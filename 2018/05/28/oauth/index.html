<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta name="google-site-verification" content="6jvcY_UrCpp1JLjXITf45ljboLU0NDGF16ZqomMt-ls">
  
  <title>GO Oauth2/OIDC客户端/服务器 | 个人笔记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="服务器参考https://github.com/RangelReale/osin 客户端参考https://github.com/golang/oauth2 OIDC服务器参考https://github.com/coreos/dex OIDC客户端参考https://github.com/coreos/go-oidc  OAuth2服务器package mainimport (	&quot;fmt&quot;	&quot;">
<meta name="keywords" content="golang">
<meta property="og:type" content="article">
<meta property="og:title" content="GO Oauth2&#x2F;OIDC客户端&#x2F;服务器">
<meta property="og:url" content="http://blog.kimq.cn/2018/05/28/oauth/index.html">
<meta property="og:site_name" content="个人笔记">
<meta property="og:description" content="服务器参考https://github.com/RangelReale/osin 客户端参考https://github.com/golang/oauth2 OIDC服务器参考https://github.com/coreos/dex OIDC客户端参考https://github.com/coreos/go-oidc  OAuth2服务器package mainimport (	&quot;fmt&quot;	&quot;">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-08-01T09:26:24.727Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GO Oauth2&#x2F;OIDC客户端&#x2F;服务器">
<meta name="twitter:description" content="服务器参考https://github.com/RangelReale/osin 客户端参考https://github.com/golang/oauth2 OIDC服务器参考https://github.com/coreos/dex OIDC客户端参考https://github.com/coreos/go-oidc  OAuth2服务器package mainimport (	&quot;fmt&quot;	&quot;">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" integrity="sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+" crossorigin="anonymous">

  <link rel="stylesheet" href="/css/styles.css">
  

</head>
</html>
<body>
  <nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="main-menu-navbar">
      <ul class="nav navbar-nav">
        
          <li><a class=""
                 href="/index.html">Home</a></li>
        
          <li><a class=""
                 href="/archives/">Archives</a></li>
        
          <li><a class=""
                 href="/atom.xml">Rss</a></li>
        
      </ul>

      <!--
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

  <div class="container">
    <div class="blog-header">
  <h1 class="blog-title">个人笔记</h1>
  
    <p class="lead blog-description">专注互联网</p>
  
</div>

    <div class="row">
        <div class="col-sm-9 blog-main">
          <article id="post-oauth" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 class="article-title" itemprop="name">
      GO Oauth2/OIDC客户端/服务器
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2018/05/28/oauth/" class="article-date"><time datetime="2018-05-28T01:12:53.000Z" itemprop="datePublished">2018-05-28</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/学习笔记/">学习笔记</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <ol>
<li>服务器参考<a href="https://github.com/RangelReale/osin" target="_blank" rel="noopener">https://github.com/RangelReale/osin</a></li>
<li>客户端参考<a href="https://github.com/golang/oauth2" target="_blank" rel="noopener">https://github.com/golang/oauth2</a></li>
<li>OIDC服务器参考<a href="https://github.com/coreos/dex" target="_blank" rel="noopener">https://github.com/coreos/dex</a></li>
<li>OIDC客户端参考<a href="https://github.com/coreos/go-oidc" target="_blank" rel="noopener">https://github.com/coreos/go-oidc</a></li>
</ol>
<h1 id="OAuth2服务器"><a href="#OAuth2服务器" class="headerlink" title="OAuth2服务器"></a>OAuth2服务器</h1><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/RangelReale/osin"</span></span><br><span class="line">	<span class="string">"github.com/RangelReale/osin/example"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleLoginPage</span><span class="params">(ar *osin.AuthorizeRequest, w http.ResponseWriter, r *http.Request)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	r.ParseForm()</span><br><span class="line">	<span class="keyword">if</span> r.Method == <span class="string">"POST"</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	html := <span class="string">`&lt;html&gt;&lt;body&gt;</span></span><br><span class="line"><span class="string">LOGIN %s&lt;br/&gt;</span></span><br><span class="line"><span class="string">&lt;form action="/authorize?%s" method="POST"&gt;</span></span><br><span class="line"><span class="string">&lt;input type="submit"/&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;&lt;/html&gt;`</span></span><br><span class="line">	w.Write([]<span class="keyword">byte</span>(fmt.Sprintf(html, ar.Client.GetId(), r.URL.RawQuery)))</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newTestStorage</span><span class="params">()</span> *<span class="title">example</span>.<span class="title">TestStorage</span></span> &#123;</span><br><span class="line">	ts := example.NewTestStorage()</span><br><span class="line">	c, _ := ts.GetClient(<span class="string">"1234"</span>)</span><br><span class="line">	tc := c.(*osin.DefaultClient)</span><br><span class="line">	tc.RedirectUri = <span class="string">"http://qjw.p.kimq.cn/callback"</span></span><br><span class="line">	<span class="keyword">return</span> ts</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cfg := osin.NewServerConfig()</span><br><span class="line">	cfg.AllowGetAccessRequest = <span class="literal">true</span></span><br><span class="line">	cfg.AllowClientSecretInParams = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">	server := osin.NewServer(cfg, newTestStorage())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Authorization code endpoint</span></span><br><span class="line">	http.HandleFunc(<span class="string">"/authorize"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		resp := server.NewResponse()</span><br><span class="line">		<span class="keyword">defer</span> resp.Close()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ar := server.HandleAuthorizeRequest(resp, r); ar != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> !handleLoginPage(ar, w, r) &#123;</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			ar.Authorized = <span class="literal">true</span></span><br><span class="line">			server.FinishAuthorizeRequest(resp, r, ar)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> resp.IsError &amp;&amp; resp.InternalError != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">"ERROR: %s\n"</span>, resp.InternalError)</span><br><span class="line">		&#125;</span><br><span class="line">		osin.OutputJSON(resp, w, r)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Access token endpoint</span></span><br><span class="line">	http.HandleFunc(<span class="string">"/token"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		resp := server.NewResponse()</span><br><span class="line">		<span class="keyword">defer</span> resp.Close()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ar := server.HandleAccessRequest(resp, r); ar != <span class="literal">nil</span> &#123;</span><br><span class="line">			ar.Authorized = <span class="literal">true</span></span><br><span class="line">			server.FinishAccessRequest(resp, r, ar)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> resp.IsError &amp;&amp; resp.InternalError != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">"ERROR: %s\n"</span>, resp.InternalError)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		osin.OutputJSON(resp, w, r)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Information endpoint</span></span><br><span class="line">	http.HandleFunc(<span class="string">"/info"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		resp := server.NewResponse()</span><br><span class="line">		<span class="keyword">defer</span> resp.Close()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ir := server.HandleInfoRequest(resp, r); ir != <span class="literal">nil</span> &#123;</span><br><span class="line">			server.FinishInfoRequest(resp, r, ir)</span><br><span class="line">		&#125;</span><br><span class="line">		osin.OutputJSON(resp, w, r)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	http.ListenAndServe(<span class="string">":14000"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="OAuth2客户端"><a href="#OAuth2客户端" class="headerlink" title="OAuth2客户端"></a>OAuth2客户端</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"golang.org/x/oauth2"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> htmlIndex = <span class="string">`&lt;html&gt;&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;a href="/login"&gt;Log in with oauth2&lt;/a&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> infoUrl = <span class="string">"http://localhost:14000/info"</span></span><br><span class="line"><span class="keyword">var</span> endpotin = oauth2.Endpoint&#123;</span><br><span class="line">	AuthURL:  <span class="string">"http://localhost:14000/authorize"</span>,</span><br><span class="line">	TokenURL: <span class="string">"http://localhost:14000/token"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> oauthConfig = &amp;oauth2.Config&#123;</span><br><span class="line">	ClientID:     <span class="string">"1234"</span>,</span><br><span class="line">	ClientSecret: <span class="string">"aabbccdd"</span>,</span><br><span class="line">	RedirectURL:  <span class="string">"http://qjw.p.kimq.cn/callback"</span>,</span><br><span class="line">	Scopes:       []<span class="keyword">string</span>&#123;<span class="string">"api"</span>&#125;,</span><br><span class="line">	Endpoint:     endpotin,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> oauthStateString = <span class="string">"random"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">"/"</span>, handleMain)</span><br><span class="line">	http.HandleFunc(<span class="string">"/login"</span>, handleLogin)</span><br><span class="line">	http.HandleFunc(<span class="string">"/callback"</span>, handleCallback)</span><br><span class="line">	fmt.Println(http.ListenAndServe(<span class="string">":8000"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleMain</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	fmt.Fprintf(w, htmlIndex)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleLogin</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	url := oauthConfig.AuthCodeURL(oauthStateString)</span><br><span class="line">	fmt.Println(url)</span><br><span class="line">	http.Redirect(w, r, url, http.StatusTemporaryRedirect)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleCallback</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	state := r.FormValue(<span class="string">"state"</span>)</span><br><span class="line">	<span class="keyword">if</span> state != oauthStateString &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"invalid oauth state, expected '%s', got '%s'\n"</span>, oauthStateString, state)</span><br><span class="line">		http.Redirect(w, r, <span class="string">"/"</span>, http.StatusTemporaryRedirect)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(state)</span><br><span class="line"></span><br><span class="line">	code := r.FormValue(<span class="string">"code"</span>)</span><br><span class="line">	fmt.Println(code)</span><br><span class="line">	token, err := oauthConfig.Exchange(oauth2.NoContext, code)</span><br><span class="line">	fmt.Println(token)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"Code exchange failed with '%s'\n"</span>, err)</span><br><span class="line">		http.Redirect(w, r, <span class="string">"/"</span>, http.StatusTemporaryRedirect)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	client := &amp;http.Client&#123;&#125;</span><br><span class="line">	req, _ := http.NewRequest(<span class="string">"GET"</span>, infoUrl, <span class="literal">nil</span>)</span><br><span class="line">	req.Header.Set(<span class="string">"Authorization"</span>, <span class="string">"bearer "</span>+token.AccessToken)</span><br><span class="line">	response, err := client.Do(req)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> response.Body.Close()</span><br><span class="line">		contents, _ := ioutil.ReadAll(response.Body)</span><br><span class="line">		fmt.Fprintf(w, <span class="string">"Content: %s\n"</span>, contents)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Fprintf(w, <span class="string">"Content: %s\n"</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Gitlab-OAuth客户端"><a href="#Gitlab-OAuth客户端" class="headerlink" title="Gitlab OAuth客户端"></a>Gitlab OAuth客户端</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"golang.org/x/oauth2"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> htmlIndex = <span class="string">`&lt;html&gt;&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;a href="/login"&gt;Log in with oauth2&lt;/a&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//var infoUrl = "http://localhost:14000/info"</span></span><br><span class="line"><span class="comment">//var endpotin = oauth2.Endpoint&#123;</span></span><br><span class="line"><span class="comment">//	AuthURL:  "http://localhost:14000/authorize",</span></span><br><span class="line"><span class="comment">//	TokenURL: "http://localhost:14000/token",</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//var oauthConfig = &amp;oauth2.Config&#123;</span></span><br><span class="line"><span class="comment">//	ClientID:     "1234",</span></span><br><span class="line"><span class="comment">//	ClientSecret: "aabbccdd",</span></span><br><span class="line"><span class="comment">//	RedirectURL:  "http://qjw.p.kimq.cn/callback",</span></span><br><span class="line"><span class="comment">//	Scopes:       []string&#123;"api"&#125;,</span></span><br><span class="line"><span class="comment">//	Endpoint:     endpotin,</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> domain = <span class="string">"https://gitlab.example.com"</span></span><br><span class="line"><span class="keyword">var</span> infoUrl = domain + <span class="string">"/api/v4/users"</span></span><br><span class="line"><span class="keyword">var</span> endpotin = oauth2.Endpoint&#123;</span><br><span class="line">	AuthURL:  domain + <span class="string">"/oauth/authorize"</span>,</span><br><span class="line">	TokenURL: domain + <span class="string">"/oauth/token"</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> oauthConfig = &amp;oauth2.Config&#123;</span><br><span class="line">	ClientID:     <span class="string">"4f56sad4f56sa4df65safd"</span>,</span><br><span class="line">	ClientSecret: <span class="string">"7f8dasf46sa54f56s4df65"</span>,</span><br><span class="line">	RedirectURL:  <span class="string">"http://qjw.p.kimq.cn/callback"</span>,</span><br><span class="line">	Scopes:       []<span class="keyword">string</span>&#123;<span class="string">"api"</span>&#125;,</span><br><span class="line">	Endpoint:     endpotin,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> oauthStateString = <span class="string">"random"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">"/"</span>, handleMain)</span><br><span class="line">	http.HandleFunc(<span class="string">"/login"</span>, handleLogin)</span><br><span class="line">	http.HandleFunc(<span class="string">"/callback"</span>, handleCallback)</span><br><span class="line">	fmt.Println(http.ListenAndServe(<span class="string">":8000"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleMain</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	fmt.Fprintf(w, htmlIndex)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleLogin</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	url := oauthConfig.AuthCodeURL(oauthStateString)</span><br><span class="line">	fmt.Println(url)</span><br><span class="line">	http.Redirect(w, r, url, http.StatusTemporaryRedirect)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleCallback</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	state := r.FormValue(<span class="string">"state"</span>)</span><br><span class="line">	<span class="keyword">if</span> state != oauthStateString &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"invalid oauth state, expected '%s', got '%s'\n"</span>, oauthStateString, state)</span><br><span class="line">		http.Redirect(w, r, <span class="string">"/"</span>, http.StatusTemporaryRedirect)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(state)</span><br><span class="line"></span><br><span class="line">	code := r.FormValue(<span class="string">"code"</span>)</span><br><span class="line">	fmt.Println(code)</span><br><span class="line">	token, err := oauthConfig.Exchange(oauth2.NoContext, code)</span><br><span class="line">	fmt.Println(token)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"Code exchange failed with '%s'\n"</span>, err)</span><br><span class="line">		http.Redirect(w, r, <span class="string">"/"</span>, http.StatusTemporaryRedirect)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	client := &amp;http.Client&#123;&#125;</span><br><span class="line">	req, _ := http.NewRequest(<span class="string">"GET"</span>, infoUrl, <span class="literal">nil</span>)</span><br><span class="line">	req.Header.Set(<span class="string">"Authorization"</span>, <span class="string">"bearer "</span>+token.AccessToken)</span><br><span class="line">	response, err := client.Do(req)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> response.Body.Close()</span><br><span class="line">		contents, _ := ioutil.ReadAll(response.Body)</span><br><span class="line">		fmt.Fprintf(w, <span class="string">"Content: %s\n"</span>, contents)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Fprintf(w, <span class="string">"Content: %s\n"</span>, err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="OIDC服务器"><a href="#OIDC服务器" class="headerlink" title="OIDC服务器"></a>OIDC服务器</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ go get github.com/coreos/dex</span><br><span class="line">$ <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/coreos/dex</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure>
<p>修改examples/config-dev.yml<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">staticClients:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">example-app</span></span><br><span class="line">  <span class="attr">redirectURIs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">'http://qjw.p.kimq.cn/callback'</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">'Example App'</span></span><br><span class="line">  <span class="attr">secret:</span> <span class="string">ZXhhbXBsZS1hcHAtc2VjcmV0</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./bin/dex serve examples/config-dev.yaml</span><br></pre></td></tr></table></figure>
<h2 id="OIDC客户端"><a href="#OIDC客户端" class="headerlink" title="OIDC客户端"></a>OIDC客户端</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line">	oidc <span class="string">"github.com/coreos/go-oidc"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"golang.org/x/net/context"</span></span><br><span class="line">	<span class="string">"golang.org/x/oauth2"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> domain = <span class="string">"http://127.0.0.1:5556/dex"</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	clientID     = <span class="string">"example-app"</span></span><br><span class="line">	clientSecret = <span class="string">"ZXhhbXBsZS1hcHAtc2VjcmV0"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line"></span><br><span class="line">	provider, err := oidc.NewProvider(ctx, domain)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	oidcConfig := &amp;oidc.Config&#123;</span><br><span class="line">		ClientID: clientID,</span><br><span class="line">	&#125;</span><br><span class="line">	verifier := provider.Verifier(oidcConfig)</span><br><span class="line"></span><br><span class="line">	config := oauth2.Config&#123;</span><br><span class="line">		ClientID:     clientID,</span><br><span class="line">		ClientSecret: clientSecret,</span><br><span class="line">		Endpoint:     provider.Endpoint(),</span><br><span class="line">		RedirectURL:  <span class="string">"http://qjw.p.kimq.cn/callback"</span>,</span><br><span class="line">		Scopes:       []<span class="keyword">string</span>&#123;oidc.ScopeOpenID&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	state := <span class="string">"foobar"</span> <span class="comment">// Don't do this in production.</span></span><br><span class="line"></span><br><span class="line">	http.HandleFunc(<span class="string">"/"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		http.Redirect(w, r, config.AuthCodeURL(state), http.StatusFound)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	http.HandleFunc(<span class="string">"/callback"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> r.URL.Query().Get(<span class="string">"state"</span>) != state &#123;</span><br><span class="line">			http.Error(w, <span class="string">"state did not match"</span>, http.StatusBadRequest)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		oauth2Token, err := config.Exchange(ctx, r.URL.Query().Get(<span class="string">"code"</span>))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			http.Error(w, <span class="string">"Failed to exchange token: "</span>+err.Error(), http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		rawIDToken, ok := oauth2Token.Extra(<span class="string">"id_token"</span>).(<span class="keyword">string</span>)</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			http.Error(w, <span class="string">"No id_token field in oauth2 token."</span>, http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		idToken, err := verifier.Verify(ctx, rawIDToken)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			http.Error(w, <span class="string">"Failed to verify ID Token: "</span>+err.Error(), http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		oauth2Token.AccessToken = <span class="string">"*REDACTED*"</span></span><br><span class="line"></span><br><span class="line">		resp := <span class="keyword">struct</span> &#123;</span><br><span class="line">			OAuth2Token   *oauth2.Token</span><br><span class="line">			IDTokenClaims *json.RawMessage <span class="comment">// ID Token payload is just JSON.</span></span><br><span class="line">		&#125;&#123;oauth2Token, <span class="built_in">new</span>(json.RawMessage)&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := idToken.Claims(&amp;resp.IDTokenClaims); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		data, err := json.MarshalIndent(resp, <span class="string">""</span>, <span class="string">"    "</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		w.Write(data)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	log.Fatal(http.ListenAndServe(<span class="string">"127.0.0.1:8000"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Dex使用Gitlab"><a href="#Dex使用Gitlab" class="headerlink" title="Dex使用Gitlab"></a>Dex使用Gitlab</h1><p>Dex默认提供了几种不需要额外配置的认证方式，参见配置 <code>config-dev.yaml</code>。代码实现参见<code>github.com/coreos/dex/storage/static.go</code><br><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">staticClients:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">example-app</span></span><br><span class="line">  <span class="attr">redirectURIs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">'http://qjw.p.kimq.cn/callback'</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">'Example App'</span></span><br><span class="line">  <span class="attr">secret:</span> <span class="string">ZXhhbXBsZS1hcHAtc2VjcmV0</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">connectors:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">mockCallback</span></span><br><span class="line">  <span class="attr">id:</span> <span class="string">mock</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">Example</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># Let dex keep a list of passwords which can be used to login to dex.</span></span><br><span class="line"><span class="attr">enablePasswordDB:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A static list of passwords to login the end user. By identifying here, dex</span></span><br><span class="line"><span class="comment"># won't look in its underlying storage for passwords.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If this option isn't chosen users may be added through the gRPC API.</span></span><br><span class="line"><span class="attr">staticPasswords:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">email:</span> <span class="string">"admin@example.com"</span></span><br><span class="line">  <span class="comment"># bcrypt hash of the string "password"</span></span><br><span class="line">  <span class="attr">hash:</span> <span class="string">"$2a$10$2b2cU8CPhOTaGrs1HRQuAueS7JTT5ZHsHSzYiFPm1leZck7Mc8T4W"</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">"admin"</span></span><br><span class="line">  <span class="attr">userID:</span> <span class="string">"08a8684b-db88-4b73-90a9-3cd1661f5466"</span></span><br></pre></td></tr></table></figure></p>
<p>为了支持Gitlab，需要</p>
<ol>
<li>准备gitlab，可以使用gitlab.com，或者自行搭建的私有仓库，用Docker运行Gitlab非常容易，参见<a href="http://blog.kimq.cn/2017/06/19/gitlab-env/">http://blog.kimq.cn/2017/06/19/gitlab-env/</a></li>
<li>Gitlab新建<code>applications</code>，其中回调<a href="http://server:5556/dex/callback" target="_blank" rel="noopener">http://server:5556/dex/callback</a>，<em>假设dex服务器的地址是<a href="http://server:5556,下同" target="_blank" rel="noopener">http://server:5556,下同</a></em>。</li>
<li><p>修改dex配置,假设自行搭建的gitlab服务器地址<a href="http://server:8080" target="_blank" rel="noopener">http://server:8080</a>，注意配置<code>baseURL</code>,<code>redirectURI/clientID/clientSecret</code>和gitlab上保持一致</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">connectors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">gitlab</span></span><br><span class="line">    <span class="comment"># Required field for connector id.</span></span><br><span class="line">    <span class="attr">id:</span> <span class="string">gitlab</span></span><br><span class="line">    <span class="comment"># Required field for connector name.</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GitLab</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment"># optional, default = https://www.gitlab.com </span></span><br><span class="line">      <span class="attr">baseURL:</span> <span class="string">http://server:8080</span></span><br><span class="line">      <span class="comment"># Credentials can be string literals or pulled from the environment.  </span></span><br><span class="line">      <span class="attr">clientID:</span> <span class="string">7071eb2135f75bf1d8cabd0c48c98ee38b84e25e628e0f9164cd2e40bd99fcd8</span></span><br><span class="line">      <span class="attr">clientSecret:</span> <span class="string">e84f364add4d221cacf36cfe4136cc1c13872ce1ba17158b5ff972221d9f3e21</span></span><br><span class="line">      <span class="attr">redirectURI:</span> <span class="string">http://server:5556/dex/callback</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>给dex的客户端分配<code>clientID/clientSecret</code>，在Gitlab上生成的clientID/clientSecret仅仅供dex自己使用（<em>站在gitlab角度看，dex是客户端</em>），分配的方式比较麻烦，dex提供了grpc的接口，参见<code>github.com/coreos/dex/Documentation/api.md</code>，编译成功之后有一个<code>github.com/coreos/dex/bin/grpc-client</code>。我用了一种比较讨巧的办法先测试，写一个Web API，参见<code>github.com/coreos/dex/server/server.go</code>和<code>github.com/coreos/dex/server/handlers.go</code></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">handleWithCORS(<span class="string">"/token"</span>, s.handleToken)</span><br><span class="line">handleWithCORS(<span class="string">"/test"</span>, s.test)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面的参数`id`和`secret`就是新分配的`clientID/clientSecret`</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">test</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	s.storage.CreateClient(storage.Client&#123;</span><br><span class="line">		ID:           <span class="string">"tt"</span>,</span><br><span class="line">		Secret:       <span class="string">"123456"</span>,</span><br><span class="line">		RedirectURIs: []<span class="keyword">string</span>&#123;<span class="string">"http://qjw.p.kimq.cn/callback"</span>&#125;,</span><br><span class="line">		Name:         <span class="string">"hehe"</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	w.Write([]<span class="keyword">byte</span>(<span class="string">"Hello, world!"</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行客户端</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line">	oidc <span class="string">"github.com/coreos/go-oidc"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"golang.org/x/net/context"</span></span><br><span class="line">	<span class="string">"golang.org/x/oauth2"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> domain = <span class="string">"http://server:5556/dex"</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	clientID     = <span class="string">"tt"</span></span><br><span class="line">	clientSecret = <span class="string">"123456"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line"></span><br><span class="line">	provider, err := oidc.NewProvider(ctx, domain)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	oidcConfig := &amp;oidc.Config&#123;</span><br><span class="line">		ClientID: clientID,</span><br><span class="line">	&#125;</span><br><span class="line">	verifier := provider.Verifier(oidcConfig)</span><br><span class="line"></span><br><span class="line">	config := oauth2.Config&#123;</span><br><span class="line">		ClientID:     clientID,</span><br><span class="line">		ClientSecret: clientSecret,</span><br><span class="line">		Endpoint:     provider.Endpoint(),</span><br><span class="line">		RedirectURL:  <span class="string">"http://qjw.p.kimq.cn/callback"</span>,</span><br><span class="line">		Scopes:       []<span class="keyword">string</span>&#123;oidc.ScopeOpenID&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	state := <span class="string">"foobar"</span> <span class="comment">// Don't do this in production.</span></span><br><span class="line"></span><br><span class="line">	http.HandleFunc(<span class="string">"/"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		http.Redirect(w, r, config.AuthCodeURL(state), http.StatusFound)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	http.HandleFunc(<span class="string">"/callback"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> r.URL.Query().Get(<span class="string">"state"</span>) != state &#123;</span><br><span class="line">			http.Error(w, <span class="string">"state did not match"</span>, http.StatusBadRequest)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		oauth2Token, err := config.Exchange(ctx, r.URL.Query().Get(<span class="string">"code"</span>))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			http.Error(w, <span class="string">"Failed to exchange token: "</span>+err.Error(), http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		rawIDToken, ok := oauth2Token.Extra(<span class="string">"id_token"</span>).(<span class="keyword">string</span>)</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			http.Error(w, <span class="string">"No id_token field in oauth2 token."</span>, http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		idToken, err := verifier.Verify(ctx, rawIDToken)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			http.Error(w, <span class="string">"Failed to verify ID Token: "</span>+err.Error(), http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		oauth2Token.AccessToken = <span class="string">"*REDACTED*"</span></span><br><span class="line"></span><br><span class="line">		resp := <span class="keyword">struct</span> &#123;</span><br><span class="line">			OAuth2Token   *oauth2.Token</span><br><span class="line">			IDTokenClaims *json.RawMessage <span class="comment">// ID Token payload is just JSON.</span></span><br><span class="line">		&#125;&#123;oauth2Token, <span class="built_in">new</span>(json.RawMessage)&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := idToken.Claims(&amp;resp.IDTokenClaims); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		data, err := json.MarshalIndent(resp, <span class="string">""</span>, <span class="string">"    "</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		w.Write(data)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	log.Fatal(http.ListenAndServe(<span class="string">"0.0.0.0:8000"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="Connector绑定"><a href="#Connector绑定" class="headerlink" title="Connector绑定"></a>Connector绑定</h2><p>dex并未就client和特定的connector（比如gitlab）做绑定，若connector只有一个，就直接跳转，否则列出来让用户选</p>
<p>加入dex同时设置了gitlab和github的connector，并且我希望这些clientid只能使用gitlab，另外一些只能使用github做授权，就无法实现。</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2018/05/28/oauth/" data-id="ckdbgbyxd004d43poy93cyt03" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2018/05/28/oauth/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li></ul>


    </footer>
  </div>
  
    
<ul id="article-nav" class="nav nav-pills nav-justified">
  
  <li role="presentation">
    <a href="/2018/05/25/plantuml/" id="article-nav-older" class="article-nav-link-wrap">
      <i class="fa fa-chevron-left pull-left"></i>
      <span class="article-nav-link-title">使用plantuml画UML图</span>
    </a>
  </li>
  
  
  <li role="presentation">
    <a href="/2018/06/26/tars/" id="article-nav-newer" class="article-nav-link-wrap">
      <span class="article-nav-link-title">腾讯Tars初探</span>
      <i class="fa fa-chevron-right pull-right"></i>
    </a>
  </li>
  
</ul>


  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>



        </div>
        <div class="col-sm-2 col-sm-offset-1 blog-sidebar">
          
  
  <div class="sidebar-module">
    <h4>Categories</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Golang/">Golang</a><span class="sidebar-module-list-count">14</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Openldap/">Openldap</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Python/">Python</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/后端/">后端</a><span class="sidebar-module-list-count">11</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/学习笔记/">学习笔记</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/开发环境/">开发环境</a><span class="sidebar-module-list-count">13</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/源码学习/">源码学习</a><span class="sidebar-module-list-count">9</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/环境搭建/">环境搭建</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/运营运维/">运营运维</a><span class="sidebar-module-list-count">10</span><ul class="sidebar-module-list-child"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/运营运维/代理/">代理</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/运营运维/网站/">网站</a><span class="sidebar-module-list-count">1</span></li></ul></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tags</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ansible/">ansible</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/antd/">antd</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/cookie/">cookie</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/cors/">cors</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/crsf/">crsf</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/docker/">docker</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/drone/">drone</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/elasticsearch/">elasticsearch</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/flask/">flask</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/git/">git</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/github/">github</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/gitlab/">gitlab</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/golang/">golang</a><span class="sidebar-module-list-count">27</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/gorm/">gorm</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/grpc/">grpc</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/hexo/">hexo</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/influxdb/">influxdb</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/jsonp/">jsonp</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/jsonschema/">jsonschema</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/kibana/">kibana</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/martini/">martini</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/nginx/">nginx</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ngrok/">ngrok</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/node/">node</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/openldap/">openldap</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/pip/">pip</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/proxy/">proxy</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/python/">python</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/redis/">redis</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/sentry/">sentry</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/sqlalchemy/">sqlalchemy</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ssh/">ssh</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/sso/">sso</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/tars/">tars</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/tavern/">tavern</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/travis/">travis</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/uml/">uml</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/wcgi/">wcgi</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/xss/">xss</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/一致性hash/">一致性hash</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/持续集成/">持续集成</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/盗链/">盗链</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/签名/">签名</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/证书/">证书</a><span class="sidebar-module-list-count">2</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tag Cloud</h4>
    <p class="tagcloud">
      <a href="/tags/ansible/" style="font-size: 10px;">ansible</a> <a href="/tags/antd/" style="font-size: 10px;">antd</a> <a href="/tags/cookie/" style="font-size: 11.67px;">cookie</a> <a href="/tags/cors/" style="font-size: 10px;">cors</a> <a href="/tags/crsf/" style="font-size: 10px;">crsf</a> <a href="/tags/docker/" style="font-size: 13.33px;">docker</a> <a href="/tags/drone/" style="font-size: 16.67px;">drone</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/flask/" style="font-size: 11.67px;">flask</a> <a href="/tags/git/" style="font-size: 11.67px;">git</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/gitlab/" style="font-size: 11.67px;">gitlab</a> <a href="/tags/golang/" style="font-size: 20px;">golang</a> <a href="/tags/gorm/" style="font-size: 10px;">gorm</a> <a href="/tags/grpc/" style="font-size: 10px;">grpc</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/influxdb/" style="font-size: 10px;">influxdb</a> <a href="/tags/jsonp/" style="font-size: 10px;">jsonp</a> <a href="/tags/jsonschema/" style="font-size: 10px;">jsonschema</a> <a href="/tags/kibana/" style="font-size: 10px;">kibana</a> <a href="/tags/martini/" style="font-size: 10px;">martini</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/ngrok/" style="font-size: 11.67px;">ngrok</a> <a href="/tags/node/" style="font-size: 10px;">node</a> <a href="/tags/openldap/" style="font-size: 13.33px;">openldap</a> <a href="/tags/pip/" style="font-size: 10px;">pip</a> <a href="/tags/proxy/" style="font-size: 13.33px;">proxy</a> <a href="/tags/python/" style="font-size: 11.67px;">python</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/sentry/" style="font-size: 11.67px;">sentry</a> <a href="/tags/sqlalchemy/" style="font-size: 10px;">sqlalchemy</a> <a href="/tags/ssh/" style="font-size: 11.67px;">ssh</a> <a href="/tags/sso/" style="font-size: 10px;">sso</a> <a href="/tags/tars/" style="font-size: 10px;">tars</a> <a href="/tags/tavern/" style="font-size: 10px;">tavern</a> <a href="/tags/travis/" style="font-size: 10px;">travis</a> <a href="/tags/uml/" style="font-size: 10px;">uml</a> <a href="/tags/wcgi/" style="font-size: 10px;">wcgi</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/一致性hash/" style="font-size: 10px;">一致性hash</a> <a href="/tags/持续集成/" style="font-size: 18.33px;">持续集成</a> <a href="/tags/盗链/" style="font-size: 10px;">盗链</a> <a href="/tags/签名/" style="font-size: 11.67px;">签名</a> <a href="/tags/证书/" style="font-size: 11.67px;">证书</a>
    </p>
  </div>


  
  <div class="sidebar-module">
    <h4>Archives</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/08/">八月 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/06/">六月 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/03/">三月 2020</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/02/">二月 2020</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/01/">一月 2020</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/07/">七月 2018</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/06/">六月 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/05/">五月 2018</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/12/">十二月 2017</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/10/">十月 2017</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/08/">八月 2017</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/07/">七月 2017</a><span class="sidebar-module-list-count">8</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/06/">六月 2017</a><span class="sidebar-module-list-count">7</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/04/">四月 2017</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/03/">三月 2017</a><span class="sidebar-module-list-count">10</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/02/">二月 2017</a><span class="sidebar-module-list-count">10</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Recents</h4>
    <ul class="sidebar-module-list">
      
        <li>
          <a href="/2020/08/01/gitlab-sentry/">gitlab/sentry集成</a>
        </li>
      
        <li>
          <a href="/2020/06/10/ansible/">Ansible实践</a>
        </li>
      
        <li>
          <a href="/2020/03/08/elasticsearch_basic/">ElasticSearch学习笔记</a>
        </li>
      
        <li>
          <a href="/2020/02/29/jaeger_basic/">Jaeger初探</a>
        </li>
      
        <li>
          <a href="/2020/02/20/tavern/">ResfulApi测试框架tavern</a>
        </li>
      
    </ul>
  </div>



        </div>
    </div>
  </div>
  <footer class="blog-footer">
  <div class="container">
    <div id="footer-info" class="inner">
      &copy; 2020 KingQiu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      <br/>
      CopyRight © 2019 <a href="http://beian.miit.gov.cn/" target="_blank">粤ICP备19068003号</a>
    </div>
  </div>
</footer>
<script>
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

  
<script>
  var disqus_shortname = 'blog-qiujinwu-com';
  
  var disqus_url = 'http://blog.kimq.cn/2018/05/28/oauth/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js" crossorigin="anonymous"></script>

<script src="http://cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js" crossorigin="anonymous"></script>



<script src="/js/script.js"></script>

</body>
</html>
