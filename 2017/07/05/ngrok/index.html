<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta name="google-site-verification" content="6jvcY_UrCpp1JLjXITf45ljboLU0NDGF16ZqomMt-ls">
  
  <title>Ngrok客户端源码学习笔记 | 个人笔记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="关于ngrok的使用，参考http://blog.qiujinwu.com/2017/02/13/ngrok-reverse-proxy/ 源码地址 https://github.com/inconshreveable/ngrok，我fork一份在https://github.com/qjw/ngrok,代码相对路径src/github.com/qjw/ngrok/src/ngrok/server">
<meta name="keywords" content="golang,ngrok">
<meta property="og:type" content="article">
<meta property="og:title" content="Ngrok客户端源码学习笔记">
<meta property="og:url" content="http://blog.kimq.cn/2017/07/05/ngrok/index.html">
<meta property="og:site_name" content="个人笔记">
<meta property="og:description" content="关于ngrok的使用，参考http://blog.qiujinwu.com/2017/02/13/ngrok-reverse-proxy/ 源码地址 https://github.com/inconshreveable/ngrok，我fork一份在https://github.com/qjw/ngrok,代码相对路径src/github.com/qjw/ngrok/src/ngrok/server">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-08-01T09:26:24.727Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ngrok客户端源码学习笔记">
<meta name="twitter:description" content="关于ngrok的使用，参考http://blog.qiujinwu.com/2017/02/13/ngrok-reverse-proxy/ 源码地址 https://github.com/inconshreveable/ngrok，我fork一份在https://github.com/qjw/ngrok,代码相对路径src/github.com/qjw/ngrok/src/ngrok/server">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" integrity="sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+" crossorigin="anonymous">

  <link rel="stylesheet" href="/css/styles.css">
  

</head>
</html>
<body>
  <nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="main-menu-navbar">
      <ul class="nav navbar-nav">
        
          <li><a class=""
                 href="/index.html">Home</a></li>
        
          <li><a class=""
                 href="/archives/">Archives</a></li>
        
          <li><a class=""
                 href="/atom.xml">Rss</a></li>
        
      </ul>

      <!--
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

  <div class="container">
    <div class="blog-header">
  <h1 class="blog-title">个人笔记</h1>
  
    <p class="lead blog-description">专注互联网</p>
  
</div>

    <div class="row">
        <div class="col-sm-9 blog-main">
          <article id="post-ngrok" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 class="article-title" itemprop="name">
      Ngrok客户端源码学习笔记
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/07/05/ngrok/" class="article-date"><time datetime="2017-07-05T14:29:10.000Z" itemprop="datePublished">2017-07-05</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/源码学习/">源码学习</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>关于ngrok的使用，参考<a href="http://blog.qiujinwu.com/2017/02/13/ngrok-reverse-proxy/" target="_blank" rel="noopener">http://blog.qiujinwu.com/2017/02/13/ngrok-reverse-proxy/</a></p>
<p>源码地址 <a href="https://github.com/inconshreveable/ngrok" target="_blank" rel="noopener">https://github.com/inconshreveable/ngrok</a>，我fork一份在<a href="https://github.com/qjw/ngrok" target="_blank" rel="noopener">https://github.com/qjw/ngrok</a>,代码相对路径<strong>src/github.com/qjw/ngrok/src/ngrok/server/</strong>。</p>
<p>main入口在<strong>src/github.com/qjw/ngrok/src/ngrok/main</strong>,分成客户端和服务端/ngrokd/ngrokd.go、/ngrok/ngrok.go。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── cli.go <span class="comment">#命令行相关</span></span><br><span class="line">├── config.go <span class="comment">#配置相关</span></span><br><span class="line">├── controller.go <span class="comment"># 控制器，用于管理view/网络/config/state等</span></span><br><span class="line">├── main.go <span class="comment">#入口</span></span><br><span class="line">├── metrics.go <span class="comment">#统计数据</span></span><br><span class="line">├── model.go <span class="comment"># 核心逻辑</span></span><br><span class="line">├── mvc</span><br><span class="line">│   ├── controller.go <span class="comment"># controller interface</span></span><br><span class="line">│   ├── model.go <span class="comment"># interface</span></span><br><span class="line">│   ├── state.go <span class="comment"># interface和状态定义</span></span><br><span class="line">│   └── view.go <span class="comment"># interface</span></span><br><span class="line">├── tls.go <span class="comment">#tls加密</span></span><br><span class="line">└── views  <span class="comment">#view</span></span><br><span class="line">    ├── term <span class="comment">#终端view</span></span><br><span class="line">    │   ├── area.go</span><br><span class="line">    │   ├── http.go</span><br><span class="line">    │   └── view.go</span><br><span class="line">    └── web <span class="comment">#web view</span></span><br><span class="line">        ├── http.go</span><br><span class="line">        └── view.go</span><br></pre></td></tr></table></figure>
<h1 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h1><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    NewController().Run(config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewController</span><span class="params">()</span> *<span class="title">Controller</span></span> &#123;</span><br><span class="line">    ctl := &amp;Controller&#123;</span><br><span class="line">        Logger:  log.NewPrefixLogger(<span class="string">"controller"</span>),</span><br><span class="line">        updates: util.NewBroadcast(),</span><br><span class="line">        cmds:    <span class="built_in">make</span>(<span class="keyword">chan</span> command),</span><br><span class="line">        views:   <span class="built_in">make</span>([]mvc.View, <span class="number">0</span>),</span><br><span class="line">        state:   <span class="built_in">make</span>(<span class="keyword">chan</span> mvc.State),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ctl</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行启动逻辑<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctl *Controller)</span> <span class="title">Run</span><span class="params">(config *Configuration)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Save the configuration</span></span><br><span class="line">    ctl.config = config</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> model *ClientModel</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建model（核心逻辑所在）</span></span><br><span class="line">    <span class="keyword">if</span> ctl.model == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// 不存在就创建</span></span><br><span class="line">        model = ctl.SetupModel(config)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        model = ctl.model.(*ClientModel)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// init the model</span></span><br><span class="line">    <span class="keyword">var</span> state mvc.State = model</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化web view</span></span><br><span class="line">    <span class="keyword">var</span> webView *web.WebView</span><br><span class="line">    <span class="keyword">if</span> config.InspectAddr != <span class="string">"disabled"</span> &#123;</span><br><span class="line">        webView = web.NewWebView(ctl, config.InspectAddr)</span><br><span class="line">        ctl.AddView(webView)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化term view</span></span><br><span class="line">    <span class="keyword">var</span> termView *term.TermView</span><br><span class="line">    <span class="keyword">if</span> config.LogTo != <span class="string">"stdout"</span> &#123;</span><br><span class="line">        termView = term.NewTermView(ctl)</span><br><span class="line">        ctl.AddView(termView)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将view关联到controller</span></span><br><span class="line">    <span class="keyword">for</span> _, protocol := <span class="keyword">range</span> model.GetProtocols() &#123;</span><br><span class="line">        <span class="keyword">switch</span> p := protocol.(<span class="keyword">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> *proto.Http:</span><br><span class="line">            <span class="keyword">if</span> termView != <span class="literal">nil</span> &#123;</span><br><span class="line">                ctl.AddView(termView.NewHttpView(p))</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> webView != <span class="literal">nil</span> &#123;</span><br><span class="line">                ctl.AddView(webView.NewHttpView(p))</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 核心逻辑入口</span></span><br><span class="line">    ctl.Go(ctl.model.Run)</span><br><span class="line"></span><br><span class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> obj := &lt;-ctl.cmds:</span><br><span class="line">            <span class="comment">// 关闭command</span></span><br><span class="line">            <span class="keyword">switch</span> cmd := obj.(<span class="keyword">type</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> cmdQuit:</span><br><span class="line">                msg := cmd.message</span><br><span class="line">                <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                    <span class="comment">// 等待退出</span></span><br><span class="line">                    ctl.doShutdown()</span><br><span class="line">                    fmt.Println(msg)</span><br><span class="line">                    done &lt;- <span class="number">1</span></span><br><span class="line">                &#125;()</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 回放命令</span></span><br><span class="line">            <span class="keyword">case</span> cmdPlayRequest:</span><br><span class="line">                ctl.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; ctl.model.PlayRequest(cmd.tunnel, cmd.payload) &#125;)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新state</span></span><br><span class="line">        <span class="keyword">case</span> obj := &lt;-updates:</span><br><span class="line">            state = obj.(mvc.State)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> ctl.state &lt;- state:</span><br><span class="line">        <span class="comment">// 退出</span></span><br><span class="line">        <span class="keyword">case</span> &lt;-done:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终进入一个死循环，似乎作者并没有打算让它和谐地退出<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *ClientModel)</span> <span class="title">Run</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// how long we should wait before we reconnect</span></span><br><span class="line">    maxWait := <span class="number">30</span> * time.Second</span><br><span class="line">    wait := <span class="number">1</span> * time.Second</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="comment">// 开始发起连接请求，响应报文等</span></span><br><span class="line">        <span class="comment">// 注意是阻塞的，若该函数返回了，说明掉线了</span></span><br><span class="line">        c.control()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 失败后，第一次状态未变，此时重置wait的时间间隔</span></span><br><span class="line">        <span class="keyword">if</span> c.connStatus == mvc.ConnOnline &#123;</span><br><span class="line">            wait = <span class="number">1</span> * time.Second</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sleep，避免无畏的不停请求，浪费服务器资源</span></span><br><span class="line">        time.Sleep(wait)</span><br><span class="line">        <span class="comment">// 失败了继续加大重试的间隔</span></span><br><span class="line">        wait = <span class="number">2</span> * wait</span><br><span class="line">        wait = time.Duration(math.Min(<span class="keyword">float64</span>(wait), <span class="keyword">float64</span>(maxWait)))</span><br><span class="line">        <span class="comment">// 设置状态</span></span><br><span class="line">        c.connStatus = mvc.ConnReconnecting</span><br><span class="line">        <span class="comment">// 刷新各种view</span></span><br><span class="line">        c.update()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="退出"><a href="#退出" class="headerlink" title="退出"></a>退出</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctl *Controller)</span> <span class="title">doShutdown</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctl.Info(<span class="string">"Shutting down"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait for all of the views, plus the model</span></span><br><span class="line">    wg.Add(<span class="built_in">len</span>(ctl.views) + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭所有的view</span></span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> ctl.views &#123;</span><br><span class="line">        vClosure := v</span><br><span class="line">        ctl.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            vClosure.Shutdown()</span><br><span class="line">            wg.Done()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭model（核心逻辑）</span></span><br><span class="line">    ctl.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        ctl.model.Shutdown()</span><br><span class="line">        wg.Done()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用WaitGroup等待多个goruntune</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="主流程"><a href="#主流程" class="headerlink" title="主流程"></a>主流程</h1><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *ClientModel)</span> <span class="title">control</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// establish control channel</span></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        ctlConn conn.Conn</span><br><span class="line">        err     error</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向服务器发起连接</span></span><br><span class="line">    <span class="keyword">if</span> c.proxyUrl == <span class="string">""</span> &#123;</span><br><span class="line">        <span class="comment">// simple non-proxied case, just connect to the server</span></span><br><span class="line">        ctlConn, err = conn.Dial(c.serverAddr, <span class="string">"ctl"</span>, c.tlsConfig)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ctlConn, err = conn.DialHttpProxy(c.proxyUrl, c.serverAddr, <span class="string">"ctl"</span>, c.tlsConfig)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// authenticate with the server</span></span><br><span class="line">    auth := &amp;msg.Auth&#123;</span><br><span class="line">        ClientId:  c.id,</span><br><span class="line">        OS:        runtime.GOOS,</span><br><span class="line">        Arch:      runtime.GOARCH,</span><br><span class="line">        Version:   version.Proto,</span><br><span class="line">        MmVersion: version.MajorMinor(),</span><br><span class="line">        User:      c.authToken,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送连接报文</span></span><br><span class="line">    <span class="keyword">if</span> err = msg.WriteMsg(ctlConn, auth); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待响应</span></span><br><span class="line">    <span class="keyword">var</span> authResp msg.AuthResp</span><br><span class="line">    <span class="keyword">if</span> err = msg.ReadMsgInto(ctlConn, &amp;authResp); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> authResp.Error != <span class="string">""</span> &#123;</span><br><span class="line">        emsg := fmt.Sprintf(<span class="string">"Failed to authenticate to server: %s"</span>, authResp.Error)</span><br><span class="line">        c.ctl.Shutdown(emsg)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c.id = authResp.ClientId</span><br><span class="line">    c.serverVersion = authResp.MmVersion</span><br><span class="line">    c.Info(<span class="string">"Authenticated with server, client id: %v"</span>, c.id)</span><br><span class="line">    <span class="comment">// 更新view</span></span><br><span class="line">    c.update()</span><br><span class="line">    <span class="comment">// 更新配置</span></span><br><span class="line">    <span class="keyword">if</span> err = SaveAuthToken(c.configPath, c.authToken); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        c.Error(<span class="string">"Failed to save auth token: %v"</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// request tunnels</span></span><br><span class="line">    reqIdToTunnelConfig := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*TunnelConfiguration)</span><br><span class="line">    <span class="keyword">for</span> _, config := <span class="keyword">range</span> c.tunnelConfig &#123;</span><br><span class="line">        <span class="comment">// create the protocol list to ask for</span></span><br><span class="line">        <span class="keyword">var</span> protocols []<span class="keyword">string</span></span><br><span class="line">        <span class="keyword">for</span> proto, _ := <span class="keyword">range</span> config.Protocols &#123;</span><br><span class="line">            protocols = <span class="built_in">append</span>(protocols, proto)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册tunnel</span></span><br><span class="line">        reqTunnel := &amp;msg.ReqTunnel&#123;</span><br><span class="line">            ReqId:      util.RandId(<span class="number">8</span>),</span><br><span class="line">            Protocol:   strings.Join(protocols, <span class="string">"+"</span>),</span><br><span class="line">            Hostname:   config.Hostname,</span><br><span class="line">            Subdomain:  config.Subdomain,</span><br><span class="line">            HttpAuth:   config.HttpAuth,</span><br><span class="line">            RemotePort: config.RemotePort,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送请求</span></span><br><span class="line">        <span class="keyword">if</span> err = msg.WriteMsg(ctlConn, reqTunnel); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 存储这些配置，后面新建tunnel需要</span></span><br><span class="line">        reqIdToTunnelConfig[reqTunnel.ReqId] = config</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始心跳</span></span><br><span class="line">    lastPong := time.Now().UnixNano()</span><br><span class="line">    c.ctl.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c.heartbeat(&amp;lastPong, ctlConn) &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// main control loop</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> rawMsg msg.Message</span><br><span class="line">        <span class="keyword">if</span> rawMsg, err = msg.ReadMsg(ctlConn); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> m := rawMsg.(<span class="keyword">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> *msg.ReqProxy:</span><br><span class="line">            <span class="comment">// 收到proxy请求，就向服务器发起一个proxy请求</span></span><br><span class="line">            c.ctl.Go(c.proxy)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> *msg.Pong:</span><br><span class="line">            <span class="comment">// 更新心跳</span></span><br><span class="line">            atomic.StoreInt64(&amp;lastPong, time.Now().UnixNano())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> *msg.NewTunnel:</span><br><span class="line">            <span class="comment">// 注册tunnel确认</span></span><br><span class="line">            <span class="keyword">if</span> m.Error != <span class="string">""</span> &#123;</span><br><span class="line">                emsg := fmt.Sprintf(<span class="string">"Server failed to allocate tunnel: %s"</span>, m.Error)</span><br><span class="line">                c.Error(emsg)</span><br><span class="line">                c.ctl.Shutdown(emsg)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            tunnel := mvc.Tunnel&#123;</span><br><span class="line">                PublicUrl: m.Url,</span><br><span class="line">                LocalAddr: reqIdToTunnelConfig[m.ReqId].Protocols[m.Protocol],</span><br><span class="line">                Protocol:  c.protoMap[m.Protocol],</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 保存tunnel对象，用于view的数据呈现</span></span><br><span class="line">            <span class="comment">// 另外是申请proxy时，作校验</span></span><br><span class="line">            c.tunnels[tunnel.PublicUrl] = tunnel</span><br><span class="line">            <span class="comment">// 更新状态</span></span><br><span class="line">            c.connStatus = mvc.ConnOnline</span><br><span class="line">            <span class="comment">// 同步到view</span></span><br><span class="line">            c.update()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            ctlConn.Warn(<span class="string">"Ignoring unknown control message %v "</span>, m)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="心跳"><a href="#心跳" class="headerlink" title="心跳"></a>心跳</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *ClientModel)</span> <span class="title">heartbeat</span><span class="params">(lastPongAddr *<span class="keyword">int64</span>, conn conn.Conn)</span></span> &#123;</span><br><span class="line">    lastPing := time.Unix(atomic.LoadInt64(lastPongAddr)<span class="number">-1</span>, <span class="number">0</span>)</span><br><span class="line">    ping := time.NewTicker(pingInterval)</span><br><span class="line">    pongCheck := time.NewTicker(time.Second)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="comment">// 检查是否过期</span></span><br><span class="line">        <span class="keyword">case</span> &lt;-pongCheck.C:</span><br><span class="line">            lastPong := time.Unix(<span class="number">0</span>, atomic.LoadInt64(lastPongAddr))</span><br><span class="line">            needPong := lastPong.Sub(lastPing) &lt; <span class="number">0</span></span><br><span class="line">            pongLatency := time.Since(lastPing)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> needPong &amp;&amp; pongLatency &gt; maxPongLatency &#123;</span><br><span class="line">                c.Info(<span class="string">"Last ping: %v, Last pong: %v"</span>, lastPing, lastPong)</span><br><span class="line">                c.Info(<span class="string">"Connection stale, haven't gotten PongMsg in %d seconds"</span>, <span class="keyword">int</span>(pongLatency.Seconds()))</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定期发送心跳</span></span><br><span class="line">        <span class="keyword">case</span> &lt;-ping.C:</span><br><span class="line">            err := msg.WriteMsg(conn, &amp;msg.Ping&#123;&#125;)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                conn.Debug(<span class="string">"Got error %v when writing PingMsg"</span>, err)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            lastPing = time.Now()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="proxy"><a href="#proxy" class="headerlink" title="proxy"></a>proxy</h2><p>当收到一个proxy请求时，会新开一个goruntune来处理<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *ClientModel)</span> <span class="title">proxy</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        remoteConn conn.Conn</span><br><span class="line">        err        error</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试连接服务器</span></span><br><span class="line">    <span class="keyword">if</span> c.proxyUrl == <span class="string">""</span> &#123;</span><br><span class="line">        remoteConn, err = conn.Dial(c.serverAddr, <span class="string">"pxy"</span>, c.tlsConfig)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        remoteConn, err = conn.DialHttpProxy(c.proxyUrl, c.serverAddr, <span class="string">"pxy"</span>, c.tlsConfig)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> remoteConn.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送响应报文</span></span><br><span class="line">    err = msg.WriteMsg(remoteConn, &amp;msg.RegProxy&#123;ClientId: c.id&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        remoteConn.Error(<span class="string">"Failed to write RegProxy: %v"</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待具体的业务报文，</span></span><br><span class="line">    <span class="comment">// 之所以需要这么个报文，是因为需要这个报文中的内容来定位tunnel，进而获取本地端的参数</span></span><br><span class="line">    <span class="comment">// 因为客户端也是一个数据中转，它一样有下游节点</span></span><br><span class="line">    <span class="keyword">var</span> startPxy msg.StartProxy</span><br><span class="line">    <span class="keyword">if</span> err = msg.ReadMsgInto(remoteConn, &amp;startPxy); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        remoteConn.Error(<span class="string">"Server failed to write StartProxy: %v"</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 找到tunnel</span></span><br><span class="line">    tunnel, ok := c.tunnels[startPxy.Url]</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        remoteConn.Error(<span class="string">"Couldn't find tunnel for proxy: %s"</span>, startPxy.Url)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接本地端</span></span><br><span class="line">    start := time.Now()</span><br><span class="line">    localConn, err := conn.Dial(tunnel.LocalAddr, <span class="string">"prv"</span>, <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        remoteConn.Warn(<span class="string">"Failed to open private leg %s: %v"</span>, tunnel.LocalAddr, err)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> tunnel.Protocol.GetName() == <span class="string">"http"</span> &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> localConn.Close()</span><br><span class="line"></span><br><span class="line">    m := c.metrics</span><br><span class="line">    m.proxySetupTimer.Update(time.Since(start))</span><br><span class="line">    m.connMeter.Mark(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// 更新view</span></span><br><span class="line">    c.update()</span><br><span class="line">    m.connTimer.Time(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        localConn := tunnel.Protocol.WrapConn(localConn,  \</span><br><span class="line">            mvc.ConnectionContext&#123;Tunnel: tunnel, ClientAddr: startPxy.ClientAddr&#125;)</span><br><span class="line">        <span class="comment">// 数据交换</span></span><br><span class="line">        bytesIn, bytesOut := conn.Join(localConn, remoteConn)</span><br><span class="line">        m.bytesIn.Update(bytesIn)</span><br><span class="line">        m.bytesOut.Update(bytesOut)</span><br><span class="line">        m.bytesInCount.Inc(bytesIn)</span><br><span class="line">        m.bytesOutCount.Inc(bytesOut)</span><br><span class="line">    &#125;)</span><br><span class="line">    c.update()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>一个典型的proxy开始报文如下<br><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">"Type"</span>:<span class="string">"StartProxy"</span>,<span class="attr">"Payload"</span>:&#123;<span class="attr">"Url"</span>:<span class="string">"http://qjw.ngrok.com:10080"</span>,<span class="attr">"ClientAddr"</span>:<span class="string">"127.0.0.1:52630"</span>&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="广播"><a href="#广播" class="headerlink" title="广播"></a>广播</h1><p>ngrok可以同时支持若干view，为了实时同步状态等数据，<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Controller <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// the model sends updates through this broadcast channel</span></span><br><span class="line">    updates *util.Broadcast</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBroadcast</span><span class="params">()</span> *<span class="title">Broadcast</span></span> &#123;</span><br><span class="line">    b := &amp;Broadcast&#123;</span><br><span class="line">        listeners: <span class="built_in">make</span>([]<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>),</span><br><span class="line">        reg:       <span class="built_in">make</span>(<span class="keyword">chan</span> (<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)),</span><br><span class="line">        unreg:     <span class="built_in">make</span>(<span class="keyword">chan</span> (<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)),</span><br><span class="line">        in:        <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            <span class="keyword">select</span> &#123;</span><br><span class="line">            <span class="comment">// 取消注册</span></span><br><span class="line">            <span class="keyword">case</span> l := &lt;-b.unreg:</span><br><span class="line">                <span class="comment">// remove L from b.listeners</span></span><br><span class="line">                <span class="comment">// this operation is slow: O(n) but not used frequently</span></span><br><span class="line">                <span class="comment">// unlike iterating over listeners</span></span><br><span class="line">                oldListeners := b.listeners</span><br><span class="line">                b.listeners = <span class="built_in">make</span>([]<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>, <span class="built_in">len</span>(oldListeners))</span><br><span class="line">                <span class="comment">// 这个删除操作很蛋疼</span></span><br><span class="line">                <span class="keyword">for</span> _, oldL := <span class="keyword">range</span> oldListeners &#123;</span><br><span class="line">                    <span class="keyword">if</span> l != oldL &#123;</span><br><span class="line">                        b.listeners = <span class="built_in">append</span>(b.listeners, oldL)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">// 注册操作</span></span><br><span class="line">            <span class="keyword">case</span> l := &lt;-b.reg:</span><br><span class="line">                b.listeners = <span class="built_in">append</span>(b.listeners, l)</span><br><span class="line">            <span class="comment">// 刷新操作</span></span><br><span class="line">            <span class="keyword">case</span> item := &lt;-b.in:</span><br><span class="line">                <span class="keyword">for</span> _, l := <span class="keyword">range</span> b.listeners &#123;</span><br><span class="line">                    l &lt;- item</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对外的刷新channel</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Broadcast)</span> <span class="title">In</span><span class="params">()</span> <span class="title">chan</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">    <span class="keyword">return</span> b.in</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成一个注册channel，用于注册</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Broadcast)</span> <span class="title">Reg</span><span class="params">()</span> <span class="title">chan</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">    listener := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">    b.reg &lt;- listener</span><br><span class="line">    <span class="keyword">return</span> listener</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取消注册一个channel</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Broadcast)</span> <span class="title">UnReg</span><span class="params">(listener <span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    b.unreg &lt;- listener</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctl *Controller)</span> <span class="title">Update</span><span class="params">(state mvc.State)</span></span> &#123;</span><br><span class="line">    ctl.updates.In() &lt;- state</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewWebView</span><span class="params">(ctl mvc.Controller, addr <span class="keyword">string</span>)</span> *<span class="title">WebView</span></span> &#123;</span><br><span class="line">    <span class="comment">// handle web socket connections</span></span><br><span class="line">    http.HandleFunc(<span class="string">"/_ws"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 注册一个channel</span></span><br><span class="line">        msgs := wv.wsMessages.Reg()</span><br><span class="line">        <span class="comment">// 退出是取消注册</span></span><br><span class="line">        <span class="keyword">defer</span> wv.wsMessages.UnReg(msgs)</span><br><span class="line">        <span class="comment">// 监听这个channel</span></span><br><span class="line">        <span class="keyword">for</span> m := <span class="keyword">range</span> msgs &#123;</span><br><span class="line">            err := conn.WriteMessage(websocket.TextMessage, m.([]<span class="keyword">byte</span>))</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="comment">// connection is closed</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> wv</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="拦截Http-Request-Response"><a href="#拦截Http-Request-Response" class="headerlink" title="拦截Http Request/Response"></a>拦截Http Request/Response</h1><p>为了支持view呈现，需要拦截获取经过客户端的所有req/resp</p>
<h2 id="Protocol"><a href="#Protocol" class="headerlink" title="Protocol"></a>Protocol</h2><p>每种tunnel 会有一种protocol,代码定义在src/github.com/qjw/ngrok/src/ngrok/proto/</p>
<p>在初始化view时，会设置proto到view对象中<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> _, protocol := <span class="keyword">range</span> model.GetProtocols() &#123;</span><br><span class="line">    <span class="keyword">switch</span> p := protocol.(<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> *proto.Http:</span><br><span class="line">        <span class="keyword">if</span> termView != <span class="literal">nil</span> &#123;</span><br><span class="line">            ctl.AddView(termView.NewHttpView(p))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> webView != <span class="literal">nil</span> &#123;</span><br><span class="line">            ctl.AddView(webView.NewHttpView(p))</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *TermView)</span> <span class="title">NewHttpView</span><span class="params">(p *proto.Http)</span> *<span class="title">HttpView</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> newTermHttpView(v.ctl, v, p, <span class="number">0</span>, <span class="number">12</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wv *WebView)</span> <span class="title">NewHttpView</span><span class="params">(proto *proto.Http)</span> *<span class="title">WebHttpView</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> newWebHttpView(wv.ctl, wv, proto)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="刷新"><a href="#刷新" class="headerlink" title="刷新"></a>刷新</h2><p>以webview为例<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newWebHttpView</span><span class="params">(ctl mvc.Controller, wv *WebView, proto *proto.Http)</span> *<span class="title">WebHttpView</span></span> &#123;</span><br><span class="line">    whv := &amp;WebHttpView&#123;</span><br><span class="line">        Logger:       log.NewPrefixLogger(<span class="string">"view"</span>, <span class="string">"web"</span>, <span class="string">"http"</span>),</span><br><span class="line">        webview:      wv,</span><br><span class="line">        ctl:          ctl,</span><br><span class="line">        httpProto:    proto,</span><br><span class="line">        idToTxn:      <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*SerializedTxn),</span><br><span class="line">        HttpRequests: util.NewRing(<span class="number">20</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 实时刷新</span></span><br><span class="line">    ctl.Go(whv.updateHttp)</span><br><span class="line">    whv.register()</span><br><span class="line">    <span class="keyword">return</span> whv</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(whv *WebHttpView)</span> <span class="title">updateHttp</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// open channels for incoming http state changes</span></span><br><span class="line">    <span class="comment">// and broadcasts</span></span><br><span class="line">    txnUpdates := whv.httpProto.Txns.Reg()</span><br><span class="line">    <span class="comment">// 监听whv.httpProto.Txns</span></span><br><span class="line">    <span class="keyword">for</span> txn := <span class="keyword">range</span> txnUpdates &#123;</span><br><span class="line">        <span class="comment">// 获得实际的对象</span></span><br><span class="line">        htxn := txn.(*proto.HttpTxn)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 。。。 刷新操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Http <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// 可以看到Txns是一个广播对象</span></span><br><span class="line">    Txns     *util.Broadcast</span><br><span class="line">    reqGauge metrics.Gauge</span><br><span class="line">    reqMeter metrics.Meter</span><br><span class="line">    reqTimer metrics.Timer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在前面的代码中，会通过包装本地的conn<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">localConn := tunnel.Protocol.WrapConn(localConn, param)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Http)</span> <span class="title">WrapConn</span><span class="params">(c conn.Conn, ctx <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">conn</span>.<span class="title">Conn</span></span> &#123;</span><br><span class="line">    tee := conn.NewTee(c)</span><br><span class="line">    <span class="comment">// 用一个管道将获取Request和Response串起来</span></span><br><span class="line">    lastTxn := <span class="built_in">make</span>(<span class="keyword">chan</span> *HttpTxn)</span><br><span class="line">    <span class="comment">// 读取Request</span></span><br><span class="line">    <span class="keyword">go</span> h.readRequests(tee, lastTxn, ctx)</span><br><span class="line">    <span class="comment">// 读取Response</span></span><br><span class="line">    <span class="keyword">go</span> h.readResponses(tee, lastTxn)</span><br><span class="line">    <span class="keyword">return</span> tee</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Http)</span> <span class="title">readRequests</span><span class="params">(tee *conn.Tee, lastTxn <span class="keyword">chan</span> *HttpTxn, connCtx <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> <span class="built_in">close</span>(lastTxn)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="comment">// 不停地从tee的写tee中解析Request</span></span><br><span class="line">        req, err := http.ReadRequest(tee.WriteBuffer())</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// no more requests to be read, we're done</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// golang's ReadRequest/DumpRequestOut is broken. Fix up the request so it works later</span></span><br><span class="line">        req.URL.Scheme = <span class="string">"http"</span></span><br><span class="line">        req.URL.Host = req.Host</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成一个HttpTxn对象</span></span><br><span class="line">        txn := &amp;HttpTxn&#123;Start: time.Now(), ConnUserCtx: connCtx&#125;</span><br><span class="line">        txn.Req = &amp;HttpRequest&#123;Request: req&#125;</span><br><span class="line">        <span class="keyword">if</span> req.Body != <span class="literal">nil</span> &#123;</span><br><span class="line">            txn.Req.BodyBytes, txn.Req.Body, err = extractBody(req.Body)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                tee.Warn(<span class="string">"Failed to extract request body: %v"</span>, err)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送到Req/Resp共享的channel，通知resp逻辑解析Response</span></span><br><span class="line">        lastTxn &lt;- txn</span><br><span class="line">        <span class="comment">// 通知view刷新</span></span><br><span class="line">        h.Txns.In() &lt;- txn</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Http)</span> <span class="title">readResponses</span><span class="params">(tee *conn.Tee, lastTxn <span class="keyword">chan</span> *HttpTxn)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> txn := <span class="keyword">range</span> lastTxn &#123;</span><br><span class="line">        <span class="comment">// 当req解析完之后，会触发resp解析</span></span><br><span class="line">        <span class="comment">// 从tee的读tee中不停地解析Response</span></span><br><span class="line">        resp, err := http.ReadResponse(tee.ReadBuffer(), txn.Req.Request)</span><br><span class="line">        txn.Duration = time.Since(txn.Start)</span><br><span class="line">        h.reqTimer.Update(txn.Duration)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            tee.Warn(<span class="string">"Error reading response from server: %v"</span>, err)</span><br><span class="line">            <span class="comment">// no more responses to be read, we're done</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新HttpTxn对象的Response</span></span><br><span class="line">        txn.Resp = &amp;HttpResponse&#123;Response: resp&#125;</span><br><span class="line">        <span class="comment">// apparently, Body can be nil in some cases</span></span><br><span class="line">        <span class="keyword">if</span> resp.Body != <span class="literal">nil</span> &#123;</span><br><span class="line">            txn.Resp.BodyBytes, txn.Resp.Body, err = extractBody(resp.Body)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                tee.Warn(<span class="string">"Failed to extract response body: %v"</span>, err)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知view刷新</span></span><br><span class="line">        h.Txns.In() &lt;- txn</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Conn-Tee"><a href="#Conn-Tee" class="headerlink" title="Conn.Tee"></a>Conn.Tee</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTee</span><span class="params">(conn Conn)</span> *<span class="title">Tee</span></span> &#123;</span><br><span class="line">    c := &amp;Tee&#123;</span><br><span class="line">        rd:   <span class="literal">nil</span>,</span><br><span class="line">        wr:   <span class="literal">nil</span>,</span><br><span class="line">        Conn: conn,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c.readPipe.rd, c.readPipe.wr = io.Pipe()</span><br><span class="line">    c.writePipe.rd, c.writePipe.wr = io.Pipe()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取的时候，一并拷贝一份到c.readPipe.wr，那么c.readPipe.rd就可读</span></span><br><span class="line">    <span class="comment">// 参考ReadBuffer</span></span><br><span class="line">    c.rd = io.TeeReader(c.Conn, c.readPipe.wr)</span><br><span class="line">    <span class="comment">// 当写入的时候，一并写入c.writePipe.wr，那么c.writePipe.rz就可读</span></span><br><span class="line">    <span class="comment">// 参考WriteBuffer</span></span><br><span class="line">    c.wr = io.MultiWriter(c.Conn, c.writePipe.wr)</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Tee)</span> <span class="title">ReadBuffer</span><span class="params">()</span> *<span class="title">bufio</span>.<span class="title">Reader</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> bufio.NewReader(c.readPipe.rd)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Tee)</span> <span class="title">WriteBuffer</span><span class="params">()</span> *<span class="title">bufio</span>.<span class="title">Reader</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> bufio.NewReader(c.writePipe.rd)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/07/05/ngrok/" data-id="ckdbgbyx7004243po1exilwmy" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/07/05/ngrok/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ngrok/">ngrok</a></li></ul>


    </footer>
  </div>
  
    
<ul id="article-nav" class="nav nav-pills nav-justified">
  
  <li role="presentation">
    <a href="/2017/07/05/ngrokd/" id="article-nav-older" class="article-nav-link-wrap">
      <i class="fa fa-chevron-left pull-left"></i>
      <span class="article-nav-link-title">Ngrok服务端源码学习笔记</span>
    </a>
  </li>
  
  
  <li role="presentation">
    <a href="/2017/07/06/ketama/" id="article-nav-newer" class="article-nav-link-wrap">
      <span class="article-nav-link-title">ketama算法Golang实现</span>
      <i class="fa fa-chevron-right pull-right"></i>
    </a>
  </li>
  
</ul>


  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>



        </div>
        <div class="col-sm-2 col-sm-offset-1 blog-sidebar">
          
  
  <div class="sidebar-module">
    <h4>Categories</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Golang/">Golang</a><span class="sidebar-module-list-count">14</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Openldap/">Openldap</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Python/">Python</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/后端/">后端</a><span class="sidebar-module-list-count">11</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/学习笔记/">学习笔记</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/开发环境/">开发环境</a><span class="sidebar-module-list-count">13</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/源码学习/">源码学习</a><span class="sidebar-module-list-count">9</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/环境搭建/">环境搭建</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/运营运维/">运营运维</a><span class="sidebar-module-list-count">10</span><ul class="sidebar-module-list-child"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/运营运维/代理/">代理</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/运营运维/网站/">网站</a><span class="sidebar-module-list-count">1</span></li></ul></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tags</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ansible/">ansible</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/antd/">antd</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/cookie/">cookie</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/cors/">cors</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/crsf/">crsf</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/docker/">docker</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/drone/">drone</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/elasticsearch/">elasticsearch</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/flask/">flask</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/git/">git</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/github/">github</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/gitlab/">gitlab</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/golang/">golang</a><span class="sidebar-module-list-count">27</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/gorm/">gorm</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/grpc/">grpc</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/hexo/">hexo</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/influxdb/">influxdb</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/jsonp/">jsonp</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/jsonschema/">jsonschema</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/kibana/">kibana</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/martini/">martini</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/nginx/">nginx</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ngrok/">ngrok</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/node/">node</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/openldap/">openldap</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/pip/">pip</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/proxy/">proxy</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/python/">python</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/redis/">redis</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/sentry/">sentry</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/sqlalchemy/">sqlalchemy</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ssh/">ssh</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/sso/">sso</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/tars/">tars</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/tavern/">tavern</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/travis/">travis</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/uml/">uml</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/wcgi/">wcgi</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/xss/">xss</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/一致性hash/">一致性hash</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/持续集成/">持续集成</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/盗链/">盗链</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/签名/">签名</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/证书/">证书</a><span class="sidebar-module-list-count">2</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tag Cloud</h4>
    <p class="tagcloud">
      <a href="/tags/ansible/" style="font-size: 10px;">ansible</a> <a href="/tags/antd/" style="font-size: 10px;">antd</a> <a href="/tags/cookie/" style="font-size: 11.67px;">cookie</a> <a href="/tags/cors/" style="font-size: 10px;">cors</a> <a href="/tags/crsf/" style="font-size: 10px;">crsf</a> <a href="/tags/docker/" style="font-size: 13.33px;">docker</a> <a href="/tags/drone/" style="font-size: 16.67px;">drone</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/flask/" style="font-size: 11.67px;">flask</a> <a href="/tags/git/" style="font-size: 11.67px;">git</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/gitlab/" style="font-size: 11.67px;">gitlab</a> <a href="/tags/golang/" style="font-size: 20px;">golang</a> <a href="/tags/gorm/" style="font-size: 10px;">gorm</a> <a href="/tags/grpc/" style="font-size: 10px;">grpc</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/influxdb/" style="font-size: 10px;">influxdb</a> <a href="/tags/jsonp/" style="font-size: 10px;">jsonp</a> <a href="/tags/jsonschema/" style="font-size: 10px;">jsonschema</a> <a href="/tags/kibana/" style="font-size: 10px;">kibana</a> <a href="/tags/martini/" style="font-size: 10px;">martini</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/ngrok/" style="font-size: 11.67px;">ngrok</a> <a href="/tags/node/" style="font-size: 10px;">node</a> <a href="/tags/openldap/" style="font-size: 13.33px;">openldap</a> <a href="/tags/pip/" style="font-size: 10px;">pip</a> <a href="/tags/proxy/" style="font-size: 13.33px;">proxy</a> <a href="/tags/python/" style="font-size: 11.67px;">python</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/sentry/" style="font-size: 11.67px;">sentry</a> <a href="/tags/sqlalchemy/" style="font-size: 10px;">sqlalchemy</a> <a href="/tags/ssh/" style="font-size: 11.67px;">ssh</a> <a href="/tags/sso/" style="font-size: 10px;">sso</a> <a href="/tags/tars/" style="font-size: 10px;">tars</a> <a href="/tags/tavern/" style="font-size: 10px;">tavern</a> <a href="/tags/travis/" style="font-size: 10px;">travis</a> <a href="/tags/uml/" style="font-size: 10px;">uml</a> <a href="/tags/wcgi/" style="font-size: 10px;">wcgi</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/一致性hash/" style="font-size: 10px;">一致性hash</a> <a href="/tags/持续集成/" style="font-size: 18.33px;">持续集成</a> <a href="/tags/盗链/" style="font-size: 10px;">盗链</a> <a href="/tags/签名/" style="font-size: 11.67px;">签名</a> <a href="/tags/证书/" style="font-size: 11.67px;">证书</a>
    </p>
  </div>


  
  <div class="sidebar-module">
    <h4>Archives</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/08/">八月 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/06/">六月 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/03/">三月 2020</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/02/">二月 2020</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/01/">一月 2020</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/07/">七月 2018</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/06/">六月 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/05/">五月 2018</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/12/">十二月 2017</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/10/">十月 2017</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/08/">八月 2017</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/07/">七月 2017</a><span class="sidebar-module-list-count">8</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/06/">六月 2017</a><span class="sidebar-module-list-count">7</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/04/">四月 2017</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/03/">三月 2017</a><span class="sidebar-module-list-count">10</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/02/">二月 2017</a><span class="sidebar-module-list-count">10</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Recents</h4>
    <ul class="sidebar-module-list">
      
        <li>
          <a href="/2020/08/01/gitlab-sentry/">gitlab/sentry集成</a>
        </li>
      
        <li>
          <a href="/2020/06/10/ansible/">Ansible实践</a>
        </li>
      
        <li>
          <a href="/2020/03/08/elasticsearch_basic/">ElasticSearch学习笔记</a>
        </li>
      
        <li>
          <a href="/2020/02/29/jaeger_basic/">Jaeger初探</a>
        </li>
      
        <li>
          <a href="/2020/02/20/tavern/">ResfulApi测试框架tavern</a>
        </li>
      
    </ul>
  </div>



        </div>
    </div>
  </div>
  <footer class="blog-footer">
  <div class="container">
    <div id="footer-info" class="inner">
      &copy; 2020 KingQiu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      <br/>
      CopyRight © 2019 <a href="http://beian.miit.gov.cn/" target="_blank">粤ICP备19068003号</a>
    </div>
  </div>
</footer>
<script>
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

  
<script>
  var disqus_shortname = 'blog-qiujinwu-com';
  
  var disqus_url = 'http://blog.kimq.cn/2017/07/05/ngrok/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js" crossorigin="anonymous"></script>

<script src="http://cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js" crossorigin="anonymous"></script>



<script src="/js/script.js"></script>

</body>
</html>
