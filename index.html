<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta name="google-site-verification" content="6jvcY_UrCpp1JLjXITf45ljboLU0NDGF16ZqomMt-ls">
  
  <title>个人笔记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="随笔">
<meta property="og:type" content="website">
<meta property="og:title" content="个人笔记">
<meta property="og:url" content="http://blog.kimq.cn/index.html">
<meta property="og:site_name" content="个人笔记">
<meta property="og:description" content="随笔">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="个人笔记">
<meta name="twitter:description" content="随笔">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" integrity="sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+" crossorigin="anonymous">

  <link rel="stylesheet" href="/css/styles.css">
  

</head>
</html>
<body>
  <nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="main-menu-navbar">
      <ul class="nav navbar-nav">
        
          <li><a class="active"
                 href="/index.html">Home</a></li>
        
          <li><a class=""
                 href="/archives/">Archives</a></li>
        
          <li><a class=""
                 href="/atom.xml">Rss</a></li>
        
      </ul>

      <!--
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

  <div class="container">
    <div class="blog-header">
  <h1 class="blog-title">个人笔记</h1>
  
    <p class="lead blog-description">专注互联网</p>
  
</div>

    <div class="row">
        <div class="col-sm-9 blog-main">
          
  
    <article id="post-gitlab-sentry" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/01/gitlab-sentry/">gitlab/sentry集成</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2020/08/01/gitlab-sentry/" class="article-date"><time datetime="2020-08-01T02:36:35.000Z" itemprop="datePublished">2020-08-01</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/开发环境/">开发环境</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>gitlab/sentry都通过docker在本机运行, 本机docker 接口ip地址<code>172.17.0.1</code></p>
<p>参考旧文</p>
<ul>
<li><a href="https://blog.kimq.cn/2017/06/19/gitlab-env/">搭建gitlab测试环境</a></li>
<li><a href="https://blog.kimq.cn/2017/03/10/sentry/">Sentry</a></li>
</ul>
<h1 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h1><h2 id="运行Sentry"><a href="#运行Sentry" class="headerlink" title="运行Sentry"></a>运行Sentry</h2><p>为了避免端口冲突, sentry端口改成8081</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -d --name my-sentry -e SENTRY_SECRET_KEY=&apos;&lt;KEY&gt;&apos; \</span><br><span class="line">	-p 8081:9000 \</span><br><span class="line">	--link sentry-redis:redis --link sentry-postgres:postgres sentry:9.1.2</span><br></pre></td></tr></table></figure>
<h2 id="运行Gitlab"><a href="#运行Gitlab" class="headerlink" title="运行Gitlab"></a>运行Gitlab</h2><ul>
<li>这里指定了ce的版本, 避免新版本再测试出现不一致</li>
<li>通过参数指定了<code>hostname</code>为docker的ip</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -it --rm  \</span><br><span class="line">    --hostname 172.17.0.1 \</span><br><span class="line">    --publish 8080:80 --publish 2222:22 \</span><br><span class="line">    --name gitlab \</span><br><span class="line">    --volume /gitlab/config:/etc/gitlab \</span><br><span class="line">    --volume /gitlab/logs:/var/log/gitlab \</span><br><span class="line">    --volume /gitlab/data:/var/opt/gitlab \</span><br><span class="line">    gitlab/gitlab-ce:12.9.10-ce.0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>22端口容易被现有服务占用, 这里使用<code>2222端口</code>用作代码传输的ssl通道</p>
</blockquote>
<p>可以修改本机的<code>~/.ssh/config</code>, 参考<a href="https://stackoverflow.com/questions/3596260/git-remote-add-with-other-ssh-port" target="_blank" rel="noopener">这里</a><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat ~/.ssh/config </span><br><span class="line">HOST 172.17.0.1</span><br><span class="line">    Port 2222</span><br></pre></td></tr></table></figure></p>
<h1 id="gitlab集成sentry"><a href="#gitlab集成sentry" class="headerlink" title="gitlab集成sentry"></a>gitlab集成sentry</h1><blockquote>
<p>可以查看对应proj的问题,以及作出处理</p>
</blockquote>
<p>就是gitlab里面使用sentry的功能, 所以需要去sentry<code>赋(授)能(权)</code></p>
<ul>
<li>登录sentry</li>
<li>左上角 - 个人中心 - 下拉菜单 - API key</li>
<li>打开页面, 找到或者创建auth token, 需要<code>project:read, event:read</code> 两个权限</li>
</ul>
<p>完整流程, 可以查看<a href="https://docs.gitlab.com/ee/operations/error_tracking.html" target="_blank" rel="noopener">Gitlab Error Tracking</a></p>
<h2 id="gitlab-proj启用error-tracking"><a href="#gitlab-proj启用error-tracking" class="headerlink" title="gitlab proj启用error tracking"></a>gitlab proj启用<code>error tracking</code></h2><ul>
<li>Navigate to your project’s <code>Settings &gt; Operations</code>.</li>
<li>Ensure that the <code>Active</code> checkbox is set.</li>
<li>In the Sentry API URL field, enter your Sentry hostname. For example, enter <a href="https://sentry.example.com" target="_blank" rel="noopener">https://sentry.example.com</a> (本例<code>http://172.17.0.1:8081/</code>) if this is the address at which your Sentry instance is available. For the SaaS version of Sentry, the hostname will be <a href="https://sentry.io" target="_blank" rel="noopener">https://sentry.io</a>.</li>
<li>In the Auth Token field, enter the token you <code>previously generated</code>(见上一步生成的token).</li>
<li>Click the Connect button to test the connection to Sentry and populate the Project dropdown.</li>
<li>From the Project dropdown, choose a <code>Sentry project</code> to link to your GitLab project.</li>
<li>Click <code>Save changes</code> for the changes to take effect.</li>
<li>You can now visit <code>Operations &gt; Error Tracking</code> in your project’s sidebar to view a list of Sentry errors.</li>
</ul>
<p>到此, 我们可以在gitlab看到对应项目的所有senry 问题记录, 对于<code>gitlab-ce:12.9.10-ce.0</code> , 最上面可以<code>查看/过滤</code>问题, 也可以<code>忽略/解决</code>问题, 也可以基于问题新建一个<code>gitlab issue</code></p>
<blockquote>
<p>这些操作需要额外的<code>event:admin</code> 权限</p>
</blockquote>
<p>而更早的<code>gitlab-ce:12.3.5-ce.0</code> 就只有一个简单的列表</p>
<blockquote>
<p>对于本机自建的gitlab, 有可能报错<code>Connection has failed. Re-check Auth Token and try again</code>, 参考<a href="https://gitlab.com/gitlab-org/gitlab/-/issues/32314" target="_blank" rel="noopener">这里</a></p>
</blockquote>
<p>GitLab -&gt; Admim area -&gt; Settings -&gt; Network -&gt; Outbound requests -&gt; Allow requests to the local network from hooks and services</p>
<p>By checking both boxes, everything worked as documented.</p>
<h1 id="Sentry-集成-gitlab"><a href="#Sentry-集成-gitlab" class="headerlink" title="Sentry 集成 gitlab"></a>Sentry 集成 gitlab</h1><blockquote>
<p>可以直接在sentry创建gitlab issue</p>
</blockquote>
<ul>
<li>In Sentry, navigate to Organization <code>Settings &gt; Integrations</code>.</li>
<li>Within Integrations, find the <code>GitLab icon</code> and click Install.</li>
<li>In the resulting modal, click <code>Add Installation</code>.</li>
<li>In the pop-up window, complete the instructions to create a Sentry app within GitLab. Once you’re finished, click Next.</li>
<li>Fill out the resulting GitLab Configuration form with the following information:<ul>
<li>The GitLab URL is the base URL for your GitLab instance. If using gitlab.com, enter <a href="http://172.17.0.1:8080" target="_blank" rel="noopener">http://172.17.0.1:8080</a></li>
<li>Find the GitLab Group Path in your group’s GitLab page. 自定, 必须gitlab存在</li>
<li>Find the GitLab Application ID and Secret in the Sentry app within GitLab.<ul>
<li>GitLab Application ID : gitlab生成 - GitLab Application Secret : gitlab生成</li>
</ul>
</li>
<li>Use this information to fill out the GitLab Configuration and click Submit.</li>
</ul>
</li>
<li>In the resulting panel, click <code>Authorize</code>.</li>
<li>In Sentry, return to Organization Settings &gt; Integrations. You’ll see a new instance of GitLab underneath the list of integrations.</li>
<li>Next to your GitLab Instance, click Configure. It’s important to configure to receive the full benefits of commit tracking.</li>
<li>On the resulting page, click Add Repository to select which repositories in which you’d like to begin tracking commits.</li>
</ul>
<p>完整记录参考<a href="https://docs.sentry.io/workflow/integrations/gitlab/" target="_blank" rel="noopener">integrations gitlab</a></p>
<h2 id="生成gitlab-application"><a href="#生成gitlab-application" class="headerlink" title="生成gitlab application"></a>生成gitlab application</h2><p>具体的流程参考 <a href="https://docs.gitlab.com/ee/integration/oauth_provider.html" target="_blank" rel="noopener">GitLab as OAuth2 authentication service provider</a></p>
<ul>
<li>Name : Sentry (自定义)</li>
<li>Redirect URI : <a href="http://172.17.0.1:8081/extensions/gitlab/setup/" target="_blank" rel="noopener">http://172.17.0.1:8081/extensions/gitlab/setup/</a></li>
<li>Scopes : <code>api</code></li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://docs.gitlab.com/ee/operations/error_tracking.html" target="_blank" rel="noopener">https://docs.gitlab.com/ee/operations/error_tracking.html</a></li>
<li><a href="https://docs.gitlab.com/ee/integration/oauth_provider.html" target="_blank" rel="noopener">https://docs.gitlab.com/ee/integration/oauth_provider.html</a></li>
<li><a href="https://docs.sentry.io/workflow/integrations/gitlab/" target="_blank" rel="noopener">https://docs.sentry.io/workflow/integrations/gitlab/</a></li>
<li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/32314" target="_blank" rel="noopener">https://gitlab.com/gitlab-org/gitlab/-/issues/32314</a></li>
</ul>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2020/08/01/gitlab-sentry/" data-id="ckdbgbyvz001j43poalktwudl" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2020/08/01/gitlab-sentry/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gitlab/">gitlab</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sentry/">sentry</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-ansible" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/10/ansible/">Ansible实践</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2020/06/10/ansible/" class="article-date"><time datetime="2020-06-10T16:00:00.000Z" itemprop="datePublished">2020-06-11</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/运营运维/">运营运维</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install software-properties-common</span><br><span class="line">$ sudo apt-add-repository ppa:ansible/ansible</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install ansible</span><br></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /etc/ansible/hosts  | sed -e <span class="string">"/^#/d"</span> -e <span class="string">"/^$/d"</span></span><br><span class="line">localhost ansible_connection=<span class="built_in">local</span></span><br></pre></td></tr></table></figure>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ansible all -a &quot;whoami&quot;</span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br></pre></td></tr></table></figure>
<h1 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h1><p>文件路径<code>/etc/ansible/hosts</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">192.168.1.50</span><br><span class="line">aserver.example.org</span><br><span class="line">bserver.example.org</span><br></pre></td></tr></table></figure>
<p>ansible 典型参数</p>
<ul>
<li>可用性<code>-m ping</code></li>
<li>执行commands <code>-a cmd</code></li>
<li>全局替换ssh登录用户 <code>-u</code></li>
<li>全局替换ssh key <code>--private-key</code></li>
<li>sudo <code>--sudo</code>, <code>--sudo-user root2</code></li>
<li><code>--list-hosts</code> 列出hosts</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 第一个参数有个特例，all表示所有</span></span><br><span class="line">$ ansible localhost  -m ping</span><br><span class="line">localhost | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">$ ansible all -a <span class="string">"whoami"</span></span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">$ sudo ansible all -a <span class="string">"whoami"</span> -u root --sudo</span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">root</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出特定name的hosts</span></span><br><span class="line">$ ansible <span class="built_in">test</span> --list-hosts</span><br><span class="line">  hosts (2):</span><br><span class="line">    virtualbox</span><br><span class="line">    localhost</span><br></pre></td></tr></table></figure>
<h2 id="ssh-key"><a href="#ssh-key" class="headerlink" title="ssh key"></a>ssh key</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ssh-keygen </span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/home/king/.ssh/id_rsa): /home/king/.ssh/ansible</span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /home/king/.ssh/ansible.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /home/king/.ssh/ansible.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:T1liGGmbLRZI4lKIIdWn3gvWg8h/6F7hi/tgpFsNbPk king@king</span><br><span class="line">The key<span class="string">'s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 2048]----+</span></span><br><span class="line"><span class="string">|o+.oo.....       |</span></span><br><span class="line"><span class="string">|o .o..o +o       |</span></span><br><span class="line"><span class="string">|  . .o ..=o .    |</span></span><br><span class="line"><span class="string">|   o..  =..+     |</span></span><br><span class="line"><span class="string">| . o*+..S.o      |</span></span><br><span class="line"><span class="string">|  o+==+. o       |</span></span><br><span class="line"><span class="string">|  .o+oEo  .      |</span></span><br><span class="line"><span class="string">|   +o+o.         |</span></span><br><span class="line"><span class="string">|  .o=+o          |</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br><span class="line"><span class="string">$ ssh-copy-id -i ~/.ssh/ansible -o "PubkeyAuthentication no" king@192.168.2.131</span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/home/king/.ssh/ansible.pub"</span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span></span><br><span class="line"><span class="string">king@192.168.2.131'</span>s password: </span><br><span class="line">Number of key(s) added: 1</span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh -o 'PubkeyAuthentication no' 'king@192.168.2.131'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"><span class="comment"># 注意`SSH_AUTH_SOCK`</span></span><br><span class="line">$ SSH_AUTH_SOCK=0  ssh -i /home/king/.ssh/ansible  king@192.168.2.131</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ SSH_AUTH_SOCK=0 ansible 192.168.2.131 -a whoami --private-key=/home/king/.ssh/ansible </span><br><span class="line">192.168.2.131 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br></pre></td></tr></table></figure>
<h1 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h1><ul>
<li>ansible_ssh_host 将要连接的远程主机名.与你想要设定的主机的别名不同的话,可通过此变量设置.</li>
<li>ansible_ssh_port ssh端口号.如果不是默认的端口号,通过此变量设置.</li>
<li>ansible_ssh_user 默认的 ssh 用户名</li>
<li>ansible_ssh_pass ssh 密码(这种方式并不安全,我们强烈建议使用 –ask-pass 或 SSH 密钥)</li>
<li>ansible_sudo_pass sudo 密码(这种方式并不安全,我们强烈建议使用 –ask-sudo-pass)</li>
<li>ansible_sudo_exe (new in version 1.8) sudo 命令路径(适用于1.8及以上版本)</li>
<li>ansible_connection 与主机的连接类型.比如:local, ssh 或者 paramiko. Ansible 1.2 以前默认使用 paramiko.1.2 以后默认使用 ‘smart’,’smart’ 方式会根据是否支持 ControlPersist, 来判断’ssh’ 方式是否可行.</li>
<li>ansible_ssh_private_key_file ssh 使用的私钥文件.适用于有多个密钥,而你不想使用 SSH 代理的情况.</li>
<li>ansible_shell_type 目标系统的shell类型.默认情况下,命令的执行使用 ‘sh’ 语法,可设置为 ‘csh’ 或 ‘fish’.</li>
</ul>
<p>修改<code>/etc/ansible/hosts</code><br><figure class="highlight"><table><tr><td class="code"><pre><span class="line">192.168.2.131 ansible_ssh_user=king ansible_ssh_private_key_file=/home/king/.ssh/ansible</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ SSH_AUTH_SOCK=0 ansible all -a whoami </span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">192.168.2.131 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br></pre></td></tr></table></figure>
<h2 id="组和别名"><a href="#组和别名" class="headerlink" title="组和别名"></a>组和别名</h2><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[test]</span></span><br><span class="line"><span class="comment">#192.168.2.131 ansible_ssh_user=king ansible_ssh_private_key_file=/home/king/ansible</span></span><br><span class="line">virtualbox ansible_ssh_host=192.168.2.131 ansible_ssh_user=king ansible_ssh_private_key_file=/home/king/ansible</span><br><span class="line">localhost              ansible_connection=local</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ SSH_AUTH_SOCK=0 ansible <span class="built_in">test</span> -a whoami </span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">192.168.2.131 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">$ SSH_AUTH_SOCK=0 ansible <span class="built_in">test</span> -a whoami </span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">virtualbox | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br></pre></td></tr></table></figure>
<h3 id="主机-amp-组变量"><a href="#主机-amp-组变量" class="headerlink" title="主机&amp;组变量"></a>主机&amp;组变量</h3><p><code>/etc/ansible/hosts</code> 每个主机支持一系列参数, 如果一个组的参数有重复, 可以做成<code>组变量</code><br><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[bastion]</span></span><br><span class="line">b1 ansible_ssh_user=admin ansible_ssh_private_key_file=/home/king/.ssh/bastion</span><br><span class="line">b2 ansible_ssh_user=admin ansible_ssh_private_key_file=/home/king/.ssh/bastion</span><br><span class="line">b3 ansible_ssh_user=admin ansible_ssh_private_key_file=/home/king/.ssh/bastion</span><br></pre></td></tr></table></figure></p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[bastion]</span></span><br><span class="line">b1 </span><br><span class="line">b2 </span><br><span class="line">b3 </span><br><span class="line"></span><br><span class="line"><span class="section">[bastion:vars]</span></span><br><span class="line"><span class="attr">ansible_ssh_user</span>=admin </span><br><span class="line"><span class="attr">ansible_ssh_private_key_file</span>=/home/king/.ssh/bastion</span><br></pre></td></tr></table></figure>
<h1 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h1><ul>
<li><code>ansible-doc -l</code> 来列出支持的模块</li>
<li><code>ansible-doc -s command</code> 列出特定模块的指引</li>
</ul>
<blockquote>
<p>默认ansible使用的模块是<code>command</code>，即可以执行一些<code>shell</code>命令。shell和command的用法基本一样，实际上shell模块执行命令的方式是在远程使用<code>/bin/sh</code>来执行的</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible <span class="built_in">test</span> -m <span class="built_in">command</span> -a whoami</span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">virtualbox | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">$ ansible <span class="built_in">test</span> -m shell -a whoami</span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">virtualbox | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br></pre></td></tr></table></figure>
<blockquote>
<p>最开始的<code>ping</code>也是一个特定的模块</p>
</blockquote>
<h2 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h2><p>拷贝文件到服务器, 会自动判断是否有修改</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ansible virtualbox -m copy -a src=&quot;~/1.pdf dest=/tmp mode=0770 owner=king group=fa backup=yes&quot;</span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;429b1cd33dcb3e71e9975e424994906f10c6d98d&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/1.pdf&quot;, </span><br><span class="line">    &quot;gid&quot;: 1000, </span><br><span class="line">    &quot;group&quot;: &quot;fa&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0770&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;king&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;/tmp/1.pdf&quot;, </span><br><span class="line">    &quot;size&quot;: 56111, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 1000</span><br><span class="line">&#125;</span><br><span class="line">$ ansible virtualbox -m copy -a src=&quot;~/1.pdf dest=/tmp mode=0770 owner=king group=fa backup=yes&quot;</span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;checksum&quot;: &quot;429b1cd33dcb3e71e9975e424994906f10c6d98d&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/1.pdf&quot;, </span><br><span class="line">    &quot;gid&quot;: 1000, </span><br><span class="line">    &quot;group&quot;: &quot;fa&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0770&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;king&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;/tmp/1.pdf&quot;, </span><br><span class="line">    &quot;size&quot;: 56111, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 1000</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 目录也支持</span><br><span class="line">$ ansible virtualbox -m copy -a src=&quot;~/s dest=/tmp&quot;</span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/&quot;, </span><br><span class="line">    &quot;src&quot;: &quot;/home/king/s&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果使用”/“结尾，则拷贝的是目录中的文件，如果不以斜杠结尾，则拷贝的是目录加目录中的文件。</p>
</blockquote>
<h2 id="file"><a href="#file" class="headerlink" title="file"></a>file</h2><p>管理文件、目录的属性，也可以创建文件或目录。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ansible-doc -s file</span><br><span class="line">- name: Sets attributes of files</span><br><span class="line">  action: file</span><br><span class="line">      group       # file/directory的所属组</span><br><span class="line">      owner       # file/directory的所有者</span><br><span class="line">      mode        # 修改权限，格式可以是0644、&apos;u+rwx&apos;或&apos;u=rw,g=r,o=r&apos;等</span><br><span class="line">      path=       # 指定待操作的文件，可使用别名&apos;dest&apos;或&apos;name&apos;来替代path</span><br><span class="line">      recurse     # (默认no)递归修改文件的属性信息，要求state=directory</span><br><span class="line">      src         # 创建链接时使用，指定链接的源文件</span><br><span class="line">      state       # directory:如果目录不存在则递归创建</span><br><span class="line">                  # file:文件不存在时，不会被创建(默认值)</span><br><span class="line">                  # touch:touch由path指定的文件，即创建一个新文件，或修改其mtime和atime</span><br><span class="line">                  # link:修改或创建软链接</span><br><span class="line">                  # hard:修改或创建硬链接</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible virtualbox -m file -a <span class="string">'path=/tmp/x/y/z state=directory owner=king group=fa mode=0755 recurse=yes'</span></span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"gid"</span>: 1000, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"fa"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0755"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"king"</span>, </span><br><span class="line">    <span class="string">"path"</span>: <span class="string">"/tmp/x/y/z"</span>, </span><br><span class="line">    <span class="string">"size"</span>: 4096, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"directory"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: 1000</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="fetch"><a href="#fetch" class="headerlink" title="fetch"></a>fetch</h2><p>和<code>copy</code>工作方式类似，只不过是从远程主机将文件拉取到本地端，存储时使用主机名作为目录树，且只能拉取文件不能拉取目录。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-doc -s fetch</span><br><span class="line">- name: Fetches a file from remote nodes</span><br><span class="line">  action: fetch</span><br><span class="line">      dest=               <span class="comment"># 本地存储拉取文件的目录。例如dest=/data，src=/etc/fstab，</span></span><br><span class="line">                          <span class="comment"># 远程主机名host.exp.com，则保存的路径为/data/host.exp.com/etc/fstab。</span></span><br><span class="line">      fail_on_missing     <span class="comment"># 当设置为yes时，如果拉取的源文件不存在，则此任务失败。默认为no。</span></span><br><span class="line">      flat                <span class="comment"># 改变拉取后的路径存储方式。如果设置为yes，且当dest以"/"结尾时，将直接把源文件</span></span><br><span class="line">                          <span class="comment"># 的basename存储在dest下。显然，应该考虑多个主机拉取时的文件覆盖情况。</span></span><br><span class="line">      src=                <span class="comment"># 远程主机上的源文件。只能是文件，不支持目录。在未来的版本中可能会支持目录递归拉取。</span></span><br><span class="line">      validate_checksum   <span class="comment"># fetch到文件后，检查其md5和源文件是否相同。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible virtualbox -m fetch -a <span class="string">"src=/tmp/1.pdf dest=/tmp/"</span></span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"checksum"</span>: <span class="string">"429b1cd33dcb3e71e9975e424994906f10c6d98d"</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/virtualbox/tmp/1.pdf"</span>, </span><br><span class="line">    <span class="string">"md5sum"</span>: <span class="string">"d7fa85f4857527c3a58290a0be2b679a"</span>, </span><br><span class="line">    <span class="string">"remote_checksum"</span>: <span class="string">"429b1cd33dcb3e71e9975e424994906f10c6d98d"</span>, </span><br><span class="line">    <span class="string">"remote_md5sum"</span>: null</span><br><span class="line">&#125;</span><br><span class="line">$ ansible virtualbox -m fetch -a <span class="string">"src=/tmp/1.pdf dest=/tmp/ flat=yes"</span></span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"checksum"</span>: <span class="string">"429b1cd33dcb3e71e9975e424994906f10c6d98d"</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/1.pdf"</span>, </span><br><span class="line">    <span class="string">"md5sum"</span>: <span class="string">"d7fa85f4857527c3a58290a0be2b679a"</span>, </span><br><span class="line">    <span class="string">"remote_checksum"</span>: <span class="string">"429b1cd33dcb3e71e9975e424994906f10c6d98d"</span>, </span><br><span class="line">    <span class="string">"remote_md5sum"</span>: null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="apt"><a href="#apt" class="headerlink" title="apt"></a>apt</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 yes/safe/full/dist</span></span><br><span class="line">$ ansible virtualbox -m apt -a <span class="string">"name=dos2unix update_cache=yes"</span> --sudo --ask-sudo-pass</span><br><span class="line">SUDO password: </span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"cache_update_time"</span>: 1591944887, </span><br><span class="line">    <span class="string">"cache_updated"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"stderr"</span>: <span class="string">""</span>, </span><br><span class="line">    <span class="string">"stdout"</span>: <span class="string">"正在读取软件包列表..."</span></span><br><span class="line"><span class="comment"># 移除</span></span><br><span class="line">$ ansible virtualbox -m apt -a <span class="string">"name=dos2unix state=absent"</span> --sudo --ask-sudo-pass</span><br><span class="line"><span class="comment"># 安装 latest/absent/present</span></span><br><span class="line">$ ansible virtualbox -m apt -a <span class="string">"name=dos2unix state=present"</span> --sudo --ask-sudo-pass</span><br></pre></td></tr></table></figure>
<h2 id="service"><a href="#service" class="headerlink" title="service"></a>service</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># running,started,stopped,restarted,reloaded</span></span><br><span class="line">$ ansible virtualbox -m service -a <span class="string">"name=nginx state=stopped "</span> --sudo --ask-sudo-pass</span><br><span class="line">SUDO password: </span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"nginx"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"stopped"</span></span><br><span class="line">&#125;</span><br><span class="line">$ ansible virtualbox -m service -a <span class="string">"name=nginx state=stopped "</span> --sudo --ask-sudo-pass</span><br><span class="line">SUDO password: </span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"nginx"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"stopped"</span></span><br><span class="line">&#125;</span><br><span class="line">$ ansible virtualbox -m service -a <span class="string">"name=nginx state=started "</span> --sudo --ask-sudo-pass</span><br><span class="line">SUDO password: </span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"nginx"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"started"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="playbook"><a href="#playbook" class="headerlink" title="playbook"></a>playbook</h2><p>一个playboook包含多个play, 每个play包含多个节</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">virtualbox</span></span><br><span class="line">  <span class="attr">tasks:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">execute</span> <span class="string">date</span> <span class="string">cmd</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/date</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">date</span> <span class="comment"># 注册到一个变量, 以便打印stdout</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">execute</span> <span class="string">shell</span> <span class="string">whoami</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">whoami</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">whoami</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">var=date.stdout_lines</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">msg="&#123;&#123;</span> <span class="string">whoami.stdout</span> <span class="string">&#125;&#125;"</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">virtualbox</span></span><br><span class="line">  <span class="attr">tasks:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">execute</span> <span class="string">date</span> <span class="string">cmd</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">msg="&#123;&#123;</span> <span class="string">nginx</span> <span class="string">&#125;&#125;"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible-playbook a.yaml </span><br><span class="line"></span><br><span class="line">PLAY ***************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [setup] *******************************************************************</span><br><span class="line">ok: [virtualbox]</span><br><span class="line"></span><br><span class="line">TASK [execute date cmd] ********************************************************</span><br><span class="line">changed: [virtualbox]</span><br><span class="line"></span><br><span class="line">TASK [execute shell whoami] ****************************************************</span><br><span class="line">changed: [virtualbox]</span><br><span class="line"></span><br><span class="line">TASK [debug] *******************************************************************</span><br><span class="line">ok: [virtualbox] =&gt; &#123;</span><br><span class="line">    <span class="string">"date.stdout_lines"</span>: [</span><br><span class="line">        <span class="string">"2020年 06月 12日 星期五 15:50:36 CST"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [debug] *******************************************************************</span><br><span class="line">ok: [virtualbox] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"king"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY ***************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [setup] *******************************************************************</span><br><span class="line">ok: [virtualbox]</span><br><span class="line"></span><br><span class="line">TASK [execute date cmd] ********************************************************</span><br><span class="line">ok: [virtualbox]</span><br><span class="line"></span><br><span class="line">TASK [debug] *******************************************************************</span><br><span class="line">ok: [virtualbox] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: &#123;</span><br><span class="line">        <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"nginx"</span>, </span><br><span class="line">        <span class="string">"state"</span>: <span class="string">"started"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">virtualbox                 : ok=8    changed=2    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>
<h1 id="Bastion"><a href="#Bastion" class="headerlink" title="Bastion"></a>Bastion</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[server]</span><br><span class="line">server1 ansible_ssh_host=10.2.40.11</span><br><span class="line">server2 ansible_ssh_host=10.2.40.22 </span><br><span class="line">server3 ansible_ssh_host=10.2.40.33</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[server:vars]</span><br><span class="line">ansible_ssh_user=admin </span><br><span class="line">ansible_ssh_private_key_file=/home/king/.ssh/bastion</span><br><span class="line">ansible_ssh_common_args=&apos; -o ProxyCommand=&quot;ssh -W %h:%p bastion_admin@bastion_ip&quot;&apos;</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="https://ansible-tran.readthedocs.io/en/latest/docs/intro_getting_started.html#id1" target="_blank" rel="noopener">新手上路</a></li>
<li><a href="https://askubuntu.com/questions/762541/ubuntu-16-04-ssh-sign-and-send-pubkey-signing-failed-agent-refused-operation" target="_blank" rel="noopener">https://askubuntu.com/questions/762541/ubuntu-16-04-ssh-sign-and-send-pubkey-signing-failed-agent-refused-operation</a></li>
<li><a href="https://blog.scottlowe.org/2015/12/24/running-ansible-through-ssh-bastion-host/" target="_blank" rel="noopener">Running Ansible Through an SSH Bastion Host</a></li>
<li><a href="https://www.cnblogs.com/f-ck-need-u/p/7553186.html" target="_blank" rel="noopener">Ansible系列(一)：基本配置和使用</a></li>
<li><a href="https://www.cnblogs.com/f-ck-need-u/p/7550603.html" target="_blank" rel="noopener">Ansible系列(二)：选项和常用模块</a></li>
<li><a href="https://www.w3cschool.cn/automate_with_ansible/automate_with_ansible-db6727oq.html" target="_blank" rel="noopener">https://www.w3cschool.cn/automate_with_ansible/automate_with_ansible-db6727oq.html</a></li>
<li><a href="https://www.jianshu.com/p/446f0ab2e131" target="_blank" rel="noopener">https://www.jianshu.com/p/446f0ab2e131</a></li>
</ol>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2020/06/10/ansible/" data-id="ckdbgbyux000443pos3bb5u3i" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2020/06/10/ansible/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ansible/">ansible</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-elasticsearch_basic" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/08/elasticsearch_basic/">ElasticSearch学习笔记</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2020/03/08/elasticsearch_basic/" class="article-date"><time datetime="2020-03-08T16:00:00.000Z" itemprop="datePublished">2020-03-09</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/运营运维/">运营运维</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h1><blockquote>
<p><code>ip</code>酌情修改</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker pull kibana:6.5.4</span><br><span class="line">$ docker pull elasticsearch:6.5.4</span><br><span class="line">$ docker run -d -p 9200:9200 -p 9300:9300 -e <span class="string">"discovery.type=single-node"</span> \</span><br><span class="line">    --name elastic  elasticsearch:6.5.4</span><br><span class="line">$ docker run -d -e <span class="string">"ELASTICSEARCH_URL=http://192.168.2.139:9200"</span> \</span><br><span class="line">    --name kibana   -p 5601:5601 kibana:6.5.4</span><br></pre></td></tr></table></figure>
<h2 id="7-3-0"><a href="#7-3-0" class="headerlink" title="7.3.0"></a>7.3.0</h2><blockquote>
<p><code>认证</code>, <a href="https://www.elastic.co/guide/en/beats/filebeat/current/ilm.html" target="_blank" rel="noopener"><code>filebeat lifecycle</code></a><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker pull docker.elastic.co/beats/filebeat:7.3.1</span><br><span class="line"></span><br><span class="line">$ docker run -d -p 9200:9200 -p 9300:9300 -e <span class="string">"discovery.type=single-node"</span> \</span><br><span class="line">    -e <span class="string">"ELASTIC_USERNAME=elastic"</span> \</span><br><span class="line">    -e <span class="string">"ELASTIC_PASSWORD=kibana"</span> \</span><br><span class="line">    -e <span class="string">"xpack.security.enabled=true"</span> \</span><br><span class="line">    --name elastic  elasticsearch:7.3.0</span><br><span class="line"></span><br><span class="line">$ docker run -d -e <span class="string">"ELASTICSEARCH_HOSTS=http://192.168.2.139:9200"</span> \</span><br><span class="line">    -e <span class="string">"ELASTICSEARCH_USERNAME=elastic"</span> \</span><br><span class="line">    -e <span class="string">"ELASTICSEARCH_PASSWORD=kibana"</span> \</span><br><span class="line">    -e <span class="string">"xpack.security.enabled=true"</span> \</span><br><span class="line">    --name kibana   -p 5601:5601 kibana:7.3.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ docker run -d --name=filebeat  \</span><br><span class="line">	--volume=<span class="string">"C:\docker\filebeat\filebeat.docker.yml:/usr/share/filebeat/filebeat.yml:ro"</span> \</span><br><span class="line">    --volume=<span class="string">"D:\log:/var/lib/docker/containers:ro"</span> \</span><br><span class="line">    docker.elastic.co/beats/filebeat:7.3.0</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="beat直接运行"><a href="#beat直接运行" class="headerlink" title="beat直接运行"></a>beat直接运行</h3><p><a href="https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.3.0-linux-x86_64.tar.gz" target="_blank" rel="noopener">https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.3.0-linux-x86_64.tar.gz</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./filebeat-7.3.0-linux-x86_64/filebeat -c a.yml  -e -d <span class="string">"*"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">~/filebeat/x.log</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">["http://127.0.0.1:9200"]</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">"filebeat"</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">"filebeat"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setup.template.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.ilm.rollover_alias:</span> <span class="string">"filebeat-test"</span></span><br><span class="line"><span class="attr">setup.ilm.check_exists:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">setup.ilm.overwrite:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.ilm.pattern:</span> <span class="string">"&#123;now/d&#125;"</span></span><br></pre></td></tr></table></figure>
<h1 id="ECK"><a href="#ECK" class="headerlink" title="ECK"></a><a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-quickstart.html" target="_blank" rel="noopener">ECK</a></h1><h2 id="all-in-one"><a href="#all-in-one" class="headerlink" title="all in one"></a>all in one</h2><p>需要在集群中先安装 <a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-deploy-eck.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-deploy-eck.html</a></p>
<p>可以酌情修改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f https://download.elastic.co/downloads/eck/1.1.0/all-in-one.yaml</span><br></pre></td></tr></table></figure>
<p>一些细节</p>
<ul>
<li>比较费内存, 如果只是配置和验证, 可以适当调小</li>
<li>1个master和1个data 跑不起来, 非得各三个, 待查</li>
</ul>
<h2 id="帐号"><a href="#帐号" class="headerlink" title="帐号"></a>帐号</h2><ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/built-in-users.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/built-in-users.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/users-command.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/users-command.html</a></li>
</ul>
<p>进入pod</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 仅供测试</span><br><span class="line">$ bin/elasticsearch-users useradd king -p pwd -r superuser</span><br></pre></td></tr></table></figure>
<p>port forward</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -k -u king -XGET <span class="string">"https://127.0.0.1:9200/_count?pretty  "</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "query": &#123;</span></span><br><span class="line"><span class="string">    "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line">Enter host password <span class="keyword">for</span> user <span class="string">'king'</span>:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"count"</span> : 42,</span><br><span class="line">  <span class="string">"_shards"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : 3,</span><br><span class="line">    <span class="string">"successful"</span> : 3,</span><br><span class="line">    <span class="string">"skipped"</span> : 0,</span><br><span class="line">    <span class="string">"failed"</span> : 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">$ curl -k -u king:<span class="built_in">pwd</span> -XPUT <span class="string">"https://127.0.0.1:9200/idx  "</span> -H <span class="string">'Content-Type: application/json'</span></span><br><span class="line">&#123;<span class="string">"acknowledged"</span>:<span class="literal">true</span>,<span class="string">"shards_acknowledged"</span>:<span class="literal">true</span>,<span class="string">"index"</span>:<span class="string">"idx"</span>&#125;</span><br><span class="line">$ curl -k -u king:<span class="built_in">pwd</span> -XGET <span class="string">"https://127.0.0.1:9200/_count?pretty  "</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "query": &#123;</span></span><br><span class="line"><span class="string">    "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"count"</span> : 42,</span><br><span class="line">  <span class="string">"_shards"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : 3,</span><br><span class="line">    <span class="string">"successful"</span> : 3,</span><br><span class="line">    <span class="string">"skipped"</span> : 0,</span><br><span class="line">    <span class="string">"failed"</span> : 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h2><ul>
<li>curl</li>
<li>kibana -&gt; dev tools</li>
<li><a href="https://chrome.google.com/webstore/detail/elasticsearch-head/ffmkiejjmecolpfloofpjologoblkegm" target="_blank" rel="noopener">ElasticSearch Head</a></li>
<li><a href="https://github.com/mobz/elasticsearch-head" target="_blank" rel="noopener">https://github.com/mobz/elasticsearch-head</a> 同上</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -XGET <span class="string">"http://192.168.2.139:9200/_count?pretty  "</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "query": &#123;</span></span><br><span class="line"><span class="string">    "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET _count?pretty  </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match_all"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><ul>
<li>索引(index)</li>
<li>类型(type)</li>
<li>文档</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Relational DB -&gt; Databases -&gt; Tables -&gt; Rows -&gt; Columns</span><br><span class="line">Elasticsearch -&gt; Indices -&gt; Types -&gt; Documents -&gt; Fields</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Elasticsearch集群可以包含多个索引(indices)（数据库），每一个索引可以包含多个类型(types)（表），每一个类型包含多个文档(documents)（行），然后每个文档包含多个字段(Fields)（列）。</p>
</blockquote>
<h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><p>创建/查询<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT /megacorp/employee/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"first_name"</span>: <span class="string">"John"</span>,</span><br><span class="line">  <span class="string">"last_name"</span>: <span class="string">"Smith"</span>,</span><br><span class="line">  <span class="string">"age"</span>: 25,</span><br><span class="line">  <span class="string">"about"</span>: <span class="string">"I love to go rock climbing"</span>,</span><br><span class="line">  <span class="string">"interests"</span>: [</span><br><span class="line">    <span class="string">"sports"</span>,</span><br><span class="line">    <span class="string">"music"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>名字</th>
<th>说明</th>
<th>note</th>
</tr>
</thead>
<tbody>
<tr>
<td>megacorp</td>
<td>索引名</td>
<td>文档存储的地方</td>
</tr>
<tr>
<td>employee</td>
<td>类型名</td>
<td>文档代表的对象的类</td>
</tr>
<tr>
<td>1</td>
<td>这个员工的ID</td>
<td>文档的唯一标识</td>
</tr>
</tbody>
</table>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /megacorp/employee/1</span><br><span class="line">GET /megacorp/employee/_search?q=last_name:Smith</span><br><span class="line">GET /megacorp/employee/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match"</span>: &#123;</span><br><span class="line">      <span class="string">"last_name"</span>: <span class="string">"Smith"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="搜索类型"><a href="#搜索类型" class="headerlink" title="搜索类型"></a>搜索类型</h3><ul>
<li>query string 将所有参数通过查询字符串定义 <code>上面第二个查询</code></li>
<li>DSL 使用JSON完整的表示请求体(request body) <code>上面第三个查询</code></li>
</ul>
<h3 id="查询与过滤"><a href="#查询与过滤" class="headerlink" title="查询与过滤"></a>查询与过滤</h3><ul>
<li>结构化查询（Query DSL）</li>
<li>结构化过滤（Filter DSL）</li>
</ul>
<blockquote>
<p>对比返回结果的差异</p>
</blockquote>
<p>一条过滤语句会询问每个文档的字段值是否包含着特定值</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_index"</span> : <span class="string">"megacorp"</span>,</span><br><span class="line">  <span class="attr">"_type"</span> : <span class="string">"employee"</span>,</span><br><span class="line">  <span class="attr">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"_version"</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"found"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"_source"</span> : &#123;</span><br><span class="line">    <span class="attr">"first_name"</span> : <span class="string">"John"</span>,</span><br><span class="line">    <span class="attr">"last_name"</span> : <span class="string">"Smith"</span>,</span><br><span class="line">    <span class="attr">"age"</span> : <span class="number">25</span>,</span><br><span class="line">    <span class="attr">"about"</span> : <span class="string">"I love to go rock climbing"</span>,</span><br><span class="line">    <span class="attr">"interests"</span> : [</span><br><span class="line">      <span class="string">"sports"</span>,</span><br><span class="line">      <span class="string">"music"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一条查询语句会计算每个文档与查询语句的相关性，会给出一个相关性评分 _score ，并且按照相关性对匹配到的文档进行排序。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"took"</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"_shards"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="attr">"successful"</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="attr">"skipped"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"hits"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"max_score"</span> : <span class="number">0.2876821</span>,</span><br><span class="line">    <span class="attr">"hits"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"_index"</span> : <span class="string">"megacorp"</span>,</span><br><span class="line">        <span class="attr">"_type"</span> : <span class="string">"employee"</span>,</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"2"</span>,</span><br><span class="line">        <span class="attr">"_score"</span> : <span class="number">0.2876821</span>,</span><br><span class="line">        <span class="attr">"_source"</span> : &#123;</span><br><span class="line">          <span class="attr">"first_name"</span> : <span class="string">"Jane"</span>,</span><br><span class="line">          <span class="attr">"last_name"</span> : <span class="string">"Smith"</span>,</span><br><span class="line">          <span class="attr">"age"</span> : <span class="number">32</span>,</span><br><span class="line">          <span class="attr">"about"</span> : <span class="string">"I like to collect rock albums"</span>,</span><br><span class="line">          <span class="attr">"interests"</span> : [</span><br><span class="line">            <span class="string">"music"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="version"><a href="#version" class="headerlink" title="_version"></a>_version</h3><p>每个文档都有一个 <code>_version</code>号码， 这个号码在文档被改变时加一。Elasticsearch使用这个 _version 保证所有修改都被正确排序。当一个旧版本出现在新版本之后，它会被简单的忽略。</p>
<h1 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h1><h2 id="Search-search"><a href="#Search-search" class="headerlink" title="Search(_search)"></a>Search(<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/query-dsl-match-all-query.html" target="_blank" rel="noopener"><code>_search</code></a>)</h2><ul>
<li>全局 <code>/_search</code></li>
<li>索引 <code>/gb/_search</code>, <code>/gb,us/_search</code>, <code>/g*,u*/_search</code></li>
<li>类型 <code>/gb/user/_search</code>, <code>/gb,us/user,tweet/_search</code></li>
<li><code>/_all/user,tweet/_search</code></li>
</ul>
<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	"hits": &#123; # 实际结果</span><br><span class="line">		"total": 14, # 匹配到的文档总数</span><br><span class="line">		"hits": [&#123;</span><br><span class="line">			"_index": "us", # 索引</span><br><span class="line">			"_type": "tweet", # 类型</span><br><span class="line">			"_id": "7", # ID</span><br><span class="line">			"_score": 1, # 排序的分数</span><br><span class="line">			"_source": &#123; # 实际的内容</span><br><span class="line">				"date": "2014-09-17",</span><br><span class="line">				"name": "John Smith",</span><br><span class="line">				"tweet": "The Query DSL is really powerful and flexible",</span><br><span class="line">				"user_id": 2</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;],</span><br><span class="line">		"max_score": 1 # 是所有文档匹配查询中 _score 的最大值</span><br><span class="line">	&#125;,</span><br><span class="line">	"took": 4, # 搜索请求花费的毫秒数。</span><br><span class="line">	"_shards": &#123;</span><br><span class="line">		"failed": 0, # 失败的</span><br><span class="line">		"successful": 10, # 成功的</span><br><span class="line">		"total": 10 # 参与查询的分片数</span><br><span class="line">	&#125;,</span><br><span class="line">	"timed_out": false # 查询超时与否 `GET /_search?timeout=10ms`</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>_score 字段，这是相关性得分(<code>relevance score</code>)，它衡量了文档与查询的匹配程度</li>
</ul>
<h3 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /_search?size=5</span><br><span class="line">GET /_search?size=5&amp;from=5</span><br><span class="line">GET /_search?size=5&amp;from=10</span><br></pre></td></tr></table></figure>
<h3 id="检索一部分字段"><a href="#检索一部分字段" class="headerlink" title="检索一部分字段"></a>检索一部分字段</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /website/blog/123?_source=title,text</span><br></pre></td></tr></table></figure>
<h3 id="不要元数据"><a href="#不要元数据" class="headerlink" title="不要元数据"></a>不要元数据</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /website/blog/123/_source</span><br></pre></td></tr></table></figure>
<h3 id="是否存在"><a href="#是否存在" class="headerlink" title="是否存在"></a>是否存在</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HEAD /megacorp/employee/1</span><br></pre></td></tr></table></figure>
<h3 id="批量查询"><a href="#批量查询" class="headerlink" title="批量查询"></a>批量查询</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /_mget</span><br><span class="line">&#123;</span><br><span class="line">  &quot;docs&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_index&quot;: &quot;megacorp&quot;,</span><br><span class="line">      &quot;_type&quot;: &quot;employee&quot;,</span><br><span class="line">      &quot;_id&quot;: 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_index&quot;: &quot;megacorp&quot;,</span><br><span class="line">      &quot;_type&quot;: &quot;employee&quot;,</span><br><span class="line">      &quot;_id&quot;: 1,</span><br><span class="line">      &quot;_source&quot;: &quot;first_name&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /megacorp/employee/_mget</span><br><span class="line">&#123;</span><br><span class="line">  &quot;ids&quot;: [</span><br><span class="line">    &quot;2&quot;,</span><br><span class="line">    &quot;1&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /megacorp/employee/_mget</span><br><span class="line">&#123;</span><br><span class="line">  &quot;docs&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_id&quot;: 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_id&quot;: 1,</span><br><span class="line">      &quot;_source&quot;: &quot;first_name&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="全文搜索"><a href="#全文搜索" class="headerlink" title="全文搜索"></a>全文搜索</h2><p>当不指定key时, elasticsearch会从_all的key中做全文搜索</p>
<p>Elasticsearch把所有字符串字段值连接起来放在一个大字符串中，它被索引为一个特殊的字段 <code>_all</code></p>
<h1 id="创建-更新-删除"><a href="#创建-更新-删除" class="headerlink" title="创建/更新/删除"></a>创建/更新/删除</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT /website/blog/123</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;My first blog entry&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;Just trying this out...&quot;,</span><br><span class="line">  &quot;date&quot;: &quot;2014/01/01&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>文档在Elasticsearch中是不可变的, 如果已经存在,那么会生成一份新的, 同时递增<code>_version</code>, 留意下面的<code>_version</code> 和 <code>result</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_index"</span> : <span class="string">"megacorp"</span>,</span><br><span class="line">  <span class="attr">"_type"</span> : <span class="string">"employee"</span>,</span><br><span class="line">  <span class="attr">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"_version"</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"result"</span> : <span class="string">"updated"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们的数据没有自然ID，我们可以让Elasticsearch自动为我们生成(注意<code>POST</code>)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /website/blog/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;My second blog entry&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;Still trying this out...&quot;,</span><br><span class="line">  &quot;date&quot;: &quot;2014/01/01&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="只创建不更新"><a href="#只创建不更新" class="headerlink" title="只创建不更新"></a>只创建不更新</h2><p>简单的方式是使用 POST 方法让Elasticsearch自动生成唯一 _id</p>
<p>其他方法</p>
<ul>
<li>PUT /website/blog/123?op_type=create</li>
<li>PUT /website/blog/123/_create</li>
</ul>
<p>成功响应状态码是 201 Created 。 失败将返回 409 Conflict </p>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DELETE /website/blog/123</span><br></pre></td></tr></table></figure>
<h2 id="冲突"><a href="#冲突" class="headerlink" title="冲突"></a>冲突</h2><blockquote>
<p>elasticsearch 使用<code>_version</code>做乐观锁控制</p>
</blockquote>
<p>index 、 get 、 delete 请求时，我们指出每个文档都有一个 _version 号码，这个号码在文档被改变时加一。Elasticsearch使用这个 _version 保证所有修改都被正确排序。当一个旧版本出现在新版本之后，它会被简单的忽略。</p>
<p>我们只希望文档的 _version 是 1 时更新才生效。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT /website/blog/1?version=1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;My first blog entry&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;Starting to get the hang of this...&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="使用外部版本控制系统"><a href="#使用外部版本控制系统" class="headerlink" title="使用外部版本控制系统"></a>使用外部版本控制系统</h3><p>可以在Elasticsearch的查询字符串后面添加<code>version_type=external</code> 来使用这些版本号。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT /website/blog/2?version=5&amp;version_type=external</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;My first external blog entry&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;Starting to get the hang of this...&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>外部版本号与之前说的内部版本号在处理的时候有些不同。它不再检查 _version 是否与请求中指定的<code>一致</code>，而是检查是否<code>小于</code>指定的版本。如果请求成功，外部版本号就会被存储到 _version 中。</p>
</blockquote>
<h3 id="重试"><a href="#重试" class="headerlink" title="重试"></a>重试</h3><p>乐观锁失败的情况下, 通常可以重试<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /website/pageviews/1/_update?retry_on_conflict=5</span><br><span class="line">&#123;</span><br><span class="line">  &quot;script&quot; : &quot;ctx._source.views+=1&quot;,</span><br><span class="line">  &quot;upsert&quot;: &#123;</span><br><span class="line">    &quot;views&quot;: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="局部更新"><a href="#局部更新" class="headerlink" title="局部更新"></a>局部更新</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /website/blog/1/_update</span><br><span class="line">&#123;</span><br><span class="line">  &quot;doc&quot; : &#123;</span><br><span class="line">    &quot;tags&quot; : [ &quot;testing&quot; ],</span><br><span class="line">    &quot;views&quot;: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/elastic/elasticsearch-groovy" target="_blank" rel="noopener"><code>使用Groovy脚本?</code></a></p>
<h2 id="批量更新"><a href="#批量更新" class="headerlink" title="批量更新"></a>批量更新</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123; &quot;delete&quot;: &#123; &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot;, &quot;_id&quot;: &quot;123&quot; &#125;&#125;</span><br><span class="line">&#123; &quot;create&quot;: &#123; &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot;, &quot;_id&quot;: &quot;123&quot; &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot;: &quot;My first blog post&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot; &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot;: &quot;My second blog post&quot; &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /website/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_type&quot;: &quot;log&quot; &#125;&#125;</span><br><span class="line">&#123; &quot;event&quot;: &quot;User logged in&quot; &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>每个子请求都被独立的执行，所以一个子请求的错误并不影响其它请求。如果任何一个请求失败，顶层的 error 标记将被设置为 true ，然后错误的细节将在相应的请求中被报告</p>
</blockquote>
<table>
<thead>
<tr>
<th>行为</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>create</td>
<td>当文档不存在时创建之</td>
</tr>
<tr>
<td>index</td>
<td>创建新文档或替换已有文档</td>
</tr>
<tr>
<td>update</td>
<td>局部更新文档</td>
</tr>
<tr>
<td>delete</td>
<td>删除一个文档</td>
</tr>
</tbody>
</table>
<h3 id="为什么不用一个大json"><a href="#为什么不用一个大json" class="headerlink" title="为什么不用一个大json"></a>为什么不用一个大json</h3><p>便于服务器流式操作, Elasticsearch从网络缓冲区中一行一行的直接读取数据, 并分发到不同的node去处理, 而无需等待所有的内容并序列化,造成额外的内存开销,以及时间上的延误</p>
<h1 id="映射-mapping-分析-analysis"><a href="#映射-mapping-分析-analysis" class="headerlink" title="映射(mapping)/分析(analysis)"></a>映射(mapping)/分析(analysis)</h1><ul>
<li>映射(mapping)机制用于进行字段类型确认，将每个字段匹配为一种确定的数据类型( string , number , booleans , date 等)。</li>
<li>分析(analysis)机制用于进行全文文本(Full Text)的分词，以建立供搜索用的反向索引。</li>
</ul>
<h2 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h2><p>类型类似于rdm的表(table), 每个表有自己的定义(schema), 只不过Elasticsearch会对字段类型进行猜测，动态生成了字段和类型的映射关系, 如果没有明确定义。</p>
<blockquote>
<p>最新的elasticsearch干掉了这个概念</p>
</blockquote>
<p>比如2020-03-09 elasticsearch可能推导为日期格式, 那么本字段就不会匹配<code>2020</code>/<code>03</code>/<code>09</code>的任一个</p>
<p>当做全局搜索时, 从_all中匹配, 而后者会将所有字段转成字符串, 所以能匹配上</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /_search?q=2020 # 12 个结果</span><br><span class="line">GET /_search?q=2020-03-09 # 还是 12 个结果 !(只需要匹配2020就算, 只不过匹配度(score)略后)</span><br><span class="line">GET /_search?q=date:2020-03-09 # 1 一个结果</span><br><span class="line">GET /_search?q=date:2020 # 0 个结果 !</span><br></pre></td></tr></table></figure>
<p>获取type的schema</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /megacorp/_mapping/employee</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"megacorp"</span> : &#123;</span><br><span class="line">    <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">      <span class="attr">"employee"</span> : &#123;</span><br><span class="line">        <span class="attr">"properties"</span> : &#123;</span><br><span class="line">          <span class="attr">"about"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"fields"</span> : &#123;</span><br><span class="line">              <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">                <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">                <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"age"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"long"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"first_name"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"fields"</span> : &#123;</span><br><span class="line">              <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">                <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">                <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"interests"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"fields"</span> : &#123;</span><br><span class="line">              <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">                <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">                <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"fielddata"</span> : <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>类型</th>
<th>表示的数据类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>String</td>
<td>string</td>
</tr>
<tr>
<td>Whole number</td>
<td>byte , short , integer , long</td>
</tr>
<tr>
<td>Floating point</td>
<td>float , double</td>
</tr>
<tr>
<td>Boolean</td>
<td>boolean</td>
</tr>
<tr>
<td>Date</td>
<td>date</td>
</tr>
</tbody>
</table>
<h3 id="自定义类型"><a href="#自定义类型" class="headerlink" title="自定义类型"></a>自定义类型</h3><p>自定义类型可以使你完成以下几点：</p>
<ul>
<li>区分全文（full text）字符串字段和准确字符串字段(就是分词与不分词，全文的一般要分词，准确的就不需要分词)</li>
<li>使用特定语言的分析器(例如中文、英文、阿拉伯语，不同文字的断字、断词方式的差异)</li>
<li>优化部分匹配字段</li>
<li>指定自定义日期格式</li>
<li>…</li>
</ul>
<h4 id="type"><a href="#type" class="headerlink" title="type"></a>type</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;number_of_clicks&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">    &quot;index&quot;: &quot;not_analyzed&quot;</span><br><span class="line">    &quot;analyzer&quot;: &quot;english&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="index"><a href="#index" class="headerlink" title="index"></a>index</h4><table>
<thead>
<tr>
<th>值</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>analyzed</td>
<td>首先分析这个字符串，然后索引。换言之，以全文形式索引此字段。</td>
</tr>
<tr>
<td>not_analyzed</td>
<td>索引这个字段，使之可以被搜索，但是索引内容和指定值一样。不分析此字段。</td>
</tr>
<tr>
<td>no</td>
<td>不索引这个字段。这个字段不能为搜索到。</td>
</tr>
</tbody>
</table>
<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><p>每一种核心数据类型(strings, numbers, booleans及dates)以不同的方式进行索引, 在Elasticsearch中他们是被区别对待的。</p>
<h4 id="确切值-Exact-values-vs-全文文本-Full-text"><a href="#确切值-Exact-values-vs-全文文本-Full-text" class="headerlink" title="确切值(Exact values) vs. 全文文本(Full text)"></a>确切值(Exact values) vs. 全文文本(Full text)</h4><p>Elasticsearch中的数据可以大致分为两种类型：<code>确切值</code> 及 <code>全文文本</code></p>
<p>确切值是确定的，正如它的名字一样。比如一个date或用户ID，也可以包含更多的字符串比如username或email地址。确切值 “Foo” 和 “foo” 就并不相同。确切值 2014 和 2014-09-15 也不相同。确切值是很容易查询的，因为结果是二进制的 – 要么匹配，要么不匹配。</p>
<p>全文文本，从另一个角度来说是文本化的数据(常常以人类的语言书写)，比如英语单数/复数, 近义词 或者依赖上下文推导的(鼠标/老鼠), 而对于全文数据的查询来说, 存在一个匹配程度的问题</p>
<ul>
<li>一个针对 “UK” 的查询将返回涉及 “United Kingdom” 的文档</li>
<li>一个针对 “jump” 的查询同时能够匹配 “jumped” ， “jumps” ， “jumping” 甚至 “leap”</li>
<li>“johnny walker” 也能匹配 “Johnnie Walker” ， “johnnie depp” 及 “Johnny Depp”</li>
<li>“fox news hunting” 能返回有关hunting on Fox News的故事，而 “fox hunting news” 也能返回关于fox hunting的新闻故事。</li>
</ul>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>为了方便在全文文本字段中进行这些类型的查询，Elasticsearch首先对文本分析(analyzes)</p>
<ul>
<li>使用<code>字符过滤器(character filter)</code>去掉无意义词(啊/哦/额/the 等)</li>
<li><code>分词(analysis)</code></li>
<li>转换(复数-&gt;单数, 同义词 等等)</li>
</ul>
<p><code>分析器</code>就是处理这些步骤的功能逻辑</p>
<h3 id="内建分析器"><a href="#内建分析器" class="headerlink" title="内建分析器"></a>内建分析器</h3><ul>
<li>标准分析器, 标准分析器是Elasticsearch默认使用的分析器。对于文本分析，它对于任何语言都是最佳选择, 它根据Unicode Consortium的定义的单词边界(word boundaries)来切分文本，然后去掉大部分标点符号。最后，把所有词转为小写。</li>
<li>简单分析器, 简单分析器将非单个字母的文本切分，然后把每个词转为小写</li>
<li>空格分析器, 空格分析器依据空格切分文本。它不转换小写。</li>
<li>语言分析器<ul>
<li>english 分析器 自带一套英语停用词库——像 and 或 the 这些与语义无关的通用词。</li>
<li>中文1 <a href="https://github.com/medcl/elasticsearch-analysis-pinyin" target="_blank" rel="noopener">https://github.com/medcl/elasticsearch-analysis-pinyin</a></li>
<li>中文2 <a href="https://github.com/medcl/elasticsearch-analysis-ik" target="_blank" rel="noopener">https://github.com/medcl/elasticsearch-analysis-ik</a></li>
</ul>
</li>
</ul>
<h3 id="测试验证"><a href="#测试验证" class="headerlink" title="测试验证"></a>测试验证</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot; : &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot; : &quot;Text to analyze!&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"tokens"</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"text"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"&lt;ALPHANUM&gt;"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"to"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">5</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">7</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"&lt;ALPHANUM&gt;"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"analyze"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">8</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">15</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"&lt;ALPHANUM&gt;"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="指定分析器"><a href="#指定分析器" class="headerlink" title="指定分析器"></a>指定分析器</h2><p>当Elasticsearch在你的文档中探测到一个新的字符串字段，它将自动设置它为全文 string 字段并用 standard 分析器分析。</p>
<p>创建一个新索引，指定 tweet 字段的分析器为 english<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT /gb</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;tweet&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;tweet&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">          &quot;analyzer&quot;: &quot;english&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;date&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;date&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;name&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;string&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;user_id&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;long&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>定在 tweet 的映射中增加一个新的 <code>not_analyzed</code> 类型的文本字段，叫做 tag<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT /gb/_mapping/tweet</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;tag&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">      &quot;index&quot;: &quot;not_analyzed&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="复杂搜索-聚合"><a href="#复杂搜索-聚合" class="headerlink" title="复杂搜索/聚合"></a>复杂搜索/聚合</h1><ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/query-dsl-bool-query.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/6.8/query-dsl-bool-query.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/agg-metadata.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/6.5/agg-metadata.html</a></li>
</ul>
<h1 id="集群和节点"><a href="#集群和节点" class="headerlink" title="集群和节点"></a>集群和节点</h1><ul>
<li>节点(node)是一个运行着的Elasticsearch实例</li>
<li>集群(cluster)是一组具有相同 cluster.name 的节点集合，</li>
<li>分片(shards), 个最小级别“工作单元(worker unit)”,它只是保存了索引中所有数据的一部分, 索引(index)——一个存储关联数据的地方。实际上，索引只是一个用来指向一个或多个分片(shards)的“逻辑命名空间(logical namespace)”</li>
</ul>
<blockquote>
<p>做为用户，我们能够与集群中的任何节点通信。每一个节点都知道文档存在于哪个节点上，它们可以转发请求到相应的节点上。我们访问的节点负责收集各节点返回的数据，最后一起返回给客户端。</p>
</blockquote>
<h2 id="Node"><a href="#Node" class="headerlink" title="Node"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html" target="_blank" rel="noopener">Node</a></h2><ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#master-node" target="_blank" rel="noopener">Master-eligible node</a> A node that has node.master set to true (default), which makes it eligible to be elected as the master node, which controls the cluster.</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#data-node" target="_blank" rel="noopener">Data node</a> A node that has node.data set to true (default). Data nodes hold data and perform data related operations such as CRUD, search, and aggregations.</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html" target="_blank" rel="noopener">Ingest node</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#ml-node" target="_blank" rel="noopener">Machine learning node</a></li>
</ul>
<blockquote>
<p>在可用性要求高的集群中, 搞一个Master Only的集群?</p>
</blockquote>
<h2 id="分片"><a href="#分片" class="headerlink" title="分片"></a>分片</h2><p>分片就是一个<code>Lucene</code>实例，并且它本身就是一个完整的搜索引擎。我们的文档存储在分片中，并且在分片中被索引，但是我们的应用程序不会直接与它们通信，取而代之的是，直接与索引通信。</p>
<ul>
<li>主要分片(primary shard)</li>
<li>复制分片(replica shard)，复制分片只是主分片的一个副本，它可以防止硬件故障导致的数据丢失，同时可以提供读请求，比如搜索或者从别的shard取回文档。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT /blogs</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"settings"</span> : &#123;</span><br><span class="line">    <span class="string">"number_of_shards"</span> : 3, <span class="comment"># 主要分片数</span></span><br><span class="line">    <span class="string">"number_of_replicas"</span> : 1 <span class="comment"># 每个主要分片的副本数量</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>文档存储在分片中，然后分片分配到你集群中的节点上。当你的集群扩容或缩小，Elasticsearch将会自动在你的节点间迁移分片，以使集群保持平衡。当索引创建完成的时候，主分片的数量就固定了，但是复制分片的数量可以随时调整。</p>
</blockquote>
<h3 id="集群状态"><a href="#集群状态" class="headerlink" title="集群状态"></a>集群状态</h3><p>因为测试环境只有一个节点, 所以复制分片(replica shards)全部都不可用(unassigned 状态)</p>
<blockquote>
<p>在同一个节点上保存相同的数据副本是没有必要的，如果这个节点故障了，那所有的数据副本也会丢失</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_cluster/health</span><br><span class="line"><span class="comment"># resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"docker-cluster"</span>,</span><br><span class="line">  <span class="string">"status"</span> : <span class="string">"yellow"</span>, &lt;----</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"number_of_nodes"</span> : 1,</span><br><span class="line">  <span class="string">"number_of_data_nodes"</span> : 1,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>颜色</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>green</td>
<td>所有主要分片和复制分片都可用</td>
</tr>
<tr>
<td>yellow</td>
<td>所有主要分片可用，但不是所有复制分片都可用</td>
</tr>
<tr>
<td>red</td>
<td>不是所有的主要分片都可用</td>
</tr>
</tbody>
</table>
<p>接上,假如副本数量是1, 当新加一个node后, 那么elasticsearch会自动创建<code>复制分片</code>, 也可能转移部分<code>主分片</code>过去, 在当前节点分配复制分片, 此时所有的分片都已经可用, 那么健康状态就是<code>green</code></p>
<p>此时的集群就相当于实现了<code>横向扩展</code>, (<em>请求任何一个节点都能读写文档</em>), <code>高可用</code>(<em>一个节点挂了, 还有另外一份, 并且支持从复制分片重新恢复主分片</em>)</p>
<h3 id="横向扩展"><a href="#横向扩展" class="headerlink" title="横向扩展"></a>横向扩展</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT /blogs/_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"number_of_replicas"</span> : 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在保持两个node的情况下, 因为没有足够的node分配(复制)分片, 所以集群状态又将变黄, 新加node后, 又将变绿, 此时集群的负载能力将进一步增强</p>
<h3 id="故障恢复"><a href="#故障恢复" class="headerlink" title="故障恢复"></a>故障恢复</h3><p>假如所有的节点都支持master选举和数据存储</p>
<p>现在master节点挂了, 那么集群将变红, 因为不是所有的主分片都可用(<em>如果master有主分片</em>), 接下来</p>
<ul>
<li>选择产生新的master节点</li>
<li>把丢失的主分片对应的复制分片升级成主分片(选择策略? 如果有多个复制分片)</li>
</ul>
<h1 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h1><p><code>新的版本的实现有改动?</code></p>
<p>当你索引一个文档，它被存储在单独一个主分片上。Elasticsearch通过根据文档的key, 并使用一个路由算法(hash)来判断文档在哪个node, 简单地<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">shard = hash(routing) % number_of_primary_shards</span><br></pre></td></tr></table></figure></p>
<p>routing 值是一个任意字符串，它默认是 _id 但也可以自定义。这个 routing 字符串通过哈希函数生成一个数字，然后除以主切片的数量得到一个余数(remainder)，余数的范围永远是0到number_of_primary_shards - 1 ，这个数字就是特定文档所在的分片。这也解释了为什么主分片的数量只能在创建索引时定义且不能修改：如果主分片的数量在未来改变了，所有先前的路由值就失效了，文档也就永远找不到了。 </p>
<blockquote>
<p>或者迁移数据?</p>
</blockquote>
<p>所有的文档API（ get 、 index 、 delete 、 bulk 、 update 、 mget ）都接收一个 routing 参数，它用来自定义文档到分片的映射。自定义路由值可以确保所有相关文档——例如属于同一个人的文档——被保存在同一分片上。</p>
<h2 id="写流转"><a href="#写流转" class="headerlink" title="写流转"></a>写流转</h2><p>我们将接收外部请求节点称之为请求节点(requesting node)</p>
<blockquote>
<p>当我们发送请求，最好的做法是循环通过所有节点请求，这样可以平衡负载。</p>
</blockquote>
<ul>
<li>客户端给 <code>请求节点</code>(node1) 发送新建、索引或删除请求。</li>
<li>找到分片对应的node, 分发给对应node(node2)</li>
<li>node2完成<code>主要分片</code>的增删改</li>
<li>node2同步修改到所有的<code>复制分片</code></li>
<li>依次同步返回, 最后由<code>请求节点</code>返回给客户端</li>
</ul>
<h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h3><p>当更新完主要分片后, 数据<code>基本</code>就安全了, 等待所有的复制分片同步完成, 会拖慢客户端请求时间</p>
<p>update API还接受 routing 、 replication 、 consistency 和 timout 参数。</p>
<p><code>replication</code> 默认的值是 sync 。这将导致主分片得到复制分片的成功响应后才返回。</p>
<p>如果你设置 replication 为 async ，请求在主分片上被执行后就会返回给客户端。它依旧会转发请求给复制节点，但你将不知道复制节点成功与否。</p>
<p>默认主分片在尝试写入时需要规定数量(quorum)或过半的分片（可以是主节点或复制节点）可用。 <code>consistency</code> 允许的值为 one （只有一个主分片）， all （所有主分片和复制分片）或者默认的 quorum 或过半分片。</p>
<p>当分片副本不足时会怎样？Elasticsearch会等待更多的分片出现。默认等待一分钟。如果需要，你可以设置 <code>timeout</code> 参数让它终止的更早： 100 表示100毫秒， 30s 表示30秒。</p>
<h2 id="读流转"><a href="#读流转" class="headerlink" title="读流转"></a>读流转</h2><blockquote>
<p>文档能够从主分片或任意一个复制分片被检索。</p>
</blockquote>
<ul>
<li>客户端给 <code>请求节点</code>(node1) 发送查询请求。</li>
<li>node1根据文档id找到对应的node(包含主要分片/复制分片)</li>
<li>分发请求到对应节点, 对于读请求，为了平衡负载，请求节点会为每个请求选择不同的分片——它会循环所有分片副本。</li>
<li>等待返回</li>
</ul>
<blockquote>
<p>可能的情况是，一个被索引的文档已经存在于主分片上却还没来得及同步到复制分片上。这时复制分片会报告文档未找到，</p>
</blockquote>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2020/03/08/elasticsearch_basic/" data-id="ckdbgbyvs001743popooelovx" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2020/03/08/elasticsearch_basic/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elasticsearch/">elasticsearch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kibana/">kibana</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-jaeger_basic" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/29/jaeger_basic/">Jaeger初探</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2020/02/29/jaeger_basic/" class="article-date"><time datetime="2020-02-29T16:00:00.000Z" itemprop="datePublished">2020-03-01</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/运营运维/">运营运维</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>Jaeger 是Uber 开源的分布式追踪系统，兼容OpenTracing 标准, 官网<a href="https://github.com/jaegertracing/jaeger" target="_blank" rel="noopener">https://github.com/jaegertracing/jaeger</a></p>
<p>运行Sample</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -d --name jaeger \</span><br><span class="line">  -e COLLECTOR_ZIPKIN_HTTP_PORT=9411 \</span><br><span class="line">  -p 5775:5775/udp \</span><br><span class="line">  -p 6831:6831/udp \</span><br><span class="line">  -p 6832:6832/udp \</span><br><span class="line">  -p 5778:5778 \</span><br><span class="line">  -p 16686:16686 \</span><br><span class="line">  -p 14268:14268 \</span><br><span class="line">  -p 14250:14250 \</span><br><span class="line">  -p 9411:9411 \</span><br><span class="line">  jaegertracing/all-in-one:1.17</span><br></pre></td></tr></table></figure>
<p>可以打开<a href="http://localhost:16686" target="_blank" rel="noopener">http://localhost:16686</a>访问<code>Jeager UI</code></p>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a><a href="https://github.com/opentracing/specification/blob/master/specification.md" target="_blank" rel="noopener">概念</a></h1><blockquote>
<p>这些概念可以对照Jeager UI加深/帮助理解</p>
</blockquote>
<p>Traces in OpenTracing are defined implicitly by their Spans. In particular, a Trace can be thought of as a directed acyclic graph (DAG) of Spans, where the edges between Spans are called References.</p>
<p>Each Span encapsulates the following state:</p>
<ul>
<li>An operation name</li>
<li>A start timestamp</li>
<li>A finish timestamp</li>
<li>A set of zero or more key:value <code>Span Tags</code>. The keys must be strings. The values may be strings, bools, or numeric types.</li>
<li>A set of zero or more <code>Span Logs</code>, each of which is itself a key:value map paired with a timestamp. The keys must be strings, though the values may be of any type. Not all OpenTracing implementations must support every value type.</li>
<li>A <code>SpanContext</code> (see below)</li>
<li><code>References</code> to zero or more causally-related Spans (via the SpanContext of those related Spans)</li>
</ul>
<p>Each SpanContext encapsulates the following state:</p>
<ul>
<li>Any OpenTracing-implementation-dependent state (for example, trace and span ids) needed to refer to a distinct Span across a process boundary</li>
<li>Baggage Items, which are just key:value pairs that cross process boundaries</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Causal relationships between Spans in a single Trace</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        [Span A]  ←←←(the root span)</span><br><span class="line">            |</span><br><span class="line">     +------+------+</span><br><span class="line">     |             |</span><br><span class="line"> [Span B]      [Span C] ←←←(Span C is a `ChildOf` Span A)</span><br><span class="line">     |             |</span><br><span class="line"> [Span D]      +---+-------+</span><br><span class="line">               |           |</span><br><span class="line">           [Span E]    [Span F] &gt;&gt;&gt; [Span G] &gt;&gt;&gt; [Span H]</span><br><span class="line">                                       ↑</span><br><span class="line">                                       ↑</span><br><span class="line">                                       ↑</span><br><span class="line">                         (Span G `FollowsFrom` Span F)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Temporal relationships between Spans in a single Trace</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">––|–––––––|–––––––|–––––––|–––––––|–––––––|–––––––|–––––––|–&gt; time</span><br><span class="line"></span><br><span class="line"> [Span A···················································]</span><br><span class="line">   [Span B··············································]</span><br><span class="line">      [Span D··········································]</span><br><span class="line">    [Span C········································]</span><br><span class="line">         [Span E·······]        [Span F··] [Span G··] [Span H··]</span><br></pre></td></tr></table></figure>
<p>参考</p>
<ul>
<li><a href="https://opentracing.io/docs/getting-started/" target="_blank" rel="noopener">https://opentracing.io/docs/getting-started/</a></li>
<li><a href="https://github.com/opentracing-contrib/opentracing-specification-zh" target="_blank" rel="noopener">https://github.com/opentracing-contrib/opentracing-specification-zh</a></li>
<li><a href="https://wu-sheng.gitbooks.io/opentracing-io/content/" target="_blank" rel="noopener">https://wu-sheng.gitbooks.io/opentracing-io/content/</a></li>
<li><a href="https://github.com/yurishkuro/opentracing-tutorial/tree/master/go" target="_blank" rel="noopener">https://github.com/yurishkuro/opentracing-tutorial/tree/master/go</a></li>
<li><a href="https://pjw.io/articles/2018/05/08/opentracing-explanations/" target="_blank" rel="noopener">https://pjw.io/articles/2018/05/08/opentracing-explanations/</a></li>
</ul>
<h1 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h1><h2 id="grpc-sample"><a href="#grpc-sample" class="headerlink" title="grpc sample"></a>grpc sample</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ protoc -I ./ helloworld.proto --go_out=plugins=grpc:./</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://github.com/grpc/grpc-go/blob/master/examples/helloworld/helloworld/helloworld.proto" target="_blank" rel="noopener">https://github.com/grpc/grpc-go/blob/master/examples/helloworld/helloworld/helloworld.proto</a></li>
<li><a href="https://github.com/grpc/grpc-go/blob/master/examples/helloworld/greeter_client/main.go" target="_blank" rel="noopener">https://github.com/grpc/grpc-go/blob/master/examples/helloworld/greeter_client/main.go</a></li>
<li><a href="https://github.com/grpc/grpc-go/blob/master/examples/helloworld/greeter_server/main.go" target="_blank" rel="noopener">https://github.com/grpc/grpc-go/blob/master/examples/helloworld/greeter_server/main.go</a></li>
</ul>
<h2 id="Jeager-Export"><a href="#Jeager-Export" class="headerlink" title="Jeager Export"></a>Jeager Export</h2><p>参考 <a href="https://github.com/census-ecosystem/opencensus-go-exporter-jaeger/blob/master/example/main.go" target="_blank" rel="noopener">https://github.com/census-ecosystem/opencensus-go-exporter-jaeger/blob/master/example/main.go</a></p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"contrib.go.opencensus.io/exporter/jaeger"</span></span><br><span class="line">	<span class="string">"go.opencensus.io/trace"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initTracer</span><span class="params">(name, agent <span class="keyword">string</span>, sampling <span class="keyword">float64</span>)</span> <span class="params">(*jaeger.Exporter, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	trace.ApplyConfig(trace.Config&#123;DefaultSampler: trace.AlwaysSample()&#125;)</span><br><span class="line">	<span class="comment">// Register the Jaeger exporter to be able to retrieve</span></span><br><span class="line">	<span class="comment">// the collected spans.</span></span><br><span class="line">	exporter, err := jaeger.NewExporter(jaeger.Options&#123;</span><br><span class="line">		CollectorEndpoint: agent,</span><br><span class="line">		Process: jaeger.Process&#123;</span><br><span class="line">			ServiceName: name,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	trace.RegisterExporter(exporter)</span><br><span class="line">	<span class="keyword">return</span> exporter, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 初始化trace服务器</span></span><br><span class="line">	exporter, _ := initTracer(<span class="string">"gotest"</span>, <span class="string">"http://localhost:14268/api/traces"</span>, <span class="number">1</span>)</span><br><span class="line">	<span class="keyword">defer</span> exporter.Flush()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h2><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dosth</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 一个子span</span></span><br><span class="line">	_, span := trace.StartSpan(ctx, <span class="string">"baidu"</span>)</span><br><span class="line">	span.AddAttributes(trace.StringAttribute(<span class="string">"name"</span>, <span class="string">"doget2"</span>))</span><br><span class="line">	span.SetStatus(trace.Status&#123;Code: trace.StatusCodeOK, Message: <span class="string">"no error"</span>&#125;)</span><br><span class="line">	span.Annotate([]trace.Attribute&#123;</span><br><span class="line">		trace.Int64Attribute(<span class="string">"len"</span>, <span class="keyword">int64</span>(<span class="number">123456</span>)),</span><br><span class="line">		trace.StringAttribute(<span class="string">"name"</span>, <span class="string">"dosth"</span>),</span><br><span class="line">	&#125;, <span class="string">"Annotate"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> span.End()</span><br><span class="line">	http.Get(<span class="string">"http://www.baidu.com"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Http-trace"><a href="#Http-trace" class="headerlink" title="Http trace"></a>Http trace</h2><p>在python做各种三方库注入比较容易, golang需要手动处理, 参考<a href="https://awesomeopensource.com/project/census-instrumentation/opencensus-go#Getting%20Started" target="_blank" rel="noopener">https://awesomeopensource.com/project/census-instrumentation/opencensus-go#Getting%20Started</a></p>
<ul>
<li><a href="https://godoc.org/go.opencensus.io/plugin/ochttp" target="_blank" rel="noopener">net/http</a></li>
<li><a href="https://godoc.org/go.opencensus.io/plugin/ocgrpc" target="_blank" rel="noopener">gRPC</a></li>
<li><a href="https://godoc.org/github.com/opencensus-integrations/ocsql" target="_blank" rel="noopener">database/sql</a></li>
<li><a href="https://godoc.org/github.com/go-kit/kit/tracing/opencensus" target="_blank" rel="noopener">Go kit</a></li>
<li><a href="https://godoc.org/github.com/orijtech/groupcache" target="_blank" rel="noopener">Groupcache</a></li>
<li><a href="https://godoc.org/github.com/orijtech/caddy" target="_blank" rel="noopener">Caddy webserver</a></li>
<li><a href="https://godoc.org/github.com/orijtech/mongo-go-driver" target="_blank" rel="noopener">MongoDB</a></li>
<li><a href="https://godoc.org/github.com/orijtech/redigo" target="_blank" rel="noopener">Redis gomodule/redigo</a></li>
<li><a href="https://godoc.org/github.com/orijtech/redis" target="_blank" rel="noopener">Redis goredis/redis</a></li>
<li><a href="https://godoc.org/github.com/orijtech/gomemcache" target="_blank" rel="noopener">Memcache</a></li>
</ul>
<h3 id="client"><a href="#client" class="headerlink" title="client"></a>client</h3><p>较为完善的例子可参考<a href="https://cloud.google.com/solutions/using-distributed-tracing-to-observe-microservice-latency-with-opencensus-and-stackdriver-trace" target="_blank" rel="noopener">https://cloud.google.com/solutions/using-distributed-tracing-to-observe-microservice-latency-with-opencensus-and-stackdriver-trace</a></p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	fmt <span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"go.opencensus.io/plugin/ochttp/propagation/tracecontext"</span></span><br><span class="line">	<span class="string">"go.opencensus.io/trace"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doget</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 调用子http服务的span</span></span><br><span class="line">	name := <span class="string">"httpget"</span></span><br><span class="line">	_, span := trace.StartSpan(ctx, name)</span><br><span class="line">	url := <span class="string">"http://127.0.0.1:12345/sub"</span></span><br><span class="line">	span.AddAttributes(trace.StringAttribute(<span class="string">"url"</span>, url))</span><br><span class="line">	<span class="keyword">defer</span> span.End()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 调用Http服务</span></span><br><span class="line">	req, err := http.NewRequest(<span class="string">"GET"</span>, url, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"%v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	req = req.WithContext(ctx)</span><br><span class="line"></span><br><span class="line">	format := &amp;tracecontext.HTTPFormat&#123;&#125;</span><br><span class="line">	format.SpanContextToRequest(span.SpanContext(), req)</span><br><span class="line"></span><br><span class="line">	client := http.DefaultClient</span><br><span class="line">	resp, err := client.Do(req)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"%v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">	s, err := ioutil.ReadAll(resp.Body)</span><br><span class="line">	fmt.Printf(<span class="keyword">string</span>(s))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hander</span><span class="params">(ctx context.Context, name <span class="keyword">string</span>)</span> <span class="title">func</span><span class="params">(http.ResponseWriter, *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 子服务router</span></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		httpFormat := &amp;tracecontext.HTTPFormat&#123;&#125;</span><br><span class="line">		sc, ok := httpFormat.SpanContextFromRequest(r)</span><br><span class="line">		<span class="keyword">var</span> span *trace.Span = <span class="literal">nil</span></span><br><span class="line">		<span class="keyword">if</span> ok &#123;</span><br><span class="line">			<span class="comment">// 从header里面取spanContext, 做好衔接</span></span><br><span class="line">			ctx, span = trace.StartSpanWithRemoteParent(ctx, name, sc)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ctx, span = trace.StartSpan(ctx, name)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 增加Tag</span></span><br><span class="line">		span.AddAttributes(trace.StringAttribute(<span class="string">"name"</span>, fmt.Sprintf(<span class="string">"name: %s"</span>, name)))</span><br><span class="line">		span.SetStatus(trace.Status&#123;Code: trace.StatusCodeOK, Message: <span class="string">"no error"</span>&#125;)</span><br><span class="line">		<span class="keyword">defer</span> span.End()</span><br><span class="line"></span><br><span class="line">		fmt.Fprintf(w, <span class="string">"Hello there!\n"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="grpc-trace"><a href="#grpc-trace" class="headerlink" title="grpc trace"></a>grpc trace</h2><p>一个完整的例子可以参考<a href="https://opencensus-website-snapshot.firebaseapp.com/gogrpc/" target="_blank" rel="noopener">https://opencensus-website-snapshot.firebaseapp.com/gogrpc/</a></p>
<h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"go.opencensus.io/plugin/ocgrpc"</span></span><br><span class="line">	<span class="string">"go.opencensus.io/stats/view"</span></span><br><span class="line">	<span class="string">"go.opencensus.io/trace"</span></span><br><span class="line">	grpc <span class="string">"google.golang.org/grpc"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">grpc_client</span><span class="params">(ctx context.Context, address, name <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 一个子span</span></span><br><span class="line">	ctx, span := trace.StartSpan(ctx, name)</span><br><span class="line">	span.AddAttributes(trace.StringAttribute(<span class="string">"grpc"</span>, fmt.Sprintf(<span class="string">"name: %s"</span>, name)))</span><br><span class="line">	<span class="keyword">defer</span> span.End()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := view.Register(ocgrpc.DefaultClientViews...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"Failed to register ocgrpc client views: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	conn, err := grpc.Dial(</span><br><span class="line">		address,</span><br><span class="line">		grpc.WithStatsHandler(&amp;ocgrpc.ClientHandler&#123;</span><br><span class="line">			StartOptions: trace.StartOptions&#123;</span><br><span class="line">				Sampler: trace.AlwaysSample(),</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;),</span><br><span class="line">		grpc.WithInsecure(),</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"did not connect: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用实际的rpc接口</span></span><br><span class="line">    <span class="comment">// grpc 生成的代码接口</span></span><br><span class="line">	c := NewGreeterClient(conn)</span><br><span class="line">	r, err := c.SayHello(ctx, &amp;HelloRequest&#123;Name: name&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"could not greet: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Printf(<span class="string">"Greeting: %s"</span>, r.GetMessage())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Server-1"><a href="#Server-1" class="headerlink" title="Server"></a>Server</h3><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">grpc_server</span><span class="params">(addr <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	lis, err := net.Listen(<span class="string">"tcp"</span>, addr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"failed to listen: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := view.Register(ocgrpc.DefaultServerViews...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"Failed to register ocgrpc server views: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	s := grpc.NewServer(grpc.StatsHandler(&amp;ocgrpc.ServerHandler&#123;&#125;))</span><br><span class="line">    <span class="comment">// grpc生成的代码</span></span><br><span class="line">	RegisterGreeterServer(s, &amp;server&#123;&#125;)</span><br><span class="line">	<span class="keyword">if</span> err := s.Serve(lis); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"failed to serve: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Flask"><a href="#Flask" class="headerlink" title="Flask"></a>Flask</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Flask==0.12.4</span><br><span class="line">opencensus==0.7.6</span><br><span class="line">opencensus-ext-flask==0.7.3</span><br><span class="line">opencensus-ext-jaeger==0.7.1</span><br><span class="line">opencensus-ext-sqlalchemy==0.1.2</span><br><span class="line">opencensus-ext-grpc==0.7.1</span><br><span class="line">opencensus.ext.requests==0.7.2</span><br></pre></td></tr></table></figure>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def init_opencensus_tracing(app):</span><br><span class="line">    from opencensus.ext.jaeger.trace_exporter import JaegerExporter</span><br><span class="line">    from opencensus.ext.flask.flask_middleware import FlaskMiddleware</span><br><span class="line">    from opencensus.trace import config_integration, samplers</span><br><span class="line"></span><br><span class="line">    # 配置注入</span><br><span class="line">    INTEGRATIONS = [&apos;sqlalchemy&apos;, &apos;requests&apos;]</span><br><span class="line">    exporter = JaegerExporter(</span><br><span class="line">        service_name=&apos;flask_sample&apos;,</span><br><span class="line">        agent_host_name=&quot;127.0.0.1&quot;,</span><br><span class="line">        agent_port=6831,</span><br><span class="line">    )</span><br><span class="line">    sampler = samplers.ProbabilitySampler(rate=1)</span><br><span class="line">    FlaskMiddleware(</span><br><span class="line">        app,</span><br><span class="line">        exporter=exporter,</span><br><span class="line">        sampler=sampler,</span><br><span class="line">        blacklist_paths=[&apos;health&apos;],</span><br><span class="line">    )</span><br><span class="line">    config_integration.trace_integrations(INTEGRATIONS)</span><br></pre></td></tr></table></figure>
<p>当使用<code>sqlalchemy</code>/<code>requests</code>做数据库操作/Http(s)操作时, 会自动生成新的<code>span</code></p>
<h2 id="Python-Grpc客户端"><a href="#Python-Grpc客户端" class="headerlink" title="Python Grpc客户端"></a>Python Grpc客户端</h2><p>grpc不支持<code>配置集成(config integration)</code></p>
<p>参考<a href="https://github.com/census-instrumentation/opencensus-python/issues/677" target="_blank" rel="noopener">https://github.com/census-instrumentation/opencensus-python/issues/677</a></p>
<blockquote>
<p>This seems to be a doc issue, the grpc integration is done by explicitly using the interceptors (refer to the examples) instead of through config_integration.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ python -m grpc_tools.protoc --python_out ./ \</span><br><span class="line">    --grpc_python_out ./ -I. ./helloworld.proto</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> opencensus.ext.grpc <span class="keyword">import</span> client_interceptor</span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">from</span> .helloworld_pb2 <span class="keyword">import</span> HelloRequest</span><br><span class="line"><span class="keyword">from</span> .helloworld_pb2_grpc <span class="keyword">import</span> GreeterStub</span><br><span class="line"></span><br><span class="line">options = [(<span class="string">"grpc.lb_policy_name"</span>, <span class="string">"round_robin"</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> qrcoder_client</span><br><span class="line">qchannel = grpc.insecure_channel(<span class="string">"127.0.0.1:12346"</span>, options)</span><br><span class="line"><span class="comment"># 注入trace</span></span><br><span class="line">trace_interceptor = client_interceptor.OpenCensusClientInterceptor(</span><br><span class="line">    host_port=<span class="string">"127.0.0.1:12346"</span></span><br><span class="line">)</span><br><span class="line">qchannel = grpc.intercept_channel(qchannel, trace_interceptor)</span><br><span class="line">qrcoder_client = GreeterStub(qchannel)</span><br><span class="line">qrcoder_client.SayHello(HelloRequest(name=<span class="string">"world"</span>))</span><br></pre></td></tr></table></figure>
<h1 id="其他Export"><a href="#其他Export" class="headerlink" title="其他Export"></a>其他Export</h1><p>上面一直都使用的<a href="https://www.jaegertracing.io/" target="_blank" rel="noopener">Jaeger</a>, 其他包括参见<a href="https://opencensus.io/exporters/supported-exporters/" target="_blank" rel="noopener">https://opencensus.io/exporters/supported-exporters/</a></p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2020/02/29/jaeger_basic/" data-id="ckdbgbywo003043pok3owgwlo" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2020/02/29/jaeger_basic/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/grpc/">grpc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-tavern" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/20/tavern/">ResfulApi测试框架tavern</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2020/02/20/tavern/" class="article-date"><time datetime="2020-02-20T16:00:00.000Z" itemprop="datePublished">2020-02-21</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Python/">Python</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h1><p>测试用例由一个测试名称、一个或多个阶段(stage)组成，每个阶段都有一个名称、一个请求和一个响应。举个简单的例子</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">test_name:</span> <span class="string">Get</span> <span class="string">some</span> <span class="string">fake</span> <span class="string">data</span> <span class="string">from</span> <span class="string">the</span> <span class="string">JSON</span> <span class="string">placeholder</span> <span class="string">API</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Make</span> <span class="string">sure</span> <span class="string">we</span> <span class="string">have</span> <span class="string">the</span> <span class="string">right</span> <span class="string">ID</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">https://jsonplaceholder.typicode.com/posts/1</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">status_code:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">body:</span></span><br><span class="line">        <span class="attr">id:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">save:</span></span><br><span class="line">        <span class="attr">body:</span></span><br><span class="line">          <span class="attr">returned_id:</span> <span class="string">id</span></span><br></pre></td></tr></table></figure>
<p>此用例表示, 使用<code>request.method</code>方法向<code>request.url</code>请求, 期望成功返回(<code>status</code>等于200), 并且返回的内容(json)中, id等于1, 并且把id存在变量<code>returned_id</code>中</p>
<h1 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h1><p><code>请求段</code>描述发送到服务器的内容</p>
<ul>
<li>url</li>
<li>json post/put/..的json内容(如果是json格式)</li>
<li>param get方法的参数</li>
<li>data form参数</li>
<li>headers</li>
<li>method</li>
</ul>
<h1 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h1><p>响应段描述了我们期望得到的结果。</p>
<ul>
<li>status_code 期望的status, 缺省200, 也可能201或其他</li>
<li>body 期待返回的内容</li>
<li>headers 期待返回的header</li>
<li>redirect_query_params 期望重定向URL的参数</li>
</ul>
<h2 id="Save"><a href="#Save" class="headerlink" title="Save"></a>Save</h2><p>The save block can save values from the response for use in future requests. Things can be saved from the body, headers, or redirect query parameters. When used to save something from the json body, this can also access dictionaries and lists recursively. If the response is</p>
<p>save块可以从响应中保存结果，以便在将来的请求中使用。可以从body、header或重定向查询参数中保存结果。当用于从json中保存内容时，它还可以递归地访问字典和列表, 获取内部某个值。如果响应是</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"thing"</span>: &#123;</span><br><span class="line">        <span class="attr">"nested"</span>: [</span><br><span class="line">            <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以从响应块中的某个值保存到first val的值中<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">response:</span></span><br><span class="line">  <span class="attr">save:</span></span><br><span class="line">    <span class="attr">body:</span></span><br><span class="line">      <span class="attr">first_val:</span> <span class="string">thing.nested[0]</span></span><br></pre></td></tr></table></figure></p>
<p>也可以使用函数调用来保存数据,见后续</p>
<h1 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h1><h2 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># common.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">全局定义</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">|</span></span><br><span class="line">  <span class="string">测试</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">global_url:</span> <span class="string">http://www.baidu.com</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">test_name:</span> <span class="string">登录/个人信息</span></span><br><span class="line"></span><br><span class="line"><span class="attr">includes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="type">!include</span> <span class="string">common.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">登录</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/login"</span></span><br></pre></td></tr></table></figure>
<h2 id="保存变量"><a href="#保存变量" class="headerlink" title="保存变量"></a>保存变量</h2><p>留意<code>global_token</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">登录</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/login"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">      <span class="attr">json:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">"user"</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">"pwd"</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">status_code:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">save:</span></span><br><span class="line">        <span class="attr">body:</span></span><br><span class="line">          <span class="attr">global_token:</span> <span class="string">data.token</span> <span class="comment"># 把token存下来后续调用</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">个人信息</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/info"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">      <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">Authorization:</span> <span class="string">"&#123;global_token&#125;"</span> <span class="comment"># 获取之前存下来的token</span></span><br></pre></td></tr></table></figure>
<h2 id="Request变量"><a href="#Request变量" class="headerlink" title="Request变量"></a>Request变量</h2><p>可以从当前的request参数中获取值用作判断</p>
<p>留意<code>tavern.request_vars</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">登录</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/login"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">      <span class="attr">json:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">"user"</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">"pwd"</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">status_code:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">body:</span></span><br><span class="line">        <span class="attr">code:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">message:</span> <span class="string">OK</span></span><br><span class="line">        <span class="attr">data:</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">"&#123;tavern.request_vars.json.username&#125;"</span> <span class="comment"># 返回的username和参数一致</span></span><br></pre></td></tr></table></figure>
<h2 id="函数保存结果"><a href="#函数保存结果" class="headerlink" title="函数保存结果"></a>函数保存结果</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">登录</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/login"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">      <span class="attr">json:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">"user"</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">"pwd"</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">status_code:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">body:</span></span><br><span class="line">        <span class="attr">code:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">message:</span> <span class="string">OK</span></span><br><span class="line">      <span class="attr">save:</span></span><br><span class="line">        <span class="string">$ext:</span></span><br><span class="line">          <span class="attr">function:</span> <span class="string">base:save_test_data</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># export PYTHONPATH=$PYTHONPATH:.</span></span><br><span class="line"><span class="keyword">from</span> box <span class="keyword">import</span> Box</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_test_data</span><span class="params">(response)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> Box(&#123;<span class="string">"test_user_id"</span>: response.json()[<span class="string">"data"</span>][<span class="string">"userID"</span>]&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="函数校验"><a href="#函数校验" class="headerlink" title="函数校验"></a>函数校验</h2><p>支持自定义参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_message</span><span class="params">(response)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> response.json().get(<span class="string">"message"</span>) == <span class="string">"OK"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_code</span><span class="params">(response,**kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> response.json().get(<span class="string">"code"</span>) == kwargs[<span class="string">"expect"</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">登录</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/login"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">      <span class="attr">json:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">"user"</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">"pwd"</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">status_code:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">verify_response_with:</span> <span class="comment"># 单函数判断 export PYTHONPATH=$PYTHONPATH:.</span></span><br><span class="line">        <span class="attr">function:</span> <span class="string">base:check_message</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">个人信息</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/info"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">status_code:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">body:</span></span><br><span class="line">        <span class="attr">code:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">message:</span> <span class="string">OK</span></span><br><span class="line">      <span class="attr">verify_response_with:</span> <span class="comment"># 多函数判断</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">function:</span> <span class="string">base:check_message</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">function:</span> <span class="string">base:check_code</span></span><br><span class="line">          <span class="attr">extra_kwargs:</span></span><br><span class="line">            <span class="attr">expect:</span> <span class="number">0</span> <span class="comment"># 期望 code = 0 (自定义参数)</span></span><br></pre></td></tr></table></figure>
<h2 id="生成header"><a href="#生成header" class="headerlink" title="生成header"></a>生成header</h2><p><code>$ext</code> 表示下面的内容是函数生成器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> box <span class="keyword">import</span> Box</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_test_header</span><span class="params">()</span>:</span></span><br><span class="line">    auth_header = &#123;</span><br><span class="line">        <span class="string">"how"</span>: <span class="string">"are you"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Box(auth_header)</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">登录</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/login"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">      <span class="attr">headers:</span></span><br><span class="line">        <span class="string">$ext:</span></span><br><span class="line">          <span class="attr">function:</span> <span class="string">base:get_test_header</span></span><br></pre></td></tr></table></figure>
<h2 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h2><p>留意<code>tavern.env_vars</code><br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">登录</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/login"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">      <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">Authorization:</span> <span class="string">"Basic &#123;tavern.env_vars.SECRET_CI_COMMIT_AUTH&#125;"</span></span><br></pre></td></tr></table></figure></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="https://github.com/taverntesting/tavern" target="_blank" rel="noopener">https://github.com/taverntesting/tavern</a></li>
<li><a href="https://tavern.readthedocs.io/en/latest/basics.html" target="_blank" rel="noopener">https://tavern.readthedocs.io/en/latest/basics.html</a></li>
<li><a href="https://pypi.org/project/python-box/" target="_blank" rel="noopener">https://pypi.org/project/python-box/</a></li>
</ol>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2020/02/20/tavern/" data-id="ckdbgbyy8005w43po3vo1sb09" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2020/02/20/tavern/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tavern/">tavern</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-nginx_ldap" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/03/nginx_ldap/">nginx配置ldap登录授权</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2020/02/03/nginx_ldap/" class="article-date"><time datetime="2020-02-03T16:00:00.000Z" itemprop="datePublished">2020-02-04</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Openldap/">Openldap</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>本文代码来自<a href="https://github.com/nginxinc/nginx-ldap-auth" target="_blank" rel="noopener">https://github.com/nginxinc/nginx-ldap-auth</a></p>
<p>nginx内建了<code>auth_request</code>实现了权限控制拦截功能, 这适用于需要在无认证的服务前增加访问控制, 比如<code>Kibana</code>无默认的权限控制, 但是公司的日志显然不能裸奔</p>
<p>实现包含三部分</p>
<ul>
<li><code>nginx</code>(<code>auth_request</code>)</li>
<li>(较通用)的<code>认证服务</code></li>
<li>实际的<code>业务服务</code></li>
</ul>
<h1 id="业务服务"><a href="#业务服务" class="headerlink" title="业务服务"></a>业务服务</h1><p>文中的业务服务比较简单, 用Python写了个简单的web服务, 以及用于客户输入<code>帐号密码</code>的表单页面</p>
<h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><ul>
<li>nginx 绑定端口8081 供外部访问</li>
<li><code>auth_request</code>做全量拦截, 如果认证失败, 抛出<code>401</code></li>
<li>nginx 将401重定向到/login, 即<code>业务服务</code>中的表单</li>
<li>表单提交又回到<code>auth_request</code><ul>
<li>若存在cookie, 从cookie中解码出帐号密码, 然后ldap认证</li>
<li>对于首次登录, 则从form表单中获取帐号密码</li>
<li>认证成功,将帐号密码保存在cookie中, 避免重复输入帐号密码</li>
</ul>
</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8081</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">auth_request</span> /auth-proxy;</span><br><span class="line">        <span class="attribute">error_page</span> <span class="number">401</span> =<span class="number">200</span> /login;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /login &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend/login;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Target <span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> = /auth-proxy &#123;</span><br><span class="line">        internal;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:8888;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_pass_request_body</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Content-Length <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_cache_key</span> <span class="string">"<span class="variable">$http_authorization</span><span class="variable">$cookie_nginxauth</span>"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Ldap-URL      <span class="string">"ldap://127.0.0.1"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Ldap-BaseDN   <span class="string">"ou=lixin,dc=example,dc=org"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Ldap-BindDN   <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Ldap-Template <span class="string">"(cn=%(username)s)"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Ldap-BindPass <span class="string">"123456"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-CookieName <span class="string">"nginxauth"</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Cookie nginxauth=<span class="variable">$cookie_nginxauth</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>nginx</code> 将所有ldap的参数,以<code>header</code>的形式传给<code>认证服务</code>, 这样确保<code>认证服务</code>相对通用</p>
</blockquote>
<h1 id="认证服务"><a href="#认证服务" class="headerlink" title="认证服务"></a>认证服务</h1><ul>
<li>设定一个header头-参数的映射表, 以及服务启动传入的缺省值</li>
<li>每次请求,都动态获取这些参数, 连同(从form表单/cookie获取到的)帐号密码存入临时变量ctx</li>
<li>使用ctx的参数做ldap认证</li>
<li>参数错误/认证失败 返回401</li>
</ul>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>这显然只是一个sample, 不可能在生产环境中实施, 因为安全问题和性能问题比较明显</p>
<p>首先将帐号密码存在cookie中显然不合适, 可以考虑对帐号密码加密再写cookie</p>
<p>更好的方法是将帐号密码存在内部存储, 比如redis中,然后把redis的key写cookie</p>
<p>此时仍然存在问题, 因为每个请求都要走一遍ldap认证, 对响应时延影响较大</p>
<p>一种折中的方案是, 认证成功之后, 生成一个session并存入redis, session_id写cookie, 用户完整信息在session中, 但仍有不足, 比如ldap删除某个用户, 并不会立即反映到业务系统来</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2020/02/03/nginx_ldap/" data-id="ckdbgbyx4003v43pobuvxsxr8" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2020/02/03/nginx_ldap/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openldap/">openldap</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-sentry_ldap" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/03/sentry_ldap/">sentry配置ldap登录授权</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2020/02/03/sentry_ldap/" class="article-date"><time datetime="2020-02-03T16:00:00.000Z" itemprop="datePublished">2020-02-04</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Openldap/">Openldap</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>快速安装sentry见<a href="http://blog.kimq.cn/2017/03/10/sentry/">http://blog.kimq.cn/2017/03/10/sentry/</a></p>
<p>了解ldap见<a href="http://blog.kimq.cn/2020/02/02/openldap/">http://blog.kimq.cn/2020/02/02/openldap/</a></p>
<h1 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h1><p>进入docker<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it my-sentry /bin/bash</span><br><span class="line"><span class="comment"># 最好先修改源</span></span><br><span class="line">$ apt update</span><br><span class="line">$ apt-get install libsasl2-dev python-dev libldap2-dev libssl-dev </span><br><span class="line"><span class="comment"># for debug</span></span><br><span class="line">$ apt-get vim procps -y</span><br><span class="line"><span class="comment"># 安装sentry插件</span></span><br><span class="line">pip install https://github.com/Banno/getsentry-ldap-auth/archive/2.8.1.zip</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><code>getsentry-ldap-auth</code>的版本自行评估</p>
</blockquote>
<h2 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/lib/python2.7/site-packages/sentry_ldap_auth$ find . -<span class="built_in">type</span> f</span><br><span class="line">./backend.py</span><br><span class="line">./__init__.py</span><br></pre></td></tr></table></figure>
<p>若有问题, 可自行修改代码, 然后重启docker镜像, 日志查看<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker logs -f my-sentry</span><br></pre></td></tr></table></figure></p>
<h1 id="配置ldap群组和帐号"><a href="#配置ldap群组和帐号" class="headerlink" title="配置ldap群组和帐号"></a>配置ldap群组和帐号</h1><p>两个群组 </p>
<ul>
<li><code>owner_group</code> 对应sentry的owner角色</li>
<li><code>admin_group</code> 对应sentry的admin角色</li>
</ul>
<hr>
<p><code>admin</code>属于<code>owner_group</code>, <code>king1</code>属于<code>admin_group</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -x -H ldap://localhost  -w 123456 -D cn=admin,ou=tech,ou=lixin,dc=example,dc=org \</span><br><span class="line">   -b <span class="string">"ou=lixin,dc=example,dc=org"</span></span><br><span class="line"><span class="comment"># admin_group, lixin, example.org</span></span><br><span class="line">dn: cn=admin_group,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: groupOfNames</span><br><span class="line">objectClass: top</span><br><span class="line">cn: admin_group</span><br><span class="line">member: cn=king1,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># owner_group, lixin, example.org</span></span><br><span class="line">dn: cn=owner_group,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: groupOfNames</span><br><span class="line">objectClass: top</span><br><span class="line">cn: owner_group</span><br><span class="line">member: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># admin, tech, lixin, example.org</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">cn: admin</span><br><span class="line">userPassword:: e1NTSEF9ekRETXFGME4ydVNHUWZzRmxZSVlKVmVoS3BWbENxaGk=</span><br><span class="line"></span><br><span class="line"><span class="comment"># king1, tech, lixin, example.org</span></span><br><span class="line">dn: cn=king1,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">cn: king1</span><br><span class="line"></span><br><span class="line"><span class="comment"># king2, tech, lixin, example.org</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">cn: king2</span><br></pre></td></tr></table></figure>
<h1 id="配置Sentry服务器"><a href="#配置Sentry服务器" class="headerlink" title="配置Sentry服务器"></a>配置Sentry服务器</h1><p>将下列配置附到<code>/etc/sentry/sentry.conf.py</code> 后面</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment"># ldap auth</span></span><br><span class="line"><span class="keyword">import</span> ldap</span><br><span class="line"><span class="keyword">from</span> django_auth_ldap.config <span class="keyword">import</span> LDAPSearch, GroupOfNamesType</span><br><span class="line"></span><br><span class="line"><span class="comment"># ldap服务器地址</span></span><br><span class="line">AUTH_LDAP_SERVER_URI = <span class="string">'ldap://172.17.0.1'</span></span><br><span class="line"><span class="comment"># 具有查询权限的内部帐号</span></span><br><span class="line">AUTH_LDAP_BIND_DN = <span class="string">'cn=admin,ou=tech,ou=lixin,dc=example,dc=org'</span></span><br><span class="line"><span class="comment"># 密码</span></span><br><span class="line">AUTH_LDAP_BIND_PASSWORD = <span class="string">'123456'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户登录的过滤条件, 我们输入的帐号是ldap的`cn`</span></span><br><span class="line"><span class="comment"># @attention user占位符别修改</span></span><br><span class="line">AUTH_LDAP_USER_SEARCH = LDAPSearch(</span><br><span class="line">            <span class="string">'ou=tech,ou=lixin,dc=example,dc=org'</span>,</span><br><span class="line">            ldap.SCOPE_SUBTREE,</span><br><span class="line">            <span class="string">'(cn=%(user)s)'</span>,</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找组的过滤条件</span></span><br><span class="line">AUTH_LDAP_GROUP_SEARCH = LDAPSearch(</span><br><span class="line">            <span class="string">'ou=lixin,dc=example,dc=org'</span>,</span><br><span class="line">            ldap.SCOPE_SUBTREE,</span><br><span class="line">            <span class="string">'(objectClass=groupOfNames)'</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line"><span class="comment"># GroupOfNamesType</span></span><br><span class="line"><span class="comment"># NestedGroupOfNamesType</span></span><br><span class="line"><span class="comment"># GroupOfUniqueNamesType</span></span><br><span class="line"><span class="comment"># NestedGroupOfUniqueNamesType</span></span><br><span class="line"><span class="comment"># ActiveDirectoryGroupType</span></span><br><span class="line"><span class="comment"># NestedActiveDirectoryGroupType</span></span><br><span class="line"><span class="comment"># OrganizationalRoleGroupType</span></span><br><span class="line"><span class="comment"># NestedOrganizationalRoleGroupType</span></span><br><span class="line">AUTH_LDAP_GROUP_TYPE = GroupOfNamesType()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果设置了AUTH_LDAP_REQUIRE_GROUP那么只有这个组的成员才会登录成功</span></span><br><span class="line">AUTH_LDAP_REQUIRE_GROUP = <span class="literal">None</span></span><br><span class="line"><span class="comment"># AUTH_LDAP_DENY_GROUP正好相反，这个组的用户登录都会被拒绝。</span></span><br><span class="line">AUTH_LDAP_DENY_GROUP = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于映射sentry用户字段, 因为ldap测试的对象比较简单, 这里全部都用`cn`</span></span><br><span class="line">AUTH_LDAP_USER_ATTR_MAP = &#123;</span><br><span class="line">        <span class="string">'name'</span>: <span class="string">'cn'</span>,</span><br><span class="line">        <span class="string">'email'</span>: <span class="string">'cn'</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">AUTH_LDAP_FIND_GROUP_PERMS = <span class="literal">True</span></span><br><span class="line">AUTH_LDAP_CACHE_GROUPS = <span class="literal">True</span></span><br><span class="line">AUTH_LDAP_GROUP_CACHE_TIMEOUT = <span class="number">3600</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sentry缺省的Organization, 填写错误会导致登录后无权限, 一般不用修改</span></span><br><span class="line">AUTH_LDAP_DEFAULT_SENTRY_ORGANIZATION = <span class="string">u'Sentry'</span></span><br><span class="line"><span class="comment"># 自动加入到这个缺省的群组</span></span><br><span class="line">AUTH_LDAP_SENTRY_SUBSCRIBE_BY_DEFAULT = <span class="literal">True</span></span><br><span class="line"><span class="comment"># 配置哪些群组里的用户,具有哪个角色</span></span><br><span class="line"><span class="comment"># 例如owner_group 这个群组里的用户具有owner角色</span></span><br><span class="line">AUTH_LDAP_SENTRY_GROUP_ROLE_MAPPING = &#123;</span><br><span class="line">        <span class="string">'owner'</span>: [<span class="string">'owner_group'</span>],</span><br><span class="line">        <span class="string">'admin'</span>: [<span class="string">'admin_group'</span>],</span><br><span class="line">        <span class="string">'member'</span>: [], <span class="comment"># 缺省, 这里就不用配置了</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment"># 缺省角色(如果不属于我们配置的群组)</span></span><br><span class="line">AUTH_LDAP_SENTRY_ORGANIZATION_ROLE_TYPE = <span class="string">'member'</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">AUTH_LDAP_SENTRY_ORGANIZATION_GLOBAL_ACCESS = <span class="literal">True</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">AUTH_LDAP_SENTRY_USERNAME_FIELD = <span class="string">'cn'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用ldap登录</span></span><br><span class="line">AUTHENTICATION_BACKENDS = AUTHENTICATION_BACKENDS + (</span><br><span class="line">        <span class="string">'sentry_ldap_auth.backend.SentryLdapBackend'</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志相关</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logger = logging.getLogger(<span class="string">'django_auth_ldap'</span>)</span><br><span class="line">logger.addHandler(logging.StreamHandler())</span><br><span class="line">logger.setLevel(<span class="string">'DEBUG'</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>AUTH_LDAP_SENTRY_GROUP_ROLE_MAPPING</code> 字典的value值, 只需要写对应群组的<code>RDN</code>即可, 无需填写完整的<code>DN</code></p>
</blockquote>
<p>如果一个用户分别属于多个群组, 那么系统会取登记最高的角色, 角色优先级如下(由低到高)<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_effective_sentry_role</span><span class="params">(group_names)</span>:</span></span><br><span class="line">    role_priority_order = [</span><br><span class="line">        <span class="string">'member'</span>,</span><br><span class="line">        <span class="string">'admin'</span>,</span><br><span class="line">        <span class="string">'manager'</span>,</span><br><span class="line">        <span class="string">'owner'</span>,</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure></p>
<h1 id="登录验证"><a href="#登录验证" class="headerlink" title="登录验证"></a>登录验证</h1><p>打开<a href="http://127.0.0.1:8080" target="_blank" rel="noopener">http://127.0.0.1:8080</a> 然后分别用<code>admin</code>, <code>king1</code>, <code>king2</code> 登录, 在member页面<a href="http://127.0.0.1:8080/settings/sentry/members/" target="_blank" rel="noopener">http://127.0.0.1:8080/settings/sentry/members/</a> 可以看到三个用户属于不同的角色</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="https://github.com/Banno/getsentry-ldap-auth" target="_blank" rel="noopener">https://github.com/Banno/getsentry-ldap-auth</a></li>
<li><a href="https://django-auth-ldap.readthedocs.io/en/latest/reference.html" target="_blank" rel="noopener">https://django-auth-ldap.readthedocs.io/en/latest/reference.html</a></li>
<li><a href="https://darkcooking.gitbooks.io/django-auth-ldap/content/chapter4.html" target="_blank" rel="noopener">https://darkcooking.gitbooks.io/django-auth-ldap/content/chapter4.html</a></li>
</ol>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2020/02/03/sentry_ldap/" data-id="ckdbgbyxs005643pocbdwt7r2" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2020/02/03/sentry_ldap/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openldap/">openldap</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-openldap" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/02/openldap/">OpenLdap学习</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2020/02/02/openldap/" class="article-date"><time datetime="2020-02-02T16:00:00.000Z" itemprop="datePublished">2020-02-03</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Openldap/">Openldap</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -d --privileged -p 10004:80 --name php \</span><br><span class="line">  --env PHPLDAPADMIN_HTTPS=<span class="literal">false</span> --env PHPLDAPADMIN_LDAP_HOSTS=172.17.0.1  \</span><br><span class="line">  --detach osixia/phpldapadmin</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>172.17.0.1</code> 注意留意下本地docker网卡的ip地址</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -p 389:389 --name ldap \</span><br><span class="line">  --network bridge --hostname openldap-host \</span><br><span class="line">  --env LDAP_ORGANISATION=<span class="string">"example"</span> --env LDAP_DOMAIN=<span class="string">"example.org"</span> \</span><br><span class="line">  --env LDAP_ADMIN_PASSWORD=<span class="string">"pwd"</span> --detach osixia/openldap</span><br></pre></td></tr></table></figure>
<h2 id="SSL"><a href="#SSL" class="headerlink" title="SSL"></a>SSL</h2><p>如果要使用SSL访问, 将地址从<code>ldap://localhost</code>换成<code>ldaps://localhost</code></p>
<p>若使用自己的证书</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run --hostname ldap.example.org \</span><br><span class="line">  --volume /path/to/certificates:/container/service/slapd/assets/certs \</span><br><span class="line">  --env LDAP_TLS_CRT_FILENAME=my-ldap.crt \</span><br><span class="line">  --env LDAP_TLS_KEY_FILENAME=my-ldap.key \</span><br><span class="line">  --env LDAP_TLS_CA_CRT_FILENAME=the-ca.crt \</span><br><span class="line">  --detach osixia/openldap</span><br></pre></td></tr></table></figure>
<h2 id="原生客户端"><a href="#原生客户端" class="headerlink" title="原生客户端"></a><a href="http://www.ldapadmin.org/" target="_blank" rel="noopener">原生客户端</a></h2><p>支持<code>Windows</code> 和<code>Linux</code> , 个人感觉体验不如<strong><a href="http://phpldapadmin.sourceforge.net/wiki/index.php/Main_Page" target="_blank" rel="noopener">phpldapadmin</a></strong></p>
<ul>
<li><a href="http://www.ldapadmin.org/download/ldapadmin.html" target="_blank" rel="noopener">http://www.ldapadmin.org/download/ldapadmin.html</a></li>
<li><a href="http://ivb.sweb.cz/en/ldap.html" target="_blank" rel="noopener">http://ivb.sweb.cz/en/ldap.html</a></li>
<li><a href="https://github.com/ibv/LDAP-Admin/releases" target="_blank" rel="noopener">https://github.com/ibv/LDAP-Admin/releases</a></li>
</ul>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>打开本地浏览器, 访问<a href="http://localhost:10004" target="_blank" rel="noopener">http://localhost:10004</a> 即可打开<code>PHPLdapAdmin</code></p>
<blockquote>
<p>端口10004和docker保持一致</p>
</blockquote>
<p>需要登录, 登录帐号密码<code>cn=admin,dc=example,dc=org</code> / <code>pwd</code></p>
<blockquote>
<p>注意参数和docker中的保持一致, <code>缺省用户是固定的admin</code></p>
</blockquote>
<h3 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h3><p>也可以登录docker shell用命令行测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID  IMAGE               COMMAND               CREATED        STATUS        PORTS                          NAMES</span><br><span class="line">bfa797f2e0c7  osixia/phpldapadmin <span class="string">"/container/tool/run"</span> 15 minutes ago Up 15 minutes 443/tcp, 0.0.0.0:10004-&gt;80/tcp php</span><br><span class="line">e0c9ca20a8f1  osixia/openldap     <span class="string">"/container/tool/run"</span> 15 minutes ago Up 15 minutes 0.0.0.0:389-&gt;389/tcp, 636/tcp  ldap</span><br><span class="line">$ docker <span class="built_in">exec</span> -it --privileged ldap /bin/bash</span><br><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,dc=example,dc=org"</span> -w <span class="built_in">pwd</span> -b <span class="string">"dc=example,dc=org"</span></span><br><span class="line"><span class="comment"># extended LDIF</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># LDAPv3</span></span><br><span class="line"><span class="comment"># base &lt;dc=example,dc=org&gt; with scope subtree</span></span><br><span class="line"><span class="comment"># filter: (objectclass=*)</span></span><br><span class="line"><span class="comment"># requesting: ALL</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># example.org</span></span><br><span class="line">dn: dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: dcObject</span><br><span class="line">objectClass: organization</span><br><span class="line">o: example</span><br><span class="line">dc: example</span><br><span class="line"></span><br><span class="line"><span class="comment"># admin, example.org</span></span><br><span class="line">dn: cn=admin,dc=example,dc=org</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">cn: admin</span><br><span class="line">description: LDAP administrator</span><br><span class="line">userPassword:: e1NTSEF9cVNPeHRiYTFoQ0RtMlJPcWRwOW0vaTVULzRidzE2NHI=</span><br><span class="line"></span><br><span class="line"><span class="comment"># search result</span></span><br><span class="line">search: 2</span><br><span class="line">result: 0 Success</span><br><span class="line"></span><br><span class="line"><span class="comment"># numResponses: 3</span></span><br><span class="line"><span class="comment"># numEntries: 2</span></span><br></pre></td></tr></table></figure>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>ldap的数据是分层的数组结构, 并且可能有多个DB,每个DB一棵树</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dc:         com</span><br><span class="line">             |</span><br><span class="line">dc:        genfic         ## (公司)</span><br><span class="line">          /      \</span><br><span class="line">ou:   People   servers    ## (公司部门)</span><br><span class="line">      /    \     ..</span><br><span class="line">uid: ..   John            ## (部门里的数据)</span><br></pre></td></tr></table></figure>
<p>一些常用的概念</p>
<ul>
<li>Distinguished Name(<code>DN</code>) 惟一辨别名，类似于Linux文件系统中的绝对路径，每个对象都有一个惟一的名称，如”uid=king,ou=qiu,dc=example,dc=org”，在一个目录树中DN总是惟一的</li>
<li>RDN, DN最左边的一节, 一直凭借父节点的RDN就构成了DN</li>
<li>OID, 可以理解为内部ID, 但是仍然需要申请并公示, 避免重复</li>
<li>Domain Component(<code>DC</code>) 域名的部分，其格式是将完整的域名分成几部分，如域名为example.org变成dc=example,dc=org</li>
<li>User Id(<code>uid</code>) 用户ID，如”king”</li>
<li>Organization Unit(<code>OU</code>) 组织单位，类似于Linux文件系统中的子目录，它是一个容器对象，组织单位可以包含其他各种对象（包括其他组织单元），如”lixin”</li>
<li>Common Name(<code>CN</code>) 公共名称，如”king qiu”</li>
<li>Surname(<code>SN</code>) 姓，如”king”</li>
<li>Relative dn(<code>RDN</code>) 相对辨别名，类似于文件系统中的相对路径，它是与目录树结构无关的部分，如”uid=qiu”或”cn=king”</li>
<li>Country(<code>C</code>) 国家，如”CN”或”US”等。</li>
<li>Organization(<code>O</code>) 组织名，如”Example, Inc.”</li>
</ul>
<h2 id="通信协议-渠道"><a href="#通信协议-渠道" class="headerlink" title="通信协议/渠道"></a>通信协议/渠道</h2><blockquote>
<p>以下内容以具体实现<a href="https://linux.die.net/man/8/slapd" target="_blank" rel="noopener"><strong><code>slapd</code></strong></a> 为准</p>
</blockquote>
<p>slapd提供了几种方式客户端接入<a href="https://www.openldap.org/doc/admin24/runningslapd.html#Command-Line%20Options" target="_blank" rel="noopener">连接渠道</a></p>
<table>
<thead>
<tr>
<th>URL</th>
<th>Protocol</th>
<th>Transport</th>
</tr>
</thead>
<tbody>
<tr>
<td>ldap:///</td>
<td>LDAP    TCP</td>
<td>port 389</td>
</tr>
<tr>
<td>ldaps:///</td>
<td>LDAP over SSL</td>
<td>TCP port 636</td>
</tr>
<tr>
<td>ldapi:///</td>
<td>LDAP</td>
<td>IPC (Unix-domain socket)</td>
</tr>
</tbody>
</table>
<p>当使用官方的客户端工具时, 使用参数<code>-H</code></p>
<h2 id="后端-Backends"><a href="#后端-Backends" class="headerlink" title="后端(Backends)"></a><a href="https://www.openldap.org/doc/admin24/backends.html" target="_blank" rel="noopener">后端(Backends)</a></h2><p>slapd 支持多种数据的后端存储方式</p>
<ul>
<li>Berkeley DB</li>
<li>LDAP, not an actual database; instead it acts as a proxy to forward incoming requests to another LDAP server</li>
<li>LDIF, a basic storage backend that stores entries in text files in LDIF format</li>
<li>LMDB, the recommended primary backend for a normal slapd database. It uses OpenLDAP’s own Lightning Memory-Mapped Database (LMDB) library to store data and is intended to replace the Berkeley DB backends</li>
<li>etc…</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 从cn=config下过滤特定objectClass所有条目的dn</span></span><br><span class="line">$ ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b cn=config \</span><br><span class="line">    -s sub <span class="string">"(objectClass=olcDatabaseConfig)"</span> dn</span><br><span class="line">dn: olcDatabase=&#123;-1&#125;frontend,cn=config</span><br><span class="line">dn: olcDatabase=&#123;0&#125;config,cn=config</span><br><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br></pre></td></tr></table></figure>
<p>可以看到, 上述实例使用的<code>mdb</code></p>
<h2 id="数据库-Database"><a href="#数据库-Database" class="headerlink" title="数据库(Database)"></a><a href="https://www.openldap.org/doc/admin24/slapdconf2.html" target="_blank" rel="noopener">数据库(Database)</a></h2><blockquote>
<p>早期的slapd使用配置文件<code>slapd.conf</code>, 目前已不建议, 考虑<code>dynamic runtime configuration engine</code> , 后者有以下优势</p>
</blockquote>
<ul>
<li>is fully LDAP-enabled</li>
<li>is managed using the standard LDAP operations</li>
<li>stores its configuration data in an LDIF database, generally in the /usr/local/etc/openldap/slapd.d directory.</li>
<li>allows all of slapd’s configuration options to be changed on the fly, generally without requiring a server restart for the changes to take effect.</li>
</ul>
<p>从上面的环境可以看到, 缺省就存在三个<code>database</code></p>
<ul>
<li>frontend, 对所有DB有效的配置, 优先级较低(special database that is used to hold database-level options that should be applied to all the other databases)</li>
<li>config, 配置数据库</li>
<li>mdb(视bachend而不同), 实际的数据存储</li>
</ul>
<blockquote>
<p>实际上slapd可以有多个db, slapd会根据dn匹配各个库的<a href="https://www.openldap.org/doc/admin24/slapdconf2.html#olcSuffix:%20%3Cdn%20suffix%3E" target="_blank" rel="noopener"><code>olcSuffix</code></a>来做路由</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b <span class="string">"olcDatabase=&#123;1&#125;mdb,cn=config"</span> \</span><br><span class="line">   -s sub <span class="string">"(objectClass=olcDatabaseConfig)"</span>  olcSuffix</span><br><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">olcSuffix: dc=example,dc=org</span><br></pre></td></tr></table></figure>
<p>官方提供了</p>
<ul>
<li><a href="https://www.zytrax.com/books/ldap/ch14/#ldapsearch" target="_blank" rel="noopener"><strong><code>ldapsearch</code></strong></a> 查询(search LDAP entries)</li>
<li><a href="https://www.zytrax.com/books/ldap/ch14/#ldapadd" target="_blank" rel="noopener"><strong><code>ldapadd</code></strong></a> 新增(add LDIF entries to an LDAP directory)</li>
<li><a href="https://www.zytrax.com/books/ldap/ch14/#ldapdelete" target="_blank" rel="noopener"><strong><code>ldapdelete</code></strong></a> 删除(delete LDAP entries)</li>
<li><a href="https://www.zytrax.com/books/ldap/ch14/#ladpadd" target="_blank" rel="noopener"><strong><code>ldapmodify</code></strong></a> 修改(modify existing LDAP entries)</li>
</ul>
<h1 id="config库"><a href="#config库" class="headerlink" title="config库"></a>config库</h1><p>config库的根DN是<code>cn=config</code>, 这里包含了所有的配置</p>
<p>具体的每个字段的意义, 参考<a href="https://www.openldap.org/doc/admin24/slapdconf2.html" target="_blank" rel="noopener">https://www.openldap.org/doc/admin24/slapdconf2.html</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b <span class="string">"cn=config"</span> dn 2&gt;/dev/null | head -n 5</span><br><span class="line">dn: cn=config</span><br><span class="line">dn: cn=module&#123;0&#125;,cn=config</span><br><span class="line">dn: cn=module&#123;1&#125;,cn=config</span><br></pre></td></tr></table></figure>
<h2 id="数据库配置"><a href="#数据库配置" class="headerlink" title="数据库配置"></a><a href="https://www.openldap.org/doc/admin24/slapdconf2.html#Database-specific%20Directives" target="_blank" rel="noopener">数据库配置</a></h2><p>几个重要的配置</p>
<ul>
<li><a href="https://www.openldap.org/doc/admin24/slapdconf2.html#olcAccess:%20to%20%3Cwhat%3E%20[%20by%20%3Cwho%3E%20[%3Caccesslevel%3E]%20[%3Ccontrol%3E]%20]+" target="_blank" rel="noopener">olcAccess</a> 访问控制记录, 一般会有多条</li>
<li><a href="https://www.openldap.org/doc/admin24/slapdconf2.html#olcRootDN:%20%3CDN%3E" target="_blank" rel="noopener">olcRootDN</a>  超级管理员DN</li>
<li><a href="https://www.openldap.org/doc/admin24/slapdconf2.html#olcRootPW:%20%3Cpassword%3E" target="_blank" rel="noopener">olcRootPW</a>  超级管理员密码</li>
<li><a href="https://www.openldap.org/doc/admin24/slapdconf2.html#olcSuffix:%20%3Cdn%20suffix%3E" target="_blank" rel="noopener">olcSuffix</a> 路由的DN后缀</li>
</ul>
<blockquote>
<p>对于<code>olcSuffix</code>, 更具体的路由应该在前, 否则后面的db永远无法路由</p>
</blockquote>
<h1 id="添加-删除-配置"><a href="#添加-删除-配置" class="headerlink" title="添加/删除/配置"></a>添加/删除/配置</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; base.ldif  &lt;&lt; EOF</span><br><span class="line">&gt; dn: ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line">ou: lixin</span><br><span class="line"><span class="comment"># 空行</span></span><br><span class="line">dn: ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line">ou: tech</span><br><span class="line">description: 产品部</span><br><span class="line"><span class="comment"># 空行</span></span><br><span class="line">dn: cn=king1,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">cn: king1</span><br><span class="line">userPassword: 1</span><br><span class="line"><span class="comment"># 空行</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">cn: king2</span><br><span class="line">userPassword: 1</span><br><span class="line">&gt; EOF</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapadd -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org -f base.ldif </span><br><span class="line">adding new entry <span class="string">"ou=lixin,dc=example,dc=org"</span></span><br><span class="line">adding new entry <span class="string">"ou=tech,ou=lixin,dc=example,dc=org"</span></span><br><span class="line">adding new entry <span class="string">"cn=king1,ou=tech,ou=lixin,dc=example,dc=org"</span></span><br><span class="line">adding new entry <span class="string">"cn=king2,ou=tech,ou=lixin,dc=example,dc=org"</span></span><br></pre></td></tr></table></figure>
<p>查询<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"ou=lixin,dc=example,dc=org"</span> dn</span><br><span class="line"><span class="comment"># lixin, example.org</span></span><br><span class="line">dn: ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># tech, lixin, example.org</span></span><br><span class="line">dn: ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># king1, tech, lixin, example.org</span></span><br><span class="line">dn: cn=king1,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># king2, tech, lixin, example.org</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># search result</span></span><br><span class="line">search: 2</span><br><span class="line">result: 0 Success</span><br><span class="line"></span><br><span class="line"><span class="comment"># numResponses: 5</span></span><br><span class="line"><span class="comment"># numEntries: 4</span></span><br></pre></td></tr></table></figure></p>
<p>修改<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; c &lt;&lt; EOF</span><br><span class="line">&gt; dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">changetype: modify</span><br><span class="line">add: description</span><br><span class="line">description: 你懂的</span><br><span class="line">&gt; EOF</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapmodify -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org -f c</span><br><span class="line">modifying entry <span class="string">"cn=king2,ou=tech,ou=lixin,dc=example,dc=org"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ cat &gt; c &lt;&lt; EOF</span><br><span class="line">&gt; dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">changetype: modify</span><br><span class="line">delete: description</span><br><span class="line">description: 你懂的</span><br><span class="line">-</span><br><span class="line">add: street</span><br><span class="line">street: iii</span><br><span class="line">&gt; EOF<span class="string">""</span></span><br><span class="line">$ ldapmodify -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org -f c</span><br><span class="line">modifying entry <span class="string">"cn=king2,ou=tech,ou=lixin,dc=example,dc=org"</span></span><br></pre></td></tr></table></figure></p>
<p>多字段属性增删改<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"cn=king2,ou=tech,ou=lixin,dc=example,dc=org"</span> street | \</span><br><span class="line">    sed -e <span class="string">"/^$/d"</span> -e <span class="string">"/^#/d"</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">street: iii</span><br><span class="line">street: jjj</span><br><span class="line">street: kkk</span><br><span class="line"><span class="comment"># 删除stree=jjj的条目, 修改street=kkk的条目修改为lll</span></span><br><span class="line">$ cat &gt; c &lt;&lt; EOF</span><br><span class="line">&gt; dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">changetype: modify</span><br><span class="line">delete: street</span><br><span class="line">street: jjj</span><br><span class="line">-</span><br><span class="line">delete: street</span><br><span class="line">street: kkk</span><br><span class="line">-</span><br><span class="line">add: street</span><br><span class="line">street: lll</span><br><span class="line">&gt; EOF</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"cn=king2,ou=tech,ou=lixin,dc=example,dc=org"</span> street | \</span><br><span class="line">    sed -e <span class="string">"/^$/d"</span> -e <span class="string">"/^#/d"</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">street: iii</span><br><span class="line">street: lll</span><br></pre></td></tr></table></figure></p>
<p>删除<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; base.ldif &lt;&lt; EOF</span><br><span class="line">&gt; dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">cn: admin</span><br><span class="line">userPassword: 1</span><br><span class="line">&gt; EOF</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapadd -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org -f base.ldif</span><br><span class="line">adding new entry <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapdelete -H ldap://localhost -D cn=admin,dc=example,dc=org -w 1 \</span><br><span class="line">    cn=king1,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"ou=lixin,dc=example,dc=org"</span> dn</span><br><span class="line"><span class="comment"># lixin, example.org</span></span><br><span class="line">dn: ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># tech, lixin, example.org</span></span><br><span class="line">dn: ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># admin, tech, lixin, example.org</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># king2, tech, lixin, example.org</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># search result</span></span><br><span class="line">search: 2</span><br><span class="line">result: 0 Success</span><br></pre></td></tr></table></figure></p>
<h2 id="查询-filter"><a href="#查询-filter" class="headerlink" title="查询/filter"></a>查询/filter</h2><p>ldap的优势是<code>快速</code>/<code>灵活</code>的查询, ldapsearch有一个filter参数, 用于定制查询条件</p>
<p>几个概念</p>
<ul>
<li>basedn 从树的那个子(根)节点开始查找(<code>-b</code>)</li>
<li>filter 查询条件</li>
<li>attrs 查询结果返回哪些属性</li>
</ul>
<blockquote>
<p>filter手册,参考<a href="https://www.zytrax.com/books/ldap/apa/search.html" target="_blank" rel="noopener">https://www.zytrax.com/books/ldap/apa/search.html</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 从`ou=lixin,dc=example,dc=org`开始查找</span></span><br><span class="line"><span class="comment"># 匹配属性cn等于`king2`的条目</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    cn=king2 | sed -e <span class="string">"/^$/d"</span> -e <span class="string">"/^#/d"</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">cn: king2</span><br><span class="line">userPassword:: e1NTSEF9RzFqOGszdG82aHRWamRvQmYvRUlqbmo1dHNpb0NQcTE=</span><br><span class="line">street: iii</span><br><span class="line">description:: 5L2g5oeC55qE</span><br><span class="line"><span class="comment"># 接上, 只显示dn属性</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    cn=king2 dn | sed -e <span class="string">"/^$/d"</span> -e <span class="string">"/^#/d"</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br></pre></td></tr></table></figure>
<h3 id="判断"><a href="#判断" class="headerlink" title="判断"></a>判断</h3><ul>
<li>= 等于</li>
<li>~= 不等于</li>
<li>>= 大于等于</li>
<li>&lt;= 小于等于</li>
</ul>
<blockquote>
<p>比较逻辑支持通配符<code>*</code></p>
</blockquote>
<h3 id="与或非"><a href="#与或非" class="headerlink" title="与或非"></a>与或非</h3><ul>
<li>&amp; (AND)</li>
<li>! (NOT)</li>
<li>| (OR)</li>
</ul>
<blockquote>
<p>优先级用括号<code>(</code>界定</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(&amp;(exp1)(exp2)(exp3)) # exp1 AND exp2 AND exp3</span><br><span class="line">(|(exp1)(exp2)(exp3)) # exp1 OR exp2 OR exp3</span><br><span class="line">(!(exp1)) # NOT exp1</span><br><span class="line">(&amp;(!(exp1))(!(exp2))) # NOT exp1 AND NOT exp2</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cn等于admin 或者 street等于iii</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    <span class="string">"(|(cn=admin)(street=iii))"</span> dn | sed -e <span class="string">"/^$/d"</span> -e <span class="string">"/^#/d"</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br></pre></td></tr></table></figure>
<h3 id="DN查找"><a href="#DN查找" class="headerlink" title="DN查找"></a>DN查找</h3><p>用于查找DN中的每一段是否包含某个属性, <code>不支持通配符</code><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># dn中包含ou等于tech的条目</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"ou=lixin,dc=example,dc=org"</span> <span class="string">"ou:dn:=tech"</span> dn | sed -e <span class="string">"/^$/d"</span> -e <span class="string">"/^#/d"</span></span><br><span class="line">dn: ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"><span class="comment"># dn中包含cn等于admin的条目</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"ou=lixin,dc=example,dc=org"</span> <span class="string">"cn:dn:=admin"</span> dn | sed -e <span class="string">"/^$/d"</span> -e <span class="string">"/^#/d"</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br></pre></td></tr></table></figure></p>
<h2 id="匹配规则-matchingrules"><a href="#匹配规则-matchingrules" class="headerlink" title="匹配规则(matchingrules)"></a><a href="https://www.zytrax.com/books/ldap/ch3/#matchingrules" target="_blank" rel="noopener">匹配规则(matchingrules)</a></h2><p>每个属性的业务场景各有不同, 所以ldap引入了匹配规则, 用于约束属性的匹配规则, 例如姓名大小写不一致关系并不大</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">matchingRule ( 2.5.13.2 NAME &apos;caseIgnoreMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ldap内建了一大波规则</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Subschema</span><br><span class="line">dn: cn=Subschema</span><br><span class="line">matchingRules: ( 2.5.13.0 NAME &apos;objectIdentifierMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.38 )</span><br><span class="line">matchingRules: ( 2.5.13.1 NAME &apos;distinguishedNameMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.12 )</span><br><span class="line">matchingRules: ( 2.5.13.2 NAME &apos;caseIgnoreMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )</span><br><span class="line">matchingRules: ( 2.5.13.3 NAME &apos;caseIgnoreOrderingMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )</span><br><span class="line">matchingRules: ( 2.5.13.4 NAME &apos;caseIgnoreSubstringsMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.58 )</span><br><span class="line">matchingRules: ( 2.5.13.5 NAME &apos;caseExactMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )</span><br><span class="line">matchingRules: ( 2.5.13.6 NAME &apos;caseExactOrderingMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )</span><br><span class="line">matchingRules: ( 2.5.13.7 NAME &apos;caseExactSubstringsMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.58 )</span><br><span class="line">matchingRules: ( 2.5.13.8 NAME &apos;numericStringMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.36 )</span><br><span class="line">matchingRules: ( 2.5.13.10 NAME &apos;numericStringSubstringsMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.58 )</span><br><span class="line">matchingRules: ( 2.5.13.13 NAME &apos;booleanMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.7 )</span><br><span class="line">matchingRules: ( 2.5.13.14 NAME &apos;integerMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.27 )</span><br><span class="line">matchingRules: ( 2.5.13.15 NAME &apos;integerOrderingMatch&apos; </span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.27 )</span><br><span class="line">matchingRules: ( 2.5.13.16 NAME &apos;bitStringMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.6 )</span><br><span class="line">matchingRules: ( 2.5.13.17 NAME &apos;octetStringMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.40 )</span><br><span class="line">matchingRules: ( 2.5.13.18 NAME &apos;octetStringOrderingMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.40 )</span><br><span class="line">matchingRules: ( 2.5.13.20 NAME &apos;telephoneNumberMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.50 )</span><br><span class="line">matchingRules: ( 2.5.13.21 NAME &apos;telephoneNumberSubstringsMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.58 )</span><br><span class="line">matchingRules: ( 2.5.13.23 NAME &apos;uniqueMemberMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.34 )</span><br><span class="line">matchingRules: ( 2.5.13.27 NAME &apos;generalizedTimeMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.24 )</span><br><span class="line">matchingRules: ( 2.5.13.28 NAME &apos;generalizedTimeOrderingMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.24 )</span><br><span class="line">matchingRules: ( 2.5.13.29 NAME &apos;integerFirstComponentMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.27 )</span><br><span class="line">matchingRules: ( 2.5.13.30 NAME &apos;objectIdentifierFirstComponentMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.38 )</span><br><span class="line">matchingRules: ( 2.5.13.34 NAME &apos;certificateExactMatch&apos;</span><br><span class="line">  SYNTAX 1.2.826.0.1.3344810.7.1 )</span><br><span class="line">matchingRules: ( 1.3.6.1.4.1.1466.109.114.1 NAME &apos;caseExactIA5Match&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )</span><br><span class="line">matchingRules: ( 1.3.6.1.4.1.1466.109.114.2 NAME &apos;caseIgnoreIA5Match&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )</span><br><span class="line">matchingRules: ( 1.3.6.1.4.1.1466.109.114.3 NAME &apos;caseIgnoreIA5SubstringsMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )</span><br><span class="line">matchingRules: ( 1.3.6.1.4.1.4203.1.2.1 NAME &apos;caseExactIA5SubstringsMatch&apos; </span><br><span class="line"> SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )</span><br><span class="line">matchingRules: ( 1.2.840.113556.1.4.803 NAME &apos;integerBitAndMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.27 )</span><br><span class="line">matchingRules: ( 1.2.840.113556.1.4.804 NAME &apos;integerBitOrMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.27 )</span><br></pre></td></tr></table></figure>
<p>在比较时, 可以后面加一个<code>oid</code> 修改缺省的匹配规则<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># default sn EQUALITY comparison behaviour</span></span><br><span class="line"><span class="comment"># is caseIgnoreMatch (2.5.13.2)</span></span><br><span class="line">sn=smith</span><br><span class="line"></span><br><span class="line"><span class="comment"># override EQUALITY match with case sensitive match</span></span><br><span class="line">sn:caseExactMatch:=Smith</span><br><span class="line"><span class="comment"># functionally same as above using OID</span></span><br><span class="line">sn:2.5.13.5:=Smith</span><br><span class="line"></span><br><span class="line"><span class="comment"># if a wildcard appears in seach the SUBSTR </span></span><br><span class="line"><span class="comment"># MatchingRule applies</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default sn SUBSTR comparison behavior</span></span><br><span class="line"><span class="comment"># is caseIgnoreSubstringMatch</span></span><br><span class="line">sn=*s* <span class="comment"># finds Smith or smith</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># override SUBSTR match with case sensitive match</span></span><br><span class="line">sn:caseExactSubstringMatch:=*S* <span class="comment"># only finds Smith</span></span><br><span class="line"><span class="comment"># functionally same as above using OID</span></span><br><span class="line">sn:2.5.13.7:=*S*</span><br></pre></td></tr></table></figure></p>
<h1 id="权限"><a href="#权限" class="headerlink" title="权限"></a><a href="https://www.openldap.org/doc/admin24/access-control.html" target="_blank" rel="noopener"><code>权限</code></a></h1><p>到目前位置, 所有的操作,要不使用unix socket通道(<code>ldapi:///</code>), 不受权限控制, 要不就使用超级管理员<code>admin,dc=example,dc=org</code></p>
<p>slapd提供了完善的权限控制, 让其他用户也能做全部/部分操作</p>
<p>缺省情况下, 其他用户只有对自己的权限<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b <span class="string">"olcDatabase=&#123;1&#125;mdb,cn=config"</span> \</span><br><span class="line">    -s sub <span class="string">"(objectClass=olcDatabaseConfig)"</span>  olcAccess</span><br><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword,shadowLastChange by self write by dn=<span class="string">"cn=a</span></span><br><span class="line"><span class="string"> dmin,dc=example,dc=org"</span> write by anonymous auth by * none</span><br><span class="line">olcAccess: &#123;1&#125;to * by self <span class="built_in">read</span> by dn=<span class="string">"cn=admin,dc=example,dc=org"</span> write by * </span><br><span class="line"> none</span><br><span class="line"><span class="comment"># 查询lixin部门</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    -w 1 -b <span class="string">"ou=lixin,dc=example,dc=org"</span> dn</span><br><span class="line">search: 2</span><br><span class="line">result: 32 No such object</span><br><span class="line"><span class="comment"># 查询自己</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    -w 1 -b <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> dn</span><br><span class="line"><span class="comment"># admin, tech, lixin, example.org</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line">search: 2</span><br><span class="line">result: 0 Success</span><br></pre></td></tr></table></figure></p>
<p>现在给<code>cn=admin,ou=tech,ou=lixin,dc=example,dc=org</code> 加一个<code>read</code>权限<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; perm &lt;&lt; EOF</span><br><span class="line">&gt; dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;to dn.subtree=<span class="string">"ou=lixin,dc=example,dc=org"</span></span><br><span class="line">    by dn.exact=<span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> <span class="built_in">read</span></span><br><span class="line">    by anonymous auth</span><br><span class="line">    by * none</span><br><span class="line">&gt; EOF</span><br><span class="line">$ ldapmodify -H ldapi:// -Y EXTERNAL -f perm</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b <span class="string">"olcDatabase=&#123;1&#125;mdb,cn=config"</span> \</span><br><span class="line">   -s sub <span class="string">"(objectClass=olcDatabaseConfig)"</span>  olcAccess</span><br><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">olcAccess: &#123;0&#125;to dn.subtree=<span class="string">"ou=lixin,dc=example,dc=org"</span>   by dn.exact=<span class="string">"cn=adm</span></span><br><span class="line"><span class="string"> in,ou=tech,ou=lixin,dc=example,dc=org"</span> <span class="built_in">read</span>   by anonymous auth   by * none</span><br><span class="line">olcAccess: &#123;1&#125;to attrs=userPassword,shadowLastChange by self write by dn=<span class="string">"cn=a</span></span><br><span class="line"><span class="string"> dmin,dc=example,dc=org"</span> write by anonymous auth by * none</span><br><span class="line">olcAccess: &#123;2&#125;to * by self <span class="built_in">read</span> by dn=<span class="string">"cn=admin,dc=example,dc=org"</span> write by * </span><br><span class="line"> none</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    -w 1 -b <span class="string">"ou=lixin,dc=example,dc=org"</span> dn</span><br><span class="line"><span class="comment"># lixin, example.org</span></span><br><span class="line">dn: ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># tech, lixin, example.org</span></span><br><span class="line">dn: ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># hr, tech, lixin, example.org</span></span><br><span class="line">dn: cn=hr,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># admin, tech, lixin, example.org</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># king1, tech, lixin, example.org</span></span><br><span class="line">dn: cn=king1,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># king2, tech, lixin, example.org</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line">search: 2</span><br><span class="line">result: 0 Success</span><br><span class="line"><span class="comment"># 查分配的权限之外的dn就找不到了</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    -w 1 -b <span class="string">"dc=example,dc=org"</span> dn</span><br><span class="line">search: 2</span><br><span class="line">result: 32 No such object</span><br></pre></td></tr></table></figure>
<h2 id="权限Index"><a href="#权限Index" class="headerlink" title="权限Index"></a>权限Index</h2><p>由于权限规则定义的顺序非常关键, 所以slapd使用一个<code>{X}</code>来锁定顺序, 在上面的例子中,可以看到<code>{0}, {1}, {2}</code> </p>
<blockquote>
<p>我们的配置中手动写死{0}, 是为了确保新插入的规则优先级最高, 因为此调规则的DN范围是小于后两条</p>
</blockquote>
<p>{X}的另外一个作用是在增删改查时用作定位, 例如删除第一条</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">delete: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;</span><br></pre></td></tr></table></figure>
<h2 id="权限集合"><a href="#权限集合" class="headerlink" title="权限集合"></a>权限集合</h2><table>
<thead>
<tr>
<th>Level</th>
<th>Privileges</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>none</td>
<td>0</td>
<td>no access</td>
</tr>
<tr>
<td>disclose</td>
<td>d</td>
<td>needed for information disclosure on error</td>
</tr>
<tr>
<td>auth</td>
<td>dx</td>
<td>needed to authenticate (bind)</td>
</tr>
<tr>
<td>compare</td>
<td>cdx</td>
<td>needed to compare</td>
</tr>
<tr>
<td>search</td>
<td>scdx</td>
<td>needed to apply search filters</td>
</tr>
<tr>
<td>read</td>
<td>rscdx</td>
<td>needed to read search results</td>
</tr>
<tr>
<td>write</td>
<td>wrscdx</td>
<td>needed to modify/rename</td>
</tr>
<tr>
<td>manage</td>
<td>mwrscdx</td>
<td>needed to manage</td>
</tr>
</tbody>
</table>
<ul>
<li>高级别权限自动包含低级别权限</li>
<li>search和read的区别在于, search可以返回<code>查到了</code>, 但是没有<code>查到的具体结果</code></li>
<li>认证权限, 表示允许登录, 至于能不能成功, 则使用帐号密码认证</li>
</ul>
<h2 id="权限规则"><a href="#权限规则" class="headerlink" title="权限规则"></a>权限规则</h2><p>规则语法<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">access to what： </span><br><span class="line">by who access control</span><br></pre></td></tr></table></figure></p>
<ul>
<li>control 就是之前的权限等级, 读/写/授权etc</li>
<li>指令中包含1个to语句，可多个by语句</li>
<li><code>what</code> 限定规则应用条目(entries)的集合, 全部用<code>*</code></li>
<li><code>who</code> 授权给哪些实体(entities)</li>
</ul>
<h3 id="what"><a href="#what" class="headerlink" title="what"></a>what</h3><blockquote>
<p>匹配所有使用<code>*</code><br>多种匹配规则可同时使用</p>
</blockquote>
<p><a href="https://www.openldap.org/doc/admin24/access-control.html#What%20to%20control%20access%20to" target="_blank" rel="noopener">scope</a>(基于某个根DN匹配)</p>
<ul>
<li>base matches only the entry with provided DN</li>
<li>one matches the entries whose parent is the provided DN</li>
<li>subtree matches all entries in the subtree whose root is the provided DN</li>
<li>children matches all entries under the DN (but not the entry named by the DN)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0: o=suffix</span><br><span class="line">1: cn=Manager,o=suffix</span><br><span class="line">2: ou=people,o=suffix</span><br><span class="line">3: uid=kdz,ou=people,o=suffix</span><br><span class="line">4: cn=addresses,uid=kdz,ou=people,o=suffix</span><br><span class="line">5: uid=hyc,ou=people,o=suffix</span><br></pre></td></tr></table></figure>
<ul>
<li>dn.base=”ou=people,o=suffix” match 2; </li>
<li>dn.one=”ou=people,o=suffix” match 3, and 5; </li>
<li>dn.subtree=”ou=people,o=suffix” match 2, 3, 4, and 5; and </li>
<li>dn.children=”ou=people,o=suffix” match 3, 4, and 5.</li>
</ul>
<p>regex(基于DN正则表达式匹配)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">access to dn.regex=&quot;(.+,)?ou=People,(dc=[^,]+,dc=[^,]+)$&quot;</span><br></pre></td></tr></table></figure>
<p>filter(基于过滤器)<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter=(objectClass=person)</span><br><span class="line"><span class="comment"># 配合使用</span></span><br><span class="line">dn.one=<span class="string">"ou=people,o=suffix"</span> filter=(objectClass=person)</span><br></pre></td></tr></table></figure></p>
<p>attrs(只授权部分属性)</p>
<p>缺省授权所有的attr, 这里可以过滤限定属性的范围</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">to attrs=member,entry</span><br></pre></td></tr></table></figure>
<blockquote>
<p>有两个<code>伪属性</code>(pseudo), <code>entry</code> <code>children</code> , 需要特别注意</p>
</blockquote>
<ul>
<li>To read (and hence return) a target entry, the subject must have read access to the target’s <code>entry</code> attribute</li>
<li>To perform a search, the subject must have search access to the search base’s <code>entry</code> attribute.</li>
<li>To add or delete an entry, the subject must have write access to the entry’s <code>entry</code> attribute AND must have write access to the entry’s parent’s <code>children</code> attribute</li>
<li>To rename an entry, the subject must have write access to entry’s <code>entry</code> attribute AND have write access to both the old parent’s and new parent’s <code>children</code> attributes.</li>
</ul>
<h3 id="who"><a href="#who" class="headerlink" title="who"></a>who</h3><p>用于限定权限赋予给哪些实体, 一些特殊的实体如下</p>
<table>
<thead>
<tr>
<th>Specifier</th>
<th>Entities</th>
</tr>
</thead>
<tbody>
<tr>
<td>*</td>
<td>All, including anonymous and authenticated users</td>
</tr>
<tr>
<td>anonymous</td>
<td>Anonymous (non-authenticated) users</td>
</tr>
<tr>
<td>users</td>
<td>Authenticated users</td>
</tr>
<tr>
<td>self</td>
<td>User associated with target entry</td>
</tr>
</tbody>
</table>
<p>剩下两种通用的匹配方式 <code>scope</code> <code>regex</code> 和what用于保持一致</p>
<p>一个特殊的<code>dnattr</code>用于限定DN在某种条目的attr列表中</p>
<blockquote>
<p>这个attr只能存放其他条目的DN</p>
</blockquote>
<h3 id="权限评估-Evaluation"><a href="#权限评估-Evaluation" class="headerlink" title="权限评估(Evaluation)"></a>权限评估(Evaluation)</h3><p>当判断who是否具有what的access权限时</p>
<ul>
<li>根据权限结合的优先级, 从先到后</li>
<li>找到第一条匹配what的记录(<code>dn/attr</code>)</li>
<li>根据这条记录的by, 判断当前用户是否符合who<ul>
<li>如果没有who, 那么会append一个缺省的<code>access to * by * none</code> (<strong>而不是继续评估下个access to</strong>)</li>
<li>如果有, 则检查by的access 是否满足客户端申请的权限</li>
</ul>
</li>
<li>如果没有what, 那么<code>then a default read is used</code></li>
</ul>
<blockquote>
<p>所以, 一个<code>access to</code>必须把所有<code>by</code>的考虑清楚, 否则未考虑的<code>who</code>将无权限</p>
</blockquote>
<h2 id="密码"><a href="#密码" class="headerlink" title="密码"></a>密码</h2><p>新建用户时, 可以用明文写到<code>userPassword</code> 一次性创建, 通过ldapsearch可以看到密码被加密了, 不过只是简单的<code>base64编码</code>, 安全性较低</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># admin, tech, lixin, example.org</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">userPassword:: MQ==</span><br></pre></td></tr></table></figure>
<p>我们可以用<code>slappasswd</code> 生成带盐的强加密密码</p>
<p>再测试之前, 先调整权限, 让所有用户可以自己修改密码<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 内建规则, 所有用户可以自己修改密码</span></span><br><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword,shadowLastChange </span><br><span class="line">  by self write </span><br><span class="line">  by dn=<span class="string">"cn=admin,dc=example,dc=org"</span> write </span><br><span class="line">  by anonymous auth </span><br><span class="line">  by * none</span><br><span class="line"><span class="comment"># 本地新增,移动到第二位</span></span><br><span class="line">olcAccess: &#123;1&#125;to dn.subtree=<span class="string">"ou=lixin,dc=example,dc=org"</span>   by dn.exact=<span class="string">"cn=adm</span></span><br><span class="line"><span class="string"> in,ou=tech,ou=lixin,dc=example,dc=org"</span> <span class="built_in">read</span>   by anonymous auth   by * none</span><br><span class="line"><span class="comment"># 超级管理员</span></span><br><span class="line">olcAccess: &#123;2&#125;to * by self <span class="built_in">read</span> by dn=<span class="string">"cn=admin,dc=example,dc=org"</span> write by * </span><br><span class="line"> none</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ slappasswd -h &#123;SSHA&#125;</span><br><span class="line">New password: </span><br><span class="line">Re-enter new password: </span><br><span class="line">&#123;SSHA&#125;zDDMqF0N2uSGQfsFlYIYJVehKpVlCqhi</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ cat &gt; <span class="built_in">pwd</span> &lt;&lt; EOF</span><br><span class="line">&gt; dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">changetype: modify</span><br><span class="line">replace: userPassword</span><br><span class="line">userPassword: &#123;SSHA&#125;zDDMqF0N2uSGQfsFlYIYJVehKpVlCqhi</span><br><span class="line">&gt; EOF</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ ldapmodify -x -H ldap://localhost  -w <span class="built_in">pwd</span> \</span><br><span class="line">   -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> -f <span class="built_in">pwd</span></span><br><span class="line">modifying entry <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">  -w <span class="built_in">pwd</span> -b <span class="string">"ou=lixin,dc=example,dc=org"</span> userPassword</span><br><span class="line">ldap_bind: Invalid credentials (49)</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">   -w 123456 -b <span class="string">"ou=lixin,dc=example,dc=org"</span> userPassword</span><br><span class="line"><span class="comment"># admin, tech, lixin, example.org</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">userPassword:: e1NTSEF9ekRETXFGME4ydVNHUWZzRmxZSVlKVmVoS3BWbENxaGk=</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ <span class="built_in">echo</span> e1NTSEF9ekRETXFGME4ydVNHUWZzRmxZSVlKVmVoS3BWbENxaGk= | base64 -d</span><br><span class="line">&#123;SSHA&#125;zDDMqF0N2uSGQfsFlYIYJVehKpVlCqhi</span><br></pre></td></tr></table></figure>
<h1 id="第三方授权"><a href="#第三方授权" class="headerlink" title="第三方授权"></a>第三方授权</h1><p>ldap一个很重要的用途就是做第三方的认证授权</p>
<p>通常的做法</p>
<ul>
<li>客户输入一个<code>cn</code>或者<code>uid</code>, 按照限定的规则拼装成DN</li>
<li>根据限定的搜索条件, 查询DN是否存在</li>
<li>使用DN和客户输入的密码做bind</li>
</ul>
<h2 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h2><p>slapd内建了一个<code>groupOfNames</code>的objectClass, 其包含一个member的属性, 该属性只能包含其他DN<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ou, lixin, example.org</span><br><span class="line">dn: cn=ou,ou=lixin,dc=example,dc=org</span><br><span class="line">member: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">member: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: groupOfNames</span><br><span class="line">objectClass: top</span><br><span class="line">cn: ou</span><br></pre></td></tr></table></figure></p>
<p>那么可以考虑将角色和groupOfNames关联起来, 如果某个用户在这个groupOfNames的member中,那么就具有这个角色</p>
<p>这里有个问题, 在user端, 没有渠道查到它属于哪些groups, 为此需要安装额外的插件</p>
<h2 id="memberOf"><a href="#memberOf" class="headerlink" title="memberOf"></a>memberOf</h2><p>具体安装参考<a href="https://mayanbin.com/post/enable-memberof-in-openldap.html" target="_blank" rel="noopener">https://mayanbin.com/post/enable-memberof-in-openldap.html</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; a &lt;&lt; EOF</span><br><span class="line">&gt; dn: cn=module,cn=config</span><br><span class="line">cn: module</span><br><span class="line">objectClass: olcModuleList</span><br><span class="line">olcModulePath: /usr/lib64/openldap</span><br><span class="line"><span class="comment"># 空行</span></span><br><span class="line">dn: cn=module&#123;0&#125;,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcModuleLoad</span><br><span class="line">olcModuleLoad: memberof.la</span><br><span class="line">&gt; EOF</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapadd -Q -Y EXTERNAL -H ldapi:/// -f a</span><br><span class="line">adding new entry <span class="string">"cn=module,cn=config"</span></span><br><span class="line"></span><br><span class="line">modifying entry <span class="string">"cn=module&#123;0&#125;,cn=config"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ cat &gt; a &lt;&lt; EOF</span><br><span class="line">&gt; dn: olcOverlay=memberof,olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">objectClass: olcConfig</span><br><span class="line">objectClass: olcMemberOf</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: top</span><br><span class="line">olcOverlay: memberof</span><br><span class="line">olcMemberOfDangling: ignore</span><br><span class="line">olcMemberOfRefInt: TRUE</span><br><span class="line">olcMemberOfGroupOC: groupOfNames</span><br><span class="line">olcMemberOfMemberAD: member     </span><br><span class="line">olcMemberOfMemberOfAD: memberOf</span><br><span class="line">&gt; EOF</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ ldapadd -Q -Y EXTERNAL -H ldapi:/// -f a</span><br><span class="line">adding new entry <span class="string">"olcOverlay=memberof,olcDatabase=&#123;1&#125;mdb,cn=config"</span></span><br></pre></td></tr></table></figure>
<p>之后就有了<code>memberOf</code> 字段</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    -w 123456 -b <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> memberof</span><br><span class="line"><span class="comment"># admin, tech, lixin, example.org</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">memberOf: cn=ou,ou=lixin,dc=example,dc=org</span><br><span class="line">memberOf: cn=ou2,ou=lixin,dc=example,dc=or</span><br></pre></td></tr></table></figure>
<p>注意:</p>
<ul>
<li>memberof不属于强制，ldapsearch查询需要单独指定</li>
<li>老数据不会修复</li>
</ul>
<p>当我们做组判断时, </p>
<ul>
<li>根据三方系统配置的组名, 按照规则拼接完整DN, </li>
<li>根据搜索规则, 判断DN是否存在</li>
<li>检查用户的memberOf里面是否存在这个组DN</li>
</ul>
<h1 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install flask_simpleldap</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果不使用flask, 也可以直接安装<strong><a href="https://www.python-ldap.org/en/python-ldap-3.2.0/" target="_blank" rel="noopener">python-ldap</a></strong></p>
</blockquote>
<p>Debian/Ubuntu:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install libsasl2-dev python-dev libldap2-dev libssl-dev</span><br></pre></td></tr></table></figure>
<p>RedHat/CentOS:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo yum install python-devel openldap-devel</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> ldap</span><br><span class="line">ldapconn = ldap.initialize(<span class="string">'ldap://localhost:389'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p</span><span class="params">(con, u, p)</span>:</span></span><br><span class="line">    res = con.simple_bind_s(u, p)</span><br><span class="line">    print(res)</span><br><span class="line"></span><br><span class="line">    res = con.whoami_s()</span><br><span class="line">    print(res)</span><br><span class="line"></span><br><span class="line">    res = con.search_s(</span><br><span class="line">        <span class="string">"cn=admin,dc=example,dc=org"</span>,</span><br><span class="line">        ldap.SCOPE_SUBTREE,</span><br><span class="line">        <span class="comment"># ldap.SCOPE_BASE,</span></span><br><span class="line">        <span class="comment"># ldap.SCOPE_ONELEVEL,</span></span><br><span class="line">        <span class="string">'(&amp;(cn=admin))'</span>,</span><br><span class="line">    )</span><br><span class="line">    print(res)</span><br><span class="line"></span><br><span class="line">p(ldapconn, <span class="string">'cn=admin,dc=example,dc=org'</span>, <span class="string">"pwd"</span>)</span><br></pre></td></tr></table></figure>
<p>新建用户, 注意<code>uid</code>, <code>objectClass</code><br><figure class="highlight ldif"><table><tr><td class="code"><pre><span class="line"><span class="comment"># king, example.org</span></span><br><span class="line"><span class="attribute">dn</span>: uid=king,dc=example,dc=org</span><br><span class="line"><span class="attribute">uid</span>: king</span><br><span class="line"><span class="attribute">userPassword:</span>: e01ENX14TXBDT0tDNUk0SU56RkNhYjNXRW13PT0=</span><br><span class="line"><span class="attribute">objectClass</span>: account</span><br><span class="line"><span class="attribute">objectClass</span>: simpleSecurityObject</span><br><span class="line"><span class="attribute">objectClass</span>: top</span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, g</span><br><span class="line"><span class="keyword">from</span> flask_simpleldap <span class="keyword">import</span> LDAP</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">'dev key'</span></span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">'LDAP_OPENLDAP'</span>] = <span class="literal">True</span></span><br><span class="line">app.config[<span class="string">'LDAP_BASE_DN'</span>] = <span class="string">'dc=example,dc=org'</span></span><br><span class="line">app.config[<span class="string">'LDAP_USERNAME'</span>] = <span class="string">'cn=admin,dc=example,dc=org'</span></span><br><span class="line">app.config[<span class="string">'LDAP_PASSWORD'</span>] = <span class="string">'pwd'</span></span><br><span class="line">app.config[<span class="string">'LDAP_USER_OBJECT_FILTER'</span>] = <span class="string">'(&amp;(objectclass=simpleSecurityObject)(userid=%s))'</span></span><br><span class="line"></span><br><span class="line">ldap = LDAP(app)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="meta">@ldap.basic_auth_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Welcome, &#123;0&#125;!'</span>.format(g.ldap_username)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5010</span>)</span><br></pre></td></tr></table></figure>
<p>浏览器访问<a href="http://127.0.0.1:5010/" target="_blank" rel="noopener">http://127.0.0.1:5010/</a>, 即弹出对话框,输入<code>king</code>, <code>1</code> 登录成功</p>
<ul>
<li><a href="https://github.com/admiralobvious/flask-simpleldap/tree/master/examples" target="_blank" rel="noopener">https://github.com/admiralobvious/flask-simpleldap/tree/master/examples</a> 有若干sample可供参考</li>
<li><a href="https://medium.com/@chris.pruitt15/ldap-user-authentication-in-flask-api-e662b0aeb7de" target="_blank" rel="noopener">https://medium.com/@chris.pruitt15/ldap-user-authentication-in-flask-api-e662b0aeb7de</a></li>
</ul>
<p>具体原理比较简单</p>
<ul>
<li>先使用环境变量配置的帐号密码(管理员)登录<ul>
<li><code>LDAP_USERNAME</code>/<code>LDAP_PASSWORD</code></li>
<li>登录见<code>simple_bind_s</code></li>
</ul>
</li>
<li>根据输入的uid以及<code>LDAP_USER_OBJECT_FILTER</code>来搜索用户</li>
<li>找到用户, 获取完整的<code>DN</code></li>
<li>使用DN和输入的密码再登录, 确认密码有效性</li>
</ul>
<h1 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h1><p><a href="https://github.com/go-ldap/ldap/blob/master/examples_test.go" target="_blank" rel="noopener">https://github.com/go-ldap/ldap/blob/master/examples_test.go</a> 有较详细的sample</p>
<blockquote>
<p>如果<code>gopkg.in/asn1-ber.v1</code> 安装不上, 修改<code>go.mod</code>, 添加以下内容, 重新<code>tidy</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">replace (</span><br><span class="line">	gopkg.in/asn1-ber.v1 =&gt; github.com/go-asn1-ber/asn1-ber v0.0.0-20181015200546-f715ec2f112d</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/go-ldap/ldap"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	conn, err := ldap.Dial(<span class="string">"tcp"</span>, <span class="string">"127.0.0.1:389"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := conn.Bind(<span class="string">"cn=admin,dc=example,dc=org"</span>, <span class="string">"pwd"</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	searchRequest := ldap.NewSearchRequest(</span><br><span class="line">		<span class="string">"dc=example,dc=org"</span>, <span class="comment">// The base dn to search</span></span><br><span class="line">		ldap.ScopeWholeSubtree, ldap.NeverDerefAliases, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">false</span>,</span><br><span class="line">		<span class="string">"(&amp;(uid=king))"</span>, <span class="comment">// The filter to apply</span></span><br><span class="line">		[]<span class="keyword">string</span>&#123;&#125;,      <span class="comment">// A list attributes to retrieve</span></span><br><span class="line">		<span class="literal">nil</span>,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	sr, err := conn.Search(searchRequest)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, entry := <span class="keyword">range</span> sr.Entries &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"%s: %v\n"</span>, entry.DN, entry.GetAttributeValue(<span class="string">"cn"</span>))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, entry := <span class="keyword">range</span> sr.Referrals &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"%s: %v\n"</span>, entry)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="数据安全"><a href="#数据安全" class="headerlink" title="数据安全"></a>数据安全</h1><p>缺省的<a href="https://lmdb.readthedocs.io/en/release/" target="_blank" rel="noopener">mdb数据存储</a>在<code>/var/lib/ldap/</code>, 一个数据文件,一个锁文件, 我们可以外挂docker数据目录(<code>/var/lib/ldap</code>)和配置目录(<code>/etc/ldap/slapd.d</code>)实现数据的持久化保存</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lmdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意传入的路径是一个目录, 下面包含两文件</span></span><br><span class="line">env_db = lmdb.Environment(<span class="string">'/home/user/mdb'</span>)</span><br><span class="line"></span><br><span class="line">txn = env_db.begin()</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> txn.cursor():  <span class="comment"># 遍历</span></span><br><span class="line">    print(key)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"-"</span>)</span><br><span class="line">data = txn.get(<span class="string">"cn"</span>.encode(<span class="string">"utf8"</span>))</span><br><span class="line">env_db.close()</span><br></pre></td></tr></table></figure>
<h2 id="安装问题"><a href="#安装问题" class="headerlink" title="安装问题"></a>安装问题</h2><ul>
<li><a href="https://stackoverflow.com/questions/4768446/i-cant-install-python-ldap" target="_blank" rel="noopener">I can’t install python-ldap</a></li>
<li><a href="https://askubuntu.com/questions/815897/how-to-meet-depends-requirements-for-libldap-2-4-2" target="_blank" rel="noopener">How to meet depends requirements for libldap-2.4-2</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo aptitude install libsasl2-dev</span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  libsasl2-dev&#123;b&#125; </span><br><span class="line">0 packages upgraded, 1 newly installed, 0 to remove and 5 not upgraded.</span><br><span class="line">Need to get 254 kB of archives. After unpacking 831 kB will be used.</span><br><span class="line">The following packages have unmet dependencies:</span><br><span class="line"> libsasl2-dev : Depends: libsasl2-2 (= 2.1.26.dfsg1-14build1) but 2.1.26.dfsg1-14ubuntu0.1 is installed.</span><br><span class="line">The following actions will resolve these dependencies:</span><br><span class="line"></span><br><span class="line">     Keep the following packages at their current version:</span><br><span class="line">1)     libsasl2-dev [Not Installed]                       </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Accept this solution? [Y/n/q/?] n</span><br><span class="line">The following actions will resolve these dependencies:</span><br><span class="line"></span><br><span class="line">     Downgrade the following packages:                                                   </span><br><span class="line">1)     libsasl2-2 [2.1.26.dfsg1-14ubuntu0.1 (now) -&gt; 2.1.26.dfsg1-14build1 (xenial)]     </span><br><span class="line">2)     libsasl2-2:i386 [2.1.26.dfsg1-14ubuntu0.1 (now) -&gt; 2.1.26.dfsg1-14build1 (xenial)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Accept this solution? [Y/n/q/?] y</span><br><span class="line">The following packages will be DOWNGRADED:</span><br><span class="line">  libsasl2-2 libsasl2-2:i386 </span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  libsasl2-dev </span><br><span class="line">0 packages upgraded, 1 newly installed, 2 downgraded, 0 to remove and 5 not upgraded.</span><br><span class="line">Need to get 354 kB of archives. After unpacking 831 kB will be used.</span><br><span class="line">Do you want to <span class="built_in">continue</span>? [Y/n/?] y</span><br><span class="line">Get: 1 http://mirrors.aliyun.com/ubuntu xenial/main i386 libsasl2-2 i386 2.1.26.dfsg1-14build1 [51.8 kB]</span><br><span class="line">Get: 2 http://mirrors.aliyun.com/ubuntu xenial/main amd64 libsasl2-2 amd64 2.1.26.dfsg1-14build1 [48.7 kB]</span><br><span class="line">Get: 3 http://mirrors.aliyun.com/ubuntu xenial/main amd64 libsasl2-dev amd64 2.1.26.dfsg1-14build1 [254 kB]</span><br><span class="line">Fetched 354 kB <span class="keyword">in</span> 0s (384 kB/s)       </span><br><span class="line">dpkg: warning: downgrading libsasl2-2:i386 from 2.1.26.dfsg1-14ubuntu0.1 to 2.1.26.dfsg1-14build1</span><br><span class="line">(Reading database ... 530388 files and directories currently installed.)</span><br><span class="line">Preparing to unpack .../libsasl2-2_2.1.26.dfsg1-14build1_i386.deb ...</span><br><span class="line">De-configuring libsasl2-2:amd64 (2.1.26.dfsg1-14ubuntu0.1) ...</span><br><span class="line">Unpacking libsasl2-2:i386 (2.1.26.dfsg1-14build1) over (2.1.26.dfsg1-14ubuntu0.1) ...</span><br><span class="line">dpkg: warning: downgrading libsasl2-2:amd64 from 2.1.26.dfsg1-14ubuntu0.1 to 2.1.26.dfsg1-14build1</span><br><span class="line">Preparing to unpack .../libsasl2-2_2.1.26.dfsg1-14build1_amd64.deb ...</span><br><span class="line">Unpacking libsasl2-2:amd64 (2.1.26.dfsg1-14build1) over (2.1.26.dfsg1-14ubuntu0.1) ...</span><br><span class="line">Selecting previously unselected package libsasl2-dev.</span><br><span class="line">Preparing to unpack .../libsasl2-dev_2.1.26.dfsg1-14build1_amd64.deb ...</span><br><span class="line">Unpacking libsasl2-dev (2.1.26.dfsg1-14build1) ...</span><br><span class="line">Processing triggers <span class="keyword">for</span> libc-bin (2.23-0ubuntu11) ...</span><br><span class="line">Processing triggers <span class="keyword">for</span> man-db (2.7.5-1) ...</span><br><span class="line">Setting up libsasl2-2:amd64 (2.1.26.dfsg1-14build1) ...</span><br><span class="line">Setting up libsasl2-2:i386 (2.1.26.dfsg1-14build1) ...</span><br><span class="line">Setting up libsasl2-dev (2.1.26.dfsg1-14build1) ...</span><br><span class="line">Processing triggers <span class="keyword">for</span> libc-bin (2.23-0ubuntu11) ...</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="https://blog.mylitboy.com/article/operation/docker-install-openldap/" target="_blank" rel="noopener">Docker安装OpenLDAP及PHPLdapAdmin客户端</a></li>
<li><a href="https://wiki.gentoo.org/wiki/Centralized_authentication_using_OpenLDAP/zh" target="_blank" rel="noopener">使用OpenLDAP实现集中式认证</a></li>
<li><a href="https://www.cnblogs.com/woshimrf/p/ldap.html" target="_blank" rel="noopener">openldap介绍和使用</a></li>
</ol>
<h2 id="应用支持"><a href="#应用支持" class="headerlink" title="应用支持"></a>应用支持</h2><ul>
<li><a href="https://grafana.com/docs/grafana/v6.5/auth/ldap/" target="_blank" rel="noopener">https://grafana.com/docs/grafana/v6.5/auth/ldap/</a></li>
<li><a href="https://github.com/nginxinc/nginx-ldap-auth" target="_blank" rel="noopener">https://github.com/nginxinc/nginx-ldap-auth</a></li>
<li><a href="https://github.com/Banno/getsentry-ldap-auth" target="_blank" rel="noopener">https://github.com/Banno/getsentry-ldap-auth</a></li>
<li><a href="https://docs.gitlab.com/ee/administration/auth/ldap.html" target="_blank" rel="noopener">https://docs.gitlab.com/ee/administration/auth/ldap.html</a></li>
<li><a href="https://confluence.atlassian.com/adminjiraserver/connecting-to-an-ldap-directory-938847052.html" target="_blank" rel="noopener">https://confluence.atlassian.com/adminjiraserver/connecting-to-an-ldap-directory-938847052.html</a></li>
<li><a href="https://wiki.jenkins.io/display/JENKINS/LDAP+Plugin" target="_blank" rel="noopener">https://wiki.jenkins.io/display/JENKINS/LDAP+Plugin</a></li>
<li><a href="https://resources.collab.net/blogs/subversion-ldap-authentication-with-apache" target="_blank" rel="noopener">https://resources.collab.net/blogs/subversion-ldap-authentication-with-apache</a></li>
<li><a href="https://github.com/flowable/flowable-engine/tree/master/modules/flowable-ldap" target="_blank" rel="noopener">https://github.com/flowable/flowable-engine/tree/master/modules/flowable-ldap</a></li>
<li><a href="https://www.zentao.net/extension-viewExt-76.html" target="_blank" rel="noopener">https://www.zentao.net/extension-viewExt-76.html</a></li>
</ul>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2020/02/02/openldap/" data-id="ckdbgbyxe004h43popx1teubf" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2020/02/02/openldap/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openldap/">openldap</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-config" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/19/config/">关于配置文件的一些想法</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2020/01/19/config/" class="article-date"><time datetime="2020-01-19T16:00:00.000Z" itemprop="datePublished">2020-01-20</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/学习笔记/">学习笔记</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>当前配置文件可选择的非常多, 从很早的ini、xml到后来的json、yaml, 以及最近讨论得比较多的toml、hcl等</p>
<p>总体而言, 现在越来越倾向于易与人阅读的格式, 例如yaml、toml、hcl用来结构化的符号已经非常少了, 对比此前的xml、json有明显的区别</p>
<p>具体怎么选择, 首先要从业务需求分析, 比如就几个key/value对, 甚至可以考虑用参数传入, 下面从几个方面考虑</p>
<p>Ini<br><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment">; 稍微复杂一点的单层嵌套结构</span></span><br><span class="line"></span><br><span class="line"><span class="section">[c]</span></span><br><span class="line"><span class="attr">x</span> = c.x</span><br><span class="line"><span class="attr">y</span> = c.y</span><br><span class="line"></span><br><span class="line"><span class="section">[d]</span></span><br><span class="line"><span class="attr">x</span> = d.x</span><br><span class="line"><span class="attr">y</span> = d.y</span><br></pre></td></tr></table></figure></p>
<hr>
<p>java properties<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#以下为服务器、数据库信息</span><br><span class="line">dbPort = localhost</span><br><span class="line">databaseName = mydb</span><br><span class="line">dbUserName = root</span><br><span class="line">dbPassword = root</span><br><span class="line">#以下为数据库表信息</span><br><span class="line">dbTable = mytable</span><br><span class="line">#以下为服务器信息</span><br><span class="line">ip = 192.168.0.9</span><br></pre></td></tr></table></figure></p>
<hr>
<p>json<br><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"a"</span>: <span class="string">"a"</span>,</span><br><span class="line">    <span class="attr">"b"</span>: <span class="string">"b"</span>,</span><br><span class="line">    <span class="attr">"c"</span>:&#123;</span><br><span class="line">        <span class="attr">"x"</span>: <span class="string">"c.x"</span>,</span><br><span class="line">        <span class="attr">"y"</span>: <span class="string">"c.y"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"d"</span>:&#123;</span><br><span class="line">        <span class="attr">"x"</span>: <span class="string">"d.x"</span>,</span><br><span class="line">        <span class="attr">"y"</span>: <span class="string">"d.y"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"e"</span>:[</span><br><span class="line">        &#123; <span class="attr">"x"</span>:<span class="string">"e[0].x"</span>, <span class="attr">"y"</span>:<span class="string">"e[0].y"</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">"x"</span>:<span class="string">"e[1].x"</span>, <span class="attr">"y"</span>:<span class="string">"e[1].y"</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<p>yaml<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">b4:</span> <span class="literal">NuLL</span> <span class="comment"># string</span></span><br><span class="line"><span class="attr">b5:</span> <span class="literal">Null</span> <span class="comment"># null</span></span><br><span class="line"><span class="attr">c:</span></span><br><span class="line">  <span class="attr">x:</span> <span class="string">c.x</span></span><br><span class="line">  <span class="attr">y:</span> <span class="string">c.y</span></span><br><span class="line"><span class="attr">d:</span></span><br><span class="line">  <span class="attr">x:</span> <span class="string">d.x</span></span><br><span class="line">  <span class="attr">y:</span> <span class="string">d.y</span></span><br></pre></td></tr></table></figure></p>
<hr>
<p>toml<br><figure class="highlight toml"><table><tr><td class="code"><pre><span class="line"><span class="attr">a</span> = <span class="string">"a"</span></span><br><span class="line"><span class="attr">b</span> = <span class="string">"b"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">c.x</span> = <span class="string">"c.x"</span></span><br><span class="line"><span class="attr">c.y</span> = <span class="string">"c.y"</span></span><br><span class="line"></span><br><span class="line"><span class="section">[d]</span></span><br><span class="line"><span class="attr">x</span> = <span class="string">"d.x"</span></span><br><span class="line"><span class="attr">y</span> = <span class="string">"d.y"</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[e]]</span></span><br><span class="line"><span class="attr">x</span> = <span class="string">"e[0].x"</span></span><br><span class="line"><span class="attr">y</span> = <span class="string">"e[0].y"</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[e]]</span></span><br><span class="line"><span class="attr">x</span> = <span class="string">"e[1].x"</span></span><br><span class="line"><span class="attr">y</span> = <span class="string">"e[1].y"</span></span><br></pre></td></tr></table></figure></p>
<h2 id="机器友好-amp-人友好"><a href="#机器友好-amp-人友好" class="headerlink" title="机器友好&amp;人友好"></a>机器友好&amp;人友好</h2><p>机器友好,意味着<code>表述能力强</code>, <code>读写效率高</code>, 如果有频繁的读写操作, 并且很少会需要人来修改, 那么此类较为合适</p>
<p>人友好,则表示<code>容易看懂</code>, 若是修改<code>不易出错</code>.</p>
<blockquote>
<p>对于一个复杂 ( <em>特别是嵌套比较深</em> ) 的配置, 如果需要人来修改, 并非合适的选项, 做个配置页面会更好</p>
</blockquote>
<p>像xml虽然强大, 但是解析/阅读都不易, 新项目用得越来越少了</p>
<h2 id="注释友好"><a href="#注释友好" class="headerlink" title="注释友好"></a>注释友好</h2><p>除非完全不和人打交道, 否则注释是配置中非常重要的一块内容</p>
<p>xml/json对注释支持就不太好, yaml/properties/toml支持<code>#注释</code>, 部分还支持行尾注释, 而hcl则支持C语言风格的注释</p>
<h2 id="多行友好"><a href="#多行友好" class="headerlink" title="多行友好"></a>多行友好</h2><p>在json中写多行需要手动加换行符, 既麻烦又难以阅读, yaml原生支持<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">key:</span> <span class="string">|</span></span><br><span class="line">  <span class="string">line1</span></span><br><span class="line">  <span class="string">line2</span></span><br></pre></td></tr></table></figure></p>
<p>toml进一步扩展了多行的支持</p>
<h2 id="空格恐惧症"><a href="#空格恐惧症" class="headerlink" title="空格恐惧症"></a>空格恐惧症</h2><p>像yaml / toml / python 等通过空格缩进来确认层级的配置/语言, 容易因为多/少空格引发错误, 不过如今的编辑器都非常智能, 此类问题较为容易发现</p>
<p>减少结构化符号带来了空格维护问题, 过多的符号则影响内容的阅读, hcl则做了一个折中, 保留了json的大括号, 但是其他的符号适当的省略了</p>
<h2 id="语法增强"><a href="#语法增强" class="headerlink" title="语法增强"></a>语法增强</h2><p>所谓配置文件和编程语言相向而行, 越来越像对方了</p>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>ini、java properties等对数组支持不是很好, 后续基本都是标配. 目前yaml/toml都支持整形/浮点/布尔/日期等常用类型</p>
<h3 id="层级简化"><a href="#层级简化" class="headerlink" title="层级简化"></a>层级简化</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="attr">name</span> = <span class="string">"Orange"</span></span><br><span class="line"><span class="attr">physical.color</span> = <span class="string">"orange"</span></span><br><span class="line"><span class="attr">physical.shape</span> = <span class="string">"round"</span></span><br><span class="line">site."google.com" = true</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"Orange"</span>,</span><br><span class="line">  <span class="attr">"physical"</span>: &#123;</span><br><span class="line">    <span class="attr">"color"</span>: <span class="string">"orange"</span>,</span><br><span class="line">    <span class="attr">"shape"</span>: <span class="string">"round"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"site"</span>: &#123;</span><br><span class="line">    <span class="attr">"google.com"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="代码复用"><a href="#代码复用" class="headerlink" title="代码复用"></a>代码复用</h3><p>对于一些共用的变量, 块状配置, 支持引用,  减少维护成本.  主流的配置格式暂未发现方案</p>
<p>有一些第三方的库可以支持, 例如<a href="https://pypi.org/project/jsonref/" target="_blank" rel="noopener">https://pypi.org/project/jsonref/</a></p>
<h3 id="错误检查"><a href="#错误检查" class="headerlink" title="错误检查"></a>错误检查</h3><p>xml/json 有自己的校验框架,  例如<a href="https://python-jsonschema.readthedocs.io/en/stable/" target="_blank" rel="noopener">json schema</a>, 但这并不是解释器的功能, 也并非必须, 而新的配置, 可能会做一些语法上的要求, 规避一些常见的坑, 比如toml字典里key不可重复</p>
<h2 id="公司技术栈和语言文化"><a href="#公司技术栈和语言文化" class="headerlink" title="公司技术栈和语言文化"></a>公司技术栈和语言文化</h2><p>每个公司都有自己的技术栈, 比如阿里的Java, 那么具体用什么配置,很多时候会参考这个技术栈里面广泛使用的配置方案.  scalar就搞了一个<a href="https://github.com/lightbend/config/blob/master/HOCON.md" target="_blank" rel="noopener">HOCON</a></p>
<ul>
<li><a href="https://github.com/toml-lang/toml" target="_blank" rel="noopener">https://github.com/toml-lang/toml</a></li>
<li><a href="https://github.com/hashicorp/hcl" target="_blank" rel="noopener">https://github.com/hashicorp/hcl</a></li>
</ul>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2020/01/19/config/" data-id="ckdbgbyvc000c43pog8jot7jo" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2020/01/19/config/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-s3blob" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/13/s3blob/">Golang对象存储接口</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2020/01/13/s3blob/" class="article-date"><time datetime="2020-01-13T16:00:00.000Z" itemprop="datePublished">2020-01-14</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Golang/">Golang</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"path"</span></span><br><span class="line">	<span class="string">"path/filepath"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/aws/aws-sdk-go/aws"</span></span><br><span class="line">	<span class="string">"github.com/aws/aws-sdk-go/aws/credentials"</span></span><br><span class="line">	<span class="string">"github.com/aws/aws-sdk-go/aws/session"</span></span><br><span class="line">	<span class="string">"gocloud.dev/blob"</span></span><br><span class="line">	<span class="string">"gocloud.dev/blob/fileblob"</span></span><br><span class="line">	<span class="string">"gocloud.dev/blob/s3blob"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	bucketName = <span class="string">"kimq"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> blobStorage <span class="keyword">struct</span> &#123;</span><br><span class="line">	driver <span class="keyword">string</span></span><br><span class="line">	bucket *blob.Bucket</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *blobStorage)</span> <span class="title">Upload</span><span class="params">(ctx context.Context, name <span class="keyword">string</span>, reader io.Reader)</span> <span class="params">(outputURL <span class="keyword">string</span>, err error)</span></span> &#123;</span><br><span class="line">	key := path.Join(<span class="string">"images/"</span>, name)</span><br><span class="line">	writer, err := u.bucket.NewWriter(ctx, key, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"new writer error: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_, err = io.Copy(writer, reader)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"io copy error: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> writer.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := writer.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"writer close error: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ourl := fmt.Sprintf(<span class="string">"%s://%s/%s"</span>, u.driver, bucketName, key)</span><br><span class="line">	<span class="keyword">return</span> ourl, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init_file_bucket</span><span class="params">(ctx context.Context, bucket <span class="keyword">string</span>)</span> <span class="params">(*blobStorage, error)</span></span> &#123;</span><br><span class="line">	dir := filepath.Join(<span class="string">"/tmp/1/"</span>, bucket)</span><br><span class="line">	<span class="comment">//dir := filepath.Join(os.TempDir(), bucket)</span></span><br><span class="line">	<span class="keyword">if</span> err := os.MkdirAll(dir, <span class="number">0775</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"create bucket dir %q error: %v"</span>, dir, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	bb, err := fileblob.OpenBucket(dir, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"open bucket error: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;blobStorage&#123;</span><br><span class="line">		driver: <span class="string">"file"</span>,</span><br><span class="line">		bucket: bb,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init_jd_bucket</span><span class="params">(ctx context.Context, bucket <span class="keyword">string</span>)</span> <span class="params">(*blobStorage, error)</span></span> &#123;</span><br><span class="line">	ak := <span class="string">"Access Key ID"</span></span><br><span class="line">	sk := <span class="string">"Access Key Secret"</span></span><br><span class="line"></span><br><span class="line">	sess, err := session.NewSession(&amp;aws.Config&#123;</span><br><span class="line">		Endpoint:         aws.String(<span class="string">"s3.cn-south-1.jdcloud-oss.com"</span>), <span class="comment">//Bucket所在Endpoint</span></span><br><span class="line">		Region:           aws.String(<span class="string">"cn-south-1"</span>),                    <span class="comment">//Bucket所在Region</span></span><br><span class="line">		S3ForcePathStyle: aws.Bool(<span class="literal">true</span>),</span><br><span class="line">		Credentials:      credentials.NewStaticCredentials(ak, sk, <span class="string">""</span>),</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"new session error: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sb, err := s3blob.OpenBucket(ctx, sess, bucket, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"open bucket error: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;blobStorage&#123;</span><br><span class="line">		driver: <span class="string">"jds3"</span>,</span><br><span class="line">		bucket: sb,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	path := <span class="string">"/tmp/workshop.png"</span></span><br><span class="line">	filename := filepath.Base(path)</span><br><span class="line">	f, err := os.Open(path)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ctx := context.Background()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// up, err := init_file_bucket(ctx, bucketName)</span></span><br><span class="line">	up, err := init_jd_bucket(ctx, bucketName)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> f, err := up.Upload(ctx, filename, f); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"%s uploader ok %s\n"</span>, up.driver, f)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://www.alibabacloud.com/help/zh/doc-detail/64919.htm" target="_blank" rel="noopener">https://www.alibabacloud.com/help/zh/doc-detail/64919.htm</a></li>
<li><a href="https://docs.jdcloud.com/cn/object-storage-service/introduction-2" target="_blank" rel="noopener">https://docs.jdcloud.com/cn/object-storage-service/introduction-2</a></li>
<li><a href="https://docs.jdcloud.com/cn/object-storage-service/regions-and-endpoints" target="_blank" rel="noopener">https://docs.jdcloud.com/cn/object-storage-service/regions-and-endpoints</a></li>
</ul>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2020/01/13/s3blob/" data-id="ckdbgbyxn005043poas28tw7d" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2020/01/13/s3blob/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li></ul>


    </footer>
  </div>
  
</article>



  


  <div id="page-nav">
    <nav><ul class="pagination"><li class="disabled"><span class="page-prev"><i class="fa fa-chevron-left"></i> Prev</a></li><li class="active"><span class="page-number">1</span></li><li><a class="page-number" href="/page/2/">2</a></li><li><a class="page-number" href="/page/3/">3</a></li><li class="disabled"><span class="page-space">&hellip;</span></li><li><a class="page-number" href="/page/7/">7</a></li><li><a class="page-next" rel="next" href="/page/2/">Next <i class="fa fa-chevron-right"></i></a></li></ul></nav>
  </div>



        </div>
        <div class="col-sm-2 col-sm-offset-1 blog-sidebar">
          
  
  <div class="sidebar-module">
    <h4>Categories</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Golang/">Golang</a><span class="sidebar-module-list-count">14</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Openldap/">Openldap</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Python/">Python</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/后端/">后端</a><span class="sidebar-module-list-count">11</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/学习笔记/">学习笔记</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/开发环境/">开发环境</a><span class="sidebar-module-list-count">13</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/源码学习/">源码学习</a><span class="sidebar-module-list-count">9</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/环境搭建/">环境搭建</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/运营运维/">运营运维</a><span class="sidebar-module-list-count">10</span><ul class="sidebar-module-list-child"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/运营运维/代理/">代理</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/运营运维/网站/">网站</a><span class="sidebar-module-list-count">1</span></li></ul></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tags</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ansible/">ansible</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/antd/">antd</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/cookie/">cookie</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/cors/">cors</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/crsf/">crsf</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/docker/">docker</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/drone/">drone</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/elasticsearch/">elasticsearch</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/flask/">flask</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/git/">git</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/github/">github</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/gitlab/">gitlab</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/golang/">golang</a><span class="sidebar-module-list-count">27</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/gorm/">gorm</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/grpc/">grpc</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/hexo/">hexo</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/influxdb/">influxdb</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/jsonp/">jsonp</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/jsonschema/">jsonschema</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/kibana/">kibana</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/martini/">martini</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/nginx/">nginx</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ngrok/">ngrok</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/node/">node</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/openldap/">openldap</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/pip/">pip</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/proxy/">proxy</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/python/">python</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/redis/">redis</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/sentry/">sentry</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/sqlalchemy/">sqlalchemy</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ssh/">ssh</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/sso/">sso</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/tars/">tars</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/tavern/">tavern</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/travis/">travis</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/uml/">uml</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/wcgi/">wcgi</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/xss/">xss</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/一致性hash/">一致性hash</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/持续集成/">持续集成</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/盗链/">盗链</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/签名/">签名</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/证书/">证书</a><span class="sidebar-module-list-count">2</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tag Cloud</h4>
    <p class="tagcloud">
      <a href="/tags/ansible/" style="font-size: 10px;">ansible</a> <a href="/tags/antd/" style="font-size: 10px;">antd</a> <a href="/tags/cookie/" style="font-size: 11.67px;">cookie</a> <a href="/tags/cors/" style="font-size: 10px;">cors</a> <a href="/tags/crsf/" style="font-size: 10px;">crsf</a> <a href="/tags/docker/" style="font-size: 13.33px;">docker</a> <a href="/tags/drone/" style="font-size: 16.67px;">drone</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/flask/" style="font-size: 11.67px;">flask</a> <a href="/tags/git/" style="font-size: 11.67px;">git</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/gitlab/" style="font-size: 11.67px;">gitlab</a> <a href="/tags/golang/" style="font-size: 20px;">golang</a> <a href="/tags/gorm/" style="font-size: 10px;">gorm</a> <a href="/tags/grpc/" style="font-size: 10px;">grpc</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/influxdb/" style="font-size: 10px;">influxdb</a> <a href="/tags/jsonp/" style="font-size: 10px;">jsonp</a> <a href="/tags/jsonschema/" style="font-size: 10px;">jsonschema</a> <a href="/tags/kibana/" style="font-size: 10px;">kibana</a> <a href="/tags/martini/" style="font-size: 10px;">martini</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/ngrok/" style="font-size: 11.67px;">ngrok</a> <a href="/tags/node/" style="font-size: 10px;">node</a> <a href="/tags/openldap/" style="font-size: 13.33px;">openldap</a> <a href="/tags/pip/" style="font-size: 10px;">pip</a> <a href="/tags/proxy/" style="font-size: 13.33px;">proxy</a> <a href="/tags/python/" style="font-size: 11.67px;">python</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/sentry/" style="font-size: 11.67px;">sentry</a> <a href="/tags/sqlalchemy/" style="font-size: 10px;">sqlalchemy</a> <a href="/tags/ssh/" style="font-size: 11.67px;">ssh</a> <a href="/tags/sso/" style="font-size: 10px;">sso</a> <a href="/tags/tars/" style="font-size: 10px;">tars</a> <a href="/tags/tavern/" style="font-size: 10px;">tavern</a> <a href="/tags/travis/" style="font-size: 10px;">travis</a> <a href="/tags/uml/" style="font-size: 10px;">uml</a> <a href="/tags/wcgi/" style="font-size: 10px;">wcgi</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/一致性hash/" style="font-size: 10px;">一致性hash</a> <a href="/tags/持续集成/" style="font-size: 18.33px;">持续集成</a> <a href="/tags/盗链/" style="font-size: 10px;">盗链</a> <a href="/tags/签名/" style="font-size: 11.67px;">签名</a> <a href="/tags/证书/" style="font-size: 11.67px;">证书</a>
    </p>
  </div>


  
  <div class="sidebar-module">
    <h4>Archives</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/08/">八月 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/06/">六月 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/03/">三月 2020</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/02/">二月 2020</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/01/">一月 2020</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/07/">七月 2018</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/06/">六月 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/05/">五月 2018</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/12/">十二月 2017</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/10/">十月 2017</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/08/">八月 2017</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/07/">七月 2017</a><span class="sidebar-module-list-count">8</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/06/">六月 2017</a><span class="sidebar-module-list-count">7</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/04/">四月 2017</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/03/">三月 2017</a><span class="sidebar-module-list-count">10</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/02/">二月 2017</a><span class="sidebar-module-list-count">10</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Recents</h4>
    <ul class="sidebar-module-list">
      
        <li>
          <a href="/2020/08/01/gitlab-sentry/">gitlab/sentry集成</a>
        </li>
      
        <li>
          <a href="/2020/06/10/ansible/">Ansible实践</a>
        </li>
      
        <li>
          <a href="/2020/03/08/elasticsearch_basic/">ElasticSearch学习笔记</a>
        </li>
      
        <li>
          <a href="/2020/02/29/jaeger_basic/">Jaeger初探</a>
        </li>
      
        <li>
          <a href="/2020/02/20/tavern/">ResfulApi测试框架tavern</a>
        </li>
      
    </ul>
  </div>



        </div>
    </div>
  </div>
  <footer class="blog-footer">
  <div class="container">
    <div id="footer-info" class="inner">
      &copy; 2020 KingQiu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      <br/>
      CopyRight © 2019 <a href="http://beian.miit.gov.cn/" target="_blank">粤ICP备19068003号</a>
    </div>
  </div>
</footer>
<script>
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

  
<script>
  var disqus_shortname = 'blog-qiujinwu-com';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js" crossorigin="anonymous"></script>

<script src="http://cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js" crossorigin="anonymous"></script>



<script src="/js/script.js"></script>

</body>
</html>
