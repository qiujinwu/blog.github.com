<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta name="google-site-verification" content="6jvcY_UrCpp1JLjXITf45ljboLU0NDGF16ZqomMt-ls">
  
  <title>个人笔记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="随笔">
<meta property="og:type" content="website">
<meta property="og:title" content="个人笔记">
<meta property="og:url" content="http://blog.kimq.cn/page/5/index.html">
<meta property="og:site_name" content="个人笔记">
<meta property="og:description" content="随笔">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="个人笔记">
<meta name="twitter:description" content="随笔">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" integrity="sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+" crossorigin="anonymous">

  <link rel="stylesheet" href="/css/styles.css">
  

</head>
</html>
<body>
  <nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="main-menu-navbar">
      <ul class="nav navbar-nav">
        
          <li><a class=""
                 href="/index.html">Home</a></li>
        
          <li><a class=""
                 href="/archives/">Archives</a></li>
        
          <li><a class=""
                 href="/atom.xml">Rss</a></li>
        
      </ul>

      <!--
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

  <div class="container">
    <div class="blog-header">
  <h1 class="blog-title">个人笔记</h1>
  
    <p class="lead blog-description">专注互联网</p>
  
</div>

    <div class="row">
        <div class="col-sm-9 blog-main">
          
  
    <article id="post-lantern-share" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/22/lantern-share/">蓝灯局域网共享</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/06/22/lantern-share/" class="article-date"><time datetime="2017-06-22T11:52:33.000Z" itemprop="datePublished">2017-06-22</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/运营运维/">运营运维</a> / <a class="article-category-link" href="/categories/运营运维/代理/">代理</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="蓝灯"><a href="#蓝灯" class="headerlink" title="蓝灯"></a><a href="https://getlantern.org/" target="_blank" rel="noopener">蓝灯</a></h1><p><strong>蓝灯</strong> github <a href="https://github.com/getlantern/lantern" target="_blank" rel="noopener">https://github.com/getlantern/lantern</a>，其他页面</p>
<ol>
<li><a href="https://getlantern.org/" target="_blank" rel="noopener">https://getlantern.org/</a></li>
<li><a href="http://s3.amazonaws.com/urtuz53txrmk9/index.html" target="_blank" rel="noopener">http://s3.amazonaws.com/urtuz53txrmk9/index.html</a></li>
</ol>
<p>下载For windows版本，安装，我的版本是3.7.2，默认绑定的127.0.0.1主机，使用了三个端口，一个用于ui，一个用于socks5代理，一个用于http代理。</p>
<p>windows下会自动设置系统代理为lantern的http代理，也可以用<strong>SwitchyOmega</strong>之类的工具只代理浏览器</p>
<p>具体使用的端口可以从配置文件【C:\Users\xxx\AppData\Roaming\Lantern\setting.yaml】文件中找到，key分别是addr、uiAddr、socksAddr。（<em>不同的版本，配置文件可能有出入，端口也有出入</em>）</p>
<p>另一种方法是在打开lantern的时候自动打开的浏览器页面查看，具体是点击左上角的按钮 - 设置 -  高级设置（addr、socksAddr），uiAddr从浏览器地址栏就可以知道。</p>
<p>默认情况下，可以上网，免费账户每个月500M高速流量</p>
<h1 id="共享"><a href="#共享" class="headerlink" title="共享"></a>共享</h1><p>为了共享给局域网使用，特别是版本欠缺的iphone，由于默认绑定的127.0.0.1，局域网其他主机是无法访问socks5和http代理的，最简单直接的办法就是让其绑定0.0.0.0，google了网上教程，发现都无效，可能新版本都修复了那些漏洞，毕竟任意让你共享，收费版就玩不下去了。</p>
<p>直接日它不行那就取巧，将local的代理forward（中继）到一个绑定了0.0.0.0的其他端口</p>
<p>具体使用的工具是<strong><a href="http://www.privoxy.org/" target="_blank" rel="noopener">privoxy</a></strong>，一个成熟稳定的代理工具，支持Windows，我下载的版本是<strong><a href="http://www.privoxy.org/sf-download-mirror/Win32/" target="_blank" rel="noopener">3.0.10</a></strong></p>
<p>安装之后，找到【c:\Program files(x86)\Privoxy】的config.txt，将<strong>listen-address</strong>绑定的IP从127.0.0.1改成0.0.0.0，另外增加forward配置，将本机的lantern http代理forward到本机的8118端口<br><figure class="highlight"><table><tr><td class="code"><pre><span class="line">listen-address  0.0.0.0:8118</span><br><span class="line">forward / 127.0.0.1:49763</span><br></pre></td></tr></table></figure></p>
<p>我尝试过用<strong>【forward-socks5(t) / 127.0.0.1:49764 .】</strong>来重定向socks5代理，发现不行，只好重定向http代理了。</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/06/22/lantern-share/" data-id="ckdbgbywx003g43poirdm77bu" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/06/22/lantern-share/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/proxy/">proxy</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-golang-ci-docker" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/22/golang-ci-docker/">Golang持续集成，并生成docker镜像</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/06/22/golang-ci-docker/" class="article-date"><time datetime="2017-06-22T10:23:16.000Z" itemprop="datePublished">2017-06-22</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Golang/">Golang</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>本文代码请参考<a href="https://github.com/qjw/git-notify" target="_blank" rel="noopener">https://github.com/qjw/git-notify</a>，部分脚本参考<strong><a href="https://github.com/drone/drone" target="_blank" rel="noopener">drone</a></strong>的实现</p>
<p>将讲述两种ci，分别是<strong><a href="https://github.com/drone/drone" target="_blank" rel="noopener">drone</a></strong>和<strong><a href="https://www.travis-ci.org" target="_blank" rel="noopener">travis-ci</a></strong></p>
<h1 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h1><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(<span class="built_in">shell</span> uname)</span>, Darwin)</span><br><span class="line">	EXTLDFLAGS = -extldflags <span class="string">"-static"</span> <span class="variable">$(null)</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	EXTLDFLAGS =</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line">PACKAGES = <span class="variable">$(<span class="built_in">shell</span> go list ./... | grep -v /vendor/)</span></span><br><span class="line"></span><br><span class="line"><span class="section">deps: deps_backend</span></span><br><span class="line"></span><br><span class="line"><span class="section">deps_backend:</span></span><br><span class="line">	go get -u github.com/kardianos/govendor</span><br><span class="line">	go get -u github.com/jteeuwen/go-bindata/...</span><br><span class="line">	govendor sync</span><br><span class="line"></span><br><span class="line"><span class="section">gen: gen_template</span></span><br><span class="line"></span><br><span class="line"><span class="section">gen_template:</span></span><br><span class="line">	go generate github.com/qjw/git-notify/templates/</span><br><span class="line"></span><br><span class="line"><span class="section">test:</span></span><br><span class="line">	go test -cover <span class="variable">$(PACKAGES)</span></span><br><span class="line"></span><br><span class="line"><span class="section">build: build_static</span></span><br><span class="line"></span><br><span class="line"><span class="section">build_static:</span></span><br><span class="line">	CGO_ENABLED=0 GOOS=linux  go install -a -installsuffix cgo \</span><br><span class="line">    	-ldflags '$&#123;EXTLDFLAGS&#125;' github.com/qjw/git-notify</span><br><span class="line">	mkdir -p release</span><br><span class="line">	cp <span class="variable">$(GOPATH)</span>/bin/git-notify release/</span><br></pre></td></tr></table></figure>
<ol>
<li>makefile中的项目路径需要根据实际情况修改</li>
<li>依赖的二进制工具（<strong>deps_backend</strong>）也因项目而异</li>
<li>上面的<strong>govendor sync</strong>是用来根据<strong>vendor/vendor.json</strong>来同步依赖库，若使用其他，需要酌情修改</li>
<li><strong><a href="https://github.com/qjw/git-notify" target="_blank" rel="noopener">git-notify</a></strong>有模板资源，并且依赖&lt;github.com/jteeuwen/go-bindata&gt;打包到代码中，所以需要go template，根据需要作删减</li>
</ol>
<p>有了这个，运行下面命令即可在项目主目录/release生成目标执行文件。<strong>为了生成的docker镜像更小，这里使用静态编译</strong>，若无此需求，可以普通编译，以减少目标文件尺寸<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make deps gen <span class="built_in">test</span> build</span><br></pre></td></tr></table></figure></p>
<h1 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h1><p>编译成功之后，就可以运行下列命令生成docker镜像<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t git-notify:0.1 .</span><br></pre></td></tr></table></figure></p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> release/git-notify /</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"/git-notify"</span>]</span></span><br></pre></td></tr></table></figure>
<h1 id="drone"><a href="#drone" class="headerlink" title="drone"></a><a href="https://github.com/drone/drone" target="_blank" rel="noopener">drone</a></h1><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">workspace:</span></span><br><span class="line">  <span class="attr">base:</span> <span class="string">/go</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">src/github.com/qjw/git-notify</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pipeline:</span></span><br><span class="line">  <span class="attr">test:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">golang:1.8</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GO15VENDOREXPERIMENT=1</span></span><br><span class="line">    <span class="attr">commands:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">make</span> <span class="string">deps</span> <span class="string">gen</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">make</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">compile:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">golang:1.8</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GO15VENDOREXPERIMENT=1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GOPATH=/go</span></span><br><span class="line">    <span class="attr">commands:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">export</span> <span class="string">PATH=$PATH:$GOPATH/bin</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">make</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">docker:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">plugins/docker</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">$&#123;EMAIL&#125;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;PASSWORD&#125;</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">$&#123;EMAIL&#125;</span></span><br><span class="line">    <span class="attr">repo:</span> <span class="string">hub.c.163.com/$&#123;USERNAME&#125;/test</span></span><br><span class="line">    <span class="attr">registry:</span> <span class="string">hub.c.163.com</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">latest</span></span><br></pre></td></tr></table></figure>
<h1 id="travis-ci"><a href="#travis-ci" class="headerlink" title="travis-ci"></a><a href="https://www.travis-ci.org" target="_blank" rel="noopener">travis-ci</a></h1><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">sudo:</span> <span class="string">required</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">go</span></span><br><span class="line"><span class="attr">go:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="number">1.8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker</span></span><br><span class="line"></span><br><span class="line"><span class="attr">branches:</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"><span class="attr">install:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">make</span> <span class="string">deps</span> <span class="string">gen</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">make</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">make</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line"><span class="attr">after_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker</span> <span class="string">build</span> <span class="string">-t</span> <span class="string">qjw/git-notify</span> <span class="string">.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker</span> <span class="string">login</span> <span class="string">-u</span> <span class="string">$&#123;EMAIL&#125;</span> <span class="string">-p</span> <span class="string">$&#123;PASSWORD&#125;</span> <span class="string">hub.c.163.com</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker</span> <span class="string">tag</span> <span class="string">qjw/git-notify</span> <span class="string">hub.c.163.com/$&#123;USERNAME&#125;/git-notify</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">hub.c.163.com/$&#123;USERNAME&#125;/git-notify</span></span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="https://blog.codeship.com/building-minimal-docker-containers-for-go-applications/" target="_blank" rel="noopener">https://blog.codeship.com/building-minimal-docker-containers-for-go-applications/</a></li>
</ol>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/06/22/golang-ci-docker/" data-id="ckdbgbyw8002543po7gh608zo" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/06/22/golang-ci-docker/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/持续集成/">持续集成</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-golang-testing" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/20/golang-testing/">Golang单元测试</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/06/20/golang-testing/" class="article-date"><time datetime="2017-06-20T04:23:16.000Z" itemprop="datePublished">2017-06-20</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Golang/">Golang</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="简单用法"><a href="#简单用法" class="headerlink" title="简单用法"></a>简单用法</h1><p>记住下面的这些原则：</p>
<ol>
<li>文件名必须是_test.go结尾的，这样在执行go test的时候才会执行到相应的代码</li>
<li>你必须import testing这个包</li>
<li>所有的测试用例函数必须是Test开头</li>
<li>测试用例会按照源代码中写的顺序依次执行</li>
<li>测试函数TestXxx()的参数是testing.T，我们可以使用该类型来记录错误或者是测试状态</li>
<li>测试格式：func TestXxx (t *testing.T),Xxx部分可以为任意的字母数字的组合，但是首字母不能是小写字母[a-z]，例如Testintdiv是错误的函数名。</li>
<li>.T的Error, Errorf, FailNow, Fatal, FatalIf方法，说明测试不通过，调用Log方法用来记录测试的信息。</li>
</ol>
<p>例如 fibonacci.go<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> lib</span><br><span class="line"></span><br><span class="line"><span class="comment">//斐波那契数列</span></span><br><span class="line"><span class="comment">//求出第n个数的值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fibonacci</span><span class="params">(n <span class="keyword">int64</span>)</span> <span class="title">int64</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> n &lt; <span class="number">2</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Fibonacci(n<span class="number">-1</span>) + Fibonacci(n<span class="number">-2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>fibonacci_test.go<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> lib</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"testing"</span></span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestFibonacci</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    r := Fibonacci(<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">if</span> r != <span class="number">55</span> &#123;</span><br><span class="line">        t.Errorf(<span class="string">"Fibonacci(10) failed. Got %d, expected 55."</span>, r)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go <span class="built_in">test</span> lib</span><br></pre></td></tr></table></figure>
<h2 id="构造析构"><a href="#构造析构" class="headerlink" title="构造析构"></a>构造析构</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// package level initialization of database connections</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// init database connections</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该函数由 go 语言的 test 框架调用</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestLastUnit</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 测试结束时，清理数据</span></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">(userID <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    &#125;(userID)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果待测试的功能模块涉及到文件操作，临时文件是一个不错的解决方案,<strong>go语言的 ioutil 包提供了 TempDir 和 TempFile 方法，供我们使用。</strong></p>
<h2 id="Package"><a href="#Package" class="headerlink" title="Package"></a>Package</h2><p>在写单元测试时，一般情况下，我们将功能代码和测试代码放到同一个目录下，仅以后缀 _test 进行区分。</p>
<p>对于复杂的大型项目，功能依赖比较多时，通常在跟目录下再增加一个 test 文件夹，不同的测试放到不同的子目录下面，如下图所示：</p>
<h2 id="覆盖率"><a href="#覆盖率" class="headerlink" title="覆盖率"></a>覆盖率</h2><p>在go语言的测试覆盖率统计时，go test通过参数<strong>covermode</strong>的设定可以对覆盖率统计模式作如下三种设定。</p>
<ol>
<li>set    缺省模式, 只记录语句是否被执行过</li>
<li>count    记录语句被执行的次数</li>
<li>atomic    记录语句被执行的次数，并保证在并发执行时的正确性</li>
</ol>
<p>其他选项</p>
<ol>
<li>-cover 允许代码分析</li>
<li>-coverprofile 输出结果文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go <span class="built_in">test</span> -cover -coverprofile=cover.out -covermode=count -o /tmp/testgo <span class="built_in">test</span></span><br><span class="line">go tool cover -func=cover.out</span><br><span class="line"><span class="comment"># 用html直观展示</span></span><br><span class="line">go tool cover -html=cover.out</span><br></pre></td></tr></table></figure>
<h2 id="httptest"><a href="#httptest" class="headerlink" title="httptest"></a>httptest</h2><p>针对模拟网络访问，标准库了提供了一个httptest包，可以让我们模拟http的网络调用，下面举个例子了解使用。<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"io"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// e.g. http.HandleFunc("/health-check", HealthCheckHandler)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HealthCheckHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="comment">// A very simple health check.</span></span><br><span class="line">	w.WriteHeader(http.StatusOK)</span><br><span class="line">	w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// In the future we could report back on the status of our DB, or our cache</span></span><br><span class="line">	<span class="comment">// (e.g. Redis) by performing a simple PING, and include them in the response.</span></span><br><span class="line">	io.WriteString(w, <span class="string">`&#123;"alive": true&#125;`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"net/http/httptest"</span></span><br><span class="line">	<span class="string">"testing"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestHealthCheckHandler</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Create a request to pass to our handler. We don't have any query parameters for now, so we'll</span></span><br><span class="line">	<span class="comment">// pass 'nil' as the third parameter.</span></span><br><span class="line">	req, err := http.NewRequest(<span class="string">"GET"</span>, <span class="string">"/health-check"</span>, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		t.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// We create a ResponseRecorder (which satisfies http.ResponseWriter) to record the response.</span></span><br><span class="line">	rr := httptest.NewRecorder()</span><br><span class="line">	handler := http.HandlerFunc(HealthCheckHandler)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Our handlers satisfy http.Handler, so we can call their ServeHTTP method</span></span><br><span class="line">	<span class="comment">// directly and pass in our Request and ResponseRecorder.</span></span><br><span class="line">	handler.ServeHTTP(rr, req)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Check the status code is what we expect.</span></span><br><span class="line">	<span class="keyword">if</span> status := rr.Code; status != http.StatusOK &#123;</span><br><span class="line">		t.Errorf(<span class="string">"handler returned wrong status code: got %v want %v"</span>,</span><br><span class="line">			status, http.StatusOK)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Check the response body is what we expect.</span></span><br><span class="line">	expected := <span class="string">`&#123;"alive1": true&#125;`</span></span><br><span class="line">	<span class="keyword">if</span> rr.Body.String() != expected &#123;</span><br><span class="line">		t.Errorf(<span class="string">"handler returned unexpected body: got %v want %v"</span>,</span><br><span class="line">			rr.Body.String(), expected)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="stretchr-testify"><a href="#stretchr-testify" class="headerlink" title="stretchr/testify"></a>stretchr/testify</h1><p>和其他的单元测试相比，go提供的默认方案灵活但繁琐，<a href="https://github.com/stretchr/testify" target="_blank" rel="noopener">https://github.com/stretchr/testify</a>作了适当的包装简化</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go get github.com/stretchr/testify</span><br></pre></td></tr></table></figure>
<p>testify又分成几个模块</p>
<h2 id="assert"><a href="#assert" class="headerlink" title="assert"></a>assert</h2><ol>
<li>Prints friendly, easy to read failure descriptions</li>
<li>Allows for very readable code</li>
<li>Optionally annotate each assertion with a message</li>
</ol>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> yours</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"testing"</span></span><br><span class="line">    <span class="string">"github.com/stretchr/testify/assert"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSomething</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// assert equality</span></span><br><span class="line">    assert.Equal(t, <span class="number">123</span>, <span class="number">123</span>, <span class="string">"they should be equal"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// assert inequality</span></span><br><span class="line">    assert.NotEqual(t, <span class="number">123</span>, <span class="number">456</span>, <span class="string">"they should not be equal"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// assert for nil (good for errors)</span></span><br><span class="line">    assert.Nil(t, object)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// assert for not nil (good when you expect something)</span></span><br><span class="line">    <span class="keyword">if</span> assert.NotNil(t, object) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// now we know that object isn't nil, we are safe to make</span></span><br><span class="line">    <span class="comment">// further assertions without causing any errors</span></span><br><span class="line">    assert.Equal(t, <span class="string">"Something"</span>, object.Value)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="require"><a href="#require" class="headerlink" title="require"></a>require</h2><p>The require package provides same global functions as the assert package, but instead of returning a boolean result they terminate current test.</p>
<h2 id="mock"><a href="#mock" class="headerlink" title="mock"></a>mock</h2><p>当某些接口依赖其他接口时，可以通过mock模拟依赖的接口并做出预期的输出<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> test</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Random <span class="keyword">interface</span> &#123;</span><br><span class="line">	Random(limit <span class="keyword">int</span>) <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Calculator <span class="keyword">interface</span> &#123;</span><br><span class="line">	Random() <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newCalculator</span><span class="params">(rnd Random)</span> <span class="title">Calculator</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> calc&#123;</span><br><span class="line">		rnd: rnd,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> calc <span class="keyword">struct</span> &#123;</span><br><span class="line">	rnd Random</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c calc)</span> <span class="title">Random</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> c.rnd.Random(<span class="number">100</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Calculator 接口创建依赖于Random接口，为了测试前者，我们用mock<strong>模拟一个Random接口</strong>，见randomMock<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/stretchr/testify/assert"</span></span><br><span class="line">	<span class="string">"github.com/stretchr/testify/mock"</span></span><br><span class="line">	<span class="string">"testing"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> randomMock <span class="keyword">struct</span> &#123;</span><br><span class="line">	mock.Mock</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o randomMock)</span> <span class="title">Random</span><span class="params">(limit <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	args := o.Called(limit)</span><br><span class="line">	<span class="keyword">return</span> args.Int(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestRandom</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	rnd := <span class="built_in">new</span>(randomMock)</span><br><span class="line">	rnd.On(<span class="string">"Random"</span>, <span class="number">100</span>).Return(<span class="number">7</span>)</span><br><span class="line">	calc := newCalculator(rnd)</span><br><span class="line">	assert.Equal(t, <span class="number">7</span>, calc.Random())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="mockery"><a href="#mockery" class="headerlink" title="mockery"></a>mockery</h3><p><strong><a href="https://github.com/vektra/mockery" target="_blank" rel="noopener">mockery</a></strong> provides the ability to easily generate mocks for golang interfaces. It removes the boilerplate coding required to use mocks.</p>
<p>接上面的例子，运行下面的命令<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go get github.com/vektra/mockery/.../</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/code/go/src/<span class="built_in">test</span>$ mockery -name=Random</span><br><span class="line">Generating mock <span class="keyword">for</span>: Random</span><br></pre></td></tr></table></figure>
<p>就自动生成mocks/Random.go</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">├── main.go</span><br><span class="line">├── main_test.go</span><br><span class="line">├── mocks</span><br><span class="line">│   └── Random.go</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Code generated by mockery v1.0.0</span></span><br><span class="line"><span class="keyword">package</span> mocks</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> mock <span class="string">"github.com/stretchr/testify/mock"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Random is an autogenerated mock type for the Random type</span></span><br><span class="line"><span class="keyword">type</span> Random <span class="keyword">struct</span> &#123;</span><br><span class="line">	mock.Mock</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Random provides a mock function with given fields: limit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(_m *Random)</span> <span class="title">Random</span><span class="params">(limit <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	ret := _m.Called(limit)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> r0 <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">if</span> rf, ok := ret.Get(<span class="number">0</span>).(<span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">int</span>)</span> <span class="title">int</span>); <span class="title">ok</span></span> &#123;</span><br><span class="line">		r0 = rf(limit)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		r0 = ret.Get(<span class="number">0</span>).(<span class="keyword">int</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> r0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应的main_test.go修改为<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/stretchr/testify/assert"</span></span><br><span class="line">	<span class="comment">// "github.com/stretchr/testify/mock"</span></span><br><span class="line">	<span class="string">"testing"</span></span><br><span class="line">	<span class="string">"test/mocks"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//type RandomMock struct &#123;</span></span><br><span class="line"><span class="comment">//	mock.Mock</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//func (o RandomMock) Random(limit int) int &#123;</span></span><br><span class="line"><span class="comment">//	args := o.Called(limit)</span></span><br><span class="line"><span class="comment">//	return args.Int(0)</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestRandom</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	rnd := <span class="built_in">new</span>(mocks.Random)</span><br><span class="line">	rnd.On(<span class="string">"Random"</span>, <span class="number">100</span>).Return(<span class="number">7</span>)</span><br><span class="line">	calc := newCalculator(rnd)</span><br><span class="line">	assert.Equal(t, <span class="number">7</span>, calc.Random())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>另参考<a href="https://github.com/jaytaylor/mockery-example" target="_blank" rel="noopener">https://github.com/jaytaylor/mockery-example</a></p>
<h1 id="Goblin"><a href="#Goblin" class="headerlink" title="Goblin"></a>Goblin</h1><p>Minimal and Beautiful Go testing framework <a href="https://github.com/franela/goblin" target="_blank" rel="noopener">https://github.com/franela/goblin</a></p>
<p>Goblin是一个小巧的测试框架，可以配合testing使用，内建了assert的一些方法<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"testing"</span></span><br><span class="line">    . <span class="string">"github.com/franela/goblin"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Test</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    g := Goblin(t)</span><br><span class="line">    g.Describe(<span class="string">"Numbers"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        g.It(<span class="string">"Should add two numbers "</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            g.Assert(<span class="number">1</span>+<span class="number">1</span>).Equal(<span class="number">2</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        g.It(<span class="string">"Should match equal numbers"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            g.Assert(<span class="number">2</span>).Equal(<span class="number">4</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        g.It(<span class="string">"Should substract two numbers"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/06/20/golang-testing/" data-id="ckdbgbywd002j43pox12mvyz4" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/06/20/golang-testing/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-gitlab-env" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/19/gitlab-env/">搭建gitlab测试环境</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/06/19/gitlab-env/" class="article-date"><time datetime="2017-06-19T02:36:35.000Z" itemprop="datePublished">2017-06-19</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/开发环境/">开发环境</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="准备docker"><a href="#准备docker" class="headerlink" title="准备docker"></a>准备docker</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p /mnt/volumes/gitlab</span><br><span class="line"><span class="built_in">cd</span> /mnt/volumes/gitlab</span><br><span class="line">mkdir config logs data</span><br><span class="line">sudo docker run -it --rm  \</span><br><span class="line">    --hostname localhost \</span><br><span class="line">    --publish 8080:80 --publish 2222:22 \</span><br><span class="line">    --name gitlab \</span><br><span class="line">    --volume /mnt/volumes/gitlab/config:/etc/gitlab \</span><br><span class="line">    --volume /mnt/volumes/gitlab/logs:/var/<span class="built_in">log</span>/gitlab \</span><br><span class="line">    --volume /mnt/volumes/gitlab/data:/var/opt/gitlab \</span><br><span class="line">    gitlab/gitlab-ce:latest</span><br></pre></td></tr></table></figure>
<blockquote>
</blockquote>
<p>–hostname<br>指定容器中绑定的域名，会在创建镜像仓库的时候使用到，这里绑定localhost<br>–publish<br>端口映射，冒号前面是宿主机端口，后面是容器expose出的端口<br>–volume<br>volume 映射，冒号前面是宿主机的一个文件路径，后面是容器中的文件路径</p>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>启动之后就可以使用地址<a href="http://127.0.0.1:8080" target="_blank" rel="noopener">http://127.0.0.1:8080</a>访问本地的gitlab，</p>
<p>启动之后需要设置初始的密码，以及注册新用户</p>
<p>完了创建group和project</p>
<p><strong>添加公钥，以便免密clone</strong>，从~/.ssh/isa.pub文件中获取</p>
<p>然后就可以clone代码了</p>
<h2 id="指定git-clone-的端口"><a href="#指定git-clone-的端口" class="headerlink" title="指定git clone 的端口"></a>指定git clone 的端口</h2><p>由于docker将22端口重定向到了主机的2222，所以需要修改<strong>~/.ssh/config</strong>文件，添加<br><figure class="highlight"><table><tr><td class="code"><pre><span class="line">Host localhost</span><br><span class="line">    Port 2222</span><br></pre></td></tr></table></figure></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="http://www.jianshu.com/p/05e3bb375f64" target="_blank" rel="noopener">http://www.jianshu.com/p/05e3bb375f64</a></li>
<li><a href="https://stackoverflow.com/questions/3596260/git-remote-add-with-other-ssh-port" target="_blank" rel="noopener">https://stackoverflow.com/questions/3596260/git-remote-add-with-other-ssh-port</a></li>
</ol>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/06/19/gitlab-env/" data-id="ckdbgbyvx001g43pogupnunz6" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/06/19/gitlab-env/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gitlab/">gitlab</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-git-rebase" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/17/git-rebase/">git rebase 合并commit</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/04/17/git-rebase/" class="article-date"><time datetime="2017-04-17T08:13:05.000Z" itemprop="datePublished">2017-04-17</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/开发环境/">开发环境</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>对git基本上是记住一些常用的功能，其他用到了去查手册，这里备注一个我不常用但挺实用的功能</p>
<p>一句话，将若干commit合并成一个。</p>
<h1 id="本地多个commit合并"><a href="#本地多个commit合并" class="headerlink" title="本地多个commit合并"></a>本地多个commit合并</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 本地新建10个commit</span></span><br><span class="line"><span class="keyword">for</span> ((i=1;i&lt;10;i++));<span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt; a;git add .;git commit -m commit<span class="variable">$i</span>;<span class="keyword">done</span>;</span><br></pre></td></tr></table></figure>
<p>log如下<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">* a69d8fb - (HEAD -&gt; master) commit9 (2 分钟前) &lt;King&gt;</span><br><span class="line">* 6b24d3a - commit8 (2 分钟前) &lt;King&gt;</span><br><span class="line">* 98aeb92 - commit7 (2 分钟前) &lt;King&gt;</span><br><span class="line">* 8b2120b - commit6 (2 分钟前) &lt;King&gt;</span><br><span class="line">* 8660ff5 - commit5 (2 分钟前) &lt;King&gt;</span><br><span class="line">* 38b1be3 - commit4 (2 分钟前) &lt;King&gt;</span><br><span class="line">* 07be2fa - commit3 (2 分钟前) &lt;King&gt;</span><br><span class="line">* 139aabd - commit2 (2 分钟前) &lt;King&gt;</span><br><span class="line">* f570edb - commit1 (2 分钟前) &lt;King&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:/tmp/git/work$ git rebase -i f570edb</span><br><span class="line"><span class="comment"># 将后面的提交的pick都改成s，保存确认commit的描述</span></span><br><span class="line">pick 139aabd commit2</span><br><span class="line">s 07be2fa commit3</span><br><span class="line">s 38b1be3 commit4</span><br><span class="line">s 8660ff5 commit5</span><br><span class="line">s 8b2120b commit6</span><br><span class="line">s 98aeb92 commit7</span><br><span class="line">s 6b24d3a commit8</span><br><span class="line">s a69d8fb commit9</span><br><span class="line">king@king:/tmp/git/work$ git <span class="built_in">log</span></span><br><span class="line">commit c040772af1dd96cd3311112193e39cbfd7a93e28</span><br><span class="line">Author: King &lt;qiujinwu456@gmail.com&gt;</span><br><span class="line">Date:   Mon Apr 17 16:17:11 2017 +0800</span><br><span class="line">    commit2</span><br><span class="line">    commit3</span><br><span class="line">    commit4</span><br><span class="line">    commit5</span><br><span class="line">    commit6</span><br><span class="line">    commit7</span><br><span class="line">    commit8</span><br><span class="line">    commit9</span><br><span class="line">commit f570edbf5bbe3ba661c36916c36ac12227e1cdd1</span><br><span class="line">Author: King &lt;qiujinwu456@gmail.com&gt;</span><br><span class="line">Date:   Mon Apr 17 16:17:11 2017 +0800</span><br><span class="line">    commit1</span><br></pre></td></tr></table></figure>
<p>可以看到最新的9个已经merge成一个，但是第一个和第二个还是分开了（<strong>搞不懂为啥要这么设计，将第一个pick改成s，或者其他操作都不行</strong>）</p>
<p>如果一定要合并，可以参考<a href="http://stackoverflow.com/questions/2563632/how-can-i-merge-two-commits-into-one" target="_blank" rel="noopener">http://stackoverflow.com/questions/2563632/how-can-i-merge-two-commits-into-one</a><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 清掉第一条commit，但是保留代码</span></span><br><span class="line">git reset --soft <span class="string">"HEAD^"</span></span><br><span class="line"><span class="comment"># 复用上一次的commit</span></span><br><span class="line">git commit --amend</span><br></pre></td></tr></table></figure></p>
<h1 id="多人合作"><a href="#多人合作" class="headerlink" title="多人合作"></a>多人合作</h1><p>新建三个目录<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:/tmp/git$ tree . -d 2</span><br><span class="line">.</span><br><span class="line">├── origin</span><br><span class="line">├── work</span><br><span class="line">└── work1</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp/git/work</span><br><span class="line">git init .</span><br><span class="line"><span class="keyword">for</span> ((i=1;i&lt;10;i++));<span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt; a;git add .;git commit -m commit<span class="variable">$i</span>;<span class="keyword">done</span>;</span><br><span class="line">git remote add origin /tmp/git/origin/</span><br><span class="line"><span class="built_in">cd</span> ../origin</span><br><span class="line">git init --bare</span><br><span class="line"><span class="built_in">cd</span> -</span><br><span class="line">git push origin master</span><br><span class="line"><span class="built_in">cd</span> ../work1</span><br><span class="line">git <span class="built_in">clone</span> /tmp/git/origin/ .</span><br></pre></td></tr></table></figure>
<p>到目前为止，work和work1共享了origin仓库</p>
<p>接下来让别人push一些修改到master，自己也做了一些commit<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp/git/work</span><br><span class="line"><span class="keyword">for</span> ((i=1;i&lt;10;i++));<span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt; b;git add .;git commit -m <span class="built_in">local</span><span class="variable">$i</span>;<span class="keyword">done</span>;</span><br><span class="line"><span class="built_in">cd</span> ../work1</span><br><span class="line">git config user.name <span class="string">"another king"</span></span><br><span class="line"><span class="keyword">for</span> ((i=1;i&lt;10;i++));<span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt; c;git add .;git commit -m remote<span class="variable">$i</span>;<span class="keyword">done</span>;</span><br><span class="line">git push origin master</span><br><span class="line"><span class="built_in">cd</span> -</span><br></pre></td></tr></table></figure></p>
<p>在work pull远程代码之后，log是这样的<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git pull origin master</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">*   3d5b7d2 - (HEAD -&gt; master) Merge branch <span class="string">'master'</span> of /tmp/git/origin (19 秒钟前) &lt;King&gt;</span><br><span class="line">|\  </span><br><span class="line">| * c83b1e9 - (origin/master) remote9 (40 秒钟前) &lt;another king&gt;</span><br><span class="line">| * 0c6e331 - remote8 (40 秒钟前) &lt;another king&gt;</span><br><span class="line">| * 17a8fcd - remote7 (40 秒钟前) &lt;another king&gt;</span><br><span class="line">| * c685ee7 - remote6 (40 秒钟前) &lt;another king&gt;</span><br><span class="line">| * 8868d35 - remote5 (40 秒钟前) &lt;another king&gt;</span><br><span class="line">| * 3b724d2 - remote4 (40 秒钟前) &lt;another king&gt;</span><br><span class="line">| * d82b1bd - remote3 (40 秒钟前) &lt;another king&gt;</span><br><span class="line">| * e9865f1 - remote2 (40 秒钟前) &lt;another king&gt;</span><br><span class="line">| * 2c86a3b - remote1 (40 秒钟前) &lt;another king&gt;</span><br><span class="line">* | 1384e0c - local9 (40 秒钟前) &lt;King&gt;</span><br><span class="line">* | ae7c46e - local8 (40 秒钟前) &lt;King&gt;</span><br><span class="line">* | bbea9bb - local7 (40 秒钟前) &lt;King&gt;</span><br><span class="line">* | 88e2fbb - local6 (40 秒钟前) &lt;King&gt;</span><br><span class="line">* | 60b7ac3 - local5 (40 秒钟前) &lt;King&gt;</span><br><span class="line">* | c5494bd - local4 (40 秒钟前) &lt;King&gt;</span><br><span class="line">* | 5dfe9a9 - local3 (40 秒钟前) &lt;King&gt;</span><br><span class="line">* | 18ecbb4 - local2 (40 秒钟前) &lt;King&gt;</span><br><span class="line">* | 76662a5 - local1 (40 秒钟前) &lt;King&gt;</span><br><span class="line">|/  </span><br><span class="line">* 8383510 - commit9 (48 秒钟前) &lt;King&gt;</span><br><span class="line">* 0a15467 - commit8 (48 秒钟前) &lt;King&gt;</span><br><span class="line">* 3f76d47 - commit7 (48 秒钟前) &lt;King&gt;</span><br><span class="line">* 3d469ec - commit6 (48 秒钟前) &lt;King&gt;</span><br><span class="line">* cdcf488 - commit5 (48 秒钟前) &lt;King&gt;</span><br><span class="line">* cab099e - commit4 (48 秒钟前) &lt;King&gt;</span><br><span class="line">* 77a35fe - commit3 (48 秒钟前) &lt;King&gt;</span><br><span class="line">* 5b8b08e - commit2 (48 秒钟前) &lt;King&gt;</span><br><span class="line">* f1d3575 - commit1 (49 秒钟前) &lt;King&gt;</span><br></pre></td></tr></table></figure>
<p>这里有个问题，别人的改动插入到我的改动之中，若改成rebase，就不一样<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:/tmp/git/work$ git pull --rebase origin master</span><br><span class="line">remote: 对象计数中: 26, 完成.</span><br><span class="line">remote: 压缩对象中: 100% (18/18), 完成.</span><br><span class="line">remote: Total 26 (delta 0), reused 0 (delta 0)</span><br><span class="line">展开对象中: 100% (26/26), 完成.</span><br><span class="line">来自 /tmp/git/origin</span><br><span class="line"> * branch            master     -&gt; FETCH_HEAD</span><br><span class="line">   4245282..ff5ceb9  master     -&gt; origin/master</span><br><span class="line">首先，回退分支以便在上面重放您的工作...</span><br><span class="line">应用：local1</span><br><span class="line">应用：local2</span><br><span class="line">应用：local3</span><br><span class="line">应用：local4</span><br><span class="line">应用：local5</span><br><span class="line">应用：local6</span><br><span class="line">应用：local7</span><br><span class="line">应用：local8</span><br><span class="line">应用：local9</span><br></pre></td></tr></table></figure></p>
<p>生成后的log如下<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">* d6f1150 - (HEAD -&gt; master) local9 (29 秒钟前) &lt;King&gt;</span><br><span class="line">* 3ea2ae7 - local8 (29 秒钟前) &lt;King&gt;</span><br><span class="line">* a1dcc9b - local7 (29 秒钟前) &lt;King&gt;</span><br><span class="line">* 65488ec - local6 (29 秒钟前) &lt;King&gt;</span><br><span class="line">* 417f852 - local5 (29 秒钟前) &lt;King&gt;</span><br><span class="line">* e460dbd - local4 (29 秒钟前) &lt;King&gt;</span><br><span class="line">* 7a0e9a5 - local3 (29 秒钟前) &lt;King&gt;</span><br><span class="line">* cc58778 - local2 (29 秒钟前) &lt;King&gt;</span><br><span class="line">* e69d861 - local1 (29 秒钟前) &lt;King&gt;</span><br><span class="line">* ff5ceb9 - (origin/master) remote9 (54 秒钟前) &lt;another king&gt;</span><br><span class="line">* dc8997b - remote8 (54 秒钟前) &lt;another king&gt;</span><br><span class="line">* ef231f5 - remote7 (54 秒钟前) &lt;another king&gt;</span><br><span class="line">* e7af01a - remote6 (54 秒钟前) &lt;another king&gt;</span><br><span class="line">* 3ed0382 - remote5 (54 秒钟前) &lt;another king&gt;</span><br><span class="line">* 1dce6c2 - remote4 (54 秒钟前) &lt;another king&gt;</span><br><span class="line">* f726941 - remote3 (54 秒钟前) &lt;another king&gt;</span><br><span class="line">* 13b51a6 - remote2 (54 秒钟前) &lt;another king&gt;</span><br><span class="line">* 949d038 - remote1 (54 秒钟前) &lt;another king&gt;</span><br><span class="line">* 4245282 - commit9 (60 秒钟前) &lt;King&gt;</span><br><span class="line">* 6713be4 - commit8 (60 秒钟前) &lt;King&gt;</span><br><span class="line">* d5c11c8 - commit7 (60 秒钟前) &lt;King&gt;</span><br><span class="line">* 3e07d30 - commit6 (60 秒钟前) &lt;King&gt;</span><br><span class="line">* 7265b3d - commit5 (60 秒钟前) &lt;King&gt;</span><br><span class="line">* 0deb807 - commit4 (60 秒钟前) &lt;King&gt;</span><br><span class="line">* 9b232a4 - commit3 (60 秒钟前) &lt;King&gt;</span><br><span class="line">* bfd3ad1 - commit2 (60 秒钟前) &lt;King&gt;</span><br><span class="line">* 108010e - commit1 (60 秒钟前) &lt;King&gt;</span><br></pre></td></tr></table></figure></p>
<p>原理很简单</p>
<blockquote>
<p>–rebase,这里表示把你的本地当前分支里的每个提交(commit)取消掉，并且把它们临时 保存为补丁(patch)(这些补丁放到”.git/rebase”目录中),然后把本地当前分支更新 为最新的”origin”分支，最后把保存的这些补丁应用到本地当前分支上。</p>
</blockquote>
<p>参考<a href="http://blog.csdn.net/hudashi/article/details/7664631/" target="_blank" rel="noopener">http://blog.csdn.net/hudashi/article/details/7664631/</a></p>
<h1 id="开发分支合并"><a href="#开发分支合并" class="headerlink" title="开发分支合并"></a>开发分支合并</h1><p>大部分情况下，不会直接基于master分支，而是自己拉一个分支下来，然后commit，最后创建一个pull request。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp/git/work</span><br><span class="line">git init .</span><br><span class="line"><span class="keyword">for</span> ((i=1;i&lt;10;i++));<span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt; a;git add .;git commit -m commit<span class="variable">$i</span>;<span class="keyword">done</span>;</span><br><span class="line">git remote add origin /tmp/git/origin/</span><br><span class="line"><span class="built_in">cd</span> ../origin</span><br><span class="line">git init --bare</span><br><span class="line"><span class="built_in">cd</span> -</span><br><span class="line">git push origin master</span><br><span class="line"><span class="built_in">cd</span> ../work1</span><br><span class="line">git <span class="built_in">clone</span> /tmp/git/origin/ .</span><br></pre></td></tr></table></figure>
<p>到目前为止，work和work1共享了origin仓库</p>
<p>接下来让别人push一些修改到master，自己<strong>开个新分支</strong>也做了一些commit。最后切回master，并且拉取别人提交到master的commit<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp/git/work</span><br><span class="line">git checkout -b tmp</span><br><span class="line"><span class="keyword">for</span> ((i=1;i&lt;10;i++));<span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt; b;git add .;git commit -m <span class="built_in">local</span><span class="variable">$i</span>;<span class="keyword">done</span>;</span><br><span class="line"><span class="built_in">cd</span> ../work1</span><br><span class="line">git config user.name <span class="string">"another king"</span></span><br><span class="line"><span class="keyword">for</span> ((i=1;i&lt;10;i++));<span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt; c;git add .;git commit -m remote<span class="variable">$i</span>;<span class="keyword">done</span>;</span><br><span class="line">git push origin master</span><br><span class="line"><span class="built_in">cd</span> -</span><br><span class="line">git checkout master</span><br><span class="line">git pull origin master</span><br></pre></td></tr></table></figure></p>
<p>一般情况是直接git merge master将别人的commit合并到临时分支<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git checkout tmp</span><br><span class="line">git merge master</span><br></pre></td></tr></table></figure></p>
<p>和之前的直接pull一样，别人的提交穿插在自己的commit中间<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">*   36d5aa7 - (HEAD -&gt; tmp) Merge branch <span class="string">'master'</span> into tmp (29 秒钟前) &lt;King&gt;</span><br><span class="line">|\  </span><br><span class="line">| * f5c0dc8 - (origin/master, master) remote9 (2 分钟前) &lt;another king&gt;</span><br><span class="line">| * 45ec76f - remote8 (2 分钟前) &lt;another king&gt;</span><br><span class="line">| * 095dc1b - remote7 (2 分钟前) &lt;another king&gt;</span><br><span class="line">| * 7999947 - remote6 (2 分钟前) &lt;another king&gt;</span><br><span class="line">| * 889f88c - remote5 (2 分钟前) &lt;another king&gt;</span><br><span class="line">| * 303ab0c - remote4 (2 分钟前) &lt;another king&gt;</span><br><span class="line">| * cff4cb8 - remote3 (2 分钟前) &lt;another king&gt;</span><br><span class="line">| * c4995a0 - remote2 (2 分钟前) &lt;another king&gt;</span><br><span class="line">| * 56bf566 - remote1 (2 分钟前) &lt;another king&gt;</span><br><span class="line">* | 589f098 - local9 (2 分钟前) &lt;King&gt;</span><br><span class="line">* | e575680 - local8 (2 分钟前) &lt;King&gt;</span><br><span class="line">* | 2a14876 - local7 (2 分钟前) &lt;King&gt;</span><br><span class="line">* | fa8458b - local6 (2 分钟前) &lt;King&gt;</span><br><span class="line">* | a4f6c50 - local5 (2 分钟前) &lt;King&gt;</span><br><span class="line">* | 6118659 - local4 (2 分钟前) &lt;King&gt;</span><br><span class="line">* | b2bfba8 - local3 (2 分钟前) &lt;King&gt;</span><br><span class="line">* | 0f422b5 - local2 (2 分钟前) &lt;King&gt;</span><br><span class="line">* | 3be57eb - local1 (2 分钟前) &lt;King&gt;</span><br><span class="line">|/  </span><br><span class="line">* 491590d - commit9 (3 分钟前) &lt;King&gt;</span><br><span class="line">* 918800c - commit8 (3 分钟前) &lt;King&gt;</span><br><span class="line">* 0dfe536 - commit7 (3 分钟前) &lt;King&gt;</span><br><span class="line">* 17521f8 - commit6 (3 分钟前) &lt;King&gt;</span><br><span class="line">* 9db0b79 - commit5 (3 分钟前) &lt;King&gt;</span><br><span class="line">* 58cbf4e - commit4 (3 分钟前) &lt;King&gt;</span><br><span class="line">* 1c4abaa - commit3 (3 分钟前) &lt;King&gt;</span><br><span class="line">* b973520 - commit2 (3 分钟前) &lt;King&gt;</span><br><span class="line">* 9718254 - commit1 (3 分钟前) &lt;King&gt;</span><br></pre></td></tr></table></figure></p>
<p>利用rebase，同样可以做的很<strong>干净</strong><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:/tmp/git/work$ git checkout  tmp </span><br><span class="line">切换到分支 <span class="string">'tmp'</span></span><br><span class="line">king@king:/tmp/git/work$ git rebase master </span><br><span class="line">首先，回退分支以便在上面重放您的工作...</span><br><span class="line">应用：local1</span><br><span class="line">应用：local2</span><br><span class="line">应用：local3</span><br><span class="line">应用：local4</span><br><span class="line">应用：local5</span><br><span class="line">应用：local6</span><br><span class="line">应用：local7</span><br><span class="line">应用：local8</span><br><span class="line">应用：local9</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/04/17/git-rebase/" data-id="ckdbgbyvv001c43powccgq9rq" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/04/17/git-rebase/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/git/">git</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-docker-build-gcc1" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/13/docker-build-gcc1/">用docker构建c编译环境2</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/04/13/docker-build-gcc1/" class="article-date"><time datetime="2017-04-13T01:32:17.000Z" itemprop="datePublished">2017-04-13</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/开发环境/">开发环境</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>可以编译了，最终需要运行，而且很有必要编译和运行是同一个环境</p>
<p>下面以一个libevent程序来说明问题</p>
<p>main.c<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _EVENT_HAVE_SYS_TIME_H  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/event.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/event_struct.h&gt;  </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/util.h&gt;  </span></span></span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">lasttime</span>;</span>  </span><br><span class="line"><span class="keyword">int</span> event_is_persistent;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">timeout_cb</span><span class="params">(<span class="keyword">evutil_socket_t</span> fd, short event, <span class="keyword">void</span> *arg)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"timeout\n"</span>);</span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event</span> <span class="title">timeout</span>;</span>       <span class="comment">//创建事件  </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span>;</span>    <span class="comment">//创建事件"总管"的指针  </span></span><br><span class="line">    <span class="keyword">int</span> flags;                      </span><br><span class="line">    <span class="comment">//事件标志,超时事件可不设EV_TIMEOUT,因为在添加事件时可设置  </span></span><br><span class="line">  </span><br><span class="line">    event_is_persistent = <span class="number">1</span>;  </span><br><span class="line">    flags = EV_PERSIST;  </span><br><span class="line">    <span class="comment">/* Initalize the event library */</span>  </span><br><span class="line">    base = event_base_new();            <span class="comment">//创建事件"总管"  </span></span><br><span class="line">    <span class="comment">/* Initalize one event */</span>  </span><br><span class="line">    event_assign(&amp;timeout, base, <span class="number">-1</span>, flags, timeout_cb, (<span class="keyword">void</span>*) &amp;timeout);  </span><br><span class="line">    evutil_timerclear(&amp;tv);  </span><br><span class="line">    tv.tv_sec = <span class="number">1</span>;  </span><br><span class="line">    event_add(&amp;timeout, &amp;tv);       <span class="comment">//添加事件,同时设置超时时间  </span></span><br><span class="line">    evutil_gettimeofday(&amp;lasttime, <span class="literal">NULL</span>);  </span><br><span class="line">    event_base_dispatch(base);      <span class="comment">//循环监视事件,事件标志的条件发生,就调用回调函数  </span></span><br><span class="line">    <span class="keyword">return</span> (<span class="number">0</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Dockerfile<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM king_release:0.1</span><br><span class="line"></span><br><span class="line">MAINTAINER qiujinwu@gmail.com</span><br><span class="line"></span><br><span class="line">RUN mkdir -p /app</span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line">COPY sources.list /etc/apt</span><br><span class="line">COPY run.sh /</span><br><span class="line"></span><br><span class="line">RUN apt-get update \</span><br><span class="line">	&amp;&amp; apt-get install build-essential -y \</span><br><span class="line">	&amp;&amp; apt-get install gdb -y \</span><br><span class="line">	&amp;&amp; apt-get install libevent-dev -y \</span><br><span class="line">	&amp;&amp; apt-get clean -y \</span><br><span class="line">	&amp;&amp; apt-get autoclean</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;/run.sh&quot;]</span><br></pre></td></tr></table></figure></p>
<p>Dockerfile2<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM ubuntu:16.04</span><br><span class="line"></span><br><span class="line">MAINTAINER qiujinwu@gmail.com</span><br><span class="line"></span><br><span class="line">COPY sources.list /etc/apt</span><br><span class="line"></span><br><span class="line">RUN apt-get update \</span><br><span class="line">	&amp;&amp; apt-get install libevent-2.0-5 -y \</span><br><span class="line">	&amp;&amp; apt-get clean -y \</span><br><span class="line">	&amp;&amp; apt-get autoclean</span><br></pre></td></tr></table></figure></p>
<p>Dockerfile3<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM king_release:0.1</span><br><span class="line">MAINTAINER qiujinwu@gmail.com</span><br><span class="line">ADD a.out /</span><br><span class="line">CMD [&quot;/a.out&quot;]</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 编译运行时基础镜像</span></span><br><span class="line">docker build -f <span class="variable">$PWD</span>/Dockerfile2 -t king_release:0.1 ~/tmp/dockerfile/</span><br><span class="line"><span class="comment"># 编译 打包编译服务镜像</span></span><br><span class="line">docker build -t king_build:0.1 ~/tmp/dockerfile/</span><br><span class="line"><span class="comment"># 编译程序</span></span><br><span class="line">./b.sh + main.c -levent</span><br><span class="line"><span class="comment"># 编译最终运行的镜像</span></span><br><span class="line">docker build -f <span class="variable">$PWD</span>/Dockerfile3 -t a.out:0.1 ~/tmp/dockerfile/</span><br></pre></td></tr></table></figure>
<p>编译后如下<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">king@king:~/tmp/dockerfile$ docker images</span><br><span class="line">REPOSITORY      TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">a.out           0.1                 bd79dd4a7add        2 minutes ago       172 MB</span><br><span class="line">king_build      0.1                 e0d3c8b3e691        23 minutes ago      479 MB</span><br><span class="line">king_release    0.1                 cc28cd7564c0        33 minutes ago      172 MB</span><br></pre></td></tr></table></figure></p>
<p>运行程序<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/tmp/dockerfile$ docker run -it --rm a.out:0.1</span><br><span class="line">timeout</span><br><span class="line">timeout</span><br><span class="line">timeout</span><br><span class="line">timeout</span><br></pre></td></tr></table></figure></p>
<p>停止容器和删除镜像，<em>无需删除容器</em><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 停止镜像</span></span><br><span class="line">docker ps | grep a.out | awk <span class="string">'&#123;print $1&#125;'</span> | xargs -i docker stop &#123;&#125;</span><br><span class="line"><span class="comment"># 删除镜像</span></span><br><span class="line">docker images | grep a.out | awk <span class="string">'&#123;print $3&#125;'</span> | xargs -i docker rmi &#123;&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="裁剪"><a href="#裁剪" class="headerlink" title="裁剪"></a>裁剪</h1><p>上面的运行时还有100多M，还是挺大的，利用静态编译可以压缩到更小。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">king@king:~/tmp/dockerfile$ ./b.sh + main.c -levent</span><br><span class="line">king@king:~/tmp/dockerfile$ ./b.sh + main.c -levent -static -o b.out</span><br><span class="line">king@king:~/tmp/dockerfile$ ll</span><br><span class="line">总用量 1148</span><br><span class="line">-rwxr-xr-x  1 root root    9024 4月  13 09:48 a.out*</span><br><span class="line">-rwxr-xr-x  1 root root 1112800 4月  13 09:49 b.out*</span><br></pre></td></tr></table></figure></p>
<p>可以看到，静态连接的可执行程序大了非常多，但是他没有那些系统库/三方库的依赖，所以可以很方便的使用精简版的docker来运行</p>
<p>Dockerfile4<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM scratch</span><br><span class="line">ADD b.out /</span><br><span class="line">CMD [&quot;/b.out&quot;]</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -f <span class="variable">$PWD</span>/Dockerfile4 -t b.out:0.1 ~/tmp/dockerfile/</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/tmp/dockerfile$ docker images</span><br><span class="line">REPOSITORY      TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">b.out           0.1                 1176fc755f3d        2 minutes ago       1.11 MB</span><br><span class="line">a.out           0.1                 bd79dd4a7add        32 minutes ago      172 MB</span><br><span class="line">king_build      0.1                 e0d3c8b3e691        53 minutes ago      479 MB</span><br><span class="line">king_release    0.1                 cc28cd7564c0        About an hour ago   172 MB</span><br></pre></td></tr></table></figure>
<p>可以看到打出来的docker镜像非常非常小</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/tmp/dockerfile$ docker run -it --rm b.out:0.1</span><br><span class="line">timeout</span><br><span class="line">timeout</span><br><span class="line">timeout</span><br><span class="line">timeout</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(venv) king@king:~/tmp/dockerfile$ ldd a.out </span><br><span class="line">	linux-vdso.so.1 =&gt;  (0x00007ffdd8157000)</span><br><span class="line">	libevent-2.0.so.5 =&gt; /usr/lib/x86_64-linux-gnu/libevent-2.0.so.5 (0x00007f85e9e7d000)</span><br><span class="line">	libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f85e9ab4000)</span><br><span class="line">	libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f85e9896000)</span><br><span class="line">	/lib64/ld-linux-x86-64.so.2 (0x000055b917112000)</span><br><span class="line">(venv) king@king:~/tmp/dockerfile$ ldd b.out </span><br><span class="line">	不是动态可执行文件</span><br><span class="line">(venv) king@king:~/tmp/dockerfile$ file b.out </span><br><span class="line">b.out: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, </span><br><span class="line"><span class="keyword">for</span> GNU/Linux 2.6.32, BuildID[sha1]=eb066746936748bf4438aa6473cfcd101759dd95, not stripped</span><br></pre></td></tr></table></figure>
<h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><ol>
<li>部分设备只安装了动态库，没有匹配的静态库，导致静态编译失败</li>
<li>静态编译时存在一个顺序问题，如果在链接时，并未发现引用就不会链接任何符号，而右边的对象如果又依赖这些库，就会出现链接失败，如下</li>
</ol>
<p>还是上面的代码main.c<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/tmp/a$ gcc main.c -c</span><br><span class="line">king@king:~/tmp/a$ gcc -levent -static main.o</span><br><span class="line">main.o：在函数‘main’中：</span><br><span class="line">main.c:(.text+0x5e)：对‘event_base_new’未定义的引用</span><br><span class="line">main.c:(.text+0x9b)：对‘event_assign’未定义的引用</span><br><span class="line">main.c:(.text+0xd8)：对‘event_add’未定义的引用</span><br><span class="line">main.c:(.text+0xf6)：对‘event_base_dispatch’未定义的引用</span><br><span class="line">collect2: error: ld returned 1 <span class="built_in">exit</span> status</span><br><span class="line">king@king:~/tmp/a$ gcc main.o -levent -static</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/04/13/docker-build-gcc1/" data-id="ckdbgbyvk000n43poq8tn1p1x" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/04/13/docker-build-gcc1/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-docker-build-gcc" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/12/docker-build-gcc/">用docker构建c编译环境</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/04/12/docker-build-gcc/" class="article-date"><time datetime="2017-04-12T14:45:32.000Z" itemprop="datePublished">2017-04-12</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/开发环境/">开发环境</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/tmp/dockerfile$ </span><br><span class="line">FROM ubuntu:16.04</span><br><span class="line"></span><br><span class="line">MAINTAINER qiujinwu@gmail.com</span><br><span class="line"></span><br><span class="line">RUN mkdir -p /app</span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line">COPY sources.list /etc/apt</span><br><span class="line">COPY run.sh /</span><br><span class="line"></span><br><span class="line">RUN apt-get update \</span><br><span class="line">	&amp;&amp; apt-get install build-essential -y \</span><br><span class="line">	&amp;&amp; apt-get install gdb -y \</span><br><span class="line">	&amp;&amp; apt-get clean -y \</span><br><span class="line">	&amp;&amp; apt-get autoclean</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [<span class="string">"/run.sh"</span>]</span><br></pre></td></tr></table></figure>
<h1 id="Docker-入口脚本"><a href="#Docker-入口脚本" class="headerlink" title="Docker 入口脚本"></a>Docker 入口脚本</h1><p>用于支持gcc/g++/make命令，也可以直接进入shell<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#for arg in "$@"</span></span><br><span class="line"><span class="comment">#do</span></span><br><span class="line"><span class="comment">#	echo "arg: $&#123;arg&#125;"</span></span><br><span class="line"><span class="comment">#done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">declare</span> -r g_red=<span class="string">"\e[0;31;44m"</span></span><br><span class="line"><span class="built_in">declare</span> -r g_green=<span class="string">"\e[0;32m"</span></span><br><span class="line"><span class="built_in">declare</span> -r g_blue=<span class="string">"\e[0;34m"</span></span><br><span class="line"><span class="built_in">declare</span> -r g_end=<span class="string">"\e[0m"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">_err</span></span>()&#123;</span><br><span class="line">	<span class="built_in">echo</span> -e <span class="string">"<span class="variable">$&#123;g_red&#125;</span><span class="variable">$&#123;@&#125;</span><span class="variable">$&#123;g_end&#125;</span>"</span></span><br><span class="line">	<span class="built_in">return</span> 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">do_make</span></span>()&#123;</span><br><span class="line">	make <span class="string">"<span class="variable">$&#123;@&#125;</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">do_gcc</span></span>()&#123;</span><br><span class="line">	gcc <span class="string">"<span class="variable">$&#123;@&#125;</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">do_gplus</span></span>()&#123;</span><br><span class="line">	g++ <span class="string">"<span class="variable">$&#123;@&#125;</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;#&#125;</span>"</span> -lt 1 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	/bin/bash</span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">"<span class="variable">$&#123;1&#125;</span>"</span> == <span class="string">"make"</span> -o <span class="string">"<span class="variable">$&#123;1&#125;</span>"</span> == <span class="string">"m"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">shift</span> 1</span><br><span class="line">	do_make <span class="string">"<span class="variable">$&#123;@&#125;</span>"</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">"<span class="variable">$&#123;1&#125;</span>"</span> == <span class="string">"gcc"</span> -o <span class="string">"<span class="variable">$&#123;1&#125;</span>"</span> == <span class="string">"g"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">shift</span> 1</span><br><span class="line">	do_gcc <span class="string">"<span class="variable">$&#123;@&#125;</span>"</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">"<span class="variable">$&#123;1&#125;</span>"</span> == <span class="string">"g++"</span> -o <span class="string">"<span class="variable">$&#123;1&#125;</span>"</span> == <span class="string">"+"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">shift</span> 1</span><br><span class="line">	do_gplus <span class="string">"<span class="variable">$&#123;@&#125;</span>"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	_err <span class="string">"unsupport command"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p>
<h1 id="apt源"><a href="#apt源" class="headerlink" title="apt源"></a>apt源</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/tmp/dockerfile$ cat sources.list </span><br><span class="line"></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial main restricted</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial universe</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates universe</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security universe</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security multiverse</span><br></pre></td></tr></table></figure>
<h1 id="编译和测试"><a href="#编译和测试" class="headerlink" title="编译和测试"></a>编译和测试</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#/bin/bash</span></span><br><span class="line"><span class="comment"># 编译镜像</span></span><br><span class="line">docker build -t king:0.1 ~/tmp/dockerfile/</span><br><span class="line"><span class="comment"># 检查是否创建成功</span></span><br><span class="line">docker images | grep king</span><br><span class="line"><span class="comment"># 运行</span></span><br><span class="line">docker run -it --rm -v <span class="string">"<span class="variable">$PWD</span>"</span>:/app  king:0.1 gcc main.c -v</span><br></pre></td></tr></table></figure>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">docker run -it --rm -v <span class="string">"<span class="variable">$PWD</span>"</span>:/app  king:0.1 <span class="string">"<span class="variable">$&#123;@&#125;</span>"</span></span><br></pre></td></tr></table></figure>
<p>运行,<strong>必须在当前目录运行</strong><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/tmp/dockerfile$ ./b.sh g main.c </span><br><span class="line">king@king:~/tmp/dockerfile$ ./b.sh g main.c -g2</span><br><span class="line">king@king:~/tmp/dockerfile$ ./b.sh </span><br><span class="line">root@c780882cbd3f:/app<span class="comment"># gdb a.out </span></span><br><span class="line">GNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1</span><br><span class="line">Copyright (C) 2016 Free Software Foundation, Inc.</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/04/12/docker-build-gcc/" data-id="ckdbgbyvj000j43pory6dddbp" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/04/12/docker-build-gcc/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-ssh-interactive-job" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/10/ssh-interactive-job/">SSH远程自动执行交互任务</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/04/10/ssh-interactive-job/" class="article-date"><time datetime="2017-04-10T03:56:41.000Z" itemprop="datePublished">2017-04-10</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/开发环境/">开发环境</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>ssh远程到其他主机是比较安全和方便的办法，例如[<strong>ssh <a href="mailto:king@1.2.3.4" target="_blank" rel="noopener">king@1.2.3.4</a></strong>]，若要自动执行某些命令（并立即返回结果，退出ssh），可以[<strong>ssh <a href="mailto:king@1.2.3.4" target="_blank" rel="noopener">king@1.2.3.4</a> ls</strong>]</p>
<p>若要执行一些交互式的任务，比方登录一个mysql客户端，并且需要持续的使用（而不是简单地做个sql查询），那么上面的办法就不行了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">ssh -t kingqiu@1.2.3.4 <span class="string">"mysql -h192.168.0.1 -uuser -ppassword --default-character-set=utf8mb4 test"</span></span><br></pre></td></tr></table></figure>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ol>
<li><a href="https://superuser.com/questions/646196/ssh-and-execute-interactive-command" target="_blank" rel="noopener">https://superuser.com/questions/646196/ssh-and-execute-interactive-command</a></li>
</ol>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/04/10/ssh-interactive-job/" data-id="ckdbgbyxw005d43pojpld7677" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/04/10/ssh-interactive-job/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssh/">ssh</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-python-ws" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/16/python-ws/">Flask 处理websocket</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/03/16/python-ws/" class="article-date"><time datetime="2017-03-16T11:51:19.000Z" itemprop="datePublished">2017-03-16</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/后端/">后端</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>最近要用flask弄一个websocket服务，由于ws的特殊性，若用正常的flask写法，就会<strong>阻塞</strong>当前线程，生产环境一般用<a href="http://gunicorn.org/" target="_blank" rel="noopener">Gunicorn</a>，没有测试过有无作异步处理，但是若用flask内置的容器，就会出问题。</p>
<p>之前学习Golang的时候，了解到<a href="https://github.com/gorilla/websocket" target="_blank" rel="noopener">gorilla/websocket</a>这个工程。在Go里面写ws逻辑很简单，直接在回调里面一个for循环就好，因为go运行时在底层会自动将goruntime的请求异步化，也就是用同步的代码写异步请求，而不是nodejs的那种回调满天飞的代码，很是赏心悦目。</p>
<p>Flask运行需要一个<a href="http://docs.jinkan.org/docs/flask/deploying/wsgi-standalone.html" target="_blank" rel="noopener">WSGI 容器</a>来提供服务，flask就内置了wsgi容器，不过性能一般，供测试足够了。</p>
<p>一些生产环境下的容器如</p>
<ol>
<li><a href="http://gunicorn.org/" target="_blank" rel="noopener">Gunicorn</a></li>
<li><a href="http://www.tornadoweb.org/en/stable/" target="_blank" rel="noopener">Tornado</a></li>
<li><a href="http://www.gevent.org/" target="_blank" rel="noopener">Gevent</a></li>
</ol>
<p>不同的容器使用的服务器模型不一样，比如</p>
<ol>
<li>多进程模型，来一请求就开一进程</li>
<li>多线程模型，来一请求就开一线程</li>
<li>进程池或者线程池，若池为空就排队，进程调度通常又通过外部的调度程序，例如nginx，或者直接用操作系统来调度（父进程bind，然后fork），多线程调度通常用一个队列来分配任务，或者利用操作系统来调度</li>
<li>两者混合使用，有多个进程的池，每个进程有一个线程池</li>
</ol>
<p>在大部分情况下，如果一个任务（请求）阻塞特别长时间，可能导致整个线程不可用，进而导致拒绝服务。在大部分<strong>阻塞特别长</strong>的情况下，后台只是简单地等待IO，这种情况下可以用全异步实现最大的并发。</p>
<p>写个例子<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    time.sleep(<span class="number">1000</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello, World!'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/a')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'a'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">"0.0.0.0"</span>,port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure></p>
<p>直接用python运行【python main.py】,访问<a href="http://127.0.0.1:5000/a" target="_blank" rel="noopener">http://127.0.0.1:5000/a</a>成功，访问<a href="http://127.0.0.1:5000/" target="_blank" rel="noopener">http://127.0.0.1:5000/</a>在那等待，再访问<a href="http://127.0.0.1:5000/a" target="_blank" rel="noopener">http://127.0.0.1:5000/a</a>也一并卡住了，这里可能只有一个线程在提供服务，而且sleep把这个线程阻塞掉了</p>
<p>换个容器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line">monkey.patch_all()</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> wsgi</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></span><br><span class="line">    time.sleep(<span class="number">1000</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello, World!'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/a')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'a'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    server = wsgi.WSGIServer((<span class="string">'0.0.0.0'</span>, <span class="number">5000</span>), app)</span><br><span class="line">    server.serve_forever()</span><br></pre></td></tr></table></figure>
<p>写个脚本，运行100个wget去请求<a href="http://127.0.0.1:5000/" target="_blank" rel="noopener">http://127.0.0.1:5000/</a>，然后再访问<a href="http://127.0.0.1:5000/a" target="_blank" rel="noopener">http://127.0.0.1:5000/a</a>，结果<strong>成功</strong>。<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">for</span> ((i=0;i&lt;100;i++));<span class="keyword">do</span> </span><br><span class="line">	(</span><br><span class="line">	wget http://127.0.0.1:5000 </span><br><span class="line">	)&amp;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/03/16/python-ws/" data-id="ckdbgbyxi004q43poiihsn2v1" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/03/16/python-ws/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-sentry" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/10/sentry/">Sentry</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/03/10/sentry/" class="article-date"><time datetime="2017-03-10T01:43:34.000Z" itemprop="datePublished">2017-03-10</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/开发环境/">开发环境</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="安装Sentry"><a href="#安装Sentry" class="headerlink" title="安装Sentry"></a>安装Sentry</h1><p>推荐用docker来安装，参考<strong><a href="https://hub.docker.com/_/sentry/" target="_blank" rel="noopener">https://hub.docker.com/_/sentry/</a></strong><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull sentry</span><br><span class="line">docker pull redis</span><br><span class="line">docker pull postgres</span><br></pre></td></tr></table></figure></p>
<p>运行redis<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d --name sentry-redis redis</span><br></pre></td></tr></table></figure></p>
<p>运行progress<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -d --name sentry-postgres -e POSTGRES_PASSWORD=secret -e POSTGRES_USER=sentry postgres</span><br></pre></td></tr></table></figure></p>
<p>使用sentry命令行生成一个密钥，用于在sentry容器之间授权<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~$ docker run --rm sentry config generate-secret-key</span><br><span class="line"><span class="built_in">fc</span>=k^xur0()hb7cqi81z@&amp;b!d9cy6l_-j<span class="comment">#&amp;36)kk28u^%ldx*l</span></span><br></pre></td></tr></table></figure></p>
<p>如果数据库是第一次使用（新的），用下面的命令创建表结构（初始化）<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -it --rm -e SENTRY_SECRET_KEY=<span class="string">'&lt;secret-key&gt;'</span> \</span><br><span class="line">	--link sentry-postgres:postgres --link sentry-redis:redis sentry upgrade</span><br></pre></td></tr></table></figure></p>
<p>在这个过程中会提示创建用户<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Would you like to create a user account now? [Y/n]: Y</span><br><span class="line">Email: email@gmail.com</span><br><span class="line">Password:</span><br><span class="line">Repeat <span class="keyword">for</span> confirmation: </span><br><span class="line">Should this user be a superuser? [y/N]: Y</span><br><span class="line">User created: email@gmail.com</span><br></pre></td></tr></table></figure></p>
<p>运行服务器（Web）</p>
<p>注意<strong>-p 8080:9000</strong><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d --name my-sentry -e SENTRY_SECRET_KEY=<span class="string">'&lt;secret-key&gt;'</span> \</span><br><span class="line">	-p 8080:9000 \</span><br><span class="line">	--link sentry-redis:redis --link sentry-postgres:postgres sentry</span><br></pre></td></tr></table></figure></p>
<p>sentry还需要 celery beat 和 celery workers干活，所以再启动两个容器<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d --name sentry-cron -e SENTRY_SECRET_KEY=<span class="string">'&lt;secret-key&gt;'</span> \</span><br><span class="line">	--link sentry-postgres:postgres --link sentry-redis:redis sentry run cron</span><br><span class="line">docker run -d --name sentry-worker-1 -e SENTRY_SECRET_KEY=<span class="string">'&lt;secret-key&gt;'</span>  \</span><br><span class="line">	--link sentry-postgres:postgres --link sentry-redis:redis sentry run worker</span><br></pre></td></tr></table></figure></p>
<h1 id="Go-Client"><a href="#Go-Client" class="headerlink" title="Go Client"></a>Go Client</h1><p>sentry client for go <strong><a href="https://docs.sentry.io/clients/go/" target="_blank" rel="noopener">https://docs.sentry.io/clients/go/</a></strong>，只需要简单的封裝就可以适配gin<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/getsentry/raven-go"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"github.com/gin-gonic/gin"</span></span><br><span class="line">	<span class="string">"runtime/debug"</span></span><br><span class="line">	<span class="string">"errors"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Middleware</span><span class="params">(dsn <span class="keyword">string</span>)</span> <span class="title">gin</span>.<span class="title">HandlerFunc</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> dsn == <span class="string">""</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">"Error: No DSN detected!\n"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	raven.SetDSN(dsn)</span><br><span class="line">	<span class="keyword">var</span> client = raven.DefaultClient</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"></span><br><span class="line">				flags := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">					<span class="string">"endpoint"</span>: c.Request.RequestURI,</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				debug.PrintStack()</span><br><span class="line">				rvalStr := fmt.Sprint(err)</span><br><span class="line">				packet := raven.NewPacket(rvalStr, raven.NewException(</span><br><span class="line">					errors.New(rvalStr),</span><br><span class="line">					raven.NewStacktrace(<span class="number">2</span>, <span class="number">3</span>, <span class="literal">nil</span>)),</span><br><span class="line">				)</span><br><span class="line">				client.Capture(packet, flags)</span><br><span class="line">				c.Writer.WriteHeader(http.StatusInternalServerError)</span><br><span class="line"></span><br><span class="line">				<span class="comment">//const size = 1 &lt;&lt; 12</span></span><br><span class="line">				<span class="comment">//buf := make([]byte, size)</span></span><br><span class="line">				<span class="comment">//n := runtime.Stack(buf, false)</span></span><br><span class="line">				<span class="comment">//client.CaptureMessage(fmt.Sprintf("%v\nStacktrace:\n%s", err, buf[:n]),nil)</span></span><br><span class="line">				<span class="comment">//c.Writer.WriteHeader(http.StatusInternalServerError)</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;()</span><br><span class="line">		c.Next()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>参考</p>
<ol>
<li><a href="https://github.com/dz0ny/martini-sentry" target="_blank" rel="noopener">https://github.com/dz0ny/martini-sentry</a></li>
<li><a href="https://github.com/gin-gonic/gin-sentry" target="_blank" rel="noopener">https://github.com/gin-gonic/gin-sentry</a></li>
</ol>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/gin-gonic/gin"</span></span><br><span class="line">	<span class="string">"github.com/getsentry/raven-go"</span></span><br><span class="line">	<span class="string">"errors"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line"></span><br><span class="line">	r.Use(Middleware(<span class="string">"http://5138362834d22ecbd@localhost:8080/2"</span>))</span><br><span class="line">	<span class="comment">// r.Use(gin.Recovery())</span></span><br><span class="line"></span><br><span class="line">	r.GET(<span class="string">"/ping"</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		raven.CaptureErrorAndWait(errors.New(<span class="string">"this is a string error"</span>), <span class="literal">nil</span>)</span><br><span class="line">		<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"this is a panic"</span>))</span><br><span class="line">		c.JSON(<span class="number">200</span>, gin.H&#123;</span><br><span class="line">			<span class="string">"message"</span>: <span class="string">"pong"</span>,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line">	r.Run(<span class="string">":12345"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Python-client"><a href="#Python-client" class="headerlink" title="Python client"></a>Python client</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> raven.contrib.flask <span class="keyword">import</span> Sentry</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, redirect, url_for, escape, request</span><br><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Manager</span><br><span class="line"></span><br><span class="line">sentry = Sentry()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span><span class="params">()</span>:</span></span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    sentry.init_app(app, dsn=<span class="string">'http://5138362834d22ecbd@localhost:8080/2'</span>)</span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line">app = create_app()</span><br><span class="line">sentry.captureMessage(<span class="string">'hello, world!.shit'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="Pip修改默认源"><a href="#Pip修改默认源" class="headerlink" title="Pip修改默认源"></a>Pip修改默认源</h2><p>Pip默认的源速度很慢，而且时而访问不了，可以修改到国内的源<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install -i http://pypi.douban.com/simple/ \</span><br><span class="line">    --trusted-host pypi.douban.com itsdangerous</span><br></pre></td></tr></table></figure></p>
<p>其他比如<a href="http://mirrors.aliyun.com/pypi/simple/" target="_blank" rel="noopener">http://mirrors.aliyun.com/pypi/simple/</a></p>
<h3 id="设置全局默认"><a href="#设置全局默认" class="headerlink" title="设置全局默认"></a>设置全局默认</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@KingUbuntu64:~$ mkdir -p ~/.config/pip/</span><br><span class="line">king@KingUbuntu64:~$ vi ~/.config/pip/pip.conf</span><br></pre></td></tr></table></figure>
<p>如果是Windows，路径是【%APPDATA%\pip\pip.ini】<br><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[global]</span></span><br><span class="line"><span class="attr">timeout</span> = <span class="number">60</span></span><br><span class="line"><span class="attr">index-url</span> = http://pypi.douban.com/simple</span><br><span class="line"><span class="section">[install]</span></span><br><span class="line"><span class="attr">trusted-host</span>=pypi.douban.com</span><br></pre></td></tr></table></figure></p>
<h1 id="不用docker"><a href="#不用docker" class="headerlink" title="不用docker"></a>不用docker</h1><p>先准备redis，mysql或者postgres</p>
<h2 id="安装sentry"><a href="#安装sentry" class="headerlink" title="安装sentry"></a>安装sentry</h2><p>apt-get 安装的依赖可能有所差异</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt-get install libpq-dev libffi-dev python-mysqldb libmysqlclient-dev \</span><br><span class="line">	libssl-dev libjpeg9 libjpeg9-dev libpng16-16 libpng3 libpng16-dev</span><br><span class="line">pip install sentry pymysql MySQL-python</span><br></pre></td></tr></table></figure>
<h2 id="生成初始化配置"><a href="#生成初始化配置" class="headerlink" title="生成初始化配置"></a>生成初始化配置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(venv) king@kingqiu:~/proj$ sentry init .</span><br><span class="line">(venv) king@kingqiu:~/proj$ ls</span><br><span class="line">config.yml  sentry.conf.py</span><br></pre></td></tr></table></figure>
<h2 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h2><h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><p>默认是postgres<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'sentry.db.postgres'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'sentry'</span>,</span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'postgres'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'PORT'</span>: <span class="string">''</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>改成mysql，其中的【NAME】表示数据库名，需要事先新建该数据库<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        # You can swap out the engine for MySQL easily by changing this value</span><br><span class="line">        # to ``django.db.backends.mysql`` or to PostgreSQL with</span><br><span class="line">        # ``django.db.backends.postgresql_psycopg2``</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'sentry'</span>,</span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'username'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'password'</span>,</span><br><span class="line">        <span class="string">'PORT'</span>: <span class="string">'3306'</span>,</span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">'localhost'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># See https://docs.sentry.io/on-premise/server/queue/ for more</span></span><br><span class="line"><span class="comment"># information on configuring your queue broker and workers. Sentry relies</span></span><br><span class="line"><span class="comment"># on a Python framework called Celery to manage queues.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">BROKER_URL</span> = <span class="string">'redis://localhost:6379'</span></span><br></pre></td></tr></table></figure>
<h3 id="IP-端口"><a href="#IP-端口" class="headerlink" title="IP/端口"></a>IP/端口</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="attr">SENTRY_WEB_HOST</span> = <span class="string">'0.0.0.0'</span></span><br><span class="line"><span class="attr">SENTRY_WEB_PORT</span> = <span class="number">9000</span></span><br><span class="line"><span class="attr">SENTRY_WEB_OPTIONS</span> = &#123;</span><br><span class="line">    <span class="comment"># 'workers': 3,  # the number of web workers</span></span><br><span class="line">    <span class="comment"># 'protocol': 'uwsgi',  # Enable uwsgi protocol instead of http</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>创建表神马的，config后面的.表示路径，自行修改。</p>
<p>在这个过程中，可以一次性创建超级用户<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sentry --config=. upgrade</span><br></pre></td></tr></table></figure></p>
<h3 id="创建新用户"><a href="#创建新用户" class="headerlink" title="创建新用户"></a>创建新用户</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sentry --config=. createsuperuser</span><br><span class="line">sentry --config=. createuser</span><br></pre></td></tr></table></figure>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><h4 id="启动Web服务"><a href="#启动Web服务" class="headerlink" title="启动Web服务"></a>启动Web服务</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sentry --config=. start</span><br></pre></td></tr></table></figure>
<h4 id="启动Wokers"><a href="#启动Wokers" class="headerlink" title="启动Wokers"></a>启动Wokers</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sentry --config=. celery worker -B</span><br></pre></td></tr></table></figure>
<h1 id="使用OpenID登陆"><a href="#使用OpenID登陆" class="headerlink" title="使用OpenID登陆"></a>使用OpenID登陆</h1><p>在upgrade时，注册一个owner权限的用户，并且用此账户登陆</p>
<p>首次登陆会弹出<code>Welcome to Sentry</code>，其中<code>Root URL</code>会用作oauth回调路径，所以慎重填写</p>
<p>使用通用的OpenID登陆依赖一个<a href="https://github.com/TableflippersAnonymous/sentry-auth-openid" target="_blank" rel="noopener">sentry-auth-openid</a>插件。</p>
<p>直接安装的sentry，按照指引即可，若使用docker，可以先调试确认</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker run --rm -it --name my-sentry -e SENTRY_SECRET_KEY=<span class="string">'$KEY'</span> \</span><br><span class="line">	-p 9000:9000 \</span><br><span class="line">	--link sentry-redis:redis --link sentry-postgres:postgres sentry /bin/bash</span><br><span class="line"><span class="comment"># 安装插件</span></span><br><span class="line">pip install https://github.com/TableflippersAnonymous/sentry-auth-openid/archive/master.zip</span><br><span class="line"><span class="comment"># 安装vi以便编辑配置</span></span><br><span class="line">apt update &amp;&amp; apt install vim -y</span><br></pre></td></tr></table></figure>
<p>vi /etc/sentry/sentry.conf.py 添加以下内容<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">OPENID_AUTHORIZE_URL = <span class="string">"http://server:5556/dex/auth"</span></span><br><span class="line">OPENID_TOKEN_URL = <span class="string">"http://server:5556/dex/token"</span></span><br><span class="line">OPENID_CLIENT_ID = <span class="string">"example-app"</span></span><br><span class="line">OPENID_CLIENT_SECRET = <span class="string">"ZXhhbXBsZS1hcHAtc2VjcmV0"</span></span><br></pre></td></tr></table></figure></p>
<p>openid服务器，可以用<a href="https://github.com/coreos/dex" target="_blank" rel="noopener">https://github.com/coreos/dex</a> 测试用着</p>
<h2 id="启用"><a href="#启用" class="headerlink" title="启用"></a>启用</h2><p>登陆之后，左边菜单<code>MANAGE -&gt; Auth</code>，完整的URL <a href="http://localhost:9000/organizations/sentry/auth/" target="_blank" rel="noopener">http://localhost:9000/organizations/sentry/auth/</a></p>
<p>然后点击<code>OPENID</code> 按钮会跳转到oidc服务器进行验证，验证OK保存，下次就自动开启了openid登陆</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/03/10/sentry/" data-id="ckdbgbyxp005243po649wb6e2" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/03/10/sentry/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sentry/">sentry</a></li></ul>


    </footer>
  </div>
  
</article>



  


  <div id="page-nav">
    <nav><ul class="pagination"><li><a class="page-prev" rel="prev" href="/page/4/"><i class="fa fa-chevron-left"></i> Prev</a></li><li><a class="page-number" href="/">1</a></li><li class="disabled"><span class="page-space">&hellip;</span></li><li><a class="page-number" href="/page/3/">3</a></li><li><a class="page-number" href="/page/4/">4</a></li><li class="active"><span class="page-number">5</span></li><li><a class="page-number" href="/page/6/">6</a></li><li><a class="page-number" href="/page/7/">7</a></li><li><a class="page-next" rel="next" href="/page/6/">Next <i class="fa fa-chevron-right"></i></a></li></ul></nav>
  </div>



        </div>
        <div class="col-sm-2 col-sm-offset-1 blog-sidebar">
          
  
  <div class="sidebar-module">
    <h4>Categories</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Golang/">Golang</a><span class="sidebar-module-list-count">14</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Openldap/">Openldap</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Python/">Python</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/后端/">后端</a><span class="sidebar-module-list-count">11</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/学习笔记/">学习笔记</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/开发环境/">开发环境</a><span class="sidebar-module-list-count">13</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/源码学习/">源码学习</a><span class="sidebar-module-list-count">9</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/环境搭建/">环境搭建</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/运营运维/">运营运维</a><span class="sidebar-module-list-count">10</span><ul class="sidebar-module-list-child"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/运营运维/代理/">代理</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/运营运维/网站/">网站</a><span class="sidebar-module-list-count">1</span></li></ul></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tags</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ansible/">ansible</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/antd/">antd</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/cookie/">cookie</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/cors/">cors</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/crsf/">crsf</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/docker/">docker</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/drone/">drone</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/elasticsearch/">elasticsearch</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/flask/">flask</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/git/">git</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/github/">github</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/gitlab/">gitlab</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/golang/">golang</a><span class="sidebar-module-list-count">27</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/gorm/">gorm</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/grpc/">grpc</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/hexo/">hexo</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/influxdb/">influxdb</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/jsonp/">jsonp</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/jsonschema/">jsonschema</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/kibana/">kibana</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/martini/">martini</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/nginx/">nginx</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ngrok/">ngrok</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/node/">node</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/openldap/">openldap</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/pip/">pip</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/proxy/">proxy</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/python/">python</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/redis/">redis</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/sentry/">sentry</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/sqlalchemy/">sqlalchemy</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ssh/">ssh</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/sso/">sso</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/tars/">tars</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/tavern/">tavern</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/travis/">travis</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/uml/">uml</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/wcgi/">wcgi</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/xss/">xss</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/一致性hash/">一致性hash</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/持续集成/">持续集成</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/盗链/">盗链</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/签名/">签名</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/证书/">证书</a><span class="sidebar-module-list-count">2</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tag Cloud</h4>
    <p class="tagcloud">
      <a href="/tags/ansible/" style="font-size: 10px;">ansible</a> <a href="/tags/antd/" style="font-size: 10px;">antd</a> <a href="/tags/cookie/" style="font-size: 11.67px;">cookie</a> <a href="/tags/cors/" style="font-size: 10px;">cors</a> <a href="/tags/crsf/" style="font-size: 10px;">crsf</a> <a href="/tags/docker/" style="font-size: 13.33px;">docker</a> <a href="/tags/drone/" style="font-size: 16.67px;">drone</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/flask/" style="font-size: 11.67px;">flask</a> <a href="/tags/git/" style="font-size: 11.67px;">git</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/gitlab/" style="font-size: 11.67px;">gitlab</a> <a href="/tags/golang/" style="font-size: 20px;">golang</a> <a href="/tags/gorm/" style="font-size: 10px;">gorm</a> <a href="/tags/grpc/" style="font-size: 10px;">grpc</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/influxdb/" style="font-size: 10px;">influxdb</a> <a href="/tags/jsonp/" style="font-size: 10px;">jsonp</a> <a href="/tags/jsonschema/" style="font-size: 10px;">jsonschema</a> <a href="/tags/kibana/" style="font-size: 10px;">kibana</a> <a href="/tags/martini/" style="font-size: 10px;">martini</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/ngrok/" style="font-size: 11.67px;">ngrok</a> <a href="/tags/node/" style="font-size: 10px;">node</a> <a href="/tags/openldap/" style="font-size: 13.33px;">openldap</a> <a href="/tags/pip/" style="font-size: 10px;">pip</a> <a href="/tags/proxy/" style="font-size: 13.33px;">proxy</a> <a href="/tags/python/" style="font-size: 11.67px;">python</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/sentry/" style="font-size: 11.67px;">sentry</a> <a href="/tags/sqlalchemy/" style="font-size: 10px;">sqlalchemy</a> <a href="/tags/ssh/" style="font-size: 11.67px;">ssh</a> <a href="/tags/sso/" style="font-size: 10px;">sso</a> <a href="/tags/tars/" style="font-size: 10px;">tars</a> <a href="/tags/tavern/" style="font-size: 10px;">tavern</a> <a href="/tags/travis/" style="font-size: 10px;">travis</a> <a href="/tags/uml/" style="font-size: 10px;">uml</a> <a href="/tags/wcgi/" style="font-size: 10px;">wcgi</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/一致性hash/" style="font-size: 10px;">一致性hash</a> <a href="/tags/持续集成/" style="font-size: 18.33px;">持续集成</a> <a href="/tags/盗链/" style="font-size: 10px;">盗链</a> <a href="/tags/签名/" style="font-size: 11.67px;">签名</a> <a href="/tags/证书/" style="font-size: 11.67px;">证书</a>
    </p>
  </div>


  
  <div class="sidebar-module">
    <h4>Archives</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/08/">八月 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/06/">六月 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/03/">三月 2020</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/02/">二月 2020</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/01/">一月 2020</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/07/">七月 2018</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/06/">六月 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/05/">五月 2018</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/12/">十二月 2017</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/10/">十月 2017</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/08/">八月 2017</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/07/">七月 2017</a><span class="sidebar-module-list-count">8</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/06/">六月 2017</a><span class="sidebar-module-list-count">7</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/04/">四月 2017</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/03/">三月 2017</a><span class="sidebar-module-list-count">10</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/02/">二月 2017</a><span class="sidebar-module-list-count">10</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Recents</h4>
    <ul class="sidebar-module-list">
      
        <li>
          <a href="/2020/08/01/gitlab-sentry/">gitlab/sentry集成</a>
        </li>
      
        <li>
          <a href="/2020/06/10/ansible/">Ansible实践</a>
        </li>
      
        <li>
          <a href="/2020/03/08/elasticsearch_basic/">ElasticSearch学习笔记</a>
        </li>
      
        <li>
          <a href="/2020/02/29/jaeger_basic/">Jaeger初探</a>
        </li>
      
        <li>
          <a href="/2020/02/20/tavern/">ResfulApi测试框架tavern</a>
        </li>
      
    </ul>
  </div>



        </div>
    </div>
  </div>
  <footer class="blog-footer">
  <div class="container">
    <div id="footer-info" class="inner">
      &copy; 2020 KingQiu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      <br/>
      CopyRight © 2019 <a href="http://beian.miit.gov.cn/" target="_blank">粤ICP备19068003号</a>
    </div>
  </div>
</footer>
<script>
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

  
<script>
  var disqus_shortname = 'blog-qiujinwu-com';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js" crossorigin="anonymous"></script>

<script src="http://cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js" crossorigin="anonymous"></script>



<script src="/js/script.js"></script>

</body>
</html>
