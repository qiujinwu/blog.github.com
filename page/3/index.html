<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta name="google-site-verification" content="6jvcY_UrCpp1JLjXITf45ljboLU0NDGF16ZqomMt-ls">
  
  <title>个人笔记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="随笔">
<meta property="og:type" content="website">
<meta property="og:title" content="个人笔记">
<meta property="og:url" content="http://blog.kimq.cn/page/3/index.html">
<meta property="og:site_name" content="个人笔记">
<meta property="og:description" content="随笔">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="个人笔记">
<meta name="twitter:description" content="随笔">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" integrity="sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+" crossorigin="anonymous">

  <link rel="stylesheet" href="/css/styles.css">
  

</head>
</html>
<body>
  <nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="main-menu-navbar">
      <ul class="nav navbar-nav">
        
          <li><a class=""
                 href="/index.html">Home</a></li>
        
          <li><a class=""
                 href="/archives/">Archives</a></li>
        
          <li><a class=""
                 href="/atom.xml">Rss</a></li>
        
      </ul>

      <!--
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

  <div class="container">
    <div class="blog-header">
  <h1 class="blog-title">个人笔记</h1>
  
    <p class="lead blog-description">专注互联网</p>
  
</div>

    <div class="row">
        <div class="col-sm-9 blog-main">
          
  
    <article id="post-ssh-tunnel" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/06/ssh-tunnel/">SSH隧道</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/12/06/ssh-tunnel/" class="article-date"><time datetime="2017-12-06T11:07:25.000Z" itemprop="datePublished">2017-12-06</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/运营运维/">运营运维</a> / <a class="article-category-link" href="/categories/运营运维/代理/">代理</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>ssh常用来做远程ssl登录，通过添加公钥到<code>~/.ssh/authorized_keys</code>还可以实现<code>无密登录</code></p>
<h1 id="其他小tip"><a href="#其他小tip" class="headerlink" title="其他小tip"></a>其他小tip</h1><h2 id="直接执行命令"><a href="#直接执行命令" class="headerlink" title="直接执行命令"></a>直接执行命令</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@DESKTOP-89R692H:/home/king$ ssh king@192.168.1.2 <span class="built_in">pwd</span></span><br><span class="line">king@192.168.1.2<span class="string">'s password:</span></span><br><span class="line"><span class="string">/home/king</span></span><br></pre></td></tr></table></figure>
<h2 id="拷贝文件"><a href="#拷贝文件" class="headerlink" title="拷贝文件"></a>拷贝文件</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@DESKTOP-89R692H:/home/king$ scp test.sh king@192.168.1.2:/tmp</span><br><span class="line">king@192.168.1.2<span class="string">'s password:</span></span><br><span class="line"><span class="string">test.sh                100%  124     0.1KB/s   00:00</span></span><br><span class="line"><span class="string">king@DESKTOP-89R692H:/home/king$ scp king@192.168.1.2:/tmp/test.sh ./test.sh</span></span><br><span class="line"><span class="string">king@192.168.1.2'</span>s password:</span><br><span class="line">test.sh                100%  124     0.1KB/s   00:00</span><br></pre></td></tr></table></figure>
<h2 id="密码参数"><a href="#密码参数" class="headerlink" title="密码参数"></a>密码参数</h2><p>在不适用公钥无密登录的时候，密码必需手动输入，无法通过命令行直接带进去</p>
<p>对此，可以使用开源软件<a href="https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html" target="_blank" rel="noopener">putty</a>来支持，后者有发布Windows版本，不过可以直接在Linux下编译</p>
<p>具体用法参考<a href="http://qjw.qiujinwu.com/blog/2013/01/28/putty" target="_blank" rel="noopener">http://qjw.qiujinwu.com/blog/2013/01/28/putty</a></p>
<h1 id="本地端口转发"><a href="#本地端口转发" class="headerlink" title="本地端口转发"></a>本地端口转发</h1><p>假定host1是本地主机，host2是远程主机。由于种种原因，这两台主机之间无法连通。但是，另外还有一台host3，可以同时连通前面两台主机。因此，很自然的想法就是，通过host3，将host1连上host2。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">本地端口:目标主机:目标主机端口 -p 跳板机端口 跳板机username@跳板机host</span><br></pre></td></tr></table></figure>
<p>端口转发的一个类似场景如nginx</p>
<blockquote>
<p>只留一个对外的主机，并且开放80端口，通过nginx根据ServerName/Path来分发到upsteam(本机/其他主机的端口)，</p>
</blockquote>
<h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h2><p>默认情况docker的端口对于host是不可访问的，当然<code>-p</code>可以将端口share出来</p>
<p>这里模拟一种场景，测试服务器只开放了22/80端口，想通过ssh隧道访问其他端口</p>
<p>准备文件<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/tmp/docker$ ls</span><br><span class="line">authorized_keys  dockerfile  sources.list</span><br></pre></td></tr></table></figure></p>
<p><code>authorized_keys</code>存host的公钥，文件来自<code>~/.ssh/id_rsa.pub</code>,<code>sources.list</code>设置（比如阿里云）的源，这里我们用它来实现无密登录docker的ssh</p>
<p>dockerfile<br><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">16.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> qiujinwu@gmail.com</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /app</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> sources.list /etc/apt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update \</span></span><br><span class="line"><span class="bash">	&amp;&amp; apt-get install openssh-server netcat iputils-ping telnet net-tools -y \</span></span><br><span class="line"><span class="bash">	&amp;&amp; apt-get clean -y \</span></span><br><span class="line"><span class="bash">	&amp;&amp; apt-get autoclean</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /var/run/sshd</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">'root:1'</span> |chpasswd</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /root/.ssh/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> authorized_keys /root/.ssh/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">22</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"/usr/sbin/sshd"</span>, <span class="string">"-D"</span>]</span></span><br></pre></td></tr></table></figure></p>
<p>build docker镜像<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t sshd:0.1 ~/tmp/docker/</span><br></pre></td></tr></table></figure></p>
<p>运行<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进入交互shell，再手动启动sshd</span></span><br><span class="line">docker run -it --rm -p 10022:22 --name sshd sshd:0.1 /bin/bash</span><br><span class="line"><span class="comment"># 自动启动sshd</span></span><br><span class="line">docker run -it --rm -p 10022:22 --name sshd sshd:0.1</span><br><span class="line"><span class="comment"># 关闭(另起shell）</span></span><br><span class="line">docker stop sshd</span><br></pre></td></tr></table></figure></p>
<h3 id="echo-服务器"><a href="#echo-服务器" class="headerlink" title="echo 服务器"></a>echo 服务器</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rm -f /tmp/f; mkfifo /tmp/f</span><br><span class="line">cat /tmp/f | nc -l -p 40001 127.0.0.1 &gt; /tmp/f</span><br></pre></td></tr></table></figure>
<p>到此，我们可以启动一个进入shell的docker镜像，然后<code>/etc/init.d/sshd start</code>启动sshd，最后在shell中启动echo服务器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~$ docker run -it --rm -p 10022:22 --name sshd sshd:0.1 /bin/bash</span><br><span class="line">root@2f661b626247:/app<span class="comment"># /etc/init.d/ssh start</span></span><br><span class="line"> * Starting OpenBSD Secure Shell server sshd [ OK ]</span><br><span class="line">root@2f661b626247:/app<span class="comment"># rm -f /tmp/f; mkfifo /tmp/f</span></span><br><span class="line">root@2f661b626247:/app<span class="comment"># cat /tmp/f | nc -l -p 40001 127.0.0.1 &gt; /tmp/f</span></span><br><span class="line">root@2f661b626247:/app<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -N参数，表示只连接远程主机，不打开远程shell</span></span><br><span class="line"><span class="comment"># -T参数，表示不为这个连接分配TTY</span></span><br><span class="line">ssh -NT -L localhost:40001:localhost:40001 -p 10022 root@127.0.0.1</span><br></pre></td></tr></table></figure>
<p>这是，本机的sshd会监听40001端口，并且转交到本机的10022端口（docker的22端口），然后docker会交给自己的40001端口</p>
<p>接下来在本机运行客户端<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~$ nc 127.0.0.1 40001</span><br><span class="line">aa</span><br><span class="line">aa</span><br><span class="line">bbb</span><br><span class="line">bbb</span><br></pre></td></tr></table></figure></p>
<h2 id="跨主机"><a href="#跨主机" class="headerlink" title="跨主机"></a>跨主机</h2><p>前面的例子第三方的跳板机收到请求后，转发到自己（localhost）的其他端口，也可以转发到其他主机</p>
<p>运行目标机docker<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/.ssh$ docker run -it --rm --name sshd2 sshd:0.1 /bin/bash</span><br><span class="line">root@bea2bbfe3625:/app<span class="comment"># rm -f /tmp/f; mkfifo /tmp/f</span></span><br><span class="line"><span class="comment"># 这里不指定0.0.0.0</span></span><br><span class="line">root@bea2bbfe3625:/app<span class="comment"># cat /tmp/f | nc -l -p 40001 &gt; /tmp/f</span></span><br></pre></td></tr></table></figure></p>
<p>运行跳板机docker, 暴露端口22到10022，并且链接到目标机（使用别名up）<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -it --rm -p 10022:22 --link=sshd2:up --name=sshd sshd:0.1</span><br></pre></td></tr></table></figure></p>
<p>参考<a href="http://qjw.qiujinwu.com/blog/2013/12/22/nc_server" target="_blank" rel="noopener">http://qjw.qiujinwu.com/blog/2013/12/22/nc_server</a></p>
<p>运行宿主机 ,将本机40001的数据转发到跳板机docker，然后再转发到名为up的docker的40001端口<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh -NT -L localhost:40001:up:40001 -p 10022 root@127.0.0.1</span><br></pre></td></tr></table></figure></p>
<h1 id="远程端口转发"><a href="#远程端口转发" class="headerlink" title="远程端口转发"></a>远程端口转发</h1><p>host1与host2之间无法连通，必须借助host3转发。但是，特殊情况出现了，host3是一台内网机器，它可以连接外网的host1，但是反过来就不行，外网的host1连不上内网的host3。这时，”本地端口转发”就不能用了，怎么办？<br>解决办法是，既然host3可以连host1，那么就从host3上建立与host1的SSH连接，然后在host1上使用这条连接就可以了。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">外网端口:目标主机:目标主机端口 -p 外网ssh端口 外网机username@外网host</span><br></pre></td></tr></table></figure>
<p>继续使用docker模拟</p>
<p>默认的bridge模式, host机会有一个x.x.x.1的ip和docker机器联通</p>
<p>运行目标机器<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/.ssh$ docker run -it --rm --name sshd2 sshd:0.1 /bin/bash</span><br><span class="line">root@556f737ec232:/app<span class="comment"># rm -f /tmp/f; mkfifo /tmp/f</span></span><br><span class="line">root@556f737ec232:/app<span class="comment"># cat /tmp/f | nc -l -p 40001 &gt; /tmp/f</span></span><br></pre></td></tr></table></figure></p>
<p>运行跳板机，通知host机监听40001端口，并且转发给自己，然后自己再转发给up机器的40001端口<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/tmp/docker$ docker run -it --rm --link=sshd2:up --name=sshd sshd:0.1 /bin/bash</span><br><span class="line">root@fd1b60b1b84e:/app<span class="comment"># ssh -NT -R 40001:up:40001 -p 22 king@172.17.0.1</span></span><br><span class="line">king@172.17.0.1<span class="string">'s password:</span></span><br></pre></td></tr></table></figure></p>
<p>在host机执行测试程序即可<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~$ nc 127.0.0.1 40001</span><br><span class="line">aa</span><br><span class="line">aa</span><br><span class="line">bbb</span><br><span class="line">bbb</span><br></pre></td></tr></table></figure></p>
<h1 id="SSL隧道"><a href="#SSL隧道" class="headerlink" title="SSL隧道"></a>SSL隧道</h1><p>在本地绑定一个端口，发送往这个端口的数据都通过ssh到远程机器出去，本质上就是socks代理<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh -NT -D 1080 king@192.168.1.219</span><br></pre></td></tr></table></figure></p>
<p>浏览器可以安装个<a href="https://github.com/FelisCatus/SwitchyOmega/releases" target="_blank" rel="noopener">switchyomega</a>工具，然后设置socks5代理指向 localhost:1080，就可以让浏览器所有数据都从192.168.1.219出去，从而做些羞羞的事情</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="http://www.ruanyifeng.com/blog/2011/12/ssh_port_forwarding.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2011/12/ssh_port_forwarding.html</a></li>
<li><a href="http://qjw.qiujinwu.com/blog/2013/12/22/nc_server" target="_blank" rel="noopener">http://qjw.qiujinwu.com/blog/2013/12/22/nc_server</a></li>
<li><a href="http://www.cnblogs.com/wellbye/p/3163966.html" target="_blank" rel="noopener">http://www.cnblogs.com/wellbye/p/3163966.html</a></li>
</ol>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/12/06/ssh-tunnel/" data-id="ckdbgbyxy005g43pos4jf2ykz" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/12/06/ssh-tunnel/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssh/">ssh</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-influxdb" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/05/influxdb/">telegraf/influxdb/grafana初探</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/12/05/influxdb/" class="article-date"><time datetime="2017-12-05T11:07:03.000Z" itemprop="datePublished">2017-12-05</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/学习笔记/">学习笔记</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>influxdb/grafana直接docker运行最简单</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">// 下载镜像</span><br><span class="line">docker pull influxdb</span><br><span class="line">docker pull grafana/grafana</span><br><span class="line"><span class="comment"># 运行（第一次）</span></span><br><span class="line">docker run -p 8086:8086 --name influxdb -v <span class="variable">$PWD</span>:/var/lib/influxdb influxdb</span><br><span class="line">docker run -p 3000:3000 --name grafana grafana/grafana</span><br><span class="line"><span class="comment"># 创建了容器之后，由于指定了自定义name，后续可以根据这个name直接启动</span></span><br><span class="line">docker start influxdb</span><br><span class="line">docker start grafana</span><br></pre></td></tr></table></figure>
<p>telegraf直接安装</p>
<p>下载地址 <a href="https://github.com/influxdata/telegraf/releases" target="_blank" rel="noopener">https://github.com/influxdata/telegraf/releases</a><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo dpkg -i /home/king/telegraf_1.4.5-1_amd64.deb</span><br><span class="line"><span class="comment"># 安装客户端</span></span><br><span class="line">sudo apt-get install influxdb-client</span><br><span class="line"><span class="comment"># docker也是可以的</span></span><br><span class="line"><span class="comment"># https://hub.docker.com/_/telegraf/</span></span><br></pre></td></tr></table></figure></p>
<h1 id="influxdb"><a href="#influxdb" class="headerlink" title="influxdb"></a>influxdb</h1><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a><a href="https://docs.influxdata.com/influxdb/v0.9/concepts/key_concepts" target="_blank" rel="noopener">基本概念</a></h2><ol>
<li>dababase 数据库</li>
<li><a href="https://docs.influxdata.com/influxdb/v0.9/concepts/key_concepts/#measurement" target="_blank" rel="noopener">measurement</a>，数据库表</li>
<li>points,类比数据表行</li>
<li>time, 时间戳，由于是时序数据库，每个数据表都会有一列时间戳的列</li>
<li>field, 字段数据，没有索引，通常根据时间来呈现</li>
<li>tag, 字段的标签，有索引，可以以此进行过滤</li>
<li><a href="https://docs.influxdata.com/influxdb/v0.9/concepts/key_concepts/#series" target="_blank" rel="noopener">series</a>, a series is the collection of data that share a retention policy, measurement, and tag set，</li>
</ol>
<h2 id="field和tag"><a href="#field和tag" class="headerlink" title="field和tag"></a>field和tag</h2><p>两者除了索引的区别外，本质上是定位的差异，举个例子，有数据</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">时间戳 姓名 城市 收入 支出</span><br></pre></td></tr></table></figure>
<p><code>收入</code>、<code>支出</code>定位于field，没有实际的规律，一般不会用它来做顾虑（传统的关系数据库，常见的可以根据范围过滤搜索），而<code>姓名</code>、<code>城市</code>定位于Tag，可以理解为这一行（<code>point</code>）的属性，我们会有诸如</p>
<ol>
<li>所有人的收入曲线图</li>
<li>广州、深圳等各个城市的收入，支出曲线图</li>
<li>甚至只看广州的张三的支出曲线图</li>
</ol>
<p><code>Tag</code>一般在一个有限的集合中选取，而不是<code>field</code>那样无明显的规律</p>
<h2 id="写入数据"><a href="#写入数据" class="headerlink" title="写入数据"></a>写入数据</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建数据库</span></span><br><span class="line">curl -i -XPOST http://localhost:8086/query --data-urlencode <span class="string">"q=CREATE DATABASE telegraf"</span></span><br><span class="line"><span class="comment"># 写入数据，最后的时间戳可以省略，自动用当前时间(test: measurement名称）</span></span><br><span class="line">curl -i -XPOST <span class="string">'http://localhost:8086/write?db=telegraf'</span> --data-binary  \</span><br><span class="line">	<span class="string">'test,tag1=server01,tag2=us-west field1=0.64,field2=11 1434055562000000000'</span></span><br></pre></td></tr></table></figure>
<p>也可以使用cli工具<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/tmp$ influx </span><br><span class="line">Visit https://enterprise.influxdata.com to register <span class="keyword">for</span> updates,</span><br><span class="line">   InfluxDB server management, and monitoring.</span><br><span class="line">Connected to http://localhost:8086 version 1.4.2</span><br><span class="line">InfluxDB shell 0.10.0</span><br><span class="line">&gt; show databases;</span><br><span class="line">name: databases</span><br><span class="line">---------------</span><br><span class="line">name</span><br><span class="line">_internal</span><br><span class="line">telegraf</span><br><span class="line"></span><br><span class="line">&gt; use telegraf;</span><br><span class="line">Using database telegraf</span><br><span class="line">&gt; show measurements;</span><br><span class="line">name: measurements</span><br><span class="line">------------------</span><br><span class="line">name</span><br><span class="line">money</span><br><span class="line">processes</span><br><span class="line">swap</span><br><span class="line">system</span><br><span class="line"><span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">&gt; show series from money</span><br><span class="line">key</span><br><span class="line">money,city=上海,name=张三</span><br><span class="line">money,city=北京,name=刘七</span><br><span class="line"></span><br><span class="line">&gt; select * from money <span class="built_in">limit</span> 2</span><br><span class="line">name: money</span><br><span class="line">-----------</span><br><span class="line">time			city	<span class="keyword">in</span>	name	out</span><br><span class="line">1512445152435671225	深圳	28	赵六	1</span><br><span class="line">1512445153519585060	上海	76	李四	95</span><br></pre></td></tr></table></figure></p>
<h2 id="简单的数据源"><a href="#简单的数据源" class="headerlink" title="简单的数据源"></a>简单的数据源</h2><p>不依赖于telegraf采集器，在程序中，也有非常多的api可选,参见<a href="https://docs.influxdata.com/influxdb/v0.9/clients/api/" target="_blank" rel="noopener">https://docs.influxdata.com/influxdb/v0.9/clients/api/</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">url=<span class="string">"http://localhost:8086/write?db=telegraf"</span></span><br><span class="line">names=(<span class="string">'张三'</span> <span class="string">'李四'</span> <span class="string">'王五'</span> <span class="string">'赵六'</span> <span class="string">'刘七'</span>)</span><br><span class="line">citys=(<span class="string">'深圳'</span> <span class="string">'广州'</span> <span class="string">'北京'</span> <span class="string">'上海'</span> <span class="string">'成都'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">doWrite</span></span>()&#123;</span><br><span class="line">    curl -i -XPOST <span class="string">"<span class="variable">$&#123;url&#125;</span>"</span> --data-binary <span class="string">"money,name="</span><span class="variable">$&#123;1&#125;</span><span class="string">",city="</span><span class="variable">$&#123;2&#125;</span><span class="string">" in="</span><span class="variable">$&#123;3&#125;</span><span class="string">",out="</span><span class="variable">$&#123;4&#125;</span><span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>((i=0;i&lt;10000;i++))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">in</span>=$(($(<span class="built_in">echo</span> <span class="variable">$RANDOM</span>) % 100))</span><br><span class="line">    out=$(($(<span class="built_in">echo</span> <span class="variable">$RANDOM</span>) % 100))</span><br><span class="line"></span><br><span class="line">    cityid=$(($(<span class="built_in">echo</span> <span class="variable">$RANDOM</span>) % 5))</span><br><span class="line">    nameid=$(($(<span class="built_in">echo</span> <span class="variable">$RANDOM</span>) % 5))</span><br><span class="line">    doWrite <span class="variable">$&#123;names[nameid]&#125;</span> <span class="variable">$&#123;citys[cityid]&#125;</span> <span class="string">"<span class="variable">$&#123;in&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;out&#125;</span>"</span></span><br><span class="line">    sleep 1</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h1 id="Telegraf"><a href="#Telegraf" class="headerlink" title="Telegraf"></a><a href="https://github.com/influxdata/telegraf" target="_blank" rel="noopener">Telegraf</a></h1><p>telegraf是一个数据采集器，自身有一些基本的采集功能，比如cpu、内存等。支持插件的设计使得采集范围非常广泛，支持列表见<a href="https://github.com/influxdata/telegraf#input-plugins" target="_blank" rel="noopener">https://github.com/influxdata/telegraf#input-plugins</a></p>
<p>具体的配置见官方文档，为了对接influxdb，我们先需要修改<code>/etc/telegraf/telegraf.conf</code><br><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Configuration for influxdb server to send metrics to</span></span><br><span class="line"><span class="section">[[outputs.influxdb]]</span></span><br><span class="line">  <span class="comment">## The full HTTP or UDP URL for your InfluxDB instance.</span></span><br><span class="line">  <span class="comment">##</span></span><br><span class="line">  <span class="comment">## Multiple urls can be specified as part of the same cluster,</span></span><br><span class="line">  <span class="comment">## this means that only ONE of the urls will be written to each interval.</span></span><br><span class="line">  <span class="comment"># urls = ["udp://localhost:8089"] # UDP endpoint example                      </span></span><br><span class="line">  urls = ["http://localhost:8086"] # required</span><br><span class="line">  <span class="comment">## The target database for metrics (telegraf will create it if not exists).   </span></span><br><span class="line">  database = "telegraf" # required</span><br></pre></td></tr></table></figure></p>
<p>直接运行<code>telegraf</code>命令启动服务器（为什么没有/etc/init.d/xx）</p>
<h1 id="grafana"><a href="#grafana" class="headerlink" title="grafana"></a><a href="https://grafana.com/" target="_blank" rel="noopener">grafana</a></h1><p>grafana本身支持很多后端，包括influxdb，它是启动之后再进行参数配置。</p>
<p>首先配置数据源,influxdb参考<a href="http://docs.grafana.org/features/datasources/influxdb/" target="_blank" rel="noopener">http://docs.grafana.org/features/datasources/influxdb/</a></p>
<p>然后添加dashboard-panel。在panel的metrics里有各种参数（本质上就是一个sql的语义），以及一些聚合函数支持</p>
<p>完善权限控制</p>
<p>这三个东西和elk技(全)术(家)栈(桶)有些有意思的对比，<a href="http://www.infoq.com/cn/articles/grafana-vs-kibana-the-key-differences-to-know" target="_blank" rel="noopener">这里</a>有一个grafana和kibana的比较</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="http://www.jianshu.com/p/dfd329d30891" target="_blank" rel="noopener">http://www.jianshu.com/p/dfd329d30891</a></li>
</ol>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/12/05/influxdb/" data-id="ckdbgbywk002x43po26zrh1w8" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/12/05/influxdb/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/influxdb/">influxdb</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-antd" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/02/antd/">antd随笔</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/12/02/antd/" class="article-date"><time datetime="2017-12-02T15:20:52.000Z" itemprop="datePublished">2017-12-02</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/学习笔记/">学习笔记</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>antd <a href="https://ant.design/index-cn" target="_blank" rel="noopener">https://ant.design/index-cn</a></p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>本着学习的目的，最开始自己从零折腾，不过后来放弃了，学习从<a href="https://github.com/zuiidea/antd-admin" target="_blank" rel="noopener">https://github.com/zuiidea/antd-admin</a>开始</p>
<p>可以直接删除业务/页面代码，保留配置继续开发，后者体验网址<a href="http://antd-admin.zuiidea.com" target="_blank" rel="noopener">http://antd-admin.zuiidea.com</a></p>
<h1 id="html5-es6-react"><a href="#html5-es6-react" class="headerlink" title="html5/es6+/react"></a>html5/es6+/react</h1><p>大量使用es6语法</p>
<p>简化的import/export，以及<a href="https://segmentfault.com/q/1010000005762199" target="_blank" rel="noopener">大括号语法</a>，自动导出子模块（变量）<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;request, config&#125; <span class="keyword">from</span> <span class="string">'utils'</span></span><br><span class="line"><span class="keyword">const</span> &#123;api&#125; = config;</span><br></pre></td></tr></table></figure></p>
<p><a href="http://www.ruanyifeng.com/blog/2015/05/async.html" target="_blank" rel="noopener">异步函数</a>/<code>async</code><br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">loginCb</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> request(&#123;</span><br><span class="line">    url: api.userLoginCB,</span><br><span class="line">    method: <span class="string">'get'</span>,</span><br><span class="line">    data,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><a href="http://www.ruanyifeng.com/blog/2015/04/generator.html" target="_blank" rel="noopener">生成器函数</a>/<code>yield</code>/<code>*函数</code><br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">yield</span> put(&#123;</span><br><span class="line">  type: <span class="string">'querySuccess'</span>,</span><br><span class="line">  payload: &#123;</span><br><span class="line">    data: data,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">* query(&#123;</span><br><span class="line">          url,</span><br><span class="line">          payload,</span><br><span class="line">        &#125;, &#123;call, put&#125;) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;data&#125; = <span class="keyword">yield</span> call(url, payload);</span><br><span class="line">  <span class="keyword">yield</span> put(&#123;</span><br><span class="line">    type: <span class="string">'querySuccess'</span>,</span><br><span class="line">    payload: &#123;</span><br><span class="line">      data: data,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>箭头函数<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(<span class="function">(<span class="params">&#123; detail, loading &#125;</span>) =&gt;</span> (&#123; <span class="attr">state</span>:detail, loading &#125;))(Detail)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> handleOk = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  validateFields(<span class="function">(<span class="params">errors</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (errors) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> data = &#123;</span><br><span class="line">      ...item,</span><br><span class="line">      ...getFieldsValue(),</span><br><span class="line">    &#125;;</span><br><span class="line">    onOk(data)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多重</span></span><br><span class="line"><span class="keyword">const</span> handleChange = <span class="function">(<span class="params">count</span>) =&gt;</span> <span class="function">(<span class="params">fileList</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// do sth</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>合并对象/…<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">  ...item,</span><br><span class="line">  ...getFieldsValue(),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>const/let声明变量/常亮</p>
<p>(不)等于 ===/!==</p>
<p><a href="https://www.cnblogs.com/zxyun/p/7019631.html" target="_blank" rel="noopener">map/filter</a></p>
<p>window.localStorage保存本地配置</p>
<h2 id="React"><a href="#React" class="headerlink" title="React"></a>React</h2><p>react组件有<a href="https://www.cnblogs.com/wonyun/p/5930333.html" target="_blank" rel="noopener">三种声明</a>方式</p>
<p>antd大量使用<code>函数式定义</code>的写法，这种写法是废代码不多，但是不支持状态和react事件</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; config &#125; <span class="keyword">from</span> <span class="string">'utils'</span></span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">'./Footer.less'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Footer = <span class="function"><span class="params">()</span> =&gt;</span> (&lt;div className=&#123;styles.footer&#125;&gt;</span><br><span class="line">  &#123;config.footerText&#125;</span><br><span class="line">&lt;/div&gt;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Footer</span><br></pre></td></tr></table></figure>
<p>es5原生方式React.createClass定义的组件</p>
<p>es6形式的extends React.Component定义的组件</p>
<h1 id="跳转"><a href="#跳转" class="headerlink" title="跳转"></a>跳转</h1><p>跳转可以用history接口<a href="https://developer.mozilla.org/en-US/docs/Web/API/History_API" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API/History_API</a></p>
<p>或者更高层的history库 <a href="https://github.com/ReactTraining/history" target="_blank" rel="noopener">https://github.com/ReactTraining/history</a></p>
<p>不过推荐dispatch一个routerRedux异步任务的方式</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">dispatch(routerRedux.push(&#123;</span><br><span class="line">  pathname: buildUrl(route.apartmentBatchPrice,&#123;<span class="attr">id</span>:record.id&#125;),</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>
<h2 id="React-router的迁移问题"><a href="#React-router的迁移问题" class="headerlink" title="React router的迁移问题"></a>React router的迁移问题</h2><p>React router 2到4接口改变了很多，antd/dva版本上也有出现很多问题，参见<a href="https://github.com/gmfe/Think/issues/6" target="_blank" rel="noopener">https://github.com/gmfe/Think/issues/6</a></p>
<p>新版本不再有query成员，不过可以手动处理下<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> queryString = <span class="built_in">require</span>(<span class="string">'query-string'</span>);</span><br><span class="line">location.query = queryString.parse(location.search);</span><br></pre></td></tr></table></figure></p>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>跳转时，一般使用url的query参数传递参数，不过若使用<a href="https://github.com/ReactTraining/history" target="_blank" rel="noopener">ReactTraining/history</a> 库，可以借助<code>location.state</code></p>
<ol>
<li>location.pathname - The path of the URL</li>
<li>location.search - The URL query string</li>
<li>location.hash - The URL hash fragment</li>
<li>location.state - Some extra state for this location that does not reside in the URL (supported in createBrowserHistory and createMemoryHistory)</li>
<li>location.key - A unique string representing this location (supported in createBrowserHistory and createMemoryHistory)</li>
</ol>
<blockquote>
<p>routerRedux.push的参数就是一个location对象</p>
</blockquote>
<h1 id="Model复用"><a href="#Model复用" class="headerlink" title="Model复用"></a><a href="https://github.com/dvajs/dva-model-extend" target="_blank" rel="noopener">Model复用</a></h1><p>借助dva提供的<code>modelExtend</code>，可以复用model的变量和方法，</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> modelExtend <span class="keyword">from</span> <span class="string">'dva-model-extend'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> model = &#123;</span><br><span class="line">  reducers: &#123;</span><br><span class="line">    updateState (state, &#123; payload &#125;) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        ...payload,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pageModel = modelExtend(model, &#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    list: [],</span><br><span class="line">    pagination: &#123;</span><br><span class="line">      showSizeChanger: <span class="literal">false</span>,</span><br><span class="line">      showQuickJumper: <span class="literal">false</span>,</span><br><span class="line">      showTotal: <span class="function"><span class="params">total</span> =&gt;</span> <span class="string">`共 <span class="subst">$&#123;total&#125;</span> 条记录`</span>,</span><br><span class="line">      current: <span class="number">1</span>,</span><br><span class="line">      total: <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  reducers: &#123;</span><br><span class="line">    querySuccess (state, &#123; payload &#125;) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; list, pagination &#125; = payload</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        ...&#123;<span class="attr">list</span>:list&#125;,</span><br><span class="line">        pagination: &#123;</span><br><span class="line">          ...state.pagination,</span><br><span class="line">          ...pagination,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  model,</span><br><span class="line">  pageModel,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>和C++的继承有几分相似的是，modelExtend的继承可以继续继承，也可以多继承</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> pageModel = modelExtend(model, model2 &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="service优化"><a href="#service优化" class="headerlink" title="service优化"></a>service优化</h1><p>service定义了调用后端Api的接口，每个route的service结构都大同小异，考虑到常用的就CRUD，对于同一个后端，使用的http method/参数定义也相同，所以可以抽象以下。</p>
<p>下面的代码架设了create/query/detail/update/enable/disable/remove等常用方法的请求格式<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;request, config&#125; <span class="keyword">from</span> <span class="string">'utils'</span></span><br><span class="line"><span class="keyword">import</span> &#123;buildUrl&#125; <span class="keyword">from</span> <span class="string">'../utils/url'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createService</span>(<span class="params">keys</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> res = &#123;&#125;;</span><br><span class="line">  <span class="keyword">let</span> exclude = &#123;&#125;</span><br><span class="line">  <span class="keyword">if</span> (keys[<span class="string">"create"</span>]) &#123;</span><br><span class="line">    res[<span class="string">"create"</span>] =</span><br><span class="line">      <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params">data, param=null</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> request(&#123;</span><br><span class="line">          url: buildUrl(keys.create, param),</span><br><span class="line">          method: <span class="string">'post'</span>,</span><br><span class="line">          data,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    exclude[<span class="string">"create"</span>] = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keys[<span class="string">"query"</span>]) &#123;</span><br><span class="line">    res[<span class="string">"query"</span>] =</span><br><span class="line">      <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">query</span>(<span class="params">data, param=null</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> request(&#123;</span><br><span class="line">          url: buildUrl(keys.query, param),</span><br><span class="line">          method: <span class="string">'get'</span>,</span><br><span class="line">          data,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    exclude[<span class="string">"query"</span>] = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keys[<span class="string">"detail"</span>]) &#123;</span><br><span class="line">    res[<span class="string">"detail"</span>] =</span><br><span class="line">      <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">detail</span>(<span class="params">param = null</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> request(&#123;</span><br><span class="line">          url: buildUrl(keys.detail, param),</span><br><span class="line">          method: <span class="string">'get'</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    exclude[<span class="string">"detail"</span>] = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keys[<span class="string">"update"</span>]) &#123;</span><br><span class="line">    res[<span class="string">"update"</span>] =</span><br><span class="line">      <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params">data, param=null</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> request(&#123;</span><br><span class="line">          url: buildUrl(keys.update, param),</span><br><span class="line">          method: <span class="string">'put'</span>,</span><br><span class="line">          data: data,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    exclude[<span class="string">"update"</span>] = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keys[<span class="string">"enable"</span>]) &#123;</span><br><span class="line">    res[<span class="string">"enable"</span>] =</span><br><span class="line">      <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">enable</span>(<span class="params">param = null</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> request(&#123;</span><br><span class="line">          url: buildUrl(keys.enable, param),</span><br><span class="line">          method: <span class="string">'post'</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    exclude[<span class="string">"enable"</span>] = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keys[<span class="string">"disable"</span>]) &#123;</span><br><span class="line">    res[<span class="string">"disable"</span>] =</span><br><span class="line">      <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">disable</span>(<span class="params">param = null</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> request(&#123;</span><br><span class="line">          url: buildUrl(keys.disable, param),</span><br><span class="line">          method: <span class="string">'post'</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    exclude[<span class="string">"disable"</span>] = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keys[<span class="string">"remove"</span>]) &#123;</span><br><span class="line">    res[<span class="string">"remove"</span>] =</span><br><span class="line">      <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">remove</span>(<span class="params">param = null</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> request(&#123;</span><br><span class="line">          url: buildUrl(keys.remove, param),</span><br><span class="line">          method: <span class="string">'delete'</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    exclude[<span class="string">"remove"</span>] = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> methods = &#123;</span><br><span class="line">    <span class="string">"post"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="string">"put"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="string">"get"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="string">"delete"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="string">"patch"</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> keys) &#123;</span><br><span class="line">    <span class="keyword">if</span> (keys.hasOwnProperty(key))&#123;</span><br><span class="line">      <span class="comment">// 排除上面的通用方法</span></span><br><span class="line">      <span class="keyword">if</span>(key <span class="keyword">in</span> exclude) <span class="keyword">continue</span></span><br><span class="line">      <span class="comment">// 必须是对象</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">typeof</span> keys[key] === <span class="string">'object'</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> rt = keys[key]</span><br><span class="line">        <span class="comment">// 合法的方法</span></span><br><span class="line">        <span class="keyword">if</span>(!rt.method <span class="keyword">in</span> methods) &#123;</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res[key] =</span><br><span class="line">          <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params">data, param=null</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> request(&#123;</span><br><span class="line">              url: buildUrl(rt.url, param),</span><br><span class="line">              method: rt.method,</span><br><span class="line">              data,</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;request, config&#125; <span class="keyword">from</span> <span class="string">'utils'</span></span><br><span class="line"><span class="keyword">import</span> &#123;createService&#125; <span class="keyword">from</span> <span class="string">"./common"</span></span><br><span class="line"></span><br><span class="line">exports.services = createService(config.api.user);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">user: &#123;</span><br><span class="line">  <span class="string">"query"</span>: <span class="string">`<span class="subst">$&#123;APIV1&#125;</span>/users/`</span>,</span><br><span class="line">  <span class="string">"update"</span>: <span class="string">`<span class="subst">$&#123;APIV1&#125;</span>/users/:id`</span>,</span><br><span class="line">  <span class="string">"detail"</span>: <span class="string">`<span class="subst">$&#123;APIV1&#125;</span>/users/:id`</span>,</span><br><span class="line">  <span class="string">"enable"</span>: <span class="string">`<span class="subst">$&#123;APIV1&#125;</span>/users/:id/enable`</span>,</span><br><span class="line">  <span class="string">"disable"</span>: <span class="string">`<span class="subst">$&#123;APIV1&#125;</span>/users/:id/disable`</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>一些特殊的方法，则简单描述即可</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;request, config&#125; <span class="keyword">from</span> <span class="string">'utils'</span></span><br><span class="line"><span class="keyword">import</span> &#123;createService&#125; <span class="keyword">from</span> <span class="string">"./common"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> routes = config.api.price</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> routes[<span class="string">"generate"</span>] != <span class="string">'object'</span>)&#123;</span><br><span class="line">  routes[<span class="string">'generate'</span>] = &#123;</span><br><span class="line">    <span class="string">"method"</span>: <span class="string">"post"</span>,</span><br><span class="line">    <span class="string">"url"</span>: routes[<span class="string">'generate'</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exports.services = createService(routes);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">price: &#123;</span><br><span class="line">  <span class="string">"create"</span>: <span class="string">`<span class="subst">$&#123;APIV1&#125;</span>/:id/prices`</span>,</span><br><span class="line">  <span class="string">"update"</span>: <span class="string">`<span class="subst">$&#123;APIV1&#125;</span>/:id/prices`</span>,</span><br><span class="line">  <span class="string">"query"</span>: <span class="string">`<span class="subst">$&#123;APIV1&#125;</span>/:id/prices`</span>,</span><br><span class="line">  <span class="string">"generate"</span>: <span class="string">`<span class="subst">$&#123;APIV1&#125;</span>/:id/prices/generate`</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Url"><a href="#Url" class="headerlink" title="Url"></a>Url</h1><p>大量使用<a href="https://github.com/pillarjs/path-to-regexp" target="_blank" rel="noopener">path-to-regexp</a></p>
<p>有用到几种场景</p>
<p>判断是否是我们需要的url<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">setup(&#123;dispatch, history&#125;) &#123;</span><br><span class="line">  history.listen(<span class="function">(<span class="params">location</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> match = pathToRegexp(route.apartments).exec(location.pathname);</span><br><span class="line">    <span class="keyword">if</span> (match) &#123;</span><br><span class="line">      location.query = queryString.parse(location.search);</span><br><span class="line">      <span class="keyword">const</span> payload = location.query || &#123;<span class="attr">page</span>: <span class="number">1</span>, <span class="attr">count</span>: countPePage&#125;;</span><br><span class="line">      dispatch(&#123;</span><br><span class="line">        type: <span class="string">'query'</span>,</span><br><span class="line">        payload,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>构建url用于跳转，解析url中的参数<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pathToRegexp <span class="keyword">from</span> <span class="string">'path-to-regexp'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  buildUrl:<span class="function">(<span class="params">url, param</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!param) <span class="keyword">return</span> url;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> toPath = pathToRegexp.compile(url);</span><br><span class="line">    <span class="keyword">return</span> toPath(param);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  parseUrl:<span class="function">(<span class="params">url,route</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> match = pathToRegexp(route).exec(url)</span><br><span class="line">    <span class="keyword">if</span>(!match) <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> urlDatas = &#123;&#125;;</span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">const</span> keys = pathToRegexp.parse(route)</span><br><span class="line">    keys.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">typeof</span> item !== <span class="string">'object'</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      urlDatas[item.name] = match[index]</span><br><span class="line">      index ++</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> urlDatas</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">yield</span> put(routerRedux.push(&#123;</span><br><span class="line">  pathname: buildUrl(route.storeDetailIndex,&#123;<span class="attr">id</span>:store.id,<span class="attr">tab</span>:route.storeDetailTab.rule&#125;),</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> urlDatas = parseUrl(location.pathname, current.route);</span><br><span class="line">pathArray.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(item === current || !item.route) <span class="keyword">return</span>;</span><br><span class="line">  item.route2 = buildUrl(item.route,urlDatas)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="dva-loading"><a href="#dva-loading" class="headerlink" title="dva-loading"></a><a href="https://github.com/dvajs/dva/tree/master/packages/dva-loading" target="_blank" rel="noopener">dva-loading</a></h1><p>通过绑定一个<a href="https://github.com/redux-saga/redux-saga" target="_blank" rel="noopener">redux-saga</a>异步请求来实现UI的<code>加载中</code>的效果</p>
<p>关于dva以及react全家桶的一些概念，参见<a href="https://github.com/dvajs/dva/blob/master/README_zh-CN.md" target="_blank" rel="noopener">https://github.com/dvajs/dva/blob/master/README_zh-CN.md</a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> createLoading <span class="keyword">from</span> <span class="string">'dva-loading'</span></span><br><span class="line"><span class="comment">// 1. Initialize</span></span><br><span class="line"><span class="keyword">const</span> app = dva(&#123;</span><br><span class="line">  ...createLoading(&#123;</span><br><span class="line">    effects: <span class="literal">true</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(<span class="function">(<span class="params">&#123; detail, loading &#125;</span>) =&gt;</span> (&#123; <span class="attr">state</span>:detail, loading &#125;))(Detail)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;Button type=<span class="string">"primary"</span> size=<span class="string">"large"</span> loading=&#123;loading.effects.login&#125;&gt;</span><br><span class="line">  登录</span><br><span class="line">&lt;<span class="regexp">/Button&gt;</span></span><br></pre></td></tr></table></figure>
<p>antd很多组件都集成了loading属性。例如<a href="https://ant.design/components/button-cn/#API" target="_blank" rel="noopener">button</a>，<a href="https://ant.design/components/table-cn/#Table" target="_blank" rel="noopener">Table</a></p>
<p>当页面不存在这些支持loading的控件，或者不合适使用时，antd-admin提供了一个全局的<a href="https://github.com/zuiidea/antd-admin/tree/master/src/components/Loader" target="_blank" rel="noopener">Loader</a>控件<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> LoginCB = <span class="function">(<span class="params">&#123;location, dispatch, loading&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Loader fullScreen spinning=&#123;loading.effects[<span class="string">'login_cb/login'</span>]&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="表单"><a href="#表单" class="headerlink" title="表单"></a><a href="https://ant.design/components/form-cn/" target="_blank" rel="noopener">表单</a></h1><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;Form.Item &#123;...props&#125;&gt;</span><br><span class="line">  &#123;children&#125;</span><br><span class="line">&lt;<span class="regexp">/Form.Item&gt;</span></span><br></pre></td></tr></table></figure>
<p>form基于<a href="https://github.com/react-component/form" target="_blank" rel="noopener">rc-form</a>，一些选项可以参考<a href="https://github.com/react-component/form#option-object" target="_blank" rel="noopener">https://github.com/react-component/form#option-object</a></p>
<p>经过 <code>getFieldDecorator</code> 包装的控件，表单控件会自动添加 <code>value</code>（或 <code>valuePropName</code> 指定的其他属性） <code>onChange</code>（或 trigger 指定的其他属性），数据同步将被 Form 接管，这会导致以下结果：</p>
<ol>
<li>你不再需要也不应该用 <code>onChange</code> 来做同步，但还是可以继续监听 onChange 等事件。</li>
<li>你不能用控件的 <code>value</code> <code>defaultValue</code> 等属性来设置表单域的值，默认值可以用 <code>getFieldDecorator</code> 里的 <code>initialValue</code>。</li>
<li>你不应该用 <code>setState</code>，可以使用 <code>this.props.form.setFieldsValue</code> 来动态改变表单值。</li>
</ol>
<h2 id="自定义控件适配"><a href="#自定义控件适配" class="headerlink" title="自定义控件适配"></a><a href="https://github.com/ant-design/ant-design/issues/5700" target="_blank" rel="noopener">自定义控件适配</a></h2><p>参考<a href="https://ant.design/components/form/#components-form-demo-customized-form-controls" target="_blank" rel="noopener">https://ant.design/components/form/#components-form-demo-customized-form-controls</a></p>
<p>关键两点</p>
<ol>
<li>初始值从<code>props.value</code>获取，这个值从<code>getFieldDecorator</code>的<code>initialValue</code>获取</li>
<li>当控件<code>value</code>值改变时，通过<code>props.onChange</code>获取到触发<code>getFieldDecorator</code>的回调，并触发之</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123;Select&#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; <span class="keyword">from</span> <span class="string">'dva'</span></span><br><span class="line"><span class="keyword">import</span> &#123;Icon&#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span>;</span><br><span class="line"><span class="keyword">const</span> &#123;Option&#125; = Select;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IDSelect</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> value = <span class="keyword">this</span>.props.value || [];</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      current_value: <span class="literal">undefined</span>,</span><br><span class="line">      list: [],</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">    <span class="comment">// Should be a controlled component.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'value'</span> <span class="keyword">in</span> nextProps) &#123;</span><br><span class="line">      <span class="comment">// ----- mark------</span></span><br><span class="line">      <span class="keyword">const</span> value = nextProps.value;</span><br><span class="line">      <span class="keyword">if</span>(value === <span class="literal">undefined</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!value)&#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">current_value</span>: <span class="literal">null</span>&#125;);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">current_value</span>:<span class="built_in">String</span>(value)&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'list'</span> <span class="keyword">in</span> nextProps) &#123;</span><br><span class="line">      <span class="keyword">const</span> list = nextProps.list;</span><br><span class="line">      <span class="keyword">if</span>(list === <span class="literal">undefined</span>) <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;list&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> handleChange = <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;<span class="attr">current_value</span>:value&#125;);</span><br><span class="line">      <span class="comment">// ----- mark------</span></span><br><span class="line">      <span class="keyword">const</span> onChange = <span class="keyword">this</span>.props.onChange;</span><br><span class="line">      <span class="keyword">if</span> (onChange) &#123;</span><br><span class="line">        onChange(<span class="built_in">parseInt</span>(value));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123;list,value,...props&#125; = <span class="keyword">this</span>.props</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;span&gt;</span><br><span class="line">      &#123;<span class="keyword">this</span>.state.list.length &gt; <span class="number">0</span> &amp;&amp; &lt;Select</span><br><span class="line">        &#123;...props&#125;</span><br><span class="line">        defaultValue=&#123;this.state.current_value&#125;</span><br><span class="line">        onChange=&#123;handleChange&#125;</span><br><span class="line">        &gt;</span><br><span class="line">          &#123;this.state.list.map(function (object, i) &#123;</span><br><span class="line">            return &lt;Option value=&#123;String(object.id)&#125; key=&#123;i&#125;&gt;&#123;object.name&#125;&lt;/Option&gt;;</span><br><span class="line">          &#125;)&#125;</span><br><span class="line">        &lt;/Select&gt;&#125;</span><br><span class="line">      &lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">IDSelect.propTypes = &#123;</span></span><br><span class="line"><span class="regexp">  value: PropTypes.number,</span></span><br><span class="line"><span class="regexp">  list: PropTypes.arrayOf(PropTypes.object),</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">module.exports = &#123;</span></span><br><span class="line"><span class="regexp">  IDSelect,</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;FormItem&gt;</span><br><span class="line">  &#123;getFieldDecorator(<span class="string">'user_id'</span>, &#123;</span><br><span class="line">    initialValue: state.editType === <span class="string">'create'</span> ? <span class="literal">null</span> : data.user_id,</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        required: <span class="literal">true</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">  &#125;)(</span><br><span class="line">    &lt;IDSelect</span><br><span class="line">      disabled=&#123;state.editType !== <span class="string">'create'</span>&#125;</span><br><span class="line">      list=&#123;state.users&#125;</span><br><span class="line">    /&gt;</span><br><span class="line">  )&#125;</span><br><span class="line">&lt;<span class="regexp">/FormItem&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="提交"><a href="#提交" class="headerlink" title="提交"></a>提交</h2><p>提交时，使用<code>form.validateFields</code>做校验，参数中<code>values</code>就是包含所有表单参数的map,map的key是<code>getFieldDecorator</code>的第一个参数。<em>例如上面的user_id</em></p>
<p>某些控件返回的数据并非后端需要的格式（例如DatePicker返回一个moment，Select返回一个String类型的ID），在提交到后端的API之前，在这里做格式的转换</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> handleSubmit = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  e.preventDefault();</span><br><span class="line">  form.validateFields(<span class="function">(<span class="params">err, values</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">        <span class="comment">// do submit</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="校验"><a href="#校验" class="headerlink" title="校验"></a><a href="https://github.com/yiminghe/async-validator" target="_blank" rel="noopener">校验</a></h2><p>规则见<a href="https://github.com/yiminghe/async-validator" target="_blank" rel="noopener">https://github.com/yiminghe/async-validator</a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> checkCoordinate = <span class="function">(<span class="params">rule, value, callback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>(!parseCoordinate(value))&#123;</span><br><span class="line">    callback(<span class="string">"错误的经纬度"</span>);</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  callback();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&lt;FormItem&gt;</span><br><span class="line">  &#123;getFieldDecorator(<span class="string">'coordinate'</span>, &#123;</span><br><span class="line">    initialValue: state.editType === <span class="string">'create'</span> ? <span class="string">""</span> : <span class="built_in">String</span>(data.lng) + <span class="string">','</span> + <span class="built_in">String</span>(data.lat),</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        required: <span class="literal">true</span>,</span><br><span class="line">        min: <span class="number">1</span>,</span><br><span class="line">        max: <span class="number">64</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;<span class="attr">validator</span>: checkCoordinate&#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;)(&lt;Input placeholder="请输入经纬度" style=&#123;&#123;width: '100%'&#125;&#125;/&gt;)&#125;</span><br><span class="line">&lt;<span class="regexp">/FormItem&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  parseCoordinate:<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> values = value.split(<span class="string">","</span>);</span><br><span class="line">    <span class="keyword">if</span> (values.length !== <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        lng: <span class="built_in">parseFloat</span>(values[<span class="number">0</span>]),</span><br><span class="line">        lat: <span class="built_in">parseFloat</span>(values[<span class="number">1</span>])</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="layout"><a href="#layout" class="headerlink" title="layout"></a>layout</h2><p>form有个全局的layout，参见<a href="https://ant.design/components/form/#API" target="_blank" rel="noopener">form</a>的layout参数。<code>&#39;horizontal&#39;|&#39;vertical&#39;|&#39;inline&#39;</code></p>
<p>若需要嵌套（例如每个input一行，某些行有多个input)，则需要借助<a href="https://ant.design/components/grid/#Col" target="_blank" rel="noopener">Col</a>来控制<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;FormItem</span><br><span class="line">  label=<span class="string">"位置"</span></span><br><span class="line">  required</span><br><span class="line">  &#123;...formItemLayout&#125;</span><br><span class="line">&gt;</span><br><span class="line">  &lt;Col span=&#123;<span class="number">6</span>&#125;&gt;</span><br><span class="line">    &lt;FormItem&gt;</span><br><span class="line">      &#123;getFieldDecorator(<span class="string">'param1'</span>, &#123;</span><br><span class="line">        initialValue: state.editType === <span class="string">'create'</span> ? <span class="string">""</span> : data.param1,</span><br><span class="line">        rules: [</span><br><span class="line">          &#123;</span><br><span class="line">            required: <span class="literal">true</span>,</span><br><span class="line">            min: <span class="number">1</span>,</span><br><span class="line">            max: <span class="number">32</span></span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;)(&lt;Input style=&#123;&#123;width: '100%'&#125;&#125;/&gt;)&#125;</span><br><span class="line">    &lt;<span class="regexp">/FormItem&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>Col&gt;</span><br><span class="line">  &lt;Col span=&#123;<span class="number">6</span>&#125;&gt;</span><br><span class="line">    &lt;FormItem&gt;</span><br><span class="line">      &#123;getFieldDecorator(<span class="string">'param2'</span>, &#123;</span><br><span class="line">        initialValue: state.editType === <span class="string">'create'</span> ? <span class="string">""</span> : data.param2,</span><br><span class="line">        rules: [</span><br><span class="line">          &#123;</span><br><span class="line">            required: <span class="literal">true</span>,</span><br><span class="line">            type: <span class="string">"integer"</span></span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;)(&lt;InputNumber style=&#123;&#123;width: '100%'&#125;&#125;/&gt;)&#125;</span><br><span class="line">    &lt;<span class="regexp">/FormItem&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>Col&gt;</span><br><span class="line">&lt;<span class="regexp">/FormItem&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>关于required的红点</p>
<p>若某个表单是必选的，左边的label会有个红色的*。但是对于一行有多个表单（只有一个左侧的label）默认情况下，不会有</p>
<p>解决办法是（见上面代码）在最外层的FormItem加上<code>required</code>，内层的无需处理<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 一行多表单</span></span><br><span class="line">&lt;FormItem</span><br><span class="line">  label=<span class="string">"位置"</span></span><br><span class="line">  required</span><br><span class="line">  &#123;...formItemLayout&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<h1 id="富文本编辑器"><a href="#富文本编辑器" class="headerlink" title="富文本编辑器"></a>富文本编辑器</h1><p>官方推荐的<a href="https://github.com/leejaen/react-lz-editor" target="_blank" rel="noopener">react-lz-editor</a>相当不错，并且支持markdown和普通的<a href="https://baike.baidu.com/item/%E6%89%80%E8%A7%81%E5%8D%B3%E6%89%80%E5%BE%97/8721378?fr=aladdin&amp;fromid=190526&amp;fromtitle=WYSIWYG" target="_blank" rel="noopener">wysiwyg</a>模式，不过有一个需求（<code>粘贴富文本格式</code>)似乎满足不了,</p>
<p><a href="https://github.com/jpuri/react-draft-wysiwyg" target="_blank" rel="noopener">react-draft-wysiwyg</a>也是个不错的选择<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;Editor&#125; <span class="keyword">from</span> <span class="string">'react-draft-wysiwyg'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'react-draft-wysiwyg/dist/react-draft-wysiwyg.css'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EditorState, convertToRaw, ContentState, convertFromHTML &#125; <span class="keyword">from</span> <span class="string">'draft-js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> checkContent = <span class="function">(<span class="params">rule, value, callback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (value &amp;&amp; state.editorState) &#123;</span><br><span class="line">    <span class="keyword">const</span> content = draftToHtml(convertToRaw(state.editorState.getCurrentContent()));</span><br><span class="line">    <span class="keyword">if</span>(content.length &lt; <span class="number">9</span> || content.length &gt;= <span class="number">1024000</span>)&#123;</span><br><span class="line">      callback(<span class="string">"content must be between 2 and 1024000 characters\n"</span>);</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  callback();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> uploadImageCallBack = <span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(</span><br><span class="line">    (resolve, reject) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">      xhr.open(<span class="string">'POST'</span>, <span class="string">'/api/v1/upload'</span>);</span><br><span class="line">      <span class="keyword">const</span> data = <span class="keyword">new</span> FormData();</span><br><span class="line">      data.append(<span class="string">'file'</span>, file);</span><br><span class="line">      xhr.send(data);</span><br><span class="line">      xhr.addEventListener(<span class="string">'load'</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> response = <span class="built_in">JSON</span>.parse(xhr.responseText);</span><br><span class="line">        response = &#123; <span class="attr">data</span>: &#123; <span class="attr">link</span>: response.data.url,<span class="attr">alt</span>: <span class="string">"fasdf"</span> &#125; &#125;</span><br><span class="line">        resolve(response);</span><br><span class="line">      &#125;);</span><br><span class="line">      xhr.addEventListener(<span class="string">'error'</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> error = <span class="built_in">JSON</span>.parse(xhr.responseText);</span><br><span class="line">        reject(error);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> onEditorStateChange = <span class="function">(<span class="params">editorState</span>) =&gt;</span> &#123;</span><br><span class="line">  dispatch(&#123;</span><br><span class="line">    type: <span class="string">`<span class="subst">$&#123;pageKey&#125;</span>/updateState`</span>,</span><br><span class="line">    payload: &#123;</span><br><span class="line">      editorState</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&lt;Editor</span><br><span class="line">  editorState=&#123;state.editorState&#125;</span><br><span class="line">  wrapperClassName=<span class="string">"demo-wrapper"</span></span><br><span class="line">  editorClassName=<span class="string">"demo-editor"</span></span><br><span class="line">  toolbar=&#123;&#123;</span><br><span class="line">    image: &#123; <span class="attr">uploadCallback</span>: uploadImageCallBack, <span class="attr">alt</span>: &#123; <span class="attr">present</span>: <span class="literal">false</span>, <span class="attr">mandatory</span>: <span class="literal">false</span> &#125; &#125;,</span><br><span class="line">  &#125;&#125;</span><br><span class="line">  onEditorStateChange=&#123;onEditorStateChange&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure></p>
<p>百度开源的<a href="http://ueditor.baidu.com/website/" target="_blank" rel="noopener">ueditor</a>非常完善,但是体积非常大，一个精简版<a href="http://ueditor.baidu.com/website/umeditor.html" target="_blank" rel="noopener">UMeditor</a></p>
<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a><a href="https://ant.design/components/upload-cn/" target="_blank" rel="noopener">文件上传</a></h1><p>以下代码配合后端上传接口实现</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123;Upload&#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; <span class="keyword">from</span> <span class="string">'dva'</span></span><br><span class="line"><span class="keyword">import</span> &#123; config &#125; <span class="keyword">from</span> <span class="string">'../utils'</span></span><br><span class="line"><span class="keyword">import</span> &#123;Icon&#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UploadButton = <span class="function"><span class="params">()</span> =&gt;</span> (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;Icon type=<span class="string">"plus"</span> /&gt;</span><br><span class="line">    &lt;div className=<span class="string">"ant-upload-text"</span>&gt;点击上传&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>div&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> handleChange = <span class="function">(<span class="params">count</span>) =&gt;</span> <span class="function">(<span class="params">fileList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 1. Limit the number of uploaded files</span></span><br><span class="line">  <span class="comment">//    Only to show two recent uploaded files, and old ones will be replaced by the new</span></span><br><span class="line">  fileList = fileList.slice(-count);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. filter successfully uploaded files according to response from server</span></span><br><span class="line">  fileList = fileList.filter(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (file.response) &#123;</span><br><span class="line">      <span class="keyword">if</span> (file.response.code !== <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. read from response and show file link</span></span><br><span class="line">  fileList = fileList.map(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (file.response) &#123;</span><br><span class="line">      <span class="comment">// Component will show file.url as link</span></span><br><span class="line">      file.url = file.response.data.url;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> file;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fileList</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> handleOneChange = <span class="function">(<span class="params">fileList</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> handleChange(<span class="number">1</span>)(fileList);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> normOneFile = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> res = e;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(e)) &#123;</span><br><span class="line">    res = e;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res = e.fileList</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (res.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> res[<span class="number">0</span>].url;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> normFile = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> res = e;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(e)) &#123;</span><br><span class="line">    res = e;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res = e.fileList</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (res.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> res.map(<span class="function"><span class="keyword">function</span>(<span class="params">object, i</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> object.url</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageUploader</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> value = <span class="keyword">this</span>.props.value || [];</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      images: value</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">    <span class="comment">// Should be a controlled component.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'value'</span> <span class="keyword">in</span> nextProps &amp;&amp; !!nextProps.value) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = nextProps.value;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 排除uploading的</span></span><br><span class="line">      <span class="keyword">if</span>(!value) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">        images: [</span><br><span class="line">          &#123;</span><br><span class="line">            uid: <span class="number">-1</span>,</span><br><span class="line">            name: <span class="string">'test.png'</span>,</span><br><span class="line">            status: <span class="string">'done'</span>,</span><br><span class="line">            url: value</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> handleChangeImp = <span class="function">(<span class="params">info</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = handleOneChange(info.fileList)</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;<span class="attr">images</span>: res&#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> onChange = <span class="keyword">this</span>.props.onChange;</span><br><span class="line">      <span class="keyword">if</span> (onChange) &#123;</span><br><span class="line">        onChange(res);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (&lt;span&gt;</span><br><span class="line">      &lt;Upload name="file" listType="picture-card" </span><br><span class="line">        fileList=&#123;this.state.images&#125; onChange=&#123;handleChangeImp&#125; action="/api/v1/upload"&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          this.state.images.length &gt;= 1</span><br><span class="line">            ? null</span><br><span class="line">            : &lt;UploadButton/&gt;</span><br><span class="line">        &#125;</span><br><span class="line">      &lt;/Upload&gt;</span><br><span class="line">    &lt;/span&gt;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageMultiUploader</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> value = <span class="keyword">this</span>.props.value || [];</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      images: value</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">    <span class="comment">// Should be a controlled component.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'value'</span> <span class="keyword">in</span> nextProps &amp;&amp; !!nextProps.value) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = nextProps.value;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 排除uploading的</span></span><br><span class="line">      <span class="keyword">const</span> newValue = value.filter(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (!item);</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">if</span>(newValue.length &gt; <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> image_urls = [];</span><br><span class="line">      value.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item, index</span>) </span>&#123;</span><br><span class="line">        image_urls.push(&#123;</span><br><span class="line">          uid: -(index + <span class="number">1</span>),</span><br><span class="line">          name: <span class="string">'test'</span> + index + <span class="string">'.png'</span>,</span><br><span class="line">          status: <span class="string">'done'</span>,</span><br><span class="line">          url: item</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;<span class="attr">images</span>: image_urls&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> handleChangeImp = <span class="function">(<span class="params">count</span>) =&gt;</span> <span class="function">(<span class="params">info</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = handleChange(count)(info.fileList)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;<span class="attr">images</span>: res&#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> onChange = <span class="keyword">this</span>.props.onChange;</span><br><span class="line">      <span class="keyword">if</span> (onChange) &#123;</span><br><span class="line">        onChange(res);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (&lt;span&gt;</span><br><span class="line">      &lt;Upload name="file" listType="picture-card" fileList=&#123;this.state.images&#125; </span><br><span class="line">      onChange=&#123;handleChangeImp(this.props.maxImage)&#125; action="/api/v1/upload"&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          this.state.images.length &gt;= this.props.maxImage</span><br><span class="line">            ? null</span><br><span class="line">            : &lt;UploadButton/&gt;</span><br><span class="line">        &#125;</span><br><span class="line">      &lt;/Upload&gt;</span><br><span class="line">    &lt;/span&gt;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ImageUploader,</span><br><span class="line">  ImageMultiUploader,</span><br><span class="line">  normOneFile,</span><br><span class="line">  normFile</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;FormItem</span><br><span class="line">  &#123;...formItemLayout&#125;</span><br><span class="line">  label=<span class="string">"照片"</span></span><br><span class="line">&gt;</span><br><span class="line">  &#123;getFieldDecorator(<span class="string">'image_url'</span>, &#123;</span><br><span class="line">    initialValue: state.editType === <span class="string">'create'</span> ? <span class="string">""</span> : data.image_url,</span><br><span class="line">    getValueFromEvent: normOneFile,</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        required: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;)(</span><br><span class="line">    &lt;ImageUploader /&gt;</span><br><span class="line">  )&#125;</span><br><span class="line">&lt;<span class="regexp">/FormItem&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="一些不错的三方库"><a href="#一些不错的三方库" class="headerlink" title="一些不错的三方库"></a>一些不错的三方库</h1><ol>
<li><a href="https://github.com/facebook/prop-types" target="_blank" rel="noopener">prop-types</a>,检查组件参数</li>
<li><a href="https://github.com/pillarjs/path-to-regexp" target="_blank" rel="noopener">path-to-regexp</a>,url工具库</li>
<li><a href="https://github.com/nfl/react-helmet" target="_blank" rel="noopener">react-helmet</a>,设置title以及头部信息</li>
<li><a href="https://github.com/rstacruz/nprogress" target="_blank" rel="noopener">nprogress</a>,加载进度条，和dva-loading配合使用</li>
<li><a href="https://github.com/axios/axios" target="_blank" rel="noopener">axios</a>,基于promise的http客户端库，dva-admin实现了一个比较完善的<a href="https://github.com/zuiidea/antd-admin/blob/master/src/utils/request.js" target="_blank" rel="noopener">request函数</a></li>
<li><a href="https://github.com/sindresorhus/query-string" target="_blank" rel="noopener">query-string</a>，解析url查询参数</li>
<li><a href="https://github.com/ElemeFE/react-amap" target="_blank" rel="noopener">react-amap</a>，高德地图</li>
<li><a href="https://github.com/alexei/sprintf.js/" target="_blank" rel="noopener">sprintf.js</a>,类似于C printf的占位符打印实现</li>
<li><a href="https://github.com/kaivi/ReactInlineEdit" target="_blank" rel="noopener">ReactInlineEdit</a>,双击编辑控件</li>
<li><a href="https://github.com/ljharb/qs" target="_blank" rel="noopener">qs</a>,A querystring parser with nesting support</li>
<li><a href="https://github.com/lodash/lodash" target="_blank" rel="noopener">lodash</a>,工具库</li>
<li>其他<a href="https://ant.design/docs/react/recommendation-cn" target="_blank" rel="noopener">https://ant.design/docs/react/recommendation-cn</a></li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (lastHref !== href) &#123;</span><br><span class="line">  NProgress.start()</span><br><span class="line">  <span class="keyword">if</span> (!loading.global) &#123;</span><br><span class="line">    NProgress.done()</span><br><span class="line">    lastHref = href</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="日期"><a href="#日期" class="headerlink" title="日期"></a>日期</h1><p>antd使用moment作为日期处理库</p>
<p>获取当月/指定月的区间</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Moment <span class="keyword">from</span> <span class="string">'moment'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getMonthDateRange = <span class="function">(<span class="params">param</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> startDate = Moment([param.year(), param.month()]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clone the value before .endOf()</span></span><br><span class="line">  <span class="keyword">const</span> endDate = Moment(startDate).endOf(<span class="string">'month'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// make sure to call toDate() for plain JavaScript date type</span></span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">from</span>: startDate, <span class="attr">to</span>: endDate &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getCurMonthRange = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> getMonthDateRange(Moment())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getMonthDateRange,</span><br><span class="line">  getCurMonthRange,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="DatePicker"><a href="#DatePicker" class="headerlink" title="DatePicker"></a><a href="https://ant.design/components/date-picker/" target="_blank" rel="noopener">DatePicker</a></h2><p>最新的DatePicker输入输出都是一个moment对象，下面的代码做了个处理，输入输出都是如<code>2017-12-04</code>的这种格式</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123;DatePicker&#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; <span class="keyword">from</span> <span class="string">'dva'</span></span><br><span class="line"><span class="keyword">import</span> &#123;config&#125; <span class="keyword">from</span> <span class="string">'../utils'</span></span><br><span class="line"><span class="keyword">import</span> &#123;Icon&#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"><span class="keyword">import</span> moment <span class="keyword">from</span> <span class="string">'moment'</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span>;</span><br><span class="line"><span class="keyword">const</span> RangePicker = DatePicker.RangePicker;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringDatePicker</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> value = <span class="keyword">this</span>.props.value || [];</span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      current_value: <span class="literal">undefined</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">    <span class="comment">// Should be a controlled component.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'value'</span> <span class="keyword">in</span> nextProps) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = nextProps.value;</span><br><span class="line">      <span class="keyword">if</span>(value === <span class="literal">undefined</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!value)&#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">current_value</span>: <span class="literal">null</span>&#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> current_value = moment(value, <span class="string">'YYYY-MM-DD'</span>)</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;current_value&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> handleChange = <span class="function">(<span class="params">value, dateString</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> current_value = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">if</span>(!!value)&#123;</span><br><span class="line">        current_value = value.format(<span class="string">'YYYY-MM-DD'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">        current_value</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> onChange = <span class="keyword">this</span>.props.onChange;</span><br><span class="line">      <span class="keyword">if</span> (onChange) &#123;</span><br><span class="line">        onChange(current_value);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;span&gt;</span><br><span class="line">      &#123;<span class="keyword">this</span>.state.current_value !== <span class="literal">undefined</span> &amp;&amp; &lt;DatePicker</span><br><span class="line">        defaultValue=&#123;this.state.current_value&#125;</span><br><span class="line">        onChange=&#123;handleChange&#125;</span><br><span class="line">        showToday=&#123;true&#125;</span><br><span class="line">      /&gt;&#125;</span><br><span class="line">      &lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">StringDatePicker.propTypes = &#123;</span></span><br><span class="line"><span class="regexp">  value: PropTypes.string</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">class StringRangePicker extends React.Component &#123;</span></span><br><span class="line"><span class="regexp">  constructor(props) &#123;</span></span><br><span class="line"><span class="regexp">    super(props);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    const value = this.props.value || [];</span></span><br><span class="line"><span class="regexp">    this.state = &#123;</span></span><br><span class="line"><span class="regexp">      current_value: undefined</span></span><br><span class="line"><span class="regexp">    &#125;;</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  componentWillReceiveProps(nextProps) &#123;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ Should be a controlled component.</span></span><br><span class="line"><span class="regexp">    if ('value' in nextProps) &#123;</span></span><br><span class="line"><span class="regexp">      const value = nextProps.value;</span></span><br><span class="line"><span class="regexp">      if(value === undefined) return</span></span><br><span class="line"><span class="regexp">      if(!!value &amp;&amp; value.length &gt; 0)&#123;</span></span><br><span class="line"><span class="regexp">        const newValue = value.filter(function(item) &#123;</span></span><br><span class="line"><span class="regexp">          return (!!item);</span></span><br><span class="line"><span class="regexp">        &#125;);</span></span><br><span class="line"><span class="regexp">        if(newValue.length !== value.length)</span></span><br><span class="line"><span class="regexp">          return;</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">      if (!value)&#123;</span></span><br><span class="line"><span class="regexp">        this.setState(&#123;current_value: []&#125;);</span></span><br><span class="line"><span class="regexp">        return;</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">      const current_value = value.map(item=&gt;moment(item, 'YYYY-MM-DD'))</span></span><br><span class="line"><span class="regexp">      this.setState(&#123;current_value&#125;);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  render() &#123;</span></span><br><span class="line"><span class="regexp">    const handleChange = (value, dateString) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">      let current_value = null;</span></span><br><span class="line"><span class="regexp">      if(!!value)&#123;</span></span><br><span class="line"><span class="regexp">        current_value=value.map(item=&gt;item.format('YYYY-MM-DD'))</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">      this.setState(&#123;</span></span><br><span class="line"><span class="regexp">        current_value</span></span><br><span class="line"><span class="regexp">      &#125;)</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">      const onChange = this.props.onChange;</span></span><br><span class="line"><span class="regexp">      if (onChange) &#123;</span></span><br><span class="line"><span class="regexp">        onChange(current_value);</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    return (</span></span><br><span class="line"><span class="regexp">      &lt;span&gt;</span></span><br><span class="line"><span class="regexp">      &#123;this.state.current_value !== undefined &amp;&amp; &lt;RangePicker</span></span><br><span class="line"><span class="regexp">        defaultValue=&#123;this.state.current_value&#125;</span></span><br><span class="line"><span class="regexp">        onChange=&#123;handleChange&#125;</span></span><br><span class="line"><span class="regexp">        showToday=&#123;true&#125;</span></span><br><span class="line"><span class="regexp">      /</span>&gt;&#125;</span><br><span class="line">      &lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">StringRangePicker.propTypes = &#123;</span></span><br><span class="line"><span class="regexp">  value: PropTypes.arrayOf(PropTypes.string)</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">module.exports = &#123;</span></span><br><span class="line"><span class="regexp">  StringDatePicker,</span></span><br><span class="line"><span class="regexp">  StringRangePicker,</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>
<h1 id="高德地图"><a href="#高德地图" class="headerlink" title="高德地图"></a>高德地图</h1><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123;mapKey&#125; <span class="keyword">from</span> <span class="string">'../../utils/config'</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="built_in">Map</span>, Marker &#125; <span class="keyword">from</span> <span class="string">'react-amap'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> AMap = <span class="function">(<span class="params">&#123;lng,lat&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span>  plugins = [</span><br><span class="line">    <span class="string">'MapType'</span>,</span><br><span class="line">    <span class="string">'Scale'</span>,</span><br><span class="line">    <span class="string">'OverView'</span>,</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div style=&#123;&#123;<span class="attr">width</span>:<span class="string">"100%"</span>,<span class="attr">minHeight</span>:<span class="string">"400px"</span>&#125;&#125;&gt;</span><br><span class="line">      &lt;<span class="built_in">Map</span> amapkey=&#123;mapKey&#125;</span><br><span class="line">           plugins=&#123;plugins&#125;</span><br><span class="line">           zoom=&#123;<span class="number">15</span>&#125;</span><br><span class="line">           center=&#123;&#123;<span class="attr">longitude</span>: lng, <span class="attr">latitude</span>: lat&#125;&#125;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;Marker position=&#123;&#123;<span class="attr">longitude</span>: lng, <span class="attr">latitude</span>: lat&#125;&#125; /&gt;</span><br><span class="line">      &lt;<span class="regexp">/Map&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> AMap</span><br></pre></td></tr></table></figure>
<h1 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a>Layout</h1><p>一个常见的管理系统后台，通常都包含一些共有的组件，例如左侧<a href="https://ant.design/components/menu/" target="_blank" rel="noopener">菜单</a>入口，上面导航条，底部说明，<a href="https://ant.design/components/breadcrumb/" target="_blank" rel="noopener">面包屑菜单</a>等</p>
<p>antd admin的实现参考<a href="https://github.com/zuiidea/antd-admin/tree/master/src/components/Layout" target="_blank" rel="noopener">https://github.com/zuiidea/antd-admin/tree/master/src/components/Layout</a></p>
<p>antd admin通过route的一个简单设计，是的每个子页面都无需考虑这些在它外围的基础控件</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Routers = <span class="function"><span class="keyword">function</span> (<span class="params">&#123;history, app&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> error = dynamic(&#123;</span><br><span class="line">    app,</span><br><span class="line">    component: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./routes/error'</span>),</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> routes = [</span><br><span class="line">    &#123;</span><br><span class="line">      path: route.users,</span><br><span class="line">      models: <span class="function"><span class="params">()</span> =&gt;</span> [<span class="keyword">import</span>(<span class="string">'./models/user/index'</span>)],</span><br><span class="line">      component: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./routes/user/index'</span>),</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      path: route.userLogin,</span><br><span class="line">      component: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./routes/login/'</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;ConnectedRouter history=&#123;history&#125;&gt;</span><br><span class="line">      &lt;App&gt;</span><br><span class="line">        &lt;Switch&gt;</span><br><span class="line">          &lt;Route exact path=<span class="string">"/"</span> render=&#123;() =&gt; (&lt;Redirect to="/user"/&gt;)&#125;/&gt;</span><br><span class="line">          &#123;</span><br><span class="line">            routes.map(<span class="function">(<span class="params">&#123;path, ...dynamics&#125;, key</span>) =&gt;</span> (</span><br><span class="line">              &lt;Route key=&#123;key&#125;</span><br><span class="line">                     exact</span><br><span class="line">                     path=&#123;path&#125;</span><br><span class="line">                     component=&#123;dynamic(&#123;</span><br><span class="line">                       app,</span><br><span class="line">                       ...dynamics,</span><br><span class="line">                     &#125;)&#125;</span><br><span class="line">              /&gt;</span><br><span class="line">            ))</span><br><span class="line">          &#125;</span><br><span class="line">          &lt;Route component=&#123;error&#125;/&gt;</span><br><span class="line">        &lt;<span class="regexp">/Switch&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>App&gt;</span><br><span class="line">    &lt;<span class="regexp">/ConnectedRouter&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br></pre></td></tr></table></figure>
<p>所有的Page都包含在App Page里面</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* global window */</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> NProgress <span class="keyword">from</span> <span class="string">'nprogress'</span></span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span></span><br><span class="line"><span class="keyword">import</span> pathToRegexp <span class="keyword">from</span> <span class="string">'path-to-regexp'</span></span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'dva'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Layout, Loader &#125; <span class="keyword">from</span> <span class="string">'components'</span></span><br><span class="line"><span class="keyword">import</span> &#123; classnames, config &#125; <span class="keyword">from</span> <span class="string">'utils'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Helmet &#125; <span class="keyword">from</span> <span class="string">'react-helmet'</span></span><br><span class="line"><span class="keyword">import</span> &#123; withRouter &#125; <span class="keyword">from</span> <span class="string">'dva/router'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../themes/index.less'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./app.less'</span></span><br><span class="line"><span class="keyword">import</span> <span class="built_in">Error</span> <span class="keyword">from</span> <span class="string">'./error'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; prefix, openPages,name &#125; = config</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; Header, Bread, Footer, Sider, styles &#125; = Layout</span><br><span class="line"><span class="keyword">let</span> lastHref</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> App = <span class="function">(<span class="params">&#123; children, dispatch, app, loading, location &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 顶部进度条</span></span><br><span class="line">  <span class="keyword">if</span> (lastHref !== href) &#123;</span><br><span class="line">    NProgress.start()</span><br><span class="line">    <span class="keyword">if</span> (!loading.global) &#123;</span><br><span class="line">      NProgress.done()</span><br><span class="line">      lastHref = href</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (openPages &amp;&amp; openPages.includes(pathname)) &#123;</span><br><span class="line">	<span class="comment">// 对于特殊的页面，比如login，直接返回Page内容，而不在外面包含公用的组件</span></span><br><span class="line">    <span class="keyword">return</span> (&lt;div&gt;</span><br><span class="line">      &lt;Loader fullScreen spinning=&#123;loading.effects['app/query']&#125; /&gt;</span><br><span class="line">      &#123;children&#125;</span><br><span class="line">    &lt;/div&gt;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &#123;<span class="comment">/* 全局的loading效果 */</span>&#125;</span><br><span class="line">      &lt;Loader fullScreen spinning=&#123;loading.effects[<span class="string">'app/query'</span>]&#125; /&gt;</span><br><span class="line">      &#123;<span class="comment">/* html title、配置等 */</span>&#125;</span><br><span class="line">      &lt;Helmet&gt;</span><br><span class="line">        &lt;title&gt;&#123; name &#125;&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">        &lt;meta name="viewport" content="width=device-width, initial-scale=1.0" /</span>&gt;</span><br><span class="line">        &lt;link rel=<span class="string">"icon"</span> href=&#123;logo&#125; type=<span class="string">"image/x-icon"</span> /&gt;</span><br><span class="line">        &#123;iconFontJS &amp;&amp; &lt;script src=&#123;iconFontJS&#125; /&gt;&#125;</span><br><span class="line">        &#123;iconFontCSS &amp;&amp; &lt;link rel="stylesheet" href=&#123;iconFontCSS&#125; /&gt;&#125;</span><br><span class="line">      &lt;<span class="regexp">/Helmet&gt;</span></span><br><span class="line"><span class="regexp">      &lt;div className=&#123;classnames(styles.layout, &#123; [styles.fold]: isNavbar ? false : siderFold &#125;, &#123; [styles.withnavbar]: isNavbar &#125;)&#125;&gt;</span></span><br><span class="line"><span class="regexp">		/</span><span class="regexp">/ 侧边菜单</span></span><br><span class="line"><span class="regexp">        &#123;!isNavbar ? &lt;aside className=&#123;classnames(styles.sider, [styles.light])&#125;&gt;</span></span><br><span class="line"><span class="regexp">          &#123;siderProps.menu.length === 0 ? null : &lt;Sider &#123;...siderProps&#125; /</span>&gt;&#125;</span><br><span class="line">        &lt;<span class="regexp">/aside&gt; : ''&#125;</span></span><br><span class="line"><span class="regexp">        &lt;div className=&#123;styles.main&#125;&gt;</span></span><br><span class="line"><span class="regexp">	      /</span><span class="regexp">/ 顶部导航</span></span><br><span class="line"><span class="regexp">          &lt;Header &#123;...headerProps&#125; /</span>&gt;</span><br><span class="line">	      <span class="comment">// 面包屑菜单</span></span><br><span class="line">          &lt;Bread &#123;...breadProps&#125; /&gt;</span><br><span class="line">		  <span class="comment">// 每个页面实际的内容</span></span><br><span class="line">          &lt;div className=&#123;styles.container&#125;&gt;</span><br><span class="line">            &lt;div className=&#123;styles.content&#125;&gt;</span><br><span class="line">              &#123;hasPermission ? children : &lt;Error /&gt;&#125;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>div&gt;</span><br><span class="line">          <span class="comment">// 底部说明</span></span><br><span class="line">          &lt;Footer /&gt;</span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>div&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default withRouter(connect((&#123; app, loading &#125;) =&gt; (&#123; app, loading &#125;))(App))</span></span><br></pre></td></tr></table></figure>
<p>这种设计的好处是可以利用App的model处理一些通用的东西，比如</p>
<p>全局的错误监听(models/app.js)<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">setup(&#123;dispatch, history&#125;) &#123;</span><br><span class="line">  <span class="comment">// Add a response interceptor</span></span><br><span class="line">  axios.interceptors.response.use(<span class="function"><span class="keyword">function</span> (<span class="params">response</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Do something with response data</span></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;response&#125; = error</span><br><span class="line">  <span class="keyword">let</span> msg;</span><br><span class="line">  <span class="keyword">let</span> statusCode;</span><br><span class="line">  <span class="keyword">if</span> (response &amp;&amp; response <span class="keyword">instanceof</span> <span class="built_in">Object</span>) &#123;</span><br><span class="line">    statusCode = response.status</span><br><span class="line">    <span class="keyword">if</span> (statusCode === <span class="number">401</span>) &#123;</span><br><span class="line">      <span class="comment">// Do something with response error</span></span><br><span class="line">      dispatch(&#123;</span><br><span class="line">        type: <span class="string">'unauthorized'</span>,</span><br><span class="line">        payload: error,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>添加路径/路由信息，以及处理一些自动的跳转（登录成功后，存在cookie访问login页面等）<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">history.listen(<span class="function">(<span class="params">location</span>) =&gt;</span> &#123;</span><br><span class="line">  dispatch(&#123;</span><br><span class="line">    type: <span class="string">'updateState'</span>,</span><br><span class="line">    payload: &#123;</span><br><span class="line">      locationPathname: location.pathname,</span><br><span class="line">      locationQuery: queryString.parse(location.search),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> match = pathToRegexp(route.userLoginCB).exec(location.pathname)</span><br><span class="line">  <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">    dispatch(&#123;<span class="attr">type</span>: <span class="string">'query'</span>&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>授权检查拦截<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">* query(&#123;</span><br><span class="line">          payload,</span><br><span class="line">        &#125;, &#123;call, put, select&#125;) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;locationPathname, locationQuery&#125; = <span class="keyword">yield</span> select(<span class="function"><span class="params">_</span> =&gt;</span> _.app);</span><br><span class="line">  <span class="comment">// 如果不是登录页，那么如果存在就不再查询</span></span><br><span class="line">  <span class="keyword">const</span> match = pathToRegexp(route.userLogin).exec(locationPathname);</span><br><span class="line">  <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;user&#125; = <span class="keyword">yield</span> select(<span class="function"><span class="params">_</span> =&gt;</span> _.app);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"id"</span> <span class="keyword">in</span> user) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;data&#125; = <span class="keyword">yield</span> call(query, payload);</span><br><span class="line">  <span class="keyword">if</span> (data) &#123;</span><br><span class="line">    <span class="keyword">const</span> menuData = <span class="keyword">yield</span> call(menusService.services.query);</span><br><span class="line">    <span class="keyword">let</span> user = data</span><br><span class="line">    <span class="keyword">let</span> menu = menuData.data;</span><br><span class="line">    <span class="keyword">let</span> visit = menu.map(<span class="function"><span class="params">item</span> =&gt;</span> item.id);</span><br><span class="line">    <span class="keyword">yield</span> put(&#123;</span><br><span class="line">      type: <span class="string">'updateState'</span>,</span><br><span class="line">      payload: &#123;</span><br><span class="line">        user,</span><br><span class="line">        menu,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (locationPathname === route.userLogin) &#123;</span><br><span class="line">      <span class="keyword">if</span> (locationQuery[<span class="string">"url"</span>]) &#123;</span><br><span class="line">        <span class="built_in">window</span>.location.assign(locationQuery[<span class="string">"url"</span>]);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">yield</span> put(routerRedux.replace(&#123;</span><br><span class="line">          pathname: indexPage,</span><br><span class="line">        &#125;))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config.openPages &amp;&amp; config.openPages.indexOf(locationPathname) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">yield</span> put(routerRedux.push(&#123;</span><br><span class="line">      pathname: route.userLogin,</span><br><span class="line">      search: queryString.stringify(&#123;</span><br><span class="line">        <span class="keyword">from</span>: locationPathname,</span><br><span class="line">      &#125;),</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">* unauthorized(action, &#123;put, select&#125;) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;locationPathname&#125; = <span class="keyword">yield</span> select(<span class="function"><span class="params">_</span> =&gt;</span> _.app)</span><br><span class="line">  <span class="keyword">if</span> (locationPathname !== route.userLogin) &#123;</span><br><span class="line">    <span class="keyword">yield</span> put(routerRedux.push(&#123;</span><br><span class="line">      pathname: route.userLogin,</span><br><span class="line">      search: queryString.stringify(&#123;</span><br><span class="line">        url: <span class="built_in">window</span>.location.href</span><br><span class="line">      &#125;),</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>当然一些全局的操作，比如logout处理，左侧菜单栏收房，面包屑菜单处理等也可以在这里一并处理好</p>
<h2 id="面包屑菜单"><a href="#面包屑菜单" class="headerlink" title="面包屑菜单"></a>面包屑菜单</h2><p>左侧导航菜单的内容，从后端拉取，后端可以根据权限返回有限的数据</p>
<p>antd-admin的实现见<a href="https://github.com/zuiidea/antd-admin/blob/master/src/components/Layout/Menu.js" target="_blank" rel="noopener">https://github.com/zuiidea/antd-admin/blob/master/src/components/Layout/Menu.js</a></p>
<p>输入的菜单数据是个数组，在前端组装一个树结构，由于后端通常也是一个配置来写这些菜单，数组结构抽象树结构很难理解，所以可以考虑将输入也接收树结构，利于后端编辑</p>
<p>为了适配面包屑菜单，后端返回的菜单数据，有一种<code>隐藏</code>item,这种item不显示在左边菜单，而仅仅用于面包屑菜单匹配</p>
<p>ant-admin的<a href="https://github.com/zuiidea/antd-admin/blob/master/src/components/Layout/Bread.js" target="_blank" rel="noopener">Bread</a>没有支持导航带参数的链接。比如</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[首页] =&gt; [用户列表] =&gt; [用户详情] =&gt; [用户编辑]</span><br></pre></td></tr></table></figure>
<p>一般的做法，用户详情/编辑的地址会有一个user_id，而不是固定的（例如用户列表这种）</p>
<p>基于<code>面包屑菜单所需要的参数在当前page中都存在</code>的假设，可以如下处理<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Breadcrumb, Icon &#125; <span class="keyword">from</span> <span class="string">'antd'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Link &#125; <span class="keyword">from</span> <span class="string">'react-router-dom'</span></span><br><span class="line"><span class="keyword">import</span> pathToRegexp <span class="keyword">from</span> <span class="string">'path-to-regexp'</span></span><br><span class="line"><span class="keyword">import</span> &#123; queryArray &#125; <span class="keyword">from</span> <span class="string">'utils'</span></span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">'./Bread.less'</span></span><br><span class="line"><span class="keyword">import</span> &#123;parseUrl,buildUrl&#125; <span class="keyword">from</span> <span class="string">'../../utils/url'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Bread = <span class="function">(<span class="params">&#123; menu, location &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 匹配当前路由</span></span><br><span class="line">  <span class="keyword">let</span> pathArray = []</span><br><span class="line">  <span class="keyword">let</span> current;</span><br><span class="line">  <span class="keyword">let</span> match;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> menu) &#123;</span><br><span class="line">    <span class="keyword">if</span> (menu[index].route) &#123;</span><br><span class="line">      match = pathToRegexp(menu[index].route).exec(location.pathname);</span><br><span class="line">      <span class="keyword">if</span>(match)&#123;</span><br><span class="line">        current = menu[index];</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> getPathArray = <span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    pathArray.unshift(item);</span><br><span class="line">    <span class="keyword">if</span> (item.pid) &#123;</span><br><span class="line">      getPathArray(queryArray(menu, item.pid, <span class="string">'id'</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!current) &#123;</span><br><span class="line">    pathArray.push(menu[<span class="number">0</span>] || &#123;</span><br><span class="line">      id: <span class="number">1</span>,</span><br><span class="line">      icon: <span class="string">'laptop'</span>,</span><br><span class="line">      name: <span class="string">'Dashboard'</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    pathArray.push(&#123;</span><br><span class="line">      id: <span class="number">404</span>,</span><br><span class="line">      name: <span class="string">'Not Found'</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    getPathArray(current)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 自动填充</span></span><br><span class="line">  <span class="keyword">if</span>(current)&#123;</span><br><span class="line">    <span class="keyword">const</span> urlDatas = parseUrl(location.pathname, current.route);</span><br><span class="line">    pathArray.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(item === current || !item.route) <span class="keyword">return</span>;</span><br><span class="line">      item.route2 = buildUrl(item.route,urlDatas)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 递归查找父级</span></span><br><span class="line">  <span class="keyword">const</span> breads = pathArray.map(<span class="function">(<span class="params">item, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> content = (</span><br><span class="line">      &lt;span&gt;&#123;item.icon</span><br><span class="line">        ? &lt;Icon type=&#123;item.icon&#125; style=&#123;&#123; marginRight: 4 &#125;&#125; /&gt;</span><br><span class="line">        : <span class="string">''</span>&#125;&#123;item.name&#125;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">    return (</span></span><br><span class="line"><span class="regexp">      &lt;Breadcrumb.Item key=&#123;key&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &#123;((pathArray.length - 1) !== key &amp;&amp; "route" in item)</span></span><br><span class="line"><span class="regexp">          ? &lt;Link to=&#123;item.route2 || '#'&#125;&gt;</span></span><br><span class="line"><span class="regexp">            &#123;content&#125;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>Link&gt;</span><br><span class="line">          : content&#125;</span><br><span class="line">      &lt;<span class="regexp">/Breadcrumb.Item&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;)</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;div className=&#123;styles.bread&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Breadcrumb&gt;</span></span><br><span class="line"><span class="regexp">        &#123;breads&#125;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>Breadcrumb&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">Bread.propTypes = &#123;</span></span><br><span class="line"><span class="regexp">  menu: PropTypes.array,</span></span><br><span class="line"><span class="regexp">  location: PropTypes.object,</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Bread</span></span><br></pre></td></tr></table></figure></p>
<h1 id="省市区"><a href="#省市区" class="headerlink" title="省市区"></a>省市区</h1><p>基于动态读取后端数据的省市区控件</p>
<p>数据来源<a href="https://gitee.com/nxs/nation-province-city-district" target="_blank" rel="noopener">腾讯地图LBS</a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123;Cascader&#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; <span class="keyword">from</span> <span class="string">'dva'</span></span><br><span class="line"><span class="keyword">import</span> &#123; config &#125; <span class="keyword">from</span> <span class="string">'../utils'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Geography</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.state = &#123;</span><br><span class="line">      options: [],</span><br><span class="line">      current_province: <span class="literal">null</span>,</span><br><span class="line">      current_city: <span class="literal">null</span>,</span><br><span class="line">      current_area: <span class="literal">null</span>,</span><br><span class="line">      default_value: <span class="literal">null</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  updateConfig()&#123;</span><br><span class="line">    <span class="keyword">let</span> options = [];</span><br><span class="line">    <span class="keyword">const</span> &#123;provinces,citys,areas&#125; = <span class="keyword">this</span>.props</span><br><span class="line">    <span class="keyword">const</span> state = <span class="keyword">this</span>.state</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!!provinces)&#123;</span><br><span class="line">      provinces.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">        options.push(&#123;</span><br><span class="line">          value: item.id,</span><br><span class="line">          label: item.fullname,</span><br><span class="line">          isLeaf: <span class="literal">false</span>,</span><br><span class="line">          type: <span class="string">'province'</span>,</span><br><span class="line">          data: item,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> currentCitys = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(!!state.current_province &amp;&amp; !!citys) &#123;</span><br><span class="line">      options.find(<span class="function"><span class="keyword">function</span>(<span class="params">province</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(province.value == state.current_province)&#123;</span><br><span class="line">          <span class="keyword">let</span> tmp_citys = []</span><br><span class="line">          citys.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">            tmp_citys.push(&#123;</span><br><span class="line">              value: item.id,</span><br><span class="line">              label: item.fullname,</span><br><span class="line">              isLeaf: <span class="literal">false</span>,</span><br><span class="line">              type: <span class="string">'city'</span>,</span><br><span class="line">              data: item,</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">          currentCitys = tmp_citys;</span><br><span class="line">          province.children = tmp_citys;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!!currentCitys &amp;&amp; !!state.current_city &amp;&amp; !!areas)&#123;</span><br><span class="line">      currentCitys.find(<span class="function"><span class="keyword">function</span>(<span class="params">city</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(city.value == state.current_city)&#123;</span><br><span class="line">          <span class="keyword">let</span> tmp_areas = []</span><br><span class="line">          areas.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">            tmp_areas.push(&#123;</span><br><span class="line">              value: item.id,</span><br><span class="line">              label: item.fullname,</span><br><span class="line">              isLeaf: <span class="literal">true</span>,</span><br><span class="line">              type: <span class="string">'area'</span>,</span><br><span class="line">              data: item,</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">          city.children = tmp_areas;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      options,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">    <span class="comment">// Should be a controlled component.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state.default_value === <span class="literal">null</span> &amp;&amp; <span class="string">'value'</span> <span class="keyword">in</span> nextProps) &#123;</span><br><span class="line">      <span class="keyword">let</span> value = nextProps.value</span><br><span class="line">      <span class="keyword">if</span>(!value)&#123;</span><br><span class="line">        value = []</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(value.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> newValue = value.filter(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> (!!item);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">if</span>(newValue.length !== value.length)</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.props.initGeography(value);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> current_province = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">let</span> current_city = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">let</span> current_area = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">if</span>(nextProps.value.length === <span class="number">3</span>)&#123;</span><br><span class="line">        current_province = nextProps.value[<span class="number">0</span>];</span><br><span class="line">        current_city = nextProps.value[<span class="number">1</span>];</span><br><span class="line">        current_area = nextProps.value[<span class="number">2</span>];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">        default_value: value,</span><br><span class="line">        current_province,</span><br><span class="line">        current_city,</span><br><span class="line">        current_area</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.state.default_value !== <span class="literal">null</span>)</span><br><span class="line">      <span class="keyword">this</span>.updateConfig()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span>  loadData = <span class="function">(<span class="params">selectedOptions</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> targetOption = selectedOptions[selectedOptions.length - <span class="number">1</span>];</span><br><span class="line">      targetOption.loading = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">if</span>(targetOption.type == <span class="string">'province'</span>)&#123;</span><br><span class="line">        <span class="keyword">this</span>.props.getCitys(targetOption.data);</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">          current_province: targetOption.data.id,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(targetOption.type == <span class="string">'city'</span>)&#123;</span><br><span class="line">        <span class="keyword">this</span>.props.getAreas(targetOption.data);</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">          current_city: targetOption.data.id,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      targetOption.loading = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> onChange = <span class="function">(<span class="params">value, selectedOptions</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(selectedOptions.length == <span class="number">3</span> || selectedOptions.length == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> onChange = <span class="keyword">this</span>.props.onChange;</span><br><span class="line">        <span class="keyword">if</span>(selectedOptions.length == <span class="number">3</span>)&#123;</span><br><span class="line">          <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">            current_province: selectedOptions[<span class="number">0</span>].data.id,</span><br><span class="line">            current_city: selectedOptions[<span class="number">1</span>].data.id,</span><br><span class="line">            current_area: selectedOptions[<span class="number">2</span>].data.id,</span><br><span class="line">          &#125;)</span><br><span class="line">          <span class="keyword">if</span> (onChange) &#123;</span><br><span class="line">            onChange(selectedOptions.map(<span class="function"><span class="params">x</span>=&gt;</span>x.data.id));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">            current_province: <span class="literal">null</span>,</span><br><span class="line">            current_city: <span class="literal">null</span>,</span><br><span class="line">            current_area: <span class="literal">null</span>,</span><br><span class="line">          &#125;)</span><br><span class="line">          <span class="keyword">if</span> (onChange) &#123;</span><br><span class="line">            onChange([]);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (&lt;span&gt;</span><br><span class="line">      &#123;(this.state.options.length &gt; 0 &amp;&amp; &lt;Cascader</span><br><span class="line">            defaultValue=&#123;this.state.default_value&#125;</span><br><span class="line">            onChange=&#123;onChange&#125;</span><br><span class="line">            options=&#123;this.state.options&#125;</span><br><span class="line">            loadData=&#123;loadData&#125;</span><br><span class="line">            changeOnSelect</span><br><span class="line">          /&gt;)&#125;</span><br><span class="line">    &lt;/span&gt;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  Geography</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可复用的model<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> modelExtend <span class="keyword">from</span> <span class="string">'dva-model-extend'</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> share <span class="keyword">from</span> <span class="string">'../services/share'</span></span><br><span class="line"><span class="keyword">import</span> &#123;model&#125; <span class="keyword">from</span> <span class="string">'./common'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> geographyModel = modelExtend(model, &#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    provinces: [],</span><br><span class="line">    citys: [],</span><br><span class="line">    areas: [],</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  effects: &#123;</span><br><span class="line">    * provinces(&#123;payload&#125;, &#123;call, put&#125;) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;data&#125; = <span class="keyword">yield</span> call(share.provinces, &#123;&#125;);</span><br><span class="line">      <span class="keyword">yield</span> put(&#123;</span><br><span class="line">        type: <span class="string">'updateState'</span>,</span><br><span class="line">        payload: &#123;</span><br><span class="line">          provinces: data,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    * citys(&#123;payload&#125;, &#123;call, put&#125;) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;data&#125; = <span class="keyword">yield</span> call(share.citys, payload);</span><br><span class="line">      <span class="keyword">yield</span> put(&#123;</span><br><span class="line">        type: <span class="string">'updateState'</span>,</span><br><span class="line">        payload: &#123;</span><br><span class="line">          citys: data,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    * areas(&#123;payload&#125;, &#123;call, put&#125;) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;data&#125; = <span class="keyword">yield</span> call(share.areas, payload);</span><br><span class="line">      <span class="keyword">yield</span> put(&#123;</span><br><span class="line">        type: <span class="string">'updateState'</span>,</span><br><span class="line">        payload: &#123;</span><br><span class="line">          areas: data,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    * selectProvince(&#123;payload&#125;, &#123;call, put&#125;) &#123;</span><br><span class="line">      <span class="keyword">yield</span> put(&#123;</span><br><span class="line">        type: <span class="string">'citys'</span>,</span><br><span class="line">        payload: payload[<span class="string">'id'</span>],</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">yield</span> put(&#123;</span><br><span class="line">        type: <span class="string">'updateState'</span>,</span><br><span class="line">        payload: &#123;</span><br><span class="line">          current_province: payload,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    * selectCity(&#123;payload&#125;, &#123;call, put&#125;) &#123;</span><br><span class="line">      <span class="keyword">yield</span> put(&#123;</span><br><span class="line">        type: <span class="string">'areas'</span>,</span><br><span class="line">        payload: payload[<span class="string">'id'</span>],</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">yield</span> put(&#123;</span><br><span class="line">        type: <span class="string">'updateState'</span>,</span><br><span class="line">        payload: &#123;</span><br><span class="line">          current_city: payload,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    * initGeography(&#123;payload&#125;, &#123;call, put&#125;) &#123;</span><br><span class="line">      <span class="keyword">let</span> res = <span class="keyword">yield</span> call(share.provinces, &#123;&#125;);</span><br><span class="line">      <span class="keyword">const</span> provinces = res.data</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 若没有默认值，只get省份列表</span></span><br><span class="line">      <span class="keyword">if</span>(!payload || payload.length != <span class="number">3</span>)&#123;</span><br><span class="line">        <span class="keyword">yield</span> put(&#123;</span><br><span class="line">          type: <span class="string">'updateState'</span>,</span><br><span class="line">          payload: &#123;</span><br><span class="line">            provinces,</span><br><span class="line">            citys: [],</span><br><span class="line">            areas: [],</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> province_id = <span class="built_in">parseInt</span>(payload[<span class="number">0</span>]);</span><br><span class="line">      <span class="keyword">const</span> city_id = <span class="built_in">parseInt</span>(payload[<span class="number">1</span>])</span><br><span class="line">      <span class="keyword">const</span> area_id = <span class="built_in">parseInt</span>(payload[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 默认省份是否匹配</span></span><br><span class="line">      <span class="keyword">let</span> current_province = <span class="literal">null</span>;</span><br><span class="line">      provinces.find(<span class="function"><span class="keyword">function</span>(<span class="params">province</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(province.id == province_id)&#123;</span><br><span class="line">          current_province = province;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">if</span>(!current_province) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 找到匹配的省份，get 市区</span></span><br><span class="line">      res = <span class="keyword">yield</span> call(share.citys, current_province.id);</span><br><span class="line">      <span class="keyword">const</span> citys = res.data</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> current_city = <span class="literal">null</span>;</span><br><span class="line">      citys.find(<span class="function"><span class="keyword">function</span>(<span class="params">city</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(city.id == city_id)&#123;</span><br><span class="line">          current_city = city;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">if</span>(!current_city) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      res = <span class="keyword">yield</span> call(share.areas, current_city.id);</span><br><span class="line">      <span class="keyword">const</span> areas = res.data</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> current_area = <span class="literal">null</span>;</span><br><span class="line">      areas.find(<span class="function"><span class="keyword">function</span>(<span class="params">area</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(area.id == area_id)&#123;</span><br><span class="line">          current_area = area;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">if</span>(!current_area) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">yield</span> put(&#123;</span><br><span class="line">        type: <span class="string">'updateState'</span>,</span><br><span class="line">        payload: &#123;</span><br><span class="line">          provinces,</span><br><span class="line">          citys,</span><br><span class="line">          areas,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  reducers: &#123;</span><br><span class="line">    clearGeography(state,&#123; payload &#125;) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        provinces: [],</span><br><span class="line">        citys: [],</span><br><span class="line">        areas: [],</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  geographyModel,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>使用</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> geographyProps = &#123;</span><br><span class="line">  provinces: state.provinces,</span><br><span class="line">  citys: state.citys,</span><br><span class="line">  areas: state.areas,</span><br><span class="line">  initGeography(item) &#123;</span><br><span class="line">    dispatch(&#123;</span><br><span class="line">      type: <span class="string">`<span class="subst">$&#123;pageKey&#125;</span>/initGeography`</span>,</span><br><span class="line">      payload: item</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  getCitys(item) &#123;</span><br><span class="line">    dispatch(&#123;</span><br><span class="line">      type: <span class="string">`<span class="subst">$&#123;pageKey&#125;</span>/selectProvince`</span>,</span><br><span class="line">      payload: item</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  getAreas (item) &#123;</span><br><span class="line">    dispatch(&#123;</span><br><span class="line">      type: <span class="string">`<span class="subst">$&#123;pageKey&#125;</span>/selectCity`</span>,</span><br><span class="line">      payload: item</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> modelExtend(geographyModel, &#123;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;FormItem</span><br><span class="line">  label=<span class="string">"位置"</span></span><br><span class="line">  required</span><br><span class="line">  &#123;...formItemLayout&#125;</span><br><span class="line">&gt;</span><br><span class="line">  &#123;getFieldDecorator(<span class="string">'geography'</span>, &#123;</span><br><span class="line">    initialValue: state.editType === <span class="string">'create'</span> ? <span class="string">""</span> : [data.province_code,data.city_code,data.area_code],</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        required: <span class="literal">true</span>,</span><br><span class="line">      &#125;],</span><br><span class="line">  &#125;)(</span><br><span class="line">    &lt;Geography &#123;...geographyProps&#125; /&gt;</span><br><span class="line">  )&#125;</span><br><span class="line">&lt;<span class="regexp">/FormItem&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/12/02/antd/" data-id="ckdbgbyv6000743po5xr7k99l" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/12/02/antd/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/antd/">antd</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-gorm" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/02/gorm/">gorm一些笔记</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/12/02/gorm/" class="article-date"><time datetime="2017-12-02T13:09:07.000Z" itemprop="datePublished">2017-12-02</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/学习笔记/">学习笔记</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>官网 <a href="https://github.com/jinzhu/gorm" target="_blank" rel="noopener">https://github.com/jinzhu/gorm</a></p>
<h2 id="数据表名"><a href="#数据表名" class="headerlink" title="数据表名"></a>数据表名</h2><p>gorm默认将golang基于<code>帕斯卡命名法</code>的model的类名转换成<code>下划线命名法</code>格式作为数据表名字</p>
<p>若不一致，可以实现类方法<code>TableName</code>方法<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(StoreLite)</span> <span class="title">TableName</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"stores"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个转换的方法有放开<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ToDBName convert string to db name</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ToDBName</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">string</span></span></span><br></pre></td></tr></table></figure></p>
<p>写个工具函数通过一个对象获取它的表名<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/jinzhu/gorm"</span></span><br><span class="line">	<span class="string">"github.com/jinzhu/inflection"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DBName</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	t := reflect.TypeOf(obj)</span><br><span class="line">	_, ok := t.MethodByName(<span class="string">"TableName"</span>)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123; <span class="comment">//没找到</span></span><br><span class="line">		<span class="keyword">if</span> t.Kind() == reflect.Ptr &#123;</span><br><span class="line">			t = t.Elem()</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> inflection.Plural(gorm.ToDBName(t.Name()))</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		v := reflect.ValueOf(obj).MethodByName(<span class="string">"TableName"</span>).Call([]reflect.Value&#123;&#125;)</span><br><span class="line">		<span class="keyword">return</span> v[<span class="number">0</span>].Interface().(<span class="keyword">string</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过外键关联查询时，会需要使用类名，参见<a href="http://jinzhu.me/gorm/associations.html#has-one" target="_blank" rel="noopener">http://jinzhu.me/gorm/associations.html#has-one</a><code>Related</code><br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// User has one CreditCard, UserID is the foreign key</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    gorm.Model</span><br><span class="line">    CreditCard   CreditCard</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CreditCard <span class="keyword">struct</span> &#123;</span><br><span class="line">    gorm.Model</span><br><span class="line">    UserID   <span class="keyword">uint</span></span><br><span class="line">    Number   <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> card CreditCard</span><br><span class="line">db.Model(&amp;user).Related(&amp;card, <span class="string">"CreditCard"</span>)</span><br></pre></td></tr></table></figure></p>
<p>go默认的反射的类名具有完整的包路径<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DBClassName</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	t := reflect.TypeOf(obj)</span><br><span class="line">	<span class="keyword">if</span> t.Kind() != reflect.Struct &#123;</span><br><span class="line">		t = t.Elem()</span><br><span class="line">	&#125;</span><br><span class="line">	name := filepath.Ext(t.String())</span><br><span class="line">	<span class="keyword">return</span> name[<span class="number">1</span>:]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Select"><a href="#Select" class="headerlink" title="Select"></a>Select</h2><p>gorm默认是<code>select(*)</code>,有些情况可能会导致较多的不必要数据传输和性能损耗。解决方案是<code>Select</code><br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">db.Select(<span class="string">"name, age"</span>).Find(&amp;users)</span><br><span class="line"><span class="comment">//// SELECT name, age FROM users;</span></span><br><span class="line"></span><br><span class="line">db.Select([]<span class="keyword">string</span>&#123;<span class="string">"name"</span>, <span class="string">"age"</span>&#125;).Find(&amp;users)</span><br><span class="line"><span class="comment">//// SELECT name, age FROM users;</span></span><br><span class="line"></span><br><span class="line">db.Table(<span class="string">"users"</span>).Select(<span class="string">"COALESCE(age,?)"</span>, <span class="number">42</span>).Rows()</span><br><span class="line"><span class="comment">//// SELECT COALESCE(age,'42') FROM users;</span></span><br></pre></td></tr></table></figure></p>
<p>在代码中写死列名不是个好办法<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 过滤出需要查询的字段，若json:"-"，则忽略之</span></span><br><span class="line"><span class="comment">// 背景： 默认情况下grom总是查询所有字段select(*)，而实际情况并不需要那么多</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FieldsFilter</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">	dbName := DBName(obj)</span><br><span class="line">	value := reflect.TypeOf(obj)</span><br><span class="line">	<span class="keyword">if</span> value.Kind() == reflect.Ptr &#123;</span><br><span class="line">		value = value.Elem()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> value.Kind() != reflect.Struct &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">"must be struct object"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> res []<span class="keyword">string</span></span><br><span class="line">	<span class="keyword">return</span> fieldFilterImp(value, res, dbName)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fieldFilterImp</span><span class="params">(t reflect.Type, res []<span class="keyword">string</span>, dbName <span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">	count := t.NumField()</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; count; i++ &#123;</span><br><span class="line">		field := t.Field(i)</span><br><span class="line">		<span class="keyword">if</span> field.Anonymous &#123;</span><br><span class="line">			res = fieldFilterImp(field.Type, res, dbName)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		tag := field.Tag.Get(<span class="string">"json"</span>)</span><br><span class="line">		name := parseTag(tag)</span><br><span class="line">		<span class="keyword">if</span> name == <span class="string">""</span> &#123;</span><br><span class="line">			name = field.Name</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> name == <span class="string">"-"</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		tag = field.Tag.Get(<span class="string">"field"</span>)</span><br><span class="line">		<span class="keyword">if</span> tag == <span class="string">"-"</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> tag != <span class="string">""</span> &#123;</span><br><span class="line">			res = <span class="built_in">append</span>(res, tag)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 考虑到join之后可能有列的重名，所以加上db name</span></span><br><span class="line">			res = <span class="built_in">append</span>(res, fmt.Sprintf(<span class="string">"%s.%s"</span>, dbName, name))</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="记录不存在的错误"><a href="#记录不存在的错误" class="headerlink" title="记录不存在的错误"></a>记录不存在的错误</h2><p>当查询不存在时，同样返回错误，通过函数<code>RecordNotFound</code>判断是否属于这种情况</p>
<h2 id="Count"><a href="#Count" class="headerlink" title="Count"></a>Count</h2><p>gorm默认使用<code>select count(*)</code>，相比select count(‘id’)效率低那么一点，可以优化</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetObjectCount</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;, db *gorm.DB)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> cnt <span class="keyword">int</span></span><br><span class="line">	temp_db := db.Model(obj).Select(<span class="string">"count(\"id\") as count"</span>).Count(&amp;cnt)</span><br><span class="line">	<span class="keyword">if</span> temp_db.Error != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, temp_db.Error</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> cnt, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="更新部分"><a href="#更新部分" class="headerlink" title="更新部分"></a>更新部分</h2><p>可以使用<code>Select/Omit</code>来选择/排除更新的列</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">db.Model(&amp;user).Select(<span class="string">"name"</span>).Updates(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">	<span class="string">"name"</span>: <span class="string">"hello"</span>, <span class="string">"age"</span>: <span class="number">18</span>, <span class="string">"actived"</span>: <span class="literal">false</span>&#125;)</span><br><span class="line"><span class="comment">//// UPDATE users SET name='hello',</span></span><br><span class="line"><span class="comment">//  updated_at='2013-11-17 21:34:10' WHERE id=111;</span></span><br><span class="line"></span><br><span class="line">db.Model(&amp;user).Omit(<span class="string">"name"</span>).Updates(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">	<span class="string">"name"</span>: <span class="string">"hello"</span>, <span class="string">"age"</span>: <span class="number">18</span>, <span class="string">"actived"</span>: <span class="literal">false</span>&#125;)</span><br><span class="line"><span class="comment">//// UPDATE users SET age=18, actived=false,</span></span><br><span class="line"><span class="comment">//  updated_at='2013-11-17 21:34:10' WHERE id=111;</span></span><br></pre></td></tr></table></figure>
<p>同样利用上面的工具函数，可以过滤可更新的列 数据</p>
<h2 id="批量更新"><a href="#批量更新" class="headerlink" title="批量更新"></a>批量更新</h2><p>当需要一并插入多条数据，sql批量插入的写法比较省<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tbl_name</span><br><span class="line">    (a,b,c)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">    (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>),</span><br><span class="line">    (<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>),</span><br><span class="line">    (<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>);</span><br></pre></td></tr></table></figure></p>
<p>不过gorm目前不支持<a href="https://github.com/jinzhu/gorm/issues/255" target="_blank" rel="noopener">https://github.com/jinzhu/gorm/issues/255</a></p>
<h2 id="last-insert-id"><a href="#last-insert-id" class="headerlink" title="last_insert_id"></a>last_insert_id</h2><p>gorm自动实现了<code>last_insert_id</code>,即便在事务模式下，后面的sql都可以直接取ID</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">tmpDB := gd.DB.Begin()</span><br><span class="line"><span class="keyword">if</span> err := service.CreateObject(apartment, tmpDB); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	tmpDB.Rollback()</span><br><span class="line">	util.ResponseDbError(http.StatusOK, c, err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> param.ImageUrls &#123;</span><br><span class="line">	img := &amp;model.ApartmentImage&#123;</span><br><span class="line">		ApartmentID: apartment.ID,</span><br><span class="line">		Sequence:    <span class="keyword">uint8</span>(k + <span class="number">1</span>),</span><br><span class="line">		ImageUrl:    v,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := service.CreateObject(img, tmpDB); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tmpDB.Rollback()</span><br><span class="line">		util.ResponseDbError(http.StatusOK, c, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tmpDB.Commit()</span><br></pre></td></tr></table></figure>
<h2 id="软删除"><a href="#软删除" class="headerlink" title="软删除"></a>软删除</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    gorm.Model</span><br><span class="line">    Birthday     time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// gorm源码</span></span><br><span class="line"><span class="keyword">type</span> Model <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID        <span class="keyword">uint</span> <span class="string">`gorm:"primary_key"`</span></span><br><span class="line">	CreatedAt time.Time</span><br><span class="line">	UpdatedAt time.Time</span><br><span class="line">	DeletedAt *time.Time <span class="string">`sql:"index"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>grom确保自动更新CreatedAt/UpdatedAt，删除只会设置DeletedAt而不删除实际的数据</p>
<h2 id="打印sql"><a href="#打印sql" class="headerlink" title="打印sql"></a>打印sql</h2><p>打印gorm最终执行的sql对性能优化很有帮助<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// LogMode set log mode, `true` for detailed logs,</span></span><br><span class="line"><span class="comment">//  `false` for no log, default, will only print error logs</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *DB)</span> <span class="title">LogMode</span><span class="params">(enable <span class="keyword">bool</span>)</span> *<span class="title">DB</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> enable &#123;</span><br><span class="line">		s.logMode = <span class="number">2</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		s.logMode = <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="支持自定义对象"><a href="#支持自定义对象" class="headerlink" title="支持自定义对象"></a>支持自定义对象</h2><p>对于自定义类型变量，只需要实现<code>database/sql.Scanner</code>接口，参见<a href="https://github.com/jinzhu/gorm/issues/47" target="_blank" rel="noopener">https://github.com/jinzhu/gorm/issues/47</a></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> FmtDate <span class="keyword">struct</span> &#123;</span><br><span class="line">	Tm *time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	ctLayout = <span class="string">"2006-01-02 15:04:05"</span></span><br><span class="line">	cdLayout = <span class="string">"2006-01-02"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// sql.Scanner implementation to convert a time.Time column to a LocalDate</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ct *FmtDate)</span> <span class="title">Scan</span><span class="params">(value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> tm, ok := value.(time.Time); ok &#123;</span><br><span class="line">		ct.Tm = &amp;tm</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"invalid time.Time format"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sql/driver.Valuer implementation to go from LocalDate -&gt; time.Time</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ct FmtDate)</span> <span class="title">Value</span><span class="params">()</span> <span class="params">(driver.Value, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> ct.Tm != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ct.Tm.Format(cdLayout), <span class="literal">nil</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">""</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为了支持json(序列化、反序列化)，可以实现</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ct *FmtDate)</span> <span class="title">UnmarshalJSON</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	s := strings.Trim(<span class="keyword">string</span>(b), <span class="string">"\""</span>)</span><br><span class="line">	<span class="keyword">if</span> s == <span class="string">"null"</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"invalid date format"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	tm, err := time.Parse(cdLayout, s)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		ct.Tm = &amp;tm</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ct FmtDate)</span> <span class="title">MarshalJSON</span><span class="params">()</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> ct.Tm != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> []<span class="keyword">byte</span>(fmt.Sprintf(<span class="string">"\"%s\""</span>, ct.Tm.Format(cdLayout))), <span class="literal">nil</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> []<span class="keyword">byte</span>(<span class="string">"\"\""</span>), <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="自动解析时间"><a href="#自动解析时间" class="headerlink" title="自动解析时间"></a>自动解析时间</h2><p><a href="https://stackoverflow.com/questions/29341590/go-parse-time-from-database" target="_blank" rel="noopener">https://stackoverflow.com/questions/29341590/go-parse-time-from-database</a></p>
<p><a href="https://github.com/go-sql-driver/mysql#timetime-support" target="_blank" rel="noopener">https://github.com/go-sql-driver/mysql#timetime-support</a></p>
<p>The default internal output type of MySQL <code>DATE</code> and <code>DATETIME</code> values is <code>[]byte</code> which allows you to scan the value into a <code>[]byte</code>, <code>string</code> or <code>sql.RawBytes</code> variable in your program.</p>
<p>However, many want to scan MySQL <code>DATE</code> and <code>DATETIME</code> values into <code>time.Time</code> variables, which is the logical opposite in Go to <code>DATE</code> and <code>DATETIME</code> in MySQL. You can do that by changing the internal output type from <code>[]byte</code> to <code>time.Time</code> with the DSN parameter <code>parseTime=true</code>. You can set the default <a href="https://golang.org/pkg/time/#Location" target="_blank" rel="noopener"><code>time.Time</code> location</a> with the <code>loc</code> DSN parameter.</p>
<p><strong>Caution:</strong> As of Go 1.1, this makes <code>time.Time</code> the only variable type you can scan <code>DATE</code> and <code>DATETIME</code> values into. This breaks for example <a href="https://github.com/go-sql-driver/mysql/wiki/Examples#rawbytes" target="_blank" rel="noopener"><code>sql.RawBytes</code> support</a>.</p>
<p>Alternatively you can use the <a href="https://godoc.org/github.com/go-sql-driver/mysql#NullTime" target="_blank" rel="noopener"><code>NullTime</code></a> type as the scan destination, which works with both <code>time.Time</code> and <code>string</code> / <code>[]byte</code>.</p>
<h2 id="时区"><a href="#时区" class="headerlink" title="时区"></a>时区</h2><p>gorm（应该是go-sql-driver/mysql）会使用utc时间，结果就是明明用9点写入数据库，但数据库里面存的是1点（东八区）</p>
<p>解决办法有几种</p>
<p>设置driver的loc为local<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">db, err := gorm.Open(<span class="string">"mysql"</span>, </span><br><span class="line">	<span class="string">"db:dbadmin@tcp(127.0.0.1:3306)/foo?charset=utf8&amp;parseTime=true&amp;loc=Local"</span>)</span><br></pre></td></tr></table></figure></p>
<p>这样方案的好处是省事，不过在数据库中存当地时间，某些情况下（比如跨国家）会造成疑惑和bug，另一种变通的办法时，使用时间转成本地时间</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> FmtTime <span class="keyword">struct</span> &#123;</span><br><span class="line">	Tm *time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	ctLayout = <span class="string">"2006-01-02 15:04:05"</span></span><br><span class="line">	cdLayout = <span class="string">"2006-01-02"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ct *FmtTime)</span> <span class="title">UnmarshalJSON</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	s := strings.Trim(<span class="keyword">string</span>(b), <span class="string">"\""</span>)</span><br><span class="line">	<span class="keyword">if</span> s == <span class="string">"null"</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"invalid date format"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	tm, err := time.Parse(ctLayout, s)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		ct.Tm = &amp;tm</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ct *FmtTime)</span> <span class="title">MarshalJSON</span><span class="params">()</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> ct.Tm != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// 用本地时区输出</span></span><br><span class="line">		<span class="keyword">return</span> []<span class="keyword">byte</span>(fmt.Sprintf(<span class="string">"\"%s\""</span>, ct.Tm.In(time.Local).Format(ctLayout))), <span class="literal">nil</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> []<span class="keyword">byte</span>(<span class="string">"\"\""</span>), <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getMysqlUrl</span><span class="params">(c *config.Config)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">"%s:%s@tcp(%s:%d)/%s?charset=utf8&amp;parseTime=true"</span>,</span><br><span class="line">		c.MysqlUser,</span><br><span class="line">		c.MysqlPassword,</span><br><span class="line">		c.MysqlHost,</span><br><span class="line">		c.MysqlPort,</span><br><span class="line">		c.MysqlDb)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">OpenDB</span><span class="params">(c *config.Config)</span> <span class="params">(db *sql.DB, driver <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	driver = <span class="string">"mysql"</span></span><br><span class="line">	<span class="keyword">var</span> url <span class="keyword">string</span> = getMysqlUrl(c)</span><br><span class="line">	db, err := sql.Open(driver, url)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> driver == <span class="string">"mysql"</span> &#123;</span><br><span class="line">		<span class="comment">// per issue https://github.com/go-sql-driver/mysql/issues/257</span></span><br><span class="line">		db.SetMaxIdleConns(<span class="number">0</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := pingDatabase(db); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">		log.Fatalln(<span class="string">"ping 数据库"</span> + driver + <span class="string">"失败"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">OpenGorm</span><span class="params">(c *config.Config, driver <span class="keyword">string</span>)</span> <span class="params">(db *gorm.DB)</span></span> &#123;</span><br><span class="line">	url := getMysqlUrl(c)</span><br><span class="line">	db, err := gorm.Open(driver, url)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pingDatabase</span><span class="params">(db *sql.DB)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">		err = db.Ping()</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		log.Print(<span class="string">"ping 数据库失败, 1s后重试"</span>)</span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/12/02/gorm/" data-id="ckdbgbywe002m43po42ayk2kt" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/12/02/gorm/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gorm/">gorm</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-nginx-build" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/01/nginx-build/">nginx编译</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/12/01/nginx-build/" class="article-date"><time datetime="2017-12-01T11:31:39.000Z" itemprop="datePublished">2017-12-01</time></a>
</div>

    
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h1><p>从<a href="http://nginx.org/download/" target="_blank" rel="noopener">http://nginx.org/download/</a>下载nginx,最简单的用法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.9.9.tar.gz</span><br><span class="line">tar zvfx nginx-1.9.9.tar.gz</span><br><span class="line"><span class="built_in">cd</span> nginx-1.9.9.tar.gz</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">./obj/nginx</span><br></pre></td></tr></table></figure>
<p>考虑到nginx有各种配置和各种可选的模块，通常需要定制configure的参数，configure –help查看所有的选项</p>
<p>可以【<strong>nginx -V</strong>】查看现有nginx的编译参数，若configure过程中缺少某些库，自行安装(ubuntu apt-get即可)</p>
<p>例如<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./configure  --with-cc-opt=<span class="string">'-g -O2 -fPIE -fstack-protector-strong \</span></span><br><span class="line"><span class="string">    -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2'</span> \</span><br><span class="line">    --with-ld-opt=<span class="string">'-Wl,-Bsymbolic-functions -fPIE -pie -Wl,-z,relro \</span></span><br><span class="line"><span class="string">    -Wl,-z,now'</span> --prefix=/usr/share/nginx --conf-path=/etc/nginx/nginx.conf \</span><br><span class="line">    --http-log-path=/var/<span class="built_in">log</span>/nginx/access.log \</span><br><span class="line">    --error-log-path=/var/<span class="built_in">log</span>/nginx/error.log \</span><br><span class="line">    --lock-path=/var/lock/nginx.lock \</span><br><span class="line">    --pid-path=/run/nginx.pid \</span><br><span class="line">    --http-client-body-temp-path=/var/lib/nginx/body \</span><br><span class="line">    --http-fastcgi-temp-path=/var/lib/nginx/fastcgi \</span><br><span class="line">    --http-proxy-temp-path=/var/lib/nginx/proxy \</span><br><span class="line">    --http-scgi-temp-path=/var/lib/nginx/scgi \</span><br><span class="line">    --http-uwsgi-temp-path=/var/lib/nginx/uwsgi \</span><br><span class="line">    --with-debug --with-pcre-jit --with-ipv6 --with-http_ssl_module \</span><br><span class="line">    --with-http_stub_status_module --with-http_realip_module \</span><br><span class="line">    --with-http_auth_request_module --with-http_addition_module \</span><br><span class="line">    --with-http_gunzip_module --with-http_gzip_static_module \</span><br><span class="line">    --with-http_v2_module --with-http_sub_module --with-stream \</span><br><span class="line">    --with-stream_ssl_module --with-threads</span><br></pre></td></tr></table></figure></p>
<p>make之后，sudo ./objs/nginx 即可运行（background）模式</p>
<p>关闭nginx</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#从容停止Nginx </span></span><br><span class="line">sudo <span class="built_in">kill</span> -QUIT `pidof nginx | sed <span class="string">"s/ /\n/g"</span> | sort |  head -n 1`</span><br><span class="line"><span class="comment">#快速停止Nginx  </span></span><br><span class="line">sudo <span class="built_in">kill</span> -TERM `pidof nginx | sed <span class="string">"s/ /\n/g"</span> | sort |  head -n 1`</span><br><span class="line"><span class="comment">#强制停止Nginx</span></span><br><span class="line">sudo <span class="built_in">kill</span> -9 `pidof nginx | sed <span class="string">"s/ /\n/g"</span> | sort |  head -n 1`</span><br></pre></td></tr></table></figure>
<p>前台运行<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nginx -g <span class="string">'daemon off;'</span></span><br></pre></td></tr></table></figure></p>
<h1 id="编译第三方插件"><a href="#编译第三方插件" class="headerlink" title="编译第三方插件"></a>编译第三方插件</h1><p>随便挑一个<a href="https://www.nginx.com/resources/wiki/modules/fancy_index/" target="_blank" rel="noopener">https://www.nginx.com/resources/wiki/modules/fancy_index/</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加--add-module参数</span></span><br><span class="line">./configure ** --add-module=/tmp/ngx-fancyindex</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/aperezdc/ngx-fancyindex.git ngx-fancyindex</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;                                                                        </span><br><span class="line">	<span class="attribute">listen</span> <span class="number">8800</span>;</span><br><span class="line">	<span class="attribute">root</span>  /home/king/;</span><br><span class="line">	<span class="attribute">fancyindex</span> <span class="literal">on</span>;</span><br><span class="line">	<span class="attribute">fancyindex_exact_size</span> <span class="literal">off</span>;</span><br><span class="line">	<span class="attribute">fancyindex_localtime</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="OpenResty"><a href="#OpenResty" class="headerlink" title="OpenResty"></a>OpenResty</h1><p>安装 <a href="https://openresty.org/cn/installation.html" target="_blank" rel="noopener">https://openresty.org/cn/installation.html</a></p>
<p>可以安装预编译的二进制或者直接从源码编译</p>
<blockquote>
<p>OpenResty以nginx的方式发布，只不过和官方的使用不同的模块。由于两者的配置等各种依赖隔离，只要确保OpenResty和Nginx不端口冲突，就可和谐共生</p>
</blockquote>
<p>查看sudo make install 可以看到默认的安装路径<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">test</span> -f <span class="string">'/usr/local/openresty/nginx/conf/mime.types'</span> \</span><br><span class="line">	|| cp conf/mime.types <span class="string">'/usr/local/openresty/nginx/conf'</span></span><br><span class="line">cp conf/mime.types <span class="string">'/usr/local/openresty/nginx/conf/mime.types.default'</span></span><br><span class="line"><span class="built_in">test</span> -f <span class="string">'/usr/local/openresty/nginx/conf/fastcgi_params'</span> \</span><br><span class="line">	|| cp conf/fastcgi_params <span class="string">'/usr/local/openresty/nginx/conf'</span></span><br><span class="line">cp conf/fastcgi_params \</span><br><span class="line">	<span class="string">'/usr/local/openresty/nginx/conf/fastcgi_params.default'</span></span><br><span class="line"><span class="built_in">test</span> -f <span class="string">'/usr/local/openresty/nginx/conf/fastcgi.conf'</span> \</span><br><span class="line">	|| cp conf/fastcgi.conf <span class="string">'/usr/local/openresty/nginx/conf'</span></span><br><span class="line">cp conf/fastcgi.conf <span class="string">'/usr/local/openresty/nginx/conf/fastcgi.conf.default'</span></span><br><span class="line"><span class="built_in">test</span> -f <span class="string">'/usr/local/openresty/nginx/conf/uwsgi_params'</span> \</span><br><span class="line">	|| cp conf/uwsgi_params <span class="string">'/usr/local/openresty/nginx/conf'</span></span><br><span class="line">cp conf/uwsgi_params \</span><br><span class="line">	<span class="string">'/usr/local/openresty/nginx/conf/uwsgi_params.default'</span></span><br><span class="line"><span class="built_in">test</span> -f <span class="string">'/usr/local/openresty/nginx/conf/scgi_params'</span> \</span><br><span class="line">	|| cp conf/scgi_params <span class="string">'/usr/local/openresty/nginx/conf'</span></span><br><span class="line">cp conf/scgi_params \</span><br><span class="line">	<span class="string">'/usr/local/openresty/nginx/conf/scgi_params.default'</span></span><br><span class="line"><span class="comment"># 主配置</span></span><br><span class="line"><span class="built_in">test</span> -f <span class="string">'/usr/local/openresty/nginx/conf/nginx.conf'</span> \</span><br><span class="line">	|| cp conf/nginx.conf <span class="string">'/usr/local/openresty/nginx/conf/nginx.conf'</span></span><br><span class="line">cp conf/nginx.conf <span class="string">'/usr/local/openresty/nginx/conf/nginx.conf.default'</span></span><br><span class="line"><span class="built_in">test</span> -d <span class="string">'/usr/local/openresty/nginx/logs'</span> \</span><br><span class="line">	|| mkdir -p <span class="string">'/usr/local/openresty/nginx/logs'</span></span><br><span class="line"><span class="built_in">test</span> -d <span class="string">'/usr/local/openresty/nginx/logs'</span> \</span><br><span class="line">	|| mkdir -p <span class="string">'/usr/local/openresty/nginx/logs'</span></span><br><span class="line"><span class="built_in">test</span> -d <span class="string">'/usr/local/openresty/nginx/html'</span> \</span><br><span class="line">	|| cp -R docs/html <span class="string">'/usr/local/openresty/nginx'</span></span><br><span class="line"><span class="built_in">test</span> -d <span class="string">'/usr/local/openresty/nginx/logs'</span> \</span><br><span class="line"><span class="comment"># 日志</span></span><br><span class="line">	|| mkdir -p <span class="string">'/usr/local/openresty/nginx/logs'</span></span><br><span class="line">make[2]: Leaving directory <span class="string">'/tmp/openresty-1.13.6.1/build/nginx-1.13.6'</span></span><br><span class="line">make[1]: Leaving directory <span class="string">'/tmp/openresty-1.13.6.1/build/nginx-1.13.6'</span></span><br><span class="line"><span class="comment"># 二进制</span></span><br><span class="line">ln -sf /usr/<span class="built_in">local</span>/openresty/nginx/sbin/nginx /usr/<span class="built_in">local</span>/openresty/bin/openresty</span><br></pre></td></tr></table></figure></p>
<h2 id="网站统计中的数据收集原理及实现"><a href="#网站统计中的数据收集原理及实现" class="headerlink" title="网站统计中的数据收集原理及实现"></a><a href="http://blog.codinglabs.org/articles/how-web-analytics-data-collection-system-work.html" target="_blank" rel="noopener">网站统计中的数据收集原理及实现</a></h2><p>配置</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">	<span class="comment"># 创建名称为tick的日志格式（后面会引用）</span></span><br><span class="line">	<span class="attribute">log_format</span> tick <span class="string">"<span class="variable">$msec</span>^A<span class="variable">$remote_addr</span>^A<span class="variable">$u_domain</span>^A<span class="variable">$u_url</span>^A<span class="variable">$u_title</span>^A<span class="variable">$u_referrer</span>^A<span class="variable">$u_sh</span>^A<span class="variable">$u_sw</span>^A<span class="variable">$u_cd</span>^A<span class="variable">$u_lang</span>^A<span class="variable">$http_user_agent</span>^A<span class="variable">$u_utrace</span>^A<span class="variable">$u_account</span>"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="section">server</span> &#123;</span><br><span class="line">		<span class="attribute">listen</span> <span class="number">9088</span>;</span><br><span class="line">		<span class="attribute">index</span> index.html;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="attribute">location</span> /<span class="number">1</span>.gif &#123;</span><br><span class="line">			<span class="comment">#伪装成gif文件</span></span><br><span class="line">			<span class="attribute">default_type</span> image/gif;    </span><br><span class="line">			<span class="comment">#本身关闭access_log，通过subrequest记录log</span></span><br><span class="line">			<span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">			<span class="attribute">access_by_lua</span> <span class="string">"</span></span><br><span class="line"><span class="string">				-- 用户跟踪cookie名为__utrace</span></span><br><span class="line"><span class="string">				local uid = ngx.var.cookie___utrace        </span></span><br><span class="line"><span class="string">				if not uid then</span></span><br><span class="line"><span class="string">					-- 如果没有则生成一个跟踪cookie，算法为md5(时间戳+IP+客户端信息)</span></span><br><span class="line"><span class="string">					uid = ngx.md5(ngx.now() .. ngx.var.remote_addr .. ngx.var.http_user_agent)</span></span><br><span class="line"><span class="string">				end </span></span><br><span class="line"><span class="string">				ngx.header['Set-Cookie'] = &#123;'__utrace=' .. uid .. '; path=/'&#125;</span></span><br><span class="line"><span class="string">				if ngx.var.arg_domain then</span></span><br><span class="line"><span class="string">					-- 通过subrequest到/i-log记录日志，将参数和用户跟踪cookie带过去</span></span><br><span class="line"><span class="string">					ngx.location.capture('/i-log?' .. ngx.var.args .. '&amp;utrace=' .. uid)</span></span><br><span class="line"><span class="string">				end </span></span><br><span class="line"><span class="string">			"</span>;  </span><br><span class="line"></span><br><span class="line">			<span class="comment">#此请求不缓存</span></span><br><span class="line">			<span class="attribute">add_header</span> Expires <span class="string">"Fri, 01 Jan 1980 00:00:00 GMT"</span>;</span><br><span class="line">			<span class="attribute">add_header</span> Pragma <span class="string">"no-cache"</span>;</span><br><span class="line">			<span class="attribute">add_header</span> Cache-Control <span class="string">"no-cache, max-age=0, must-revalidate"</span>;</span><br><span class="line">			<span class="comment">#返回一个1×1的空gif图片</span></span><br><span class="line">			empty_gif;</span><br><span class="line">		&#125;   </span><br><span class="line"></span><br><span class="line">		<span class="attribute">location</span> /i-log &#123;</span><br><span class="line">			internal;</span><br><span class="line"></span><br><span class="line">			<span class="attribute">set_unescape_uri</span> <span class="variable">$u_domain</span> <span class="variable">$arg_domain</span>;</span><br><span class="line">			<span class="attribute">set_unescape_uri</span> <span class="variable">$u_url</span> <span class="variable">$arg_url</span>;</span><br><span class="line">			<span class="attribute">set_unescape_uri</span> <span class="variable">$u_title</span> <span class="variable">$arg_title</span>;</span><br><span class="line">			<span class="attribute">set_unescape_uri</span> <span class="variable">$u_referrer</span> <span class="variable">$arg_referrer</span>;</span><br><span class="line">			<span class="attribute">set_unescape_uri</span> <span class="variable">$u_sh</span> <span class="variable">$arg_sh</span>;</span><br><span class="line">			<span class="attribute">set_unescape_uri</span> <span class="variable">$u_sw</span> <span class="variable">$arg_sw</span>;</span><br><span class="line">			<span class="attribute">set_unescape_uri</span> <span class="variable">$u_cd</span> <span class="variable">$arg_cd</span>;</span><br><span class="line">			<span class="attribute">set_unescape_uri</span> <span class="variable">$u_lang</span> <span class="variable">$arg_lang</span>;</span><br><span class="line">			<span class="attribute">set_unescape_uri</span> <span class="variable">$u_utrace</span> <span class="variable">$arg_utrace</span>;</span><br><span class="line">			<span class="attribute">set_unescape_uri</span> <span class="variable">$u_account</span> <span class="variable">$arg_account</span>;</span><br><span class="line"></span><br><span class="line">			<span class="attribute">log_subrequest</span> <span class="literal">on</span>;</span><br><span class="line">			<span class="comment">#记录日志到ma.log，实际应用中最好加buffer，格式为tick</span></span><br><span class="line">			<span class="attribute">access_log</span> /tmp/ma.log tick;</span><br><span class="line"></span><br><span class="line">			<span class="attribute">echo</span> <span class="string">''</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>前端代码<br>cat /usr/local/openresty/nginx/html/ma.js<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> params = &#123;&#125;;</span><br><span class="line">    <span class="comment">//Document对象数据</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">document</span>) &#123;</span><br><span class="line">        params.domain = <span class="built_in">document</span>.domain || <span class="string">''</span>; </span><br><span class="line">        params.url = <span class="built_in">document</span>.URL || <span class="string">''</span>; </span><br><span class="line">        params.title = <span class="built_in">document</span>.title || <span class="string">''</span>; </span><br><span class="line">        params.referrer = <span class="built_in">document</span>.referrer || <span class="string">''</span>; </span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="comment">//Window对象数据</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">window</span> &amp;&amp; <span class="built_in">window</span>.screen) &#123;</span><br><span class="line">        params.sh = <span class="built_in">window</span>.screen.height || <span class="number">0</span>;</span><br><span class="line">        params.sw = <span class="built_in">window</span>.screen.width || <span class="number">0</span>;</span><br><span class="line">        params.cd = <span class="built_in">window</span>.screen.colorDepth || <span class="number">0</span>;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="comment">//navigator对象数据</span></span><br><span class="line">    <span class="keyword">if</span>(navigator) &#123;</span><br><span class="line">        params.lang = navigator.language || <span class="string">''</span>; </span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="comment">//解析_maq配置</span></span><br><span class="line">    <span class="keyword">if</span>(_maq) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> _maq) &#123;</span><br><span class="line">            <span class="keyword">switch</span>(_maq[i][<span class="number">0</span>]) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'_setAccount'</span>:</span><br><span class="line">                    params.account = _maq[i][<span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;   </span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="comment">//拼接参数串</span></span><br><span class="line">    <span class="keyword">var</span> args = <span class="string">''</span>; </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> params) &#123;</span><br><span class="line">        <span class="keyword">if</span>(args != <span class="string">''</span>) &#123;</span><br><span class="line">            args += <span class="string">'&amp;'</span>;</span><br><span class="line">        &#125;   </span><br><span class="line">        args += i + <span class="string">'='</span> + <span class="built_in">encodeURIComponent</span>(params[i]);</span><br><span class="line">    &#125;   </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//通过Image对象请求后端脚本</span></span><br><span class="line">    <span class="keyword">var</span> img = <span class="keyword">new</span> Image(<span class="number">1</span>, <span class="number">1</span>); </span><br><span class="line">    img.src = <span class="string">'/1.gif?'</span> + args;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></p>
<p>cat /usr/local/openresty/nginx/html/index.html<br><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Welcome to OpenResty!<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> _maq = _maq || [];</span></span><br><span class="line"><span class="javascript">_maq.push([<span class="string">'_setAccount'</span>, <span class="string">'网站标识'</span>]);</span></span><br><span class="line"> </span><br><span class="line"><span class="javascript">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> ma = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>); ma.type = <span class="string">'text/javascript'</span>; ma.async = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">    ma.src = <span class="string">'/ma.js'</span>;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> s = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'script'</span>)[<span class="number">0</span>]; s.parentNode.insertBefore(ma, s);</span></span><br><span class="line">&#125;)();</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to OpenResty!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>If you see this page, the OpenResty web platform is successfully installed and</span><br><span class="line">working. Further configuration is required.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>For online documentation and support please refer to</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"https://openresty.org/"</span>&gt;</span>openresty.org<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">em</span>&gt;</span>Thank you for flying OpenResty.<span class="tag">&lt;/<span class="name">em</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="http://blog.codinglabs.org/articles/how-web-analytics-data-collection-system-work.html" target="_blank" rel="noopener">http://blog.codinglabs.org/articles/how-web-analytics-data-collection-system-work.html</a></li>
</ol>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/12/01/nginx-build/" data-id="ckdbgbyx2003r43poj2ewl0ot" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/12/01/nginx-build/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/">nginx</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-kelly-src" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/18/kelly-src/">Kelly源码剖析</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/10/18/kelly-src/" class="article-date"><time datetime="2017-10-18T12:36:15.000Z" itemprop="datePublished">2017-10-18</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Golang/">Golang</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://github.com/qjw/kelly" target="_blank" rel="noopener">Kelly</a>是基于golang的一个简单的web框架</p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>作为web后端开发，标准的<a href="https://golang.org/pkg/net/http/" target="_blank" rel="noopener">net/http</a>非常高效灵活，足以适用非常多的场景，当然也有很多周边待补充，这就出现了各种web框架，甚至出现了替代默认的Http库的<a href="https://github.com/valyala/fasthttp" target="_blank" rel="noopener">valyala/fasthttp</a></p>
<p>golang目前百花齐放，个人主要了解到的是两个项目</p>
<ol>
<li><a href="https://beego.me/" target="_blank" rel="noopener">beego: simple &amp; powerful Go app framework</a></li>
<li><a href="https://github.com/gin-gonic/gin" target="_blank" rel="noopener">gin-gonic/gin</a></li>
</ol>
<p>beego没有实际用过，听说是大而全的项目，对开发者友好。不过由于了解甚少，草率评论并不合适，这里不作过多说明。</p>
<p>本着刨根问底的学习态度，最开始了解的是<a href="https://github.com/philsong/martini" target="_blank" rel="noopener">martini</a>，后查证效率偏低（大量用到<a href="https://golang.org/pkg/reflect/" target="_blank" rel="noopener">反射/reflect</a>），所以就进一步学习了<a href="https://github.com/gin-gonic/gin" target="_blank" rel="noopener">gin-gonic/gin</a>。</p>
<p>后者小巧灵活，学习成本低，并且提供了很多实用的补充，例如</p>
<ol>
<li>路由和中间件核心框架，路由基于<a href="https://github.com/julienschmidt/httprouter" target="_blank" rel="noopener">julienschmidt/httprouter</a></li>
<li>gin.Context</li>
<li>binding</li>
<li>校验，基于<a href="https://gopkg.in/go-playground/validator.v9" target="_blank" rel="noopener">go-playground/validator.v9</a></li>
<li>Http Request工具函数，获取param/path/form/header/cookie等</li>
<li>Http Response工具函数，设置cookie，header，返回xml/json，返回template支持等</li>
<li>内建的几个常用中间件</li>
</ol>
<p>martini/gin都包含非常多的中间件，两者迁移非常容易，参考</p>
<ol>
<li><a href="https://github.com/codegangsta/martini-contrib" target="_blank" rel="noopener">https://github.com/codegangsta/martini-contrib</a></li>
<li><a href="https://github.com/gin-gonic/contrib" target="_blank" rel="noopener">https://github.com/gin-gonic/contrib</a></li>
<li><a href="https://github.com/gin-contrib" target="_blank" rel="noopener">https://github.com/gin-contrib</a></li>
</ol>
<p>用久了，也发现gin也有一些问题</p>
<ol>
<li>依赖还是偏多（<em>虽然和很多库相比算较少的</em>），就写个hello world都下载半天依赖</li>
<li>第三方middleware有的依赖gopkg.in的代码，另外一些依赖github.com的代码</li>
<li>gin.Context对Golang标准库<a href="https://golang.org/pkg/context/" target="_blank" rel="noopener">context</a>不友好</li>
<li>binding有一些问题，本人的优化版本在<a href="https://github.com/qjw/go-gin-binding" target="_blank" rel="noopener">https://github.com/qjw/go-gin-binding</a></li>
<li>虽然middleware很多，但选择性太多，质量参差不齐，不好选择，另外太多的第三方依赖不如将大部分常用的集成到一起来的方便。</li>
</ol>
<p>经过多方对比考察，认为<a href="https://github.com/urfave/negroni" target="_blank" rel="noopener">urfave/negroni</a>作为路由/中间件基础框架非常合适，（<em>看看原型就知道他对<a href="https://golang.org/pkg/context/" target="_blank" rel="noopener">context</a>有多友好</em>）所以折腾就开始了。</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">  ServeHTTP(rw http.ResponseWriter, r *http.Request, next http.HandlerFunc)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过综合评估，决定自己弄个类似于gin的框架</p>
<p>原则是尽量踏着巨人的肩膀，避免一些通用组件重复造轮子，聚焦于优秀智慧的集成</p>
<h1 id="安装测试"><a href="#安装测试" class="headerlink" title="安装测试"></a>安装测试</h1><p>安装kelly<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go get github.com/qjw/kelly</span><br></pre></td></tr></table></figure></p>
<p>运行sample<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go get github.com/qjw/kelly/sample</span><br></pre></td></tr></table></figure></p>
<p>具体参考<a href="https://github.com/qjw/kelly#运行sample" target="_blank" rel="noopener">https://github.com/qjw/kelly#运行sample</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 运行sample</span></span><br><span class="line">king@king:~/tmp/gopath/bin$ ./sample</span><br><span class="line">[negroni] listening on :9090</span><br></pre></td></tr></table></figure>
<h2 id="源码结构"><a href="#源码结构" class="headerlink" title="源码结构"></a>源码结构</h2><ol>
<li>.(当前目录)：核心代码</li>
<li>binding：数据绑定支持，必需，自动安装</li>
<li>render：响应输出支持，必须，自动安装，例如响应json/xml/html/text/模板/二进制，以及重定向等</li>
<li>sample：测试代码</li>
<li>sample-conf：测试代码</li>
<li>toolkits：可选的辅助工具集，例如二维码/验证码/模板引擎，</li>
<li>sessions：session/flash/认证/权限控制，可选，依赖redis</li>
<li>middleware：各种中间件，可选</li>
<li>middleware/swagger：swagger支持</li>
</ol>
<h1 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h1><p>使用<a href="https://github.com/julienschmidt/httprouter" target="_blank" rel="noopener">https://github.com/julienschmidt/httprouter</a></p>
<p>router需要支持以下特性</p>
<ol>
<li>各种http方法</li>
<li>Path变量</li>
<li>多级路由</li>
</ol>
<p>httprouter并不原生多级路由，所以这里做了些扩展【<strong>留意代码中的注释，下同</strong>】</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Router <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// 支持的http方法，支持链式调用</span></span><br><span class="line">	GET(<span class="keyword">string</span>, ...HandlerFunc) Router</span><br><span class="line">	HEAD(<span class="keyword">string</span>, ...HandlerFunc) Router</span><br><span class="line">	OPTIONS(<span class="keyword">string</span>, ...HandlerFunc) Router</span><br><span class="line">	POST(<span class="keyword">string</span>, ...HandlerFunc) Router</span><br><span class="line">	PUT(<span class="keyword">string</span>, ...HandlerFunc) Router</span><br><span class="line">	PATCH(<span class="keyword">string</span>, ...HandlerFunc) Router</span><br><span class="line">	DELETE(<span class="keyword">string</span>, ...HandlerFunc) Router</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> router <span class="keyword">struct</span> &#123;	</span><br><span class="line">	<span class="comment">// 共享的全局httprouter</span></span><br><span class="line">	rt *httprouter.Router</span><br><span class="line">	<span class="comment">// 当前rouer路径</span></span><br><span class="line">	path <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// 绝对路径</span></span><br><span class="line">	absolutePath <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rt *router)</span> <span class="title">GET</span><span class="params">(path <span class="keyword">string</span>, handles ...HandlerFunc)</span> <span class="title">Router</span></span> &#123;</span><br><span class="line">	<span class="comment">// 留意rt.rt.GET作为参数传入</span></span><br><span class="line">	<span class="keyword">return</span> rt.methodImp(rt.rt.GET, <span class="string">"GET"</span>, path, handles...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rt *router)</span> <span class="title">methodImp</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	handle <span class="keyword">func</span>(path <span class="keyword">string</span>, handle httprouter.Handle)</span>,</span></span><br><span class="line">	method <span class="keyword">string</span>,</span><br><span class="line">	path <span class="keyword">string</span>,</span><br><span class="line">	handles ...HandlerFunc) Router &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 增加计数</span></span><br><span class="line">	rt.endpoints = <span class="built_in">append</span>(rt.endpoints, &amp;endpoint&#123;</span><br><span class="line">		method:  method,</span><br><span class="line">		path:    path,</span><br><span class="line">		handles: handles,</span><br><span class="line">		endPointRegisterCB: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="comment">// 在调用传入的handle函数前，已经加上了rt.absolutePath</span></span><br><span class="line">			handle(rt.absolutePath+path, rt.wrapHandle(handles...))</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span> rt</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>kelly的router都共享一个全局的httprouter对象，并且各自保存自己的所处的路径（path），在绑定特定的http请求时，自动加上自己的前缀，再绑定到原生的httprouter上去</p>
<h1 id="Callback和Context"><a href="#Callback和Context" class="headerlink" title="Callback和Context"></a>Callback和Context</h1><p>golang自带的net/http callback为<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">    ServeHTTP(ResponseWriter, *Request)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HandlerFunc <span class="function"><span class="keyword">func</span><span class="params">(ResponseWriter, *Request)</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f HandlerFunc)</span> <span class="title">ServeHTTP</span><span class="params">(w ResponseWriter, r *Request)</span></span> &#123;</span><br><span class="line">	f(w, r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Context则是一个输入（Request），一个输出/响应（ResponseWriter），这种方法有很好的灵活性，不过易用性稍弱</p>
<p>kelly借鉴gin的做法<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> HandlerFunc <span class="function"><span class="keyword">func</span><span class="params">(c *Context)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f HandlerFunc)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	f(newContext(w, r, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中最关键的就是这个Context，因为web编程大部分工作（刨去业务代码），最重要的还是解析输入，构建输出，这些都是基于http请求，这就是Context的抽象<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Context <span class="keyword">struct</span> &#123;</span><br><span class="line">	http.ResponseWriter</span><br><span class="line">	r *http.Request</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 下一个处理逻辑，用于middleware</span></span><br><span class="line">	next http.HandlerFunc</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 用于支持设置context数据</span></span><br><span class="line">	dataContext</span><br><span class="line">	<span class="comment">// render</span></span><br><span class="line">	renderOp</span><br><span class="line">	<span class="comment">// request</span></span><br><span class="line">	request</span><br><span class="line">	<span class="comment">// binder</span></span><br><span class="line">	binder</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到Context除了包装了http.Request和http.ResponseWriter之外，还有一些</p>
<ol>
<li>dataContext ：支持请求context，用于在中间件链传递数据。<strong>参见源码目录render</strong></li>
<li>renderOp ：格式化输出支持（例如xml/json等）</li>
<li>binder ： 数据绑定支持，<strong>参见源码目录binding</strong></li>
<li>request ：输入（获取参数）支持</li>
</ol>
<p>binder和request在于，前者是自动将http请求的输入绑定到一个golang struct，并且依据规则进行校验，提高开发效率。后者则属于一些工具函数，例如获取某个param/path/form参数，或者获取某个cookie。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> binder <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// 绑定一个对象，根据Content-type自动判断类型</span></span><br><span class="line">	Bind(<span class="keyword">interface</span>&#123;&#125;) (error, []<span class="keyword">string</span>)</span><br><span class="line">	<span class="comment">// 绑定json，从body取数据</span></span><br><span class="line">	BindJson(<span class="keyword">interface</span>&#123;&#125;) (error, []<span class="keyword">string</span>)</span><br><span class="line">	<span class="comment">// 绑定xml，从body取数据</span></span><br><span class="line">	BindXml(<span class="keyword">interface</span>&#123;&#125;) (error, []<span class="keyword">string</span>)</span><br><span class="line">	<span class="comment">// 绑定form，从body/query取数据</span></span><br><span class="line">	BindForm(<span class="keyword">interface</span>&#123;&#125;) (error, []<span class="keyword">string</span>)</span><br><span class="line">	<span class="comment">// 绑定path变量</span></span><br><span class="line">	BindPath(<span class="keyword">interface</span>&#123;&#125;) (error, []<span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line">	GetBindParameter() <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	GetBindJsonParameter() <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	GetBindXmlParameter() <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	GetBindFormParameter() <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	GetBindPathParameter() <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> request <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// 根据key获取cookie值</span></span><br><span class="line">	GetCookie(<span class="keyword">string</span>) (<span class="keyword">string</span>, error)</span><br><span class="line">	<span class="comment">// 根据key获取cookie值，若不存在，则返回默认值</span></span><br><span class="line">	GetDefaultCookie(<span class="keyword">string</span>, <span class="keyword">string</span>) <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// 根据key获取cookie值，若不存在，则panic</span></span><br><span class="line">	MustGetCookie(<span class="keyword">string</span>) <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根据key获取header值</span></span><br><span class="line">	GetHeader(<span class="keyword">string</span>) (<span class="keyword">string</span>, error)</span><br><span class="line">	<span class="comment">// 根据key获取header值，若不存在，则返回默认值</span></span><br><span class="line">	GetDefaultHeader(<span class="keyword">string</span>, <span class="keyword">string</span>) <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// 根据key获取header值，若不存在，则panic</span></span><br><span class="line">	MustGetHeader(<span class="keyword">string</span>) <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// Content-Type</span></span><br><span class="line">	ContentType() <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根据key获取PATH变量值</span></span><br><span class="line">	GetPathVarible(<span class="keyword">string</span>) (<span class="keyword">string</span>, error)</span><br><span class="line">	<span class="comment">// 根据key获取PATH变量值，若不存在，则panic</span></span><br><span class="line">	MustGetPathVarible(<span class="keyword">string</span>) <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根据key获取QUERY变量值，可能包含多个（http://127.0.0.1:9090/path/abc?abc=bbb&amp;abc=aaa）</span></span><br><span class="line">	GetMultiQueryVarible(<span class="keyword">string</span>) ([]<span class="keyword">string</span>, error)</span><br><span class="line">	<span class="comment">// 根据key获取QUERY变量值，仅返回第一个</span></span><br><span class="line">	GetQueryVarible(<span class="keyword">string</span>) (<span class="keyword">string</span>, error)</span><br><span class="line">	<span class="comment">// 根据key获取QUERY变量值，仅返回第一个,若不存在，则返回默认值</span></span><br><span class="line">	GetDefaultQueryVarible(<span class="keyword">string</span>, <span class="keyword">string</span>) <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// 根据key获取QUERY变量值，仅返回第一个,若不存在，则panic</span></span><br><span class="line">	MustGetQueryVarible(<span class="keyword">string</span>) <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根据key获取FORM变量值，可能get可能包含多个</span></span><br><span class="line">	GetMultiFormVarible(<span class="keyword">string</span>) ([]<span class="keyword">string</span>, error)</span><br><span class="line">	<span class="comment">// 根据key获取FORM变量值，仅返回第一个</span></span><br><span class="line">	GetFormVarible(<span class="keyword">string</span>) (<span class="keyword">string</span>, error)</span><br><span class="line">	<span class="comment">// 根据key获取FORM变量值，仅返回第一个,若不存在，则返回默认值</span></span><br><span class="line">	GetDefaultFormVarible(<span class="keyword">string</span>, <span class="keyword">string</span>) <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// 根据key获取FORM变量值，仅返回第一个,若不存在，则panic</span></span><br><span class="line">	MustGetFormVarible(<span class="keyword">string</span>) <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// @ref http.Request.ParseMultipartForm</span></span><br><span class="line">	ParseMultipartForm() error</span><br><span class="line">	<span class="comment">// 获取（上传的）文件信息</span></span><br><span class="line">	GetFileVarible(<span class="keyword">string</span>) (multipart.File, *multipart.FileHeader, error)</span><br><span class="line">	MustGetFileVarible(<span class="keyword">string</span>) (multipart.File, *multipart.FileHeader)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>render处理常见的xml/json等之外，还有比如设置cookie/header等操作，完成的功能列表如下<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> renderOp <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// 返回紧凑的json</span></span><br><span class="line">	WriteJson(<span class="keyword">int</span>, <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	<span class="comment">// 返回xml</span></span><br><span class="line">	WriteXml(<span class="keyword">int</span>, <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	<span class="comment">// 返回html</span></span><br><span class="line">	WriteHtml(<span class="keyword">int</span>, <span class="keyword">string</span>)</span><br><span class="line">	<span class="comment">// 返回模板html</span></span><br><span class="line">	WriteTemplateHtml(<span class="keyword">int</span>, *template.Template, <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	<span class="comment">// 返回格式化的json</span></span><br><span class="line">	WriteIndentedJson(<span class="keyword">int</span>, <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	<span class="comment">// 返回文本</span></span><br><span class="line">	WriteString(<span class="keyword">int</span>, <span class="keyword">string</span>, ...<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">	<span class="comment">// 返回二进制数据</span></span><br><span class="line">	WriteData(<span class="keyword">int</span>, <span class="keyword">string</span>, []<span class="keyword">byte</span>)</span><br><span class="line">	<span class="comment">// 返回重定向</span></span><br><span class="line">	Redirect(<span class="keyword">int</span>, <span class="keyword">string</span>)</span><br><span class="line">	<span class="comment">// 设置header</span></span><br><span class="line">	SetHeader(<span class="keyword">string</span>, <span class="keyword">string</span>)</span><br><span class="line">	<span class="comment">// 设置cookie</span></span><br><span class="line">	SetCookie(<span class="keyword">string</span>, <span class="keyword">string</span>, <span class="keyword">int</span>, <span class="keyword">string</span>, <span class="keyword">string</span>, <span class="keyword">bool</span>, <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line">	Abort(<span class="keyword">int</span>, <span class="keyword">string</span>)</span><br><span class="line">	ResponseStatusOK()</span><br><span class="line">	ResponseStatusBadRequest(error)</span><br><span class="line">	ResponseStatusUnauthorized(error)</span><br><span class="line">	ResponseStatusForbidden(error)</span><br><span class="line">	ResponseStatusNotFound(error)</span><br><span class="line">	ResponseStatusInternalServerError(error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>这里的WriteTemplateHtml使用golang内置的模板引擎，由于功能有限，在【toolkits/template】中基于第三方引擎实现更为强大的功能</strong></p>
<p>context则比较简单，只是一个数据的get/set<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> dataContext <span class="keyword">interface</span> &#123;</span><br><span class="line">	Set(<span class="keyword">interface</span>&#123;&#125;, <span class="keyword">interface</span>&#123;&#125;) dataContext</span><br><span class="line">	Get(<span class="keyword">interface</span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	MustGet(<span class="keyword">interface</span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="中间件框架"><a href="#中间件框架" class="headerlink" title="中间件框架"></a>中间件框架</h1><p>好的中间件框架是一个web框架灵活性的重要标志，目前主流的框架大部分都支持中间件扩展，并且有丰富的第三方中间件。为了方便移植其他框架的中间件，一般都容易兼容标准的net/http接口。</p>
<p>标准的net/http默认不支持读写自定义数据，这很大程度影响中间件的灵活性，当然可以用标准库<a href="https://golang.org/pkg/context/" target="_blank" rel="noopener">context</a>进行扩充，由于需要替换原有的reqeust，对程序结构影响很大，参见<a href="http://www.flysnow.org/2017/07/29/go-classic-libs-gorilla-context.html#新的替代者" target="_blank" rel="noopener">http://www.flysnow.org/2017/07/29/go-classic-libs-gorilla-context.html#新的替代者</a>。经过调研，选用<a href="https://github.com/urfave/negroni" target="_blank" rel="noopener">https://github.com/urfave/negroni</a></p>
<p>negroni原型如下<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> HandlerFunc <span class="function"><span class="keyword">func</span><span class="params">(rw http.ResponseWriter, r *http.Request, next http.HandlerFunc)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h HandlerFunc)</span> <span class="title">ServeHTTP</span><span class="params">(rw http.ResponseWriter, r *http.Request, next http.HandlerFunc)</span></span> &#123;</span><br><span class="line">	h(rw, r, next)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>negroni中间件默认不会传递调用，而是需要手动触发调用参数next，所以当使用context添加data并替换了http.Request对象时，处理起来就很轻松和自然</strong>。</p>
<h2 id="回调调用链"><a href="#回调调用链" class="headerlink" title="回调调用链"></a>回调调用链</h2><p>kelly的入口在kelly.Run<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">type</span> kellyImp <span class="keyword">struct</span> &#123;</span><br><span class="line">	*router</span><br><span class="line">	n *negroni.Negroni</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k *kellyImp)</span> <span class="title">Run</span><span class="params">(addr ...<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 运行negroni.Negroni.Run</span></span><br><span class="line">	k.n.Run(addr...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newImp</span><span class="params">(n *negroni.Negroni, handlers ...HandlerFunc)</span> <span class="title">Kelly</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建negroni.Negroni回调</span></span><br><span class="line">	rt := newRouterImp(handlers...)</span><br><span class="line">	ky := &amp;kellyImp&#123;</span><br><span class="line">		router: rt,</span><br><span class="line">		n:      n,</span><br><span class="line">	&#125;</span><br><span class="line">	ky.n = n</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// negroni触发之后，会进入rt</span></span><br><span class="line">	n.UseHandler(rt)</span><br><span class="line">	<span class="keyword">return</span> ky</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当kelly收到http请求，先触发negroni.Negroni的回调，这个回调在router定义</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newRouterImp</span><span class="params">(handlers ...HandlerFunc)</span> *<span class="title">router</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建全局的httprouter对象</span></span><br><span class="line">	httpRt := httprouter.New()</span><br><span class="line">	<span class="comment">// 创建根router对象</span></span><br><span class="line">	rt := &amp;router&#123;</span><br><span class="line">		rt:           httpRt,</span><br><span class="line">		path:         <span class="string">""</span>, <span class="comment">// 根router路径是空的</span></span><br><span class="line">		absolutePath: <span class="string">""</span>,</span><br><span class="line">		dataContext:  newMapContext(),</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rt</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而router又将请求转发到了全局的httprouter对象，参见下面代码</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rt *router)</span> <span class="title">ServeHTTP</span><span class="params">(rw http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	rt.rt.ServeHTTP(rw, r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终就触发了我们在注册http方法时设置到httprouter的回调中</p>
<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><ol>
<li>有两种方式设置中间件，在创建router时，传入</li>
<li>创建之后，调用Use</li>
</ol>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建根router</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewClassic</span><span class="params">(handlers ...HandlerFunc)</span> <span class="title">Kelly</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> newImp(negroni.Classic(), handlers...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建根router</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(handlers ...HandlerFunc)</span> <span class="title">Kelly</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> newImp(negroni.New(negroni.NewRecovery()), handlers...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Router <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// 新建子router</span></span><br><span class="line">	Group(<span class="keyword">string</span>, ...HandlerFunc) Router</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 动态插入中间件</span></span><br><span class="line">	Use(...HandlerFunc) Router</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于httprouter并没有对中间件的支持，所以需要继续作转换</p>
<p>最外层的注册，使用了kelly的回调原型<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> router <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 中间件</span></span><br><span class="line">	middlewares []HandlerFunc</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 所有的子Group</span></span><br><span class="line">	groups []*router</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 父Group</span></span><br><span class="line">	parent *router</span><br><span class="line"></span><br><span class="line">	endpoints []*endpoint</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rt *router)</span> <span class="title">GET</span><span class="params">(path <span class="keyword">string</span>, handles ...HandlerFunc)</span> <span class="title">Router</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> rt.methodImp(rt.rt.GET, <span class="string">"GET"</span>, path, handles...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>留意<strong>结构中的endPointRegisterCB成员</strong>和<strong>rt.wrapHandle(handles…)</strong></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rt *router)</span> <span class="title">methodImp</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	handle <span class="keyword">func</span>(path <span class="keyword">string</span>, handle httprouter.Handle)</span>,</span></span><br><span class="line">	method <span class="keyword">string</span>,</span><br><span class="line">	path <span class="keyword">string</span>,</span><br><span class="line">	handles ...HandlerFunc) Router &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将注册信息加入到endpoints成员中，</span></span><br><span class="line">	rt.endpoints = <span class="built_in">append</span>(rt.endpoints, &amp;endpoint&#123;</span><br><span class="line">		method:  method,</span><br><span class="line">		path:    path,</span><br><span class="line">		handles: handles,</span><br><span class="line">		endPointRegisterCB: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="comment">// 注册回调，</span></span><br><span class="line">			handle(rt.absolutePath+path, rt.wrapHandle(handles...))</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span> rt</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在kelly进入主循环之前，会完成调用。<strong>留意doBeforeRun</strong><br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(k *kellyImp)</span> <span class="title">Run</span><span class="params">(addr ...<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> k.n == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">"invalid kelly"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	k.router.doBeforeRun()</span><br><span class="line">	k.n.Run(addr...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rt *router)</span> <span class="title">doBeforeRun</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 先注册自己的endpoints</span></span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> rt.endpoints &#123;</span><br><span class="line">		v.run()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 先注册儿子们的endpoints</span></span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> rt.groups &#123;</span><br><span class="line">		v.doBeforeRun()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *endpoint)</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> DebugFlag &amp;&amp; this.endPointRegisterCB == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">"invalid endpoint"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 直接调用创建时的函数，并且清空，避免重复调用</span></span><br><span class="line">	this.endPointRegisterCB()</span><br><span class="line">	this.endPointRegisterCB = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>之所以通过这种方式，在最后一步统一注册，是为了支持创建router之后使用Use方法动态添加中间件的情形</strong></p>
<h2 id="Callback转换"><a href="#Callback转换" class="headerlink" title="Callback转换"></a>Callback转换</h2><p>在endPointRegisterCB中，注册的回调需要原型【httprouter.Handle】，而我们传入的是【kelly.HandlerFunc数组】，通过下面的函数转换<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rt *router)</span> <span class="title">wrapHandle</span><span class="params">(handles ...HandlerFunc)</span> <span class="title">httprouter</span>.<span class="title">Handle</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建一个negroni实例</span></span><br><span class="line">	tmpHandle := negroni.New()</span><br><span class="line">	<span class="comment">// 将父router的中间件（【kelly.HandlerFunc数组】）注册到negroni</span></span><br><span class="line">	rt.wrapParentHandle(tmpHandle)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 注册当前router的中间件到negroni</span></span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> rt.middlewares &#123;</span><br><span class="line">		tmpHandle.UseFunc(wrapHandlerFunc(v))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 注册特定方法的中间件到negroni</span></span><br><span class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> handles &#123;</span><br><span class="line">		tmpHandle.UseFunc(wrapHandlerFunc(v))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 返回一个httprouter的回调</span></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(wr http.ResponseWriter, r *http.Request, params httprouter.Params)</span></span> &#123;</span><br><span class="line">		<span class="comment">// 将请求转到negroni</span></span><br><span class="line">		tmpHandle.ServeHTTP(wr, r)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rt *router)</span> <span class="title">wrapParentHandle</span><span class="params">(n *negroni.Negroni)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> rt.parent != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// 让父router优先注册自己的中间件</span></span><br><span class="line">		rt.parent.wrapParentHandle(n)</span><br><span class="line">		<span class="comment">// 注册parent的中间件</span></span><br><span class="line">		<span class="keyword">for</span> _, v := <span class="keyword">range</span> rt.parent.middlewares &#123;</span><br><span class="line">			n.UseFunc(wrapHandlerFunc(v))</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>大体的思路就是每次注册http方法，就生成一个negroni对象，并且注册祖宗十八代的中间件、自己的中间件和自己的处理函数，然后转成httprouter的回调注册。</p>
<p>而negroni包装kelly.HandlerFunc回调时，同样需要一层转换<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">wrapHandlerFunc</span><span class="params">(f HandlerFunc)</span> <span class="title">negroni</span>.<span class="title">HandlerFunc</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(rw http.ResponseWriter, r *http.Request, next http.HandlerFunc)</span></span> &#123;</span><br><span class="line">		f(newContext(rw, r, next))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>留意这个next</strong>，为了支持中间件链继续运行，需要保存这个next</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newContext</span><span class="params">(w http.ResponseWriter, r *http.Request, next http.HandlerFunc)</span> *<span class="title">Context</span></span> &#123;</span><br><span class="line">	c := &amp;Context&#123;</span><br><span class="line">		next:           next,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Context)</span> <span class="title">InvokeNext</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> c.next != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.next.ServeHTTP(c, c.Request())</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">"invalid invoke next"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h2><p>一个请求进来，先走negroni，转发到httprouter，httprouter根据路由规则找到对应的negroni回调，然后触发每一个中间件回调，最后到业务回调。这个过程中，需要将negroni参数转换成kelly.HandlerFunc</p>
<p>这整个过程中存在</p>
<ol>
<li>额外的内存消耗，每个请求都会有一个negroni实例</li>
<li>函数调用栈过长带来的cpu消耗</li>
<li>每个中间件/回调都伴随这一个kelly.Context对象的创建（创建本身比较简单）</li>
</ol>
<h1 id="Path变量"><a href="#Path变量" class="headerlink" title="Path变量"></a>Path变量</h1><p>path变量 httprouter支持，具体存储在回调的第三个参数中</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Handle <span class="function"><span class="keyword">func</span><span class="params">(http.ResponseWriter, *http.Request, Params)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Param <span class="keyword">struct</span> &#123;</span><br><span class="line">	Key   <span class="keyword">string</span></span><br><span class="line">	Value <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Params []Param</span><br></pre></td></tr></table></figure>
<p>回到函数wrapHandle，<strong>留意mapContextFilter</strong><br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rt *router)</span> <span class="title">wrapHandle</span><span class="params">(handles ...HandlerFunc)</span> <span class="title">httprouter</span>.<span class="title">Handle</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(wr http.ResponseWriter, r *http.Request, params httprouter.Params)</span></span> &#123;</span><br><span class="line">		r = mapContextFilter(wr, r, params)</span><br><span class="line">		tmpHandle.ServeHTTP(wr, r)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实际上就是将这个params参数通过标准库<a href="https://golang.org/pkg/context/" target="_blank" rel="noopener">context</a>存入request对象中</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> contextMap <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapContextFilter</span><span class="params">(_ http.ResponseWriter, r *http.Request, params httprouter.Params)</span> *<span class="title">http</span>.<span class="title">Request</span></span>&#123;</span><br><span class="line">	contextMap := contextMap&#123;</span><br><span class="line">		pathParamID: params,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> contextSet(r, contextKey, contextMap)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">contextSet</span><span class="params">(r *http.Request, key, value <span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">http</span>.<span class="title">Request</span></span> &#123;</span><br><span class="line">	ctx := context.WithValue(r.Context(), key, value)</span><br><span class="line">	<span class="keyword">return</span> r.WithContext(ctx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="取变量"><a href="#取变量" class="headerlink" title="取变量"></a>取变量</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">contextMustGet</span><span class="params">(r *http.Request, key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">	v := r.Context().Value(key)</span><br><span class="line">	<span class="keyword">if</span> v == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(fmt.Errorf(<span class="string">"get context value fail by '%v'"</span>, key))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> v</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getPathParams</span><span class="params">(r *http.Request)</span> <span class="title">httprouter</span>.<span class="title">Params</span></span>&#123;</span><br><span class="line">	datas := contextMustGet(r, contextKey).(contextMap)</span><br><span class="line">	<span class="comment">// 这个pathParamID是一个全局常量</span></span><br><span class="line">	<span class="keyword">return</span> datas[pathParamID].(httprouter.Params)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r requestImp)</span> <span class="title">GetPathVarible</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	params := getPathParams(r.Request)</span><br><span class="line">	val := params.ByName(name)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(val) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> val, <span class="literal">nil</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> val, fmt.Errorf(<span class="string">"can not get path varibel by '%v'"</span>, name)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Context数据"><a href="#Context数据" class="headerlink" title="Context数据"></a>Context数据</h1><p>由于kelly.Context在整个调用链并非连续(而是每个negroni调用动态创建的)，所以不能简单地在里面加一个map之类的成员</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newContext</span><span class="params">(w http.ResponseWriter, r *http.Request, next http.HandlerFunc)</span> *<span class="title">Context</span></span> &#123;</span><br><span class="line">	c := &amp;Context&#123;</span><br><span class="line">		dataContext:    newMapHttpContext(r),</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以和path变量一样，同样将一个map对象绑定到request对象<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> mapHttpContext <span class="keyword">struct</span> &#123;</span><br><span class="line">	r *http.Request</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *mapHttpContext)</span> <span class="title">Set</span><span class="params">(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">dataContext</span></span> &#123;</span><br><span class="line">	datas := contextMustGet(c.r, contextKey).(contextMap)</span><br><span class="line">	datas[key] = value</span><br><span class="line">	<span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c mapHttpContext)</span> <span class="title">Get</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">	datas := contextMustGet(c.r, contextKey).(contextMap)</span><br><span class="line">	<span class="keyword">if</span> data, ok := datas[key]; ok &#123;</span><br><span class="line">		<span class="keyword">return</span> data</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newMapHttpContext</span><span class="params">(r *http.Request)</span> <span class="title">dataContext</span></span> &#123;</span><br><span class="line">	c := &amp;mapHttpContext&#123;</span><br><span class="line">		r: r,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h1><p>中间件可以在每个请求之前做些处理，甚至拦截，<strong>注解则在每次注册Http请求时做些处理</strong>，比如swagger就依赖于这种场景</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Router <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// 添加全局的 注解 函数。该router下面和子（孙）router下面的endpoint注册都会被触发</span></span><br><span class="line">	GlobalAnnotation(handles ...AnnotationHandlerFunc) Router</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加临时 注解 函数，只对使用返回的AnnotationRouter对象进行注册的endpoint有效</span></span><br><span class="line">	Annotation(handles ...AnnotationHandlerFunc) AnnotationRouter</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 用于支持设置context数据</span></span><br><span class="line">	dataContext</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AnnotationHandlerFunc <span class="function"><span class="keyword">func</span><span class="params">(c *AnnotationContext)</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AnnotationContext <span class="keyword">struct</span> &#123;</span><br><span class="line">	r       Router</span><br><span class="line">	method  <span class="keyword">string</span></span><br><span class="line">	path    <span class="keyword">string</span></span><br><span class="line">	<span class="comment">// 不包含中间件</span></span><br><span class="line">	handles []HandlerFunc</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="注册filter"><a href="#注册filter" class="headerlink" title="注册filter"></a>注册filter</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rt *router)</span> <span class="title">GlobalAnnotation</span><span class="params">(handles ...AnnotationHandlerFunc)</span> <span class="params">(r Router)</span></span> &#123;</span><br><span class="line">	r = rt</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(rt.epMiddlewares) == <span class="number">0</span> &#123;</span><br><span class="line">		rt.epMiddlewares = <span class="built_in">make</span>([]AnnotationHandlerFunc, <span class="built_in">len</span>(handles))</span><br><span class="line">		<span class="built_in">copy</span>(rt.epMiddlewares, handles)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> _, item := <span class="keyword">range</span> handles &#123;</span><br><span class="line">			rt.epMiddlewares = <span class="built_in">append</span>(rt.epMiddlewares, item)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只是简单地将他存到成员epMiddlewares中</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> router <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// endpoint钩子函数</span></span><br><span class="line">	epMiddlewares []AnnotationHandlerFunc</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 被子类覆盖的方法，</span></span><br><span class="line">	overiteInvokeAnnotation <span class="function"><span class="keyword">func</span><span class="params">(c *AnnotationContext)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="触发"><a href="#触发" class="headerlink" title="触发"></a>触发</h2><p>创建router时，会指定rt。在doBeforeRun时，会完成注入<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newRouterImp</span><span class="params">(handlers ...HandlerFunc)</span> *<span class="title">router</span></span> &#123;</span><br><span class="line">	rt := &amp;router&#123;&#125;</span><br><span class="line">	rt.overiteInvokeAnnotation = rt.invokeAnnotation</span><br><span class="line">	<span class="keyword">return</span> rt</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rt *router)</span> <span class="title">invokeParentAnnotation</span><span class="params">(c *AnnotationContext)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> rt.parent != <span class="literal">nil</span> &#123;</span><br><span class="line">		rt.parent.invokeParentAnnotation(c)</span><br><span class="line">		<span class="keyword">for</span> _, item := <span class="keyword">range</span> rt.parent.epMiddlewares &#123;</span><br><span class="line">			item(c)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rt *router)</span> <span class="title">invokeAnnotation</span><span class="params">(c *AnnotationContext)</span></span> &#123;</span><br><span class="line">	rt.invokeParentAnnotation(c)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 执行全局的ep 过滤器</span></span><br><span class="line">	<span class="keyword">for</span> _, item := <span class="keyword">range</span> rt.epMiddlewares &#123;</span><br><span class="line">		item(c)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再回到注册http请求的函数methodImp。<strong>留意函数变量f</strong><br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rt *router)</span> <span class="title">methodImp</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	handle <span class="keyword">func</span>(path <span class="keyword">string</span>, handle httprouter.Handle)</span>,</span></span><br><span class="line">	method <span class="keyword">string</span>,</span><br><span class="line">	path <span class="keyword">string</span>,</span><br><span class="line">	handles ...HandlerFunc) Router &#123;</span><br><span class="line"></span><br><span class="line">	f := rt.overiteInvokeAnnotation</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 增加计数</span></span><br><span class="line">	rt.endpoints = <span class="built_in">append</span>(rt.endpoints, &amp;endpoint&#123;</span><br><span class="line">		endPointRegisterCB: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="comment">// 注册到httprouter</span></span><br><span class="line">			handle(rt.absolutePath+path, rt.wrapHandle(handles...))</span><br><span class="line">			<span class="comment">// 调用注解</span></span><br><span class="line">			f(&amp;AnnotationContext&#123;</span><br><span class="line">				r:       rt,</span><br><span class="line">				method:  method,</span><br><span class="line">				path:    path,</span><br><span class="line">				handles: handles,</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span> rt</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="临时Filter"><a href="#临时Filter" class="headerlink" title="临时Filter"></a>临时Filter</h2><p>使用GlobalAnnotation注册filter会应用到当前router和他的子router，临时filter需要使用kelly.Router.Annotation。这个函数返回的是一个AnnotationRouter对象。</p>
<p>这个对象有自己的AnnotationHandlerFunc数组，所以不会影响其他的请求</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newAnnotationRouter</span><span class="params">(r *router, handles ...AnnotationHandlerFunc)</span> <span class="title">AnnotationRouter</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;annotationRouter&#123;</span><br><span class="line">		router:      r,</span><br><span class="line">		middlewares: handles,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> annotationRouter <span class="keyword">struct</span> &#123;</span><br><span class="line">	*router</span><br><span class="line">	<span class="comment">// endpoint钩子函数</span></span><br><span class="line">	middlewares []AnnotationHandlerFunc</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时为了在触发filter时，一并触发自己的filter，需要重写<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *annotationRouter)</span> <span class="title">doMethod</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	f <span class="keyword">func</span>(path <span class="keyword">string</span>, handles ...HandlerFunc)</span> <span class="title">Router</span>,</span></span><br><span class="line">	path <span class="keyword">string</span>,</span><br><span class="line">	handles ...HandlerFunc,</span><br><span class="line">) Router &#123;</span><br><span class="line">	old := r.router.overiteInvokeAnnotation</span><br><span class="line">	<span class="comment">// 重写overiteInvokeAnnotation，并且函数退出自动复原</span></span><br><span class="line">	r.router.overiteInvokeAnnotation = r.invokeAnnotation</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		r.router.overiteInvokeAnnotation = old</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">return</span> f(path, handles...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>由于go并非真正的继承，而只是简单的组合，所以这里的多态实现有些另类</strong></p>
<h2 id="注解使用"><a href="#注解使用" class="headerlink" title="注解使用"></a>注解使用</h2><p>必须使用链式调用，或者保存返回的临时对象<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">router := r.Group(<span class="string">"/swagger"</span></span><br><span class="line">).GlobalAnnotation(swagger.SetGlobalParam(&amp;swagger.StructParam&#123;</span><br><span class="line">	Tags: []<span class="keyword">string</span>&#123;<span class="string">"API接口"</span>&#125;,</span><br><span class="line">&#125;)).OPTIONS(<span class="string">"/*path"</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *kelly.Context)</span></span> &#123;</span><br><span class="line">	c.ResponseStatusOK()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">router.Annotation(swagger.Swagger(&amp;swagger.StructParam&#123;</span><br><span class="line">	ResponseData: &amp;swagger.SuccessResp&#123;&#125;,</span><br><span class="line">	FormData:     &amp;swaggerParam&#123;&#125;,</span><br><span class="line">	Summary:      <span class="string">"api1"</span>,</span><br><span class="line">&#125;)).POST(<span class="string">"/api1"</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *kelly.Context)</span></span> &#123;</span><br><span class="line">	c.ResponseStatusOK()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/10/18/kelly-src/" data-id="ckdbgbyws003543po639sv0oc" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/10/18/kelly-src/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-go-debug" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/10/17/go-debug/">Golang 调试</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/10/17/go-debug/" class="article-date"><time datetime="2017-10-17T13:16:48.000Z" itemprop="datePublished">2017-10-17</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Golang/">Golang</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="编译选项"><a href="#编译选项" class="headerlink" title="编译选项"></a>编译选项</h1><p>传递-gcflags “-N -l” 参数，这样可以忽略Go内部做的一些优化，聚合变量和函数等优化，这样对于GDB调试来说非常困难，所以在编译的时候加入这两个参数避免这些优化。</p>
<ol>
<li>对于单个go文件的，直接 【go build -gcflags “-N -l” main.go】</li>
<li>对于基于package的，使用包路径  【go build -gcflags “-N -l” github.com/qjw/kelly/sample】,在当前目录直接.即可【go build -gcflags “-N -l” .】</li>
</ol>
<h1 id="GDB"><a href="#GDB" class="headerlink" title="GDB"></a>GDB</h1><p>处理下断点时，注意函数的名称，其他都和C一致</p>
<p>以main函数为例，不能直接b main，这虽然会生效，但是实际上会陷入c库的main，而不是golang的main，务必使用包名+函数名<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:/go/src/github.com/qjw/kelly/sample$ gdb sample </span><br><span class="line">(gdb) b main.main</span><br><span class="line">Breakpoint 1 at 0x8bfe70: file /go/src/github.com/qjw/kelly/sample/main.go, line 42.</span><br><span class="line">(gdb) l</span><br><span class="line">28			Password: <span class="string">""</span>,</span><br><span class="line">29			DB:       3,</span><br><span class="line">30		&#125;)</span><br><span class="line">31		<span class="keyword">if</span> err := redisClient.Ping().Err(); err != nil &#123;</span><br><span class="line">32			log.Fatal(<span class="string">"failed to connect redis"</span>)</span><br><span class="line">33		&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Delve"><a href="#Delve" class="headerlink" title="Delve"></a><a href="https://github.com/derekparker/delve" target="_blank" rel="noopener">Delve</a></h1><p>安装指引 <a href="https://github.com/derekparker/delve/blob/master/Documentation/installation/linux/install.md" target="_blank" rel="noopener">https://github.com/derekparker/delve/blob/master/Documentation/installation/linux/install.md</a>，简单地就可以</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go get github.com/derekparker/delve/cmd/dlv</span><br></pre></td></tr></table></figure>
<p>最终debug程序就是dlv，目前Gogland等很多IDE的调试器就使用dlv。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:/go/src/github.com/qjw/kelly/sample$ dlv <span class="built_in">exec</span> ./sample </span><br><span class="line">Type <span class="string">'help'</span> <span class="keyword">for</span> list of commands.</span><br><span class="line">(dlv) b main.main</span><br><span class="line">Breakpoint 1 <span class="built_in">set</span> at 0x8bfe8b <span class="keyword">for</span> main.main() ./main.go:42</span><br><span class="line">(dlv) <span class="built_in">continue</span></span><br><span class="line">&gt; main.main() ./main.go:42 (hits goroutine(1):1 total:1) (PC: 0x8bfe8b)</span><br><span class="line">    37:			log.Print(err)</span><br><span class="line">    38:		&#125;</span><br><span class="line">    39:		<span class="built_in">return</span> store</span><br><span class="line">    40:	&#125;</span><br><span class="line">    41:	</span><br><span class="line">=&gt;  42:	func <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    43:		store := initStore()</span><br></pre></td></tr></table></figure>
<p>自动从源码编译</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:/go/src/github.com/qjw/kelly/sample$ dlv debug .</span><br><span class="line">Type <span class="string">'help'</span> <span class="keyword">for</span> list of commands.</span><br><span class="line">(dlv) b main.main</span><br><span class="line">Breakpoint 1 <span class="built_in">set</span> at 0xa1d2db <span class="keyword">for</span> main.main() ./main.go:42</span><br><span class="line">(dlv) <span class="built_in">continue</span></span><br><span class="line">&gt; main.main() ./main.go:42 (hits goroutine(1):1 total:1) (PC: 0xa1d2db)</span><br><span class="line">    37:			log.Print(err)</span><br><span class="line">    38:		&#125;</span><br><span class="line">    39:		<span class="built_in">return</span> store</span><br><span class="line">    40:	&#125;</span><br><span class="line">    41:	</span><br><span class="line">=&gt;  42:	func <span class="function"><span class="title">main</span></span>() &#123;</span><br></pre></td></tr></table></figure>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/10/17/go-debug/" data-id="ckdbgbyw0001n43po2tgdvans" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/10/17/go-debug/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-golang-option_type" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/20/golang-option_type/">Golang 可选类型</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/08/20/golang-option_type/" class="article-date"><time datetime="2017-08-20T14:06:13.000Z" itemprop="datePublished">2017-08-20</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Golang/">Golang</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>对于struct，有些字段可能是空值，有些字段不存在（这是两种含义），若对于不允许空值的场景，空值可以表示不存在的含义。</p>
<ol>
<li>golang声明之后会赋一个默认值（区别C/C++）</li>
<li>用万能的指针可以区分空值和不存在，不过存在<strong>Null Pointer Exception</strong>的问题</li>
</ol>
<p>以下内容参考<strong><a href="http://www.markphelps.me/2017/08/20/optional-types-with-go-generate.html" target="_blank" rel="noopener">http://www.markphelps.me/2017/08/20/optional-types-with-go-generate.html</a></strong></p>
<p>既然不用指针，就必须有一个标志表示<strong>是否存在</strong>，对象定义如下</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> optional</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> String <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="keyword">string</span>  <span class="keyword">string</span></span><br><span class="line">	present <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">EmptyString</span><span class="params">()</span> <span class="title">String</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> String&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">OfString</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">String</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> String&#123;<span class="keyword">string</span>: s, present: <span class="literal">true</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *String)</span> <span class="title">Set</span><span class="params">(s <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	o.<span class="keyword">string</span> = s</span><br><span class="line">	o.present = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *String)</span> <span class="title">Get</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> o.<span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *String)</span> <span class="title">Present</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> o.present</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于golang没有语言层面的模板（类比C++的<a href="http://www.cplusplus.com/doc/oldtutorial/templates/" target="_blank" rel="noopener">template</a>），而type却有很多种，所以需要有一种机制能快速给一个对象生成上述的代码。</p>
<p>利用<a href="https://golang.org/pkg/html/template/" target="_blank" rel="noopener">go template</a>机制和<a href="https://blog.golang.org/generate" target="_blank" rel="noopener">go generate</a>比较容易实现</p>
<p>模板定义</p>
<figure class="highlight django"><table><tr><td class="code"><pre><span class="line"><span class="xml">package </span><span class="template-variable">&#123;&#123; .PackageName &#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">// </span><span class="template-variable">&#123;&#123; .OutputName &#125;&#125;</span><span class="xml"> is an optional </span><span class="template-variable">&#123;&#123; .TypeName &#125;&#125;</span></span><br><span class="line"><span class="xml">type </span><span class="template-variable">&#123;&#123; .OutputName &#125;&#125;</span><span class="xml"> struct &#123;</span></span><br><span class="line"><span class="xml">    </span><span class="template-variable">&#123;&#123; .TypeName | unexport &#125;&#125;</span><span class="xml"> </span><span class="template-variable">&#123;&#123; .TypeName &#125;&#125;</span></span><br><span class="line"><span class="xml">    present bool</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">// Empty</span><span class="template-variable">&#123;&#123; .OutputName | title &#125;&#125;</span><span class="xml"> returns an empty </span><span class="template-variable">&#123;&#123; .PackageName &#125;&#125;</span><span class="xml">.</span><span class="template-variable">&#123;&#123; .OutputName &#125;&#125;</span></span><br><span class="line"><span class="xml">func Empty</span><span class="template-variable">&#123;&#123; .OutputName | title &#125;&#125;</span><span class="xml">() </span><span class="template-variable">&#123;&#123; .OutputName &#125;&#125;</span><span class="xml"> &#123;</span></span><br><span class="line"><span class="xml">    return </span><span class="template-variable">&#123;&#123; .OutputName &#125;&#125;</span><span class="xml">&#123;&#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">// Of</span><span class="template-variable">&#123;&#123; .TypeName | title &#125;&#125;</span><span class="xml"> creates a </span><span class="template-variable">&#123;&#123; .PackageName &#125;&#125;</span><span class="xml">.</span><span class="template-variable">&#123;&#123; .OutputName &#125;&#125;</span><span class="xml"> from a </span><span class="template-variable">&#123;&#123; .TypeName &#125;&#125;</span></span><br><span class="line"><span class="xml">func Of</span><span class="template-variable">&#123;&#123; .TypeName | title &#125;&#125;</span><span class="xml">(</span><span class="template-variable">&#123;&#123; .TypeName | first &#125;&#125;</span><span class="xml"> </span><span class="template-variable">&#123;&#123; .TypeName &#125;&#125;</span><span class="xml">) </span><span class="template-variable">&#123;&#123; .OutputName &#125;&#125;</span><span class="xml"> &#123;</span></span><br><span class="line"><span class="xml">    return </span><span class="template-variable">&#123;&#123; .OutputName &#125;&#125;</span><span class="xml">&#123; </span><span class="template-variable">&#123;&#123; .TypeName | unexport &#125;&#125;</span><span class="xml">: </span><span class="template-variable">&#123;&#123; .TypeName | first &#125;&#125;</span><span class="xml">, present: true&#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">// Set sets the </span><span class="template-variable">&#123;&#123; .TypeName &#125;&#125;</span><span class="xml"> value</span></span><br><span class="line"><span class="xml">func (o *</span><span class="template-variable">&#123;&#123; .OutputName &#125;&#125;</span><span class="xml">) Set(</span><span class="template-variable">&#123;&#123; .TypeName | first &#125;&#125;</span><span class="xml"> </span><span class="template-variable">&#123;&#123; .TypeName &#125;&#125;</span><span class="xml">) &#123;</span></span><br><span class="line"><span class="xml">    o.</span><span class="template-variable">&#123;&#123; .TypeName | unexport &#125;&#125;</span><span class="xml"> = </span><span class="template-variable">&#123;&#123; .TypeName | first &#125;&#125;</span></span><br><span class="line"><span class="xml">    o.present = true</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">// Get returns the </span><span class="template-variable">&#123;&#123; .TypeName &#125;&#125;</span><span class="xml"> value</span></span><br><span class="line"><span class="xml">func (o *</span><span class="template-variable">&#123;&#123; .OutputName &#125;&#125;</span><span class="xml">) Get() </span><span class="template-variable">&#123;&#123; .TypeName &#125;&#125;</span><span class="xml"> &#123;</span></span><br><span class="line"><span class="xml">    return o.</span><span class="template-variable">&#123;&#123; .TypeName | unexport &#125;&#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="xml">// Present returns whether or not the value is present</span></span><br><span class="line"><span class="xml">func (o *</span><span class="template-variable">&#123;&#123; .OutputName &#125;&#125;</span><span class="xml">) Present() bool &#123;</span></span><br><span class="line"><span class="xml">    return o.present</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<p>代码定义</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">	<span class="string">"strings"</span></span><br><span class="line">	<span class="string">"html/template"</span></span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;</span><br><span class="line">	Timestamp   time.Time</span><br><span class="line">	PackageName <span class="keyword">string</span></span><br><span class="line">	TypeName    <span class="keyword">string</span></span><br><span class="line">	OutputName  <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	funcMap = template.FuncMap&#123;</span><br><span class="line">		<span class="string">"title"</span>: strings.Title,</span><br><span class="line">		<span class="string">"first"</span>: <span class="function"><span class="keyword">func</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">			<span class="keyword">return</span> strings.ToLower(<span class="keyword">string</span>(s[<span class="number">0</span>]))</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"unexport"</span>: <span class="function"><span class="keyword">func</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">			<span class="keyword">return</span> strings.ToLower(<span class="keyword">string</span>(s[<span class="number">0</span>])) + <span class="keyword">string</span>(s[<span class="number">1</span>:])</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	temp,err := ioutil.ReadFile(<span class="string">"src/github.com/qjw/test/a.tpl"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	t := template.Must(template.New(<span class="string">""</span>).Funcs(funcMap).Parse(<span class="keyword">string</span>(temp)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> buf bytes.Buffer</span><br><span class="line">	err = t.Execute(&amp;buf, data&#123;</span><br><span class="line">		Timestamp:time.Now(),</span><br><span class="line">		PackageName: <span class="string">"main"</span>,</span><br><span class="line">		TypeName: <span class="string">"int"</span>,</span><br><span class="line">		OutputName: <span class="string">"Int"</span>,</span><br><span class="line"></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panic(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = ioutil.WriteFile(<span class="string">"src/github.com/qjw/test/a_gen.go"</span>, buf.Bytes(), <span class="number">0644</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">"writing output: %s"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以将其作为一个command，然后用<a href="https://blog.golang.org/generate" target="_blank" rel="noopener">go generate</a>批量生成类型代码，作者的代码在<a href="https://github.com/markphelps/optional/blob/master/cmd/optional/main.go" target="_blank" rel="noopener">https://github.com/markphelps/optional/blob/master/cmd/optional/main.go</a></p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/08/20/golang-option_type/" data-id="ckdbgbywc002f43po80iwhgfv" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/08/20/golang-option_type/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-golang-3rdtools" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/20/golang-3rdtools/">Golang第三方工具</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/08/20/golang-3rdtools/" class="article-date"><time datetime="2017-08-20T13:36:58.000Z" itemprop="datePublished">2017-08-20</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Golang/">Golang</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="360EntSecGroup-Skylar-goreporter"><a href="#360EntSecGroup-Skylar-goreporter" class="headerlink" title="360EntSecGroup-Skylar/goreporter"></a><a href="https://github.com/360EntSecGroup-Skylar/goreporter" target="_blank" rel="noopener">360EntSecGroup-Skylar/goreporter</a></h1><p>A Golang tool that does static analysis, unit testing, code review and generate code quality report.<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go get -u github.com/360EntSecGroup-Skylar/goreporter</span><br></pre></td></tr></table></figure></p>
<p>安装之后，为了支持生成图表，需要<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install graphviz</span><br></pre></td></tr></table></figure></p>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>由于<a href="https://github.com/360EntSecGroup-Skylar/goreporter" target="_blank" rel="noopener">360EntSecGroup-Skylar/goreporter</a> 不会自动查找和排除vendor目录，所以这里取巧，将vendor/src做一个软连接到vendor目录<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ln -s github.com/qjw/git-notify/vendor/ github.com/qjw/git-notify/vendor/src</span><br><span class="line"><span class="comment"># html结果文件在当前目录，可以参数另行指定</span></span><br><span class="line">./goreporter  -p ../src/github.com/qjw/git-notify/ -e ../src/github.com/qjw/git-notify/vendor/  -f html</span><br></pre></td></tr></table></figure></p>
<p>感觉没有什么比较有价值的东西，生成的报表界面倒是挺好看</p>
<h1 id="stringer"><a href="#stringer" class="headerlink" title="stringer"></a><a href="https://godoc.org/golang.org/x/tools/cmd/stringer" target="_blank" rel="noopener">stringer</a></h1><p>根据一个（ unsigned ）int的别名生成fmt.Stringer接口的方法</p>
<blockquote>
<p>Stringer is a tool to automate the creation of methods that satisfy the fmt.Stringer interface. Given the name of a (signed or unsigned) integer type T that has constants defined, stringer will create a new self-contained Go source file implementing</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go get golang.org/x/tools/cmd/stringer</span><br></pre></td></tr></table></figure>
<p>安装完了会编译出一个stringer命令，在<strong>$GOPATH/bin</strong></p>
<p>待生成方法的int别名Pill<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> painkiller</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Pill <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	Placebo Pill = <span class="literal">iota</span></span><br><span class="line">	Aspirin</span><br><span class="line">	Ibuprofen</span><br><span class="line">	Paracetamol</span><br><span class="line">	Acetaminophen = Paracetamol</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>运行命令<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">stringer -<span class="built_in">type</span>=Pill</span><br></pre></td></tr></table></figure></p>
<p>结果<br><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Code generated by "stringer -type=Pill"; DO NOT EDIT.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> painkiller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> _Pill_name = <span class="string">"PlaceboAspirinIbuprofenParacetamol"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _Pill_index = [...]<span class="keyword">uint8</span>&#123;<span class="number">0</span>, <span class="number">7</span>, <span class="number">14</span>, <span class="number">23</span>, <span class="number">34</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(i Pill)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> i &lt; <span class="number">0</span> || i &gt;= Pill(<span class="built_in">len</span>(_Pill_index)<span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Sprintf(<span class="string">"Pill(%d)"</span>, i)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> _Pill_name[_Pill_index[i]:_Pill_index[i+<span class="number">1</span>]]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="go-callvis"><a href="#go-callvis" class="headerlink" title="go-callvis"></a><a href="https://github.com/TrueFurby/go-callvis" target="_blank" rel="noopener">go-callvis</a></h1><p>生成调用图</p>
<blockquote>
<p>Purpose of this tool is to provide a visual overview of your program by using the data from call graph and its relations with packages and types. This is especially useful in larger projects where the complexity of the code rises or when you are just simply trying to understand code structure of somebody else.</p>
</blockquote>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go get -u github.com/TrueFurby/go-callvis</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/TrueFurby/go-callvis &amp;&amp; make</span><br></pre></td></tr></table></figure>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>必须包含main package</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go-callvis github.com/qjw/kelly/sample | dot -Tpng -o output.png</span><br></pre></td></tr></table></figure>
<blockquote>
<p>生成的png图片可能很大</p>
</blockquote>
<h1 id="gometalinter"><a href="#gometalinter" class="headerlink" title="gometalinter"></a><a href="https://github.com/alecthomas/gometalinter" target="_blank" rel="noopener">gometalinter</a></h1><p>执行各种静态检查，支持各种第三方的lint tools</p>
<blockquote>
<p>Concurrently run Go lint tools and normalise their output</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go get -u gopkg.in/alecthomas/gometalinter.v1</span><br><span class="line">gometalinter.v1 --install</span><br><span class="line">gometalinter.v1 --vendor --skip=vendor...</span><br></pre></td></tr></table></figure>
<h1 id="depth"><a href="#depth" class="headerlink" title="depth"></a><a href="https://github.com/KyleBanks/depth" target="_blank" rel="noopener">depth</a></h1><p>查看依赖树</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/code/go/src/bb$ depth github.com/qjw/kelly</span><br><span class="line">github.com/qjw/kelly</span><br><span class="line">  ├ github.com/qjw/kelly/binding</span><br><span class="line">    └ gopkg.in/go-playground/validator.v9</span><br><span class="line">      └ github.com/go-playground/universal-translator</span><br><span class="line">        └ github.com/go-playground/locales</span><br><span class="line">          └ github.com/go-playground/locales/currency</span><br><span class="line">  ├ github.com/qjw/kelly/render</span><br><span class="line">  ├ github.com/julienschmidt/httprouter</span><br><span class="line">  ├ github.com/urfave/negroni</span><br></pre></td></tr></table></figure>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/08/20/golang-3rdtools/" data-id="ckdbgbyw5001y43po6dqdappq" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/08/20/golang-3rdtools/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li></ul>


    </footer>
  </div>
  
</article>



  
    <article id="post-sqlalchemy" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/23/sqlalchemy/">Flask sqlalchemy调优总结</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/07/23/sqlalchemy/" class="article-date"><time datetime="2017-07-23T12:23:11.000Z" itemprop="datePublished">2017-07-23</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/后端/">后端</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>直接用tcpdump监听数据库端口（mysql为例）可以打印所有的sql语句。（注意修改网卡的名称）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:/tmp$ sudo tcpdump -i lo -s 0 -l -w - dst port 3306 | strings | perl -e <span class="string">'</span></span><br><span class="line"><span class="string">while(&lt;&gt;) &#123; chomp; next if /^[^ ]+[ ]*$/;</span></span><br><span class="line"><span class="string">  if(/^(SELECT|UPDATE|DELETE|INSERT|SET|COMMIT|ROLLBACK|CREATE|DROP|ALTER)/i) &#123; </span></span><br><span class="line"><span class="string">    if (defined $q) &#123; print "$q\n"; &#125;</span></span><br><span class="line"><span class="string">    $q=$_;</span></span><br><span class="line"><span class="string">  &#125; else &#123;</span></span><br><span class="line"><span class="string">    $_ =~ s/^[ \t]+//; $q.=" $_";</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>由于stdout缓存，会有大概率最后几条出不来，（继续执行sql语句就会把这一次没出来的挤出来）</p>
<p><a href="http://docs.sqlalchemy.org/en/latest/faq/performance.html" target="_blank" rel="noopener">sqlalchemy官网</a>可以设置一些时间，用于监听任务执行的时间。注意</p>
<ol>
<li>before_cursor_execute</li>
<li>after_cursor_execute</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> event</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.engine <span class="keyword">import</span> Engine</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig()</span><br><span class="line">logger = logging.getLogger(<span class="string">"myapp.sqltime"</span>)</span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="meta">@event.listens_for(Engine, "before_cursor_execute")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">before_cursor_execute</span><span class="params">(conn, cursor, statement,</span></span></span><br><span class="line"><span class="function"><span class="params">                        parameters, context, executemany)</span>:</span></span><br><span class="line">    conn.info.setdefault(<span class="string">'query_start_time'</span>, []).append(time.time())</span><br><span class="line">    logger.debug(<span class="string">"Start Query: %s"</span>, statement)</span><br><span class="line"></span><br><span class="line"><span class="meta">@event.listens_for(Engine, "after_cursor_execute")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">after_cursor_execute</span><span class="params">(conn, cursor, statement,</span></span></span><br><span class="line"><span class="function"><span class="params">                        parameters, context, executemany)</span>:</span></span><br><span class="line">    total = time.time() - conn.info[<span class="string">'query_start_time'</span>].pop(<span class="number">-1</span>)</span><br><span class="line">    logger.debug(<span class="string">"Query Complete!"</span>)</span><br><span class="line">    logger.debug(<span class="string">"Total Time: %f"</span>, total)</span><br></pre></td></tr></table></figure>
<p>完整的事件文档参考</p>
<ol>
<li><a href="http://docs.sqlalchemy.org/en/latest/core/events.html" target="_blank" rel="noopener">http://docs.sqlalchemy.org/en/latest/core/events.html</a></li>
<li><a href="http://docs.sqlalchemy.org/en/latest/orm/events.html" target="_blank" rel="noopener">http://docs.sqlalchemy.org/en/latest/orm/events.html</a></li>
<li><a href="http://docs.sqlalchemy.org/en/latest/core/event.html#event-reference" target="_blank" rel="noopener">http://docs.sqlalchemy.org/en/latest/core/event.html#event-reference</a></li>
</ol>
<p>使用工具<a href="https://github.com/rkern/line_profiler" target="_blank" rel="noopener">line_profiler</a>分析调用时间，使用非常简单，在需要分析的函数加上【@prifile】注解,</p>
<p>若使用ide，会提示注解找不到符号，不用管他</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@profile</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    a = [<span class="number">1</span>]*<span class="number">100</span></span><br><span class="line">    b = [x*x*x <span class="keyword">for</span> x <span class="keyword">in</span> a ]</span><br><span class="line">    c = [x <span class="keyword">for</span> x <span class="keyword">in</span> b]</span><br><span class="line">    d = c*<span class="number">2</span></span><br><span class="line">run()</span><br></pre></td></tr></table></figure>
<hr>
<p>安装line_profiler会一并安装一个kernprof.py脚本，需要这个脚本运行我们的程序才会不出错</p>
<p>在程序退出后，-v参数会指示程序将结果输出到stdout，例如<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Total time: 8.55619 s</span><br><span class="line">File: /home/king/bug/venv/lib/python3.5/site-packages/sqlalchemy/orm/query.py</span><br><span class="line">Function: __iter__ at line 2733</span><br><span class="line"></span><br><span class="line">Line <span class="comment">#      Hits         Time  Per Hit   % Time  Line Contents</span></span><br><span class="line">==============================================================</span><br><span class="line">2733                                            @profile</span><br><span class="line">2734                                            def __iter__(self):</span><br><span class="line">2735      2176      1140139    524.0     13.3       context = self._compile_context()</span><br><span class="line">2736      2176         3682      1.7      0.0       context.statement.use_labels = True</span><br><span class="line">2737      2176         2284      1.0      0.0       <span class="keyword">if</span> self._autoflush and not self._populate_existing:</span><br><span class="line">2738      2176        28075     12.9      0.3           self.session._autoflush()</span><br><span class="line">2739      2176      7382008   3392.5     86.3       <span class="built_in">return</span> self._execute_and_instances(context)</span><br></pre></td></tr></table></figure></p>
<p>参考<a href="https://www.oschina.net/translate/python-performance-analysis?print" target="_blank" rel="noopener">https://www.oschina.net/translate/python-performance-analysis?print</a></p>
<p>也可以用cProfile来分析，参考</p>
<p>只需要在运行时，加上【-m cProfile】python选项<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python -m cProfile /home/king/code/bug/main.py</span><br></pre></td></tr></table></figure></p>
<p>然后在需要作分析测试的地方<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cProfile.run(<span class="string">'requests.get("http://tech.glowing.com")'</span>)</span><br></pre></td></tr></table></figure></p>
<p>一种更简单的办法<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> cProfile</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> pstats</span><br><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">profiled</span><span class="params">(limit=<span class="number">20</span>)</span>:</span></span><br><span class="line">    pr = cProfile.Profile()</span><br><span class="line">    pr.enable()</span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line">    pr.disable()</span><br><span class="line">    s = io.StringIO()</span><br><span class="line">    ps = pstats.Stats(pr, stream=s).sort_stats(<span class="string">'cumulative'</span>)</span><br><span class="line">    ps.print_stats(limit)</span><br><span class="line">    <span class="comment"># uncomment this to see who's calling what</span></span><br><span class="line">    <span class="comment"># ps.print_callers()</span></span><br><span class="line">    print(s.getvalue())</span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Test</span><span class="params">(cars)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> profiled(limit=<span class="number">30</span>):</span><br><span class="line">        <span class="keyword">for</span> num <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">20</span>):</span><br><span class="line">            <span class="keyword">for</span> car <span class="keyword">in</span> cars:</span><br><span class="line">                car.test()</span><br></pre></td></tr></table></figure>
<p>参考</p>
<ol>
<li><a href="http://docs.sqlalchemy.org/en/latest/faq/performance.html" target="_blank" rel="noopener">http://docs.sqlalchemy.org/en/latest/faq/performance.html</a></li>
<li><a href="http://tech.glowing.com/cn/python-profiling/" target="_blank" rel="noopener">http://tech.glowing.com/cn/python-profiling/</a></li>
<li><a href="http://ju.outofmemory.cn/entry/284150" target="_blank" rel="noopener">http://ju.outofmemory.cn/entry/284150</a></li>
</ol>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://blog.kimq.cn/2017/07/23/sqlalchemy/" data-id="ckdbgbyxu005943pod1q2a0yx" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
        <a href="http://blog.kimq.cn/2017/07/23/sqlalchemy/#disqus_thread" class="article-comment-link">
          <i class="fa fa-comment"></i> Comments
        </a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flask/">flask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sqlalchemy/">sqlalchemy</a></li></ul>


    </footer>
  </div>
  
</article>



  


  <div id="page-nav">
    <nav><ul class="pagination"><li><a class="page-prev" rel="prev" href="/page/2/"><i class="fa fa-chevron-left"></i> Prev</a></li><li><a class="page-number" href="/">1</a></li><li><a class="page-number" href="/page/2/">2</a></li><li class="active"><span class="page-number">3</span></li><li><a class="page-number" href="/page/4/">4</a></li><li><a class="page-number" href="/page/5/">5</a></li><li class="disabled"><span class="page-space">&hellip;</span></li><li><a class="page-number" href="/page/7/">7</a></li><li><a class="page-next" rel="next" href="/page/4/">Next <i class="fa fa-chevron-right"></i></a></li></ul></nav>
  </div>



        </div>
        <div class="col-sm-2 col-sm-offset-1 blog-sidebar">
          
  
  <div class="sidebar-module">
    <h4>Categories</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Golang/">Golang</a><span class="sidebar-module-list-count">14</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Openldap/">Openldap</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Python/">Python</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/后端/">后端</a><span class="sidebar-module-list-count">11</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/学习笔记/">学习笔记</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/开发环境/">开发环境</a><span class="sidebar-module-list-count">13</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/源码学习/">源码学习</a><span class="sidebar-module-list-count">9</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/环境搭建/">环境搭建</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/运营运维/">运营运维</a><span class="sidebar-module-list-count">10</span><ul class="sidebar-module-list-child"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/运营运维/代理/">代理</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/运营运维/网站/">网站</a><span class="sidebar-module-list-count">1</span></li></ul></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tags</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ansible/">ansible</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/antd/">antd</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/cookie/">cookie</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/cors/">cors</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/crsf/">crsf</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/docker/">docker</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/drone/">drone</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/elasticsearch/">elasticsearch</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/flask/">flask</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/git/">git</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/github/">github</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/gitlab/">gitlab</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/golang/">golang</a><span class="sidebar-module-list-count">27</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/gorm/">gorm</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/grpc/">grpc</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/hexo/">hexo</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/influxdb/">influxdb</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/jsonp/">jsonp</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/jsonschema/">jsonschema</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/kibana/">kibana</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/martini/">martini</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/nginx/">nginx</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ngrok/">ngrok</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/node/">node</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/openldap/">openldap</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/pip/">pip</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/proxy/">proxy</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/python/">python</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/redis/">redis</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/sentry/">sentry</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/sqlalchemy/">sqlalchemy</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ssh/">ssh</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/sso/">sso</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/tars/">tars</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/tavern/">tavern</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/travis/">travis</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/uml/">uml</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/wcgi/">wcgi</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/xss/">xss</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/一致性hash/">一致性hash</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/持续集成/">持续集成</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/盗链/">盗链</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/签名/">签名</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/证书/">证书</a><span class="sidebar-module-list-count">2</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Tag Cloud</h4>
    <p class="tagcloud">
      <a href="/tags/ansible/" style="font-size: 10px;">ansible</a> <a href="/tags/antd/" style="font-size: 10px;">antd</a> <a href="/tags/cookie/" style="font-size: 11.67px;">cookie</a> <a href="/tags/cors/" style="font-size: 10px;">cors</a> <a href="/tags/crsf/" style="font-size: 10px;">crsf</a> <a href="/tags/docker/" style="font-size: 13.33px;">docker</a> <a href="/tags/drone/" style="font-size: 16.67px;">drone</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/flask/" style="font-size: 11.67px;">flask</a> <a href="/tags/git/" style="font-size: 11.67px;">git</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/gitlab/" style="font-size: 11.67px;">gitlab</a> <a href="/tags/golang/" style="font-size: 20px;">golang</a> <a href="/tags/gorm/" style="font-size: 10px;">gorm</a> <a href="/tags/grpc/" style="font-size: 10px;">grpc</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/influxdb/" style="font-size: 10px;">influxdb</a> <a href="/tags/jsonp/" style="font-size: 10px;">jsonp</a> <a href="/tags/jsonschema/" style="font-size: 10px;">jsonschema</a> <a href="/tags/kibana/" style="font-size: 10px;">kibana</a> <a href="/tags/martini/" style="font-size: 10px;">martini</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/ngrok/" style="font-size: 11.67px;">ngrok</a> <a href="/tags/node/" style="font-size: 10px;">node</a> <a href="/tags/openldap/" style="font-size: 13.33px;">openldap</a> <a href="/tags/pip/" style="font-size: 10px;">pip</a> <a href="/tags/proxy/" style="font-size: 13.33px;">proxy</a> <a href="/tags/python/" style="font-size: 11.67px;">python</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/sentry/" style="font-size: 11.67px;">sentry</a> <a href="/tags/sqlalchemy/" style="font-size: 10px;">sqlalchemy</a> <a href="/tags/ssh/" style="font-size: 11.67px;">ssh</a> <a href="/tags/sso/" style="font-size: 10px;">sso</a> <a href="/tags/tars/" style="font-size: 10px;">tars</a> <a href="/tags/tavern/" style="font-size: 10px;">tavern</a> <a href="/tags/travis/" style="font-size: 10px;">travis</a> <a href="/tags/uml/" style="font-size: 10px;">uml</a> <a href="/tags/wcgi/" style="font-size: 10px;">wcgi</a> <a href="/tags/xss/" style="font-size: 10px;">xss</a> <a href="/tags/一致性hash/" style="font-size: 10px;">一致性hash</a> <a href="/tags/持续集成/" style="font-size: 18.33px;">持续集成</a> <a href="/tags/盗链/" style="font-size: 10px;">盗链</a> <a href="/tags/签名/" style="font-size: 11.67px;">签名</a> <a href="/tags/证书/" style="font-size: 11.67px;">证书</a>
    </p>
  </div>


  
  <div class="sidebar-module">
    <h4>Archives</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/08/">八月 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/06/">六月 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/03/">三月 2020</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/02/">二月 2020</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/01/">一月 2020</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/07/">七月 2018</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/06/">六月 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/05/">五月 2018</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/12/">十二月 2017</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/10/">十月 2017</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/08/">八月 2017</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/07/">七月 2017</a><span class="sidebar-module-list-count">8</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/06/">六月 2017</a><span class="sidebar-module-list-count">7</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/04/">四月 2017</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/03/">三月 2017</a><span class="sidebar-module-list-count">10</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/02/">二月 2017</a><span class="sidebar-module-list-count">10</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Recents</h4>
    <ul class="sidebar-module-list">
      
        <li>
          <a href="/2020/08/01/gitlab-sentry/">gitlab/sentry集成</a>
        </li>
      
        <li>
          <a href="/2020/06/10/ansible/">Ansible实践</a>
        </li>
      
        <li>
          <a href="/2020/03/08/elasticsearch_basic/">ElasticSearch学习笔记</a>
        </li>
      
        <li>
          <a href="/2020/02/29/jaeger_basic/">Jaeger初探</a>
        </li>
      
        <li>
          <a href="/2020/02/20/tavern/">ResfulApi测试框架tavern</a>
        </li>
      
    </ul>
  </div>



        </div>
    </div>
  </div>
  <footer class="blog-footer">
  <div class="container">
    <div id="footer-info" class="inner">
      &copy; 2020 KingQiu<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      <br/>
      CopyRight © 2019 <a href="http://beian.miit.gov.cn/" target="_blank">粤ICP备19068003号</a>
    </div>
  </div>
</footer>
<script>
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

  
<script>
  var disqus_shortname = 'blog-qiujinwu-com';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js" crossorigin="anonymous"></script>

<script src="http://cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js" crossorigin="anonymous"></script>



<script src="/js/script.js"></script>

</body>
</html>
