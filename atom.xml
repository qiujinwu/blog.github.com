<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>个人笔记</title>
  
  <subtitle>专注互联网</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.kimq.cn/"/>
  <updated>2020-08-01T09:26:24.727Z</updated>
  <id>http://blog.kimq.cn/</id>
  
  <author>
    <name>KingQiu</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>gitlab/sentry集成</title>
    <link href="http://blog.kimq.cn/2020/08/01/gitlab-sentry/"/>
    <id>http://blog.kimq.cn/2020/08/01/gitlab-sentry/</id>
    <published>2020-08-01T02:36:35.000Z</published>
    <updated>2020-08-01T09:26:24.727Z</updated>
    
    <content type="html"><![CDATA[<p>gitlab/sentry都通过docker在本机运行, 本机docker 接口ip地址<code>172.17.0.1</code></p><p>参考旧文</p><ul><li><a href="https://blog.kimq.cn/2017/06/19/gitlab-env/">搭建gitlab测试环境</a></li><li><a href="https://blog.kimq.cn/2017/03/10/sentry/">Sentry</a></li></ul><h1 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h1><h2 id="运行Sentry"><a href="#运行Sentry" class="headerlink" title="运行Sentry"></a>运行Sentry</h2><p>为了避免端口冲突, sentry端口改成8081</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -d --name my-sentry -e SENTRY_SECRET_KEY=&apos;&lt;KEY&gt;&apos; \</span><br><span class="line">-p 8081:9000 \</span><br><span class="line">--link sentry-redis:redis --link sentry-postgres:postgres sentry:9.1.2</span><br></pre></td></tr></table></figure><h2 id="运行Gitlab"><a href="#运行Gitlab" class="headerlink" title="运行Gitlab"></a>运行Gitlab</h2><ul><li>这里指定了ce的版本, 避免新版本再测试出现不一致</li><li>通过参数指定了<code>hostname</code>为docker的ip</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -it --rm  \</span><br><span class="line">    --hostname 172.17.0.1 \</span><br><span class="line">    --publish 8080:80 --publish 2222:22 \</span><br><span class="line">    --name gitlab \</span><br><span class="line">    --volume /gitlab/config:/etc/gitlab \</span><br><span class="line">    --volume /gitlab/logs:/var/log/gitlab \</span><br><span class="line">    --volume /gitlab/data:/var/opt/gitlab \</span><br><span class="line">    gitlab/gitlab-ce:12.9.10-ce.0</span><br></pre></td></tr></table></figure><blockquote><p>22端口容易被现有服务占用, 这里使用<code>2222端口</code>用作代码传输的ssl通道</p></blockquote><p>可以修改本机的<code>~/.ssh/config</code>, 参考<a href="https://stackoverflow.com/questions/3596260/git-remote-add-with-other-ssh-port" target="_blank" rel="noopener">这里</a><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat ~/.ssh/config </span><br><span class="line">HOST 172.17.0.1</span><br><span class="line">    Port 2222</span><br></pre></td></tr></table></figure></p><h1 id="gitlab集成sentry"><a href="#gitlab集成sentry" class="headerlink" title="gitlab集成sentry"></a>gitlab集成sentry</h1><blockquote><p>可以查看对应proj的问题,以及作出处理</p></blockquote><p>就是gitlab里面使用sentry的功能, 所以需要去sentry<code>赋(授)能(权)</code></p><ul><li>登录sentry</li><li>左上角 - 个人中心 - 下拉菜单 - API key</li><li>打开页面, 找到或者创建auth token, 需要<code>project:read, event:read</code> 两个权限</li></ul><p>完整流程, 可以查看<a href="https://docs.gitlab.com/ee/operations/error_tracking.html" target="_blank" rel="noopener">Gitlab Error Tracking</a></p><h2 id="gitlab-proj启用error-tracking"><a href="#gitlab-proj启用error-tracking" class="headerlink" title="gitlab proj启用error tracking"></a>gitlab proj启用<code>error tracking</code></h2><ul><li>Navigate to your project’s <code>Settings &gt; Operations</code>.</li><li>Ensure that the <code>Active</code> checkbox is set.</li><li>In the Sentry API URL field, enter your Sentry hostname. For example, enter <a href="https://sentry.example.com" target="_blank" rel="noopener">https://sentry.example.com</a> (本例<code>http://172.17.0.1:8081/</code>) if this is the address at which your Sentry instance is available. For the SaaS version of Sentry, the hostname will be <a href="https://sentry.io" target="_blank" rel="noopener">https://sentry.io</a>.</li><li>In the Auth Token field, enter the token you <code>previously generated</code>(见上一步生成的token).</li><li>Click the Connect button to test the connection to Sentry and populate the Project dropdown.</li><li>From the Project dropdown, choose a <code>Sentry project</code> to link to your GitLab project.</li><li>Click <code>Save changes</code> for the changes to take effect.</li><li>You can now visit <code>Operations &gt; Error Tracking</code> in your project’s sidebar to view a list of Sentry errors.</li></ul><p>到此, 我们可以在gitlab看到对应项目的所有senry 问题记录, 对于<code>gitlab-ce:12.9.10-ce.0</code> , 最上面可以<code>查看/过滤</code>问题, 也可以<code>忽略/解决</code>问题, 也可以基于问题新建一个<code>gitlab issue</code></p><blockquote><p>这些操作需要额外的<code>event:admin</code> 权限</p></blockquote><p>而更早的<code>gitlab-ce:12.3.5-ce.0</code> 就只有一个简单的列表</p><blockquote><p>对于本机自建的gitlab, 有可能报错<code>Connection has failed. Re-check Auth Token and try again</code>, 参考<a href="https://gitlab.com/gitlab-org/gitlab/-/issues/32314" target="_blank" rel="noopener">这里</a></p></blockquote><p>GitLab -&gt; Admim area -&gt; Settings -&gt; Network -&gt; Outbound requests -&gt; Allow requests to the local network from hooks and services</p><p>By checking both boxes, everything worked as documented.</p><h1 id="Sentry-集成-gitlab"><a href="#Sentry-集成-gitlab" class="headerlink" title="Sentry 集成 gitlab"></a>Sentry 集成 gitlab</h1><blockquote><p>可以直接在sentry创建gitlab issue</p></blockquote><ul><li>In Sentry, navigate to Organization <code>Settings &gt; Integrations</code>.</li><li>Within Integrations, find the <code>GitLab icon</code> and click Install.</li><li>In the resulting modal, click <code>Add Installation</code>.</li><li>In the pop-up window, complete the instructions to create a Sentry app within GitLab. Once you’re finished, click Next.</li><li>Fill out the resulting GitLab Configuration form with the following information:<ul><li>The GitLab URL is the base URL for your GitLab instance. If using gitlab.com, enter <a href="http://172.17.0.1:8080" target="_blank" rel="noopener">http://172.17.0.1:8080</a></li><li>Find the GitLab Group Path in your group’s GitLab page. 自定, 必须gitlab存在</li><li>Find the GitLab Application ID and Secret in the Sentry app within GitLab.<ul><li>GitLab Application ID : gitlab生成 - GitLab Application Secret : gitlab生成</li></ul></li><li>Use this information to fill out the GitLab Configuration and click Submit.</li></ul></li><li>In the resulting panel, click <code>Authorize</code>.</li><li>In Sentry, return to Organization Settings &gt; Integrations. You’ll see a new instance of GitLab underneath the list of integrations.</li><li>Next to your GitLab Instance, click Configure. It’s important to configure to receive the full benefits of commit tracking.</li><li>On the resulting page, click Add Repository to select which repositories in which you’d like to begin tracking commits.</li></ul><p>完整记录参考<a href="https://docs.sentry.io/workflow/integrations/gitlab/" target="_blank" rel="noopener">integrations gitlab</a></p><h2 id="生成gitlab-application"><a href="#生成gitlab-application" class="headerlink" title="生成gitlab application"></a>生成gitlab application</h2><p>具体的流程参考 <a href="https://docs.gitlab.com/ee/integration/oauth_provider.html" target="_blank" rel="noopener">GitLab as OAuth2 authentication service provider</a></p><ul><li>Name : Sentry (自定义)</li><li>Redirect URI : <a href="http://172.17.0.1:8081/extensions/gitlab/setup/" target="_blank" rel="noopener">http://172.17.0.1:8081/extensions/gitlab/setup/</a></li><li>Scopes : <code>api</code></li></ul><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://docs.gitlab.com/ee/operations/error_tracking.html" target="_blank" rel="noopener">https://docs.gitlab.com/ee/operations/error_tracking.html</a></li><li><a href="https://docs.gitlab.com/ee/integration/oauth_provider.html" target="_blank" rel="noopener">https://docs.gitlab.com/ee/integration/oauth_provider.html</a></li><li><a href="https://docs.sentry.io/workflow/integrations/gitlab/" target="_blank" rel="noopener">https://docs.sentry.io/workflow/integrations/gitlab/</a></li><li><a href="https://gitlab.com/gitlab-org/gitlab/-/issues/32314" target="_blank" rel="noopener">https://gitlab.com/gitlab-org/gitlab/-/issues/32314</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;gitlab/sentry都通过docker在本机运行, 本机docker 接口ip地址&lt;code&gt;172.17.0.1&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;参考旧文&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://blog.kimq.cn/2017/06/19/git
      
    
    </summary>
    
      <category term="开发环境" scheme="http://blog.kimq.cn/categories/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"/>
    
    
      <category term="gitlab" scheme="http://blog.kimq.cn/tags/gitlab/"/>
    
      <category term="sentry" scheme="http://blog.kimq.cn/tags/sentry/"/>
    
  </entry>
  
  <entry>
    <title>Ansible实践</title>
    <link href="http://blog.kimq.cn/2020/06/10/ansible/"/>
    <id>http://blog.kimq.cn/2020/06/10/ansible/</id>
    <published>2020-06-10T16:00:00.000Z</published>
    <updated>2020-08-01T09:26:24.727Z</updated>
    
    <content type="html"><![CDATA[<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install software-properties-common</span><br><span class="line">$ sudo apt-add-repository ppa:ansible/ansible</span><br><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install ansible</span><br></pre></td></tr></table></figure><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /etc/ansible/hosts  | sed -e <span class="string">"/^#/d"</span> -e <span class="string">"/^$/d"</span></span><br><span class="line">localhost ansible_connection=<span class="built_in">local</span></span><br></pre></td></tr></table></figure><h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ansible all -a &quot;whoami&quot;</span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br></pre></td></tr></table></figure><h1 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h1><p>文件路径<code>/etc/ansible/hosts</code></p><figure class="highlight"><table><tr><td class="code"><pre><span class="line">192.168.1.50</span><br><span class="line">aserver.example.org</span><br><span class="line">bserver.example.org</span><br></pre></td></tr></table></figure><p>ansible 典型参数</p><ul><li>可用性<code>-m ping</code></li><li>执行commands <code>-a cmd</code></li><li>全局替换ssh登录用户 <code>-u</code></li><li>全局替换ssh key <code>--private-key</code></li><li>sudo <code>--sudo</code>, <code>--sudo-user root2</code></li><li><code>--list-hosts</code> 列出hosts</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 第一个参数有个特例，all表示所有</span></span><br><span class="line">$ ansible localhost  -m ping</span><br><span class="line">localhost | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">$ ansible all -a <span class="string">"whoami"</span></span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">$ sudo ansible all -a <span class="string">"whoami"</span> -u root --sudo</span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">root</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出特定name的hosts</span></span><br><span class="line">$ ansible <span class="built_in">test</span> --list-hosts</span><br><span class="line">  hosts (2):</span><br><span class="line">    virtualbox</span><br><span class="line">    localhost</span><br></pre></td></tr></table></figure><h2 id="ssh-key"><a href="#ssh-key" class="headerlink" title="ssh key"></a>ssh key</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ssh-keygen </span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/home/king/.ssh/id_rsa): /home/king/.ssh/ansible</span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /home/king/.ssh/ansible.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /home/king/.ssh/ansible.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:T1liGGmbLRZI4lKIIdWn3gvWg8h/6F7hi/tgpFsNbPk king@king</span><br><span class="line">The key<span class="string">'s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 2048]----+</span></span><br><span class="line"><span class="string">|o+.oo.....       |</span></span><br><span class="line"><span class="string">|o .o..o +o       |</span></span><br><span class="line"><span class="string">|  . .o ..=o .    |</span></span><br><span class="line"><span class="string">|   o..  =..+     |</span></span><br><span class="line"><span class="string">| . o*+..S.o      |</span></span><br><span class="line"><span class="string">|  o+==+. o       |</span></span><br><span class="line"><span class="string">|  .o+oEo  .      |</span></span><br><span class="line"><span class="string">|   +o+o.         |</span></span><br><span class="line"><span class="string">|  .o=+o          |</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br><span class="line"><span class="string">$ ssh-copy-id -i ~/.ssh/ansible -o "PubkeyAuthentication no" king@192.168.2.131</span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/home/king/.ssh/ansible.pub"</span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span></span><br><span class="line"><span class="string">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span></span><br><span class="line"><span class="string">king@192.168.2.131'</span>s password: </span><br><span class="line">Number of key(s) added: 1</span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh -o 'PubkeyAuthentication no' 'king@192.168.2.131'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"><span class="comment"># 注意`SSH_AUTH_SOCK`</span></span><br><span class="line">$ SSH_AUTH_SOCK=0  ssh -i /home/king/.ssh/ansible  king@192.168.2.131</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ SSH_AUTH_SOCK=0 ansible 192.168.2.131 -a whoami --private-key=/home/king/.ssh/ansible </span><br><span class="line">192.168.2.131 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br></pre></td></tr></table></figure><h1 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h1><ul><li>ansible_ssh_host 将要连接的远程主机名.与你想要设定的主机的别名不同的话,可通过此变量设置.</li><li>ansible_ssh_port ssh端口号.如果不是默认的端口号,通过此变量设置.</li><li>ansible_ssh_user 默认的 ssh 用户名</li><li>ansible_ssh_pass ssh 密码(这种方式并不安全,我们强烈建议使用 –ask-pass 或 SSH 密钥)</li><li>ansible_sudo_pass sudo 密码(这种方式并不安全,我们强烈建议使用 –ask-sudo-pass)</li><li>ansible_sudo_exe (new in version 1.8) sudo 命令路径(适用于1.8及以上版本)</li><li>ansible_connection 与主机的连接类型.比如:local, ssh 或者 paramiko. Ansible 1.2 以前默认使用 paramiko.1.2 以后默认使用 ‘smart’,’smart’ 方式会根据是否支持 ControlPersist, 来判断’ssh’ 方式是否可行.</li><li>ansible_ssh_private_key_file ssh 使用的私钥文件.适用于有多个密钥,而你不想使用 SSH 代理的情况.</li><li>ansible_shell_type 目标系统的shell类型.默认情况下,命令的执行使用 ‘sh’ 语法,可设置为 ‘csh’ 或 ‘fish’.</li></ul><p>修改<code>/etc/ansible/hosts</code><br><figure class="highlight"><table><tr><td class="code"><pre><span class="line">192.168.2.131 ansible_ssh_user=king ansible_ssh_private_key_file=/home/king/.ssh/ansible</span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ SSH_AUTH_SOCK=0 ansible all -a whoami </span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">192.168.2.131 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br></pre></td></tr></table></figure><h2 id="组和别名"><a href="#组和别名" class="headerlink" title="组和别名"></a>组和别名</h2><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[test]</span></span><br><span class="line"><span class="comment">#192.168.2.131 ansible_ssh_user=king ansible_ssh_private_key_file=/home/king/ansible</span></span><br><span class="line">virtualbox ansible_ssh_host=192.168.2.131 ansible_ssh_user=king ansible_ssh_private_key_file=/home/king/ansible</span><br><span class="line">localhost              ansible_connection=local</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ SSH_AUTH_SOCK=0 ansible <span class="built_in">test</span> -a whoami </span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">192.168.2.131 | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">$ SSH_AUTH_SOCK=0 ansible <span class="built_in">test</span> -a whoami </span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">virtualbox | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br></pre></td></tr></table></figure><h3 id="主机-amp-组变量"><a href="#主机-amp-组变量" class="headerlink" title="主机&amp;组变量"></a>主机&amp;组变量</h3><p><code>/etc/ansible/hosts</code> 每个主机支持一系列参数, 如果一个组的参数有重复, 可以做成<code>组变量</code><br><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[bastion]</span></span><br><span class="line">b1 ansible_ssh_user=admin ansible_ssh_private_key_file=/home/king/.ssh/bastion</span><br><span class="line">b2 ansible_ssh_user=admin ansible_ssh_private_key_file=/home/king/.ssh/bastion</span><br><span class="line">b3 ansible_ssh_user=admin ansible_ssh_private_key_file=/home/king/.ssh/bastion</span><br></pre></td></tr></table></figure></p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[bastion]</span></span><br><span class="line">b1 </span><br><span class="line">b2 </span><br><span class="line">b3 </span><br><span class="line"></span><br><span class="line"><span class="section">[bastion:vars]</span></span><br><span class="line"><span class="attr">ansible_ssh_user</span>=admin </span><br><span class="line"><span class="attr">ansible_ssh_private_key_file</span>=/home/king/.ssh/bastion</span><br></pre></td></tr></table></figure><h1 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h1><ul><li><code>ansible-doc -l</code> 来列出支持的模块</li><li><code>ansible-doc -s command</code> 列出特定模块的指引</li></ul><blockquote><p>默认ansible使用的模块是<code>command</code>，即可以执行一些<code>shell</code>命令。shell和command的用法基本一样，实际上shell模块执行命令的方式是在远程使用<code>/bin/sh</code>来执行的</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible <span class="built_in">test</span> -m <span class="built_in">command</span> -a whoami</span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">virtualbox | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">$ ansible <span class="built_in">test</span> -m shell -a whoami</span><br><span class="line">localhost | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br><span class="line"></span><br><span class="line">virtualbox | SUCCESS | rc=0 &gt;&gt;</span><br><span class="line">king</span><br></pre></td></tr></table></figure><blockquote><p>最开始的<code>ping</code>也是一个特定的模块</p></blockquote><h2 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h2><p>拷贝文件到服务器, 会自动判断是否有修改</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ansible virtualbox -m copy -a src=&quot;~/1.pdf dest=/tmp mode=0770 owner=king group=fa backup=yes&quot;</span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;checksum&quot;: &quot;429b1cd33dcb3e71e9975e424994906f10c6d98d&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/1.pdf&quot;, </span><br><span class="line">    &quot;gid&quot;: 1000, </span><br><span class="line">    &quot;group&quot;: &quot;fa&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0770&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;king&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;/tmp/1.pdf&quot;, </span><br><span class="line">    &quot;size&quot;: 56111, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 1000</span><br><span class="line">&#125;</span><br><span class="line">$ ansible virtualbox -m copy -a src=&quot;~/1.pdf dest=/tmp mode=0770 owner=king group=fa backup=yes&quot;</span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false, </span><br><span class="line">    &quot;checksum&quot;: &quot;429b1cd33dcb3e71e9975e424994906f10c6d98d&quot;, </span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/1.pdf&quot;, </span><br><span class="line">    &quot;gid&quot;: 1000, </span><br><span class="line">    &quot;group&quot;: &quot;fa&quot;, </span><br><span class="line">    &quot;mode&quot;: &quot;0770&quot;, </span><br><span class="line">    &quot;owner&quot;: &quot;king&quot;, </span><br><span class="line">    &quot;path&quot;: &quot;/tmp/1.pdf&quot;, </span><br><span class="line">    &quot;size&quot;: 56111, </span><br><span class="line">    &quot;state&quot;: &quot;file&quot;, </span><br><span class="line">    &quot;uid&quot;: 1000</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 目录也支持</span><br><span class="line">$ ansible virtualbox -m copy -a src=&quot;~/s dest=/tmp&quot;</span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: true, </span><br><span class="line">    &quot;dest&quot;: &quot;/tmp/&quot;, </span><br><span class="line">    &quot;src&quot;: &quot;/home/king/s&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>如果使用”/“结尾，则拷贝的是目录中的文件，如果不以斜杠结尾，则拷贝的是目录加目录中的文件。</p></blockquote><h2 id="file"><a href="#file" class="headerlink" title="file"></a>file</h2><p>管理文件、目录的属性，也可以创建文件或目录。</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ansible-doc -s file</span><br><span class="line">- name: Sets attributes of files</span><br><span class="line">  action: file</span><br><span class="line">      group       # file/directory的所属组</span><br><span class="line">      owner       # file/directory的所有者</span><br><span class="line">      mode        # 修改权限，格式可以是0644、&apos;u+rwx&apos;或&apos;u=rw,g=r,o=r&apos;等</span><br><span class="line">      path=       # 指定待操作的文件，可使用别名&apos;dest&apos;或&apos;name&apos;来替代path</span><br><span class="line">      recurse     # (默认no)递归修改文件的属性信息，要求state=directory</span><br><span class="line">      src         # 创建链接时使用，指定链接的源文件</span><br><span class="line">      state       # directory:如果目录不存在则递归创建</span><br><span class="line">                  # file:文件不存在时，不会被创建(默认值)</span><br><span class="line">                  # touch:touch由path指定的文件，即创建一个新文件，或修改其mtime和atime</span><br><span class="line">                  # link:修改或创建软链接</span><br><span class="line">                  # hard:修改或创建硬链接</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible virtualbox -m file -a <span class="string">'path=/tmp/x/y/z state=directory owner=king group=fa mode=0755 recurse=yes'</span></span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"gid"</span>: 1000, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"fa"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0755"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"king"</span>, </span><br><span class="line">    <span class="string">"path"</span>: <span class="string">"/tmp/x/y/z"</span>, </span><br><span class="line">    <span class="string">"size"</span>: 4096, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"directory"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: 1000</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="fetch"><a href="#fetch" class="headerlink" title="fetch"></a>fetch</h2><p>和<code>copy</code>工作方式类似，只不过是从远程主机将文件拉取到本地端，存储时使用主机名作为目录树，且只能拉取文件不能拉取目录。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-doc -s fetch</span><br><span class="line">- name: Fetches a file from remote nodes</span><br><span class="line">  action: fetch</span><br><span class="line">      dest=               <span class="comment"># 本地存储拉取文件的目录。例如dest=/data，src=/etc/fstab，</span></span><br><span class="line">                          <span class="comment"># 远程主机名host.exp.com，则保存的路径为/data/host.exp.com/etc/fstab。</span></span><br><span class="line">      fail_on_missing     <span class="comment"># 当设置为yes时，如果拉取的源文件不存在，则此任务失败。默认为no。</span></span><br><span class="line">      flat                <span class="comment"># 改变拉取后的路径存储方式。如果设置为yes，且当dest以"/"结尾时，将直接把源文件</span></span><br><span class="line">                          <span class="comment"># 的basename存储在dest下。显然，应该考虑多个主机拉取时的文件覆盖情况。</span></span><br><span class="line">      src=                <span class="comment"># 远程主机上的源文件。只能是文件，不支持目录。在未来的版本中可能会支持目录递归拉取。</span></span><br><span class="line">      validate_checksum   <span class="comment"># fetch到文件后，检查其md5和源文件是否相同。</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible virtualbox -m fetch -a <span class="string">"src=/tmp/1.pdf dest=/tmp/"</span></span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"checksum"</span>: <span class="string">"429b1cd33dcb3e71e9975e424994906f10c6d98d"</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/virtualbox/tmp/1.pdf"</span>, </span><br><span class="line">    <span class="string">"md5sum"</span>: <span class="string">"d7fa85f4857527c3a58290a0be2b679a"</span>, </span><br><span class="line">    <span class="string">"remote_checksum"</span>: <span class="string">"429b1cd33dcb3e71e9975e424994906f10c6d98d"</span>, </span><br><span class="line">    <span class="string">"remote_md5sum"</span>: null</span><br><span class="line">&#125;</span><br><span class="line">$ ansible virtualbox -m fetch -a <span class="string">"src=/tmp/1.pdf dest=/tmp/ flat=yes"</span></span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"checksum"</span>: <span class="string">"429b1cd33dcb3e71e9975e424994906f10c6d98d"</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/1.pdf"</span>, </span><br><span class="line">    <span class="string">"md5sum"</span>: <span class="string">"d7fa85f4857527c3a58290a0be2b679a"</span>, </span><br><span class="line">    <span class="string">"remote_checksum"</span>: <span class="string">"429b1cd33dcb3e71e9975e424994906f10c6d98d"</span>, </span><br><span class="line">    <span class="string">"remote_md5sum"</span>: null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="apt"><a href="#apt" class="headerlink" title="apt"></a>apt</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 yes/safe/full/dist</span></span><br><span class="line">$ ansible virtualbox -m apt -a <span class="string">"name=dos2unix update_cache=yes"</span> --sudo --ask-sudo-pass</span><br><span class="line">SUDO password: </span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"cache_update_time"</span>: 1591944887, </span><br><span class="line">    <span class="string">"cache_updated"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"stderr"</span>: <span class="string">""</span>, </span><br><span class="line">    <span class="string">"stdout"</span>: <span class="string">"正在读取软件包列表..."</span></span><br><span class="line"><span class="comment"># 移除</span></span><br><span class="line">$ ansible virtualbox -m apt -a <span class="string">"name=dos2unix state=absent"</span> --sudo --ask-sudo-pass</span><br><span class="line"><span class="comment"># 安装 latest/absent/present</span></span><br><span class="line">$ ansible virtualbox -m apt -a <span class="string">"name=dos2unix state=present"</span> --sudo --ask-sudo-pass</span><br></pre></td></tr></table></figure><h2 id="service"><a href="#service" class="headerlink" title="service"></a>service</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># running,started,stopped,restarted,reloaded</span></span><br><span class="line">$ ansible virtualbox -m service -a <span class="string">"name=nginx state=stopped "</span> --sudo --ask-sudo-pass</span><br><span class="line">SUDO password: </span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"nginx"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"stopped"</span></span><br><span class="line">&#125;</span><br><span class="line">$ ansible virtualbox -m service -a <span class="string">"name=nginx state=stopped "</span> --sudo --ask-sudo-pass</span><br><span class="line">SUDO password: </span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"nginx"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"stopped"</span></span><br><span class="line">&#125;</span><br><span class="line">$ ansible virtualbox -m service -a <span class="string">"name=nginx state=started "</span> --sudo --ask-sudo-pass</span><br><span class="line">SUDO password: </span><br><span class="line">virtualbox | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"nginx"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"started"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="playbook"><a href="#playbook" class="headerlink" title="playbook"></a>playbook</h2><p>一个playboook包含多个play, 每个play包含多个节</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">virtualbox</span></span><br><span class="line">  <span class="attr">tasks:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">execute</span> <span class="string">date</span> <span class="string">cmd</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/date</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">date</span> <span class="comment"># 注册到一个变量, 以便打印stdout</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">execute</span> <span class="string">shell</span> <span class="string">whoami</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">whoami</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">whoami</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">var=date.stdout_lines</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">msg="&#123;&#123;</span> <span class="string">whoami.stdout</span> <span class="string">&#125;&#125;"</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">virtualbox</span></span><br><span class="line">  <span class="attr">tasks:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">execute</span> <span class="string">date</span> <span class="string">cmd</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span> <span class="string">msg="&#123;&#123;</span> <span class="string">nginx</span> <span class="string">&#125;&#125;"</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible-playbook a.yaml </span><br><span class="line"></span><br><span class="line">PLAY ***************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [setup] *******************************************************************</span><br><span class="line">ok: [virtualbox]</span><br><span class="line"></span><br><span class="line">TASK [execute date cmd] ********************************************************</span><br><span class="line">changed: [virtualbox]</span><br><span class="line"></span><br><span class="line">TASK [execute shell whoami] ****************************************************</span><br><span class="line">changed: [virtualbox]</span><br><span class="line"></span><br><span class="line">TASK [debug] *******************************************************************</span><br><span class="line">ok: [virtualbox] =&gt; &#123;</span><br><span class="line">    <span class="string">"date.stdout_lines"</span>: [</span><br><span class="line">        <span class="string">"2020年 06月 12日 星期五 15:50:36 CST"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [debug] *******************************************************************</span><br><span class="line">ok: [virtualbox] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"king"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY ***************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [setup] *******************************************************************</span><br><span class="line">ok: [virtualbox]</span><br><span class="line"></span><br><span class="line">TASK [execute date cmd] ********************************************************</span><br><span class="line">ok: [virtualbox]</span><br><span class="line"></span><br><span class="line">TASK [debug] *******************************************************************</span><br><span class="line">ok: [virtualbox] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: &#123;</span><br><span class="line">        <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"nginx"</span>, </span><br><span class="line">        <span class="string">"state"</span>: <span class="string">"started"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************</span><br><span class="line">virtualbox                 : ok=8    changed=2    unreachable=0    failed=0</span><br></pre></td></tr></table></figure><h1 id="Bastion"><a href="#Bastion" class="headerlink" title="Bastion"></a>Bastion</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[server]</span><br><span class="line">server1 ansible_ssh_host=10.2.40.11</span><br><span class="line">server2 ansible_ssh_host=10.2.40.22 </span><br><span class="line">server3 ansible_ssh_host=10.2.40.33</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[server:vars]</span><br><span class="line">ansible_ssh_user=admin </span><br><span class="line">ansible_ssh_private_key_file=/home/king/.ssh/bastion</span><br><span class="line">ansible_ssh_common_args=&apos; -o ProxyCommand=&quot;ssh -W %h:%p bastion_admin@bastion_ip&quot;&apos;</span><br></pre></td></tr></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://ansible-tran.readthedocs.io/en/latest/docs/intro_getting_started.html#id1" target="_blank" rel="noopener">新手上路</a></li><li><a href="https://askubuntu.com/questions/762541/ubuntu-16-04-ssh-sign-and-send-pubkey-signing-failed-agent-refused-operation" target="_blank" rel="noopener">https://askubuntu.com/questions/762541/ubuntu-16-04-ssh-sign-and-send-pubkey-signing-failed-agent-refused-operation</a></li><li><a href="https://blog.scottlowe.org/2015/12/24/running-ansible-through-ssh-bastion-host/" target="_blank" rel="noopener">Running Ansible Through an SSH Bastion Host</a></li><li><a href="https://www.cnblogs.com/f-ck-need-u/p/7553186.html" target="_blank" rel="noopener">Ansible系列(一)：基本配置和使用</a></li><li><a href="https://www.cnblogs.com/f-ck-need-u/p/7550603.html" target="_blank" rel="noopener">Ansible系列(二)：选项和常用模块</a></li><li><a href="https://www.w3cschool.cn/automate_with_ansible/automate_with_ansible-db6727oq.html" target="_blank" rel="noopener">https://www.w3cschool.cn/automate_with_ansible/automate_with_ansible-db6727oq.html</a></li><li><a href="https://www.jianshu.com/p/446f0ab2e131" target="_blank" rel="noopener">https://www.jianshu.com/p/446f0ab2e131</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安装&lt;/h1&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span cla
      
    
    </summary>
    
      <category term="运营运维" scheme="http://blog.kimq.cn/categories/%E8%BF%90%E8%90%A5%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="ansible" scheme="http://blog.kimq.cn/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>ElasticSearch学习笔记</title>
    <link href="http://blog.kimq.cn/2020/03/08/elasticsearch_basic/"/>
    <id>http://blog.kimq.cn/2020/03/08/elasticsearch_basic/</id>
    <published>2020-03-08T16:00:00.000Z</published>
    <updated>2020-08-01T09:26:24.727Z</updated>
    
    <content type="html"><![CDATA[<h1 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h1><blockquote><p><code>ip</code>酌情修改</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker pull kibana:6.5.4</span><br><span class="line">$ docker pull elasticsearch:6.5.4</span><br><span class="line">$ docker run -d -p 9200:9200 -p 9300:9300 -e <span class="string">"discovery.type=single-node"</span> \</span><br><span class="line">    --name elastic  elasticsearch:6.5.4</span><br><span class="line">$ docker run -d -e <span class="string">"ELASTICSEARCH_URL=http://192.168.2.139:9200"</span> \</span><br><span class="line">    --name kibana   -p 5601:5601 kibana:6.5.4</span><br></pre></td></tr></table></figure><h2 id="7-3-0"><a href="#7-3-0" class="headerlink" title="7.3.0"></a>7.3.0</h2><blockquote><p><code>认证</code>, <a href="https://www.elastic.co/guide/en/beats/filebeat/current/ilm.html" target="_blank" rel="noopener"><code>filebeat lifecycle</code></a><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker pull docker.elastic.co/beats/filebeat:7.3.1</span><br><span class="line"></span><br><span class="line">$ docker run -d -p 9200:9200 -p 9300:9300 -e <span class="string">"discovery.type=single-node"</span> \</span><br><span class="line">    -e <span class="string">"ELASTIC_USERNAME=elastic"</span> \</span><br><span class="line">    -e <span class="string">"ELASTIC_PASSWORD=kibana"</span> \</span><br><span class="line">    -e <span class="string">"xpack.security.enabled=true"</span> \</span><br><span class="line">    --name elastic  elasticsearch:7.3.0</span><br><span class="line"></span><br><span class="line">$ docker run -d -e <span class="string">"ELASTICSEARCH_HOSTS=http://192.168.2.139:9200"</span> \</span><br><span class="line">    -e <span class="string">"ELASTICSEARCH_USERNAME=elastic"</span> \</span><br><span class="line">    -e <span class="string">"ELASTICSEARCH_PASSWORD=kibana"</span> \</span><br><span class="line">    -e <span class="string">"xpack.security.enabled=true"</span> \</span><br><span class="line">    --name kibana   -p 5601:5601 kibana:7.3.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ docker run -d --name=filebeat  \</span><br><span class="line">--volume=<span class="string">"C:\docker\filebeat\filebeat.docker.yml:/usr/share/filebeat/filebeat.yml:ro"</span> \</span><br><span class="line">    --volume=<span class="string">"D:\log:/var/lib/docker/containers:ro"</span> \</span><br><span class="line">    docker.elastic.co/beats/filebeat:7.3.0</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="beat直接运行"><a href="#beat直接运行" class="headerlink" title="beat直接运行"></a>beat直接运行</h3><p><a href="https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.3.0-linux-x86_64.tar.gz" target="_blank" rel="noopener">https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.3.0-linux-x86_64.tar.gz</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./filebeat-7.3.0-linux-x86_64/filebeat -c a.yml  -e -d <span class="string">"*"</span></span><br></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">~/filebeat/x.log</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">["http://127.0.0.1:9200"]</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">"filebeat"</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">"filebeat"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">setup.template.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.ilm.rollover_alias:</span> <span class="string">"filebeat-test"</span></span><br><span class="line"><span class="attr">setup.ilm.check_exists:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">setup.ilm.overwrite:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.ilm.pattern:</span> <span class="string">"&#123;now/d&#125;"</span></span><br></pre></td></tr></table></figure><h1 id="ECK"><a href="#ECK" class="headerlink" title="ECK"></a><a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-quickstart.html" target="_blank" rel="noopener">ECK</a></h1><h2 id="all-in-one"><a href="#all-in-one" class="headerlink" title="all in one"></a>all in one</h2><p>需要在集群中先安装 <a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-deploy-eck.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-deploy-eck.html</a></p><p>可以酌情修改</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f https://download.elastic.co/downloads/eck/1.1.0/all-in-one.yaml</span><br></pre></td></tr></table></figure><p>一些细节</p><ul><li>比较费内存, 如果只是配置和验证, 可以适当调小</li><li>1个master和1个data 跑不起来, 非得各三个, 待查</li></ul><h2 id="帐号"><a href="#帐号" class="headerlink" title="帐号"></a>帐号</h2><ul><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/built-in-users.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/built-in-users.html</a></li><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/users-command.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/users-command.html</a></li></ul><p>进入pod</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 仅供测试</span><br><span class="line">$ bin/elasticsearch-users useradd king -p pwd -r superuser</span><br></pre></td></tr></table></figure><p>port forward</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -k -u king -XGET <span class="string">"https://127.0.0.1:9200/_count?pretty  "</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "query": &#123;</span></span><br><span class="line"><span class="string">    "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line">Enter host password <span class="keyword">for</span> user <span class="string">'king'</span>:</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"count"</span> : 42,</span><br><span class="line">  <span class="string">"_shards"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : 3,</span><br><span class="line">    <span class="string">"successful"</span> : 3,</span><br><span class="line">    <span class="string">"skipped"</span> : 0,</span><br><span class="line">    <span class="string">"failed"</span> : 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">$ curl -k -u king:<span class="built_in">pwd</span> -XPUT <span class="string">"https://127.0.0.1:9200/idx  "</span> -H <span class="string">'Content-Type: application/json'</span></span><br><span class="line">&#123;<span class="string">"acknowledged"</span>:<span class="literal">true</span>,<span class="string">"shards_acknowledged"</span>:<span class="literal">true</span>,<span class="string">"index"</span>:<span class="string">"idx"</span>&#125;</span><br><span class="line">$ curl -k -u king:<span class="built_in">pwd</span> -XGET <span class="string">"https://127.0.0.1:9200/_count?pretty  "</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "query": &#123;</span></span><br><span class="line"><span class="string">    "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"count"</span> : 42,</span><br><span class="line">  <span class="string">"_shards"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : 3,</span><br><span class="line">    <span class="string">"successful"</span> : 3,</span><br><span class="line">    <span class="string">"skipped"</span> : 0,</span><br><span class="line">    <span class="string">"failed"</span> : 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h2><ul><li>curl</li><li>kibana -&gt; dev tools</li><li><a href="https://chrome.google.com/webstore/detail/elasticsearch-head/ffmkiejjmecolpfloofpjologoblkegm" target="_blank" rel="noopener">ElasticSearch Head</a></li><li><a href="https://github.com/mobz/elasticsearch-head" target="_blank" rel="noopener">https://github.com/mobz/elasticsearch-head</a> 同上</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -XGET <span class="string">"http://192.168.2.139:9200/_count?pretty  "</span> -H <span class="string">'Content-Type: application/json'</span> -d<span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "query": &#123;</span></span><br><span class="line"><span class="string">    "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET _count?pretty  </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match_all"</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><ul><li>索引(index)</li><li>类型(type)</li><li>文档</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Relational DB -&gt; Databases -&gt; Tables -&gt; Rows -&gt; Columns</span><br><span class="line">Elasticsearch -&gt; Indices -&gt; Types -&gt; Documents -&gt; Fields</span><br></pre></td></tr></table></figure><blockquote><p>Elasticsearch集群可以包含多个索引(indices)（数据库），每一个索引可以包含多个类型(types)（表），每一个类型包含多个文档(documents)（行），然后每个文档包含多个字段(Fields)（列）。</p></blockquote><h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><p>创建/查询<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT /megacorp/employee/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"first_name"</span>: <span class="string">"John"</span>,</span><br><span class="line">  <span class="string">"last_name"</span>: <span class="string">"Smith"</span>,</span><br><span class="line">  <span class="string">"age"</span>: 25,</span><br><span class="line">  <span class="string">"about"</span>: <span class="string">"I love to go rock climbing"</span>,</span><br><span class="line">  <span class="string">"interests"</span>: [</span><br><span class="line">    <span class="string">"sports"</span>,</span><br><span class="line">    <span class="string">"music"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><table><thead><tr><th>名字</th><th>说明</th><th>note</th></tr></thead><tbody><tr><td>megacorp</td><td>索引名</td><td>文档存储的地方</td></tr><tr><td>employee</td><td>类型名</td><td>文档代表的对象的类</td></tr><tr><td>1</td><td>这个员工的ID</td><td>文档的唯一标识</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /megacorp/employee/1</span><br><span class="line">GET /megacorp/employee/_search?q=last_name:Smith</span><br><span class="line">GET /megacorp/employee/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"query"</span>: &#123;</span><br><span class="line">    <span class="string">"match"</span>: &#123;</span><br><span class="line">      <span class="string">"last_name"</span>: <span class="string">"Smith"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="搜索类型"><a href="#搜索类型" class="headerlink" title="搜索类型"></a>搜索类型</h3><ul><li>query string 将所有参数通过查询字符串定义 <code>上面第二个查询</code></li><li>DSL 使用JSON完整的表示请求体(request body) <code>上面第三个查询</code></li></ul><h3 id="查询与过滤"><a href="#查询与过滤" class="headerlink" title="查询与过滤"></a>查询与过滤</h3><ul><li>结构化查询（Query DSL）</li><li>结构化过滤（Filter DSL）</li></ul><blockquote><p>对比返回结果的差异</p></blockquote><p>一条过滤语句会询问每个文档的字段值是否包含着特定值</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_index"</span> : <span class="string">"megacorp"</span>,</span><br><span class="line">  <span class="attr">"_type"</span> : <span class="string">"employee"</span>,</span><br><span class="line">  <span class="attr">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"_version"</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"found"</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"_source"</span> : &#123;</span><br><span class="line">    <span class="attr">"first_name"</span> : <span class="string">"John"</span>,</span><br><span class="line">    <span class="attr">"last_name"</span> : <span class="string">"Smith"</span>,</span><br><span class="line">    <span class="attr">"age"</span> : <span class="number">25</span>,</span><br><span class="line">    <span class="attr">"about"</span> : <span class="string">"I love to go rock climbing"</span>,</span><br><span class="line">    <span class="attr">"interests"</span> : [</span><br><span class="line">      <span class="string">"sports"</span>,</span><br><span class="line">      <span class="string">"music"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一条查询语句会计算每个文档与查询语句的相关性，会给出一个相关性评分 _score ，并且按照相关性对匹配到的文档进行排序。</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"took"</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"_shards"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="attr">"successful"</span> : <span class="number">5</span>,</span><br><span class="line">    <span class="attr">"skipped"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"hits"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"max_score"</span> : <span class="number">0.2876821</span>,</span><br><span class="line">    <span class="attr">"hits"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"_index"</span> : <span class="string">"megacorp"</span>,</span><br><span class="line">        <span class="attr">"_type"</span> : <span class="string">"employee"</span>,</span><br><span class="line">        <span class="attr">"_id"</span> : <span class="string">"2"</span>,</span><br><span class="line">        <span class="attr">"_score"</span> : <span class="number">0.2876821</span>,</span><br><span class="line">        <span class="attr">"_source"</span> : &#123;</span><br><span class="line">          <span class="attr">"first_name"</span> : <span class="string">"Jane"</span>,</span><br><span class="line">          <span class="attr">"last_name"</span> : <span class="string">"Smith"</span>,</span><br><span class="line">          <span class="attr">"age"</span> : <span class="number">32</span>,</span><br><span class="line">          <span class="attr">"about"</span> : <span class="string">"I like to collect rock albums"</span>,</span><br><span class="line">          <span class="attr">"interests"</span> : [</span><br><span class="line">            <span class="string">"music"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="version"><a href="#version" class="headerlink" title="_version"></a>_version</h3><p>每个文档都有一个 <code>_version</code>号码， 这个号码在文档被改变时加一。Elasticsearch使用这个 _version 保证所有修改都被正确排序。当一个旧版本出现在新版本之后，它会被简单的忽略。</p><h1 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h1><h2 id="Search-search"><a href="#Search-search" class="headerlink" title="Search(_search)"></a>Search(<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/query-dsl-match-all-query.html" target="_blank" rel="noopener"><code>_search</code></a>)</h2><ul><li>全局 <code>/_search</code></li><li>索引 <code>/gb/_search</code>, <code>/gb,us/_search</code>, <code>/g*,u*/_search</code></li><li>类型 <code>/gb/user/_search</code>, <code>/gb,us/user,tweet/_search</code></li><li><code>/_all/user,tweet/_search</code></li></ul><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">"hits": &#123; # 实际结果</span><br><span class="line">"total": 14, # 匹配到的文档总数</span><br><span class="line">"hits": [&#123;</span><br><span class="line">"_index": "us", # 索引</span><br><span class="line">"_type": "tweet", # 类型</span><br><span class="line">"_id": "7", # ID</span><br><span class="line">"_score": 1, # 排序的分数</span><br><span class="line">"_source": &#123; # 实际的内容</span><br><span class="line">"date": "2014-09-17",</span><br><span class="line">"name": "John Smith",</span><br><span class="line">"tweet": "The Query DSL is really powerful and flexible",</span><br><span class="line">"user_id": 2</span><br><span class="line">&#125;</span><br><span class="line">&#125;],</span><br><span class="line">"max_score": 1 # 是所有文档匹配查询中 _score 的最大值</span><br><span class="line">&#125;,</span><br><span class="line">"took": 4, # 搜索请求花费的毫秒数。</span><br><span class="line">"_shards": &#123;</span><br><span class="line">"failed": 0, # 失败的</span><br><span class="line">"successful": 10, # 成功的</span><br><span class="line">"total": 10 # 参与查询的分片数</span><br><span class="line">&#125;,</span><br><span class="line">"timed_out": false # 查询超时与否 `GET /_search?timeout=10ms`</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>_score 字段，这是相关性得分(<code>relevance score</code>)，它衡量了文档与查询的匹配程度</li></ul><h3 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /_search?size=5</span><br><span class="line">GET /_search?size=5&amp;from=5</span><br><span class="line">GET /_search?size=5&amp;from=10</span><br></pre></td></tr></table></figure><h3 id="检索一部分字段"><a href="#检索一部分字段" class="headerlink" title="检索一部分字段"></a>检索一部分字段</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /website/blog/123?_source=title,text</span><br></pre></td></tr></table></figure><h3 id="不要元数据"><a href="#不要元数据" class="headerlink" title="不要元数据"></a>不要元数据</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /website/blog/123/_source</span><br></pre></td></tr></table></figure><h3 id="是否存在"><a href="#是否存在" class="headerlink" title="是否存在"></a>是否存在</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HEAD /megacorp/employee/1</span><br></pre></td></tr></table></figure><h3 id="批量查询"><a href="#批量查询" class="headerlink" title="批量查询"></a>批量查询</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /_mget</span><br><span class="line">&#123;</span><br><span class="line">  &quot;docs&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_index&quot;: &quot;megacorp&quot;,</span><br><span class="line">      &quot;_type&quot;: &quot;employee&quot;,</span><br><span class="line">      &quot;_id&quot;: 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_index&quot;: &quot;megacorp&quot;,</span><br><span class="line">      &quot;_type&quot;: &quot;employee&quot;,</span><br><span class="line">      &quot;_id&quot;: 1,</span><br><span class="line">      &quot;_source&quot;: &quot;first_name&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /megacorp/employee/_mget</span><br><span class="line">&#123;</span><br><span class="line">  &quot;ids&quot;: [</span><br><span class="line">    &quot;2&quot;,</span><br><span class="line">    &quot;1&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /megacorp/employee/_mget</span><br><span class="line">&#123;</span><br><span class="line">  &quot;docs&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_id&quot;: 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;_id&quot;: 1,</span><br><span class="line">      &quot;_source&quot;: &quot;first_name&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="全文搜索"><a href="#全文搜索" class="headerlink" title="全文搜索"></a>全文搜索</h2><p>当不指定key时, elasticsearch会从_all的key中做全文搜索</p><p>Elasticsearch把所有字符串字段值连接起来放在一个大字符串中，它被索引为一个特殊的字段 <code>_all</code></p><h1 id="创建-更新-删除"><a href="#创建-更新-删除" class="headerlink" title="创建/更新/删除"></a>创建/更新/删除</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT /website/blog/123</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;My first blog entry&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;Just trying this out...&quot;,</span><br><span class="line">  &quot;date&quot;: &quot;2014/01/01&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>文档在Elasticsearch中是不可变的, 如果已经存在,那么会生成一份新的, 同时递增<code>_version</code>, 留意下面的<code>_version</code> 和 <code>result</code></p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_index"</span> : <span class="string">"megacorp"</span>,</span><br><span class="line">  <span class="attr">"_type"</span> : <span class="string">"employee"</span>,</span><br><span class="line">  <span class="attr">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"_version"</span> : <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"result"</span> : <span class="string">"updated"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果我们的数据没有自然ID，我们可以让Elasticsearch自动为我们生成(注意<code>POST</code>)</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /website/blog/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;My second blog entry&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;Still trying this out...&quot;,</span><br><span class="line">  &quot;date&quot;: &quot;2014/01/01&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="只创建不更新"><a href="#只创建不更新" class="headerlink" title="只创建不更新"></a>只创建不更新</h2><p>简单的方式是使用 POST 方法让Elasticsearch自动生成唯一 _id</p><p>其他方法</p><ul><li>PUT /website/blog/123?op_type=create</li><li>PUT /website/blog/123/_create</li></ul><p>成功响应状态码是 201 Created 。 失败将返回 409 Conflict </p><h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DELETE /website/blog/123</span><br></pre></td></tr></table></figure><h2 id="冲突"><a href="#冲突" class="headerlink" title="冲突"></a>冲突</h2><blockquote><p>elasticsearch 使用<code>_version</code>做乐观锁控制</p></blockquote><p>index 、 get 、 delete 请求时，我们指出每个文档都有一个 _version 号码，这个号码在文档被改变时加一。Elasticsearch使用这个 _version 保证所有修改都被正确排序。当一个旧版本出现在新版本之后，它会被简单的忽略。</p><p>我们只希望文档的 _version 是 1 时更新才生效。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT /website/blog/1?version=1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;My first blog entry&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;Starting to get the hang of this...&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="使用外部版本控制系统"><a href="#使用外部版本控制系统" class="headerlink" title="使用外部版本控制系统"></a>使用外部版本控制系统</h3><p>可以在Elasticsearch的查询字符串后面添加<code>version_type=external</code> 来使用这些版本号。</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT /website/blog/2?version=5&amp;version_type=external</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;: &quot;My first external blog entry&quot;,</span><br><span class="line">  &quot;text&quot;: &quot;Starting to get the hang of this...&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>外部版本号与之前说的内部版本号在处理的时候有些不同。它不再检查 _version 是否与请求中指定的<code>一致</code>，而是检查是否<code>小于</code>指定的版本。如果请求成功，外部版本号就会被存储到 _version 中。</p></blockquote><h3 id="重试"><a href="#重试" class="headerlink" title="重试"></a>重试</h3><p>乐观锁失败的情况下, 通常可以重试<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /website/pageviews/1/_update?retry_on_conflict=5</span><br><span class="line">&#123;</span><br><span class="line">  &quot;script&quot; : &quot;ctx._source.views+=1&quot;,</span><br><span class="line">  &quot;upsert&quot;: &#123;</span><br><span class="line">    &quot;views&quot;: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="局部更新"><a href="#局部更新" class="headerlink" title="局部更新"></a>局部更新</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /website/blog/1/_update</span><br><span class="line">&#123;</span><br><span class="line">  &quot;doc&quot; : &#123;</span><br><span class="line">    &quot;tags&quot; : [ &quot;testing&quot; ],</span><br><span class="line">    &quot;views&quot;: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://github.com/elastic/elasticsearch-groovy" target="_blank" rel="noopener"><code>使用Groovy脚本?</code></a></p><h2 id="批量更新"><a href="#批量更新" class="headerlink" title="批量更新"></a>批量更新</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123; &quot;delete&quot;: &#123; &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot;, &quot;_id&quot;: &quot;123&quot; &#125;&#125;</span><br><span class="line">&#123; &quot;create&quot;: &#123; &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot;, &quot;_id&quot;: &quot;123&quot; &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot;: &quot;My first blog post&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;website&quot;, &quot;_type&quot;: &quot;blog&quot; &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot;: &quot;My second blog post&quot; &#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /website/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_type&quot;: &quot;log&quot; &#125;&#125;</span><br><span class="line">&#123; &quot;event&quot;: &quot;User logged in&quot; &#125;</span><br></pre></td></tr></table></figure><blockquote><p>每个子请求都被独立的执行，所以一个子请求的错误并不影响其它请求。如果任何一个请求失败，顶层的 error 标记将被设置为 true ，然后错误的细节将在相应的请求中被报告</p></blockquote><table><thead><tr><th>行为</th><th>解释</th></tr></thead><tbody><tr><td>create</td><td>当文档不存在时创建之</td></tr><tr><td>index</td><td>创建新文档或替换已有文档</td></tr><tr><td>update</td><td>局部更新文档</td></tr><tr><td>delete</td><td>删除一个文档</td></tr></tbody></table><h3 id="为什么不用一个大json"><a href="#为什么不用一个大json" class="headerlink" title="为什么不用一个大json"></a>为什么不用一个大json</h3><p>便于服务器流式操作, Elasticsearch从网络缓冲区中一行一行的直接读取数据, 并分发到不同的node去处理, 而无需等待所有的内容并序列化,造成额外的内存开销,以及时间上的延误</p><h1 id="映射-mapping-分析-analysis"><a href="#映射-mapping-分析-analysis" class="headerlink" title="映射(mapping)/分析(analysis)"></a>映射(mapping)/分析(analysis)</h1><ul><li>映射(mapping)机制用于进行字段类型确认，将每个字段匹配为一种确定的数据类型( string , number , booleans , date 等)。</li><li>分析(analysis)机制用于进行全文文本(Full Text)的分词，以建立供搜索用的反向索引。</li></ul><h2 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h2><p>类型类似于rdm的表(table), 每个表有自己的定义(schema), 只不过Elasticsearch会对字段类型进行猜测，动态生成了字段和类型的映射关系, 如果没有明确定义。</p><blockquote><p>最新的elasticsearch干掉了这个概念</p></blockquote><p>比如2020-03-09 elasticsearch可能推导为日期格式, 那么本字段就不会匹配<code>2020</code>/<code>03</code>/<code>09</code>的任一个</p><p>当做全局搜索时, 从_all中匹配, 而后者会将所有字段转成字符串, 所以能匹配上</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /_search?q=2020 # 12 个结果</span><br><span class="line">GET /_search?q=2020-03-09 # 还是 12 个结果 !(只需要匹配2020就算, 只不过匹配度(score)略后)</span><br><span class="line">GET /_search?q=date:2020-03-09 # 1 一个结果</span><br><span class="line">GET /_search?q=date:2020 # 0 个结果 !</span><br></pre></td></tr></table></figure><p>获取type的schema</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /megacorp/_mapping/employee</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"megacorp"</span> : &#123;</span><br><span class="line">    <span class="attr">"mappings"</span> : &#123;</span><br><span class="line">      <span class="attr">"employee"</span> : &#123;</span><br><span class="line">        <span class="attr">"properties"</span> : &#123;</span><br><span class="line">          <span class="attr">"about"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"fields"</span> : &#123;</span><br><span class="line">              <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">                <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">                <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"age"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"long"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"first_name"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"fields"</span> : &#123;</span><br><span class="line">              <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">                <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">                <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"interests"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"fields"</span> : &#123;</span><br><span class="line">              <span class="attr">"keyword"</span> : &#123;</span><br><span class="line">                <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">                <span class="attr">"ignore_above"</span> : <span class="number">256</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"fielddata"</span> : <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th>类型</th><th>表示的数据类型</th></tr></thead><tbody><tr><td>String</td><td>string</td></tr><tr><td>Whole number</td><td>byte , short , integer , long</td></tr><tr><td>Floating point</td><td>float , double</td></tr><tr><td>Boolean</td><td>boolean</td></tr><tr><td>Date</td><td>date</td></tr></tbody></table><h3 id="自定义类型"><a href="#自定义类型" class="headerlink" title="自定义类型"></a>自定义类型</h3><p>自定义类型可以使你完成以下几点：</p><ul><li>区分全文（full text）字符串字段和准确字符串字段(就是分词与不分词，全文的一般要分词，准确的就不需要分词)</li><li>使用特定语言的分析器(例如中文、英文、阿拉伯语，不同文字的断字、断词方式的差异)</li><li>优化部分匹配字段</li><li>指定自定义日期格式</li><li>…</li></ul><h4 id="type"><a href="#type" class="headerlink" title="type"></a>type</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;number_of_clicks&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">    &quot;index&quot;: &quot;not_analyzed&quot;</span><br><span class="line">    &quot;analyzer&quot;: &quot;english&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="index"><a href="#index" class="headerlink" title="index"></a>index</h4><table><thead><tr><th>值</th><th>解释</th></tr></thead><tbody><tr><td>analyzed</td><td>首先分析这个字符串，然后索引。换言之，以全文形式索引此字段。</td></tr><tr><td>not_analyzed</td><td>索引这个字段，使之可以被搜索，但是索引内容和指定值一样。不分析此字段。</td></tr><tr><td>no</td><td>不索引这个字段。这个字段不能为搜索到。</td></tr></tbody></table><h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><p>每一种核心数据类型(strings, numbers, booleans及dates)以不同的方式进行索引, 在Elasticsearch中他们是被区别对待的。</p><h4 id="确切值-Exact-values-vs-全文文本-Full-text"><a href="#确切值-Exact-values-vs-全文文本-Full-text" class="headerlink" title="确切值(Exact values) vs. 全文文本(Full text)"></a>确切值(Exact values) vs. 全文文本(Full text)</h4><p>Elasticsearch中的数据可以大致分为两种类型：<code>确切值</code> 及 <code>全文文本</code></p><p>确切值是确定的，正如它的名字一样。比如一个date或用户ID，也可以包含更多的字符串比如username或email地址。确切值 “Foo” 和 “foo” 就并不相同。确切值 2014 和 2014-09-15 也不相同。确切值是很容易查询的，因为结果是二进制的 – 要么匹配，要么不匹配。</p><p>全文文本，从另一个角度来说是文本化的数据(常常以人类的语言书写)，比如英语单数/复数, 近义词 或者依赖上下文推导的(鼠标/老鼠), 而对于全文数据的查询来说, 存在一个匹配程度的问题</p><ul><li>一个针对 “UK” 的查询将返回涉及 “United Kingdom” 的文档</li><li>一个针对 “jump” 的查询同时能够匹配 “jumped” ， “jumps” ， “jumping” 甚至 “leap”</li><li>“johnny walker” 也能匹配 “Johnnie Walker” ， “johnnie depp” 及 “Johnny Depp”</li><li>“fox news hunting” 能返回有关hunting on Fox News的故事，而 “fox hunting news” 也能返回关于fox hunting的新闻故事。</li></ul><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>为了方便在全文文本字段中进行这些类型的查询，Elasticsearch首先对文本分析(analyzes)</p><ul><li>使用<code>字符过滤器(character filter)</code>去掉无意义词(啊/哦/额/the 等)</li><li><code>分词(analysis)</code></li><li>转换(复数-&gt;单数, 同义词 等等)</li></ul><p><code>分析器</code>就是处理这些步骤的功能逻辑</p><h3 id="内建分析器"><a href="#内建分析器" class="headerlink" title="内建分析器"></a>内建分析器</h3><ul><li>标准分析器, 标准分析器是Elasticsearch默认使用的分析器。对于文本分析，它对于任何语言都是最佳选择, 它根据Unicode Consortium的定义的单词边界(word boundaries)来切分文本，然后去掉大部分标点符号。最后，把所有词转为小写。</li><li>简单分析器, 简单分析器将非单个字母的文本切分，然后把每个词转为小写</li><li>空格分析器, 空格分析器依据空格切分文本。它不转换小写。</li><li>语言分析器<ul><li>english 分析器 自带一套英语停用词库——像 and 或 the 这些与语义无关的通用词。</li><li>中文1 <a href="https://github.com/medcl/elasticsearch-analysis-pinyin" target="_blank" rel="noopener">https://github.com/medcl/elasticsearch-analysis-pinyin</a></li><li>中文2 <a href="https://github.com/medcl/elasticsearch-analysis-ik" target="_blank" rel="noopener">https://github.com/medcl/elasticsearch-analysis-ik</a></li></ul></li></ul><h3 id="测试验证"><a href="#测试验证" class="headerlink" title="测试验证"></a>测试验证</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot; : &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot; : &quot;Text to analyze!&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"tokens"</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"text"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"&lt;ALPHANUM&gt;"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"to"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">5</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">7</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"&lt;ALPHANUM&gt;"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"token"</span> : <span class="string">"analyze"</span>,</span><br><span class="line">      <span class="attr">"start_offset"</span> : <span class="number">8</span>,</span><br><span class="line">      <span class="attr">"end_offset"</span> : <span class="number">15</span>,</span><br><span class="line">      <span class="attr">"type"</span> : <span class="string">"&lt;ALPHANUM&gt;"</span>,</span><br><span class="line">      <span class="attr">"position"</span> : <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="指定分析器"><a href="#指定分析器" class="headerlink" title="指定分析器"></a>指定分析器</h2><p>当Elasticsearch在你的文档中探测到一个新的字符串字段，它将自动设置它为全文 string 字段并用 standard 分析器分析。</p><p>创建一个新索引，指定 tweet 字段的分析器为 english<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT /gb</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;tweet&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;tweet&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">          &quot;analyzer&quot;: &quot;english&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;date&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;date&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;name&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;string&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;user_id&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;long&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>定在 tweet 的映射中增加一个新的 <code>not_analyzed</code> 类型的文本字段，叫做 tag<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT /gb/_mapping/tweet</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;tag&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">      &quot;index&quot;: &quot;not_analyzed&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h1 id="复杂搜索-聚合"><a href="#复杂搜索-聚合" class="headerlink" title="复杂搜索/聚合"></a>复杂搜索/聚合</h1><ul><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.8/query-dsl-bool-query.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/6.8/query-dsl-bool-query.html</a></li><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/agg-metadata.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/6.5/agg-metadata.html</a></li></ul><h1 id="集群和节点"><a href="#集群和节点" class="headerlink" title="集群和节点"></a>集群和节点</h1><ul><li>节点(node)是一个运行着的Elasticsearch实例</li><li>集群(cluster)是一组具有相同 cluster.name 的节点集合，</li><li>分片(shards), 个最小级别“工作单元(worker unit)”,它只是保存了索引中所有数据的一部分, 索引(index)——一个存储关联数据的地方。实际上，索引只是一个用来指向一个或多个分片(shards)的“逻辑命名空间(logical namespace)”</li></ul><blockquote><p>做为用户，我们能够与集群中的任何节点通信。每一个节点都知道文档存在于哪个节点上，它们可以转发请求到相应的节点上。我们访问的节点负责收集各节点返回的数据，最后一起返回给客户端。</p></blockquote><h2 id="Node"><a href="#Node" class="headerlink" title="Node"></a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html" target="_blank" rel="noopener">Node</a></h2><ul><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#master-node" target="_blank" rel="noopener">Master-eligible node</a> A node that has node.master set to true (default), which makes it eligible to be elected as the master node, which controls the cluster.</li><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#data-node" target="_blank" rel="noopener">Data node</a> A node that has node.data set to true (default). Data nodes hold data and perform data related operations such as CRUD, search, and aggregations.</li><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html" target="_blank" rel="noopener">Ingest node</a></li><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#ml-node" target="_blank" rel="noopener">Machine learning node</a></li></ul><blockquote><p>在可用性要求高的集群中, 搞一个Master Only的集群?</p></blockquote><h2 id="分片"><a href="#分片" class="headerlink" title="分片"></a>分片</h2><p>分片就是一个<code>Lucene</code>实例，并且它本身就是一个完整的搜索引擎。我们的文档存储在分片中，并且在分片中被索引，但是我们的应用程序不会直接与它们通信，取而代之的是，直接与索引通信。</p><ul><li>主要分片(primary shard)</li><li>复制分片(replica shard)，复制分片只是主分片的一个副本，它可以防止硬件故障导致的数据丢失，同时可以提供读请求，比如搜索或者从别的shard取回文档。</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT /blogs</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"settings"</span> : &#123;</span><br><span class="line">    <span class="string">"number_of_shards"</span> : 3, <span class="comment"># 主要分片数</span></span><br><span class="line">    <span class="string">"number_of_replicas"</span> : 1 <span class="comment"># 每个主要分片的副本数量</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>文档存储在分片中，然后分片分配到你集群中的节点上。当你的集群扩容或缩小，Elasticsearch将会自动在你的节点间迁移分片，以使集群保持平衡。当索引创建完成的时候，主分片的数量就固定了，但是复制分片的数量可以随时调整。</p></blockquote><h3 id="集群状态"><a href="#集群状态" class="headerlink" title="集群状态"></a>集群状态</h3><p>因为测试环境只有一个节点, 所以复制分片(replica shards)全部都不可用(unassigned 状态)</p><blockquote><p>在同一个节点上保存相同的数据副本是没有必要的，如果这个节点故障了，那所有的数据副本也会丢失</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GET /_cluster/health</span><br><span class="line"><span class="comment"># resp</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"docker-cluster"</span>,</span><br><span class="line">  <span class="string">"status"</span> : <span class="string">"yellow"</span>, &lt;----</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"number_of_nodes"</span> : 1,</span><br><span class="line">  <span class="string">"number_of_data_nodes"</span> : 1,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th>颜色</th><th>意义</th></tr></thead><tbody><tr><td>green</td><td>所有主要分片和复制分片都可用</td></tr><tr><td>yellow</td><td>所有主要分片可用，但不是所有复制分片都可用</td></tr><tr><td>red</td><td>不是所有的主要分片都可用</td></tr></tbody></table><p>接上,假如副本数量是1, 当新加一个node后, 那么elasticsearch会自动创建<code>复制分片</code>, 也可能转移部分<code>主分片</code>过去, 在当前节点分配复制分片, 此时所有的分片都已经可用, 那么健康状态就是<code>green</code></p><p>此时的集群就相当于实现了<code>横向扩展</code>, (<em>请求任何一个节点都能读写文档</em>), <code>高可用</code>(<em>一个节点挂了, 还有另外一份, 并且支持从复制分片重新恢复主分片</em>)</p><h3 id="横向扩展"><a href="#横向扩展" class="headerlink" title="横向扩展"></a>横向扩展</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PUT /blogs/_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"number_of_replicas"</span> : 2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在保持两个node的情况下, 因为没有足够的node分配(复制)分片, 所以集群状态又将变黄, 新加node后, 又将变绿, 此时集群的负载能力将进一步增强</p><h3 id="故障恢复"><a href="#故障恢复" class="headerlink" title="故障恢复"></a>故障恢复</h3><p>假如所有的节点都支持master选举和数据存储</p><p>现在master节点挂了, 那么集群将变红, 因为不是所有的主分片都可用(<em>如果master有主分片</em>), 接下来</p><ul><li>选择产生新的master节点</li><li>把丢失的主分片对应的复制分片升级成主分片(选择策略? 如果有多个复制分片)</li></ul><h1 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h1><p><code>新的版本的实现有改动?</code></p><p>当你索引一个文档，它被存储在单独一个主分片上。Elasticsearch通过根据文档的key, 并使用一个路由算法(hash)来判断文档在哪个node, 简单地<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">shard = hash(routing) % number_of_primary_shards</span><br></pre></td></tr></table></figure></p><p>routing 值是一个任意字符串，它默认是 _id 但也可以自定义。这个 routing 字符串通过哈希函数生成一个数字，然后除以主切片的数量得到一个余数(remainder)，余数的范围永远是0到number_of_primary_shards - 1 ，这个数字就是特定文档所在的分片。这也解释了为什么主分片的数量只能在创建索引时定义且不能修改：如果主分片的数量在未来改变了，所有先前的路由值就失效了，文档也就永远找不到了。 </p><blockquote><p>或者迁移数据?</p></blockquote><p>所有的文档API（ get 、 index 、 delete 、 bulk 、 update 、 mget ）都接收一个 routing 参数，它用来自定义文档到分片的映射。自定义路由值可以确保所有相关文档——例如属于同一个人的文档——被保存在同一分片上。</p><h2 id="写流转"><a href="#写流转" class="headerlink" title="写流转"></a>写流转</h2><p>我们将接收外部请求节点称之为请求节点(requesting node)</p><blockquote><p>当我们发送请求，最好的做法是循环通过所有节点请求，这样可以平衡负载。</p></blockquote><ul><li>客户端给 <code>请求节点</code>(node1) 发送新建、索引或删除请求。</li><li>找到分片对应的node, 分发给对应node(node2)</li><li>node2完成<code>主要分片</code>的增删改</li><li>node2同步修改到所有的<code>复制分片</code></li><li>依次同步返回, 最后由<code>请求节点</code>返回给客户端</li></ul><h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h3><p>当更新完主要分片后, 数据<code>基本</code>就安全了, 等待所有的复制分片同步完成, 会拖慢客户端请求时间</p><p>update API还接受 routing 、 replication 、 consistency 和 timout 参数。</p><p><code>replication</code> 默认的值是 sync 。这将导致主分片得到复制分片的成功响应后才返回。</p><p>如果你设置 replication 为 async ，请求在主分片上被执行后就会返回给客户端。它依旧会转发请求给复制节点，但你将不知道复制节点成功与否。</p><p>默认主分片在尝试写入时需要规定数量(quorum)或过半的分片（可以是主节点或复制节点）可用。 <code>consistency</code> 允许的值为 one （只有一个主分片）， all （所有主分片和复制分片）或者默认的 quorum 或过半分片。</p><p>当分片副本不足时会怎样？Elasticsearch会等待更多的分片出现。默认等待一分钟。如果需要，你可以设置 <code>timeout</code> 参数让它终止的更早： 100 表示100毫秒， 30s 表示30秒。</p><h2 id="读流转"><a href="#读流转" class="headerlink" title="读流转"></a>读流转</h2><blockquote><p>文档能够从主分片或任意一个复制分片被检索。</p></blockquote><ul><li>客户端给 <code>请求节点</code>(node1) 发送查询请求。</li><li>node1根据文档id找到对应的node(包含主要分片/复制分片)</li><li>分发请求到对应节点, 对于读请求，为了平衡负载，请求节点会为每个请求选择不同的分片——它会循环所有分片副本。</li><li>等待返回</li></ul><blockquote><p>可能的情况是，一个被索引的文档已经存在于主分片上却还没来得及同步到复制分片上。这时复制分片会报告文档未找到，</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;运行&quot;&gt;&lt;a href=&quot;#运行&quot; class=&quot;headerlink&quot; title=&quot;运行&quot;&gt;&lt;/a&gt;运行&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;ip&lt;/code&gt;酌情修改&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;high
      
    
    </summary>
    
      <category term="运营运维" scheme="http://blog.kimq.cn/categories/%E8%BF%90%E8%90%A5%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="elasticsearch" scheme="http://blog.kimq.cn/tags/elasticsearch/"/>
    
      <category term="kibana" scheme="http://blog.kimq.cn/tags/kibana/"/>
    
  </entry>
  
  <entry>
    <title>Jaeger初探</title>
    <link href="http://blog.kimq.cn/2020/02/29/jaeger_basic/"/>
    <id>http://blog.kimq.cn/2020/02/29/jaeger_basic/</id>
    <published>2020-02-29T16:00:00.000Z</published>
    <updated>2020-08-01T09:26:24.727Z</updated>
    
    <content type="html"><![CDATA[<p>Jaeger 是Uber 开源的分布式追踪系统，兼容OpenTracing 标准, 官网<a href="https://github.com/jaegertracing/jaeger" target="_blank" rel="noopener">https://github.com/jaegertracing/jaeger</a></p><p>运行Sample</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -d --name jaeger \</span><br><span class="line">  -e COLLECTOR_ZIPKIN_HTTP_PORT=9411 \</span><br><span class="line">  -p 5775:5775/udp \</span><br><span class="line">  -p 6831:6831/udp \</span><br><span class="line">  -p 6832:6832/udp \</span><br><span class="line">  -p 5778:5778 \</span><br><span class="line">  -p 16686:16686 \</span><br><span class="line">  -p 14268:14268 \</span><br><span class="line">  -p 14250:14250 \</span><br><span class="line">  -p 9411:9411 \</span><br><span class="line">  jaegertracing/all-in-one:1.17</span><br></pre></td></tr></table></figure><p>可以打开<a href="http://localhost:16686" target="_blank" rel="noopener">http://localhost:16686</a>访问<code>Jeager UI</code></p><h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a><a href="https://github.com/opentracing/specification/blob/master/specification.md" target="_blank" rel="noopener">概念</a></h1><blockquote><p>这些概念可以对照Jeager UI加深/帮助理解</p></blockquote><p>Traces in OpenTracing are defined implicitly by their Spans. In particular, a Trace can be thought of as a directed acyclic graph (DAG) of Spans, where the edges between Spans are called References.</p><p>Each Span encapsulates the following state:</p><ul><li>An operation name</li><li>A start timestamp</li><li>A finish timestamp</li><li>A set of zero or more key:value <code>Span Tags</code>. The keys must be strings. The values may be strings, bools, or numeric types.</li><li>A set of zero or more <code>Span Logs</code>, each of which is itself a key:value map paired with a timestamp. The keys must be strings, though the values may be of any type. Not all OpenTracing implementations must support every value type.</li><li>A <code>SpanContext</code> (see below)</li><li><code>References</code> to zero or more causally-related Spans (via the SpanContext of those related Spans)</li></ul><p>Each SpanContext encapsulates the following state:</p><ul><li>Any OpenTracing-implementation-dependent state (for example, trace and span ids) needed to refer to a distinct Span across a process boundary</li><li>Baggage Items, which are just key:value pairs that cross process boundaries</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Causal relationships between Spans in a single Trace</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        [Span A]  ←←←(the root span)</span><br><span class="line">            |</span><br><span class="line">     +------+------+</span><br><span class="line">     |             |</span><br><span class="line"> [Span B]      [Span C] ←←←(Span C is a `ChildOf` Span A)</span><br><span class="line">     |             |</span><br><span class="line"> [Span D]      +---+-------+</span><br><span class="line">               |           |</span><br><span class="line">           [Span E]    [Span F] &gt;&gt;&gt; [Span G] &gt;&gt;&gt; [Span H]</span><br><span class="line">                                       ↑</span><br><span class="line">                                       ↑</span><br><span class="line">                                       ↑</span><br><span class="line">                         (Span G `FollowsFrom` Span F)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Temporal relationships between Spans in a single Trace</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">––|–––––––|–––––––|–––––––|–––––––|–––––––|–––––––|–––––––|–&gt; time</span><br><span class="line"></span><br><span class="line"> [Span A···················································]</span><br><span class="line">   [Span B··············································]</span><br><span class="line">      [Span D··········································]</span><br><span class="line">    [Span C········································]</span><br><span class="line">         [Span E·······]        [Span F··] [Span G··] [Span H··]</span><br></pre></td></tr></table></figure><p>参考</p><ul><li><a href="https://opentracing.io/docs/getting-started/" target="_blank" rel="noopener">https://opentracing.io/docs/getting-started/</a></li><li><a href="https://github.com/opentracing-contrib/opentracing-specification-zh" target="_blank" rel="noopener">https://github.com/opentracing-contrib/opentracing-specification-zh</a></li><li><a href="https://wu-sheng.gitbooks.io/opentracing-io/content/" target="_blank" rel="noopener">https://wu-sheng.gitbooks.io/opentracing-io/content/</a></li><li><a href="https://github.com/yurishkuro/opentracing-tutorial/tree/master/go" target="_blank" rel="noopener">https://github.com/yurishkuro/opentracing-tutorial/tree/master/go</a></li><li><a href="https://pjw.io/articles/2018/05/08/opentracing-explanations/" target="_blank" rel="noopener">https://pjw.io/articles/2018/05/08/opentracing-explanations/</a></li></ul><h1 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h1><h2 id="grpc-sample"><a href="#grpc-sample" class="headerlink" title="grpc sample"></a>grpc sample</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ protoc -I ./ helloworld.proto --go_out=plugins=grpc:./</span><br></pre></td></tr></table></figure><ul><li><a href="https://github.com/grpc/grpc-go/blob/master/examples/helloworld/helloworld/helloworld.proto" target="_blank" rel="noopener">https://github.com/grpc/grpc-go/blob/master/examples/helloworld/helloworld/helloworld.proto</a></li><li><a href="https://github.com/grpc/grpc-go/blob/master/examples/helloworld/greeter_client/main.go" target="_blank" rel="noopener">https://github.com/grpc/grpc-go/blob/master/examples/helloworld/greeter_client/main.go</a></li><li><a href="https://github.com/grpc/grpc-go/blob/master/examples/helloworld/greeter_server/main.go" target="_blank" rel="noopener">https://github.com/grpc/grpc-go/blob/master/examples/helloworld/greeter_server/main.go</a></li></ul><h2 id="Jeager-Export"><a href="#Jeager-Export" class="headerlink" title="Jeager Export"></a>Jeager Export</h2><p>参考 <a href="https://github.com/census-ecosystem/opencensus-go-exporter-jaeger/blob/master/example/main.go" target="_blank" rel="noopener">https://github.com/census-ecosystem/opencensus-go-exporter-jaeger/blob/master/example/main.go</a></p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"><span class="string">"contrib.go.opencensus.io/exporter/jaeger"</span></span><br><span class="line"><span class="string">"go.opencensus.io/trace"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initTracer</span><span class="params">(name, agent <span class="keyword">string</span>, sampling <span class="keyword">float64</span>)</span> <span class="params">(*jaeger.Exporter, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">trace.ApplyConfig(trace.Config&#123;DefaultSampler: trace.AlwaysSample()&#125;)</span><br><span class="line"><span class="comment">// Register the Jaeger exporter to be able to retrieve</span></span><br><span class="line"><span class="comment">// the collected spans.</span></span><br><span class="line">exporter, err := jaeger.NewExporter(jaeger.Options&#123;</span><br><span class="line">CollectorEndpoint: agent,</span><br><span class="line">Process: jaeger.Process&#123;</span><br><span class="line">ServiceName: name,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">trace.RegisterExporter(exporter)</span><br><span class="line"><span class="keyword">return</span> exporter, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 初始化trace服务器</span></span><br><span class="line">exporter, _ := initTracer(<span class="string">"gotest"</span>, <span class="string">"http://localhost:14268/api/traces"</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">defer</span> exporter.Flush()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h2><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dosth</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line"><span class="comment">// 一个子span</span></span><br><span class="line">_, span := trace.StartSpan(ctx, <span class="string">"baidu"</span>)</span><br><span class="line">span.AddAttributes(trace.StringAttribute(<span class="string">"name"</span>, <span class="string">"doget2"</span>))</span><br><span class="line">span.SetStatus(trace.Status&#123;Code: trace.StatusCodeOK, Message: <span class="string">"no error"</span>&#125;)</span><br><span class="line">span.Annotate([]trace.Attribute&#123;</span><br><span class="line">trace.Int64Attribute(<span class="string">"len"</span>, <span class="keyword">int64</span>(<span class="number">123456</span>)),</span><br><span class="line">trace.StringAttribute(<span class="string">"name"</span>, <span class="string">"dosth"</span>),</span><br><span class="line">&#125;, <span class="string">"Annotate"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">defer</span> span.End()</span><br><span class="line">http.Get(<span class="string">"http://www.baidu.com"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Http-trace"><a href="#Http-trace" class="headerlink" title="Http trace"></a>Http trace</h2><p>在python做各种三方库注入比较容易, golang需要手动处理, 参考<a href="https://awesomeopensource.com/project/census-instrumentation/opencensus-go#Getting%20Started" target="_blank" rel="noopener">https://awesomeopensource.com/project/census-instrumentation/opencensus-go#Getting%20Started</a></p><ul><li><a href="https://godoc.org/go.opencensus.io/plugin/ochttp" target="_blank" rel="noopener">net/http</a></li><li><a href="https://godoc.org/go.opencensus.io/plugin/ocgrpc" target="_blank" rel="noopener">gRPC</a></li><li><a href="https://godoc.org/github.com/opencensus-integrations/ocsql" target="_blank" rel="noopener">database/sql</a></li><li><a href="https://godoc.org/github.com/go-kit/kit/tracing/opencensus" target="_blank" rel="noopener">Go kit</a></li><li><a href="https://godoc.org/github.com/orijtech/groupcache" target="_blank" rel="noopener">Groupcache</a></li><li><a href="https://godoc.org/github.com/orijtech/caddy" target="_blank" rel="noopener">Caddy webserver</a></li><li><a href="https://godoc.org/github.com/orijtech/mongo-go-driver" target="_blank" rel="noopener">MongoDB</a></li><li><a href="https://godoc.org/github.com/orijtech/redigo" target="_blank" rel="noopener">Redis gomodule/redigo</a></li><li><a href="https://godoc.org/github.com/orijtech/redis" target="_blank" rel="noopener">Redis goredis/redis</a></li><li><a href="https://godoc.org/github.com/orijtech/gomemcache" target="_blank" rel="noopener">Memcache</a></li></ul><h3 id="client"><a href="#client" class="headerlink" title="client"></a>client</h3><p>较为完善的例子可参考<a href="https://cloud.google.com/solutions/using-distributed-tracing-to-observe-microservice-latency-with-opencensus-and-stackdriver-trace" target="_blank" rel="noopener">https://cloud.google.com/solutions/using-distributed-tracing-to-observe-microservice-latency-with-opencensus-and-stackdriver-trace</a></p><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"context"</span></span><br><span class="line">fmt <span class="string">"fmt"</span></span><br><span class="line"><span class="string">"io/ioutil"</span></span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"go.opencensus.io/plugin/ochttp/propagation/tracecontext"</span></span><br><span class="line"><span class="string">"go.opencensus.io/trace"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doget</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line"><span class="comment">// 调用子http服务的span</span></span><br><span class="line">name := <span class="string">"httpget"</span></span><br><span class="line">_, span := trace.StartSpan(ctx, name)</span><br><span class="line">url := <span class="string">"http://127.0.0.1:12345/sub"</span></span><br><span class="line">span.AddAttributes(trace.StringAttribute(<span class="string">"url"</span>, url))</span><br><span class="line"><span class="keyword">defer</span> span.End()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用Http服务</span></span><br><span class="line">req, err := http.NewRequest(<span class="string">"GET"</span>, url, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">"%v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">req = req.WithContext(ctx)</span><br><span class="line"></span><br><span class="line">format := &amp;tracecontext.HTTPFormat&#123;&#125;</span><br><span class="line">format.SpanContextToRequest(span.SpanContext(), req)</span><br><span class="line"></span><br><span class="line">client := http.DefaultClient</span><br><span class="line">resp, err := client.Do(req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">"%v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">s, err := ioutil.ReadAll(resp.Body)</span><br><span class="line">fmt.Printf(<span class="keyword">string</span>(s))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hander</span><span class="params">(ctx context.Context, name <span class="keyword">string</span>)</span> <span class="title">func</span><span class="params">(http.ResponseWriter, *http.Request)</span></span> &#123;</span><br><span class="line"><span class="comment">// 子服务router</span></span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">httpFormat := &amp;tracecontext.HTTPFormat&#123;&#125;</span><br><span class="line">sc, ok := httpFormat.SpanContextFromRequest(r)</span><br><span class="line"><span class="keyword">var</span> span *trace.Span = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line"><span class="comment">// 从header里面取spanContext, 做好衔接</span></span><br><span class="line">ctx, span = trace.StartSpanWithRemoteParent(ctx, name, sc)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ctx, span = trace.StartSpan(ctx, name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 增加Tag</span></span><br><span class="line">span.AddAttributes(trace.StringAttribute(<span class="string">"name"</span>, fmt.Sprintf(<span class="string">"name: %s"</span>, name)))</span><br><span class="line">span.SetStatus(trace.Status&#123;Code: trace.StatusCodeOK, Message: <span class="string">"no error"</span>&#125;)</span><br><span class="line"><span class="keyword">defer</span> span.End()</span><br><span class="line"></span><br><span class="line">fmt.Fprintf(w, <span class="string">"Hello there!\n"</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="grpc-trace"><a href="#grpc-trace" class="headerlink" title="grpc trace"></a>grpc trace</h2><p>一个完整的例子可以参考<a href="https://opencensus-website-snapshot.firebaseapp.com/gogrpc/" target="_blank" rel="noopener">https://opencensus-website-snapshot.firebaseapp.com/gogrpc/</a></p><h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"context"</span></span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"go.opencensus.io/plugin/ocgrpc"</span></span><br><span class="line"><span class="string">"go.opencensus.io/stats/view"</span></span><br><span class="line"><span class="string">"go.opencensus.io/trace"</span></span><br><span class="line">grpc <span class="string">"google.golang.org/grpc"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">grpc_client</span><span class="params">(ctx context.Context, address, name <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line"><span class="comment">// 一个子span</span></span><br><span class="line">ctx, span := trace.StartSpan(ctx, name)</span><br><span class="line">span.AddAttributes(trace.StringAttribute(<span class="string">"grpc"</span>, fmt.Sprintf(<span class="string">"name: %s"</span>, name)))</span><br><span class="line"><span class="keyword">defer</span> span.End()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := view.Register(ocgrpc.DefaultClientViews...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">"Failed to register ocgrpc client views: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">conn, err := grpc.Dial(</span><br><span class="line">address,</span><br><span class="line">grpc.WithStatsHandler(&amp;ocgrpc.ClientHandler&#123;</span><br><span class="line">StartOptions: trace.StartOptions&#123;</span><br><span class="line">Sampler: trace.AlwaysSample(),</span><br><span class="line">&#125;,</span><br><span class="line">&#125;),</span><br><span class="line">grpc.WithInsecure(),</span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">"did not connect: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用实际的rpc接口</span></span><br><span class="line">    <span class="comment">// grpc 生成的代码接口</span></span><br><span class="line">c := NewGreeterClient(conn)</span><br><span class="line">r, err := c.SayHello(ctx, &amp;HelloRequest&#123;Name: name&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">"could not greet: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">log.Printf(<span class="string">"Greeting: %s"</span>, r.GetMessage())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Server-1"><a href="#Server-1" class="headerlink" title="Server"></a>Server</h3><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">grpc_server</span><span class="params">(addr <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">lis, err := net.Listen(<span class="string">"tcp"</span>, addr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">"failed to listen: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := view.Register(ocgrpc.DefaultServerViews...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">"Failed to register ocgrpc server views: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s := grpc.NewServer(grpc.StatsHandler(&amp;ocgrpc.ServerHandler&#123;&#125;))</span><br><span class="line">    <span class="comment">// grpc生成的代码</span></span><br><span class="line">RegisterGreeterServer(s, &amp;server&#123;&#125;)</span><br><span class="line"><span class="keyword">if</span> err := s.Serve(lis); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">"failed to serve: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Flask"><a href="#Flask" class="headerlink" title="Flask"></a>Flask</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Flask==0.12.4</span><br><span class="line">opencensus==0.7.6</span><br><span class="line">opencensus-ext-flask==0.7.3</span><br><span class="line">opencensus-ext-jaeger==0.7.1</span><br><span class="line">opencensus-ext-sqlalchemy==0.1.2</span><br><span class="line">opencensus-ext-grpc==0.7.1</span><br><span class="line">opencensus.ext.requests==0.7.2</span><br></pre></td></tr></table></figure><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def init_opencensus_tracing(app):</span><br><span class="line">    from opencensus.ext.jaeger.trace_exporter import JaegerExporter</span><br><span class="line">    from opencensus.ext.flask.flask_middleware import FlaskMiddleware</span><br><span class="line">    from opencensus.trace import config_integration, samplers</span><br><span class="line"></span><br><span class="line">    # 配置注入</span><br><span class="line">    INTEGRATIONS = [&apos;sqlalchemy&apos;, &apos;requests&apos;]</span><br><span class="line">    exporter = JaegerExporter(</span><br><span class="line">        service_name=&apos;flask_sample&apos;,</span><br><span class="line">        agent_host_name=&quot;127.0.0.1&quot;,</span><br><span class="line">        agent_port=6831,</span><br><span class="line">    )</span><br><span class="line">    sampler = samplers.ProbabilitySampler(rate=1)</span><br><span class="line">    FlaskMiddleware(</span><br><span class="line">        app,</span><br><span class="line">        exporter=exporter,</span><br><span class="line">        sampler=sampler,</span><br><span class="line">        blacklist_paths=[&apos;health&apos;],</span><br><span class="line">    )</span><br><span class="line">    config_integration.trace_integrations(INTEGRATIONS)</span><br></pre></td></tr></table></figure><p>当使用<code>sqlalchemy</code>/<code>requests</code>做数据库操作/Http(s)操作时, 会自动生成新的<code>span</code></p><h2 id="Python-Grpc客户端"><a href="#Python-Grpc客户端" class="headerlink" title="Python Grpc客户端"></a>Python Grpc客户端</h2><p>grpc不支持<code>配置集成(config integration)</code></p><p>参考<a href="https://github.com/census-instrumentation/opencensus-python/issues/677" target="_blank" rel="noopener">https://github.com/census-instrumentation/opencensus-python/issues/677</a></p><blockquote><p>This seems to be a doc issue, the grpc integration is done by explicitly using the interceptors (refer to the examples) instead of through config_integration.</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ python -m grpc_tools.protoc --python_out ./ \</span><br><span class="line">    --grpc_python_out ./ -I. ./helloworld.proto</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> opencensus.ext.grpc <span class="keyword">import</span> client_interceptor</span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">from</span> .helloworld_pb2 <span class="keyword">import</span> HelloRequest</span><br><span class="line"><span class="keyword">from</span> .helloworld_pb2_grpc <span class="keyword">import</span> GreeterStub</span><br><span class="line"></span><br><span class="line">options = [(<span class="string">"grpc.lb_policy_name"</span>, <span class="string">"round_robin"</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> qrcoder_client</span><br><span class="line">qchannel = grpc.insecure_channel(<span class="string">"127.0.0.1:12346"</span>, options)</span><br><span class="line"><span class="comment"># 注入trace</span></span><br><span class="line">trace_interceptor = client_interceptor.OpenCensusClientInterceptor(</span><br><span class="line">    host_port=<span class="string">"127.0.0.1:12346"</span></span><br><span class="line">)</span><br><span class="line">qchannel = grpc.intercept_channel(qchannel, trace_interceptor)</span><br><span class="line">qrcoder_client = GreeterStub(qchannel)</span><br><span class="line">qrcoder_client.SayHello(HelloRequest(name=<span class="string">"world"</span>))</span><br></pre></td></tr></table></figure><h1 id="其他Export"><a href="#其他Export" class="headerlink" title="其他Export"></a>其他Export</h1><p>上面一直都使用的<a href="https://www.jaegertracing.io/" target="_blank" rel="noopener">Jaeger</a>, 其他包括参见<a href="https://opencensus.io/exporters/supported-exporters/" target="_blank" rel="noopener">https://opencensus.io/exporters/supported-exporters/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Jaeger 是Uber 开源的分布式追踪系统，兼容OpenTracing 标准, 官网&lt;a href=&quot;https://github.com/jaegertracing/jaeger&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://gith
      
    
    </summary>
    
      <category term="运营运维" scheme="http://blog.kimq.cn/categories/%E8%BF%90%E8%90%A5%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="golang" scheme="http://blog.kimq.cn/tags/golang/"/>
    
      <category term="python" scheme="http://blog.kimq.cn/tags/python/"/>
    
      <category term="grpc" scheme="http://blog.kimq.cn/tags/grpc/"/>
    
  </entry>
  
  <entry>
    <title>ResfulApi测试框架tavern</title>
    <link href="http://blog.kimq.cn/2020/02/20/tavern/"/>
    <id>http://blog.kimq.cn/2020/02/20/tavern/</id>
    <published>2020-02-20T16:00:00.000Z</published>
    <updated>2020-08-01T09:26:24.731Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h1><p>测试用例由一个测试名称、一个或多个阶段(stage)组成，每个阶段都有一个名称、一个请求和一个响应。举个简单的例子</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">test_name:</span> <span class="string">Get</span> <span class="string">some</span> <span class="string">fake</span> <span class="string">data</span> <span class="string">from</span> <span class="string">the</span> <span class="string">JSON</span> <span class="string">placeholder</span> <span class="string">API</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Make</span> <span class="string">sure</span> <span class="string">we</span> <span class="string">have</span> <span class="string">the</span> <span class="string">right</span> <span class="string">ID</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">https://jsonplaceholder.typicode.com/posts/1</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">status_code:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">body:</span></span><br><span class="line">        <span class="attr">id:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">save:</span></span><br><span class="line">        <span class="attr">body:</span></span><br><span class="line">          <span class="attr">returned_id:</span> <span class="string">id</span></span><br></pre></td></tr></table></figure><p>此用例表示, 使用<code>request.method</code>方法向<code>request.url</code>请求, 期望成功返回(<code>status</code>等于200), 并且返回的内容(json)中, id等于1, 并且把id存在变量<code>returned_id</code>中</p><h1 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h1><p><code>请求段</code>描述发送到服务器的内容</p><ul><li>url</li><li>json post/put/..的json内容(如果是json格式)</li><li>param get方法的参数</li><li>data form参数</li><li>headers</li><li>method</li></ul><h1 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h1><p>响应段描述了我们期望得到的结果。</p><ul><li>status_code 期望的status, 缺省200, 也可能201或其他</li><li>body 期待返回的内容</li><li>headers 期待返回的header</li><li>redirect_query_params 期望重定向URL的参数</li></ul><h2 id="Save"><a href="#Save" class="headerlink" title="Save"></a>Save</h2><p>The save block can save values from the response for use in future requests. Things can be saved from the body, headers, or redirect query parameters. When used to save something from the json body, this can also access dictionaries and lists recursively. If the response is</p><p>save块可以从响应中保存结果，以便在将来的请求中使用。可以从body、header或重定向查询参数中保存结果。当用于从json中保存内容时，它还可以递归地访问字典和列表, 获取内部某个值。如果响应是</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"thing"</span>: &#123;</span><br><span class="line">        <span class="attr">"nested"</span>: [</span><br><span class="line">            <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以从响应块中的某个值保存到first val的值中<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">response:</span></span><br><span class="line">  <span class="attr">save:</span></span><br><span class="line">    <span class="attr">body:</span></span><br><span class="line">      <span class="attr">first_val:</span> <span class="string">thing.nested[0]</span></span><br></pre></td></tr></table></figure></p><p>也可以使用函数调用来保存数据,见后续</p><h1 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h1><h2 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># common.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">全局定义</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">|</span></span><br><span class="line">  <span class="string">测试</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">global_url:</span> <span class="string">http://www.baidu.com</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">test_name:</span> <span class="string">登录/个人信息</span></span><br><span class="line"></span><br><span class="line"><span class="attr">includes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="type">!include</span> <span class="string">common.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">登录</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/login"</span></span><br></pre></td></tr></table></figure><h2 id="保存变量"><a href="#保存变量" class="headerlink" title="保存变量"></a>保存变量</h2><p>留意<code>global_token</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">登录</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/login"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">      <span class="attr">json:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">"user"</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">"pwd"</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">status_code:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">save:</span></span><br><span class="line">        <span class="attr">body:</span></span><br><span class="line">          <span class="attr">global_token:</span> <span class="string">data.token</span> <span class="comment"># 把token存下来后续调用</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">个人信息</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/info"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">      <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">Authorization:</span> <span class="string">"&#123;global_token&#125;"</span> <span class="comment"># 获取之前存下来的token</span></span><br></pre></td></tr></table></figure><h2 id="Request变量"><a href="#Request变量" class="headerlink" title="Request变量"></a>Request变量</h2><p>可以从当前的request参数中获取值用作判断</p><p>留意<code>tavern.request_vars</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">登录</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/login"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">      <span class="attr">json:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">"user"</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">"pwd"</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">status_code:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">body:</span></span><br><span class="line">        <span class="attr">code:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">message:</span> <span class="string">OK</span></span><br><span class="line">        <span class="attr">data:</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">"&#123;tavern.request_vars.json.username&#125;"</span> <span class="comment"># 返回的username和参数一致</span></span><br></pre></td></tr></table></figure><h2 id="函数保存结果"><a href="#函数保存结果" class="headerlink" title="函数保存结果"></a>函数保存结果</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">登录</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/login"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">      <span class="attr">json:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">"user"</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">"pwd"</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">status_code:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">body:</span></span><br><span class="line">        <span class="attr">code:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">message:</span> <span class="string">OK</span></span><br><span class="line">      <span class="attr">save:</span></span><br><span class="line">        <span class="string">$ext:</span></span><br><span class="line">          <span class="attr">function:</span> <span class="string">base:save_test_data</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># export PYTHONPATH=$PYTHONPATH:.</span></span><br><span class="line"><span class="keyword">from</span> box <span class="keyword">import</span> Box</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_test_data</span><span class="params">(response)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> Box(&#123;<span class="string">"test_user_id"</span>: response.json()[<span class="string">"data"</span>][<span class="string">"userID"</span>]&#125;)</span><br></pre></td></tr></table></figure><h2 id="函数校验"><a href="#函数校验" class="headerlink" title="函数校验"></a>函数校验</h2><p>支持自定义参数</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_message</span><span class="params">(response)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> response.json().get(<span class="string">"message"</span>) == <span class="string">"OK"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_code</span><span class="params">(response,**kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">assert</span> response.json().get(<span class="string">"code"</span>) == kwargs[<span class="string">"expect"</span>]</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">登录</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/login"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">      <span class="attr">json:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">"user"</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">"pwd"</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">status_code:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">verify_response_with:</span> <span class="comment"># 单函数判断 export PYTHONPATH=$PYTHONPATH:.</span></span><br><span class="line">        <span class="attr">function:</span> <span class="string">base:check_message</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">个人信息</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/info"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">    <span class="attr">response:</span></span><br><span class="line">      <span class="attr">status_code:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">body:</span></span><br><span class="line">        <span class="attr">code:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">message:</span> <span class="string">OK</span></span><br><span class="line">      <span class="attr">verify_response_with:</span> <span class="comment"># 多函数判断</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">function:</span> <span class="string">base:check_message</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">function:</span> <span class="string">base:check_code</span></span><br><span class="line">          <span class="attr">extra_kwargs:</span></span><br><span class="line">            <span class="attr">expect:</span> <span class="number">0</span> <span class="comment"># 期望 code = 0 (自定义参数)</span></span><br></pre></td></tr></table></figure><h2 id="生成header"><a href="#生成header" class="headerlink" title="生成header"></a>生成header</h2><p><code>$ext</code> 表示下面的内容是函数生成器</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> box <span class="keyword">import</span> Box</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_test_header</span><span class="params">()</span>:</span></span><br><span class="line">    auth_header = &#123;</span><br><span class="line">        <span class="string">"how"</span>: <span class="string">"are you"</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Box(auth_header)</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">登录</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/login"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">      <span class="attr">headers:</span></span><br><span class="line">        <span class="string">$ext:</span></span><br><span class="line">          <span class="attr">function:</span> <span class="string">base:get_test_header</span></span><br></pre></td></tr></table></figure><h2 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h2><p>留意<code>tavern.env_vars</code><br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">登录</span></span><br><span class="line">    <span class="attr">request:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">"&#123;global_url:s&#125;/user/login"</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">POST</span></span><br><span class="line">      <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">Authorization:</span> <span class="string">"Basic &#123;tavern.env_vars.SECRET_CI_COMMIT_AUTH&#125;"</span></span><br></pre></td></tr></table></figure></p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://github.com/taverntesting/tavern" target="_blank" rel="noopener">https://github.com/taverntesting/tavern</a></li><li><a href="https://tavern.readthedocs.io/en/latest/basics.html" target="_blank" rel="noopener">https://tavern.readthedocs.io/en/latest/basics.html</a></li><li><a href="https://pypi.org/project/python-box/" target="_blank" rel="noopener">https://pypi.org/project/python-box/</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Sample&quot;&gt;&lt;a href=&quot;#Sample&quot; class=&quot;headerlink&quot; title=&quot;Sample&quot;&gt;&lt;/a&gt;Sample&lt;/h1&gt;&lt;p&gt;测试用例由一个测试名称、一个或多个阶段(stage)组成，每个阶段都有一个名称、一个请求和一个响应。举个简单
      
    
    </summary>
    
      <category term="Python" scheme="http://blog.kimq.cn/categories/Python/"/>
    
    
      <category term="tavern" scheme="http://blog.kimq.cn/tags/tavern/"/>
    
  </entry>
  
  <entry>
    <title>nginx配置ldap登录授权</title>
    <link href="http://blog.kimq.cn/2020/02/03/nginx_ldap/"/>
    <id>http://blog.kimq.cn/2020/02/03/nginx_ldap/</id>
    <published>2020-02-03T16:00:00.000Z</published>
    <updated>2020-08-01T09:26:24.727Z</updated>
    
    <content type="html"><![CDATA[<p>本文代码来自<a href="https://github.com/nginxinc/nginx-ldap-auth" target="_blank" rel="noopener">https://github.com/nginxinc/nginx-ldap-auth</a></p><p>nginx内建了<code>auth_request</code>实现了权限控制拦截功能, 这适用于需要在无认证的服务前增加访问控制, 比如<code>Kibana</code>无默认的权限控制, 但是公司的日志显然不能裸奔</p><p>实现包含三部分</p><ul><li><code>nginx</code>(<code>auth_request</code>)</li><li>(较通用)的<code>认证服务</code></li><li>实际的<code>业务服务</code></li></ul><h1 id="业务服务"><a href="#业务服务" class="headerlink" title="业务服务"></a>业务服务</h1><p>文中的业务服务比较简单, 用Python写了个简单的web服务, 以及用于客户输入<code>帐号密码</code>的表单页面</p><h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><ul><li>nginx 绑定端口8081 供外部访问</li><li><code>auth_request</code>做全量拦截, 如果认证失败, 抛出<code>401</code></li><li>nginx 将401重定向到/login, 即<code>业务服务</code>中的表单</li><li>表单提交又回到<code>auth_request</code><ul><li>若存在cookie, 从cookie中解码出帐号密码, 然后ldap认证</li><li>对于首次登录, 则从form表单中获取帐号密码</li><li>认证成功,将帐号密码保存在cookie中, 避免重复输入帐号密码</li></ul></li></ul><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8081</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">auth_request</span> /auth-proxy;</span><br><span class="line">        <span class="attribute">error_page</span> <span class="number">401</span> =<span class="number">200</span> /login;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /login &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://backend/login;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Target <span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> = /auth-proxy &#123;</span><br><span class="line">        internal;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:8888;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_pass_request_body</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Content-Length <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_cache_key</span> <span class="string">"<span class="variable">$http_authorization</span><span class="variable">$cookie_nginxauth</span>"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Ldap-URL      <span class="string">"ldap://127.0.0.1"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Ldap-BaseDN   <span class="string">"ou=lixin,dc=example,dc=org"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Ldap-BindDN   <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Ldap-Template <span class="string">"(cn=%(username)s)"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Ldap-BindPass <span class="string">"123456"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-CookieName <span class="string">"nginxauth"</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Cookie nginxauth=<span class="variable">$cookie_nginxauth</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>nginx</code> 将所有ldap的参数,以<code>header</code>的形式传给<code>认证服务</code>, 这样确保<code>认证服务</code>相对通用</p></blockquote><h1 id="认证服务"><a href="#认证服务" class="headerlink" title="认证服务"></a>认证服务</h1><ul><li>设定一个header头-参数的映射表, 以及服务启动传入的缺省值</li><li>每次请求,都动态获取这些参数, 连同(从form表单/cookie获取到的)帐号密码存入临时变量ctx</li><li>使用ctx的参数做ldap认证</li><li>参数错误/认证失败 返回401</li></ul><h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>这显然只是一个sample, 不可能在生产环境中实施, 因为安全问题和性能问题比较明显</p><p>首先将帐号密码存在cookie中显然不合适, 可以考虑对帐号密码加密再写cookie</p><p>更好的方法是将帐号密码存在内部存储, 比如redis中,然后把redis的key写cookie</p><p>此时仍然存在问题, 因为每个请求都要走一遍ldap认证, 对响应时延影响较大</p><p>一种折中的方案是, 认证成功之后, 生成一个session并存入redis, session_id写cookie, 用户完整信息在session中, 但仍有不足, 比如ldap删除某个用户, 并不会立即反映到业务系统来</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;本文代码来自&lt;a href=&quot;https://github.com/nginxinc/nginx-ldap-auth&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/nginxinc/nginx-ldap-auth&lt;/a
      
    
    </summary>
    
      <category term="Openldap" scheme="http://blog.kimq.cn/categories/Openldap/"/>
    
    
      <category term="nginx" scheme="http://blog.kimq.cn/tags/nginx/"/>
    
      <category term="openldap" scheme="http://blog.kimq.cn/tags/openldap/"/>
    
  </entry>
  
  <entry>
    <title>sentry配置ldap登录授权</title>
    <link href="http://blog.kimq.cn/2020/02/03/sentry_ldap/"/>
    <id>http://blog.kimq.cn/2020/02/03/sentry_ldap/</id>
    <published>2020-02-03T16:00:00.000Z</published>
    <updated>2020-08-01T09:26:24.731Z</updated>
    
    <content type="html"><![CDATA[<p>快速安装sentry见<a href="http://blog.kimq.cn/2017/03/10/sentry/">http://blog.kimq.cn/2017/03/10/sentry/</a></p><p>了解ldap见<a href="http://blog.kimq.cn/2020/02/02/openldap/">http://blog.kimq.cn/2020/02/02/openldap/</a></p><h1 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h1><p>进入docker<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it my-sentry /bin/bash</span><br><span class="line"><span class="comment"># 最好先修改源</span></span><br><span class="line">$ apt update</span><br><span class="line">$ apt-get install libsasl2-dev python-dev libldap2-dev libssl-dev </span><br><span class="line"><span class="comment"># for debug</span></span><br><span class="line">$ apt-get vim procps -y</span><br><span class="line"><span class="comment"># 安装sentry插件</span></span><br><span class="line">pip install https://github.com/Banno/getsentry-ldap-auth/archive/2.8.1.zip</span><br></pre></td></tr></table></figure></p><blockquote><p><code>getsentry-ldap-auth</code>的版本自行评估</p></blockquote><h2 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/lib/python2.7/site-packages/sentry_ldap_auth$ find . -<span class="built_in">type</span> f</span><br><span class="line">./backend.py</span><br><span class="line">./__init__.py</span><br></pre></td></tr></table></figure><p>若有问题, 可自行修改代码, 然后重启docker镜像, 日志查看<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker logs -f my-sentry</span><br></pre></td></tr></table></figure></p><h1 id="配置ldap群组和帐号"><a href="#配置ldap群组和帐号" class="headerlink" title="配置ldap群组和帐号"></a>配置ldap群组和帐号</h1><p>两个群组 </p><ul><li><code>owner_group</code> 对应sentry的owner角色</li><li><code>admin_group</code> 对应sentry的admin角色</li></ul><hr><p><code>admin</code>属于<code>owner_group</code>, <code>king1</code>属于<code>admin_group</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -x -H ldap://localhost  -w 123456 -D cn=admin,ou=tech,ou=lixin,dc=example,dc=org \</span><br><span class="line">   -b <span class="string">"ou=lixin,dc=example,dc=org"</span></span><br><span class="line"><span class="comment"># admin_group, lixin, example.org</span></span><br><span class="line">dn: cn=admin_group,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: groupOfNames</span><br><span class="line">objectClass: top</span><br><span class="line">cn: admin_group</span><br><span class="line">member: cn=king1,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># owner_group, lixin, example.org</span></span><br><span class="line">dn: cn=owner_group,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: groupOfNames</span><br><span class="line">objectClass: top</span><br><span class="line">cn: owner_group</span><br><span class="line">member: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># admin, tech, lixin, example.org</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">cn: admin</span><br><span class="line">userPassword:: e1NTSEF9ekRETXFGME4ydVNHUWZzRmxZSVlKVmVoS3BWbENxaGk=</span><br><span class="line"></span><br><span class="line"><span class="comment"># king1, tech, lixin, example.org</span></span><br><span class="line">dn: cn=king1,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">cn: king1</span><br><span class="line"></span><br><span class="line"><span class="comment"># king2, tech, lixin, example.org</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">cn: king2</span><br></pre></td></tr></table></figure><h1 id="配置Sentry服务器"><a href="#配置Sentry服务器" class="headerlink" title="配置Sentry服务器"></a>配置Sentry服务器</h1><p>将下列配置附到<code>/etc/sentry/sentry.conf.py</code> 后面</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#################################################################</span></span><br><span class="line"><span class="comment"># ldap auth</span></span><br><span class="line"><span class="keyword">import</span> ldap</span><br><span class="line"><span class="keyword">from</span> django_auth_ldap.config <span class="keyword">import</span> LDAPSearch, GroupOfNamesType</span><br><span class="line"></span><br><span class="line"><span class="comment"># ldap服务器地址</span></span><br><span class="line">AUTH_LDAP_SERVER_URI = <span class="string">'ldap://172.17.0.1'</span></span><br><span class="line"><span class="comment"># 具有查询权限的内部帐号</span></span><br><span class="line">AUTH_LDAP_BIND_DN = <span class="string">'cn=admin,ou=tech,ou=lixin,dc=example,dc=org'</span></span><br><span class="line"><span class="comment"># 密码</span></span><br><span class="line">AUTH_LDAP_BIND_PASSWORD = <span class="string">'123456'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户登录的过滤条件, 我们输入的帐号是ldap的`cn`</span></span><br><span class="line"><span class="comment"># @attention user占位符别修改</span></span><br><span class="line">AUTH_LDAP_USER_SEARCH = LDAPSearch(</span><br><span class="line">            <span class="string">'ou=tech,ou=lixin,dc=example,dc=org'</span>,</span><br><span class="line">            ldap.SCOPE_SUBTREE,</span><br><span class="line">            <span class="string">'(cn=%(user)s)'</span>,</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找组的过滤条件</span></span><br><span class="line">AUTH_LDAP_GROUP_SEARCH = LDAPSearch(</span><br><span class="line">            <span class="string">'ou=lixin,dc=example,dc=org'</span>,</span><br><span class="line">            ldap.SCOPE_SUBTREE,</span><br><span class="line">            <span class="string">'(objectClass=groupOfNames)'</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line"><span class="comment"># GroupOfNamesType</span></span><br><span class="line"><span class="comment"># NestedGroupOfNamesType</span></span><br><span class="line"><span class="comment"># GroupOfUniqueNamesType</span></span><br><span class="line"><span class="comment"># NestedGroupOfUniqueNamesType</span></span><br><span class="line"><span class="comment"># ActiveDirectoryGroupType</span></span><br><span class="line"><span class="comment"># NestedActiveDirectoryGroupType</span></span><br><span class="line"><span class="comment"># OrganizationalRoleGroupType</span></span><br><span class="line"><span class="comment"># NestedOrganizationalRoleGroupType</span></span><br><span class="line">AUTH_LDAP_GROUP_TYPE = GroupOfNamesType()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果设置了AUTH_LDAP_REQUIRE_GROUP那么只有这个组的成员才会登录成功</span></span><br><span class="line">AUTH_LDAP_REQUIRE_GROUP = <span class="literal">None</span></span><br><span class="line"><span class="comment"># AUTH_LDAP_DENY_GROUP正好相反，这个组的用户登录都会被拒绝。</span></span><br><span class="line">AUTH_LDAP_DENY_GROUP = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于映射sentry用户字段, 因为ldap测试的对象比较简单, 这里全部都用`cn`</span></span><br><span class="line">AUTH_LDAP_USER_ATTR_MAP = &#123;</span><br><span class="line">        <span class="string">'name'</span>: <span class="string">'cn'</span>,</span><br><span class="line">        <span class="string">'email'</span>: <span class="string">'cn'</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">AUTH_LDAP_FIND_GROUP_PERMS = <span class="literal">True</span></span><br><span class="line">AUTH_LDAP_CACHE_GROUPS = <span class="literal">True</span></span><br><span class="line">AUTH_LDAP_GROUP_CACHE_TIMEOUT = <span class="number">3600</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sentry缺省的Organization, 填写错误会导致登录后无权限, 一般不用修改</span></span><br><span class="line">AUTH_LDAP_DEFAULT_SENTRY_ORGANIZATION = <span class="string">u'Sentry'</span></span><br><span class="line"><span class="comment"># 自动加入到这个缺省的群组</span></span><br><span class="line">AUTH_LDAP_SENTRY_SUBSCRIBE_BY_DEFAULT = <span class="literal">True</span></span><br><span class="line"><span class="comment"># 配置哪些群组里的用户,具有哪个角色</span></span><br><span class="line"><span class="comment"># 例如owner_group 这个群组里的用户具有owner角色</span></span><br><span class="line">AUTH_LDAP_SENTRY_GROUP_ROLE_MAPPING = &#123;</span><br><span class="line">        <span class="string">'owner'</span>: [<span class="string">'owner_group'</span>],</span><br><span class="line">        <span class="string">'admin'</span>: [<span class="string">'admin_group'</span>],</span><br><span class="line">        <span class="string">'member'</span>: [], <span class="comment"># 缺省, 这里就不用配置了</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment"># 缺省角色(如果不属于我们配置的群组)</span></span><br><span class="line">AUTH_LDAP_SENTRY_ORGANIZATION_ROLE_TYPE = <span class="string">'member'</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">AUTH_LDAP_SENTRY_ORGANIZATION_GLOBAL_ACCESS = <span class="literal">True</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">AUTH_LDAP_SENTRY_USERNAME_FIELD = <span class="string">'cn'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用ldap登录</span></span><br><span class="line">AUTHENTICATION_BACKENDS = AUTHENTICATION_BACKENDS + (</span><br><span class="line">        <span class="string">'sentry_ldap_auth.backend.SentryLdapBackend'</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志相关</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logger = logging.getLogger(<span class="string">'django_auth_ldap'</span>)</span><br><span class="line">logger.addHandler(logging.StreamHandler())</span><br><span class="line">logger.setLevel(<span class="string">'DEBUG'</span>)</span><br></pre></td></tr></table></figure><blockquote><p><code>AUTH_LDAP_SENTRY_GROUP_ROLE_MAPPING</code> 字典的value值, 只需要写对应群组的<code>RDN</code>即可, 无需填写完整的<code>DN</code></p></blockquote><p>如果一个用户分别属于多个群组, 那么系统会取登记最高的角色, 角色优先级如下(由低到高)<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_effective_sentry_role</span><span class="params">(group_names)</span>:</span></span><br><span class="line">    role_priority_order = [</span><br><span class="line">        <span class="string">'member'</span>,</span><br><span class="line">        <span class="string">'admin'</span>,</span><br><span class="line">        <span class="string">'manager'</span>,</span><br><span class="line">        <span class="string">'owner'</span>,</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure></p><h1 id="登录验证"><a href="#登录验证" class="headerlink" title="登录验证"></a>登录验证</h1><p>打开<a href="http://127.0.0.1:8080" target="_blank" rel="noopener">http://127.0.0.1:8080</a> 然后分别用<code>admin</code>, <code>king1</code>, <code>king2</code> 登录, 在member页面<a href="http://127.0.0.1:8080/settings/sentry/members/" target="_blank" rel="noopener">http://127.0.0.1:8080/settings/sentry/members/</a> 可以看到三个用户属于不同的角色</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://github.com/Banno/getsentry-ldap-auth" target="_blank" rel="noopener">https://github.com/Banno/getsentry-ldap-auth</a></li><li><a href="https://django-auth-ldap.readthedocs.io/en/latest/reference.html" target="_blank" rel="noopener">https://django-auth-ldap.readthedocs.io/en/latest/reference.html</a></li><li><a href="https://darkcooking.gitbooks.io/django-auth-ldap/content/chapter4.html" target="_blank" rel="noopener">https://darkcooking.gitbooks.io/django-auth-ldap/content/chapter4.html</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;快速安装sentry见&lt;a href=&quot;http://blog.kimq.cn/2017/03/10/sentry/&quot;&gt;http://blog.kimq.cn/2017/03/10/sentry/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;了解ldap见&lt;a href=&quot;http://blog
      
    
    </summary>
    
      <category term="Openldap" scheme="http://blog.kimq.cn/categories/Openldap/"/>
    
    
      <category term="openldap" scheme="http://blog.kimq.cn/tags/openldap/"/>
    
  </entry>
  
  <entry>
    <title>OpenLdap学习</title>
    <link href="http://blog.kimq.cn/2020/02/02/openldap/"/>
    <id>http://blog.kimq.cn/2020/02/02/openldap/</id>
    <published>2020-02-02T16:00:00.000Z</published>
    <updated>2020-08-01T09:26:24.731Z</updated>
    
    <content type="html"><![CDATA[<h1 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -d --privileged -p 10004:80 --name php \</span><br><span class="line">  --env PHPLDAPADMIN_HTTPS=<span class="literal">false</span> --env PHPLDAPADMIN_LDAP_HOSTS=172.17.0.1  \</span><br><span class="line">  --detach osixia/phpldapadmin</span><br></pre></td></tr></table></figure><blockquote><p><code>172.17.0.1</code> 注意留意下本地docker网卡的ip地址</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -p 389:389 --name ldap \</span><br><span class="line">  --network bridge --hostname openldap-host \</span><br><span class="line">  --env LDAP_ORGANISATION=<span class="string">"example"</span> --env LDAP_DOMAIN=<span class="string">"example.org"</span> \</span><br><span class="line">  --env LDAP_ADMIN_PASSWORD=<span class="string">"pwd"</span> --detach osixia/openldap</span><br></pre></td></tr></table></figure><h2 id="SSL"><a href="#SSL" class="headerlink" title="SSL"></a>SSL</h2><p>如果要使用SSL访问, 将地址从<code>ldap://localhost</code>换成<code>ldaps://localhost</code></p><p>若使用自己的证书</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run --hostname ldap.example.org \</span><br><span class="line">  --volume /path/to/certificates:/container/service/slapd/assets/certs \</span><br><span class="line">  --env LDAP_TLS_CRT_FILENAME=my-ldap.crt \</span><br><span class="line">  --env LDAP_TLS_KEY_FILENAME=my-ldap.key \</span><br><span class="line">  --env LDAP_TLS_CA_CRT_FILENAME=the-ca.crt \</span><br><span class="line">  --detach osixia/openldap</span><br></pre></td></tr></table></figure><h2 id="原生客户端"><a href="#原生客户端" class="headerlink" title="原生客户端"></a><a href="http://www.ldapadmin.org/" target="_blank" rel="noopener">原生客户端</a></h2><p>支持<code>Windows</code> 和<code>Linux</code> , 个人感觉体验不如<strong><a href="http://phpldapadmin.sourceforge.net/wiki/index.php/Main_Page" target="_blank" rel="noopener">phpldapadmin</a></strong></p><ul><li><a href="http://www.ldapadmin.org/download/ldapadmin.html" target="_blank" rel="noopener">http://www.ldapadmin.org/download/ldapadmin.html</a></li><li><a href="http://ivb.sweb.cz/en/ldap.html" target="_blank" rel="noopener">http://ivb.sweb.cz/en/ldap.html</a></li><li><a href="https://github.com/ibv/LDAP-Admin/releases" target="_blank" rel="noopener">https://github.com/ibv/LDAP-Admin/releases</a></li></ul><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>打开本地浏览器, 访问<a href="http://localhost:10004" target="_blank" rel="noopener">http://localhost:10004</a> 即可打开<code>PHPLdapAdmin</code></p><blockquote><p>端口10004和docker保持一致</p></blockquote><p>需要登录, 登录帐号密码<code>cn=admin,dc=example,dc=org</code> / <code>pwd</code></p><blockquote><p>注意参数和docker中的保持一致, <code>缺省用户是固定的admin</code></p></blockquote><h3 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h3><p>也可以登录docker shell用命令行测试</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID  IMAGE               COMMAND               CREATED        STATUS        PORTS                          NAMES</span><br><span class="line">bfa797f2e0c7  osixia/phpldapadmin <span class="string">"/container/tool/run"</span> 15 minutes ago Up 15 minutes 443/tcp, 0.0.0.0:10004-&gt;80/tcp php</span><br><span class="line">e0c9ca20a8f1  osixia/openldap     <span class="string">"/container/tool/run"</span> 15 minutes ago Up 15 minutes 0.0.0.0:389-&gt;389/tcp, 636/tcp  ldap</span><br><span class="line">$ docker <span class="built_in">exec</span> -it --privileged ldap /bin/bash</span><br><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,dc=example,dc=org"</span> -w <span class="built_in">pwd</span> -b <span class="string">"dc=example,dc=org"</span></span><br><span class="line"><span class="comment"># extended LDIF</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># LDAPv3</span></span><br><span class="line"><span class="comment"># base &lt;dc=example,dc=org&gt; with scope subtree</span></span><br><span class="line"><span class="comment"># filter: (objectclass=*)</span></span><br><span class="line"><span class="comment"># requesting: ALL</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># example.org</span></span><br><span class="line">dn: dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: dcObject</span><br><span class="line">objectClass: organization</span><br><span class="line">o: example</span><br><span class="line">dc: example</span><br><span class="line"></span><br><span class="line"><span class="comment"># admin, example.org</span></span><br><span class="line">dn: cn=admin,dc=example,dc=org</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">cn: admin</span><br><span class="line">description: LDAP administrator</span><br><span class="line">userPassword:: e1NTSEF9cVNPeHRiYTFoQ0RtMlJPcWRwOW0vaTVULzRidzE2NHI=</span><br><span class="line"></span><br><span class="line"><span class="comment"># search result</span></span><br><span class="line">search: 2</span><br><span class="line">result: 0 Success</span><br><span class="line"></span><br><span class="line"><span class="comment"># numResponses: 3</span></span><br><span class="line"><span class="comment"># numEntries: 2</span></span><br></pre></td></tr></table></figure><h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>ldap的数据是分层的数组结构, 并且可能有多个DB,每个DB一棵树</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dc:         com</span><br><span class="line">             |</span><br><span class="line">dc:        genfic         ## (公司)</span><br><span class="line">          /      \</span><br><span class="line">ou:   People   servers    ## (公司部门)</span><br><span class="line">      /    \     ..</span><br><span class="line">uid: ..   John            ## (部门里的数据)</span><br></pre></td></tr></table></figure><p>一些常用的概念</p><ul><li>Distinguished Name(<code>DN</code>) 惟一辨别名，类似于Linux文件系统中的绝对路径，每个对象都有一个惟一的名称，如”uid=king,ou=qiu,dc=example,dc=org”，在一个目录树中DN总是惟一的</li><li>RDN, DN最左边的一节, 一直凭借父节点的RDN就构成了DN</li><li>OID, 可以理解为内部ID, 但是仍然需要申请并公示, 避免重复</li><li>Domain Component(<code>DC</code>) 域名的部分，其格式是将完整的域名分成几部分，如域名为example.org变成dc=example,dc=org</li><li>User Id(<code>uid</code>) 用户ID，如”king”</li><li>Organization Unit(<code>OU</code>) 组织单位，类似于Linux文件系统中的子目录，它是一个容器对象，组织单位可以包含其他各种对象（包括其他组织单元），如”lixin”</li><li>Common Name(<code>CN</code>) 公共名称，如”king qiu”</li><li>Surname(<code>SN</code>) 姓，如”king”</li><li>Relative dn(<code>RDN</code>) 相对辨别名，类似于文件系统中的相对路径，它是与目录树结构无关的部分，如”uid=qiu”或”cn=king”</li><li>Country(<code>C</code>) 国家，如”CN”或”US”等。</li><li>Organization(<code>O</code>) 组织名，如”Example, Inc.”</li></ul><h2 id="通信协议-渠道"><a href="#通信协议-渠道" class="headerlink" title="通信协议/渠道"></a>通信协议/渠道</h2><blockquote><p>以下内容以具体实现<a href="https://linux.die.net/man/8/slapd" target="_blank" rel="noopener"><strong><code>slapd</code></strong></a> 为准</p></blockquote><p>slapd提供了几种方式客户端接入<a href="https://www.openldap.org/doc/admin24/runningslapd.html#Command-Line%20Options" target="_blank" rel="noopener">连接渠道</a></p><table><thead><tr><th>URL</th><th>Protocol</th><th>Transport</th></tr></thead><tbody><tr><td>ldap:///</td><td>LDAP    TCP</td><td>port 389</td></tr><tr><td>ldaps:///</td><td>LDAP over SSL</td><td>TCP port 636</td></tr><tr><td>ldapi:///</td><td>LDAP</td><td>IPC (Unix-domain socket)</td></tr></tbody></table><p>当使用官方的客户端工具时, 使用参数<code>-H</code></p><h2 id="后端-Backends"><a href="#后端-Backends" class="headerlink" title="后端(Backends)"></a><a href="https://www.openldap.org/doc/admin24/backends.html" target="_blank" rel="noopener">后端(Backends)</a></h2><p>slapd 支持多种数据的后端存储方式</p><ul><li>Berkeley DB</li><li>LDAP, not an actual database; instead it acts as a proxy to forward incoming requests to another LDAP server</li><li>LDIF, a basic storage backend that stores entries in text files in LDIF format</li><li>LMDB, the recommended primary backend for a normal slapd database. It uses OpenLDAP’s own Lightning Memory-Mapped Database (LMDB) library to store data and is intended to replace the Berkeley DB backends</li><li>etc…</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 从cn=config下过滤特定objectClass所有条目的dn</span></span><br><span class="line">$ ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b cn=config \</span><br><span class="line">    -s sub <span class="string">"(objectClass=olcDatabaseConfig)"</span> dn</span><br><span class="line">dn: olcDatabase=&#123;-1&#125;frontend,cn=config</span><br><span class="line">dn: olcDatabase=&#123;0&#125;config,cn=config</span><br><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br></pre></td></tr></table></figure><p>可以看到, 上述实例使用的<code>mdb</code></p><h2 id="数据库-Database"><a href="#数据库-Database" class="headerlink" title="数据库(Database)"></a><a href="https://www.openldap.org/doc/admin24/slapdconf2.html" target="_blank" rel="noopener">数据库(Database)</a></h2><blockquote><p>早期的slapd使用配置文件<code>slapd.conf</code>, 目前已不建议, 考虑<code>dynamic runtime configuration engine</code> , 后者有以下优势</p></blockquote><ul><li>is fully LDAP-enabled</li><li>is managed using the standard LDAP operations</li><li>stores its configuration data in an LDIF database, generally in the /usr/local/etc/openldap/slapd.d directory.</li><li>allows all of slapd’s configuration options to be changed on the fly, generally without requiring a server restart for the changes to take effect.</li></ul><p>从上面的环境可以看到, 缺省就存在三个<code>database</code></p><ul><li>frontend, 对所有DB有效的配置, 优先级较低(special database that is used to hold database-level options that should be applied to all the other databases)</li><li>config, 配置数据库</li><li>mdb(视bachend而不同), 实际的数据存储</li></ul><blockquote><p>实际上slapd可以有多个db, slapd会根据dn匹配各个库的<a href="https://www.openldap.org/doc/admin24/slapdconf2.html#olcSuffix:%20%3Cdn%20suffix%3E" target="_blank" rel="noopener"><code>olcSuffix</code></a>来做路由</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b <span class="string">"olcDatabase=&#123;1&#125;mdb,cn=config"</span> \</span><br><span class="line">   -s sub <span class="string">"(objectClass=olcDatabaseConfig)"</span>  olcSuffix</span><br><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">olcSuffix: dc=example,dc=org</span><br></pre></td></tr></table></figure><p>官方提供了</p><ul><li><a href="https://www.zytrax.com/books/ldap/ch14/#ldapsearch" target="_blank" rel="noopener"><strong><code>ldapsearch</code></strong></a> 查询(search LDAP entries)</li><li><a href="https://www.zytrax.com/books/ldap/ch14/#ldapadd" target="_blank" rel="noopener"><strong><code>ldapadd</code></strong></a> 新增(add LDIF entries to an LDAP directory)</li><li><a href="https://www.zytrax.com/books/ldap/ch14/#ldapdelete" target="_blank" rel="noopener"><strong><code>ldapdelete</code></strong></a> 删除(delete LDAP entries)</li><li><a href="https://www.zytrax.com/books/ldap/ch14/#ladpadd" target="_blank" rel="noopener"><strong><code>ldapmodify</code></strong></a> 修改(modify existing LDAP entries)</li></ul><h1 id="config库"><a href="#config库" class="headerlink" title="config库"></a>config库</h1><p>config库的根DN是<code>cn=config</code>, 这里包含了所有的配置</p><p>具体的每个字段的意义, 参考<a href="https://www.openldap.org/doc/admin24/slapdconf2.html" target="_blank" rel="noopener">https://www.openldap.org/doc/admin24/slapdconf2.html</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b <span class="string">"cn=config"</span> dn 2&gt;/dev/null | head -n 5</span><br><span class="line">dn: cn=config</span><br><span class="line">dn: cn=module&#123;0&#125;,cn=config</span><br><span class="line">dn: cn=module&#123;1&#125;,cn=config</span><br></pre></td></tr></table></figure><h2 id="数据库配置"><a href="#数据库配置" class="headerlink" title="数据库配置"></a><a href="https://www.openldap.org/doc/admin24/slapdconf2.html#Database-specific%20Directives" target="_blank" rel="noopener">数据库配置</a></h2><p>几个重要的配置</p><ul><li><a href="https://www.openldap.org/doc/admin24/slapdconf2.html#olcAccess:%20to%20%3Cwhat%3E%20[%20by%20%3Cwho%3E%20[%3Caccesslevel%3E]%20[%3Ccontrol%3E]%20]+" target="_blank" rel="noopener">olcAccess</a> 访问控制记录, 一般会有多条</li><li><a href="https://www.openldap.org/doc/admin24/slapdconf2.html#olcRootDN:%20%3CDN%3E" target="_blank" rel="noopener">olcRootDN</a>  超级管理员DN</li><li><a href="https://www.openldap.org/doc/admin24/slapdconf2.html#olcRootPW:%20%3Cpassword%3E" target="_blank" rel="noopener">olcRootPW</a>  超级管理员密码</li><li><a href="https://www.openldap.org/doc/admin24/slapdconf2.html#olcSuffix:%20%3Cdn%20suffix%3E" target="_blank" rel="noopener">olcSuffix</a> 路由的DN后缀</li></ul><blockquote><p>对于<code>olcSuffix</code>, 更具体的路由应该在前, 否则后面的db永远无法路由</p></blockquote><h1 id="添加-删除-配置"><a href="#添加-删除-配置" class="headerlink" title="添加/删除/配置"></a>添加/删除/配置</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; base.ldif  &lt;&lt; EOF</span><br><span class="line">&gt; dn: ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line">ou: lixin</span><br><span class="line"><span class="comment"># 空行</span></span><br><span class="line">dn: ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line">ou: tech</span><br><span class="line">description: 产品部</span><br><span class="line"><span class="comment"># 空行</span></span><br><span class="line">dn: cn=king1,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">cn: king1</span><br><span class="line">userPassword: 1</span><br><span class="line"><span class="comment"># 空行</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">cn: king2</span><br><span class="line">userPassword: 1</span><br><span class="line">&gt; EOF</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapadd -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org -f base.ldif </span><br><span class="line">adding new entry <span class="string">"ou=lixin,dc=example,dc=org"</span></span><br><span class="line">adding new entry <span class="string">"ou=tech,ou=lixin,dc=example,dc=org"</span></span><br><span class="line">adding new entry <span class="string">"cn=king1,ou=tech,ou=lixin,dc=example,dc=org"</span></span><br><span class="line">adding new entry <span class="string">"cn=king2,ou=tech,ou=lixin,dc=example,dc=org"</span></span><br></pre></td></tr></table></figure><p>查询<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"ou=lixin,dc=example,dc=org"</span> dn</span><br><span class="line"><span class="comment"># lixin, example.org</span></span><br><span class="line">dn: ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># tech, lixin, example.org</span></span><br><span class="line">dn: ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># king1, tech, lixin, example.org</span></span><br><span class="line">dn: cn=king1,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># king2, tech, lixin, example.org</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># search result</span></span><br><span class="line">search: 2</span><br><span class="line">result: 0 Success</span><br><span class="line"></span><br><span class="line"><span class="comment"># numResponses: 5</span></span><br><span class="line"><span class="comment"># numEntries: 4</span></span><br></pre></td></tr></table></figure></p><p>修改<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; c &lt;&lt; EOF</span><br><span class="line">&gt; dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">changetype: modify</span><br><span class="line">add: description</span><br><span class="line">description: 你懂的</span><br><span class="line">&gt; EOF</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapmodify -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org -f c</span><br><span class="line">modifying entry <span class="string">"cn=king2,ou=tech,ou=lixin,dc=example,dc=org"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ cat &gt; c &lt;&lt; EOF</span><br><span class="line">&gt; dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">changetype: modify</span><br><span class="line">delete: description</span><br><span class="line">description: 你懂的</span><br><span class="line">-</span><br><span class="line">add: street</span><br><span class="line">street: iii</span><br><span class="line">&gt; EOF<span class="string">""</span></span><br><span class="line">$ ldapmodify -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org -f c</span><br><span class="line">modifying entry <span class="string">"cn=king2,ou=tech,ou=lixin,dc=example,dc=org"</span></span><br></pre></td></tr></table></figure></p><p>多字段属性增删改<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"cn=king2,ou=tech,ou=lixin,dc=example,dc=org"</span> street | \</span><br><span class="line">    sed -e <span class="string">"/^$/d"</span> -e <span class="string">"/^#/d"</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">street: iii</span><br><span class="line">street: jjj</span><br><span class="line">street: kkk</span><br><span class="line"><span class="comment"># 删除stree=jjj的条目, 修改street=kkk的条目修改为lll</span></span><br><span class="line">$ cat &gt; c &lt;&lt; EOF</span><br><span class="line">&gt; dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">changetype: modify</span><br><span class="line">delete: street</span><br><span class="line">street: jjj</span><br><span class="line">-</span><br><span class="line">delete: street</span><br><span class="line">street: kkk</span><br><span class="line">-</span><br><span class="line">add: street</span><br><span class="line">street: lll</span><br><span class="line">&gt; EOF</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"cn=king2,ou=tech,ou=lixin,dc=example,dc=org"</span> street | \</span><br><span class="line">    sed -e <span class="string">"/^$/d"</span> -e <span class="string">"/^#/d"</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">street: iii</span><br><span class="line">street: lll</span><br></pre></td></tr></table></figure></p><p>删除<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; base.ldif &lt;&lt; EOF</span><br><span class="line">&gt; dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">cn: admin</span><br><span class="line">userPassword: 1</span><br><span class="line">&gt; EOF</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapadd -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org -f base.ldif</span><br><span class="line">adding new entry <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapdelete -H ldap://localhost -D cn=admin,dc=example,dc=org -w 1 \</span><br><span class="line">    cn=king1,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"ou=lixin,dc=example,dc=org"</span> dn</span><br><span class="line"><span class="comment"># lixin, example.org</span></span><br><span class="line">dn: ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># tech, lixin, example.org</span></span><br><span class="line">dn: ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># admin, tech, lixin, example.org</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># king2, tech, lixin, example.org</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># search result</span></span><br><span class="line">search: 2</span><br><span class="line">result: 0 Success</span><br></pre></td></tr></table></figure></p><h2 id="查询-filter"><a href="#查询-filter" class="headerlink" title="查询/filter"></a>查询/filter</h2><p>ldap的优势是<code>快速</code>/<code>灵活</code>的查询, ldapsearch有一个filter参数, 用于定制查询条件</p><p>几个概念</p><ul><li>basedn 从树的那个子(根)节点开始查找(<code>-b</code>)</li><li>filter 查询条件</li><li>attrs 查询结果返回哪些属性</li></ul><blockquote><p>filter手册,参考<a href="https://www.zytrax.com/books/ldap/apa/search.html" target="_blank" rel="noopener">https://www.zytrax.com/books/ldap/apa/search.html</a></p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 从`ou=lixin,dc=example,dc=org`开始查找</span></span><br><span class="line"><span class="comment"># 匹配属性cn等于`king2`的条目</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    cn=king2 | sed -e <span class="string">"/^$/d"</span> -e <span class="string">"/^#/d"</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">cn: king2</span><br><span class="line">userPassword:: e1NTSEF9RzFqOGszdG82aHRWamRvQmYvRUlqbmo1dHNpb0NQcTE=</span><br><span class="line">street: iii</span><br><span class="line">description:: 5L2g5oeC55qE</span><br><span class="line"><span class="comment"># 接上, 只显示dn属性</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    cn=king2 dn | sed -e <span class="string">"/^$/d"</span> -e <span class="string">"/^#/d"</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br></pre></td></tr></table></figure><h3 id="判断"><a href="#判断" class="headerlink" title="判断"></a>判断</h3><ul><li>= 等于</li><li>~= 不等于</li><li>>= 大于等于</li><li>&lt;= 小于等于</li></ul><blockquote><p>比较逻辑支持通配符<code>*</code></p></blockquote><h3 id="与或非"><a href="#与或非" class="headerlink" title="与或非"></a>与或非</h3><ul><li>&amp; (AND)</li><li>! (NOT)</li><li>| (OR)</li></ul><blockquote><p>优先级用括号<code>(</code>界定</p></blockquote><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(&amp;(exp1)(exp2)(exp3)) # exp1 AND exp2 AND exp3</span><br><span class="line">(|(exp1)(exp2)(exp3)) # exp1 OR exp2 OR exp3</span><br><span class="line">(!(exp1)) # NOT exp1</span><br><span class="line">(&amp;(!(exp1))(!(exp2))) # NOT exp1 AND NOT exp2</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cn等于admin 或者 street等于iii</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    <span class="string">"(|(cn=admin)(street=iii))"</span> dn | sed -e <span class="string">"/^$/d"</span> -e <span class="string">"/^#/d"</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br></pre></td></tr></table></figure><h3 id="DN查找"><a href="#DN查找" class="headerlink" title="DN查找"></a>DN查找</h3><p>用于查找DN中的每一段是否包含某个属性, <code>不支持通配符</code><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># dn中包含ou等于tech的条目</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"ou=lixin,dc=example,dc=org"</span> <span class="string">"ou:dn:=tech"</span> dn | sed -e <span class="string">"/^$/d"</span> -e <span class="string">"/^#/d"</span></span><br><span class="line">dn: ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"><span class="comment"># dn中包含cn等于admin的条目</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost  -w <span class="built_in">pwd</span> -D cn=admin,dc=example,dc=org \</span><br><span class="line">    -b <span class="string">"ou=lixin,dc=example,dc=org"</span> <span class="string">"cn:dn:=admin"</span> dn | sed -e <span class="string">"/^$/d"</span> -e <span class="string">"/^#/d"</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br></pre></td></tr></table></figure></p><h2 id="匹配规则-matchingrules"><a href="#匹配规则-matchingrules" class="headerlink" title="匹配规则(matchingrules)"></a><a href="https://www.zytrax.com/books/ldap/ch3/#matchingrules" target="_blank" rel="noopener">匹配规则(matchingrules)</a></h2><p>每个属性的业务场景各有不同, 所以ldap引入了匹配规则, 用于约束属性的匹配规则, 例如姓名大小写不一致关系并不大</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">matchingRule ( 2.5.13.2 NAME &apos;caseIgnoreMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )</span><br></pre></td></tr></table></figure><blockquote><p>ldap内建了一大波规则</p></blockquote><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Subschema</span><br><span class="line">dn: cn=Subschema</span><br><span class="line">matchingRules: ( 2.5.13.0 NAME &apos;objectIdentifierMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.38 )</span><br><span class="line">matchingRules: ( 2.5.13.1 NAME &apos;distinguishedNameMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.12 )</span><br><span class="line">matchingRules: ( 2.5.13.2 NAME &apos;caseIgnoreMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )</span><br><span class="line">matchingRules: ( 2.5.13.3 NAME &apos;caseIgnoreOrderingMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )</span><br><span class="line">matchingRules: ( 2.5.13.4 NAME &apos;caseIgnoreSubstringsMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.58 )</span><br><span class="line">matchingRules: ( 2.5.13.5 NAME &apos;caseExactMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )</span><br><span class="line">matchingRules: ( 2.5.13.6 NAME &apos;caseExactOrderingMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )</span><br><span class="line">matchingRules: ( 2.5.13.7 NAME &apos;caseExactSubstringsMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.58 )</span><br><span class="line">matchingRules: ( 2.5.13.8 NAME &apos;numericStringMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.36 )</span><br><span class="line">matchingRules: ( 2.5.13.10 NAME &apos;numericStringSubstringsMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.58 )</span><br><span class="line">matchingRules: ( 2.5.13.13 NAME &apos;booleanMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.7 )</span><br><span class="line">matchingRules: ( 2.5.13.14 NAME &apos;integerMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.27 )</span><br><span class="line">matchingRules: ( 2.5.13.15 NAME &apos;integerOrderingMatch&apos; </span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.27 )</span><br><span class="line">matchingRules: ( 2.5.13.16 NAME &apos;bitStringMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.6 )</span><br><span class="line">matchingRules: ( 2.5.13.17 NAME &apos;octetStringMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.40 )</span><br><span class="line">matchingRules: ( 2.5.13.18 NAME &apos;octetStringOrderingMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.40 )</span><br><span class="line">matchingRules: ( 2.5.13.20 NAME &apos;telephoneNumberMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.50 )</span><br><span class="line">matchingRules: ( 2.5.13.21 NAME &apos;telephoneNumberSubstringsMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.58 )</span><br><span class="line">matchingRules: ( 2.5.13.23 NAME &apos;uniqueMemberMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.34 )</span><br><span class="line">matchingRules: ( 2.5.13.27 NAME &apos;generalizedTimeMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.24 )</span><br><span class="line">matchingRules: ( 2.5.13.28 NAME &apos;generalizedTimeOrderingMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.24 )</span><br><span class="line">matchingRules: ( 2.5.13.29 NAME &apos;integerFirstComponentMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.27 )</span><br><span class="line">matchingRules: ( 2.5.13.30 NAME &apos;objectIdentifierFirstComponentMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.38 )</span><br><span class="line">matchingRules: ( 2.5.13.34 NAME &apos;certificateExactMatch&apos;</span><br><span class="line">  SYNTAX 1.2.826.0.1.3344810.7.1 )</span><br><span class="line">matchingRules: ( 1.3.6.1.4.1.1466.109.114.1 NAME &apos;caseExactIA5Match&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )</span><br><span class="line">matchingRules: ( 1.3.6.1.4.1.1466.109.114.2 NAME &apos;caseIgnoreIA5Match&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )</span><br><span class="line">matchingRules: ( 1.3.6.1.4.1.1466.109.114.3 NAME &apos;caseIgnoreIA5SubstringsMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )</span><br><span class="line">matchingRules: ( 1.3.6.1.4.1.4203.1.2.1 NAME &apos;caseExactIA5SubstringsMatch&apos; </span><br><span class="line"> SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )</span><br><span class="line">matchingRules: ( 1.2.840.113556.1.4.803 NAME &apos;integerBitAndMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.27 )</span><br><span class="line">matchingRules: ( 1.2.840.113556.1.4.804 NAME &apos;integerBitOrMatch&apos;</span><br><span class="line">  SYNTAX 1.3.6.1.4.1.1466.115.121.1.27 )</span><br></pre></td></tr></table></figure><p>在比较时, 可以后面加一个<code>oid</code> 修改缺省的匹配规则<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># default sn EQUALITY comparison behaviour</span></span><br><span class="line"><span class="comment"># is caseIgnoreMatch (2.5.13.2)</span></span><br><span class="line">sn=smith</span><br><span class="line"></span><br><span class="line"><span class="comment"># override EQUALITY match with case sensitive match</span></span><br><span class="line">sn:caseExactMatch:=Smith</span><br><span class="line"><span class="comment"># functionally same as above using OID</span></span><br><span class="line">sn:2.5.13.5:=Smith</span><br><span class="line"></span><br><span class="line"><span class="comment"># if a wildcard appears in seach the SUBSTR </span></span><br><span class="line"><span class="comment"># MatchingRule applies</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default sn SUBSTR comparison behavior</span></span><br><span class="line"><span class="comment"># is caseIgnoreSubstringMatch</span></span><br><span class="line">sn=*s* <span class="comment"># finds Smith or smith</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># override SUBSTR match with case sensitive match</span></span><br><span class="line">sn:caseExactSubstringMatch:=*S* <span class="comment"># only finds Smith</span></span><br><span class="line"><span class="comment"># functionally same as above using OID</span></span><br><span class="line">sn:2.5.13.7:=*S*</span><br></pre></td></tr></table></figure></p><h1 id="权限"><a href="#权限" class="headerlink" title="权限"></a><a href="https://www.openldap.org/doc/admin24/access-control.html" target="_blank" rel="noopener"><code>权限</code></a></h1><p>到目前位置, 所有的操作,要不使用unix socket通道(<code>ldapi:///</code>), 不受权限控制, 要不就使用超级管理员<code>admin,dc=example,dc=org</code></p><p>slapd提供了完善的权限控制, 让其他用户也能做全部/部分操作</p><p>缺省情况下, 其他用户只有对自己的权限<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b <span class="string">"olcDatabase=&#123;1&#125;mdb,cn=config"</span> \</span><br><span class="line">    -s sub <span class="string">"(objectClass=olcDatabaseConfig)"</span>  olcAccess</span><br><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword,shadowLastChange by self write by dn=<span class="string">"cn=a</span></span><br><span class="line"><span class="string"> dmin,dc=example,dc=org"</span> write by anonymous auth by * none</span><br><span class="line">olcAccess: &#123;1&#125;to * by self <span class="built_in">read</span> by dn=<span class="string">"cn=admin,dc=example,dc=org"</span> write by * </span><br><span class="line"> none</span><br><span class="line"><span class="comment"># 查询lixin部门</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    -w 1 -b <span class="string">"ou=lixin,dc=example,dc=org"</span> dn</span><br><span class="line">search: 2</span><br><span class="line">result: 32 No such object</span><br><span class="line"><span class="comment"># 查询自己</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    -w 1 -b <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> dn</span><br><span class="line"><span class="comment"># admin, tech, lixin, example.org</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line">search: 2</span><br><span class="line">result: 0 Success</span><br></pre></td></tr></table></figure></p><p>现在给<code>cn=admin,ou=tech,ou=lixin,dc=example,dc=org</code> 加一个<code>read</code>权限<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; perm &lt;&lt; EOF</span><br><span class="line">&gt; dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;to dn.subtree=<span class="string">"ou=lixin,dc=example,dc=org"</span></span><br><span class="line">    by dn.exact=<span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> <span class="built_in">read</span></span><br><span class="line">    by anonymous auth</span><br><span class="line">    by * none</span><br><span class="line">&gt; EOF</span><br><span class="line">$ ldapmodify -H ldapi:// -Y EXTERNAL -f perm</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b <span class="string">"olcDatabase=&#123;1&#125;mdb,cn=config"</span> \</span><br><span class="line">   -s sub <span class="string">"(objectClass=olcDatabaseConfig)"</span>  olcAccess</span><br><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">olcAccess: &#123;0&#125;to dn.subtree=<span class="string">"ou=lixin,dc=example,dc=org"</span>   by dn.exact=<span class="string">"cn=adm</span></span><br><span class="line"><span class="string"> in,ou=tech,ou=lixin,dc=example,dc=org"</span> <span class="built_in">read</span>   by anonymous auth   by * none</span><br><span class="line">olcAccess: &#123;1&#125;to attrs=userPassword,shadowLastChange by self write by dn=<span class="string">"cn=a</span></span><br><span class="line"><span class="string"> dmin,dc=example,dc=org"</span> write by anonymous auth by * none</span><br><span class="line">olcAccess: &#123;2&#125;to * by self <span class="built_in">read</span> by dn=<span class="string">"cn=admin,dc=example,dc=org"</span> write by * </span><br><span class="line"> none</span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    -w 1 -b <span class="string">"ou=lixin,dc=example,dc=org"</span> dn</span><br><span class="line"><span class="comment"># lixin, example.org</span></span><br><span class="line">dn: ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># tech, lixin, example.org</span></span><br><span class="line">dn: ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># hr, tech, lixin, example.org</span></span><br><span class="line">dn: cn=hr,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># admin, tech, lixin, example.org</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># king1, tech, lixin, example.org</span></span><br><span class="line">dn: cn=king1,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line"><span class="comment"># king2, tech, lixin, example.org</span></span><br><span class="line">dn: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line"></span><br><span class="line">search: 2</span><br><span class="line">result: 0 Success</span><br><span class="line"><span class="comment"># 查分配的权限之外的dn就找不到了</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    -w 1 -b <span class="string">"dc=example,dc=org"</span> dn</span><br><span class="line">search: 2</span><br><span class="line">result: 32 No such object</span><br></pre></td></tr></table></figure><h2 id="权限Index"><a href="#权限Index" class="headerlink" title="权限Index"></a>权限Index</h2><p>由于权限规则定义的顺序非常关键, 所以slapd使用一个<code>{X}</code>来锁定顺序, 在上面的例子中,可以看到<code>{0}, {1}, {2}</code> </p><blockquote><p>我们的配置中手动写死{0}, 是为了确保新插入的规则优先级最高, 因为此调规则的DN范围是小于后两条</p></blockquote><p>{X}的另外一个作用是在增删改查时用作定位, 例如删除第一条</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dn: olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">delete: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;</span><br></pre></td></tr></table></figure><h2 id="权限集合"><a href="#权限集合" class="headerlink" title="权限集合"></a>权限集合</h2><table><thead><tr><th>Level</th><th>Privileges</th><th>Description</th></tr></thead><tbody><tr><td>none</td><td>0</td><td>no access</td></tr><tr><td>disclose</td><td>d</td><td>needed for information disclosure on error</td></tr><tr><td>auth</td><td>dx</td><td>needed to authenticate (bind)</td></tr><tr><td>compare</td><td>cdx</td><td>needed to compare</td></tr><tr><td>search</td><td>scdx</td><td>needed to apply search filters</td></tr><tr><td>read</td><td>rscdx</td><td>needed to read search results</td></tr><tr><td>write</td><td>wrscdx</td><td>needed to modify/rename</td></tr><tr><td>manage</td><td>mwrscdx</td><td>needed to manage</td></tr></tbody></table><ul><li>高级别权限自动包含低级别权限</li><li>search和read的区别在于, search可以返回<code>查到了</code>, 但是没有<code>查到的具体结果</code></li><li>认证权限, 表示允许登录, 至于能不能成功, 则使用帐号密码认证</li></ul><h2 id="权限规则"><a href="#权限规则" class="headerlink" title="权限规则"></a>权限规则</h2><p>规则语法<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">access to what： </span><br><span class="line">by who access control</span><br></pre></td></tr></table></figure></p><ul><li>control 就是之前的权限等级, 读/写/授权etc</li><li>指令中包含1个to语句，可多个by语句</li><li><code>what</code> 限定规则应用条目(entries)的集合, 全部用<code>*</code></li><li><code>who</code> 授权给哪些实体(entities)</li></ul><h3 id="what"><a href="#what" class="headerlink" title="what"></a>what</h3><blockquote><p>匹配所有使用<code>*</code><br>多种匹配规则可同时使用</p></blockquote><p><a href="https://www.openldap.org/doc/admin24/access-control.html#What%20to%20control%20access%20to" target="_blank" rel="noopener">scope</a>(基于某个根DN匹配)</p><ul><li>base matches only the entry with provided DN</li><li>one matches the entries whose parent is the provided DN</li><li>subtree matches all entries in the subtree whose root is the provided DN</li><li>children matches all entries under the DN (but not the entry named by the DN)</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0: o=suffix</span><br><span class="line">1: cn=Manager,o=suffix</span><br><span class="line">2: ou=people,o=suffix</span><br><span class="line">3: uid=kdz,ou=people,o=suffix</span><br><span class="line">4: cn=addresses,uid=kdz,ou=people,o=suffix</span><br><span class="line">5: uid=hyc,ou=people,o=suffix</span><br></pre></td></tr></table></figure><ul><li>dn.base=”ou=people,o=suffix” match 2; </li><li>dn.one=”ou=people,o=suffix” match 3, and 5; </li><li>dn.subtree=”ou=people,o=suffix” match 2, 3, 4, and 5; and </li><li>dn.children=”ou=people,o=suffix” match 3, 4, and 5.</li></ul><p>regex(基于DN正则表达式匹配)</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">access to dn.regex=&quot;(.+,)?ou=People,(dc=[^,]+,dc=[^,]+)$&quot;</span><br></pre></td></tr></table></figure><p>filter(基于过滤器)<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">filter=(objectClass=person)</span><br><span class="line"><span class="comment"># 配合使用</span></span><br><span class="line">dn.one=<span class="string">"ou=people,o=suffix"</span> filter=(objectClass=person)</span><br></pre></td></tr></table></figure></p><p>attrs(只授权部分属性)</p><p>缺省授权所有的attr, 这里可以过滤限定属性的范围</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">to attrs=member,entry</span><br></pre></td></tr></table></figure><blockquote><p>有两个<code>伪属性</code>(pseudo), <code>entry</code> <code>children</code> , 需要特别注意</p></blockquote><ul><li>To read (and hence return) a target entry, the subject must have read access to the target’s <code>entry</code> attribute</li><li>To perform a search, the subject must have search access to the search base’s <code>entry</code> attribute.</li><li>To add or delete an entry, the subject must have write access to the entry’s <code>entry</code> attribute AND must have write access to the entry’s parent’s <code>children</code> attribute</li><li>To rename an entry, the subject must have write access to entry’s <code>entry</code> attribute AND have write access to both the old parent’s and new parent’s <code>children</code> attributes.</li></ul><h3 id="who"><a href="#who" class="headerlink" title="who"></a>who</h3><p>用于限定权限赋予给哪些实体, 一些特殊的实体如下</p><table><thead><tr><th>Specifier</th><th>Entities</th></tr></thead><tbody><tr><td>*</td><td>All, including anonymous and authenticated users</td></tr><tr><td>anonymous</td><td>Anonymous (non-authenticated) users</td></tr><tr><td>users</td><td>Authenticated users</td></tr><tr><td>self</td><td>User associated with target entry</td></tr></tbody></table><p>剩下两种通用的匹配方式 <code>scope</code> <code>regex</code> 和what用于保持一致</p><p>一个特殊的<code>dnattr</code>用于限定DN在某种条目的attr列表中</p><blockquote><p>这个attr只能存放其他条目的DN</p></blockquote><h3 id="权限评估-Evaluation"><a href="#权限评估-Evaluation" class="headerlink" title="权限评估(Evaluation)"></a>权限评估(Evaluation)</h3><p>当判断who是否具有what的access权限时</p><ul><li>根据权限结合的优先级, 从先到后</li><li>找到第一条匹配what的记录(<code>dn/attr</code>)</li><li>根据这条记录的by, 判断当前用户是否符合who<ul><li>如果没有who, 那么会append一个缺省的<code>access to * by * none</code> (<strong>而不是继续评估下个access to</strong>)</li><li>如果有, 则检查by的access 是否满足客户端申请的权限</li></ul></li><li>如果没有what, 那么<code>then a default read is used</code></li></ul><blockquote><p>所以, 一个<code>access to</code>必须把所有<code>by</code>的考虑清楚, 否则未考虑的<code>who</code>将无权限</p></blockquote><h2 id="密码"><a href="#密码" class="headerlink" title="密码"></a>密码</h2><p>新建用户时, 可以用明文写到<code>userPassword</code> 一次性创建, 通过ldapsearch可以看到密码被加密了, 不过只是简单的<code>base64编码</code>, 安全性较低</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># admin, tech, lixin, example.org</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">userPassword:: MQ==</span><br></pre></td></tr></table></figure><p>我们可以用<code>slappasswd</code> 生成带盐的强加密密码</p><p>再测试之前, 先调整权限, 让所有用户可以自己修改密码<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 内建规则, 所有用户可以自己修改密码</span></span><br><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword,shadowLastChange </span><br><span class="line">  by self write </span><br><span class="line">  by dn=<span class="string">"cn=admin,dc=example,dc=org"</span> write </span><br><span class="line">  by anonymous auth </span><br><span class="line">  by * none</span><br><span class="line"><span class="comment"># 本地新增,移动到第二位</span></span><br><span class="line">olcAccess: &#123;1&#125;to dn.subtree=<span class="string">"ou=lixin,dc=example,dc=org"</span>   by dn.exact=<span class="string">"cn=adm</span></span><br><span class="line"><span class="string"> in,ou=tech,ou=lixin,dc=example,dc=org"</span> <span class="built_in">read</span>   by anonymous auth   by * none</span><br><span class="line"><span class="comment"># 超级管理员</span></span><br><span class="line">olcAccess: &#123;2&#125;to * by self <span class="built_in">read</span> by dn=<span class="string">"cn=admin,dc=example,dc=org"</span> write by * </span><br><span class="line"> none</span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ slappasswd -h &#123;SSHA&#125;</span><br><span class="line">New password: </span><br><span class="line">Re-enter new password: </span><br><span class="line">&#123;SSHA&#125;zDDMqF0N2uSGQfsFlYIYJVehKpVlCqhi</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ cat &gt; <span class="built_in">pwd</span> &lt;&lt; EOF</span><br><span class="line">&gt; dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">changetype: modify</span><br><span class="line">replace: userPassword</span><br><span class="line">userPassword: &#123;SSHA&#125;zDDMqF0N2uSGQfsFlYIYJVehKpVlCqhi</span><br><span class="line">&gt; EOF</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ ldapmodify -x -H ldap://localhost  -w <span class="built_in">pwd</span> \</span><br><span class="line">   -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> -f <span class="built_in">pwd</span></span><br><span class="line">modifying entry <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">  -w <span class="built_in">pwd</span> -b <span class="string">"ou=lixin,dc=example,dc=org"</span> userPassword</span><br><span class="line">ldap_bind: Invalid credentials (49)</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">   -w 123456 -b <span class="string">"ou=lixin,dc=example,dc=org"</span> userPassword</span><br><span class="line"><span class="comment"># admin, tech, lixin, example.org</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">userPassword:: e1NTSEF9ekRETXFGME4ydVNHUWZzRmxZSVlKVmVoS3BWbENxaGk=</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ <span class="built_in">echo</span> e1NTSEF9ekRETXFGME4ydVNHUWZzRmxZSVlKVmVoS3BWbENxaGk= | base64 -d</span><br><span class="line">&#123;SSHA&#125;zDDMqF0N2uSGQfsFlYIYJVehKpVlCqhi</span><br></pre></td></tr></table></figure><h1 id="第三方授权"><a href="#第三方授权" class="headerlink" title="第三方授权"></a>第三方授权</h1><p>ldap一个很重要的用途就是做第三方的认证授权</p><p>通常的做法</p><ul><li>客户输入一个<code>cn</code>或者<code>uid</code>, 按照限定的规则拼装成DN</li><li>根据限定的搜索条件, 查询DN是否存在</li><li>使用DN和客户输入的密码做bind</li></ul><h2 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h2><p>slapd内建了一个<code>groupOfNames</code>的objectClass, 其包含一个member的属性, 该属性只能包含其他DN<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ou, lixin, example.org</span><br><span class="line">dn: cn=ou,ou=lixin,dc=example,dc=org</span><br><span class="line">member: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">member: cn=king2,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">objectClass: groupOfNames</span><br><span class="line">objectClass: top</span><br><span class="line">cn: ou</span><br></pre></td></tr></table></figure></p><p>那么可以考虑将角色和groupOfNames关联起来, 如果某个用户在这个groupOfNames的member中,那么就具有这个角色</p><p>这里有个问题, 在user端, 没有渠道查到它属于哪些groups, 为此需要安装额外的插件</p><h2 id="memberOf"><a href="#memberOf" class="headerlink" title="memberOf"></a>memberOf</h2><p>具体安装参考<a href="https://mayanbin.com/post/enable-memberof-in-openldap.html" target="_blank" rel="noopener">https://mayanbin.com/post/enable-memberof-in-openldap.html</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat &gt; a &lt;&lt; EOF</span><br><span class="line">&gt; dn: cn=module,cn=config</span><br><span class="line">cn: module</span><br><span class="line">objectClass: olcModuleList</span><br><span class="line">olcModulePath: /usr/lib64/openldap</span><br><span class="line"><span class="comment"># 空行</span></span><br><span class="line">dn: cn=module&#123;0&#125;,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcModuleLoad</span><br><span class="line">olcModuleLoad: memberof.la</span><br><span class="line">&gt; EOF</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ldapadd -Q -Y EXTERNAL -H ldapi:/// -f a</span><br><span class="line">adding new entry <span class="string">"cn=module,cn=config"</span></span><br><span class="line"></span><br><span class="line">modifying entry <span class="string">"cn=module&#123;0&#125;,cn=config"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ cat &gt; a &lt;&lt; EOF</span><br><span class="line">&gt; dn: olcOverlay=memberof,olcDatabase=&#123;1&#125;mdb,cn=config</span><br><span class="line">objectClass: olcConfig</span><br><span class="line">objectClass: olcMemberOf</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: top</span><br><span class="line">olcOverlay: memberof</span><br><span class="line">olcMemberOfDangling: ignore</span><br><span class="line">olcMemberOfRefInt: TRUE</span><br><span class="line">olcMemberOfGroupOC: groupOfNames</span><br><span class="line">olcMemberOfMemberAD: member     </span><br><span class="line">olcMemberOfMemberOfAD: memberOf</span><br><span class="line">&gt; EOF</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ ldapadd -Q -Y EXTERNAL -H ldapi:/// -f a</span><br><span class="line">adding new entry <span class="string">"olcOverlay=memberof,olcDatabase=&#123;1&#125;mdb,cn=config"</span></span><br></pre></td></tr></table></figure><p>之后就有了<code>memberOf</code> 字段</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ldapsearch -x -H ldap://localhost -D <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> \</span><br><span class="line">    -w 123456 -b <span class="string">"cn=admin,ou=tech,ou=lixin,dc=example,dc=org"</span> memberof</span><br><span class="line"><span class="comment"># admin, tech, lixin, example.org</span></span><br><span class="line">dn: cn=admin,ou=tech,ou=lixin,dc=example,dc=org</span><br><span class="line">memberOf: cn=ou,ou=lixin,dc=example,dc=org</span><br><span class="line">memberOf: cn=ou2,ou=lixin,dc=example,dc=or</span><br></pre></td></tr></table></figure><p>注意:</p><ul><li>memberof不属于强制，ldapsearch查询需要单独指定</li><li>老数据不会修复</li></ul><p>当我们做组判断时, </p><ul><li>根据三方系统配置的组名, 按照规则拼接完整DN, </li><li>根据搜索规则, 判断DN是否存在</li><li>检查用户的memberOf里面是否存在这个组DN</li></ul><h1 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install flask_simpleldap</span><br></pre></td></tr></table></figure><blockquote><p>如果不使用flask, 也可以直接安装<strong><a href="https://www.python-ldap.org/en/python-ldap-3.2.0/" target="_blank" rel="noopener">python-ldap</a></strong></p></blockquote><p>Debian/Ubuntu:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install libsasl2-dev python-dev libldap2-dev libssl-dev</span><br></pre></td></tr></table></figure><p>RedHat/CentOS:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo yum install python-devel openldap-devel</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> ldap</span><br><span class="line">ldapconn = ldap.initialize(<span class="string">'ldap://localhost:389'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p</span><span class="params">(con, u, p)</span>:</span></span><br><span class="line">    res = con.simple_bind_s(u, p)</span><br><span class="line">    print(res)</span><br><span class="line"></span><br><span class="line">    res = con.whoami_s()</span><br><span class="line">    print(res)</span><br><span class="line"></span><br><span class="line">    res = con.search_s(</span><br><span class="line">        <span class="string">"cn=admin,dc=example,dc=org"</span>,</span><br><span class="line">        ldap.SCOPE_SUBTREE,</span><br><span class="line">        <span class="comment"># ldap.SCOPE_BASE,</span></span><br><span class="line">        <span class="comment"># ldap.SCOPE_ONELEVEL,</span></span><br><span class="line">        <span class="string">'(&amp;(cn=admin))'</span>,</span><br><span class="line">    )</span><br><span class="line">    print(res)</span><br><span class="line"></span><br><span class="line">p(ldapconn, <span class="string">'cn=admin,dc=example,dc=org'</span>, <span class="string">"pwd"</span>)</span><br></pre></td></tr></table></figure><p>新建用户, 注意<code>uid</code>, <code>objectClass</code><br><figure class="highlight ldif"><table><tr><td class="code"><pre><span class="line"><span class="comment"># king, example.org</span></span><br><span class="line"><span class="attribute">dn</span>: uid=king,dc=example,dc=org</span><br><span class="line"><span class="attribute">uid</span>: king</span><br><span class="line"><span class="attribute">userPassword:</span>: e01ENX14TXBDT0tDNUk0SU56RkNhYjNXRW13PT0=</span><br><span class="line"><span class="attribute">objectClass</span>: account</span><br><span class="line"><span class="attribute">objectClass</span>: simpleSecurityObject</span><br><span class="line"><span class="attribute">objectClass</span>: top</span><br></pre></td></tr></table></figure></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, g</span><br><span class="line"><span class="keyword">from</span> flask_simpleldap <span class="keyword">import</span> LDAP</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">'dev key'</span></span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">'LDAP_OPENLDAP'</span>] = <span class="literal">True</span></span><br><span class="line">app.config[<span class="string">'LDAP_BASE_DN'</span>] = <span class="string">'dc=example,dc=org'</span></span><br><span class="line">app.config[<span class="string">'LDAP_USERNAME'</span>] = <span class="string">'cn=admin,dc=example,dc=org'</span></span><br><span class="line">app.config[<span class="string">'LDAP_PASSWORD'</span>] = <span class="string">'pwd'</span></span><br><span class="line">app.config[<span class="string">'LDAP_USER_OBJECT_FILTER'</span>] = <span class="string">'(&amp;(objectclass=simpleSecurityObject)(userid=%s))'</span></span><br><span class="line"></span><br><span class="line">ldap = LDAP(app)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="meta">@ldap.basic_auth_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Welcome, &#123;0&#125;!'</span>.format(g.ldap_username)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(port=<span class="number">5010</span>)</span><br></pre></td></tr></table></figure><p>浏览器访问<a href="http://127.0.0.1:5010/" target="_blank" rel="noopener">http://127.0.0.1:5010/</a>, 即弹出对话框,输入<code>king</code>, <code>1</code> 登录成功</p><ul><li><a href="https://github.com/admiralobvious/flask-simpleldap/tree/master/examples" target="_blank" rel="noopener">https://github.com/admiralobvious/flask-simpleldap/tree/master/examples</a> 有若干sample可供参考</li><li><a href="https://medium.com/@chris.pruitt15/ldap-user-authentication-in-flask-api-e662b0aeb7de" target="_blank" rel="noopener">https://medium.com/@chris.pruitt15/ldap-user-authentication-in-flask-api-e662b0aeb7de</a></li></ul><p>具体原理比较简单</p><ul><li>先使用环境变量配置的帐号密码(管理员)登录<ul><li><code>LDAP_USERNAME</code>/<code>LDAP_PASSWORD</code></li><li>登录见<code>simple_bind_s</code></li></ul></li><li>根据输入的uid以及<code>LDAP_USER_OBJECT_FILTER</code>来搜索用户</li><li>找到用户, 获取完整的<code>DN</code></li><li>使用DN和输入的密码再登录, 确认密码有效性</li></ul><h1 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h1><p><a href="https://github.com/go-ldap/ldap/blob/master/examples_test.go" target="_blank" rel="noopener">https://github.com/go-ldap/ldap/blob/master/examples_test.go</a> 有较详细的sample</p><blockquote><p>如果<code>gopkg.in/asn1-ber.v1</code> 安装不上, 修改<code>go.mod</code>, 添加以下内容, 重新<code>tidy</code></p></blockquote><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">replace (</span><br><span class="line">gopkg.in/asn1-ber.v1 =&gt; github.com/go-asn1-ber/asn1-ber v0.0.0-20181015200546-f715ec2f112d</span><br><span class="line">)</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/go-ldap/ldap"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">conn, err := ldap.Dial(<span class="string">"tcp"</span>, <span class="string">"127.0.0.1:389"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := conn.Bind(<span class="string">"cn=admin,dc=example,dc=org"</span>, <span class="string">"pwd"</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">searchRequest := ldap.NewSearchRequest(</span><br><span class="line"><span class="string">"dc=example,dc=org"</span>, <span class="comment">// The base dn to search</span></span><br><span class="line">ldap.ScopeWholeSubtree, ldap.NeverDerefAliases, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">false</span>,</span><br><span class="line"><span class="string">"(&amp;(uid=king))"</span>, <span class="comment">// The filter to apply</span></span><br><span class="line">[]<span class="keyword">string</span>&#123;&#125;,      <span class="comment">// A list attributes to retrieve</span></span><br><span class="line"><span class="literal">nil</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">sr, err := conn.Search(searchRequest)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, entry := <span class="keyword">range</span> sr.Entries &#123;</span><br><span class="line">fmt.Printf(<span class="string">"%s: %v\n"</span>, entry.DN, entry.GetAttributeValue(<span class="string">"cn"</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, entry := <span class="keyword">range</span> sr.Referrals &#123;</span><br><span class="line">fmt.Printf(<span class="string">"%s: %v\n"</span>, entry)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="数据安全"><a href="#数据安全" class="headerlink" title="数据安全"></a>数据安全</h1><p>缺省的<a href="https://lmdb.readthedocs.io/en/release/" target="_blank" rel="noopener">mdb数据存储</a>在<code>/var/lib/ldap/</code>, 一个数据文件,一个锁文件, 我们可以外挂docker数据目录(<code>/var/lib/ldap</code>)和配置目录(<code>/etc/ldap/slapd.d</code>)实现数据的持久化保存</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lmdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意传入的路径是一个目录, 下面包含两文件</span></span><br><span class="line">env_db = lmdb.Environment(<span class="string">'/home/user/mdb'</span>)</span><br><span class="line"></span><br><span class="line">txn = env_db.begin()</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> txn.cursor():  <span class="comment"># 遍历</span></span><br><span class="line">    print(key)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"-"</span>)</span><br><span class="line">data = txn.get(<span class="string">"cn"</span>.encode(<span class="string">"utf8"</span>))</span><br><span class="line">env_db.close()</span><br></pre></td></tr></table></figure><h2 id="安装问题"><a href="#安装问题" class="headerlink" title="安装问题"></a>安装问题</h2><ul><li><a href="https://stackoverflow.com/questions/4768446/i-cant-install-python-ldap" target="_blank" rel="noopener">I can’t install python-ldap</a></li><li><a href="https://askubuntu.com/questions/815897/how-to-meet-depends-requirements-for-libldap-2-4-2" target="_blank" rel="noopener">How to meet depends requirements for libldap-2.4-2</a></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo aptitude install libsasl2-dev</span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  libsasl2-dev&#123;b&#125; </span><br><span class="line">0 packages upgraded, 1 newly installed, 0 to remove and 5 not upgraded.</span><br><span class="line">Need to get 254 kB of archives. After unpacking 831 kB will be used.</span><br><span class="line">The following packages have unmet dependencies:</span><br><span class="line"> libsasl2-dev : Depends: libsasl2-2 (= 2.1.26.dfsg1-14build1) but 2.1.26.dfsg1-14ubuntu0.1 is installed.</span><br><span class="line">The following actions will resolve these dependencies:</span><br><span class="line"></span><br><span class="line">     Keep the following packages at their current version:</span><br><span class="line">1)     libsasl2-dev [Not Installed]                       </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Accept this solution? [Y/n/q/?] n</span><br><span class="line">The following actions will resolve these dependencies:</span><br><span class="line"></span><br><span class="line">     Downgrade the following packages:                                                   </span><br><span class="line">1)     libsasl2-2 [2.1.26.dfsg1-14ubuntu0.1 (now) -&gt; 2.1.26.dfsg1-14build1 (xenial)]     </span><br><span class="line">2)     libsasl2-2:i386 [2.1.26.dfsg1-14ubuntu0.1 (now) -&gt; 2.1.26.dfsg1-14build1 (xenial)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Accept this solution? [Y/n/q/?] y</span><br><span class="line">The following packages will be DOWNGRADED:</span><br><span class="line">  libsasl2-2 libsasl2-2:i386 </span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  libsasl2-dev </span><br><span class="line">0 packages upgraded, 1 newly installed, 2 downgraded, 0 to remove and 5 not upgraded.</span><br><span class="line">Need to get 354 kB of archives. After unpacking 831 kB will be used.</span><br><span class="line">Do you want to <span class="built_in">continue</span>? [Y/n/?] y</span><br><span class="line">Get: 1 http://mirrors.aliyun.com/ubuntu xenial/main i386 libsasl2-2 i386 2.1.26.dfsg1-14build1 [51.8 kB]</span><br><span class="line">Get: 2 http://mirrors.aliyun.com/ubuntu xenial/main amd64 libsasl2-2 amd64 2.1.26.dfsg1-14build1 [48.7 kB]</span><br><span class="line">Get: 3 http://mirrors.aliyun.com/ubuntu xenial/main amd64 libsasl2-dev amd64 2.1.26.dfsg1-14build1 [254 kB]</span><br><span class="line">Fetched 354 kB <span class="keyword">in</span> 0s (384 kB/s)       </span><br><span class="line">dpkg: warning: downgrading libsasl2-2:i386 from 2.1.26.dfsg1-14ubuntu0.1 to 2.1.26.dfsg1-14build1</span><br><span class="line">(Reading database ... 530388 files and directories currently installed.)</span><br><span class="line">Preparing to unpack .../libsasl2-2_2.1.26.dfsg1-14build1_i386.deb ...</span><br><span class="line">De-configuring libsasl2-2:amd64 (2.1.26.dfsg1-14ubuntu0.1) ...</span><br><span class="line">Unpacking libsasl2-2:i386 (2.1.26.dfsg1-14build1) over (2.1.26.dfsg1-14ubuntu0.1) ...</span><br><span class="line">dpkg: warning: downgrading libsasl2-2:amd64 from 2.1.26.dfsg1-14ubuntu0.1 to 2.1.26.dfsg1-14build1</span><br><span class="line">Preparing to unpack .../libsasl2-2_2.1.26.dfsg1-14build1_amd64.deb ...</span><br><span class="line">Unpacking libsasl2-2:amd64 (2.1.26.dfsg1-14build1) over (2.1.26.dfsg1-14ubuntu0.1) ...</span><br><span class="line">Selecting previously unselected package libsasl2-dev.</span><br><span class="line">Preparing to unpack .../libsasl2-dev_2.1.26.dfsg1-14build1_amd64.deb ...</span><br><span class="line">Unpacking libsasl2-dev (2.1.26.dfsg1-14build1) ...</span><br><span class="line">Processing triggers <span class="keyword">for</span> libc-bin (2.23-0ubuntu11) ...</span><br><span class="line">Processing triggers <span class="keyword">for</span> man-db (2.7.5-1) ...</span><br><span class="line">Setting up libsasl2-2:amd64 (2.1.26.dfsg1-14build1) ...</span><br><span class="line">Setting up libsasl2-2:i386 (2.1.26.dfsg1-14build1) ...</span><br><span class="line">Setting up libsasl2-dev (2.1.26.dfsg1-14build1) ...</span><br><span class="line">Processing triggers <span class="keyword">for</span> libc-bin (2.23-0ubuntu11) ...</span><br></pre></td></tr></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://blog.mylitboy.com/article/operation/docker-install-openldap/" target="_blank" rel="noopener">Docker安装OpenLDAP及PHPLdapAdmin客户端</a></li><li><a href="https://wiki.gentoo.org/wiki/Centralized_authentication_using_OpenLDAP/zh" target="_blank" rel="noopener">使用OpenLDAP实现集中式认证</a></li><li><a href="https://www.cnblogs.com/woshimrf/p/ldap.html" target="_blank" rel="noopener">openldap介绍和使用</a></li></ol><h2 id="应用支持"><a href="#应用支持" class="headerlink" title="应用支持"></a>应用支持</h2><ul><li><a href="https://grafana.com/docs/grafana/v6.5/auth/ldap/" target="_blank" rel="noopener">https://grafana.com/docs/grafana/v6.5/auth/ldap/</a></li><li><a href="https://github.com/nginxinc/nginx-ldap-auth" target="_blank" rel="noopener">https://github.com/nginxinc/nginx-ldap-auth</a></li><li><a href="https://github.com/Banno/getsentry-ldap-auth" target="_blank" rel="noopener">https://github.com/Banno/getsentry-ldap-auth</a></li><li><a href="https://docs.gitlab.com/ee/administration/auth/ldap.html" target="_blank" rel="noopener">https://docs.gitlab.com/ee/administration/auth/ldap.html</a></li><li><a href="https://confluence.atlassian.com/adminjiraserver/connecting-to-an-ldap-directory-938847052.html" target="_blank" rel="noopener">https://confluence.atlassian.com/adminjiraserver/connecting-to-an-ldap-directory-938847052.html</a></li><li><a href="https://wiki.jenkins.io/display/JENKINS/LDAP+Plugin" target="_blank" rel="noopener">https://wiki.jenkins.io/display/JENKINS/LDAP+Plugin</a></li><li><a href="https://resources.collab.net/blogs/subversion-ldap-authentication-with-apache" target="_blank" rel="noopener">https://resources.collab.net/blogs/subversion-ldap-authentication-with-apache</a></li><li><a href="https://github.com/flowable/flowable-engine/tree/master/modules/flowable-ldap" target="_blank" rel="noopener">https://github.com/flowable/flowable-engine/tree/master/modules/flowable-ldap</a></li><li><a href="https://www.zentao.net/extension-viewExt-76.html" target="_blank" rel="noopener">https://www.zentao.net/extension-viewExt-76.html</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;运行&quot;&gt;&lt;a href=&quot;#运行&quot; class=&quot;headerlink&quot; title=&quot;运行&quot;&gt;&lt;/a&gt;运行&lt;/h1&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span cla
      
    
    </summary>
    
      <category term="Openldap" scheme="http://blog.kimq.cn/categories/Openldap/"/>
    
    
      <category term="openldap" scheme="http://blog.kimq.cn/tags/openldap/"/>
    
  </entry>
  
  <entry>
    <title>关于配置文件的一些想法</title>
    <link href="http://blog.kimq.cn/2020/01/19/config/"/>
    <id>http://blog.kimq.cn/2020/01/19/config/</id>
    <published>2020-01-19T16:00:00.000Z</published>
    <updated>2020-08-01T09:26:24.727Z</updated>
    
    <content type="html"><![CDATA[<p>当前配置文件可选择的非常多, 从很早的ini、xml到后来的json、yaml, 以及最近讨论得比较多的toml、hcl等</p><p>总体而言, 现在越来越倾向于易与人阅读的格式, 例如yaml、toml、hcl用来结构化的符号已经非常少了, 对比此前的xml、json有明显的区别</p><p>具体怎么选择, 首先要从业务需求分析, 比如就几个key/value对, 甚至可以考虑用参数传入, 下面从几个方面考虑</p><p>Ini<br><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment">; 稍微复杂一点的单层嵌套结构</span></span><br><span class="line"></span><br><span class="line"><span class="section">[c]</span></span><br><span class="line"><span class="attr">x</span> = c.x</span><br><span class="line"><span class="attr">y</span> = c.y</span><br><span class="line"></span><br><span class="line"><span class="section">[d]</span></span><br><span class="line"><span class="attr">x</span> = d.x</span><br><span class="line"><span class="attr">y</span> = d.y</span><br></pre></td></tr></table></figure></p><hr><p>java properties<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#以下为服务器、数据库信息</span><br><span class="line">dbPort = localhost</span><br><span class="line">databaseName = mydb</span><br><span class="line">dbUserName = root</span><br><span class="line">dbPassword = root</span><br><span class="line">#以下为数据库表信息</span><br><span class="line">dbTable = mytable</span><br><span class="line">#以下为服务器信息</span><br><span class="line">ip = 192.168.0.9</span><br></pre></td></tr></table></figure></p><hr><p>json<br><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"a"</span>: <span class="string">"a"</span>,</span><br><span class="line">    <span class="attr">"b"</span>: <span class="string">"b"</span>,</span><br><span class="line">    <span class="attr">"c"</span>:&#123;</span><br><span class="line">        <span class="attr">"x"</span>: <span class="string">"c.x"</span>,</span><br><span class="line">        <span class="attr">"y"</span>: <span class="string">"c.y"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"d"</span>:&#123;</span><br><span class="line">        <span class="attr">"x"</span>: <span class="string">"d.x"</span>,</span><br><span class="line">        <span class="attr">"y"</span>: <span class="string">"d.y"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"e"</span>:[</span><br><span class="line">        &#123; <span class="attr">"x"</span>:<span class="string">"e[0].x"</span>, <span class="attr">"y"</span>:<span class="string">"e[0].y"</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">"x"</span>:<span class="string">"e[1].x"</span>, <span class="attr">"y"</span>:<span class="string">"e[1].y"</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><hr><p>yaml<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">b4:</span> <span class="literal">NuLL</span> <span class="comment"># string</span></span><br><span class="line"><span class="attr">b5:</span> <span class="literal">Null</span> <span class="comment"># null</span></span><br><span class="line"><span class="attr">c:</span></span><br><span class="line">  <span class="attr">x:</span> <span class="string">c.x</span></span><br><span class="line">  <span class="attr">y:</span> <span class="string">c.y</span></span><br><span class="line"><span class="attr">d:</span></span><br><span class="line">  <span class="attr">x:</span> <span class="string">d.x</span></span><br><span class="line">  <span class="attr">y:</span> <span class="string">d.y</span></span><br></pre></td></tr></table></figure></p><hr><p>toml<br><figure class="highlight toml"><table><tr><td class="code"><pre><span class="line"><span class="attr">a</span> = <span class="string">"a"</span></span><br><span class="line"><span class="attr">b</span> = <span class="string">"b"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">c.x</span> = <span class="string">"c.x"</span></span><br><span class="line"><span class="attr">c.y</span> = <span class="string">"c.y"</span></span><br><span class="line"></span><br><span class="line"><span class="section">[d]</span></span><br><span class="line"><span class="attr">x</span> = <span class="string">"d.x"</span></span><br><span class="line"><span class="attr">y</span> = <span class="string">"d.y"</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[e]]</span></span><br><span class="line"><span class="attr">x</span> = <span class="string">"e[0].x"</span></span><br><span class="line"><span class="attr">y</span> = <span class="string">"e[0].y"</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[e]]</span></span><br><span class="line"><span class="attr">x</span> = <span class="string">"e[1].x"</span></span><br><span class="line"><span class="attr">y</span> = <span class="string">"e[1].y"</span></span><br></pre></td></tr></table></figure></p><h2 id="机器友好-amp-人友好"><a href="#机器友好-amp-人友好" class="headerlink" title="机器友好&amp;人友好"></a>机器友好&amp;人友好</h2><p>机器友好,意味着<code>表述能力强</code>, <code>读写效率高</code>, 如果有频繁的读写操作, 并且很少会需要人来修改, 那么此类较为合适</p><p>人友好,则表示<code>容易看懂</code>, 若是修改<code>不易出错</code>.</p><blockquote><p>对于一个复杂 ( <em>特别是嵌套比较深</em> ) 的配置, 如果需要人来修改, 并非合适的选项, 做个配置页面会更好</p></blockquote><p>像xml虽然强大, 但是解析/阅读都不易, 新项目用得越来越少了</p><h2 id="注释友好"><a href="#注释友好" class="headerlink" title="注释友好"></a>注释友好</h2><p>除非完全不和人打交道, 否则注释是配置中非常重要的一块内容</p><p>xml/json对注释支持就不太好, yaml/properties/toml支持<code>#注释</code>, 部分还支持行尾注释, 而hcl则支持C语言风格的注释</p><h2 id="多行友好"><a href="#多行友好" class="headerlink" title="多行友好"></a>多行友好</h2><p>在json中写多行需要手动加换行符, 既麻烦又难以阅读, yaml原生支持<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">key:</span> <span class="string">|</span></span><br><span class="line">  <span class="string">line1</span></span><br><span class="line">  <span class="string">line2</span></span><br></pre></td></tr></table></figure></p><p>toml进一步扩展了多行的支持</p><h2 id="空格恐惧症"><a href="#空格恐惧症" class="headerlink" title="空格恐惧症"></a>空格恐惧症</h2><p>像yaml / toml / python 等通过空格缩进来确认层级的配置/语言, 容易因为多/少空格引发错误, 不过如今的编辑器都非常智能, 此类问题较为容易发现</p><p>减少结构化符号带来了空格维护问题, 过多的符号则影响内容的阅读, hcl则做了一个折中, 保留了json的大括号, 但是其他的符号适当的省略了</p><h2 id="语法增强"><a href="#语法增强" class="headerlink" title="语法增强"></a>语法增强</h2><p>所谓配置文件和编程语言相向而行, 越来越像对方了</p><h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>ini、java properties等对数组支持不是很好, 后续基本都是标配. 目前yaml/toml都支持整形/浮点/布尔/日期等常用类型</p><h3 id="层级简化"><a href="#层级简化" class="headerlink" title="层级简化"></a>层级简化</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="attr">name</span> = <span class="string">"Orange"</span></span><br><span class="line"><span class="attr">physical.color</span> = <span class="string">"orange"</span></span><br><span class="line"><span class="attr">physical.shape</span> = <span class="string">"round"</span></span><br><span class="line">site."google.com" = true</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"Orange"</span>,</span><br><span class="line">  <span class="attr">"physical"</span>: &#123;</span><br><span class="line">    <span class="attr">"color"</span>: <span class="string">"orange"</span>,</span><br><span class="line">    <span class="attr">"shape"</span>: <span class="string">"round"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"site"</span>: &#123;</span><br><span class="line">    <span class="attr">"google.com"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="代码复用"><a href="#代码复用" class="headerlink" title="代码复用"></a>代码复用</h3><p>对于一些共用的变量, 块状配置, 支持引用,  减少维护成本.  主流的配置格式暂未发现方案</p><p>有一些第三方的库可以支持, 例如<a href="https://pypi.org/project/jsonref/" target="_blank" rel="noopener">https://pypi.org/project/jsonref/</a></p><h3 id="错误检查"><a href="#错误检查" class="headerlink" title="错误检查"></a>错误检查</h3><p>xml/json 有自己的校验框架,  例如<a href="https://python-jsonschema.readthedocs.io/en/stable/" target="_blank" rel="noopener">json schema</a>, 但这并不是解释器的功能, 也并非必须, 而新的配置, 可能会做一些语法上的要求, 规避一些常见的坑, 比如toml字典里key不可重复</p><h2 id="公司技术栈和语言文化"><a href="#公司技术栈和语言文化" class="headerlink" title="公司技术栈和语言文化"></a>公司技术栈和语言文化</h2><p>每个公司都有自己的技术栈, 比如阿里的Java, 那么具体用什么配置,很多时候会参考这个技术栈里面广泛使用的配置方案.  scalar就搞了一个<a href="https://github.com/lightbend/config/blob/master/HOCON.md" target="_blank" rel="noopener">HOCON</a></p><ul><li><a href="https://github.com/toml-lang/toml" target="_blank" rel="noopener">https://github.com/toml-lang/toml</a></li><li><a href="https://github.com/hashicorp/hcl" target="_blank" rel="noopener">https://github.com/hashicorp/hcl</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;当前配置文件可选择的非常多, 从很早的ini、xml到后来的json、yaml, 以及最近讨论得比较多的toml、hcl等&lt;/p&gt;
&lt;p&gt;总体而言, 现在越来越倾向于易与人阅读的格式, 例如yaml、toml、hcl用来结构化的符号已经非常少了, 对比此前的xml、json
      
    
    </summary>
    
      <category term="学习笔记" scheme="http://blog.kimq.cn/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>Golang对象存储接口</title>
    <link href="http://blog.kimq.cn/2020/01/13/s3blob/"/>
    <id>http://blog.kimq.cn/2020/01/13/s3blob/</id>
    <published>2020-01-13T16:00:00.000Z</published>
    <updated>2020-08-01T09:26:24.731Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"context"</span></span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"io"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"><span class="string">"path"</span></span><br><span class="line"><span class="string">"path/filepath"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/aws/aws-sdk-go/aws"</span></span><br><span class="line"><span class="string">"github.com/aws/aws-sdk-go/aws/credentials"</span></span><br><span class="line"><span class="string">"github.com/aws/aws-sdk-go/aws/session"</span></span><br><span class="line"><span class="string">"gocloud.dev/blob"</span></span><br><span class="line"><span class="string">"gocloud.dev/blob/fileblob"</span></span><br><span class="line"><span class="string">"gocloud.dev/blob/s3blob"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">bucketName = <span class="string">"kimq"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> blobStorage <span class="keyword">struct</span> &#123;</span><br><span class="line">driver <span class="keyword">string</span></span><br><span class="line">bucket *blob.Bucket</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *blobStorage)</span> <span class="title">Upload</span><span class="params">(ctx context.Context, name <span class="keyword">string</span>, reader io.Reader)</span> <span class="params">(outputURL <span class="keyword">string</span>, err error)</span></span> &#123;</span><br><span class="line">key := path.Join(<span class="string">"images/"</span>, name)</span><br><span class="line">writer, err := u.bucket.NewWriter(ctx, key, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"new writer error: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_, err = io.Copy(writer, reader)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"io copy error: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">defer</span> writer.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := writer.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span>, fmt.Errorf(<span class="string">"writer close error: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ourl := fmt.Sprintf(<span class="string">"%s://%s/%s"</span>, u.driver, bucketName, key)</span><br><span class="line"><span class="keyword">return</span> ourl, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init_file_bucket</span><span class="params">(ctx context.Context, bucket <span class="keyword">string</span>)</span> <span class="params">(*blobStorage, error)</span></span> &#123;</span><br><span class="line">dir := filepath.Join(<span class="string">"/tmp/1/"</span>, bucket)</span><br><span class="line"><span class="comment">//dir := filepath.Join(os.TempDir(), bucket)</span></span><br><span class="line"><span class="keyword">if</span> err := os.MkdirAll(dir, <span class="number">0775</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"create bucket dir %q error: %v"</span>, dir, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bb, err := fileblob.OpenBucket(dir, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"open bucket error: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;blobStorage&#123;</span><br><span class="line">driver: <span class="string">"file"</span>,</span><br><span class="line">bucket: bb,</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init_jd_bucket</span><span class="params">(ctx context.Context, bucket <span class="keyword">string</span>)</span> <span class="params">(*blobStorage, error)</span></span> &#123;</span><br><span class="line">ak := <span class="string">"Access Key ID"</span></span><br><span class="line">sk := <span class="string">"Access Key Secret"</span></span><br><span class="line"></span><br><span class="line">sess, err := session.NewSession(&amp;aws.Config&#123;</span><br><span class="line">Endpoint:         aws.String(<span class="string">"s3.cn-south-1.jdcloud-oss.com"</span>), <span class="comment">//Bucket所在Endpoint</span></span><br><span class="line">Region:           aws.String(<span class="string">"cn-south-1"</span>),                    <span class="comment">//Bucket所在Region</span></span><br><span class="line">S3ForcePathStyle: aws.Bool(<span class="literal">true</span>),</span><br><span class="line">Credentials:      credentials.NewStaticCredentials(ak, sk, <span class="string">""</span>),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"new session error: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sb, err := s3blob.OpenBucket(ctx, sess, bucket, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"open bucket error: %v"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;blobStorage&#123;</span><br><span class="line">driver: <span class="string">"jds3"</span>,</span><br><span class="line">bucket: sb,</span><br><span class="line">&#125;, <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">path := <span class="string">"/tmp/workshop.png"</span></span><br><span class="line">filename := filepath.Base(path)</span><br><span class="line">f, err := os.Open(path)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctx := context.Background()</span><br><span class="line"></span><br><span class="line"><span class="comment">// up, err := init_file_bucket(ctx, bucketName)</span></span><br><span class="line">up, err := init_jd_bucket(ctx, bucketName)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> f, err := up.Upload(ctx, filename, f); err == <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"%s uploader ok %s\n"</span>, up.driver, f)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul><li><a href="https://www.alibabacloud.com/help/zh/doc-detail/64919.htm" target="_blank" rel="noopener">https://www.alibabacloud.com/help/zh/doc-detail/64919.htm</a></li><li><a href="https://docs.jdcloud.com/cn/object-storage-service/introduction-2" target="_blank" rel="noopener">https://docs.jdcloud.com/cn/object-storage-service/introduction-2</a></li><li><a href="https://docs.jdcloud.com/cn/object-storage-service/regions-and-endpoints" target="_blank" rel="noopener">https://docs.jdcloud.com/cn/object-storage-service/regions-and-endpoints</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; main&lt;/span&gt;&lt;br&gt;&lt;sp
      
    
    </summary>
    
      <category term="Golang" scheme="http://blog.kimq.cn/categories/Golang/"/>
    
    
      <category term="golang" scheme="http://blog.kimq.cn/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>errors库</title>
    <link href="http://blog.kimq.cn/2020/01/12/goerror/"/>
    <id>http://blog.kimq.cn/2020/01/12/goerror/</id>
    <published>2020-01-12T16:00:00.000Z</published>
    <updated>2020-08-01T09:26:24.727Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Pkg-errors"><a href="#Pkg-errors" class="headerlink" title="Pkg/errors"></a>Pkg/errors</h1><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/pkg/errors"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"oring error"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Func1</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := Func(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errors.WithMessage(err, <span class="string">"Func1"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Func2</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">err := Func1()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errors.Wrap(err, <span class="string">"Func2"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := Func2(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Print(err)</span><br><span class="line">fmt.Println(<span class="string">"\n------\n"</span>)</span><br><span class="line">fmt.Printf(<span class="string">"%+v"</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>New(message string)</code> 生成的错误，自带调用堆栈信息 // <code>errors.New</code>/<code>fmt.Errorf</code></li><li><code>WithMessage(err error, message string)</code>  只附加新的信息</li><li><code>func WithStack(err error) error</code> //只附加调用堆栈信息</li><li><code>func Wrap(err error, message string) error</code> //同时附加堆栈和信息</li></ul><p><code>func Cause(err error) error</code> 获取原始错误</p><h2 id="Print"><a href="#Print" class="headerlink" title="Print"></a>Print</h2><blockquote><p>fmt.Printf</p></blockquote><ul><li><code>%s,%v</code> 功能一样，输出错误信息，不包含堆栈</li><li><code>%q</code> 输出的错误信息带引号，不包含堆栈</li><li><code>%+v</code> 输出错误信息和堆栈</li></ul><h1 id="juju-errors"><a href="#juju-errors" class="headerlink" title="juju/errors"></a>juju/errors</h1><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/juju/errors"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">"oring error"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Func1</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := Func(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errors.Annotate(err, <span class="string">"Func1"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Func2</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">err := Func1()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errors.Trace(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := Func2(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Print(err)</span><br><span class="line">fmt.Println(<span class="string">"\n------\n"</span>)</span><br><span class="line">fmt.Printf(<span class="string">"%+v"</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="GOPROXY"><a href="#GOPROXY" class="headerlink" title="GOPROXY"></a>GOPROXY</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$go</span> env -w GOPROXY=https://goproxy.cn,direct</span><br><span class="line"><span class="variable">$export</span> GOPROXY=https://goproxy.cn</span><br></pre></td></tr></table></figure><h1 id="mod-replace"><a href="#mod-replace" class="headerlink" title="mod replace"></a><a href="https://studygolang.com/articles/20271" target="_blank" rel="noopener">mod replace</a></h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">replace (</span><br><span class="line">    golang.org/x/build =&gt; github.com/golang/build v0.0.0-20190416225751-b5f252a0a7dd</span><br><span class="line">    golang.org/x/crypto =&gt; github.com/golang/crypto v0.0.0-20190411191339-88737f569e3a</span><br><span class="line">    golang.org/x/exp =&gt; github.com/golang/exp v0.0.0-20190413192849-7f338f571082</span><br><span class="line">    golang.org/x/image =&gt; github.com/golang/image v0.0.0-20190417020941-4e30a6eb7d9a</span><br><span class="line">    golang.org/x/lint =&gt; github.com/golang/lint v0.0.0-20190409202823-959b441ac422</span><br><span class="line">    golang.org/x/mobile =&gt; github.com/golang/mobile v0.0.0-20190415191353-3e0bab5405d6</span><br><span class="line">    golang.org/x/net =&gt; github.com/golang/net v0.0.0-20190415214537-1da14a5a36f2</span><br><span class="line">    golang.org/x/oauth2 =&gt; github.com/golang/oauth2 v0.0.0-20190402181905-9f3314589c9a</span><br><span class="line">    golang.org/x/perf =&gt; github.com/golang/perf v0.0.0-20190312170614-0655857e383f</span><br><span class="line">    golang.org/x/sync =&gt; github.com/golang/sync v0.0.0-20190412183630-56d357773e84</span><br><span class="line">    golang.org/x/sys =&gt; github.com/golang/sys v0.0.0-20190416152802-12500544f89f</span><br><span class="line">    golang.org/x/text =&gt; github.com/golang/text v0.3.0</span><br><span class="line">    golang.org/x/time =&gt; github.com/golang/time v0.0.0-20190308202827-9d24e82272b4</span><br><span class="line">    golang.org/x/tools =&gt; github.com/golang/tools v0.0.0-20190417005754-4ca4b55e2050</span><br><span class="line">    golang.org/x/xerrors =&gt; github.com/golang/xerrors v0.0.0-20190410155217-1f06c39b4373</span><br><span class="line">    google.golang.org/api =&gt; github.com/googleapis/google-api-go-client v0.3.2</span><br><span class="line">    google.golang.org/appengine =&gt; github.com/golang/appengine v1.5.0</span><br><span class="line">    google.golang.org/genproto =&gt; github.com/google/go-genproto v0.0.0-20190415143225-d1146b9035b9</span><br><span class="line">    google.golang.org/grpc =&gt; github.com/grpc/grpc-go v1.20.0</span><br><span class="line">    gopkg.in/asn1-ber.v1 =&gt; github.com/go-asn1-ber/asn1-ber v0.0.0-20181015200546-f715ec2f112d</span><br><span class="line">    gopkg.in/fsnotify.v1 =&gt; github.com/Jwsonic/recinotify v0.0.0-20151201212458-7389700f1b43</span><br><span class="line">    gopkg.in/gorethink/gorethink.v4 =&gt; github.com/rethinkdb/rethinkdb-go v4.0.0+incompatible</span><br><span class="line">    gopkg.in/ini.v1 =&gt; github.com/go-ini/ini v1.42.0</span><br><span class="line">    gopkg.in/src-d/go-billy.v4 =&gt; github.com/src-d/go-billy v4.2.0+incompatible</span><br><span class="line">    gopkg.in/src-d/go-git-fixtures.v3 =&gt; github.com/src-d/go-git-fixtures v3.4.0+incompatible</span><br><span class="line">    gopkg.in/yaml.v2 =&gt; github.com/go-yaml/yaml v2.1.0+incompatible</span><br><span class="line">    k8s.io/api =&gt; github.com/kubernetes/api v0.0.0-20190416052506-9eb4726e83e4</span><br><span class="line">    k8s.io/apimachinery =&gt; github.com/kubernetes/apimachinery v0.0.0-20190416092415-3370b4aef5d6</span><br><span class="line">    k8s.io/client-go =&gt; github.com/kubernetes/client-go v11.0.0+incompatible</span><br><span class="line">    k8s.io/klog =&gt; github.com/simonpasquier/klog-gokit v0.1.0</span><br><span class="line">    k8s.io/kube-openapi =&gt; github.com/kubernetes/kube-openapi v0.0.0-20190401085232-94e1e7b7574c</span><br><span class="line">    k8s.io/utils =&gt; github.com/kubernetes/utils v0.0.0-20190308190857-21c4ce38f2a7</span><br><span class="line">    sigs.k8s.io/yaml =&gt; github.com/kubernetes-sigs/yaml v1.1.0</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>粘贴到项目对应的go.mod文件中，执行</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ go mod tidy</span><br></pre></td></tr></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://github.com/juju/errors" target="_blank" rel="noopener">https://github.com/juju/errors</a></li><li><a href="https://github.com/pkg/errors" target="_blank" rel="noopener">https://github.com/pkg/errors</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Pkg-errors&quot;&gt;&lt;a href=&quot;#Pkg-errors&quot; class=&quot;headerlink&quot; title=&quot;Pkg/errors&quot;&gt;&lt;/a&gt;Pkg/errors&lt;/h1&gt;&lt;figure class=&quot;highlight golang&quot;&gt;&lt;table&gt;&lt;
      
    
    </summary>
    
      <category term="Golang" scheme="http://blog.kimq.cn/categories/Golang/"/>
    
    
      <category term="golang" scheme="http://blog.kimq.cn/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Go编译时变量</title>
    <link href="http://blog.kimq.cn/2020/01/12/goversion/"/>
    <id>http://blog.kimq.cn/2020/01/12/goversion/</id>
    <published>2020-01-12T16:00:00.000Z</published>
    <updated>2020-08-01T09:26:24.727Z</updated>
    
    <content type="html"><![CDATA[<p>支持每次打包都动态更新版本号,编译时间之类的变量</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-X importpath.name=value </span><br><span class="line">Set the value of the string variable in importpath named name to value. </span><br><span class="line">Note that before Go 1.5 this option took two separate arguments. </span><br><span class="line">Now it takes one argument split on the first = sign.</span><br></pre></td></tr></table></figure><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> buildstamp = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"Build Time : %s\n"</span>, buildstamp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$export</span> flags=<span class="string">"-X main.buildstamp=`date -u '+%Y-%m-%d_%I:%M:%S%p'`"</span></span><br><span class="line"><span class="variable">$go</span> build -ldflags <span class="string">"<span class="variable">$flags</span>"</span> -o m m.go </span><br><span class="line">$./m</span><br></pre></td></tr></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://golang.org/cmd/link/" target="_blank" rel="noopener">https://golang.org/cmd/link/</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;支持每次打包都动态更新版本号,编译时间之类的变量&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;-X importpath.name=value
      
    
    </summary>
    
      <category term="Golang" scheme="http://blog.kimq.cn/categories/Golang/"/>
    
    
      <category term="golang" scheme="http://blog.kimq.cn/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Vagrant踩坑</title>
    <link href="http://blog.kimq.cn/2020/01/11/vagrant/"/>
    <id>http://blog.kimq.cn/2020/01/11/vagrant/</id>
    <published>2020-01-11T16:00:00.000Z</published>
    <updated>2020-08-01T09:26:24.731Z</updated>
    
    <content type="html"><![CDATA[<p>Vagrant是用来管理虚拟机的，如VirtualBox、VMware、AWS等，主要好处是可以提供一个可配置、可移植和复用的软件环境，可以使用shell、chef、puppet等工具部署。</p><h2 id="安装vagrant-virtualbox"><a href="#安装vagrant-virtualbox" class="headerlink" title="安装vagrant/virtualbox"></a>安装vagrant/virtualbox</h2><blockquote><p>由于<code>apt install</code>安装的版本太老, 所以从官网下载<code>vagrant_2.2.5_x86_64.deb</code></p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/data/vagrantbox$ vagrant up --provider=virtualbox</span><br><span class="line">The provider <span class="string">'virtualbox'</span> that was requested to back the machine</span><br><span class="line"><span class="string">'default'</span> is reporting that it isn<span class="string">'t usable on this system. The</span></span><br><span class="line"><span class="string">reason is shown below:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Vagrant has detected that you have a version of VirtualBox installed</span></span><br><span class="line"><span class="string">that is not supported by this version of Vagrant. Please install one of</span></span><br><span class="line"><span class="string">the supported versions listed below to use Vagrant:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">4.0, 4.1, 4.2, 4.3, 5.0, 5.1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">A Vagrant update may also be available that adds support for the version</span></span><br><span class="line"><span class="string">you specified. Please check www.vagrantup.com/downloads.html to download</span></span><br><span class="line"><span class="string">the latest version.</span></span><br></pre></td></tr></table></figure><h2 id="添加box"><a href="#添加box" class="headerlink" title="添加box"></a>添加box</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vagrant box add ubuntu/bionic https://mirrors.tuna.tsinghua.edu.cn/ubuntu-cloud-images/bionic/current/bionic-server-cloudimg-amd64-vagrant.box</span><br><span class="line">==&gt; box: Box file was not detected as metadata. Adding it directly...</span><br><span class="line">==&gt; box: Adding box <span class="string">'ubuntu/bionic'</span> (v0) <span class="keyword">for</span> provider: </span><br><span class="line">    box: Downloading: https://mirrors.tuna.tsinghua.edu.cn/ubuntu-cloud-images/bionic/current/bionic-server-cloudimg-amd64-vagrant.box</span><br><span class="line">==&gt; box: Successfully added box <span class="string">'ubuntu/bionic'</span> (v0) <span class="keyword">for</span> <span class="string">'virtualbox'</span>!</span><br></pre></td></tr></table></figure><h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vagrant box update</span><br></pre></td></tr></table></figure><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir vagrantbox</span><br><span class="line">$ <span class="built_in">cd</span> vagrantbox/</span><br><span class="line">$ vagrant init ubuntu/bionic</span><br><span class="line">A `Vagrantfile` has been placed <span class="keyword">in</span> this directory. You are now</span><br><span class="line">ready to `vagrant up` your first virtual environment! Please <span class="built_in">read</span></span><br><span class="line">the comments <span class="keyword">in</span> the Vagrantfile as well as documentation on</span><br><span class="line">`vagrantup.com` <span class="keyword">for</span> more information on using Vagrant.</span><br><span class="line">$ ls</span><br><span class="line">Vagrantfile</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vagrant up --provider=virtualbox</span><br><span class="line">Bringing machine <span class="string">'default'</span> up with <span class="string">'virtualbox'</span> provider...</span><br><span class="line">==&gt; default: Importing base box <span class="string">'ubuntu/bionic'</span>...</span><br><span class="line">==&gt; default: Matching MAC address <span class="keyword">for</span> NAT networking...</span><br><span class="line">==&gt; default: Checking <span class="keyword">if</span> box <span class="string">'ubuntu/bionic'</span> version <span class="string">'20190729'</span> is up to date...</span><br><span class="line">==&gt; default: Setting the name of the VM: vagrantbox_default_1564392888222_56525</span><br><span class="line">==&gt; default: Clearing any previously <span class="built_in">set</span> network interfaces...</span><br><span class="line">==&gt; default: Preparing network interfaces based on configuration...</span><br><span class="line">    default: Adapter 1: nat</span><br><span class="line">==&gt; default: Forwarding ports...</span><br><span class="line">    default: 22 (guest) =&gt; 2222 (host) (adapter 1)</span><br><span class="line">==&gt; default: Booting VM...</span><br><span class="line">==&gt; default: Waiting <span class="keyword">for</span> machine to boot. This may take a few minutes...</span><br><span class="line">    default: SSH address: 127.0.0.1:2222</span><br><span class="line">    default: SSH username: vagrant</span><br><span class="line">    default: SSH auth method: private key</span><br><span class="line">    default: </span><br><span class="line">    default: Vagrant insecure key detected. Vagrant will automatically replace</span><br><span class="line">    default: this with a newly generated keypair <span class="keyword">for</span> better security.</span><br><span class="line">    default: </span><br><span class="line">    default: Inserting generated public key within guest...</span><br><span class="line">    default: Removing insecure key from the guest <span class="keyword">if</span> it<span class="string">'s present...</span></span><br><span class="line"><span class="string">    default: Key inserted! Disconnecting and reconnecting using new SSH key...</span></span><br><span class="line"><span class="string">==&gt; default: Machine booted and ready!</span></span><br><span class="line"><span class="string">==&gt; default: Checking for guest additions in VM...</span></span><br><span class="line"><span class="string">    default: The guest additions on this VM do not match the installed version of</span></span><br><span class="line"><span class="string">    default: VirtualBox! In most cases this is fine, but in rare cases it can</span></span><br><span class="line"><span class="string">    default: prevent things such as shared folders from working properly. If you see</span></span><br><span class="line"><span class="string">    default: shared folder errors, please make sure the guest additions within the</span></span><br><span class="line"><span class="string">    default: virtual machine match the version of VirtualBox you have installed on</span></span><br><span class="line"><span class="string">    default: your host and reload your VM.</span></span><br><span class="line"><span class="string">    default: </span></span><br><span class="line"><span class="string">    default: Guest Additions Version: 5.2.22</span></span><br><span class="line"><span class="string">    default: VirtualBox Version: 6.0</span></span><br><span class="line"><span class="string">==&gt; default: Mounting shared folders...</span></span><br><span class="line"><span class="string">    default: /vagrant =&gt; /home/king/data/vagrantbox</span></span><br></pre></td></tr></table></figure><h2 id="查看进程"><a href="#查看进程" class="headerlink" title="查看进程"></a>查看进程</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ps aufx | grep virtualbox</span><br><span class="line">king \_ grep --color=auto virtualbox</span><br><span class="line">king  \_ /usr/lib/virtualbox/VBoxXPCOMIPCD</span><br><span class="line">king    \_ /usr/lib/virtualbox/VBoxSVC --auto-shutdown</span><br><span class="line">king     \_ /usr/lib/virtualbox/VBoxHeadless --comment vagrantbox_default_1564392888222_56525 --startvm 315ba5d9-fb4c-40ca-acf4-97dc75db70c7 --vrde config</span><br></pre></td></tr></table></figure><h2 id="进入shell"><a href="#进入shell" class="headerlink" title="进入shell"></a>进入shell</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vagrant ssh</span><br><span class="line">Welcome to Ubuntu 18.04.2 LTS (GNU/Linux 4.15.0-56-generic x86_64)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com</span><br><span class="line"> * Management:     https://landscape.canonical.com</span><br><span class="line"> * Support:        https://ubuntu.com/advantage</span><br><span class="line"></span><br><span class="line">vagrant@ubuntu:~$ <span class="built_in">pwd</span></span><br><span class="line">/home/vagrant</span><br><span class="line">vagrant@ubuntu:~$ <span class="built_in">logout</span></span><br><span class="line">Connection to 127.0.0.1 closed.</span><br></pre></td></tr></table></figure><h2 id="关机-amp-销毁"><a href="#关机-amp-销毁" class="headerlink" title="关机&amp;销毁"></a>关机&amp;销毁</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vagrant halt</span><br><span class="line">==&gt; default: Attempting graceful shutdown of VM...</span><br><span class="line">$ vagrant destroy</span><br><span class="line">    default: Are you sure you want to destroy the <span class="string">'default'</span> VM? [y/N] y</span><br><span class="line">==&gt; default: Destroying VM and associated drives...</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://www.vagrantup.com/" target="_blank" rel="noopener">https://www.vagrantup.com/</a></li><li><a href="https://www.cnblogs.com/hafiz/p/9175484.html" target="_blank" rel="noopener">https://www.cnblogs.com/hafiz/p/9175484.html</a></li><li><a href="https://segmentfault.com/a/1190000000264347" target="_blank" rel="noopener">https://segmentfault.com/a/1190000000264347</a></li><li><a href="https://github.com/astaxie/go-best-practice/blob/master/ebook/zh/01.3.md" target="_blank" rel="noopener">https://github.com/astaxie/go-best-practice/blob/master/ebook/zh/01.3.md</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Vagrant是用来管理虚拟机的，如VirtualBox、VMware、AWS等，主要好处是可以提供一个可配置、可移植和复用的软件环境，可以使用shell、chef、puppet等工具部署。&lt;/p&gt;
&lt;h2 id=&quot;安装vagrant-virtualbox&quot;&gt;&lt;a href
      
    
    </summary>
    
      <category term="开发环境" scheme="http://blog.kimq.cn/categories/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"/>
    
    
  </entry>
  
  <entry>
    <title>使用landslide生成幻灯片</title>
    <link href="http://blog.kimq.cn/2020/01/10/landslide/"/>
    <id>http://blog.kimq.cn/2020/01/10/landslide/</id>
    <published>2020-01-10T16:00:00.000Z</published>
    <updated>2020-08-01T09:26:24.727Z</updated>
    
    <content type="html"><![CDATA[<p>官网 <a href="https://github.com/adamzap/landslide" target="_blank" rel="noopener">https://github.com/adamzap/landslide</a></p><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install landslide</span><br></pre></td></tr></table></figure><h2 id="从源码安装"><a href="#从源码安装" class="headerlink" title="从源码安装"></a>从源码安装</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/adamzap/landslide.git</span><br><span class="line">$ <span class="built_in">cd</span> landslide</span><br><span class="line">$ python setup.py build</span><br><span class="line">$ sudo python setup.py install</span><br></pre></td></tr></table></figure><h1 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h1><ul><li>Press h to toggle display of help</li><li>Press left arrow and right arrow to navigate</li><li>Press t to toggle a table of contents for your presentation. Slide titles are links</li><li>Press ESC to display the presentation overview (Exposé)</li><li>Press n to toggle slide number visibility</li><li>Press b to toggle screen blanking</li><li>Press c to toggle current slide context (previous and next slides)</li><li>Press e to make slides filling the whole available space within the document body</li><li>Press S to toggle display of link to the source file for each slide</li><li>Press ‘2’ to toggle notes in your slides (specify with the .notes macro)</li><li>Press ‘3’ to toggle pseudo-3D display (experimental)</li><li>Browser zooming is supported</li></ul><h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">landslide a.md -i -o &gt; name_you_like.html</span><br></pre></td></tr></table></figure><h1 id="sample"><a href="#sample" class="headerlink" title="sample"></a>sample</h1><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># Landslide</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="section"># Overview</span></span><br><span class="line"></span><br><span class="line">Generate HTML5 slideshows from markdown, ReST, or textile.</span><br><span class="line"></span><br><span class="line">![<span class="string">python</span>](<span class="link">http://i.imgur.com/bc2xk.png</span>)</span><br><span class="line"></span><br><span class="line">Landslide is primarily written in Python, but it's themes use:</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>HTML5</span><br><span class="line"><span class="bullet">- </span>Javascript</span><br><span class="line"><span class="bullet">- </span>CSS</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="section"># Code Sample</span></span><br><span class="line"></span><br><span class="line">Landslide supports code snippets</span><br><span class="line"></span><br><span class="line"><span class="code">    !python</span></span><br><span class="line"><span class="code">    def log(self, message, level='notice'):</span></span><br><span class="line"><span class="code">        if self.logger and not callable(self.logger):</span></span><br><span class="line"><span class="code">            raise ValueError(u"Invalid logger set, must be a callable")</span></span><br><span class="line"></span><br><span class="line"><span class="code">        if self.verbose and self.logger:</span></span><br><span class="line"><span class="code">            self.logger(message, level)</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;官网 &lt;a href=&quot;https://github.com/adamzap/landslide&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/adamzap/landslide&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;安装&quot;
      
    
    </summary>
    
      <category term="开发环境" scheme="http://blog.kimq.cn/categories/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"/>
    
    
  </entry>
  
  <entry>
    <title>Python安装Git库</title>
    <link href="http://blog.kimq.cn/2018/07/16/python-pip-from-git/"/>
    <id>http://blog.kimq.cn/2018/07/16/python-pip-from-git/</id>
    <published>2018-07-16T09:33:35.000Z</published>
    <updated>2020-08-01T09:26:24.731Z</updated>
    
    <content type="html"><![CDATA[<p>依赖特定的版本</p><p>例如requirements.txt中<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ssh方式</span></span><br><span class="line">git+ssh://git@github.com/qjw/flask-swagger.git@v1.0.1</span><br><span class="line"><span class="comment"># https方式</span></span><br><span class="line">git+https://github.com/qjw/flask-swagger.git@@v1.0.1</span><br><span class="line"><span class="comment"># 本地文件系统</span></span><br><span class="line">git+file:///home/king/code/flask-swagger/</span><br></pre></td></tr></table></figure></p><p>或者<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install git+https://github.com/qjw/flask-swagger.git@v1.0.1</span><br></pre></td></tr></table></figure></p><p>安装之后,源码在目录<code>venv/lib/python3.5/site-packages/flask_swagger</code></p><p>@后面可以是<code>tag</code>/<code>branch</code>甚至<code>commit</code>.</p><p>这种方案的不足是: 每次提交修改都得<code>打tag</code>,若是提交频繁会相当麻烦且容易出错,</p><p>如果改动之后,不重新打tag,会受到cache的影响而不能即使更新</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p pip-cache</span><br><span class="line">pip install --cache-dir pip-cache -r requirements.txt</span><br></pre></td></tr></table></figure><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>在开发期间,可以使用<code>文件系统的方式</code>不经过外网安装</p><h2 id="频繁的改动"><a href="#频繁的改动" class="headerlink" title="频繁的改动"></a>频繁的改动</h2><p>前面打tag的方式,适合那些不经常变化的基础库,对于频繁有更新的项目,可以考虑使用<a href="https://pip.readthedocs.io/en/1.1/requirements.html" target="_blank" rel="noopener"><code>editable</code> packages</a>方式安装</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 指定版本(tag)</span></span><br><span class="line">-e git+ssh://git@github.com/qjw/flask-swagger.git@v1.0.1<span class="comment">#flask-swagger</span></span><br><span class="line"><span class="comment"># 直接从master</span></span><br><span class="line">-e git+ssh://git@github.com/qjw/flask-swagger.git<span class="comment">#egg=flask-swagger</span></span><br><span class="line"><span class="comment"># 从本地目录引用(调试)</span></span><br><span class="line">-e git+file:///home/king/code/flask-swagger<span class="comment">#egg=flask-swagger</span></span><br></pre></td></tr></table></figure><p>和前面的方式相比,多了参数<code>-e</code>,以及后面额<code>egg</code> hash,后者指定了源码存放的目录,具体的路径在<code>venv/src/flask-swagger</code>.</p><h3 id="已知问题"><a href="#已知问题" class="headerlink" title="已知问题"></a>已知问题</h3><p>若直接使用master或其他分支,会产生历史版本不一致的问题</p><blockquote><p>比如我重新编译一个历史版本,会因为依赖变化导致不一致的行为</p></blockquote><p>每一次产生一个branche是不现实的,用tag相对较好.代码管理是一个受权限控制的行为,那么这个tag由谁来打就是个问题</p><ol><li>如果开发者自行打tag,那git tags会各种乱和冲突</li><li>如果管理员来做,那么开发效率有严重影响(在联调过程中,tag必须准备好,可是改个bug又必须重新tag)</li></ol><p>直接使用commit id也是一种可行的办法,不过这种方式非常的不优雅</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;依赖特定的版本&lt;/p&gt;
&lt;p&gt;例如requirements.txt中&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;com
      
    
    </summary>
    
      <category term="后端" scheme="http://blog.kimq.cn/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
      <category term="git" scheme="http://blog.kimq.cn/tags/git/"/>
    
      <category term="python" scheme="http://blog.kimq.cn/tags/python/"/>
    
      <category term="pip" scheme="http://blog.kimq.cn/tags/pip/"/>
    
  </entry>
  
  <entry>
    <title>Golang defer的坑,以及函数执行顺序差异</title>
    <link href="http://blog.kimq.cn/2018/07/16/go-defer-param-order/"/>
    <id>http://blog.kimq.cn/2018/07/16/go-defer-param-order/</id>
    <published>2018-07-16T08:14:19.000Z</published>
    <updated>2020-08-01T09:26:24.727Z</updated>
    
    <content type="html"><![CDATA[<p>C/C++函数结果作为参数,会从右到左</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>&#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"B %d\n"</span>,i);</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function">B <span class="title">f</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"A %d\n"</span>,i);</span><br><span class="line">            B b;</span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"C %d %d\n"</span>,a,b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    B b;</span><br><span class="line">    A a;</span><br><span class="line">    <span class="comment">// 从右到左执行</span></span><br><span class="line">    f(a.f(<span class="number">1</span>).f(<span class="number">2</span>),b.f(<span class="number">3</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">B 3</span><br><span class="line">A 1</span><br><span class="line">B 2</span><br><span class="line">C 2 3</span><br></pre></td></tr></table></figure><p>golang变成了从左到右</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> B <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*B)</span> <span class="title">f</span><span class="params">(p <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"B %d\n"</span>, p)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> A <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*A)</span> <span class="title">f</span><span class="params">(p <span class="keyword">int</span>)</span> *<span class="title">B</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"A %d\n"</span>, p)</span><br><span class="line"><span class="keyword">return</span> &amp;B&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dd</span><span class="params">(*B, <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"C"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">a := &amp;A&#123;&#125;</span><br><span class="line">b := &amp;B&#123;&#125;</span><br><span class="line">    <span class="comment">// 在defer之前,会计算到保留最后一个函数,也就是a.f(1)会先执行</span></span><br><span class="line"><span class="keyword">defer</span> a.f(<span class="number">1</span>).f(<span class="number">2</span>)</span><br><span class="line">    <span class="comment">// 从左到右执行</span></span><br><span class="line"><span class="keyword">defer</span> dd(a.f(<span class="number">3</span>), b.f(<span class="number">4</span>))</span><br><span class="line">    <span class="comment">// 匿名函数,defer统一执行</span></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">a.f(<span class="number">5</span>).f(<span class="number">6</span>)</span><br><span class="line">&#125;()</span><br><span class="line">fmt.Println(<span class="string">"main"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A 1</span><br><span class="line">A 3</span><br><span class="line">B 4</span><br><span class="line">main</span><br><span class="line">A 5</span><br><span class="line">B 6</span><br><span class="line">C</span><br><span class="line">B 2</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;C/C++函数结果作为参数,会从右到左&lt;/p&gt;
&lt;figure class=&quot;highlight cpp&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class
      
    
    </summary>
    
      <category term="Golang" scheme="http://blog.kimq.cn/categories/Golang/"/>
    
    
      <category term="golang" scheme="http://blog.kimq.cn/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>腾讯Tars初探</title>
    <link href="http://blog.kimq.cn/2018/06/26/tars/"/>
    <id>http://blog.kimq.cn/2018/06/26/tars/</id>
    <published>2018-06-26T12:25:07.000Z</published>
    <updated>2020-08-01T09:26:24.731Z</updated>
    
    <content type="html"><![CDATA[<p>官网</p><ol><li><a href="https://github.com/Tencent/Tars" target="_blank" rel="noopener">https://github.com/Tencent/Tars</a></li><li><a href="https://github.com/tars-node" target="_blank" rel="noopener">https://github.com/tars-node</a></li></ol><p>本文重点参考</p><ol><li><a href="https://github.com/Tencent/Tars/blob/master/Install.md" target="_blank" rel="noopener">https://github.com/Tencent/Tars/blob/master/Install.md</a></li><li><a href="https://github.com/Tencent/Tars/blob/master/docs/tars_cpp_quickstart.md" target="_blank" rel="noopener">https://github.com/Tencent/Tars/blob/master/docs/tars_cpp_quickstart.md</a></li></ol><h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><p>下载代码、apt-get安装依赖</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@github.com:Tencent/Tars.git</span><br><span class="line">apt-get install flex bison libmysqlclient-dev</span><br></pre></td></tr></table></figure><p>安装第三方库<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$&#123;TARS_ROOT&#125;</span>/Tars/cpp/thirdparty/thirdparty.sh</span><br></pre></td></tr></table></figure></p><p>实际就下载一个<code>rapidjson</code><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/Tars/cpp/thirdparty$ tree -L 2</span><br><span class="line">.</span><br><span class="line">├── rapidjson</span><br><span class="line">│   ├── appveyor.yml</span><br><span class="line">│   ├── bin</span><br><span class="line">│   ├── CHANGELOG.md</span><br><span class="line">│   ├── CMakeLists.txt</span><br><span class="line">│   ├── CMakeModules</span><br><span class="line">│   ├── contrib</span><br><span class="line">│   ├── doc</span><br><span class="line">│   ├── docker</span><br><span class="line">│   ├── example</span><br><span class="line">│   ├── include</span><br><span class="line">│   ├── include_dirs.js</span><br><span class="line">│   ├── library.json</span><br><span class="line">│   ├── license.txt</span><br><span class="line">│   ├── package.json</span><br><span class="line">│   ├── rapidjson.autopkg</span><br><span class="line">│   ├── RapidJSONConfig.cmake.in</span><br><span class="line">│   ├── RapidJSONConfigVersion.cmake.in</span><br><span class="line">│   ├── RapidJSON.pc.in</span><br><span class="line">│   ├── readme.md</span><br><span class="line">│   ├── readme.zh-cn.md</span><br><span class="line">│   ├── <span class="built_in">test</span></span><br><span class="line">│   ├── thirdparty</span><br><span class="line">│   └── travis-doxygen.sh</span><br><span class="line">└── thirdparty.sh</span><br></pre></td></tr></table></figure></p><h1 id="编译核心组件-开发库"><a href="#编译核心组件-开发库" class="headerlink" title="编译核心组件/开发库"></a>编译核心组件/开发库</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;TARS_ROOT&#125;</span>/Tars/cpp/build</span><br><span class="line">chmod u+x build.sh</span><br><span class="line">./build.sh all</span><br></pre></td></tr></table></figure><p>需要重来，则<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./build.sh cleanall</span><br></pre></td></tr></table></figure></p><p>由于ubuntu的mysql库路径和tars默认配置不一致，所以需要在编译前修改CMAKE配置,<code>${TARS_ROOT}/Tars/cpp/build/CmakeLists.txt</code><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span>(MYSQL_DIR_INC <span class="string">"/usr/include/mysql"</span>)</span><br><span class="line"><span class="built_in">set</span>(MYSQL_DIR_LIB <span class="string">"/usr/lib/x86_64-linux-gnu/"</span>)</span><br></pre></td></tr></table></figure></p><h2 id="安装开发库"><a href="#安装开发库" class="headerlink" title="安装开发库"></a>安装开发库</h2><p>编译成功之后<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span></span><br><span class="line">sudo mkdir tars</span><br><span class="line">sudo chown king:king ./tars/  <span class="comment"># king酌情修改</span></span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;TARS_ROOT&#125;</span>/Tars/cpp/build</span><br><span class="line">./build.sh install</span><br></pre></td></tr></table></figure><p>文件内容如下，主要用于Cpp开发（头文件/库）</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:/usr/<span class="built_in">local</span>/tars$ tree -L 3</span><br><span class="line">.</span><br><span class="line">└── cpp</span><br><span class="line">    ├── include</span><br><span class="line">    │   ├── jmem</span><br><span class="line">    │   ├── promise</span><br><span class="line">    │   ├── servant</span><br><span class="line">    │   ├── tup</span><br><span class="line">    │   └── util</span><br><span class="line">    ├── lib</span><br><span class="line">    │   ├── libtarsparse.a</span><br><span class="line">    │   ├── libtarsservant.a</span><br><span class="line">    │   └── libtarsutil.a</span><br><span class="line">    ├── makefile</span><br><span class="line">    │   └── makefile.tars</span><br><span class="line">    ├── script</span><br><span class="line">    │   ├── create_http_server.sh</span><br><span class="line">    │   ├── create_tars_server.sh</span><br><span class="line">    │   ├── demo</span><br><span class="line">    │   └── http_demo</span><br><span class="line">    └── tools</span><br><span class="line">        ├── tars2android</span><br><span class="line">        ├── tars2c</span><br><span class="line">        ├── tars2cpp</span><br><span class="line">        ├── tars2cs</span><br><span class="line">        ├── tars2node</span><br><span class="line">        ├── tars2oc</span><br><span class="line">        ├── tars2php</span><br><span class="line">        └── tars2python</span><br></pre></td></tr></table></figure><h2 id="安装基础服务"><a href="#安装基础服务" class="headerlink" title="安装基础服务"></a>安装基础服务</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;TARS_ROOT&#125;</span>/Tars/cpp/build</span><br><span class="line">make framework-tar</span><br></pre></td></tr></table></figure><p>会生成一个<code>framework.tgz</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/app</span><br><span class="line">sudo mkdir tars</span><br><span class="line">sudo chown king:king ./tars/  <span class="comment"># king酌情修改</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;TARS_ROOT&#125;</span>/Tars/cpp/build</span><br><span class="line">cp ./framework.tgz /usr/<span class="built_in">local</span>/app/tars/</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/app/tars</span><br><span class="line">tar xzfv framework.tgz</span><br></pre></td></tr></table></figure><p>内容如下</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:/usr/<span class="built_in">local</span>/app/tars$ tree -L 2</span><br><span class="line">.</span><br><span class="line">├── framework.tgz</span><br><span class="line">├── tarsAdminRegistry</span><br><span class="line">│   ├── bin</span><br><span class="line">│   ├── conf</span><br><span class="line">│   └── util</span><br><span class="line">├── tarsconfig</span><br><span class="line">│   ├── bin</span><br><span class="line">│   ├── conf</span><br><span class="line">│   ├── data</span><br><span class="line">│   └── util</span><br><span class="line">├── tars_install.sh</span><br><span class="line">├── tarsnode</span><br><span class="line">│   ├── bin</span><br><span class="line">│   ├── conf</span><br><span class="line">│   ├── data</span><br><span class="line">│   ├── tmp</span><br><span class="line">│   └── util</span><br><span class="line">├── tarsnode_install.sh</span><br><span class="line">├── tarspatch</span><br><span class="line">│   ├── bin</span><br><span class="line">│   ├── conf</span><br><span class="line">│   ├── data</span><br><span class="line">│   └── util</span><br><span class="line">└── tarsregistry</span><br><span class="line">    ├── bin</span><br><span class="line">    ├── conf</span><br><span class="line">    ├── data</span><br><span class="line">    └── util</span><br></pre></td></tr></table></figure><h1 id="运行核心基础服务"><a href="#运行核心基础服务" class="headerlink" title="运行核心基础服务"></a>运行核心基础服务</h1><h2 id="准备Mysql"><a href="#准备Mysql" class="headerlink" title="准备Mysql"></a>准备Mysql</h2><p>安装之后<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> db_tars <span class="keyword">default</span> <span class="keyword">charset</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> tars_stat <span class="keyword">default</span> <span class="keyword">charset</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> tars_property <span class="keyword">default</span> <span class="keyword">charset</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br></pre></td></tr></table></figure></p><p>修改IP。<code>这里的IP可用域名</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;TARS_ROOT&#125;</span>/Tars/cpp/framework/sql</span><br><span class="line">sed -i <span class="string">"s/192.168.2.131/192.168.10.6/g"</span> `grep 192.168.2.131 -rl ./*`</span><br><span class="line">sed -i <span class="string">"s/db.tars.com/server/g"</span> `grep db.tars.com -rl ./*`</span><br><span class="line">sed -i <span class="string">"s/tars2015/password/g"</span> `grep tars2015 -rl ./*`</span><br><span class="line">sed -i <span class="string">"s/dbuser=tars/dbuser=user/g"</span> `grep dbuser=tars -rl ./*`</span><br></pre></td></tr></table></figure><p>创建表<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:/usr/<span class="built_in">local</span>/app/tars$ mysql -uu -pp -hserver db_tars <span class="comment"># user/password酌情修改</span></span><br><span class="line">mysql&gt; <span class="built_in">source</span> ./cpp/framework/sql/db_tars.sql</span><br></pre></td></tr></table></figure></p><p>若想使用默认的帐号密码<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CREATE USER <span class="string">'tars'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'tars2015'</span>;</span><br><span class="line">GRANT ALL ON db_tars.* TO <span class="string">'tars'</span>@<span class="string">'%'</span>;</span><br><span class="line">GRANT ALL ON tars_stat.* TO <span class="string">'tars'</span>@<span class="string">'%'</span>;</span><br><span class="line">GRANT ALL ON tars_property.* TO <span class="string">'tars'</span>@<span class="string">'%'</span>;</span><br></pre></td></tr></table></figure></p><h2 id="修改服务配置"><a href="#修改服务配置" class="headerlink" title="修改服务配置"></a>修改服务配置</h2><h3 id="修改IP地址"><a href="#修改IP地址" class="headerlink" title="修改IP地址"></a>修改IP地址</h3><p>因为个人的Mysql没有在本机，所以单独处理</p><blockquote><p><code>注意原来为IP的地方，不能用域名，否则会bind失败</code>（其实可以改进一下）</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> your_machine_ip=192.168.10.6</span><br><span class="line">sed -i <span class="string">"s/192.168.2.131/<span class="variable">$&#123;your_machine_ip&#125;</span>/g"</span> `grep 192.168.2.131 -rl ./*`</span><br><span class="line">sed -i <span class="string">"s/registry.tars.com/<span class="variable">$&#123;your_machine_ip&#125;</span>/g"</span> `grep registry.tars.com -rl ./*`</span><br><span class="line">sed -i <span class="string">"s/web.tars.com/<span class="variable">$&#123;your_machine_ip&#125;</span>/g"</span> `grep web.tars.com -rl ./*`</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> your_machine_ip=server</span><br><span class="line">sed -i <span class="string">"s/db.tars.com/<span class="variable">$&#123;your_machine_ip&#125;</span>/g"</span> `grep db.tars.com -rl ./*`</span><br></pre></td></tr></table></figure><h3 id="修改Mysql帐号密码"><a href="#修改Mysql帐号密码" class="headerlink" title="修改Mysql帐号密码"></a>修改Mysql帐号密码</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:/usr/<span class="built_in">local</span>/app/tars$ grep dbuser -rl ./* | grep <span class="string">".conf"</span></span><br><span class="line">./tarsAdminRegistry/conf/adminregistry.conf</span><br><span class="line">./tarsconfig/conf/tarsconfig.conf</span><br><span class="line">./tarsconfig/bin/tarsconfig</span><br><span class="line">./tarsregistry/conf/tarsregistry.conf</span><br></pre></td></tr></table></figure><p>Mysql帐号密码通过下列的配置指定</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">db</span>&gt;</span></span><br><span class="line">    charset=utf8</span><br><span class="line">    dbhost=server</span><br><span class="line">    dbname=db_tars</span><br><span class="line">    dbpass=p</span><br><span class="line">    dbport=3306</span><br><span class="line">    dbuser=u</span><br><span class="line"><span class="tag">&lt;/<span class="name">db</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Cd /usr/<span class="built_in">local</span>/app/tars</span><br><span class="line">chmod u+x tars_install.sh</span><br><span class="line"><span class="comment"># 运行基础组件（共五个进程）</span></span><br><span class="line">./tars_install.sh</span><br><span class="line"><span class="comment"># 运行rsync</span></span><br><span class="line">sudo ./tarspatch/util/init.sh</span><br></pre></td></tr></table></figure><p>进程如下</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/app/tars/tarsregistry/bin/tarsregistry --config=/usr/<span class="built_in">local</span>/app/tars/tarsregistry/conf/tarsregistry.conf</span><br><span class="line">/usr/<span class="built_in">local</span>/app/tars/tarsAdminRegistry/bin/tarsAdminRegistry --config=/usr/<span class="built_in">local</span>/app/tars/tarsAdminRegistry/conf/adminregistry.conf</span><br><span class="line">/usr/<span class="built_in">local</span>/app/tars/tarsnode/bin/tarsnode --locator=tars.tarsregistry.QueryObj@tcp -h 192.168.10.6 -p 17890 --config=/usr/<span class="built_in">local</span>/app/tars/tarsnode/conf/tarsnode.conf</span><br><span class="line">/usr/<span class="built_in">local</span>/app/tars/tarsconfig/bin/tarsconfig --config=/usr/<span class="built_in">local</span>/app/tars/tarsconfig/conf/tarsconfig.conf</span><br><span class="line">/usr/<span class="built_in">local</span>/app/tars/tarspatch/bin/tarspatch --config=/usr/<span class="built_in">local</span>/app/tars/tarspatch/conf/tarspatch.conf</span><br></pre></td></tr></table></figure><h1 id="运行前端"><a href="#运行前端" class="headerlink" title="运行前端"></a>运行前端</h1><h2 id="准备Java-client"><a href="#准备Java-client" class="headerlink" title="准备Java client"></a>准备Java client</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;TARS_ROOT&#125;</span>/Tars/java</span><br><span class="line">mvn clean install </span><br><span class="line">mvn clean install -f core/client.pom.xml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这一步不需要，应该是用于Java开发的，类似于C++的include/lib</span></span><br><span class="line">mvn clean install -f core/server.pom.xml</span><br></pre></td></tr></table></figure><p>编译之后</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/Tars/java$ ls ~/.m2/repository/com/tencent/tars/tars-client/</span><br><span class="line">1.4.0  maven-metadata-local.xml</span><br></pre></td></tr></table></figure><h2 id="编译前端"><a href="#编译前端" class="headerlink" title="编译前端"></a>编译前端</h2><p>切换到目录<code>${TARS_ROOT}/Tars/web/src/main/resources</code></p><p>修改 <code>app.config.properties</code><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># server为mysql地址</span></span><br><span class="line">tarsweb.datasource.tars.addr=server:3306</span><br><span class="line">tarsweb.datasource.tars.user=u</span><br><span class="line">tarsweb.datasource.tars.pswd=p</span><br></pre></td></tr></table></figure></p><p>maven打包<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn clean package</span><br></pre></td></tr></table></figure></p><p>增加<code>/etc/hosts</code> （注意不是127.0.0.1）</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">192.168.10.6 registry1.tars.com                                                    </span><br><span class="line">192.168.10.6 registry2.tars.com</span><br></pre></td></tr></table></figure><p>若找不到依赖 qq-cloud-central</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/Tars/web$ diff pom.xml pom.xml.bak </span><br><span class="line">diff pom.xml.bak pom.xml</span><br><span class="line">82c82</span><br><span class="line">&lt; &lt;groupId&gt;qq-cloud-central&lt;/groupId&gt;</span><br><span class="line">---</span><br><span class="line">&gt; &lt;groupId&gt;com.tencent.tars&lt;/groupId&gt;</span><br><span class="line">84c84</span><br><span class="line">&lt; &lt;version&gt;1.0.3&lt;/version&gt;</span><br><span class="line">---</span><br><span class="line">&gt; &lt;version&gt;1.4.0&lt;/version&gt;</span><br></pre></td></tr></table></figure><h2 id="resin运行"><a href="#resin运行" class="headerlink" title="resin运行"></a>resin运行</h2><p>下载<a href="http://caucho.com/download/resin-4.0.56.tar.gz" target="_blank" rel="noopener">http://caucho.com/download/resin-4.0.56.tar.gz</a> 解压到<code>/usr/local/app/resin</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;TARS_ROOT&#125;</span>/Tars/web/</span><br><span class="line">cp ./target/tars.war /usr/<span class="built_in">local</span>/app/resin/webapps/</span><br></pre></td></tr></table></figure><p>修改conf/resin.xml</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">host</span> <span class="attr">id</span>=<span class="string">""</span> <span class="attr">root-directory</span>=<span class="string">"."</span>&gt;</span></span><br><span class="line">    &lt;--  &lt;web-app id="/" root-directory="webapps/ROOT"/&gt; --&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">web-app</span> <span class="attr">id</span>=<span class="string">"/"</span> <span class="attr">document-directory</span>=<span class="string">"webapps/tars"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p /data/<span class="built_in">log</span>/tars</span><br><span class="line">/usr/<span class="built_in">local</span>/app/resin/bin/resin.sh start</span><br></pre></td></tr></table></figure><p>进程如下</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/lib/jvm/jdk1.8.0_111/bin/java -Dresin.watchdog=app-0 -Djava.util.logging.manager=com.caucho.log.LogManagerIm</span><br><span class="line">     usr/lib/jvm/jdk1.8.0_111/bin/java -Dresin.server=app-0 -Djava.util.logging.manager=com.caucho.log.LogManager</span><br></pre></td></tr></table></figure><h2 id="发布可选组件"><a href="#发布可选组件" class="headerlink" title="发布可选组件"></a>发布可选组件</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 其他服务</span></span><br><span class="line">make tarsstat-tar</span><br><span class="line">make tarsnotify-tar</span><br><span class="line">make tarsproperty-tar</span><br><span class="line">make tarslog-tar</span><br><span class="line">make tarsquerystat-tar</span><br><span class="line">make tarsqueryproperty-tar</span><br></pre></td></tr></table></figure><p>安装framework之后，tarsnotify会跑步起来，需要将上面步骤发布的tarsnotify-tar发布上去</p><p>接下来可以将剩余的5个也发布上去</p><h1 id="Cpp-Hello-world"><a href="#Cpp-Hello-world" class="headerlink" title="Cpp Hello world"></a>Cpp Hello world</h1><p>生成server</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/usr/local/tars/cpp/script/create_tars_server.sh TestApp HelloServer Hello</span><br></pre></td></tr></table></figure><p>在Ubuntu有报错，rename不了，参见文末[问题]集锦</p><p>生成接口头文件</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/tars/cpp/tools/tars2cpp Hello.tars</span><br><span class="line">make</span><br><span class="line">make tar</span><br></pre></td></tr></table></figure><p>make tar 会生成.tgz包，用于上传发布到tars平台</p><p>可以按照<a href="https://github.com/Tencent/Tars/blob/master/docs/tars_cpp_quickstart.md" target="_blank" rel="noopener">tars_cpp_quickstart</a> 增加一个带参数的接口</p><h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><p>创建目录[/home/tarsproto/],<em>必须这个，有点恶心</em>，在后回到刚刚服务器源码的目录，例如[/usr/local/tars/TestApp/HelloServer]<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make release</span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:/home/tarsproto/TestApp/HelloServer$ tree -L 2</span><br><span class="line">.</span><br><span class="line">├── Hello.h</span><br><span class="line">├── HelloServer.mk</span><br><span class="line">├── Hello.tars</span><br><span class="line">└── makefile</span><br><span class="line"></span><br><span class="line">0 directories, 4 files</span><br></pre></td></tr></table></figure><p>这些内容用于客户端引用</p><p>按照步骤继续添加可执行程序源码</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:/home/tarsproto/TestApp/TestHelloClient$ tree</span><br><span class="line">.</span><br><span class="line">├── main.cpp</span><br><span class="line">├── makefile</span><br><span class="line"></span><br><span class="line">0 directories, 2 files</span><br></pre></td></tr></table></figure><p>注意修改IP地址</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Communicator comm;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        HelloPrx prx;</span><br><span class="line">        comm.stringToProxy(<span class="string">"TestApp.HelloServer.HelloObj@tcp -h 192.168.10.6 -p 20001"</span> , prx);</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure><p>运行<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:/home/tarsproto/TestApp/TestHelloClient$ ./TestHelloClient </span><br><span class="line">2018-06-26 15:22:52|CommunicatorEpoll::run id:12838</span><br><span class="line">iRet:0 sReq:hello world sRsp:hello world</span><br></pre></td></tr></table></figure></p><h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><h2 id="访问http-127-0-0-1-8080报错"><a href="#访问http-127-0-0-1-8080报错" class="headerlink" title="访问http://127.0.0.1:8080报错"></a>访问<a href="http://127.0.0.1:8080报错" target="_blank" rel="noopener">http://127.0.0.1:8080报错</a></h2><p>NoClassDefFoundError: org/apache/log4j/spi/ThrowableInformation</p><p>修改${TARS_ROOT}/Tars/java/core/client.pom.xml，增加下列依赖<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/log4j/log4j --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="mysql时间搓错误"><a href="#mysql时间搓错误" class="headerlink" title="mysql时间搓错误"></a>mysql时间搓错误</h2><p>Error updating database.  Cause: com.mysql.jdbc.MysqlDataTruncation: Data truncation: Incorrect datetime value: ‘0000:00:00 00:00:00’ for column ‘patch_time’ at row 1↵### The error may involve defaultParameterMap</p><p><code>/etc/mysql/mysql.conf.d/mysqld.cnf</code>  去掉<code>NO_ZERO_DATE</code>选项<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sql_mode = <span class="string">"ONLY_FULL_GROUP_BY"</span></span><br></pre></td></tr></table></figure></p><h2 id="文件发布上传文件失败"><a href="#文件发布上传文件失败" class="headerlink" title="文件发布上传文件失败"></a>文件发布上传文件失败</h2><p>检查文件/目录权限</p><h2 id="tarsnotify-inactive"><a href="#tarsnotify-inactive" class="headerlink" title="tarsnotify inactive"></a>tarsnotify inactive</h2><p>需要手动发布 <code>tarsnotify-tar</code>（另外还有五个可选组件）</p><h2 id="生成hello-world失败"><a href="#生成hello-world失败" class="headerlink" title="生成hello world失败"></a>生成hello world失败</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Bareword <span class="string">"DemoServer"</span> not allowed <span class="keyword">while</span> <span class="string">"strict subs"</span> <span class="keyword">in</span> use at</span><br></pre></td></tr></table></figure><p>参考 <a href="http://haoningabc.iteye.com/blog/1688936" target="_blank" rel="noopener">http://haoningabc.iteye.com/blog/1688936</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#rename "DemoServer" "$SERVER" $SRC_FILE  </span></span><br><span class="line">rename <span class="string">"s/DemoServer/<span class="variable">$SERVER</span>/"</span> <span class="variable">$SRC_FILE</span>  </span><br><span class="line"><span class="comment">#rename "DemoServant" "$SERVANT" $SRC_FILE  </span></span><br><span class="line">rename <span class="string">"s/DemoServant/<span class="variable">$SERVANT</span>/"</span> <span class="variable">$SRC_FILE</span></span><br></pre></td></tr></table></figure><h2 id="编译Hello-world报错"><a href="#编译Hello-world报错" class="headerlink" title="编译Hello world报错"></a>编译Hello world报错</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/include/c++/5/bits/c++0x_warning.h:32:2: error: <span class="comment">#error This file requires compiler</span></span><br></pre></td></tr></table></figure><p>修改当前目录makeifle，<code>TARS2CPP_FLAG</code>增加<code>c11</code>支持<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">TARS2CPP_FLAG:= -std=c++11</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;官网&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/Tencent/Tars&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/Tencent/Tars&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a 
      
    
    </summary>
    
      <category term="源码学习" scheme="http://blog.kimq.cn/categories/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
    
      <category term="tars" scheme="http://blog.kimq.cn/tags/tars/"/>
    
  </entry>
  
  <entry>
    <title>GO Oauth2/OIDC客户端/服务器</title>
    <link href="http://blog.kimq.cn/2018/05/28/oauth/"/>
    <id>http://blog.kimq.cn/2018/05/28/oauth/</id>
    <published>2018-05-28T01:12:53.000Z</published>
    <updated>2020-08-01T09:26:24.727Z</updated>
    
    <content type="html"><![CDATA[<ol><li>服务器参考<a href="https://github.com/RangelReale/osin" target="_blank" rel="noopener">https://github.com/RangelReale/osin</a></li><li>客户端参考<a href="https://github.com/golang/oauth2" target="_blank" rel="noopener">https://github.com/golang/oauth2</a></li><li>OIDC服务器参考<a href="https://github.com/coreos/dex" target="_blank" rel="noopener">https://github.com/coreos/dex</a></li><li>OIDC客户端参考<a href="https://github.com/coreos/go-oidc" target="_blank" rel="noopener">https://github.com/coreos/go-oidc</a></li></ol><h1 id="OAuth2服务器"><a href="#OAuth2服务器" class="headerlink" title="OAuth2服务器"></a>OAuth2服务器</h1><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/RangelReale/osin"</span></span><br><span class="line"><span class="string">"github.com/RangelReale/osin/example"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleLoginPage</span><span class="params">(ar *osin.AuthorizeRequest, w http.ResponseWriter, r *http.Request)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">r.ParseForm()</span><br><span class="line"><span class="keyword">if</span> r.Method == <span class="string">"POST"</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">html := <span class="string">`&lt;html&gt;&lt;body&gt;</span></span><br><span class="line"><span class="string">LOGIN %s&lt;br/&gt;</span></span><br><span class="line"><span class="string">&lt;form action="/authorize?%s" method="POST"&gt;</span></span><br><span class="line"><span class="string">&lt;input type="submit"/&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;&lt;/html&gt;`</span></span><br><span class="line">w.Write([]<span class="keyword">byte</span>(fmt.Sprintf(html, ar.Client.GetId(), r.URL.RawQuery)))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newTestStorage</span><span class="params">()</span> *<span class="title">example</span>.<span class="title">TestStorage</span></span> &#123;</span><br><span class="line">ts := example.NewTestStorage()</span><br><span class="line">c, _ := ts.GetClient(<span class="string">"1234"</span>)</span><br><span class="line">tc := c.(*osin.DefaultClient)</span><br><span class="line">tc.RedirectUri = <span class="string">"http://qjw.p.kimq.cn/callback"</span></span><br><span class="line"><span class="keyword">return</span> ts</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">cfg := osin.NewServerConfig()</span><br><span class="line">cfg.AllowGetAccessRequest = <span class="literal">true</span></span><br><span class="line">cfg.AllowClientSecretInParams = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">server := osin.NewServer(cfg, newTestStorage())</span><br><span class="line"></span><br><span class="line"><span class="comment">// Authorization code endpoint</span></span><br><span class="line">http.HandleFunc(<span class="string">"/authorize"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">resp := server.NewResponse()</span><br><span class="line"><span class="keyword">defer</span> resp.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ar := server.HandleAuthorizeRequest(resp, r); ar != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> !handleLoginPage(ar, w, r) &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">ar.Authorized = <span class="literal">true</span></span><br><span class="line">server.FinishAuthorizeRequest(resp, r, ar)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> resp.IsError &amp;&amp; resp.InternalError != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"ERROR: %s\n"</span>, resp.InternalError)</span><br><span class="line">&#125;</span><br><span class="line">osin.OutputJSON(resp, w, r)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Access token endpoint</span></span><br><span class="line">http.HandleFunc(<span class="string">"/token"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">resp := server.NewResponse()</span><br><span class="line"><span class="keyword">defer</span> resp.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ar := server.HandleAccessRequest(resp, r); ar != <span class="literal">nil</span> &#123;</span><br><span class="line">ar.Authorized = <span class="literal">true</span></span><br><span class="line">server.FinishAccessRequest(resp, r, ar)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> resp.IsError &amp;&amp; resp.InternalError != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"ERROR: %s\n"</span>, resp.InternalError)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">osin.OutputJSON(resp, w, r)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Information endpoint</span></span><br><span class="line">http.HandleFunc(<span class="string">"/info"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">resp := server.NewResponse()</span><br><span class="line"><span class="keyword">defer</span> resp.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ir := server.HandleInfoRequest(resp, r); ir != <span class="literal">nil</span> &#123;</span><br><span class="line">server.FinishInfoRequest(resp, r, ir)</span><br><span class="line">&#125;</span><br><span class="line">osin.OutputJSON(resp, w, r)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">http.ListenAndServe(<span class="string">":14000"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="OAuth2客户端"><a href="#OAuth2客户端" class="headerlink" title="OAuth2客户端"></a>OAuth2客户端</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"io/ioutil"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"golang.org/x/oauth2"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> htmlIndex = <span class="string">`&lt;html&gt;&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;a href="/login"&gt;Log in with oauth2&lt;/a&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> infoUrl = <span class="string">"http://localhost:14000/info"</span></span><br><span class="line"><span class="keyword">var</span> endpotin = oauth2.Endpoint&#123;</span><br><span class="line">AuthURL:  <span class="string">"http://localhost:14000/authorize"</span>,</span><br><span class="line">TokenURL: <span class="string">"http://localhost:14000/token"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> oauthConfig = &amp;oauth2.Config&#123;</span><br><span class="line">ClientID:     <span class="string">"1234"</span>,</span><br><span class="line">ClientSecret: <span class="string">"aabbccdd"</span>,</span><br><span class="line">RedirectURL:  <span class="string">"http://qjw.p.kimq.cn/callback"</span>,</span><br><span class="line">Scopes:       []<span class="keyword">string</span>&#123;<span class="string">"api"</span>&#125;,</span><br><span class="line">Endpoint:     endpotin,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> oauthStateString = <span class="string">"random"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">http.HandleFunc(<span class="string">"/"</span>, handleMain)</span><br><span class="line">http.HandleFunc(<span class="string">"/login"</span>, handleLogin)</span><br><span class="line">http.HandleFunc(<span class="string">"/callback"</span>, handleCallback)</span><br><span class="line">fmt.Println(http.ListenAndServe(<span class="string">":8000"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleMain</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">fmt.Fprintf(w, htmlIndex)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleLogin</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">url := oauthConfig.AuthCodeURL(oauthStateString)</span><br><span class="line">fmt.Println(url)</span><br><span class="line">http.Redirect(w, r, url, http.StatusTemporaryRedirect)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleCallback</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">state := r.FormValue(<span class="string">"state"</span>)</span><br><span class="line"><span class="keyword">if</span> state != oauthStateString &#123;</span><br><span class="line">fmt.Printf(<span class="string">"invalid oauth state, expected '%s', got '%s'\n"</span>, oauthStateString, state)</span><br><span class="line">http.Redirect(w, r, <span class="string">"/"</span>, http.StatusTemporaryRedirect)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(state)</span><br><span class="line"></span><br><span class="line">code := r.FormValue(<span class="string">"code"</span>)</span><br><span class="line">fmt.Println(code)</span><br><span class="line">token, err := oauthConfig.Exchange(oauth2.NoContext, code)</span><br><span class="line">fmt.Println(token)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"Code exchange failed with '%s'\n"</span>, err)</span><br><span class="line">http.Redirect(w, r, <span class="string">"/"</span>, http.StatusTemporaryRedirect)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">client := &amp;http.Client&#123;&#125;</span><br><span class="line">req, _ := http.NewRequest(<span class="string">"GET"</span>, infoUrl, <span class="literal">nil</span>)</span><br><span class="line">req.Header.Set(<span class="string">"Authorization"</span>, <span class="string">"bearer "</span>+token.AccessToken)</span><br><span class="line">response, err := client.Do(req)</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> response.Body.Close()</span><br><span class="line">contents, _ := ioutil.ReadAll(response.Body)</span><br><span class="line">fmt.Fprintf(w, <span class="string">"Content: %s\n"</span>, contents)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Fprintf(w, <span class="string">"Content: %s\n"</span>, err.Error())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Gitlab-OAuth客户端"><a href="#Gitlab-OAuth客户端" class="headerlink" title="Gitlab OAuth客户端"></a>Gitlab OAuth客户端</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"io/ioutil"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"golang.org/x/oauth2"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> htmlIndex = <span class="string">`&lt;html&gt;&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;a href="/login"&gt;Log in with oauth2&lt;/a&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//var infoUrl = "http://localhost:14000/info"</span></span><br><span class="line"><span class="comment">//var endpotin = oauth2.Endpoint&#123;</span></span><br><span class="line"><span class="comment">//AuthURL:  "http://localhost:14000/authorize",</span></span><br><span class="line"><span class="comment">//TokenURL: "http://localhost:14000/token",</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="comment">//var oauthConfig = &amp;oauth2.Config&#123;</span></span><br><span class="line"><span class="comment">//ClientID:     "1234",</span></span><br><span class="line"><span class="comment">//ClientSecret: "aabbccdd",</span></span><br><span class="line"><span class="comment">//RedirectURL:  "http://qjw.p.kimq.cn/callback",</span></span><br><span class="line"><span class="comment">//Scopes:       []string&#123;"api"&#125;,</span></span><br><span class="line"><span class="comment">//Endpoint:     endpotin,</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> domain = <span class="string">"https://gitlab.example.com"</span></span><br><span class="line"><span class="keyword">var</span> infoUrl = domain + <span class="string">"/api/v4/users"</span></span><br><span class="line"><span class="keyword">var</span> endpotin = oauth2.Endpoint&#123;</span><br><span class="line">AuthURL:  domain + <span class="string">"/oauth/authorize"</span>,</span><br><span class="line">TokenURL: domain + <span class="string">"/oauth/token"</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> oauthConfig = &amp;oauth2.Config&#123;</span><br><span class="line">ClientID:     <span class="string">"4f56sad4f56sa4df65safd"</span>,</span><br><span class="line">ClientSecret: <span class="string">"7f8dasf46sa54f56s4df65"</span>,</span><br><span class="line">RedirectURL:  <span class="string">"http://qjw.p.kimq.cn/callback"</span>,</span><br><span class="line">Scopes:       []<span class="keyword">string</span>&#123;<span class="string">"api"</span>&#125;,</span><br><span class="line">Endpoint:     endpotin,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> oauthStateString = <span class="string">"random"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">http.HandleFunc(<span class="string">"/"</span>, handleMain)</span><br><span class="line">http.HandleFunc(<span class="string">"/login"</span>, handleLogin)</span><br><span class="line">http.HandleFunc(<span class="string">"/callback"</span>, handleCallback)</span><br><span class="line">fmt.Println(http.ListenAndServe(<span class="string">":8000"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleMain</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">fmt.Fprintf(w, htmlIndex)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleLogin</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">url := oauthConfig.AuthCodeURL(oauthStateString)</span><br><span class="line">fmt.Println(url)</span><br><span class="line">http.Redirect(w, r, url, http.StatusTemporaryRedirect)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleCallback</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">state := r.FormValue(<span class="string">"state"</span>)</span><br><span class="line"><span class="keyword">if</span> state != oauthStateString &#123;</span><br><span class="line">fmt.Printf(<span class="string">"invalid oauth state, expected '%s', got '%s'\n"</span>, oauthStateString, state)</span><br><span class="line">http.Redirect(w, r, <span class="string">"/"</span>, http.StatusTemporaryRedirect)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(state)</span><br><span class="line"></span><br><span class="line">code := r.FormValue(<span class="string">"code"</span>)</span><br><span class="line">fmt.Println(code)</span><br><span class="line">token, err := oauthConfig.Exchange(oauth2.NoContext, code)</span><br><span class="line">fmt.Println(token)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"Code exchange failed with '%s'\n"</span>, err)</span><br><span class="line">http.Redirect(w, r, <span class="string">"/"</span>, http.StatusTemporaryRedirect)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">client := &amp;http.Client&#123;&#125;</span><br><span class="line">req, _ := http.NewRequest(<span class="string">"GET"</span>, infoUrl, <span class="literal">nil</span>)</span><br><span class="line">req.Header.Set(<span class="string">"Authorization"</span>, <span class="string">"bearer "</span>+token.AccessToken)</span><br><span class="line">response, err := client.Do(req)</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> response.Body.Close()</span><br><span class="line">contents, _ := ioutil.ReadAll(response.Body)</span><br><span class="line">fmt.Fprintf(w, <span class="string">"Content: %s\n"</span>, contents)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Fprintf(w, <span class="string">"Content: %s\n"</span>, err.Error())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="OIDC服务器"><a href="#OIDC服务器" class="headerlink" title="OIDC服务器"></a>OIDC服务器</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ go get github.com/coreos/dex</span><br><span class="line">$ <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/coreos/dex</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure><p>修改examples/config-dev.yml<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">staticClients:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">example-app</span></span><br><span class="line">  <span class="attr">redirectURIs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">'http://qjw.p.kimq.cn/callback'</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">'Example App'</span></span><br><span class="line">  <span class="attr">secret:</span> <span class="string">ZXhhbXBsZS1hcHAtc2VjcmV0</span></span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./bin/dex serve examples/config-dev.yaml</span><br></pre></td></tr></table></figure><h2 id="OIDC客户端"><a href="#OIDC客户端" class="headerlink" title="OIDC客户端"></a>OIDC客户端</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"encoding/json"</span></span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line">oidc <span class="string">"github.com/coreos/go-oidc"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"golang.org/x/net/context"</span></span><br><span class="line"><span class="string">"golang.org/x/oauth2"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> domain = <span class="string">"http://127.0.0.1:5556/dex"</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">clientID     = <span class="string">"example-app"</span></span><br><span class="line">clientSecret = <span class="string">"ZXhhbXBsZS1hcHAtc2VjcmV0"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ctx := context.Background()</span><br><span class="line"></span><br><span class="line">provider, err := oidc.NewProvider(ctx, domain)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">oidcConfig := &amp;oidc.Config&#123;</span><br><span class="line">ClientID: clientID,</span><br><span class="line">&#125;</span><br><span class="line">verifier := provider.Verifier(oidcConfig)</span><br><span class="line"></span><br><span class="line">config := oauth2.Config&#123;</span><br><span class="line">ClientID:     clientID,</span><br><span class="line">ClientSecret: clientSecret,</span><br><span class="line">Endpoint:     provider.Endpoint(),</span><br><span class="line">RedirectURL:  <span class="string">"http://qjw.p.kimq.cn/callback"</span>,</span><br><span class="line">Scopes:       []<span class="keyword">string</span>&#123;oidc.ScopeOpenID&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">state := <span class="string">"foobar"</span> <span class="comment">// Don't do this in production.</span></span><br><span class="line"></span><br><span class="line">http.HandleFunc(<span class="string">"/"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">http.Redirect(w, r, config.AuthCodeURL(state), http.StatusFound)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">http.HandleFunc(<span class="string">"/callback"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> r.URL.Query().Get(<span class="string">"state"</span>) != state &#123;</span><br><span class="line">http.Error(w, <span class="string">"state did not match"</span>, http.StatusBadRequest)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">oauth2Token, err := config.Exchange(ctx, r.URL.Query().Get(<span class="string">"code"</span>))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(w, <span class="string">"Failed to exchange token: "</span>+err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">rawIDToken, ok := oauth2Token.Extra(<span class="string">"id_token"</span>).(<span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">http.Error(w, <span class="string">"No id_token field in oauth2 token."</span>, http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">idToken, err := verifier.Verify(ctx, rawIDToken)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(w, <span class="string">"Failed to verify ID Token: "</span>+err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">oauth2Token.AccessToken = <span class="string">"*REDACTED*"</span></span><br><span class="line"></span><br><span class="line">resp := <span class="keyword">struct</span> &#123;</span><br><span class="line">OAuth2Token   *oauth2.Token</span><br><span class="line">IDTokenClaims *json.RawMessage <span class="comment">// ID Token payload is just JSON.</span></span><br><span class="line">&#125;&#123;oauth2Token, <span class="built_in">new</span>(json.RawMessage)&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := idToken.Claims(&amp;resp.IDTokenClaims); err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">data, err := json.MarshalIndent(resp, <span class="string">""</span>, <span class="string">"    "</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">w.Write(data)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">log.Fatal(http.ListenAndServe(<span class="string">"127.0.0.1:8000"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Dex使用Gitlab"><a href="#Dex使用Gitlab" class="headerlink" title="Dex使用Gitlab"></a>Dex使用Gitlab</h1><p>Dex默认提供了几种不需要额外配置的认证方式，参见配置 <code>config-dev.yaml</code>。代码实现参见<code>github.com/coreos/dex/storage/static.go</code><br><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">staticClients:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">example-app</span></span><br><span class="line">  <span class="attr">redirectURIs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">'http://qjw.p.kimq.cn/callback'</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">'Example App'</span></span><br><span class="line">  <span class="attr">secret:</span> <span class="string">ZXhhbXBsZS1hcHAtc2VjcmV0</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">connectors:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">mockCallback</span></span><br><span class="line">  <span class="attr">id:</span> <span class="string">mock</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">Example</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># Let dex keep a list of passwords which can be used to login to dex.</span></span><br><span class="line"><span class="attr">enablePasswordDB:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A static list of passwords to login the end user. By identifying here, dex</span></span><br><span class="line"><span class="comment"># won't look in its underlying storage for passwords.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If this option isn't chosen users may be added through the gRPC API.</span></span><br><span class="line"><span class="attr">staticPasswords:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">email:</span> <span class="string">"admin@example.com"</span></span><br><span class="line">  <span class="comment"># bcrypt hash of the string "password"</span></span><br><span class="line">  <span class="attr">hash:</span> <span class="string">"$2a$10$2b2cU8CPhOTaGrs1HRQuAueS7JTT5ZHsHSzYiFPm1leZck7Mc8T4W"</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">"admin"</span></span><br><span class="line">  <span class="attr">userID:</span> <span class="string">"08a8684b-db88-4b73-90a9-3cd1661f5466"</span></span><br></pre></td></tr></table></figure></p><p>为了支持Gitlab，需要</p><ol><li>准备gitlab，可以使用gitlab.com，或者自行搭建的私有仓库，用Docker运行Gitlab非常容易，参见<a href="http://blog.kimq.cn/2017/06/19/gitlab-env/">http://blog.kimq.cn/2017/06/19/gitlab-env/</a></li><li>Gitlab新建<code>applications</code>，其中回调<a href="http://server:5556/dex/callback" target="_blank" rel="noopener">http://server:5556/dex/callback</a>，<em>假设dex服务器的地址是<a href="http://server:5556,下同" target="_blank" rel="noopener">http://server:5556,下同</a></em>。</li><li><p>修改dex配置,假设自行搭建的gitlab服务器地址<a href="http://server:8080" target="_blank" rel="noopener">http://server:8080</a>，注意配置<code>baseURL</code>,<code>redirectURI/clientID/clientSecret</code>和gitlab上保持一致</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">connectors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">gitlab</span></span><br><span class="line">    <span class="comment"># Required field for connector id.</span></span><br><span class="line">    <span class="attr">id:</span> <span class="string">gitlab</span></span><br><span class="line">    <span class="comment"># Required field for connector name.</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">GitLab</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment"># optional, default = https://www.gitlab.com </span></span><br><span class="line">      <span class="attr">baseURL:</span> <span class="string">http://server:8080</span></span><br><span class="line">      <span class="comment"># Credentials can be string literals or pulled from the environment.  </span></span><br><span class="line">      <span class="attr">clientID:</span> <span class="string">7071eb2135f75bf1d8cabd0c48c98ee38b84e25e628e0f9164cd2e40bd99fcd8</span></span><br><span class="line">      <span class="attr">clientSecret:</span> <span class="string">e84f364add4d221cacf36cfe4136cc1c13872ce1ba17158b5ff972221d9f3e21</span></span><br><span class="line">      <span class="attr">redirectURI:</span> <span class="string">http://server:5556/dex/callback</span></span><br></pre></td></tr></table></figure></li><li><p>给dex的客户端分配<code>clientID/clientSecret</code>，在Gitlab上生成的clientID/clientSecret仅仅供dex自己使用（<em>站在gitlab角度看，dex是客户端</em>），分配的方式比较麻烦，dex提供了grpc的接口，参见<code>github.com/coreos/dex/Documentation/api.md</code>，编译成功之后有一个<code>github.com/coreos/dex/bin/grpc-client</code>。我用了一种比较讨巧的办法先测试，写一个Web API，参见<code>github.com/coreos/dex/server/server.go</code>和<code>github.com/coreos/dex/server/handlers.go</code></p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">handleWithCORS(<span class="string">"/token"</span>, s.handleToken)</span><br><span class="line">handleWithCORS(<span class="string">"/test"</span>, s.test)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面的参数`id`和`secret`就是新分配的`clientID/clientSecret`</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">test</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">s.storage.CreateClient(storage.Client&#123;</span><br><span class="line">ID:           <span class="string">"tt"</span>,</span><br><span class="line">Secret:       <span class="string">"123456"</span>,</span><br><span class="line">RedirectURIs: []<span class="keyword">string</span>&#123;<span class="string">"http://qjw.p.kimq.cn/callback"</span>&#125;,</span><br><span class="line">Name:         <span class="string">"hehe"</span>,</span><br><span class="line">&#125;)</span><br><span class="line">w.Write([]<span class="keyword">byte</span>(<span class="string">"Hello, world!"</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>运行客户端</p><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"encoding/json"</span></span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"></span><br><span class="line">oidc <span class="string">"github.com/coreos/go-oidc"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"golang.org/x/net/context"</span></span><br><span class="line"><span class="string">"golang.org/x/oauth2"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> domain = <span class="string">"http://server:5556/dex"</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">clientID     = <span class="string">"tt"</span></span><br><span class="line">clientSecret = <span class="string">"123456"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">ctx := context.Background()</span><br><span class="line"></span><br><span class="line">provider, err := oidc.NewProvider(ctx, domain)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">oidcConfig := &amp;oidc.Config&#123;</span><br><span class="line">ClientID: clientID,</span><br><span class="line">&#125;</span><br><span class="line">verifier := provider.Verifier(oidcConfig)</span><br><span class="line"></span><br><span class="line">config := oauth2.Config&#123;</span><br><span class="line">ClientID:     clientID,</span><br><span class="line">ClientSecret: clientSecret,</span><br><span class="line">Endpoint:     provider.Endpoint(),</span><br><span class="line">RedirectURL:  <span class="string">"http://qjw.p.kimq.cn/callback"</span>,</span><br><span class="line">Scopes:       []<span class="keyword">string</span>&#123;oidc.ScopeOpenID&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">state := <span class="string">"foobar"</span> <span class="comment">// Don't do this in production.</span></span><br><span class="line"></span><br><span class="line">http.HandleFunc(<span class="string">"/"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">http.Redirect(w, r, config.AuthCodeURL(state), http.StatusFound)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">http.HandleFunc(<span class="string">"/callback"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> r.URL.Query().Get(<span class="string">"state"</span>) != state &#123;</span><br><span class="line">http.Error(w, <span class="string">"state did not match"</span>, http.StatusBadRequest)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">oauth2Token, err := config.Exchange(ctx, r.URL.Query().Get(<span class="string">"code"</span>))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(w, <span class="string">"Failed to exchange token: "</span>+err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">rawIDToken, ok := oauth2Token.Extra(<span class="string">"id_token"</span>).(<span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">http.Error(w, <span class="string">"No id_token field in oauth2 token."</span>, http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">idToken, err := verifier.Verify(ctx, rawIDToken)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(w, <span class="string">"Failed to verify ID Token: "</span>+err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">oauth2Token.AccessToken = <span class="string">"*REDACTED*"</span></span><br><span class="line"></span><br><span class="line">resp := <span class="keyword">struct</span> &#123;</span><br><span class="line">OAuth2Token   *oauth2.Token</span><br><span class="line">IDTokenClaims *json.RawMessage <span class="comment">// ID Token payload is just JSON.</span></span><br><span class="line">&#125;&#123;oauth2Token, <span class="built_in">new</span>(json.RawMessage)&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := idToken.Claims(&amp;resp.IDTokenClaims); err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">data, err := json.MarshalIndent(resp, <span class="string">""</span>, <span class="string">"    "</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">w.Write(data)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">log.Fatal(http.ListenAndServe(<span class="string">"0.0.0.0:8000"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="Connector绑定"><a href="#Connector绑定" class="headerlink" title="Connector绑定"></a>Connector绑定</h2><p>dex并未就client和特定的connector（比如gitlab）做绑定，若connector只有一个，就直接跳转，否则列出来让用户选</p><p>加入dex同时设置了gitlab和github的connector，并且我希望这些clientid只能使用gitlab，另外一些只能使用github做授权，就无法实现。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ol&gt;
&lt;li&gt;服务器参考&lt;a href=&quot;https://github.com/RangelReale/osin&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/RangelReale/osin&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;
      
    
    </summary>
    
      <category term="学习笔记" scheme="http://blog.kimq.cn/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="golang" scheme="http://blog.kimq.cn/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>使用plantuml画UML图</title>
    <link href="http://blog.kimq.cn/2018/05/25/plantuml/"/>
    <id>http://blog.kimq.cn/2018/05/25/plantuml/</id>
    <published>2018-05-25T13:14:21.000Z</published>
    <updated>2020-08-01T09:26:24.731Z</updated>
    
    <content type="html"><![CDATA[<p>官网<a href="http://plantuml.com/" target="_blank" rel="noopener">http://plantuml.com/</a></p><p>主流的工具都支持<a href="http://plantuml.com/running" target="_blank" rel="noopener">渲染</a></p><ol><li><a href="http://plugins.intellij.net/plugin/?idea&amp;id=7017" target="_blank" rel="noopener">intellij</a></li><li><a href="http://plantuml.com/eclipse" target="_blank" rel="noopener">eclipse</a></li><li><a href="https://github.com/jvantuyl/sublime_diagram_plugin" target="_blank" rel="noopener">sublime</a></li><li><a href="https://atom.io/packages/plantuml" target="_blank" rel="noopener">atom</a></li><li><a href="https://github.com/brianmaher84/PlantUML_Notepad-_UDL" target="_blank" rel="noopener">notepad++</a></li><li><a href="https://marketplace.visualstudio.com/items?itemName=okazuki.okazukiplantuml" target="_blank" rel="noopener">vscode</a></li><li><a href="http://plugins.netbeans.org/plugin/49069/plantuml" target="_blank" rel="noopener">netbeans</a></li></ol><h2 id="活动图-流程图"><a href="#活动图-流程图" class="headerlink" title="活动图/流程图"></a>活动图/流程图</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">start</span><br><span class="line">if (condition A) then (yes)</span><br><span class="line">  :Text 1;</span><br><span class="line">elseif (condition B) then (yes)</span><br><span class="line">  :Text 2;</span><br><span class="line">  stop</span><br><span class="line">elseif (condition C) then (yes)</span><br><span class="line">  :Text 3;</span><br><span class="line">elseif (condition D) then (yes)</span><br><span class="line">  :Text 4;</span><br><span class="line">else (nothing)</span><br><span class="line">  :Text else;</span><br><span class="line">endif</span><br><span class="line">stop</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><h2 id="状态图"><a href="#状态图" class="headerlink" title="状态图"></a>状态图</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">scale 350 width</span><br><span class="line">[*] --&gt; NotShooting</span><br><span class="line"></span><br><span class="line">state NotShooting &#123;</span><br><span class="line">  [*] --&gt; Idle</span><br><span class="line">  Idle --&gt; Configuring : EvConfig</span><br><span class="line">  Configuring --&gt; Idle : EvConfig</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">state Configuring &#123;</span><br><span class="line">  [*] --&gt; NewValueSelection</span><br><span class="line">  NewValueSelection --&gt; NewValuePreview : EvNewValue</span><br><span class="line">  NewValuePreview --&gt; NewValueSelection : EvNewValueRejected</span><br><span class="line">  NewValuePreview --&gt; NewValueSelection : EvNewValueSaved</span><br><span class="line">  </span><br><span class="line">  state NewValuePreview &#123;</span><br><span class="line"> State1 -&gt; State2</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><h2 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">actor Bob #red</span><br><span class="line">&apos; The only difference between actor</span><br><span class="line">&apos;and participant is the drawing</span><br><span class="line">participant Alice</span><br><span class="line">participant &quot;I have a really\nlong name&quot; as L #99FF99</span><br><span class="line">/&apos; You can also declare:</span><br><span class="line">   participant L as &quot;I have a really\nlong name&quot;  #99FF99</span><br><span class="line">  &apos;/</span><br><span class="line"></span><br><span class="line">Alice-&gt;Bob: Authentication Request</span><br><span class="line">Bob-&gt;Alice: Authentication Response</span><br><span class="line">Bob-&gt;L: Log transaction</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><h2 id="类图"><a href="#类图" class="headerlink" title="类图"></a>类图</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@startuml</span><br><span class="line">class Foo1 &#123;</span><br><span class="line">  You can use</span><br><span class="line">  several lines</span><br><span class="line">  ..</span><br><span class="line">  as you want</span><br><span class="line">  and group</span><br><span class="line">  ==</span><br><span class="line">  things together.</span><br><span class="line">  __</span><br><span class="line">  You can have as many groups</span><br><span class="line">  as you want</span><br><span class="line">  --</span><br><span class="line">  End of class</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class User &#123;</span><br><span class="line">  .. Simple Getter ..</span><br><span class="line">  + getName()</span><br><span class="line">  + getAddress()</span><br><span class="line">  .. Some setter ..</span><br><span class="line">  + setName()</span><br><span class="line">  __ private data __</span><br><span class="line">  int age</span><br><span class="line">  -- encrypted --</span><br><span class="line">  String password</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure><p>完整查看官网<a href="http://plantuml.com/" target="_blank" rel="noopener">http://plantuml.com/</a></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol><li><a href="https://www.jianshu.com/p/e92a52770832" target="_blank" rel="noopener">https://www.jianshu.com/p/e92a52770832</a></li><li><a href="https://yuque.com/yuque/help/editor-puml" target="_blank" rel="noopener">https://yuque.com/yuque/help/editor-puml</a></li><li><a href="https://blog.csdn.net/zhangjikuan/article/details/53484558" target="_blank" rel="noopener">https://blog.csdn.net/zhangjikuan/article/details/53484558</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;官网&lt;a href=&quot;http://plantuml.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://plantuml.com/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;主流的工具都支持&lt;a href=&quot;http://plantuml.com/runn
      
    
    </summary>
    
      <category term="开发环境" scheme="http://blog.kimq.cn/categories/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"/>
    
    
      <category term="uml" scheme="http://blog.kimq.cn/tags/uml/"/>
    
  </entry>
  
  <entry>
    <title>Docker编译期间传递隐私数据</title>
    <link href="http://blog.kimq.cn/2018/05/23/build-time-secrets-with-docker-containers/"/>
    <id>http://blog.kimq.cn/2018/05/23/build-time-secrets-with-docker-containers/</id>
    <published>2018-05-23T11:34:09.000Z</published>
    <updated>2020-08-01T09:26:24.727Z</updated>
    
    <content type="html"><![CDATA[<p>所谓的隐私数据，比如一些私有的token、密码、ssh key之类的不可公开但是编译期间却需要的信息</p><p>比如在docker编译期间，需要clone一个私有git仓库的代码，一般使用ssh key或者一个access token，这个密钥仅仅在编译期有用，并且不能暴露出去</p><h1 id="几种常见思路"><a href="#几种常见思路" class="headerlink" title="几种常见思路"></a>几种常见思路</h1><ol><li>Dockerfile ENV variable</li><li>Docker build time variables</li></ol><p>留意<code>build-arg</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build –build-arg HTTP_PROXY=http://10.20.30.2:1234 .</span><br></pre></td></tr></table></figure><p>这两种方式，实际都会在镜像中留下记录，也就是若获取到镜像，可以找到这些token，所以能达到目的，但并不安全</p><h1 id="dockito-vault"><a href="#dockito-vault" class="headerlink" title="dockito/vault"></a><a href="https://github.com/dockito/vault" target="_blank" rel="noopener">dockito/vault</a></h1><p><a href="https://github.com/dockito/vault" target="_blank" rel="noopener">dockito/vault</a>的思路很简单，在同一个docker环境下运行一个镜像，在里面运行一个http server。打包的docker镜像，则通过http协议去下载ssh key或者token，用完再删除。</p><p>这里的关键问题是<code>如何找到服务器的地址</code></p><p>考虑到默认配置下，同一个docker环境下的容器共享同一个ip内网，所以在目标容器中获取默认网关IP，同时<code>dockito/vault</code>绑定到这个IP即可实现</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>先打一个基础镜像，避免每次测试都要去apt-get和curl</p><p>file:<code>dockerfile.base</code>,你可以使用其他镜像，比如<a href="https://alpinelinux.org/" target="_blank" rel="noopener">Alpine Linux</a><br><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">14.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y curl git &amp;&amp; \</span></span><br><span class="line"><span class="bash">        curl -L https://raw.githubusercontent.com/dockito/vault/master/ONVAULT &gt; /usr/bin/ONVAULT &amp;&amp; \</span></span><br><span class="line"><span class="bash">        chmod +x /usr/bin/ONVAULT</span></span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t base:0.1 . -f Dockerfile.base</span><br></pre></td></tr></table></figure><h3 id="运行vault"><a href="#运行vault" class="headerlink" title="运行vault"></a>运行vault</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/$ docker run --rm -it  -p 172.17.0.1:14242:3000 -v ~/.ssh:/vault/.ssh dockito/vault</span><br><span class="line"></span><br><span class="line">&gt; dockito-vault@1.0.0 start /usr/src/app</span><br><span class="line">&gt; node index.js</span><br><span class="line"></span><br><span class="line">Service started on port 3000</span><br></pre></td></tr></table></figure><p>或者调试模式<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/$ docker run --rm -it  -p 172.17.0.1:14242:3000 -v ~/.ssh:/vault/.ssh dockito/vault /bin/sh</span><br><span class="line">/usr/src/app <span class="comment"># node index</span></span><br><span class="line">Service started on port 3000</span><br></pre></td></tr></table></figure></p><p>在宿主主机访问下面地址确认，参见<a href="https://github.com/dockito/vault/blob/master/index.js" target="_blank" rel="noopener">https://github.com/dockito/vault/blob/master/index.js</a></p><ol><li><a href="http://172.17.0.1:14242/_ping" target="_blank" rel="noopener">http://172.17.0.1:14242/_ping</a></li><li><a href="http://172.17.0.1:14242/ONVAULT" target="_blank" rel="noopener">http://172.17.0.1:14242/ONVAULT</a></li><li><a href="http://172.17.0.1:14242/ssh.tgz" target="_blank" rel="noopener">http://172.17.0.1:14242/ssh.tgz</a></li></ol><h3 id="目标镜像"><a href="#目标镜像" class="headerlink" title="目标镜像"></a>目标镜像</h3><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> base:<span class="number">0.1</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ONVAULT git <span class="built_in">clone</span> git@gitlab.kimq.cn:kingqiu/flask-swagger.git</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/$ docker build -t b:0.1 .</span><br><span class="line">Sending build context to Docker daemon   131 MB</span><br><span class="line">Step 1/2 : FROM base:0.1</span><br><span class="line"> ---&gt; e8e50a0502d0</span><br><span class="line">Step 2/2 : RUN ONVAULT git <span class="built_in">clone</span> git@gitlab.kimq.cn:kingqiu/flask-swagger.git</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 2747e4ef93b9</span><br><span class="line">[Dockito Vault] Downloading private keys...</span><br><span class="line">[Dockito Vault] Using ssh key: id_rsa</span><br><span class="line">[Dockito Vault] Executing <span class="built_in">command</span>: git <span class="built_in">clone</span> git@gitlab.kimq.cn:kingqiu/flask-swagger.git</span><br><span class="line">Cloning into <span class="string">'flask-swagger'</span>...</span><br><span class="line">[Dockito Vault] Removing private keys...</span><br><span class="line"> ---&gt; 3591a1e64c2d</span><br><span class="line">Removing intermediate container 2747e4ef93b9</span><br><span class="line">Successfully built 3591a1e64c2d</span><br></pre></td></tr></table></figure><p>具体怎么获取ssh key以及销毁，在脚本<a href="https://github.com/dockito/vault/blob/master/ONVAULT" target="_blank" rel="noopener">https://github.com/dockito/vault/blob/master/ONVAULT</a></p><h2 id="使用定制ssh-key"><a href="#使用定制ssh-key" class="headerlink" title="使用定制ssh key"></a>使用定制ssh key</h2><p>生成key，名称务必保持<code>id_rsa</code><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(venv) king@king:~/$ ssh-keygen</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/home/king/.ssh/id_rsa):  id_rsa</span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase):</span><br><span class="line">Enter same passphrase again:</span><br><span class="line">Your identification has been saved <span class="keyword">in</span> id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:fXnNp2bZXa9G7EhrjqsaZS/4W9XKgGB+YN5esolUWnQ king@king</span><br><span class="line">The key<span class="string">'s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 2048]----+</span></span><br><span class="line"><span class="string">|        . E      |</span></span><br><span class="line"><span class="string">|       . .       |</span></span><br><span class="line"><span class="string">|      = o        |</span></span><br><span class="line"><span class="string">|     = B o   o o |</span></span><br><span class="line"><span class="string">|      = S + +.o =|</span></span><br><span class="line"><span class="string">|     . B * =.oo+=|</span></span><br><span class="line"><span class="string">|      + = o.o== +|</span></span><br><span class="line"><span class="string">|       o o .+oo. |</span></span><br><span class="line"><span class="string">|      ..+oo+...  |</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br></pre></td></tr></table></figure></p><p>新建<code>config</code>，确保和上面步骤的id_rsa同一目录，假如目录是<code>/home/king/tmp</code>，留意选项<code>StrictHostKeyChecking</code><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Host *</span><br><span class="line">    StrictHostKeyChecking no</span><br></pre></td></tr></table></figure></p><p>运行server<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --rm -it -p 172.17.0.1:14242:3000 -v ~/tmp:/vault/.ssh dockito/vault</span><br></pre></td></tr></table></figure></p><p>将id_rsa.pub作为deploy key设置到gitlab/github上</p><p>然后重新build</p><h3 id="非id-rsa的key"><a href="#非id-rsa的key" class="headerlink" title="非id_rsa的key"></a>非<code>id_rsa</code>的key</h3><p>在脚本<a href="https://github.com/dockito/vault/blob/master/ONVAULT" target="_blank" rel="noopener">ONVAULT</a>，若设置了环境变量<code>VAULT_SSH_KEY</code>，会自动更新配置config<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> [[  <span class="string">"<span class="variable">$VAULT_SSH_KEY</span>"</span> != <span class="string">"id_rsa"</span> ]]; <span class="keyword">then</span></span><br><span class="line"><span class="comment"># configure the ssh to any host to use this ssh key</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\nHost *\nIdentityFile ~/.ssh/<span class="variable">$VAULT_SSH_KEY</span>"</span> &gt;&gt; ~/.ssh/config</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p><p>重命名</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mv id_rsa gitlab &amp;&amp; mv id_rsa.pub gitlab.pub</span><br></pre></td></tr></table></figure><p>留意环境变量<code>VAULT_SSH_KEY</code></p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> base:<span class="number">0.1</span></span><br><span class="line"><span class="keyword">ENV</span> VAULT_SSH_KEY gitlab</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ONVAULT git <span class="built_in">clone</span> git@gitlab.kimq.cn:kingqiu/flask-swagger.git</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">king@king:~/$ ./b.sh </span><br><span class="line">Untagged: b:0.1</span><br><span class="line">Deleted: sha256:60987f8c94</span><br><span class="line">Sending build context to Docker daemon   131 MB</span><br><span class="line">Step 1/3 : FROM base:0.1</span><br><span class="line"> ---&gt; e8e50a0502d0</span><br><span class="line">Step 2/3 : ENV VAULT_SSH_KEY gitlab</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 8b92fa1adab3</span><br><span class="line">Step 3/3 : RUN ONVAULT git <span class="built_in">clone</span> git@gitlab.kimq.cn:kingqiu/flask-swagger.git</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 43e70f25b64e</span><br><span class="line">[Dockito Vault] Downloading private keys...</span><br><span class="line">[Dockito Vault] Using ssh key: gitlab</span><br><span class="line">[Dockito Vault] Executing <span class="built_in">command</span>: git <span class="built_in">clone</span> git@gitlab.kimq.cn:kingqiu/flask-swagger.git</span><br><span class="line">Cloning into <span class="string">'flask-swagger'</span>...</span><br><span class="line">Warning: Permanently added <span class="string">'gitlab.kimq.cn,139.224.170.165'</span> (ECDSA) to the list of known hosts.</span><br><span class="line">[Dockito Vault] Removing private keys...</span><br><span class="line"> ---&gt; 1400a685ef0a</span><br><span class="line">Removing intermediate container 43e70f25b64e</span><br><span class="line">Successfully built 1400a685ef0a</span><br></pre></td></tr></table></figure><h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[Dockito Vault] Executing <span class="built_in">command</span>: git <span class="built_in">clone</span> git@gitlab.kimq.cn:kingqiu/flask-swagger.git</span><br><span class="line">Cloning into <span class="string">'flask-swagger'</span>...</span><br><span class="line">fatal: cannot run ssh: No such file or directory</span><br><span class="line">fatal: unable to fork</span><br></pre></td></tr></table></figure><blockquote><p>apk add –update –virtual openssh-client</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Collecting git+ssh://git@gitlab.kimq.cn/kingqiu/flask-swagger.git (from -r requirements.txt (line 57))</span><br><span class="line">  Cloning ssh://git@gitlab.kimq.cn/kingqiu/flask-swagger.git to /tmp/pip-o1noeq66-build</span><br><span class="line">Bad owner or permissions on /root/.ssh/config</span><br><span class="line">fatal: Could not <span class="built_in">read</span> from remote repository.</span><br></pre></td></tr></table></figure><blockquote><p>chmod 0600 config &amp;&amp; chown <code>whoami</code>:<code>id -g -n</code> config</p></blockquote><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://elasticcompute.io/2016/01/22/build-time-secrets-with-docker-containers/" target="_blank" rel="noopener">https://elasticcompute.io/2016/01/22/build-time-secrets-with-docker-containers/</a></li><li><a href="https://github.com/dockito/vault" target="_blank" rel="noopener">https://github.com/dockito/vault</a></li><li><a href="https://github.com/mdsol/docker-ssh-exec" target="_blank" rel="noopener">https://github.com/mdsol/docker-ssh-exec</a></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;所谓的隐私数据，比如一些私有的token、密码、ssh key之类的不可公开但是编译期间却需要的信息&lt;/p&gt;
&lt;p&gt;比如在docker编译期间，需要clone一个私有git仓库的代码，一般使用ssh key或者一个access token，这个密钥仅仅在编译期有用，并且不能
      
    
    </summary>
    
      <category term="环境搭建" scheme="http://blog.kimq.cn/categories/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    
    
      <category term="docker" scheme="http://blog.kimq.cn/tags/docker/"/>
    
  </entry>
  
</feed>
